"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[292],{1292(e,s,n){n.r(s),n.d(s,{default:()=>j});var t=n(2555),r=n(5043),l=n(7559),i=n(1998),a=n(2115),o=n(5685),c=n(579);const d=e=>(0,c.jsx)("span",{className:"perm-mark ".concat(e?"is-yes":"is-no"),children:e?(0,c.jsx)("svg",{viewBox:"0 0 24 24","aria-hidden":"true",className:"perm-mark-icon",children:(0,c.jsx)("path",{d:"M5 13l4 4L19 7"})}):(0,c.jsx)("svg",{viewBox:"0 0 24 24","aria-hidden":"true",className:"perm-mark-icon",children:(0,c.jsx)("path",{d:"M6 6l12 12M18 6l-12 12"})})});function u(e){let{permissionsGrouped:s={},permissionSelections:n={},permissionScopes:l={},userSchools:i=[],isAdmin:a=!1,onTogglePermission:o,onToggleGroup:u,onScopeChange:m,defaultCollapsed:h=!1}=e;const[p,g]=(0,r.useState)(""),[v,y]=(0,r.useState)(()=>{if(!h)return{};const e=Object.keys(s||{});return 0===e.length?{}:e.reduce((e,s)=>(e[s]=!0,e),{})});(0,r.useEffect)(()=>{if(!h)return;const e=Object.keys(s||{});0!==e.length&&y(s=>{let n=!1;const r=(0,t.A)({},s);return e.forEach(e=>{null==r[e]&&(r[e]=!0,n=!0)}),n?r:s})},[h,s]);const x=(0,r.useMemo)(()=>{const e={};return Object.entries(s||{}).forEach(s=>{let[n,t]=s;const r=new Map;t.forEach(e=>{if(!a&&"page.manage_permissions"===e.resource)return;const s=String(e.resource||"");var n;s&&(r.has(s)||r.set(s,{resource:s,label:(n=e.label||s,String(n||"").replace(/\s*(?:-|\u2013)\s*(View|Edit)\s*$/i,"")),readKey:"".concat(s,"|read"),writeKey:"".concat(s,"|write")}))});const l=Array.from(r.values());l.sort((e,s)=>e.label.localeCompare(s.label,"en",{sensitivity:"base"})),e[n]=l}),e},[s,a]);if(!s||0===Object.keys(s).length)return(0,c.jsx)("div",{children:"No permissions defined."});return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("div",{style:{marginBottom:12},children:(0,c.jsx)("input",{className:"input sm",placeholder:"Search permissions\u2026",value:p,onChange:e=>{g(e.target.value)}})}),Object.entries(s).map(e=>{let[s,r]=e;const h=x[s]||[];if(0===h.length)return null;const g=r.filter(e=>!!a||"page.manage_permissions"!==e.resource).map(e=>"".concat(e.resource,"|").concat(e.action)),j=g.filter(e=>n[e]).length,f=g.length>0&&j===g.length,b=j>0&&!f,N=h.filter(e=>{if(!p)return!0;const s=p.trim().toLowerCase();return(e.label||"").toLowerCase().includes(s)||(e.resource||"").toLowerCase().includes(s)}),S=v[s];return(0,c.jsxs)("div",{style:{marginBottom:12},children:[(0,c.jsxs)("div",{className:"row",style:{alignItems:"center",marginBottom:6},children:[(0,c.jsx)("input",{type:"checkbox",checked:f,ref:e=>{e&&(e.indeterminate=b)},onChange:()=>null===u||void 0===u?void 0:u(g,!f)}),(0,c.jsxs)("div",{style:{fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",gap:6},onClick:()=>(e=>{y(s=>(0,t.A)((0,t.A)({},s),{},{[e]:!s[e]}))})(s),children:[s,(0,c.jsxs)("span",{style:{fontWeight:400,fontSize:12,color:"#6b7280"},children:["(",j,"/",g.length," enabled)"]}),(0,c.jsx)("span",{style:{fontSize:10},children:S?"\u25b6":"\u25bc"})]})]}),!S&&N.length>0&&(0,c.jsxs)("table",{className:"table permissions-table",children:[(0,c.jsx)("thead",{children:(0,c.jsxs)("tr",{children:[(0,c.jsx)("th",{children:"Permission"}),(0,c.jsx)("th",{style:{textAlign:"center"},children:"Read"}),(0,c.jsx)("th",{style:{textAlign:"center"},children:"Write"}),(0,c.jsx)("th",{children:"Scope"})]})}),(0,c.jsx)("tbody",{children:N.map(e=>{const s=Boolean(n[e.readKey]),t=Boolean(n[e.writeKey]),r=l[e.writeKey]||l[e.readKey]||"country",u=!s&&!t;return(0,c.jsxs)("tr",{children:[(0,c.jsxs)("td",{children:[(0,c.jsx)("div",{style:{fontWeight:600},children:e.label}),(0,c.jsx)("div",{className:"small",style:{color:"#6b7280"},children:e.resource})]}),(0,c.jsx)("td",{style:{textAlign:"center"},children:(0,c.jsx)("button",{type:"button",className:"perm-toggle ".concat(s?"is-yes":"is-no"),onClick:()=>null===o||void 0===o?void 0:o(e.readKey,r),"aria-pressed":s,title:"Read",children:d(s)})}),(0,c.jsx)("td",{style:{textAlign:"center"},children:(0,c.jsx)("button",{type:"button",className:"perm-toggle ".concat(t?"is-yes":"is-no"),onClick:()=>null===o||void 0===o?void 0:o(e.writeKey,r),"aria-pressed":t,title:"Write",children:d(t)})}),(0,c.jsx)("td",{children:(0,c.jsxs)("select",{className:"input sm",disabled:u,value:r,onChange:s=>null===m||void 0===m?void 0:m(e.resource,s.target.value),children:[(0,c.jsx)("option",{value:"country",children:a?"User Country":"Country"}),i&&i.map(e=>(0,c.jsx)("option",{value:"school:".concat(e.id),children:e.name},e.id))]})})]},e.resource)})})]}),!S&&0===N.length&&(0,c.jsx)("div",{className:"small",style:{marginLeft:32},children:"No permissions match your search."})]},s)})]})}function m(e){let{show:s,onClose:n,onCreated:t,countries:i=[]}=e;const[o,d]=(0,r.useState)(""),[u,m]=(0,r.useState)(""),[h,p]=(0,r.useState)(""),[g,v]=(0,r.useState)("user"),[y,x]=(0,r.useState)(""),[j,f]=(0,r.useState)(!1);if(!s)return null;return(0,c.jsx)("div",{className:"modal-backdrop",onClick:n,children:(0,c.jsxs)("div",{className:"modal",onClick:e=>{e.stopPropagation()},children:[(0,c.jsx)("h2",{style:{marginTop:0,marginBottom:8},children:"Create User"}),(0,c.jsx)("div",{className:"small",style:{marginBottom:12},children:"Enter details for the new user. A temporary password must be at least 8 characters."}),(0,c.jsxs)("form",{onSubmit:async e=>{e.preventDefault();const s=u.trim();if(!s||!h)return void a.oR.error("Email and password are required");if(h.length<8)return void a.oR.error("Password must be at least 8 characters");if(["user","hr","principal","manager","accountant","admin"].includes(g)){f(!0);try{const e={full_name:o?o.trim():null,email:s,password:h,role:g};y&&"unassigned"!==y&&(e.country_id=Number(y)),await l.FH.createUser(e),a.oR.success("User created"),d(""),m(""),p(""),v("user"),x(""),null===t||void 0===t||t(),null===n||void 0===n||n()}catch(r){console.error(r),a.oR.error((null===r||void 0===r?void 0:r.message)||"Failed to create user")}finally{f(!1)}}else a.oR.error("Invalid role")},children:[(0,c.jsxs)("div",{className:"row",style:{gap:8,flexWrap:"wrap",marginBottom:12},children:[(0,c.jsx)("input",{className:"input full",placeholder:"Full name",value:o,onChange:e=>d(e.target.value)}),(0,c.jsx)("input",{className:"input full",placeholder:"Email",type:"email",value:u,onChange:e=>m(e.target.value)}),(0,c.jsx)("input",{className:"input full",placeholder:"Temporary password",type:"password",value:h,onChange:e=>p(e.target.value)}),(0,c.jsxs)("select",{className:"input full",value:g,onChange:e=>v(e.target.value),children:[(0,c.jsx)("option",{value:"user",children:"User"}),(0,c.jsx)("option",{value:"hr",children:"HR"}),(0,c.jsx)("option",{value:"principal",children:"Principal"}),(0,c.jsx)("option",{value:"manager",children:"Manager"}),(0,c.jsx)("option",{value:"accountant",children:"Accountant"}),(0,c.jsx)("option",{value:"admin",children:"Admin"})]}),(0,c.jsxs)("select",{className:"input full",value:y,onChange:e=>x(e.target.value),children:[(0,c.jsx)("option",{value:"",children:"Unassigned"}),i.map(e=>(0,c.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,c.jsxs)("div",{className:"row",style:{justifyContent:"flex-end",gap:8},children:[(0,c.jsx)("button",{type:"button",className:"btn",onClick:n,disabled:j,children:"Cancel"}),(0,c.jsx)("button",{type:"submit",className:"btn primary",disabled:j,children:j?"Creating...":"Create User"})]})]})]})})}function h(e){let{show:s,onClose:n,onCreated:t,countries:i=[]}=e;const[o,d]=(0,r.useState)(""),[u,m]=(0,r.useState)(""),[h,p]=(0,r.useState)(!1);if(!s)return null;return(0,c.jsx)("div",{className:"modal-backdrop",onClick:n,children:(0,c.jsxs)("div",{className:"modal",onClick:e=>{e.stopPropagation()},children:[(0,c.jsx)("h2",{style:{marginTop:0,marginBottom:8},children:"Create School"}),(0,c.jsx)("div",{className:"small",style:{marginBottom:12},children:"Choose a country and enter the name of the new school."}),(0,c.jsxs)("form",{onSubmit:async e=>{e.preventDefault();const s=u.trim();if(o)if(s){p(!0);try{await l.FH.adminCreateCountrySchool(o,{name:s}),a.oR.success("School created"),d(""),m(""),null===t||void 0===t||t(o),null===n||void 0===n||n()}catch(r){console.error(r),a.oR.error((null===r||void 0===r?void 0:r.message)||"Failed to create school")}finally{p(!1)}}else a.oR.error("School name is required");else a.oR.error("Country is required")},children:[(0,c.jsxs)("div",{className:"row",style:{gap:8,flexWrap:"wrap",marginBottom:12},children:[(0,c.jsxs)("select",{className:"input full",value:o,onChange:e=>d(e.target.value),children:[(0,c.jsx)("option",{value:"",children:"Select country\u2026"}),i.map(e=>(0,c.jsx)("option",{value:e.id,children:e.name},e.id))]}),(0,c.jsx)("input",{className:"input full",placeholder:"School name",value:u,onChange:e=>m(e.target.value)})]}),(0,c.jsxs)("div",{className:"row",style:{justifyContent:"flex-end",gap:8},children:[(0,c.jsx)("button",{type:"button",className:"btn",onClick:n,disabled:h,children:"Cancel"}),(0,c.jsx)("button",{type:"submit",className:"btn primary",disabled:h,children:h?"Creating...":"Create School"})]})]})]})})}function p(e){let{show:s,school:n,users:t=[],countryId:i,onClose:o,onSaved:d}=e;const[u,m]=(0,r.useState)([]),[h,p]=(0,r.useState)([]),[g,v]=(0,r.useState)(!1),[y,x]=(0,r.useState)(!1),[j,f]=(0,r.useState)(""),b=(0,r.useMemo)(()=>t.filter(e=>"principal"===e.role&&String(e.country_id)===String(i)),[t,i]);(0,r.useEffect)(()=>{!async function(){if(s&&n){v(!0);try{const e=await l.FH.adminGetSchoolPrincipals(n.id),s=Array.isArray(e)?e.map(e=>e.id):[];m(s),p(s)}catch(e){console.error(e),m([]),p([])}finally{v(!1)}}}()},[s,n]);const N=(0,r.useMemo)(()=>{const e=j.trim().toLowerCase();return b.filter(e=>!u.includes(e.id)).filter(s=>{if(!e)return!0;const n=(s.full_name||"").toLowerCase(),t=(s.email||"").toLowerCase();return n.includes(e)||t.includes(e)})},[b,u,j]),S=(0,r.useMemo)(()=>{if(u.length!==h.length)return!0;for(const e of u)if(!h.includes(e))return!0;return!1},[u,h]);if(!s||!n)return null;const C=()=>{m(h.slice()),null===o||void 0===o||o()};return(0,c.jsx)("div",{className:"drawer-backdrop",onClick:C,children:(0,c.jsxs)("div",{className:"drawer",onClick:e=>{e.stopPropagation()},children:[(0,c.jsxs)("div",{className:"drawer-header",style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12},children:[(0,c.jsxs)("div",{style:{fontWeight:700},children:["School: ",n.name]}),(0,c.jsx)("button",{className:"btn",style:{border:"none",background:"transparent",padding:0},onClick:C,children:"\xd7"})]}),g?(0,c.jsx)("div",{children:"Loading principals..."}):0===b.length?(0,c.jsx)("div",{children:"No principals found in this country. Create a principal user first, then assign them to schools."}):(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)("div",{style:{marginBottom:12},children:[(0,c.jsx)("div",{style:{fontWeight:600,marginBottom:6},children:"Assigned principals"}),0===u.length?(0,c.jsx)("div",{className:"small",children:"No principals assigned to this school yet."}):(0,c.jsx)("div",{className:"row",style:{gap:6,flexWrap:"wrap"},children:u.map(e=>{const s=t.find(s=>String(s.id)===String(e)),n=s?s.full_name||s.email||s.id:e;return(0,c.jsxs)("div",{className:"chip",children:[(0,c.jsx)("span",{children:n}),(0,c.jsx)("button",{type:"button",className:"chip-remove",onClick:()=>{return s=e,void m(e=>e.filter(e=>e!==s));var s},"aria-label":"Remove principal",children:"\xd7"})]},e)})})]}),(0,c.jsxs)("div",{style:{marginBottom:12},children:[(0,c.jsx)("div",{style:{fontWeight:600,marginBottom:6},children:"Add principal"}),(0,c.jsx)("input",{className:"input full",placeholder:"Find a principal\u2026",value:j,onChange:e=>f(e.target.value),style:{marginBottom:6}}),(0,c.jsx)("div",{style:{maxHeight:200,overflowY:"auto"},children:0===N.length?(0,c.jsx)("div",{className:"small",children:"No principals available"}):N.map(e=>{const s=e.full_name||e.email||e.id;return(0,c.jsx)("div",{className:"access-list-item",style:{cursor:"pointer"},onClick:()=>{return s=e.id,void m(e=>e.includes(s)?e:[...e,s]);var s},children:(0,c.jsx)("div",{children:s})},e.id)})})]}),(0,c.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:8},children:[(0,c.jsx)("button",{className:"btn",onClick:C,disabled:y,children:"Cancel"}),(0,c.jsx)("button",{className:"btn primary",onClick:async()=>{if(n){x(!0);try{await l.FH.adminSetSchoolPrincipals(n.id,{userIds:u}),a.oR.success("Saved"),p(u.slice()),null===d||void 0===d||d(n.id,u),null===o||void 0===o||o()}catch(e){console.error(e),a.oR.error((null===e||void 0===e?void 0:e.message)||"Failed to save principals")}finally{x(!1)}}},disabled:y||!S,children:y?"Saving...":"Save"})]})]})]})})}const g=[{key:"managePermissions",label:"Manage Permissions",resources:["page.manage_permissions"]},{key:"createUser",label:"Create User",resources:["user.create"]},{key:"createSchool",label:"Create School",resources:["school.create"]},{key:"scenarioActions",label:"Scenario Actions",resources:["scenario.create","scenario.plan_edit","scenario.copy","scenario.submit","scenario.delete"]}],v=g.flatMap(e=>e.resources),y=new Set(v);function x(e,s){const n={};return g.forEach(t=>{n[t.key]=t.resources.every(n=>function(e,s,n){return!!Array.isArray(e)&&e.some(e=>e.resource===s&&"write"===e.action&&null==e.scope_school_id&&(null==e.scope_country_id||Number(e.scope_country_id)===Number(n)))}(e,n,s))}),n}function j(){const e=(0,o.KC)(),[s,n]=(0,r.useState)([]),[d,v]=(0,r.useState)([]),j=(0,i.F2)({limit:50,offset:0,fields:"brief",order:"full_name:asc"}),f=j.isFetching,[b,N]=(0,r.useState)(""),[S,C]=(0,r.useState)("all"),[w,A]=(0,r.useState)("all"),[k,_]=(0,r.useState)(!1),[F,E]=(0,r.useState)(null),[R,U]=(0,r.useState)(null),[B,M]=(0,r.useState)(""),[H,P]=(0,r.useState)(null),[L,W]=(0,r.useState)(""),[T,I]=(0,r.useState)({}),[K,O]=(0,r.useState)({}),[q,D]=(0,r.useState)({}),[G,z]=(0,r.useState)({}),[V,Y]=(0,r.useState)(null),[$,J]=(0,r.useState)(!1),[Q,X]=(0,r.useState)([]),[Z,ee]=(0,r.useState)(!1),[se,ne]=(0,r.useState)("countries"),[te,re]=(0,r.useState)(null),[le,ie]=(0,r.useState)(""),[ae,oe]=(0,r.useState)(""),[ce,de]=(0,r.useState)({}),[ue,me]=(0,r.useState)({}),he=(0,r.useRef)({}),pe=(0,r.useRef)({}),[ge,ve]=(0,r.useState)(null),[ye,xe]=(0,r.useState)(null),[je,fe]=(0,r.useState)(!1),[be,Ne]=(0,r.useState)(!1),[Se,Ce]=(0,r.useState)(!1),[we,Ae]=(0,r.useState)(""),[ke,_e]=(0,r.useState)([]),[Fe,Ee]=(0,r.useState)(""),[Re,Ue]=(0,r.useState)(null),Be=(0,i.al)();(0,r.useEffect)(()=>{var s;return null===e||void 0===e||null===(s=e.setHeaderMeta)||void 0===s||s.call(e,{title:"Access Management",subtitle:"Manage users, permissions, and principal assignments",centered:!0}),()=>{var s;null===e||void 0===e||null===(s=e.clearHeaderMeta)||void 0===s||s.call(e)}},[e]);const Me=(0,r.useCallback)(async()=>{const e=await Be.refetch();var s;null!==e&&void 0!==e&&e.error&&(console.error(e.error),a.oR.error((null===(s=e.error)||void 0===s?void 0:s.message)||"Failed to load countries"))},[Be]),He=(0,r.useCallback)(async()=>{const e=await j.refetch();var s;null!==e&&void 0!==e&&e.error&&(console.error(e.error),a.oR.error((null===(s=e.error)||void 0===s?void 0:s.message)||"Failed to load users"))},[j]);(0,r.useEffect)(()=>{const e=Be.data;n(Array.isArray(e)?e:[])},[Be.data]),(0,r.useEffect)(()=>{var e;const s=null===(e=j.data)||void 0===e?void 0:e.items;v(Array.isArray(s)?s:[])},[j.data]),(0,r.useEffect)(()=>{var e;Be.isError&&(console.error(Be.error),a.oR.error((null===(e=Be.error)||void 0===e?void 0:e.message)||"Failed to load countries"))},[Be.isError,Be.error]),(0,r.useEffect)(()=>{var e;j.isError&&(console.error(j.error),a.oR.error((null===(e=j.error)||void 0===e?void 0:e.message)||"Failed to load users"))},[j.isError,j.error]);const Pe=(0,r.useCallback)(async e=>{const s=Number(e);if(Number.isFinite(s))try{const e=await l.FH.adminListCountrySchools(s);Array.isArray(e)?_e(e):e&&Array.isArray(e.items)?_e(e.items):_e([])}catch(n){console.error(n),a.oR.error((null===n||void 0===n?void 0:n.message)||"Failed to load schools"),_e([])}else _e([])},[]),Le=(0,r.useCallback)(async e=>{if(!e)return Y(null),I({}),O({}),X([]),U(null),M(""),P(null),W(""),D({}),void z({});J(!0);try{const s=null!=e.country_id?l.FH.adminListCountrySchools(e.country_id):Promise.resolve([]),[n,t,r]=await Promise.all([l.FH.adminGetPermissionsCatalog(),l.FH.adminGetUserPermissions(e.id),s]);Y(n||null);let i=[];Array.isArray(r)?i=r:r&&Array.isArray(r.items)&&(i=r.items),X(i);const a={},o={};(t||[]).forEach(e=>{const s="".concat(e.resource,"|").concat(e.action);a[s]=!0,null!=e.scope_school_id?o[s]="school:".concat(e.scope_school_id):o[s]="country"}),I(a),O(o),U(e.role||null),M(null!=e.country_id?String(e.country_id):""),P(e.role||null),W(null!=e.country_id?String(e.country_id):""),D(a),z(o)}catch(s){console.error(s),a.oR.error((null===s||void 0===s?void 0:s.message)||"Failed to load permissions")}finally{J(!1)}},[]);(0,r.useEffect)(()=>{he.current=ce},[ce]),(0,r.useEffect)(()=>{pe.current=ue},[ue]),(0,r.useEffect)(()=>{const e=d.find(e=>String(e.id)===String(F));Le(e)},[F,d,Le]),(0,r.useEffect)(()=>{"schools"===se&&Pe(we)},[se,we,Pe]);const We=(0,r.useMemo)(()=>d.filter(e=>"accountant"===String(e.role)),[d]),Te=(0,r.useMemo)(()=>{const e={};return We.forEach(s=>{const n=null!=s.country_id?String(s.country_id):"";e[n]||(e[n]=[]),e[n].push(s)}),Object.values(e).forEach(e=>{e.sort((e,s)=>{const n=(e.full_name||e.email||"").toLowerCase(),t=(s.full_name||s.email||"").toLowerCase();return n.localeCompare(t)})}),e},[We]),Ie=(0,r.useCallback)(async e=>{if(!e)return[];const s=he.current[e];if(s)return s;me(s=>(0,t.A)((0,t.A)({},s),{},{[e]:!0}));try{const s=await l.FH.adminGetUserPermissions(e),n=Array.isArray(s)?s:[];return de(s=>(0,t.A)((0,t.A)({},s),{},{[e]:n})),n}catch(n){return console.error(n),a.oR.error((null===n||void 0===n?void 0:n.message)||"Failed to load accountant permissions"),[]}finally{me(s=>{const n=(0,t.A)({},s);return delete n[e],n})}},[]);(0,r.useEffect)(()=>{if("countries"!==se)return;if(0===We.length)return;const e=We.filter(e=>!he.current[e.id]&&!pe.current[e.id]);0!==e.length&&(me(s=>{const n=(0,t.A)({},s);return e.forEach(e=>{n[e.id]=!0}),n}),Promise.allSettled(e.map(e=>l.FH.adminGetUserPermissions(e.id))).then(s=>{let n=!1;de(r=>{const l=(0,t.A)({},r);return s.forEach((s,t)=>{var r;const i=null===(r=e[t])||void 0===r?void 0:r.id;i&&("fulfilled"===s.status?l[i]=Array.isArray(s.value)?s.value:[]:n=!0)}),l}),n&&a.oR.error("Failed to load some accountant permissions")}).finally(()=>{me(s=>{const n=(0,t.A)({},s);return e.forEach(e=>{delete n[e.id]}),n})}))},[se,We]);const Ke=(0,r.useMemo)(()=>s.find(e=>String(e.id)===String(te))||null,[s,te]),Oe=(0,r.useMemo)(()=>Ke&&Te[String(Ke.id)]||[],[Te,Ke]),qe=(0,r.useMemo)(()=>Ke?d.filter(e=>"admin"!==String(e.role)&&(null==e.country_id||Number(e.country_id)===Number(Ke.id))):[],[Ke,d]);(0,r.useEffect)(()=>{if(!Ke)return ie(""),oe(""),ve(null),void xe(null);if(0===Oe.length)return ie(""),ve(null),void xe(null);Oe.some(e=>String(e.id)===String(le))||ie(String(Oe[0].id))},[Oe,le,Ke]),(0,r.useEffect)(()=>{let e=!0;return(async()=>{if(!Ke||!le)return ve(null),void xe(null);const s=Number(le);if(!Number.isFinite(s))return;const n=await Ie(s);if(!e)return;const t=x(n,Ke.id);ve(t),xe(t)})(),()=>{e=!1}},[Ie,le,Ke]);const De=(0,r.useMemo)(()=>V?"object"!==typeof V||Array.isArray(V)?Array.isArray(V)?V.reduce((e,s)=>{const n=s.group||"Other";return e[n]||(e[n]=[]),e[n].push(s),e},{}):{}:V:{},[V]),Ge=(0,r.useCallback)(function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"country";if(!e)return;const[n,r]=e.split("|"),l="".concat(n,"|read"),i="".concat(n,"|write"),a=(0,t.A)({},T),o=(0,t.A)({},K),c=!!!T[e];"write"===r?c?(a[i]=!0,a[l]=!0,o[i]||(o[i]=s||"country"),o[l]||(o[l]=s||"country")):(a[i]=!1,delete o[i]):c?(a[l]=!0,o[l]||(o[l]=s||"country")):(a[l]=!1,a[i]=!1,delete o[l],delete o[i]),I(a),O(o)},[T,K]),ze=(0,r.useCallback)((e,s)=>{Array.isArray(e)&&0!==e.length&&e.forEach(e=>{!!T[e]!==s&&Ge(e,"country")})},[T,Ge]);const Ve=(0,r.useMemo)(()=>{if(null==F)return!1;if(R!==H)return!0;if((B||"")!==(L||""))return!0;const e=new Set([...Object.keys(q||{}),...Object.keys(T||{})]);for(const s of e){if(!!T[s]!==!!q[s])return!0;if((K[s]||null)!==(G[s]||null))return!0}return!1},[F,R,B,H,L,T,K,q,G]);const Ye=(0,r.useMemo)(()=>{let e=d;S&&"all"!==S&&(e=e.filter(e=>e.role===S)),k&&(e=e.filter(e=>null==e.country_id)),w&&"all"!==w&&(e="unassigned"===w?e.filter(e=>null==e.country_id):e.filter(e=>String(e.country_id)===String(w)));const s=b.trim().toLowerCase();return s&&(e=e.filter(e=>{const n=(e.full_name||"").toLowerCase(),t=(e.email||"").toLowerCase();return n.includes(s)||t.includes(s)})),e},[d,S,w,b,k]),$e=(0,r.useMemo)(()=>{if(!Array.isArray(ke))return[];const e=Fe.trim().toLowerCase();return e?ke.filter(s=>(s.name||"").toLowerCase().includes(e)):ke},[ke,Fe]),Je=(0,r.useMemo)(()=>!(!ge||!ye)&&g.some(e=>ge[e.key]!==ye[e.key]),[ge,ye]),Qe=(0,r.useCallback)(e=>(null===e||void 0===e?void 0:e.full_name)||(null===e||void 0===e?void 0:e.email)||(null===e||void 0===e?void 0:e.id)||"Unknown",[]);return(0,c.jsxs)("div",{className:"permissions-page",children:[(0,c.jsxs)("div",{className:"container permissions-page-content",style:{padding:"1rem"},children:[(0,c.jsxs)("div",{className:"row",style:{justifyContent:"space-between",alignItems:"center"},children:[(0,c.jsxs)("div",{className:"access-hub-tabs",children:[(0,c.jsx)("div",{className:"access-hub-tab ".concat("countries"===se?"is-active":""),onClick:()=>{ne("countries"),E(null),Ue(null)},children:"Countries & Accountants"}),(0,c.jsx)("div",{className:"access-hub-tab ".concat("users"===se?"is-active":""),onClick:()=>{ne("users"),Ue(null),re(null)},children:"Users & Permissions"}),(0,c.jsx)("div",{className:"access-hub-tab ".concat("schools"===se?"is-active":""),onClick:()=>{ne("schools"),E(null),re(null)},children:"Schools & Principals"})]}),(0,c.jsxs)("div",{className:"row",style:{gap:8},children:[(0,c.jsx)("button",{className:"btn primary",onClick:()=>Ne(!0),children:"Create user"}),(0,c.jsx)("button",{className:"btn primary",onClick:()=>Ce(!0),children:"Create school"})]})]}),"countries"===se&&(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("div",{className:"school-assignments-overlay ".concat(Ke?"is-open":""),onClick:()=>re(null),role:"button","aria-label":"Close country drawer",tabIndex:-1}),(0,c.jsxs)("aside",{className:"school-assignments-drawer ".concat(Ke?"is-open":""),children:[(0,c.jsxs)("div",{className:"school-assignments-drawer-header",children:[(0,c.jsxs)("div",{children:[(0,c.jsx)("div",{className:"school-assignments-drawer-title",children:"Country accountants"}),(0,c.jsx)("div",{className:"school-assignments-drawer-subtitle",children:Ke?"".concat(Ke.name," ").concat(Ke.code?"(".concat(Ke.code,")"):""):"Select a country"})]}),(0,c.jsx)("button",{className:"btn school-assignments-close",onClick:()=>re(null),"aria-label":"Close drawer",type:"button",children:"x"})]}),(0,c.jsx)("div",{className:"school-assignments-drawer-body",children:Ke?(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("div",{className:"school-assignments-section-title",children:"Assigned accountant"}),0===Oe.length?(0,c.jsx)("div",{className:"school-assignments-add-card",children:(0,c.jsxs)("div",{className:"row",style:{flexDirection:"column",gap:8},children:[(0,c.jsxs)("select",{className:"input full",value:ae,onChange:e=>oe(e.target.value),children:[(0,c.jsx)("option",{value:"",children:"Select user..."}),qe.map(e=>(0,c.jsx)("option",{value:e.id,children:Qe(e)},e.id))]}),(0,c.jsx)("button",{className:"btn primary",onClick:async()=>{if(!Ke||!ae)return;const e=Number(ae);if(Number.isFinite(e)){fe(!0);try{const s=d.find(s=>String(s.id)===String(e));if(!s)return void a.oR.error("User not found");null!=s.country_id&&Number(s.country_id)===Number(Ke.id)||await l.FH.assignUserCountry(e,{country_id:Ke.id}),await l.FH.adminUpdateUserRole(e,{role:"accountant"}),a.oR.success("Accountant assigned"),de(s=>{const n=(0,t.A)({},s);return delete n[e],n}),await He(),oe(""),ie(String(e))}catch(s){console.error(s),a.oR.error((null===s||void 0===s?void 0:s.message)||"Failed to assign accountant")}finally{fe(!1)}}},disabled:!ae||je,children:je?"Assigning...":"Set as Accountant"}),0===qe.length&&(0,c.jsx)("div",{className:"small",children:"No eligible users available."})]})}):(0,c.jsxs)("div",{className:"school-assignments-add-card",children:[Oe.length>1?(0,c.jsx)("select",{className:"input full",value:le,onChange:e=>ie(e.target.value),children:Oe.map(e=>(0,c.jsx)("option",{value:e.id,children:Qe(e)},e.id))}):(0,c.jsx)("div",{style:{fontWeight:600},children:Qe(Oe[0])}),Oe.length>1&&(0,c.jsx)("div",{className:"small",style:{marginTop:6},children:"Multiple accountants assigned. Select one to edit."})]}),(0,c.jsx)("div",{className:"school-assignments-section-title",children:"Accountant capabilities"}),le?(0,c.jsxs)("div",{className:"school-assignments-card",children:[g.map(e=>(0,c.jsxs)("label",{className:"school-assignments-module-item",children:[(0,c.jsx)("input",{type:"checkbox",checked:Boolean(null===ge||void 0===ge?void 0:ge[e.key]),onChange:()=>{return s=e.key,void ve(e=>(0,t.A)((0,t.A)({},e),{},{[s]:!(null!==e&&void 0!==e&&e[s])}));var s},disabled:je}),(0,c.jsx)("span",{children:e.label})]},e.key)),(0,c.jsxs)("div",{className:"row",style:{justifyContent:"flex-end",gap:8,marginTop:12},children:[(0,c.jsx)("button",{className:"btn",onClick:()=>{ve(ye)},disabled:!Je||je,children:"Discard"}),(0,c.jsx)("button",{className:"btn primary",onClick:async()=>{if(!Ke||!le)return;const e=Number(le);if(Number.isFinite(e)){fe(!0);try{const s=he.current[e]||await Ie(e);let n=(Array.isArray(s)?s:[]).filter(e=>!y.has(e.resource));g.forEach(e=>{null!==ge&&void 0!==ge&&ge[e.key]&&e.resources.forEach(e=>{n.push({resource:e,action:"read",scope_country_id:Number(Ke.id),scope_school_id:null}),n.push({resource:e,action:"write",scope_country_id:Number(Ke.id),scope_school_id:null})})}),n=function(e){const s=new Map;return(Array.isArray(e)?e:[]).forEach(e=>{var n,t;const r=[e.resource,e.action,null!==(n=e.scope_country_id)&&void 0!==n?n:"",null!==(t=e.scope_school_id)&&void 0!==t?t:""].join("|");s.set(r,e)}),Array.from(s.values())}(n),await l.FH.adminSetUserPermissions(e,{permissions:n}),de(s=>(0,t.A)((0,t.A)({},s),{},{[e]:n})),xe(ge),a.oR.success("Accountant permissions updated")}catch(s){console.error(s),a.oR.error((null===s||void 0===s?void 0:s.message)||"Failed to update permissions")}finally{fe(!1)}}},disabled:!Je||je,children:je?"Saving...":"Save"})]})]}):(0,c.jsx)("div",{className:"school-assignments-empty",children:"Assign an accountant to edit capabilities."}),le&&(0,c.jsx)("button",{className:"btn",onClick:()=>{le&&(ne("users"),E(String(le)),re(null))},style:{marginTop:12},children:"Open full permission editor"})]}):(0,c.jsx)("div",{className:"school-assignments-empty",children:"Select a country to manage accountants."})})]})]}),"countries"===se&&(0,c.jsxs)("div",{style:{marginTop:16},children:[(0,c.jsx)("div",{style:{fontWeight:700,marginBottom:12},children:"Countries"}),(0,c.jsxs)("div",{className:"row",style:{gap:6,marginBottom:12,flexWrap:"wrap"},children:[(0,c.jsx)("span",{className:"role-tag is-ok",children:"Enabled"}),(0,c.jsx)("span",{className:"role-tag is-warn",children:"Disabled / No accountant"}),(0,c.jsx)("span",{className:"role-tag is-muted",children:"Loading / Unknown"})]}),(0,c.jsx)("div",{className:"school-assignments-table-wrap",children:(0,c.jsxs)("table",{className:"table school-assignments-table",children:[(0,c.jsx)("thead",{children:(0,c.jsxs)("tr",{children:[(0,c.jsx)("th",{children:"Country"}),(0,c.jsx)("th",{children:"Accountant status"}),(0,c.jsx)("th",{children:"Capabilities"})]})}),(0,c.jsx)("tbody",{children:0===s.length?(0,c.jsx)("tr",{children:(0,c.jsx)("td",{colSpan:3,children:"No countries available."})}):s.map(e=>{const s=Te[String(e.id)]||[],n=s[0]||null,t=s.length>1,r=0===s.length?"No accountant":1===s.length?"1 accountant: ".concat(Qe(n)):"Multiple accountants: ".concat(s.length),l=n?ce[n.id]:null,i=l?x(l,e.id):null,a=n&&Boolean(ue[n.id]);return(0,c.jsxs)("tr",{style:{cursor:"pointer"},onClick:()=>re(String(e.id)),children:[(0,c.jsx)("td",{children:(0,c.jsxs)("div",{style:{fontWeight:600},children:[e.name,e.code?" (".concat(e.code,")"):""]})}),(0,c.jsx)("td",{children:(0,c.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,c.jsx)("span",{className:"role-tag ".concat(1===s.length?"is-ok":"is-warn"),children:r}),t&&(0,c.jsx)("span",{className:"role-tag is-warn",children:"Needs review"})]})}),(0,c.jsx)("td",{children:(0,c.jsx)("div",{className:"row",style:{gap:6},children:g.map(e=>{const n=null===i||void 0===i?void 0:i[e.key],t=e.label;let r="Unknown",l="role-tag is-muted";return 0===s.length?(r="No accountant",l="role-tag is-warn"):a?(r="Loading",l="role-tag is-muted"):i?n?(r="Enabled",l="role-tag is-ok"):(r="Disabled",l="role-tag is-warn"):(r="Unknown",l="role-tag is-muted"),(0,c.jsxs)("span",{className:l,children:[t,": ",r]},e.key)})})})]},e.id)})})]})})]}),"users"===se&&(0,c.jsxs)("div",{className:"access-hub-grid",style:{marginTop:16},children:[(0,c.jsxs)("div",{className:"left-pane",children:[(0,c.jsx)("div",{style:{marginBottom:12,fontWeight:700},children:"Users"}),(0,c.jsxs)("div",{className:"row",style:{flexDirection:"column",gap:8},children:[(0,c.jsx)("input",{className:"input full",placeholder:"Search users by name or email\u2026",value:b,onChange:e=>N(e.target.value)}),(0,c.jsxs)("select",{className:"input full",value:S,onChange:e=>C(e.target.value),children:[(0,c.jsx)("option",{value:"all",children:"All roles"}),(0,c.jsx)("option",{value:"user",children:"User"}),(0,c.jsx)("option",{value:"hr",children:"HR"}),(0,c.jsx)("option",{value:"principal",children:"Principal"}),(0,c.jsx)("option",{value:"manager",children:"Manager"}),(0,c.jsx)("option",{value:"accountant",children:"Accountant"}),(0,c.jsx)("option",{value:"admin",children:"Admin"})]}),(0,c.jsxs)("select",{className:"input full",value:w,onChange:e=>A(e.target.value),children:[(0,c.jsx)("option",{value:"all",children:"All countries"}),s.map(e=>(0,c.jsx)("option",{value:String(e.id),children:e.name},e.id)),(0,c.jsx)("option",{value:"unassigned",children:"Unassigned"})]}),(0,c.jsxs)("label",{style:{display:"flex",alignItems:"center",gap:6},children:[(0,c.jsx)("input",{type:"checkbox",checked:k,onChange:e=>_(e.target.checked)}),(0,c.jsx)("span",{className:"small",children:"Show unassigned only"})]})]}),(0,c.jsx)("div",{style:{marginTop:12},children:f?(0,c.jsx)("div",{children:"Loading users\u2026"}):0===Ye.length?(0,c.jsx)("div",{children:"No users yet. Create a user to start assigning permissions."}):Ye.map(e=>{var s,n;const t=String(e.id)===String(F),r=e.full_name||e.email||e.id,l=e.email||"",i=(null===(s=e.role)||void 0===s?void 0:s.charAt(0).toUpperCase())+(null===(n=e.role)||void 0===n?void 0:n.slice(1))||"",a=e.country_name||"Unassigned";return(0,c.jsxs)("div",{className:"access-list-item ".concat(t?"is-selected":""),onClick:()=>E(String(e.id)),children:[(0,c.jsxs)("div",{style:{display:"flex",flexDirection:"column"},children:[(0,c.jsx)("div",{style:{fontWeight:600},children:r}),(0,c.jsx)("div",{className:"small",style:{color:"#6b7280"},children:l})]}),(0,c.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:6},children:[(0,c.jsx)("span",{className:"role-tag",children:i}),(0,c.jsx)("span",{className:"role-tag",children:a})]})]},e.id)})})]}),(0,c.jsx)("div",{className:"right-pane",children:F?$?(0,c.jsx)("div",{children:"Loading permissions\u2026"}):(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)("div",{className:"card",style:{marginBottom:16},children:[(0,c.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"User details"}),(()=>{const e=d.find(e=>String(e.id)===String(F));if(!e)return null;const n=e.full_name||e.email||e.id;return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)("div",{style:{marginBottom:8},children:[(0,c.jsx)("div",{style:{fontWeight:600},children:n}),(0,c.jsx)("div",{className:"small",style:{color:"#6b7280"},children:e.email})]}),(0,c.jsxs)("div",{className:"row",style:{gap:8,marginBottom:8},children:[(0,c.jsxs)("div",{style:{flex:1},children:[(0,c.jsx)("label",{className:"small",style:{display:"block",marginBottom:4},children:"Role"}),(0,c.jsxs)("select",{className:"input full",value:R||"user",onChange:e=>U(e.target.value),children:[(0,c.jsx)("option",{value:"user",children:"User"}),(0,c.jsx)("option",{value:"hr",children:"HR"}),(0,c.jsx)("option",{value:"principal",children:"Principal"}),(0,c.jsx)("option",{value:"manager",children:"Manager"}),(0,c.jsx)("option",{value:"accountant",children:"Accountant"}),(0,c.jsx)("option",{value:"admin",children:"Admin"})]})]}),(0,c.jsxs)("div",{style:{flex:1},children:[(0,c.jsx)("label",{className:"small",style:{display:"block",marginBottom:4},children:"Country"}),(0,c.jsxs)("select",{className:"input full",value:B,onChange:e=>M(e.target.value),children:[(0,c.jsx)("option",{value:"",children:"Unassigned"}),s.map(e=>(0,c.jsx)("option",{value:String(e.id),children:e.name},e.id))]}),""===B&&(0,c.jsx)("div",{className:"small",style:{color:"#ef4444",marginTop:4},children:"Assign a country to edit scoped permissions."})]})]})]})})()]}),(0,c.jsxs)("div",{className:"card",children:[(0,c.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Permissions"}),B?(0,c.jsx)(u,{permissionsGrouped:De,permissionSelections:T,permissionScopes:K,userSchools:Q,isAdmin:!0,onTogglePermission:Ge,onToggleGroup:ze,onScopeChange:function(e,s){const n="".concat(e,"|read"),r="".concat(e,"|write");O(e=>{const l=(0,t.A)({},e);return T[n]&&(l[n]=s),T[r]&&(l[r]=s),l})}}):(0,c.jsx)("div",{children:"Assign a country to edit scoped permissions."})]})]}):(0,c.jsx)("div",{style:{padding:16},children:"Select a user from the list to edit role and permissions."})})]}),"schools"===se&&(0,c.jsxs)("div",{className:"access-hub-grid",style:{marginTop:16},children:[(0,c.jsxs)("div",{className:"left-pane",children:[(0,c.jsx)("div",{style:{marginBottom:12,fontWeight:700},children:"Schools"}),(0,c.jsxs)("div",{className:"row",style:{flexDirection:"column",gap:8},children:[(0,c.jsxs)("select",{className:"input full",value:we,onChange:e=>Ae(e.target.value),children:[(0,c.jsx)("option",{value:"",children:"Select country\u2026"}),s.map(e=>(0,c.jsx)("option",{value:String(e.id),children:e.name},e.id))]}),(0,c.jsx)("input",{className:"input full",placeholder:"Search schools\u2026",value:Fe,onChange:e=>Ee(e.target.value),disabled:!we})]}),(0,c.jsx)("div",{style:{marginTop:12},children:we?0===ke.length?(0,c.jsx)("div",{children:"No schools in this country yet. Create a school to assign principals."}):0===$e.length?(0,c.jsx)("div",{children:"No schools match your search."}):$e.map(e=>{const s=String(e.id)===String(Re);return(0,c.jsx)("div",{className:"access-list-item ".concat(s?"is-selected":""),onClick:()=>Ue(String(e.id)),children:(0,c.jsx)("div",{children:e.name})},e.id)}):(0,c.jsx)("div",{children:"Select a country to view schools and assign principals."})})]}),(0,c.jsx)("div",{className:"right-pane",children:!Re&&(0,c.jsx)("div",{style:{padding:16},children:"Select a school to manage principal assignments."})}),Re&&(0,c.jsx)(p,{show:!!Re,school:ke.find(e=>String(e.id)===String(Re)),users:d,countryId:we,onClose:()=>Ue(null),onSaved:async(e,s)=>{}})]})]}),"users"===se&&F&&Ve&&(0,c.jsx)("div",{className:"permissions-sticky-footer",children:(0,c.jsx)("div",{className:"permissions-sticky-footer-inner",children:(0,c.jsxs)("div",{className:"permissions-footer-actions",children:[(0,c.jsx)("button",{className:"btn",onClick:function(){I((0,t.A)({},q)),O((0,t.A)({},G)),U(H),M(L||"")},disabled:Z||$,children:"Discard"}),(0,c.jsx)("button",{className:"btn primary",onClick:async function(){const e=d.find(e=>String(e.id)===String(F));if(!e)return void a.oR.error("Select a user");const s=(B||"")!==(L||""),n=R!==H;let r=!1;const i=new Set([...Object.keys(q||{}),...Object.keys(T||{})]);for(const t of i){if(!!T[t]!==!!q[t]){r=!0;break}if((K[t]||null)!==(G[t]||null)){r=!0;break}}let o=[];if(r){const e=B&&""!==B?Number(B):null;o=[],Object.keys(T||{}).forEach(s=>{if(!T[s])return;const[n,t]=s.split("|");let r=K[s]||"country",l=null,i=null;if("country"===r)l=e;else if(r.startsWith("school:")){const s=r.split(":")[1],n=Number(s);Number.isFinite(n)&&(i=n),l=e}o.push({resource:n,action:t,scope_country_id:l,scope_school_id:i})})}ee(!0);try{if(s){const s=B?Number(B):null;await l.FH.assignUserCountry(e.id,{country_id:s})}n&&await l.FH.adminUpdateUserRole(e.id,{role:R}),r&&await l.FH.adminSetUserPermissions(e.id,{permissions:o}),a.oR.success("Saved"),await He(),await Le({id:e.id,role:R,country_id:B?Number(B):null}),P(R),W(B||""),D((0,t.A)({},T)),z((0,t.A)({},K))}catch(c){console.error(c),a.oR.error((null===c||void 0===c?void 0:c.message)||"Save failed")}finally{ee(!1)}},disabled:Z||$,children:Z?"Saving\u2026":"Save changes"})]})})}),be&&(0,c.jsx)(m,{show:be,onClose:()=>Ne(!1),onCreated:()=>{He(),Me()},countries:s}),Se&&(0,c.jsx)(h,{show:Se,onClose:()=>Ce(!1),onCreated:e=>{String(e)===String(we)&&Pe(e),Me()},countries:s})]})}},1998(e,s,n){n.d(s,{F2:()=>c,al:()=>a,dq:()=>d,te:()=>o});var t=n(2555),r=n(2532),l=n(7559);const i={staleTime:6e4};function a(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,r.I)((0,t.A)((0,t.A)({queryKey:["countries"],queryFn:()=>l.FH.listCountries()},i),e))}function o(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,r.I)((0,t.A)((0,t.A)({queryKey:["schools",e],queryFn:()=>l.FH.listSchools(e)},i),s))}function c(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,r.I)((0,t.A)((0,t.A)({queryKey:["adminUsers",e],queryFn:()=>l.FH.listUsers(e)},i),s))}function d(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,r.I)((0,t.A)((0,t.A)({queryKey:["managerUsers",e],queryFn:()=>l.FH.managerListUsers(e)},i),s))}}}]);
//# sourceMappingURL=292.7c08c4b4.chunk.js.map