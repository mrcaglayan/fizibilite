"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[877],{7877(e,a,l){l.r(a),l.d(a,{default:()=>j});var i=l(5043),s=l(9570),t=l(4839),r=l(5685),n=l(2115),o=l(3204),d=l(7559);var c=l(3182),u=l(5534),m=l(579);const v=["temel_bilgiler","kapasite","norm.ders_dagilimi","ik.local_staff","gelirler.unit_fee","giderler.isletme"],p={temel_bilgiler:"Temel Bilgiler",kapasite:"Kapasite","norm.ders_dagilimi":"Norm","ik.local_staff":"\u0130K","gelirler.unit_fee":"Gelirler","giderler.isletme":"Giderler"},h={temel_bilgiler:"temel-bilgiler",kapasite:"kapasite","norm.ders_dagilimi":"norm","ik.local_staff":"ik","gelirler.unit_fee":"gelirler","giderler.isletme":"giderler"},y=[{key:"all",label:"T\xfcm\xfc"},{key:"ready",label:"Merkeze \u0130letilmeye Haz\u0131r"},{key:"in_review",label:"\u0130ncelemede"},{key:"revision",label:"Revize \u0130stendi"},{key:"approved",label:"Kontrol Edildi"},{key:"sent",label:"Merkeze \u0130letildi"},{key:"approved_final",label:"Onayland\u0131"}],b={all:o.x7F,ready:o.A7C,in_review:o.KSO,revision:o.BS8,approved:o.CMH,sent:o.Cer,approved_final:o.gt3};function x(e){const a=null===e||void 0===e?void 0:e.status,l=null===e||void 0===e?void 0:e.sent_at;switch(a){case"revision_requested":return{label:"Revize \u0130stendi",className:"is-bad"};case"sent_for_approval":return{label:"Merkeze iletildi",className:"is-warn"};case"approved":return l?{label:"Onayland\u0131",className:"is-ok"}:{label:"Kontrol edildi",className:"is-ok"};case"in_review":return{label:"\u0130ncelemede",className:"is-warn"};case"submitted":return{label:"Onayda",className:"is-warn"};default:return{label:"Taslak",className:"is-muted"}}}function j(){var e;const a=(0,c.A)(),l=(0,r.KC)(),o=(0,r.Zp)(),[j,f]=(0,i.useState)([]),[w,g]=(0,i.useState)(!1),[q,_]=(0,i.useState)("all"),[C,M]=(0,i.useState)(null),z=(0,i.useRef)(null),R=(0,i.useId)(),E=(0,i.useId)(),I=(0,i.useCallback)(()=>M(null),[]);!function(e,a){let l=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];(0,i.useEffect)(()=>{if(!l)return;const i=l=>{const i=null===e||void 0===e?void 0:e.current;i&&(i.contains(l.target)||null===a||void 0===a||a(l))};return document.addEventListener("mousedown",i,!0),document.addEventListener("touchstart",i,!0),()=>{document.removeEventListener("mousedown",i,!0),document.removeEventListener("touchstart",i,!0)}},[e,a,l])}(z,I,Boolean(C)),(0,i.useEffect)(()=>{function e(e){"Escape"===e.key&&I()}return document.body.style.overflow=C&&"object"===typeof C?"hidden":"auto",window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[C,I]);const A=(0,i.useMemo)(()=>{var e,l;const i=null===(e=a.user)||void 0===e?void 0:e.role;if("admin"===i||"manager"===i||"accountant"===i)return!0;const s=null===(l=a.user)||void 0===l?void 0:l.permissions;return!!Array.isArray(s)&&s.some(e=>"page.manage_permissions"===e.resource&&("read"===e.action||"write"===e.action))},[a.user]);(0,i.useEffect)(()=>{var e;return null===l||void 0===l||null===(e=l.setHeaderMeta)||void 0===e||e.call(l,{title:"Review Queue",subtitle:"Mod\xfcl onay kuyru\u011fu",centered:!0}),()=>{var e;null===l||void 0===l||null===(e=l.clearHeaderMeta)||void 0===e||e.call(l)}},[l]);const S=(0,i.useCallback)(async()=>{if(A){g(!0);try{const e=await d.FH.managerGetReviewQueue();f(Array.isArray(e)?e:[])}catch(e){console.error(e),n.oR.error((null===e||void 0===e?void 0:e.message)||"Failed to load review queue")}finally{g(!1)}}},[A]);(0,i.useEffect)(()=>{S()},[S]);const F=(0,i.useCallback)((e,a)=>{if(!e)return!1;const l=e.scenario||{},i=l.status,s=l.sent_at,t=Number(e.approvedCount||0)===v.length,r="approved"===i&&!s,n="approved"===i&&!!s;switch(a){case"ready":return r&&t;case"in_review":return"in_review"===i||"submitted"===i;case"revision":return"revision_requested"===i;case"approved":return r;case"sent":return"sent_for_approval"===i;case"approved_final":return n;default:return!0}},[]),H=(0,i.useMemo)(()=>{const e=Object.fromEntries(y.map(e=>[e.key,0]));return e.all=Array.isArray(j)?j.length:0,Array.isArray(j)?(j.forEach(a=>{y.forEach(l=>{"all"!==l.key&&F(a,l.key)&&(e[l.key]+=1)})}),e):e},[j,F]),L=(0,i.useMemo)(()=>Array.isArray(j)?"all"===q?j:j.filter(e=>F(e,q)):[],[j,q,F]),P=Math.max(0,y.findIndex(e=>e.key===q)),B=(0,i.useCallback)((e,a,l)=>{const i=h[l];i&&((0,u.sE)(e,a),(0,u.BM)(e,a,i),(0,u.dW)(i),o("/schools/".concat(e,"/").concat(i)))},[o]),K=(0,i.useCallback)((e,a)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),_(a))},[]),O=async(e,a)=>{try{const l=await d.FH.calculateScenario(e,a);if(!l||!l.results)return void n.oR.error("Hesaplama tamamlanamad\u0131");await d.FH.sendForApproval(e,a),n.oR.success("Merkeze iletildi"),S()}catch(l){console.error(l),n.oR.error((null===l||void 0===l?void 0:l.message)||"Failed to send for approval")}};if(!A)return(0,m.jsx)("div",{className:"container",children:(0,m.jsxs)("div",{className:"card",children:[(0,m.jsx)("div",{style:{fontWeight:700},children:"Access Denied"}),(0,m.jsx)("div",{className:"small",style:{marginTop:6},children:"You do not have permission to view the review queue."})]})});const D=null===C||void 0===C?void 0:C.scenario,T=null===C||void 0===C?void 0:C.school,W=D?x(D):null,G=!!C&&C.approvedCount===v.length;return(0,m.jsxs)("div",{className:"container",children:[(0,m.jsx)(s.N,{children:C&&"object"===typeof C?(0,m.jsx)(t.P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"rq-overlay"},"rq-overlay"):null}),(0,m.jsx)(s.N,{children:C&&"object"===typeof C?(0,m.jsxs)("div",{className:"rq-modal-wrap",role:"dialog","aria-modal":"true","aria-label":"Scenario details",children:[(0,m.jsx)(t.P.button,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,transition:{duration:.05}},className:"rq-close-btn",type:"button",onClick:I,"aria-label":"Close",children:(0,m.jsx)(k,{})},"rq-close-".concat(null===D||void 0===D?void 0:D.id,"-").concat(R)),(0,m.jsxs)(t.P.div,{layoutId:"rq-card-".concat(null===D||void 0===D?void 0:D.id,"-").concat(R),ref:z,className:"card rq-modal",children:[(0,m.jsxs)("div",{className:"rq-modal-head",children:[(0,m.jsx)(t.P.div,{layoutId:"rq-thumb-".concat(null===D||void 0===D?void 0:D.id,"-").concat(R),className:"rq-thumb rq-thumb--lg",children:N(D)}),(0,m.jsxs)("div",{className:"rq-modal-head-text",children:[(0,m.jsxs)(t.P.div,{layoutId:"rq-title-".concat(null===D||void 0===D?void 0:D.id,"-").concat(R),className:"rq-title rq-title--lg",children:[null===D||void 0===D?void 0:D.name," (",null===D||void 0===D?void 0:D.academic_year,")"]}),(0,m.jsx)("div",{className:"rq-subtitle",children:null===T||void 0===T?void 0:T.name})]}),(0,m.jsxs)("div",{className:"rq-modal-top-actions",children:[W?(0,m.jsx)("span",{className:"status-badge ".concat(W.className),children:W.label}):null,C?(0,m.jsxs)("span",{className:"small is-muted",children:[C.approvedCount,"/",v.length," onayland\u0131"]}):null,(0,m.jsx)("button",{className:"btn sm primary",type:"button",onClick:()=>O(T.id,D.id),disabled:!G||"approved"!==(null===D||void 0===D?void 0:D.status)||null!=(null===D||void 0===D?void 0:D.sent_at),title:G?"approved"!==(null===D||void 0===D?void 0:D.status)||null!==D&&void 0!==D&&D.sent_at?"Durum izin vermiyor":void 0:"T\xfcm mod\xfcller tamamlanmal\u0131",children:"Merkeze ilet"})]})]}),(0,m.jsxs)("div",{className:"rq-modal-body",children:[(0,m.jsxs)("div",{className:"small is-muted",style:{marginBottom:10},children:["Mod\xfclleri inceleyin. \u201cG\xf6nderildi\u201d durumundaki mod\xfcller i\xe7in ",(0,m.jsx)("b",{children:"Onayla"})," veya"," ",(0,m.jsx)("b",{children:"Revizyon \u0130ste"})," kullan\u0131n."]}),(0,m.jsx)("div",{className:"review-queue-card-inner",children:(0,m.jsxs)("table",{className:"table",children:[(0,m.jsx)("thead",{children:(0,m.jsxs)("tr",{children:[(0,m.jsx)("th",{children:"Mod\xfcl"}),(0,m.jsx)("th",{children:"Durum"}),(0,m.jsx)("th",{children:"G\xf6nderildi"}),(0,m.jsx)("th",{children:"Yorum"}),(0,m.jsx)("th",{})]})}),(0,m.jsx)("tbody",{children:null===C||void 0===C||null===(e=C.requiredItems)||void 0===e?void 0:e.map(e=>{let{workId:a,item:l}=e;const i=(null===l||void 0===l?void 0:l.state)||"not_started",s=function(e){switch(e){case"approved":return{label:"Kontrol edildi",className:"is-ok"};case"needs_revision":return{label:"Revize \u0130stendi",className:"is-bad"};case"submitted":return{label:"\u0130ncelemede",className:"is-warn"};case"in_progress":return{label:"Haz\u0131rlan\u0131yor",className:"is-warn"};default:return{label:"Ba\u015flanmad\u0131",className:"is-muted"}}}(i),t=null!==l&&void 0!==l&&l.submitted_at?new Date(l.submitted_at).toLocaleString():"-",r=(null===l||void 0===l?void 0:l.manager_comment)||"-",o="submitted"===i,c="submitted"===i,u=Boolean(h[a]);return(0,m.jsxs)("tr",{className:"submitted"===i?"highlight-row":"",children:[(0,m.jsx)("td",{children:u?(0,m.jsx)("button",{type:"button",className:"review-queue-module-link",onClick:()=>{I(),B(T.id,D.id,a)},title:"Mod\xfcle git",children:p[a]||a}):p[a]||a}),(0,m.jsx)("td",{children:(0,m.jsx)("span",{className:"status-badge ".concat(s.className),children:s.label})}),(0,m.jsx)("td",{className:"small",children:t}),(0,m.jsx)("td",{className:"small",style:{maxWidth:260,whiteSpace:"pre-wrap"},children:r}),(0,m.jsxs)("td",{children:[o?(0,m.jsx)("button",{className:"btn sm primary",type:"button",onClick:()=>(async(e,a,l)=>{try{await d.FH.reviewWorkItem(e,a,l,{action:"approve"}),n.oR.success("Onayland\u0131"),S()}catch(i){console.error(i),n.oR.error((null===i||void 0===i?void 0:i.message)||"Failed to approve work item")}})(T.id,D.id,a),children:"Onayla"}):null,c?(0,m.jsx)("button",{className:"btn sm danger",type:"button",onClick:()=>(async(e,a,l)=>{const i=window.prompt("Revizyon notu (opsiyonel):");if(void 0!==i)try{await d.FH.reviewWorkItem(e,a,l,{action:"revise",comment:i&&i.trim()?i.trim():void 0}),n.oR.success("Revizyon istendi"),S()}catch(s){console.error(s),n.oR.error((null===s||void 0===s?void 0:s.message)||"Failed to request revision")}})(T.id,D.id,a),children:"Revizyon \u0130ste"}):null]})]},a)})})]})})]})]})]}):null}),(0,m.jsxs)("section",{className:"review-queue-tabs",style:{"--rq-tab-count":y.length,"--rq-active-index":P},children:[y.map(e=>{const a="".concat(E,"-").concat(e.key);return(0,m.jsx)("input",{id:a,type:"radio",name:"review-queue-filter-".concat(E),className:"rq-tab-input",checked:q===e.key,onChange:()=>_(e.key)},a)}),(0,m.jsx)("nav",{className:"rq-tab-nav",role:"tablist","aria-label":"Senaryo filtresi",children:y.map(e=>{var a;const l="".concat(E,"-").concat(e.key),i=q===e.key,s=b[e.key];return(0,m.jsxs)("label",{htmlFor:l,role:"tab","aria-selected":i,tabIndex:0,className:"review-queue-tab ".concat(i?"is-active":""),onKeyDown:a=>K(a,e.key),children:[(0,m.jsx)("span",{className:"rq-tab-icon",children:s?(0,m.jsx)(s,{"aria-hidden":"true"}):null}),(0,m.jsx)("span",{className:"rq-tab-text",children:e.label}),(0,m.jsx)("span",{className:"review-queue-count",children:null!==(a=H[e.key])&&void 0!==a?a:0})]},e.key)})})]}),w?(0,m.jsx)("div",{className:"card",children:"Loading..."}):0===L.length?(0,m.jsx)("div",{className:"card",children:(0,m.jsx)("div",{children:"No scenarios to review"})}):(0,m.jsx)("div",{className:"review-queue-cards",children:L.map(e=>{let{school:a,scenario:l,requiredItems:i,approvedCount:s}=e;const r=x(l),n=s===v.length,o={school:a,scenario:l,requiredItems:i,approvedCount:s};return(0,m.jsx)(t.P.div,{layoutId:"rq-card-".concat(l.id,"-").concat(R),className:"card rq-card-compact",onClick:()=>M(o),children:(0,m.jsxs)("div",{className:"rq-compact-row",children:[(0,m.jsxs)("div",{className:"rq-compact-left",children:[(0,m.jsx)(t.P.div,{layoutId:"rq-thumb-".concat(l.id,"-").concat(R),className:"rq-thumb",children:N(l)}),(0,m.jsxs)("div",{children:[(0,m.jsx)("div",{className:"rq-kicker",children:null===a||void 0===a?void 0:a.name}),(0,m.jsxs)(t.P.div,{layoutId:"rq-title-".concat(l.id,"-").concat(R),className:"rq-title",children:[l.name," (",l.academic_year,")"]}),(0,m.jsxs)("div",{className:"rq-subtitle",children:[(0,m.jsx)("span",{className:"status-badge ".concat(r.className),children:r.label}),(0,m.jsxs)("span",{className:"small is-muted",style:{marginLeft:8},children:[s,"/",v.length," onayland\u0131"]})]})]})]}),(0,m.jsxs)("div",{className:"rq-actions",children:[(0,m.jsx)("button",{type:"button",className:"rq-open-pill",onClick:e=>{e.stopPropagation(),M(o)},children:"\u0130ncele"}),(0,m.jsx)("button",{className:"btn sm primary",type:"button",onClick:e=>{e.stopPropagation(),O(a.id,l.id)},disabled:!n||"approved"!==l.status||null!=l.sent_at,title:n?"approved"!==l.status||l.sent_at?"Durum izin vermiyor":void 0:"T\xfcm mod\xfcller tamamlanmal\u0131",children:"Merkeze ilet"})]})]})},l.id)})})]})}function k(){return(0,m.jsxs)(t.P.svg,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,transition:{duration:.05}},xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"rq-close-icon",children:[(0,m.jsx)("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"}),(0,m.jsx)("path",{d:"M18 6l-12 12"}),(0,m.jsx)("path",{d:"M6 6l12 12"})]})}function N(e){var a,l;const i=String((null===e||void 0===e?void 0:e.name)||"").trim();if(!i)return"S";const s=i.split(/\s+/).filter(Boolean);return(((null===(a=s[0])||void 0===a?void 0:a[0])||"S")+((null===(l=s[1])||void 0===l?void 0:l[0])||"")).toUpperCase()}}}]);
//# sourceMappingURL=877.61610bb9.chunk.js.map