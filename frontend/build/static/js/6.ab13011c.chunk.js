"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[6],{5006(e,a,i){i.r(a),i.d(a,{default:()=>j});var r=i(2555),l=i(5043),t=i(9570),n=i(4839),s=i(5685),o=i(2115),d=i(3204),c=i(7559),u=i(3182),m=i(5534),v=i(579);const p=["temel_bilgiler","kapasite","norm.ders_dagilimi","ik.local_staff","gelirler.unit_fee","giderler.isletme"],h={temel_bilgiler:"Temel Bilgiler",kapasite:"Kapasite","norm.ders_dagilimi":"Norm","ik.local_staff":"\u0130K","gelirler.unit_fee":"Gelirler","giderler.isletme":"Giderler"},y={temel_bilgiler:"temel-bilgiler",kapasite:"kapasite","norm.ders_dagilimi":"norm","ik.local_staff":"ik","gelirler.unit_fee":"gelirler","giderler.isletme":"giderler"};function b(e){const a=Number(null===e||void 0===e?void 0:e.totalRequired);return Number.isFinite(a)&&a>0?a:Array.isArray(null===e||void 0===e?void 0:e.requiredItems)?e.requiredItems.length:p.length}const x=[{key:"all",label:"T\xfcm\xfc"},{key:"ready",label:"Merkeze \u0130letilmeye Haz\u0131r"},{key:"in_review",label:"\u0130ncelemede"},{key:"revision",label:"Revize \u0130stendi"},{key:"approved",label:"Kontrol Edildi"},{key:"sent",label:"Merkeze \u0130letildi"},{key:"approved_final",label:"Onayland\u0131"}],f={all:d.x7F,ready:d.A7C,in_review:d.KSO,revision:d.BS8,approved:d.CMH,sent:d.Cer,approved_final:d.gt3};function k(e){const a=null===e||void 0===e?void 0:e.status,i=null===e||void 0===e?void 0:e.sent_at;switch(a){case"revision_requested":return{label:"Revize \u0130stendi",className:"is-bad"};case"sent_for_approval":return{label:"Merkeze iletildi",className:"is-warn"};case"approved":return i?{label:"Onayland\u0131",className:"is-ok"}:{label:"Kontrol edildi",className:"is-ok"};case"in_review":return{label:"\u0130ncelemede",className:"is-warn"};case"submitted":return{label:"Onayda",className:"is-warn"};default:return{label:"Taslak",className:"is-muted"}}}function j(){var e;const a=(0,u.A)(),i=(0,s.KC)(),d=(0,s.Zp)(),[j,q]=(0,l.useState)([]),[w,C]=(0,l.useState)(!1),[_,I]=(0,l.useState)("all"),[A,S]=(0,l.useState)(null),[R,M]=(0,l.useState)(!0),z=(0,l.useRef)(null),E=(0,l.useRef)(null),F=(0,l.useRef)(!1),H=(0,l.useId)(),P=(0,l.useId)(),B=(0,l.useCallback)(()=>{F.current=!1,M(!0),requestAnimationFrame(()=>S(null))},[]),K=(0,l.useCallback)(e=>{var a,i;F.current=!0,M(!0),z.current=null!==(a=null===e||void 0===e||null===(i=e.scenario)||void 0===i?void 0:i.id)&&void 0!==a?a:null,S(e)},[]);(0,l.useEffect)(()=>{function e(e){"Escape"===e.key&&B()}return document.body.style.overflow=A&&"object"===typeof A?"hidden":"auto",window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[A,B]),(0,l.useEffect)(()=>{if(!A)return;const e=window.setTimeout(()=>M(!1),220);return()=>window.clearTimeout(e)},[A]);const T=(0,l.useMemo)(()=>{var e,i;const r=null===(e=a.user)||void 0===e?void 0:e.role;if("admin"===r||"manager"===r||"accountant"===r)return!0;const l=null===(i=a.user)||void 0===i?void 0:i.permissions;return!!Array.isArray(l)&&l.some(e=>"page.manage_permissions"===e.resource&&("read"===e.action||"write"===e.action))},[a.user]);(0,l.useEffect)(()=>{var e;return null===i||void 0===i||null===(e=i.setHeaderMeta)||void 0===e||e.call(i,{title:"Review Queue",subtitle:"Mod\xfcl onay kuyru\u011fu",centered:!0}),()=>{var e;null===i||void 0===i||null===(e=i.clearHeaderMeta)||void 0===e||e.call(i)}},[i]);const O=(0,l.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(T){C(!0);try{var a;const i=await c.FH.managerGetReviewQueue(),r=Array.isArray(i)?i:[],l=null!==(a=null===e||void 0===e?void 0:e.activeScenarioId)&&void 0!==a?a:z.current;if(("boolean"===typeof(null===e||void 0===e?void 0:e.deferUpdate)?e.deferUpdate:F.current||null!=l)?E.current=r:q(r),null!=l){const e=r.find(e=>{var a;return String(null===e||void 0===e||null===(a=e.scenario)||void 0===a?void 0:a.id)===String(l)});e&&S({school:e.school,scenario:e.scenario,requiredItems:e.requiredItems,approvedCount:e.approvedCount,totalRequired:b(e)})}}catch(i){console.error(i),o.oR.error((null===i||void 0===i?void 0:i.message)||"Failed to load review queue")}finally{C(!1)}}},[T]);(0,l.useEffect)(()=>{var e,a;z.current=null!==(e=null===A||void 0===A||null===(a=A.scenario)||void 0===a?void 0:a.id)&&void 0!==e?e:null,F.current=Boolean(A),!A&&E.current&&(q(E.current),E.current=null)},[A]),(0,l.useEffect)(()=>{O()},[O]);const D=(0,l.useCallback)((e,a)=>{if(!e)return!1;const i=e.scenario||{},r=i.status,l=i.sent_at,t=Number(e.approvedCount||0)===b(e),n="approved"===r&&!l,s="approved"===r&&!!l;switch(a){case"ready":return n&&t;case"in_review":return"in_review"===r||"submitted"===r;case"revision":return"revision_requested"===r;case"approved":return n;case"sent":return"sent_for_approval"===r;case"approved_final":return s;default:return!0}},[]),L=(0,l.useMemo)(()=>{const e=Object.fromEntries(x.map(e=>[e.key,0]));return e.all=Array.isArray(j)?j.length:0,Array.isArray(j)?(j.forEach(a=>{x.forEach(i=>{"all"!==i.key&&D(a,i.key)&&(e[i.key]+=1)})}),e):e},[j,D]),U=(0,l.useMemo)(()=>Array.isArray(j)?"all"===_?j:j.filter(e=>D(e,_)):[],[j,_,D]),W=Math.max(0,x.findIndex(e=>e.key===_)),G=(0,l.useCallback)((e,a,i)=>{const r=y[i];r&&((0,m.sE)(e,a),(0,m.BM)(e,a,r),(0,m.dW)(r),d("/schools/".concat(e,"/").concat(r)))},[d]),Q=(0,l.useCallback)((e,a)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),I(a))},[]),Y=(e,a,i,l)=>{const t=Array.isArray(e)?e.map(e=>{var t;return e.workId!==a?e:(0,r.A)((0,r.A)({},e),{},{item:(0,r.A)((0,r.A)({},e.item),{},{state:i,manager_comment:l||(null===(t=e.item)||void 0===t?void 0:t.manager_comment)})})}):e,n=Array.isArray(t)?t.filter(e=>{var a;return"approved"===(null===e||void 0===e||null===(a=e.item)||void 0===a?void 0:a.state)}).length:0;return{updatedItems:t,approvedCount:n}},Z=(0,l.useCallback)((e,a)=>{q(i=>i.map(i=>null!==i&&void 0!==i&&i.scenario?String(i.scenario.id)!==String(e)?i:a(i):i))},[]),J=async(e,a)=>{try{var i,r;const l=await c.FH.calculateScenario(e,a);if(!l||!l.results)return void o.oR.error("Hesaplama tamamlanamad\u0131");await c.FH.sendForApproval(e,a),o.oR.success("Merkeze iletildi");const t=null!==(i=null===A||void 0===A||null===(r=A.scenario)||void 0===r?void 0:r.id)&&void 0!==i?i:null;O({activeScenarioId:t,deferUpdate:Boolean(t)})}catch(l){console.error(l),o.oR.error((null===l||void 0===l?void 0:l.message)||"Failed to send for approval")}};if(!T)return(0,v.jsx)("div",{className:"container",children:(0,v.jsxs)("div",{className:"card",children:[(0,v.jsx)("div",{style:{fontWeight:700},children:"Access Denied"}),(0,v.jsx)("div",{className:"small",style:{marginTop:6},children:"You do not have permission to view the review queue."})]})});const V=null===A||void 0===A?void 0:A.scenario,X=null===A||void 0===A?void 0:A.school,$=V?k(V):null,ee=A?b(A):p.length,ae=!!A&&A.approvedCount===ee;return(0,v.jsxs)("div",{className:"container",children:[(0,v.jsx)(t.N,{children:A&&"object"===typeof A?(0,v.jsx)(n.P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"rq-overlay",onClick:B},"rq-overlay"):null}),(0,v.jsx)(t.N,{children:A&&"object"===typeof A?(0,v.jsxs)("div",{className:"rq-modal-wrap",role:"dialog","aria-modal":"true","aria-label":"Scenario details",onClick:e=>{e.target===e.currentTarget&&B()},children:[(0,v.jsx)(n.P.button,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,transition:{duration:.05}},className:"rq-close-btn",type:"button",onClick:B,"aria-label":"Close",children:(0,v.jsx)(N,{})},"rq-close-".concat(null===V||void 0===V?void 0:V.id,"-").concat(H)),(0,v.jsxs)(n.P.div,{layoutId:R?"rq-card-".concat(null===V||void 0===V?void 0:V.id,"-").concat(H):"rq-modal-".concat(null===V||void 0===V?void 0:V.id,"-").concat(H),className:"card rq-modal",onClick:e=>e.stopPropagation(),children:[(0,v.jsxs)("div",{className:"rq-modal-head",children:[(0,v.jsx)(n.P.div,{layoutId:R?"rq-thumb-".concat(null===V||void 0===V?void 0:V.id,"-").concat(H):"rq-modal-thumb-".concat(null===V||void 0===V?void 0:V.id,"-").concat(H),className:"rq-thumb rq-thumb--lg",children:g(V)}),(0,v.jsxs)("div",{className:"rq-modal-head-text",children:[(0,v.jsxs)(n.P.div,{layoutId:R?"rq-title-".concat(null===V||void 0===V?void 0:V.id,"-").concat(H):"rq-modal-title-".concat(null===V||void 0===V?void 0:V.id,"-").concat(H),className:"rq-title rq-title--lg",children:[null===V||void 0===V?void 0:V.name," (",null===V||void 0===V?void 0:V.academic_year,")"]}),(0,v.jsx)("div",{className:"rq-subtitle",children:null===X||void 0===X?void 0:X.name})]}),(0,v.jsxs)("div",{className:"rq-modal-top-actions",children:[$?(0,v.jsx)("span",{className:"status-badge ".concat($.className),children:$.label}):null,A?(0,v.jsxs)("span",{className:"small is-muted",children:[A.approvedCount,"/",ee," onayland\u0131"]}):null,(0,v.jsx)("button",{className:"btn sm primary",type:"button",onClick:()=>J(X.id,V.id),disabled:!ae||"approved"!==(null===V||void 0===V?void 0:V.status)||null!=(null===V||void 0===V?void 0:V.sent_at),title:ae?"approved"!==(null===V||void 0===V?void 0:V.status)||null!==V&&void 0!==V&&V.sent_at?"Durum izin vermiyor":void 0:"T\xfcm mod\xfcller tamamlanmal\u0131",children:"Merkeze ilet"})]})]}),(0,v.jsxs)("div",{className:"rq-modal-body",children:[(0,v.jsxs)("div",{className:"small is-muted",style:{marginBottom:10},children:["Mod\xfclleri inceleyin. \u201cG\xf6nderildi\u201d durumundaki mod\xfcller i\xe7in ",(0,v.jsx)("b",{children:"Onayla"})," veya"," ",(0,v.jsx)("b",{children:"Revizyon \u0130ste"})," kullan\u0131n."]}),(0,v.jsx)("div",{className:"review-queue-card-inner",children:(0,v.jsxs)("table",{className:"table",children:[(0,v.jsx)("thead",{children:(0,v.jsxs)("tr",{children:[(0,v.jsx)("th",{children:"Mod\xfcl"}),(0,v.jsx)("th",{children:"Durum"}),(0,v.jsx)("th",{children:"G\xf6nderildi"}),(0,v.jsx)("th",{children:"Yorum"}),(0,v.jsx)("th",{})]})}),(0,v.jsx)("tbody",{children:null===A||void 0===A||null===(e=A.requiredItems)||void 0===e?void 0:e.map(e=>{let{workId:a,item:i}=e;const l=(null===i||void 0===i?void 0:i.state)||"not_started",t=function(e){switch(e){case"approved":return{label:"Kontrol edildi",className:"is-ok"};case"needs_revision":return{label:"Revize \u0130stendi",className:"is-bad"};case"submitted":return{label:"\u0130ncelemede",className:"is-warn"};case"in_progress":return{label:"Haz\u0131rlan\u0131yor",className:"is-warn"};default:return{label:"Ba\u015flanmad\u0131",className:"is-muted"}}}(l),n=null!==i&&void 0!==i&&i.submitted_at?new Date(i.submitted_at).toLocaleString():"-",s=(null===i||void 0===i?void 0:i.manager_comment)||"-",d="submitted"===l,u="submitted"===l,m=Boolean(y[a]);return(0,v.jsxs)("tr",{className:"submitted"===l?"highlight-row":"",children:[(0,v.jsx)("td",{children:m?(0,v.jsx)("button",{type:"button",className:"review-queue-module-link",onClick:()=>{B(),G(X.id,V.id,a)},title:"Mod\xfcle git",children:h[a]||a}):h[a]||a}),(0,v.jsx)("td",{children:(0,v.jsx)("span",{className:"status-badge ".concat(t.className),children:t.label})}),(0,v.jsx)("td",{className:"small",children:n}),(0,v.jsx)("td",{className:"small",style:{maxWidth:260,whiteSpace:"pre-wrap"},children:s}),(0,v.jsxs)("td",{children:[d?(0,v.jsx)("button",{className:"btn sm primary",type:"button",onClick:()=>(async(e,a,i)=>{try{var l;await c.FH.reviewWorkItem(e,a,i,{action:"approve"}),o.oR.success("Onayland\u0131"),String(null===A||void 0===A||null===(l=A.scenario)||void 0===l?void 0:l.id)===String(a)?(S(e=>{if(!e)return e;const{updatedItems:a,approvedCount:l}=Y(e.requiredItems,i,"approved");return(0,r.A)((0,r.A)({},e),{},{requiredItems:a,approvedCount:l})}),Z(a,e=>{const{updatedItems:a,approvedCount:l}=Y(e.requiredItems,i,"approved");return(0,r.A)((0,r.A)({},e),{},{requiredItems:a,approvedCount:l})})):O({deferUpdate:!1})}catch(t){console.error(t),o.oR.error((null===t||void 0===t?void 0:t.message)||"Failed to approve work item")}})(X.id,V.id,a),children:"Onayla"}):null,u?(0,v.jsx)("button",{className:"btn sm danger",type:"button",onClick:()=>(async(e,a,i)=>{const l=window.prompt("Revizyon notu (opsiyonel):");if(void 0!==l)try{var t;if(await c.FH.reviewWorkItem(e,a,i,{action:"revise",comment:l&&l.trim()?l.trim():void 0}),o.oR.success("Revizyon istendi"),String(null===A||void 0===A||null===(t=A.scenario)||void 0===t?void 0:t.id)===String(a)){const e=l&&l.trim()?l.trim():"";S(a=>{if(!a)return a;const{updatedItems:l,approvedCount:t}=Y(a.requiredItems,i,"needs_revision",e);return(0,r.A)((0,r.A)({},a),{},{requiredItems:l,approvedCount:t})}),Z(a,a=>{const{updatedItems:l,approvedCount:t}=Y(a.requiredItems,i,"needs_revision",e);return(0,r.A)((0,r.A)({},a),{},{requiredItems:l,approvedCount:t})})}else O({deferUpdate:!1})}catch(n){console.error(n),o.oR.error((null===n||void 0===n?void 0:n.message)||"Failed to request revision")}})(X.id,V.id,a),children:"Revizyon \u0130ste"}):null]})]},a)})})]})})]}),(0,v.jsx)("div",{className:"rq-modal-footer",children:(0,v.jsx)("button",{className:"btn",type:"button",onClick:B,children:"Kapat"})})]})]}):null}),(0,v.jsxs)("section",{className:"review-queue-tabs",style:{"--rq-tab-count":x.length,"--rq-active-index":W},children:[x.map(e=>{const a="".concat(P,"-").concat(e.key);return(0,v.jsx)("input",{id:a,type:"radio",name:"review-queue-filter-".concat(P),className:"rq-tab-input",checked:_===e.key,onChange:()=>I(e.key)},a)}),(0,v.jsx)("nav",{className:"rq-tab-nav",role:"tablist","aria-label":"Senaryo filtresi",children:x.map(e=>{var a;const i="".concat(P,"-").concat(e.key),r=_===e.key,l=f[e.key];return(0,v.jsxs)("label",{htmlFor:i,role:"tab","aria-selected":r,tabIndex:0,className:"review-queue-tab ".concat(r?"is-active":""),onKeyDown:a=>Q(a,e.key),children:[(0,v.jsx)("span",{className:"rq-tab-icon",children:l?(0,v.jsx)(l,{"aria-hidden":"true"}):null}),(0,v.jsx)("span",{className:"rq-tab-text",children:e.label}),(0,v.jsx)("span",{className:"review-queue-count",children:null!==(a=L[e.key])&&void 0!==a?a:0})]},e.key)})})]}),w?(0,v.jsx)("div",{className:"card",children:"Loading..."}):0===U.length?(0,v.jsx)("div",{className:"card",children:(0,v.jsx)("div",{children:"No scenarios to review"})}):(0,v.jsx)("div",{className:"review-queue-cards",children:U.map(e=>{const{school:a,scenario:i,requiredItems:r,approvedCount:l}=e,t=k(i),s=b(e),o=l===s,d={school:a,scenario:i,requiredItems:r,approvedCount:l,totalRequired:s};return(0,v.jsx)(n.P.div,{layoutId:"rq-card-".concat(i.id,"-").concat(H),className:"card rq-card-compact",onClick:()=>K(d),children:(0,v.jsxs)("div",{className:"rq-compact-row",children:[(0,v.jsxs)("div",{className:"rq-compact-left",children:[(0,v.jsx)(n.P.div,{layoutId:"rq-thumb-".concat(i.id,"-").concat(H),className:"rq-thumb",children:g(i)}),(0,v.jsxs)("div",{children:[(0,v.jsx)("div",{className:"rq-kicker",children:null===a||void 0===a?void 0:a.name}),(0,v.jsxs)(n.P.div,{layoutId:"rq-title-".concat(i.id,"-").concat(H),className:"rq-title",children:[i.name," (",i.academic_year,")"]}),(0,v.jsxs)("div",{className:"rq-subtitle",children:[(0,v.jsx)("span",{className:"status-badge ".concat(t.className),children:t.label}),(0,v.jsxs)("span",{className:"small is-muted",style:{marginLeft:8},children:[l,"/",s," onayland\u0131"]})]})]})]}),(0,v.jsxs)("div",{className:"rq-actions",children:[(0,v.jsx)("button",{type:"button",className:"rq-open-pill",onClick:e=>{e.stopPropagation(),K(d)},children:"\u0130ncele"}),(0,v.jsx)("button",{className:"btn sm primary",type:"button",onClick:e=>{e.stopPropagation(),J(a.id,i.id)},disabled:!o||"approved"!==i.status||null!=i.sent_at,title:o?"approved"!==i.status||i.sent_at?"Durum izin vermiyor":void 0:"T\xfcm mod\xfcller tamamlanmal\u0131",children:"Merkeze ilet"})]})]})},i.id)})})]})}function N(){return(0,v.jsxs)(n.P.svg,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,transition:{duration:.05}},xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"rq-close-icon",children:[(0,v.jsx)("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"}),(0,v.jsx)("path",{d:"M18 6l-12 12"}),(0,v.jsx)("path",{d:"M6 6l12 12"})]})}function g(e){var a,i;const r=String((null===e||void 0===e?void 0:e.name)||"").trim();if(!r)return"S";const l=r.split(/\s+/).filter(Boolean);return(((null===(a=l[0])||void 0===a?void 0:a[0])||"S")+((null===(i=l[1])||void 0===i?void 0:i[0])||"")).toUpperCase()}}}]);
//# sourceMappingURL=6.ab13011c.chunk.js.map