{"version":3,"file":"static/js/693.28733578.chunk.js","mappings":"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","sources":["hooks/useScenarioUIState.js","utils/scenarioProgress.js","pages/SchoolPage.jsx","utils/scenarioProfile.js","utils/programType.js"],"sourcesContent":["import { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { useLocation } from \"react-router-dom\";\r\n\r\n// Per school + per scenario persistence.\r\n// We scope by current URL (pathname + search). In your app, this URL already contains\r\n// schoolId and scenarioId (either in params or querystring), so each school/scenario\r\n// gets its own remembered UI state.\r\n\r\nconst DEFAULT_PREFIX = \"fizizbilite\";\r\n\r\nfunction safeRead(key, fallback) {\r\n  try {\r\n    const raw = window.localStorage.getItem(key);\r\n    if (raw == null) return fallback;\r\n    return JSON.parse(raw);\r\n  } catch {\r\n    return fallback;\r\n  }\r\n}\r\n\r\nfunction safeWrite(key, value) {\r\n  try {\r\n    window.localStorage.setItem(key, JSON.stringify(value));\r\n  } catch {\r\n    // ignore quota / privacy mode errors\r\n  }\r\n}\r\n\r\nexport function useScenarioScopeKey(prefix = DEFAULT_PREFIX, scopeOverride) {\r\n  const loc = useLocation();\r\n  return useMemo(() => {\r\n    const override = typeof scopeOverride === \"string\" ? scopeOverride.trim() : \"\";\r\n    const scope = override || (loc.pathname + (loc.search || \"\"));\r\n    return prefix + \":\" + scope;\r\n  }, [prefix, scopeOverride, loc.pathname, loc.search]);\r\n}\r\n\r\n/**\r\n * Generic persisted state hook (localStorage), scoped by current scenario URL.\r\n *\r\n * NOTE: We intentionally avoid writing to a *new* scope key until we've loaded that\r\n * key's stored value. This prevents \"old state\" from being written into a newly\r\n * navigated scenario.\r\n */\r\nexport function useScenarioUiState(name, defaultValue, { prefix = DEFAULT_PREFIX, scope } = {}) {\r\n  const scopeKey = useScenarioScopeKey(prefix, scope);\r\n  const storageKey = useMemo(() => `${scopeKey}:ui:${name}`, [scopeKey, name]);\r\n\r\n  const loadedKeyRef = useRef(null);\r\n\r\n  const [state, setState] = useState(() => safeRead(storageKey, defaultValue));\r\n\r\n  // Load when the scope (school/scenario) changes\r\n  useEffect(() => {\r\n    loadedKeyRef.current = storageKey;\r\n    setState(safeRead(storageKey, defaultValue));\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [storageKey]);\r\n\r\n  // Persist changes (only after we loaded for this key)\r\n  useEffect(() => {\r\n    if (loadedKeyRef.current !== storageKey) return;\r\n    safeWrite(storageKey, state);\r\n  }, [storageKey, state]);\r\n\r\n  return [state, setState, storageKey];\r\n}\r\n\r\nexport function useScenarioUiFlag(name, defaultValue = false, opts) {\r\n  const [v, setV] = useScenarioUiState(name, !!defaultValue, opts);\r\n  const setFlag = (next) => setV(!!(typeof next === \"function\" ? next(v) : next));\r\n  return [!!v, setFlag];\r\n}\r\n\r\nexport function useScenarioUiString(name, defaultValue = \"\", opts) {\r\n  const [v, setV] = useScenarioUiState(name, String(defaultValue ?? \"\"), opts);\r\n  const setStr = (next) => setV(String(typeof next === \"function\" ? next(v) : next));\r\n  return [String(v ?? \"\"), setStr];\r\n}\r\n\r\nexport function useScenarioUiNumber(name, defaultValue = 0, opts) {\r\n  const [v, setV] = useScenarioUiState(name, Number(defaultValue ?? 0), opts);\r\n  const setNum = (next) => {\r\n    const raw = typeof next === \"function\" ? next(v) : next;\r\n    const n = Number(raw);\r\n    setV(Number.isFinite(n) ? n : 0);\r\n  };\r\n  return [Number(v ?? 0), setNum];\r\n}\r\n","import {\r\n  DEFAULT_PROGRESS_CONFIG,\r\n  buildProgressCatalog,\r\n  isNonEmptyString,\r\n  safeGet,\r\n  toNum,\r\n} from \"./progressCatalog\";\r\nimport { isHeadquarterScenario } from \"./scenarioProfile\";\r\n\r\nfunction isFilled(value, type) {\r\n  if (type === \"string\") return isNonEmptyString(value);\r\n  // For boolean fields we accept both true/false as \"filled\".\r\n  // Only null/undefined should be treated as missing.\r\n  if (type === \"boolean\") return typeof value === \"boolean\";\r\n  const n = toNum(value);\r\n  return n > 0;\r\n}\r\n\r\nfunction normalizeConfig(config) {\r\n  const defaults = DEFAULT_PROGRESS_CONFIG();\r\n  const input = config && typeof config === \"object\" ? config : {};\r\n  const sectionsInput = input.sections && typeof input.sections === \"object\" ? input.sections : {};\r\n  const out = { version: defaults.version, sections: {} };\r\n\r\n  Object.keys(defaults.sections).forEach((id) => {\r\n    const base = defaults.sections[id] || {};\r\n    const incoming = sectionsInput[id] && typeof sectionsInput[id] === \"object\" ? sectionsInput[id] : {};\r\n    out.sections[id] = {\r\n      enabled: typeof incoming.enabled === \"boolean\" ? incoming.enabled : base.enabled !== false,\r\n      mode: typeof incoming.mode === \"string\" && incoming.mode ? incoming.mode : base.mode,\r\n      min: incoming.min != null ? Number(incoming.min) : base.min,\r\n      selectedFields:\r\n        incoming.selectedFields && typeof incoming.selectedFields === \"object\" ? incoming.selectedFields : {},\r\n    };\r\n  });\r\n\r\n  return out;\r\n}\r\n\r\nexport function computeScenarioProgress({ inputs, norm, config, scenario } = {}) {\r\n  const catalog = buildProgressCatalog({ inputs, norm, scenario });\r\n  const normalizedConfig = normalizeConfig(config);\r\n  const isHQ = isHeadquarterScenario(inputs);\r\n  const HQ_INCLUDED_TABS = new Set([\"ik\", \"gelirler\", \"giderler\"]);\r\n\r\n  const sectionsById = new Map(catalog.sections.map((s) => [s.id, s]));\r\n  const sectionResults = new Map();\r\n  let totalUnits = 0;\r\n  let doneUnits = 0;\r\n  let overallTotalUnits = 0;\r\n  let overallDoneUnits = 0;\r\n\r\n  catalog.sections.forEach((section) => {\r\n    const cfg = normalizedConfig.sections[section.id] || {};\r\n    if (cfg.enabled === false) {\r\n      sectionResults.set(section.id, { enabled: false });\r\n      return;\r\n    }\r\n    const includeInOverall = !isHQ || HQ_INCLUDED_TABS.has(section.tabKey);\r\n    const addUnits = (total, done) => {\r\n      totalUnits += total;\r\n      doneUnits += done;\r\n      if (includeInOverall) {\r\n        overallTotalUnits += total;\r\n        overallDoneUnits += done;\r\n      }\r\n    };\r\n\r\n    const requiresKademe = section.requiresKademe === true;\r\n    const hasKademeSelection = catalog.context?.hasKademeSelection;\r\n    const noKademeMode = catalog.context?.noKademeMode === true;\r\n    const kademeSelectedButEmpty =\r\n      Boolean(hasKademeSelection) &&\r\n      catalog.context?.enabledKademes &&\r\n      catalog.context.enabledKademes.size === 0;\r\n    if (requiresKademe && kademeSelectedButEmpty) {\r\n      sectionResults.set(section.id, {\r\n        enabled: true,\r\n        done: true,\r\n        doneUnits: 0,\r\n        totalUnits: 0,\r\n        missingReasons: [],\r\n      });\r\n      return;\r\n    }\r\n    if (requiresKademe && !hasKademeSelection) {\r\n      sectionResults.set(section.id, {\r\n        enabled: true,\r\n        done: false,\r\n        doneUnits: 0,\r\n        totalUnits: 1,\r\n        missingReasons: [\"Kademeler secilmedi\"],\r\n      });\r\n      addUnits(1, 0);\r\n      return;\r\n    }\r\n    if (noKademeMode && section.id === \"gelirler.unitFee\") {\r\n      sectionResults.set(section.id, {\r\n        enabled: true,\r\n        done: true,\r\n        doneUnits: 0,\r\n        totalUnits: 0,\r\n        missingReasons: [],\r\n      });\r\n      return;\r\n    }\r\n\r\n    const fieldIds = Array.isArray(section.fields) ? section.fields : [];\r\n    const selectedIds = fieldIds.filter((id) => cfg.selectedFields?.[id] !== false);\r\n    if (selectedIds.length === 0) {\r\n      if (section.allowEmpty === false) {\r\n        sectionResults.set(section.id, {\r\n          enabled: true,\r\n          done: false,\r\n          doneUnits: 0,\r\n          totalUnits: 1,\r\n          missingReasons: [section.label || \"Eksik\"],\r\n        });\r\n        addUnits(1, 0);\r\n      } else {\r\n        sectionResults.set(section.id, {\r\n          enabled: true,\r\n          done: true,\r\n          doneUnits: 0,\r\n          totalUnits: 0,\r\n          missingReasons: [],\r\n        });\r\n      }\r\n      return;\r\n    }\r\n    const applicable = selectedIds\r\n      .map((id) => catalog.fieldsById[id])\r\n      .filter(Boolean)\r\n      .filter((field) => {\r\n        if (typeof field.appliesIf !== \"function\") return true;\r\n        try {\r\n          return field.appliesIf(inputs, norm, scenario) !== false;\r\n        } catch (_) {\r\n          return true;\r\n        }\r\n      });\r\n\r\n    const filled = [];\r\n    const missing = [];\r\n\r\n    applicable.forEach((field) => {\r\n      let value = null;\r\n      try {\r\n        value = field.getValue ? field.getValue(inputs, norm) : null;\r\n      } catch (_) {\r\n        value = null;\r\n      }\r\n      const ok = isFilled(value, field.type);\r\n      if (ok) filled.push(field);\r\n      else missing.push(field);\r\n    });\r\n\r\n    const filledCount = filled.length;\r\n    let mode = String(cfg.mode || section.modeDefault || \"ALL\").toUpperCase();\r\n    let minRequired = Number.isFinite(Number(cfg.min)) ? Number(cfg.min) : section.minDefault;\r\n    if (isHQ && section.id === \"ik.localStaff\") {\r\n      mode = \"MIN\";\r\n      minRequired = 1;\r\n    }\r\n\r\n    if (mode === \"MIN\") {\r\n      const min = Math.max(1, Number.isFinite(minRequired) ? minRequired : 1);\r\n      const done = filledCount >= min;\r\n      const doneCount = Math.min(filledCount, min);\r\n      sectionResults.set(section.id, {\r\n        enabled: true,\r\n        done,\r\n        doneUnits: doneCount,\r\n        totalUnits: min,\r\n        missingReasons: done ? [] : [`En az ${min} alan`],\r\n      });\r\n      addUnits(min, doneCount);\r\n      return;\r\n    }\r\n\r\n    const total = applicable.length;\r\n    if (total === 0) {\r\n      if (section.allowEmpty === false) {\r\n        sectionResults.set(section.id, {\r\n          enabled: true,\r\n          done: false,\r\n          doneUnits: 0,\r\n          totalUnits: 1,\r\n          missingReasons: [section.label || \"Eksik\"],\r\n        });\r\n        addUnits(1, 0);\r\n      } else {\r\n        sectionResults.set(section.id, {\r\n          enabled: true,\r\n          done: true,\r\n          doneUnits: 0,\r\n          totalUnits: 0,\r\n          missingReasons: [],\r\n        });\r\n      }\r\n      return;\r\n    }\r\n\r\n    const done = filledCount === total;\r\n    const missingReasons = done\r\n      ? []\r\n      : missing.map((field) => field.label).filter(Boolean);\r\n\r\n    sectionResults.set(section.id, {\r\n      enabled: true,\r\n      done,\r\n      doneUnits: filledCount,\r\n      totalUnits: total,\r\n      missingReasons,\r\n    });\r\n    addUnits(total, filledCount);\r\n  });\r\n\r\n  const tabs = catalog.tabs.map((tab) => {\r\n    const sections = tab.sectionIds || [];\r\n    const enabledSections = sections\r\n      .map((id) => ({ id, result: sectionResults.get(id), def: sectionsById.get(id) }))\r\n      .filter((s) => s.result && s.result.enabled !== false);\r\n\r\n    let tabTotal = 0;\r\n    let tabDone = 0;\r\n    const missingLines = [];\r\n    let allDone = true;\r\n\r\n    enabledSections.forEach((s) => {\r\n      const res = s.result || {};\r\n      if (!res.done) allDone = false;\r\n      const t = Number(res.totalUnits || 0);\r\n      const d = Number(res.doneUnits || 0);\r\n      if (t > 0) {\r\n        tabTotal += t;\r\n        tabDone += d;\r\n      }\r\n      if (Array.isArray(res.missingReasons) && res.missingReasons.length) {\r\n        missingLines.push(...res.missingReasons);\r\n      }\r\n    });\r\n\r\n    const pct = tabTotal\r\n      ? Math.round((tabDone / tabTotal) * 100)\r\n      : allDone\r\n        ? 100\r\n        : 0;\r\n    const missingPreview = missingLines.length ? missingLines.join(\" / \") : \"\";\r\n\r\n    return {\r\n      key: tab.key,\r\n      label: tab.label,\r\n      pct,\r\n      done: allDone,\r\n      missingPreview,\r\n      missingLines,\r\n    };\r\n  });\r\n\r\n  const effectiveTotal = isHQ ? overallTotalUnits : totalUnits;\r\n  const effectiveDone = isHQ ? overallDoneUnits : doneUnits;\r\n  const pct = effectiveTotal ? Math.round((effectiveDone / effectiveTotal) * 100) : 100;\r\n  const missingDetailsLines = tabs\r\n    .filter((t) => !t.done)\r\n    .filter((t) => (!isHQ ? true : HQ_INCLUDED_TABS.has(t.key)))\r\n    .map((t) => {\r\n      const reasons = t.missingPreview || \"Eksik alanlar\";\r\n      return `${t.label}: ${reasons}`;\r\n    });\r\n\r\n  const visibleTabs = isHQ ? tabs.filter((t) => HQ_INCLUDED_TABS.has(t.key)) : tabs;\r\n  const completedCount = visibleTabs.filter((t) => t.done).length;\r\n  const totalCount = visibleTabs.length;\r\n\r\n  return {\r\n    pct,\r\n    completedCount,\r\n    totalCount,\r\n    tabs,\r\n    missingDetailsLines,\r\n  };\r\n}\r\n\r\nexport { safeGet, toNum, isNonEmptyString };\r\n","// frontend/src/pages/SchoolPage.jsx\r\n\r\nimport React, { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { Outlet, useLocation, useNavigate, useOutletContext, useParams } from \"react-router-dom\";\r\nimport { ToastContainer, toast } from \"react-toastify\";\r\nimport { api } from \"../api\";\r\nimport Tooltip from \"../components/ui/Tooltip\";\r\nimport { can } from \"../utils/permissions\";\r\nimport { getGradeOptions, normalizeKademeConfig, summarizeGradesByKademe } from \"../utils/kademe\";\r\nimport { computeScenarioProgress } from \"../utils/scenarioProgress\";\r\nimport { useScenarioUiState, useScenarioUiString } from \"../hooks/useScenarioUIState\";\r\nimport { FaCalculator, FaCheckCircle, FaFileExport, FaPaperPlane, FaSave } from \"react-icons/fa\";\r\nimport {\r\n  readLastVisitedPath,\r\n  readSelectedScenarioId,\r\n  writeLastVisitedPath,\r\n  writeSelectedScenarioId,\r\n  writeGlobalLastRouteSegment,\r\n  writeScenarioFlags,\r\n} from \"../utils/schoolNavStorage\";\r\nimport { getProgramType, mapBaseKademeToVariant, normalizeProgramType } from \"../utils/programType\";\r\nimport { isHeadquarterScenario } from \"../utils/scenarioProfile\";\r\n\r\n// Helper: Convert dirty input paths to permission resource keys for modifiedResources.\r\n// It strips a leading 'inputs.' prefix (if present), converts camelCase\r\n// tokens to snake_case, and returns page-level and section-level resources.\r\n// Example: 'inputs.gelirler.unitFee'  ['page.gelirler','section.gelirler.unit_fee'].\r\n/**\r\n * Convert a dirty input path into a list of permission resources.  The\r\n * function returns at most two resources: a pagelevel resource (always)\r\n * and, when a known mapping exists, a sectionlevel resource.  It\r\n * normalizes camelCase tokens to snake_case and applies custom\r\n * section mappings to ensure that generated section keys align with the\r\n * backend permissions catalog.  Unknown sections fall back to pagelevel\r\n * only.\r\n *\r\n * For example:\r\n *   'inputs.gelirler.tuition.rows.0.amount'  ['page.gelirler','section.gelirler.unit_fee']\r\n *   'inputs.temelBilgiler.performans.degerlendirme'  ['page.temel_bilgiler','section.temel_bilgiler.performans']\r\n *   'inputs.ik.years.y1'  ['page.ik','section.ik.local_staff']\r\n *\r\n * The SECTION_KEY_MAPPING constant below defines mappings from secondlevel\r\n * keys to canonical section names per page.  A wildcard '*' entry may be\r\n * used to map any key to a default section.  A mapping value of null\r\n * indicates that no sectionlevel resource should be generated for that key.\r\n *\r\n * @param {string} path Dirty input path (e.g. 'inputs.gelirler.tuition.rows.0.amount')\r\n * @returns {string[]} List of permission resource keys\r\n */\r\nfunction pathToResources(path) {\r\n  const result = [];\r\n  if (!path) return result;\r\n  const tokens = String(path).split('.');\r\n  // Strip a leading 'inputs.' prefix to isolate the module and section keys.\r\n  if (tokens.length > 0 && tokens[0] === 'inputs') {\r\n    tokens.shift();\r\n  }\r\n  if (tokens.length === 0) return result;\r\n  // Special-case: grades inputs are edited inside the Norm page, so map them to Norm permissions.\r\n  const gradeInputPages = new Set([\"gradesYears\", \"gradesCurrent\", \"grades\", \"grades_years\", \"grades_current\"]);\r\n  if (gradeInputPages.has(tokens[0])) {\r\n    result.push(\"section.norm.ders_dagilimi\");\r\n    return result;\r\n  }\r\n  // Normalize the module (page) token from camelCase to snake_case.\r\n  const pageRaw = tokens[0];\r\n  let page = pageRaw.replace(/([a-z0-9])([A-Z])/g, '$1_$2').toLowerCase();\r\n  const PAGE_ALIASES = {\r\n    grades_years: \"grades_plan\",\r\n    grades_current: \"grades_plan\",\r\n    grades: \"grades_plan\",\r\n  };\r\n  if (Object.prototype.hasOwnProperty.call(PAGE_ALIASES, page)) {\r\n    page = PAGE_ALIASES[page];\r\n  }\r\n  if (!page) return result;\r\n  // If a section token exists, map it to a canonical section resource key.  If\r\n  // mapping yields a non-null value, return only the section-level resource.\r\n  // Otherwise, fall back to the page-level resource.  This avoids sending\r\n  // both the page and section resources for the same change, which would\r\n  // incorrectly require the user to have write access on both resources.\r\n  if (tokens.length >= 2) {\r\n    const sectionRaw = tokens[1];\r\n    const sectionSnake = sectionRaw.replace(/([a-z0-9])([A-Z])/g, '$1_$2').toLowerCase();\r\n    const SECTION_KEY_MAPPING = {\r\n      temel_bilgiler: {\r\n        inflation: 'inflation',\r\n        ucret_artis_oranlari: 'inflation',\r\n        okul_ucretleri_hesaplama: 'inflation',\r\n        ik_mevcut: 'ik_mevcut',\r\n        burs_indirim_ogrenci_sayilari: 'burs_ogr',\r\n        burs_ogr: 'burs_ogr',\r\n        rakip_analizi: 'rakip',\r\n        rakip: 'rakip',\r\n        performans: 'performans',\r\n        degerlendirme: 'performans',\r\n        okul_egitim_bilgileri: 'okul_egitim',\r\n        yetkililer: null,\r\n        kademeler: null,\r\n        program_type: null,\r\n      },\r\n      gelirler: {\r\n        '*': 'unit_fee',\r\n      },\r\n      giderler: {\r\n        '*': 'isletme',\r\n      },\r\n      ik: {\r\n        '*': 'local_staff',\r\n      },\r\n      discounts: {\r\n        '*': 'discounts',\r\n      },\r\n      norm: {\r\n        '*': 'ders_dagilimi',\r\n      },\r\n      grades_plan: {\r\n        '*': 'plan',\r\n      },\r\n      kapasite: {\r\n        '*': 'caps',\r\n      },\r\n    };\r\n    const pageMap = SECTION_KEY_MAPPING[page];\r\n    let mapped = null;\r\n    if (pageMap) {\r\n      if (Object.prototype.hasOwnProperty.call(pageMap, sectionSnake)) {\r\n        mapped = pageMap[sectionSnake];\r\n      } else if (Object.prototype.hasOwnProperty.call(pageMap, '*')) {\r\n        mapped = pageMap['*'];\r\n      } else {\r\n        // If no explicit mapping exists, use the normalized section name directly.\r\n        mapped = sectionSnake;\r\n      }\r\n    } else {\r\n      // For pages with no mapping defined, use the normalized section name.\r\n      mapped = sectionSnake;\r\n    }\r\n    if (mapped) {\r\n      // When a section-level mapping exists (mapped !== null), return only\r\n      // the section-level resource.  Do not include the page-level resource\r\n      // because a section write implicitly requires only section permission.\r\n      result.push(`section.${page}.${mapped}`);\r\n      return result;\r\n    }\r\n  }\r\n  // Fall back to the page-level resource if no section mapping applies.\r\n  result.push(`page.${page}`);\r\n  return result;\r\n}\r\n\r\nfunction isScenarioLocked(scenario) {\r\n  const status = String(scenario?.status || \"draft\");\r\n  const submittedAt = scenario?.submitted_at != null;\r\n  const sentAt = scenario?.sent_at != null;\r\n  return (\r\n    status === \"sent_for_approval\" ||\r\n    status === \"submitted\" ||\r\n    (status === \"approved\" && sentAt) ||\r\n    (status === \"in_review\" && submittedAt)\r\n  );\r\n}\r\n\r\n\r\n\r\nconst INPUT_HEADER_TABS = new Set([\"basics\", \"kapasite\", \"income\", \"expenses\", \"norm\", \"hr\", \"detailedReport\", \"report\"]);\r\nconst TAB_TO_ROUTE = {\r\n  basics: \"temel-bilgiler\",\r\n  kapasite: \"kapasite\",\r\n  norm: \"norm\",\r\n  hr: \"ik\",\r\n  income: \"gelirler\",\r\n  expenses: \"giderler\",\r\n  detailedReport: \"detayli-rapor\",\r\n  report: \"rapor\",\r\n};\r\nconst ROUTE_TO_TAB = Object.fromEntries(Object.entries(TAB_TO_ROUTE).map(([key, value]) => [value, key]));\r\nconst TAB_TO_WORK_ID = {\r\n  basics: \"temel_bilgiler\",\r\n  kapasite: \"kapasite\",\r\n  norm: \"norm.ders_dagilimi\",\r\n  hr: \"ik.local_staff\",\r\n  income: \"gelirler.unit_fee\",\r\n  expenses: \"giderler.isletme\",\r\n};\r\nconst HQ_REQUIRED_WORK_IDS = new Set([\"ik.local_staff\", \"gelirler.unit_fee\", \"giderler.isletme\"]);\r\n\r\nfunction parseAcademicYear(academicYear) {\r\n  const s = String(academicYear || \"\").trim();\r\n  const range = s.match(/(\\d{4})\\s*-\\s*(\\d{4})/);\r\n  if (range) {\r\n    const startYear = Number(range[1]);\r\n    const endYear = Number(range[2]);\r\n    if (Number.isFinite(startYear) && Number.isFinite(endYear)) {\r\n      return { startYear, endYear };\r\n    }\r\n  }\r\n  const single = s.match(/^(\\d{4})$/);\r\n  if (single) {\r\n    const startYear = Number(single[1]);\r\n    if (Number.isFinite(startYear)) return { startYear, endYear: startYear };\r\n  }\r\n  return { startYear: null, endYear: null };\r\n}\r\n\r\nfunction pctValue(tab) {\r\n  const n = Number(tab?.pct);\r\n  return Number.isFinite(n) ? n : 0;\r\n}\r\n\r\nfunction mergeMissingLines(a, b) {\r\n  const out = [];\r\n  const seen = new Set();\r\n  [a, b].forEach((list) => {\r\n    if (!Array.isArray(list)) return;\r\n    list.forEach((line) => {\r\n      const val = String(line || \"\").trim();\r\n      if (!val || seen.has(val)) return;\r\n      seen.add(val);\r\n      out.push(val);\r\n    });\r\n  });\r\n  return out.slice(0, 15);\r\n}\r\n\r\nfunction findArrayItemIndex(arr, part) {\r\n  if (!Array.isArray(arr)) return -1;\r\n  const byKey = arr.findIndex(\r\n    (item) => item && typeof item === \"object\" && \"key\" in item && String(item.key) === part\r\n  );\r\n  if (byKey !== -1) return byKey;\r\n  const byName = arr.findIndex(\r\n    (item) => item && typeof item === \"object\" && \"name\" in item && String(item.name) === part\r\n  );\r\n  if (byName !== -1) return byName;\r\n  const byGrade = arr.findIndex(\r\n    (item) => item && typeof item === \"object\" && \"grade\" in item && String(item.grade) === part\r\n  );\r\n  if (byGrade !== -1) return byGrade;\r\n  const idx = Number(part);\r\n  if (Number.isInteger(idx) && String(idx) === part && idx >= 0 && idx < arr.length) return idx;\r\n  return -1;\r\n}\r\n\r\nfunction setValueAtPath(obj, parts, value) {\r\n  if (!obj || !Array.isArray(parts) || !parts.length) return false;\r\n  let cur = obj;\r\n  for (let i = 0; i < parts.length - 1; i++) {\r\n    const part = parts[i];\r\n    if (cur == null) return false;\r\n    if (Array.isArray(cur)) {\r\n      const idx = findArrayItemIndex(cur, part);\r\n      if (idx < 0) return false;\r\n      if (cur[idx] == null || typeof cur[idx] !== \"object\") cur[idx] = {};\r\n      cur = cur[idx];\r\n      continue;\r\n    }\r\n    if (typeof cur !== \"object\") return false;\r\n    if (cur[part] == null || typeof cur[part] !== \"object\") cur[part] = {};\r\n    cur = cur[part];\r\n  }\r\n  const last = parts[parts.length - 1];\r\n  if (Array.isArray(cur)) {\r\n    const idx = findArrayItemIndex(cur, last);\r\n    if (idx < 0) return false;\r\n    cur[idx] = value;\r\n    return true;\r\n  }\r\n  if (cur == null || typeof cur !== \"object\") return false;\r\n  cur[last] = value;\r\n  return true;\r\n}\r\n\r\nexport default function SchoolPage() {\r\n  const { id } = useParams();\r\n  const location = useLocation();\r\n  const navigate = useNavigate();\r\n  const outlet = useOutletContext();\r\n  const schoolId = Number(id);\r\n\r\n  const [school, setSchool] = useState(null);\r\n  const [err, setErr] = useState(\"\");\r\n\r\n  // user profile (region, country, etc.)\r\n  const [me, setMe] = useState(null);\r\n\r\n  useEffect(() => {\r\n    const base = \"Feasibility Studio\";\r\n    document.title = school?.name ? `${school.name}  ${base}` : `School  ${base}`;\r\n  }, [school?.name]);\r\n\r\n  // Selected scenario meta and related state must be defined before\r\n  // they are referenced in refreshWorkItems and submitWorkItem.\r\n  const [selectedScenario, setSelectedScenario] = useState(null);\r\n  const [prevReport, setPrevReport] = useState(null);\r\n  const [prevScenarioMeta, setPrevScenarioMeta] = useState(null);\r\n  // Work items list for the currently selected scenario.  Each entry\r\n  // represents a module (e.g. gelirler.unit_fee) and tracks its\r\n  // workflow state.  When the selected scenario changes the list is\r\n  // reloaded from the server.  Principals and HR users can submit\r\n  // modules for review via submitWorkItem, which will refresh this list.\r\n  const [workItems, setWorkItems] = useState([]);\r\n  const [workItemsLoaded, setWorkItemsLoaded] = useState(false);\r\n  const [requiredWorkIds, setRequiredWorkIds] = useState([]);\r\n  const [scenarioMetaLoaded, setScenarioMetaLoaded] = useState(false);\r\n  const [reviewingWorkItem, setReviewingWorkItem] = useState(false);\r\n\r\n  // scenarios\r\n  const [scenarios, setScenarios] = useState([]);\r\n  const [selectedScenarioId, setSelectedScenarioId] = useState(() => readSelectedScenarioId(schoolId));\r\n  const [pendingTabAfterSelect, setPendingTabAfterSelect] = useState(null);\r\n\r\n\r\n  // Refresh the work items for the current scenario.  This helper\r\n  // fetches the work item list from the backend and updates state.\r\n  // It is memoized on schoolId and selectedScenario.id to avoid\r\n  // unnecessary re-renders.  When no scenario is selected, it\r\n  // clears the list.\r\n  const refreshWorkItems = useCallback(async () => {\r\n    const sid = selectedScenario?.id;\r\n    if (!sid || !schoolId) {\r\n      setWorkItems([]);\r\n      setWorkItemsLoaded(false);\r\n      setRequiredWorkIds([]);\r\n      return;\r\n    }\r\n    try {\r\n      const data = await api.listWorkItems(schoolId, sid);\r\n      setWorkItems(Array.isArray(data?.workItems) ? data.workItems : []);\r\n      setRequiredWorkIds(Array.isArray(data?.requiredWorkIds) ? data.requiredWorkIds : []);\r\n      setWorkItemsLoaded(true);\r\n    } catch (_) {\r\n      // ignore errors, keep existing list\r\n      setRequiredWorkIds([]);\r\n      setWorkItemsLoaded(true);\r\n    }\r\n  }, [schoolId, selectedScenario?.id]);\r\n\r\n  // Refresh scenario metadata (status/sent_at/checked_at) without touching inputs/report.\r\n  const refreshScenarioMeta = useCallback(async () => {\r\n    if (!schoolId) return;\r\n    setScenarioMetaLoaded(false);\r\n    try {\r\n      const data = await api.listScenarios(schoolId, {\r\n        limit: 50,\r\n        offset: 0,\r\n        fields: \"brief\",\r\n        order: \"created_at:desc\",\r\n      });\r\n      const list = Array.isArray(data?.items) ? data.items : [];\r\n      setScenarios(list);\r\n      const scenarioId = selectedScenarioId ?? selectedScenario?.id;\r\n      if (scenarioId != null) {\r\n        const nextScenario = list.find((item) => String(item?.id) === String(scenarioId));\r\n        if (nextScenario) {\r\n          setSelectedScenario((prev) => (prev ? { ...prev, ...nextScenario } : nextScenario));\r\n        }\r\n      }\r\n      setScenarioMetaLoaded(true);\r\n    } catch (_) {\r\n      // ignore errors, keep existing meta\r\n      setScenarioMetaLoaded(false);\r\n    }\r\n  }, [schoolId, selectedScenarioId, selectedScenario?.id]);\r\n\r\n  // Submit a work item for review.  Accepts a workId string.  On\r\n  // success the work items are refreshed and a toast is shown.\r\n  const submitWorkItem = useCallback(\r\n    async (workId) => {\r\n      const sid = selectedScenario?.id;\r\n      if (!sid || !schoolId || !workId) return;\r\n      try {\r\n        await api.submitWorkItem(schoolId, sid, workId);\r\n        await refreshWorkItems();\r\n        await refreshScenarioMeta();\r\n        toast.success(\"Modl gnderildi.\");\r\n      } catch (e) {\r\n        toast.error(e.message || \"Gnderme baarsz\");\r\n      }\r\n    },\r\n    [schoolId, selectedScenario?.id, refreshWorkItems, refreshScenarioMeta]\r\n  );\r\n\r\n\r\n  // Fetch work items whenever the selected scenario changes.  If there\r\n  // is no scenario selected the list is cleared.  The refreshWorkItems\r\n  // dependency ensures that any changes to schoolId or scenario id are\r\n  // respected.\r\n  useEffect(() => {\r\n    if (!selectedScenario?.id) {\r\n      setWorkItems([]);\r\n      setWorkItemsLoaded(false);\r\n      setScenarioMetaLoaded(false);\r\n      return;\r\n    }\r\n    setWorkItemsLoaded(false);\r\n    setScenarioMetaLoaded(false);\r\n    refreshWorkItems();\r\n  }, [selectedScenario?.id, refreshWorkItems]);\r\n\r\n  // removed duplicate declarations for selectedScenario, prevReport,\r\n  // prevScenarioMeta, and workItems. These are now defined earlier\r\n  // before they are used in callbacks.\r\n\r\n  // norm\r\n  const [norm, setNorm] = useState(null);\r\n  const [progressConfig, setProgressConfig] = useState(null);\r\n\r\n  // inputs\r\n  const [inputs, setInputs] = useState(null);\r\n  const [inputsSaving, setInputsSaving] = useState(false);\r\n  const [dirtyPaths, setDirtyPaths] = useState(() => new Set());\r\n  const [baselineInputs, setBaselineInputs] = useState(null);\r\n  const [baselineNorm, setBaselineNorm] = useState(null);\r\n  const clearDirtyPrefix = useCallback((prefix) => {\r\n    setDirtyPaths((prev) => {\r\n      if (!prev.size) return prev;\r\n      let changed = false;\r\n      const next = new Set();\r\n      for (const path of prev) {\r\n        if (path.startsWith(prefix)) {\r\n          changed = true;\r\n          continue;\r\n        }\r\n        next.add(path);\r\n      }\r\n      return changed ? next : prev;\r\n    });\r\n  }, []);\r\n  const hasDirtyPrefix = useCallback(\r\n    (prefix) => {\r\n      for (const path of dirtyPaths) {\r\n        if (path === prefix || path.startsWith(prefix)) return true;\r\n      }\r\n      return false;\r\n    },\r\n    [dirtyPaths]\r\n  );\r\n  // report\r\n  const [report, setReport] = useState(null);\r\n  const [calculating, setCalculating] = useState(false);\r\n  const [lastSavedAt, setLastSavedAt] = useState(null);\r\n  const [lastCalculatedAt, setLastCalculatedAt] = useState(null);\r\n  const [nowTick, setNowTick] = useState(0);\r\n  const [exportOpen, setExportOpen] = useState(false);\r\n  const exportMenuRef = useRef(null);\r\n  const reportExportRef = useRef(null);\r\n  const [exportingPdf, setExportingPdf] = useState(false);\r\n  // Page boot loading (used to show a spinner while auto-starting the scenario wizard)\r\n  const [bootLoading, setBootLoading] = useState(true);\r\n  const [bootLoadingLabel, setBootLoadingLabel] = useState(\"Okul ailiyor...\");\r\n\r\n  useEffect(() => {\r\n    setSelectedScenarioId(readSelectedScenarioId(schoolId));\r\n  }, [schoolId]);\r\n\r\n  const uiScopeKey = useMemo(\r\n    () => `school:${schoolId}:scenario:${selectedScenarioId ?? \"none\"}`,\r\n    [schoolId, selectedScenarioId]\r\n  );\r\n  const [reportCurrency, setReportCurrency] = useScenarioUiState(\"report.currency\", \"usd\", { scope: uiScopeKey });\r\n  const reportCurrencyDefaultedForRef = useRef(null);\r\n  const [reportMode, setReportMode] = useScenarioUiState(\"report.mode\", \"original\", { scope: uiScopeKey });\r\n  const [reportModeLoading, setReportModeLoading] = useState(false);\r\n  const [detailedReportMode, setDetailedReportMode] = useScenarioUiString(\"school.detailedReportMode\", \"detailed\", { scope: uiScopeKey });\r\n  const activeRouteSegment = useMemo(() => {\r\n    const base = `/schools/${schoolId}/`;\r\n    if (!location.pathname.startsWith(base)) return \"\";\r\n    return location.pathname.slice(base.length).split(\"/\")[0] || \"\";\r\n  }, [location.pathname, schoolId]);\r\n  const tab = ROUTE_TO_TAB[activeRouteSegment] || \"\";\r\n  const activeWorkId = TAB_TO_WORK_ID[tab] || null;\r\n  const activeWorkItem = useMemo(() => {\r\n    if (!activeWorkId || !Array.isArray(workItems)) return null;\r\n    return workItems.find((item) => String(item?.work_id) === String(activeWorkId)) || null;\r\n  }, [activeWorkId, workItems]);\r\n  const activeWorkState = activeWorkItem?.state ? String(activeWorkItem.state) : \"not_started\";\r\n  const moduleLocked = [\"submitted\", \"approved\"].includes(activeWorkState);\r\n  const setTab = React.useCallback(\r\n    (nextTab) => {\r\n      const segment = TAB_TO_ROUTE[nextTab];\r\n      if (!segment) return;\r\n      navigate(`/schools/${schoolId}/${segment}`);\r\n    },\r\n    [navigate, schoolId]\r\n  );\r\n\r\n  useEffect(() => {\r\n    // Persist the current route segment for the given school and scenario. When\r\n    // no scenario is selected (`selectedScenarioId` is null) the helper will\r\n    // store the path under a \"none\" scenario key. This ensures that we\r\n    // remember the last page even before a scenario is chosen.\r\n    if (!ROUTE_TO_TAB[activeRouteSegment]) return;\r\n    writeLastVisitedPath(schoolId, selectedScenarioId, activeRouteSegment);\r\n  }, [activeRouteSegment, schoolId, selectedScenarioId]);\r\n\r\n  // Persist the current route segment globally so that when switching between\r\n  // schools or scenarios the user returns to the same sidebar page. This is\r\n  // independent of school or scenario context.\r\n  useEffect(() => {\r\n    if (!ROUTE_TO_TAB[activeRouteSegment]) return;\r\n    writeGlobalLastRouteSegment(activeRouteSegment);\r\n  }, [activeRouteSegment]);\r\n\r\n  useEffect(() => {\r\n    // When the user loads the base school path (e.g. `/schools/4`), redirect to\r\n    // the last visited route for the current school and scenario. If no\r\n    // scenario is selected we still look up the \"none\" scenario key. If\r\n    // nothing is recorded, default to the basics tab.\r\n    const base = `/schools/${schoolId}`;\r\n    if (location.pathname !== base && location.pathname !== `${base}/`) return;\r\n    const last = readLastVisitedPath(schoolId, selectedScenarioId);\r\n    const targetSegment = last || TAB_TO_ROUTE.basics;\r\n    const target = `${base}/${targetSegment}`;\r\n    navigate(target, { replace: true });\r\n  }, [location.pathname, navigate, schoolId, selectedScenarioId]);\r\n\r\n  useEffect(() => {\r\n    setBootLoading(true);\r\n    setBootLoadingLabel(\"Okul ailiyor...\");\r\n  }, [schoolId]);\r\n\r\n  useEffect(() => {\r\n    if (!pendingTabAfterSelect) return;\r\n    if (!selectedScenarioId) return;\r\n    if (String(selectedScenarioId) !== String(pendingTabAfterSelect.scenarioId)) return;\r\n    setTab(pendingTabAfterSelect.tab);\r\n    setPendingTabAfterSelect(null);\r\n  }, [pendingTabAfterSelect, selectedScenarioId, setTab]);\r\n\r\n  useEffect(() => {\r\n    const id = setInterval(() => setNowTick(Date.now()), 30000);\r\n    return () => clearInterval(id);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!exportOpen) return;\r\n    const handleClick = (event) => {\r\n      const el = exportMenuRef.current;\r\n      if (!el || el.contains(event.target)) return;\r\n      setExportOpen(false);\r\n    };\r\n    const handleKey = (event) => {\r\n      if (event.key === \"Escape\") setExportOpen(false);\r\n    };\r\n    document.addEventListener(\"mousedown\", handleClick);\r\n    document.addEventListener(\"keydown\", handleKey);\r\n    return () => {\r\n      document.removeEventListener(\"mousedown\", handleClick);\r\n      document.removeEventListener(\"keydown\", handleKey);\r\n    };\r\n  }, [exportOpen]);\r\n\r\n\r\n  const scenarioYears = parseAcademicYear(selectedScenario?.academic_year);\r\n  const baseYear = scenarioYears.startYear;\r\n  const inputCurrencyCode =\r\n    selectedScenario?.input_currency === \"LOCAL\"\r\n      ? (selectedScenario.local_currency_code || \"LOCAL\")\r\n      : \"USD\";\r\n  const isLocalScenario = selectedScenario?.input_currency === \"LOCAL\";\r\n  const prevRealFxValue = Number(inputs?.temelBilgiler?.performans?.prevYearRealizedFxUsdToLocal || 0);\r\n  const prevRealFxMissing = isLocalScenario && !(Number.isFinite(prevRealFxValue) && prevRealFxValue > 0);\r\n\r\n  const programType = useMemo(() => getProgramType(inputs, selectedScenario), [inputs, selectedScenario]);\r\n  const permissionScope = useMemo(() => {\r\n    const countryId = school?.country_id ?? me?.country_id ?? null;\r\n    return { schoolId, countryId };\r\n  }, [schoolId, school?.country_id, me?.country_id]);\r\n  const canReadNorm = useMemo(() => {\r\n    try {\r\n      return can(me, \"page.norm\", \"read\", permissionScope);\r\n    } catch {\r\n      return false;\r\n    }\r\n  }, [me, permissionScope]);\r\n  const canWriteGiderler = useMemo(() => {\r\n    try {\r\n      if (can(me, \"section.giderler.isletme\", \"write\", permissionScope)) return true;\r\n      return can(me, \"page.giderler\", \"write\", permissionScope);\r\n    } catch {\r\n      return false;\r\n    }\r\n  }, [me, permissionScope]);\r\n  const ignoreNormProgress = !norm && !canReadNorm;\r\n\r\n  const scenarioProgress = useMemo(\r\n    () => computeScenarioProgress({ inputs, norm, config: progressConfig, scenario: selectedScenario }),\r\n    [inputs, norm, progressConfig, selectedScenario]\r\n  );\r\n  const isHQ = useMemo(() => isHeadquarterScenario(inputs), [inputs]);\r\n  useEffect(() => {\r\n    if (schoolId && selectedScenarioId && inputs) {\r\n      writeScenarioFlags(schoolId, selectedScenarioId, { isHeadquarter: isHQ });\r\n    }\r\n  }, [schoolId, selectedScenarioId, inputs, isHQ]);\r\n  const progMap = useMemo(\r\n    () => Object.fromEntries((scenarioProgress?.tabs || []).map((t) => [t.key, t])),\r\n    [scenarioProgress]\r\n  );\r\n  const normAvgPct = useMemo(() => {\r\n    const a = pctValue(progMap.gradesPlan);\r\n    const b = ignoreNormProgress ? a : pctValue(progMap.norm);\r\n    return Math.round((a + b) / 2);\r\n  }, [progMap, ignoreNormProgress]);\r\n  const expensesAvgPct = useMemo(() => {\r\n    const a = pctValue(progMap.giderler);\r\n    if (isHQ) return a;\r\n    // Use the new discounts key instead of the legacy indirimler key.  If the\r\n    // discounts tab is missing, default to 0 for the percentage value.\r\n    const b = pctValue(progMap.discounts);\r\n    return Math.round((a + b) / 2);\r\n  }, [progMap, isHQ]);\r\n  const normMissingLines = useMemo(\r\n    () => mergeMissingLines(progMap.gradesPlan?.missingLines, progMap.norm?.missingLines),\r\n    [progMap]\r\n  );\r\n  const expensesMissingLines = useMemo(\r\n    () =>\r\n      isHQ\r\n        ? Array.isArray(progMap.giderler?.missingLines)\r\n          ? progMap.giderler.missingLines\r\n          : []\r\n        : mergeMissingLines(progMap.giderler?.missingLines, progMap.discounts?.missingLines),\r\n    [progMap, isHQ]\r\n  );\r\n\r\n  const fetchScenarioReport = useCallback(\r\n    async (mode) => {\r\n      if (!selectedScenarioId) return;\r\n      const nextMode = String(mode || \"original\");\r\n      setReportModeLoading(true);\r\n      setErr(\"\");\r\n      try {\r\n        const data = await api.getScenarioReport(schoolId, selectedScenarioId, nextMode);\r\n        setReport(data?.results || null);\r\n      } catch (e) {\r\n        setErr(e.message || \"Report fetch failed\");\r\n      } finally {\r\n        setReportModeLoading(false);\r\n      }\r\n    },\r\n    [schoolId, selectedScenarioId]\r\n  );\r\n\r\n  const handleReportModeChange = useCallback(\r\n    async (mode) => {\r\n      const nextMode = String(mode || \"original\");\r\n      if (nextMode === reportMode && report) return;\r\n      setReportMode(nextMode);\r\n      await fetchScenarioReport(nextMode);\r\n    },\r\n    [fetchScenarioReport, reportMode, report, setReportMode]\r\n  );\r\n  useEffect(() => {\r\n    if (!outlet?.setHeaderMeta) return;\r\n    outlet.setHeaderMeta({\r\n      title: school?.name ? school.name : \"Okul\",\r\n      subtitle: selectedScenario\r\n        ? `${selectedScenario.name}${selectedScenario.academic_year ? `  ${selectedScenario.academic_year}` : \"\"}`\r\n        : \"Senaryo sein\",\r\n      hideDefault: false,\r\n      centered: true,\r\n    });\r\n    return () => {\r\n      outlet.clearHeaderMeta?.();\r\n    };\r\n  }, [outlet, selectedScenario, school?.name]);\r\n\r\n  // A) Helper: HR(IK) -> Expenses(Isletme) 5 salary rows auto patch (uses 1.Yil / y1)\r\n  const applyIkSalariesToGiderler = useCallback((inInputs) => {\r\n    const src = inInputs || {};\r\n    const ik = src.ik || {};\r\n    const yearIK = ik?.years?.y1 ? ik.years.y1 : ik; // legacy support\r\n\r\n    const unitCosts = yearIK?.unitCosts || {};\r\n    const headcountsByLevel = yearIK?.headcountsByLevel || {};\r\n\r\n    const roles = [\r\n      \"turk_mudur\",\r\n      \"turk_mdyard\",\r\n      \"turk_egitimci\",\r\n      \"turk_temsil\",\r\n      \"yerel_yonetici_egitimci\",\r\n      \"yerel_destek\",\r\n      \"yerel_ulke_temsil_destek\",\r\n      \"int_yonetici_egitimci\",\r\n    ];\r\n\r\n    const levelKeys = Object.keys(headcountsByLevel || {});\r\n    const levels = levelKeys.length\r\n      ? levelKeys\r\n      : [\r\n          \"okulOncesi\",\r\n          \"ilkokulYerel\",\r\n          \"ilkokulInt\",\r\n          \"ortaokulYerel\",\r\n          \"ortaokulInt\",\r\n          \"liseYerel\",\r\n          \"liseInt\",\r\n        ];\r\n\r\n    const roleAnnual = {};\r\n    for (const r of roles) {\r\n      let count = 0;\r\n      for (const lvl of levels) count += Number(headcountsByLevel?.[lvl]?.[r] || 0);\r\n      roleAnnual[r] = Number(unitCosts?.[r] || 0) * count;\r\n    }\r\n\r\n    const patch = {\r\n      turkPersonelMaas:\r\n        (roleAnnual.turk_mudur || 0) +\r\n        (roleAnnual.turk_mdyard || 0) +\r\n        (roleAnnual.turk_egitimci || 0),\r\n      turkDestekPersonelMaas: roleAnnual.turk_temsil || 0,\r\n      yerelPersonelMaas: roleAnnual.yerel_yonetici_egitimci || 0,\r\n      yerelDestekPersonelMaas:\r\n        (roleAnnual.yerel_destek || 0) + (roleAnnual.yerel_ulke_temsil_destek || 0),\r\n      internationalPersonelMaas: roleAnnual.int_yonetici_egitimci || 0,\r\n    };\r\n\r\n    const prevItems = src?.giderler?.isletme?.items || {};\r\n    const keys = Object.keys(patch);\r\n\r\n    let changed = false;\r\n    for (const k of keys) {\r\n      const a = Number(prevItems?.[k] || 0);\r\n      const b = Number(patch?.[k] || 0);\r\n      if (Math.abs(a - b) > 1e-6) {\r\n        changed = true;\r\n        break;\r\n      }\r\n    }\r\n    if (!changed) return src;\r\n\r\n    const next = structuredClone(src);\r\n    next.giderler = next.giderler || {};\r\n    next.giderler.isletme = next.giderler.isletme || {};\r\n    next.giderler.isletme.items = next.giderler.isletme.items || {};\r\n    for (const k of keys) next.giderler.isletme.items[k] = Number(patch[k] || 0);\r\n    return next;\r\n  }, []);\r\n\r\n  const normalizeCapacityInputs = useCallback((src) => {\r\n    const safeNum = (v) => {\r\n      const n = Number(v);\r\n      return Number.isFinite(n) ? n : 0;\r\n    };\r\n\r\n    const s = src || {};\r\n    const legacy = safeNum(s.schoolCapacity);\r\n\r\n    const cap = s.kapasite && typeof s.kapasite === \"object\" ? s.kapasite : {};\r\n    const years = cap.years && typeof cap.years === \"object\" ? cap.years : {};\r\n\r\n    const y1 = safeNum(years.y1 != null ? years.y1 : legacy);\r\n    const y2 = safeNum(years.y2 != null ? years.y2 : y1);\r\n    const y3 = safeNum(years.y3 != null ? years.y3 : y1);\r\n\r\n    const currentStudents = safeNum(cap.currentStudents);\r\n    const byKademe = cap.byKademe && typeof cap.byKademe === \"object\" ? cap.byKademe : {};\r\n\r\n    const needsPatch =\r\n      \"schoolCapacity\" in s ||\r\n      !s.kapasite ||\r\n      typeof s.kapasite !== \"object\" ||\r\n      !cap.years ||\r\n      typeof cap.years !== \"object\" ||\r\n      safeNum(cap?.years?.y1) !== y1 ||\r\n      safeNum(cap?.years?.y2) !== y2 ||\r\n      safeNum(cap?.years?.y3) !== y3 ||\r\n      safeNum(cap?.currentStudents) !== currentStudents ||\r\n      !cap.byKademe ||\r\n      typeof cap.byKademe !== \"object\";\r\n\r\n    if (!needsPatch) return s;\r\n\r\n    const next = structuredClone(s);\r\n    next.kapasite = {\r\n      ...(cap || {}),\r\n      currentStudents,\r\n      years: { y1, y2, y3 },\r\n      byKademe,\r\n    };\r\n    if (\"schoolCapacity\" in next) delete next.schoolCapacity;\r\n    return next;\r\n  }, []);\r\n\r\n\r\n  const normalizeTemelBilgilerInputs = (src) => {\r\n    const s = src || {};\r\n    const t = s.temelBilgiler && typeof s.temelBilgiler === \"object\" ? s.temelBilgiler : {};\r\n    const next = structuredClone(s);\r\n\r\n    // inflation defaults\r\n    const inf = t.inflation && typeof t.inflation === \"object\" ? t.inflation : {};\r\n    const toFinite = (v) => (Number.isFinite(Number(v)) ? Number(v) : 0);\r\n    next.temelBilgiler = {\r\n      inflation: {\r\n        ...inf,\r\n        expenseDeviationPct: toFinite(inf.expenseDeviationPct),\r\n        y2023: toFinite(inf.y2023),\r\n        y2024: toFinite(inf.y2024),\r\n        y2025: toFinite(inf.y2025),\r\n        y1: toFinite(inf.y1),\r\n        y2: toFinite(inf.y2),\r\n        y3: toFinite(inf.y3),\r\n        currentSeasonAvgFee: toFinite(inf.currentSeasonAvgFee),\r\n      },\r\n      yetkililer: t.yetkililer || { mudur: \"\", ulkeTemsilcisi: \"\", raporuHazirlayan: \"\" },\r\n      okulEgitimBilgileri: t.okulEgitimBilgileri || {\r\n        egitimBaslamaTarihi: \"\",\r\n        zorunluEgitimDonemleri: \"\",\r\n        birDersSuresiDakika: 0,\r\n        gunlukDersSaati: 0,\r\n        haftalikDersSaatiToplam: 0,\r\n        sabahciOglenci: \"\",\r\n        ogretmenHaftalikDersOrt: 0,\r\n        gecisSinaviBilgisi: \"\",\r\n        uygulananProgram: \"\",\r\n      },\r\n      kademeler: normalizeKademeConfig(t.kademeler),\r\n      programType: normalizeProgramType(t.programType),\r\n      okulUcretleriHesaplama: typeof t.okulUcretleriHesaplama === \"boolean\" ? t.okulUcretleriHesaplama : true,\r\n      ucretArtisOranlari: t.ucretArtisOranlari || {\r\n        okulOncesi: 0,\r\n        ilkokulYerel: 0,\r\n        ilkokulInt: 0,\r\n        ortaokulYerel: 0,\r\n        ortaokulInt: 0,\r\n        liseYerel: 0,\r\n        liseInt: 0,\r\n      },\r\n      ikMevcut: t.ikMevcut || {\r\n        turkPersonelYoneticiEgitimci: 0,\r\n        turkPersonelTemsilcilik: 0,\r\n        yerelKadroluEgitimci: 0,\r\n        yerelUcretliVakaterEgitimci: 0,\r\n        yerelDestek: 0,\r\n        yerelTemsilcilik: 0,\r\n        international: 0,\r\n      },\r\n      bursIndirimOgrenciSayilari: t.bursIndirimOgrenciSayilari || {\r\n        magisBasariBursu: 0,\r\n        maarifYetenekBursu: 0,\r\n        ihtiyacBursu: 0,\r\n        okulBasariBursu: 0,\r\n        tamEgitimBursu: 0,\r\n        barinmaBursu: 0,\r\n        turkceBasariBursu: 0,\r\n        uluslararasiYukumlulukIndirimi: 0,\r\n        vakifCalisaniIndirimi: 0,\r\n        kardesIndirimi: 0,\r\n        erkenKayitIndirimi: 0,\r\n        pesinOdemeIndirimi: 0,\r\n        kademeGecisIndirimi: 0,\r\n        temsilIndirimi: 0,\r\n        kurumIndirimi: 0,\r\n        istisnaiIndirim: 0,\r\n        yerelMevzuatIndirimi: 0,\r\n      },\r\n      rakipAnalizi: t.rakipAnalizi || {\r\n        okulOncesi: { a: 0, b: 0, c: 0 },\r\n        ilkokul: { a: 0, b: 0, c: 0 },\r\n        ortaokul: { a: 0, b: 0, c: 0 },\r\n        lise: { a: 0, b: 0, c: 0 },\r\n      },\r\n      performans: t.performans || {\r\n        gerceklesen: { ogrenciSayisi: 0, gelirler: 0, giderler: 0, karZarar: 0, bursVeIndirimler: 0 },\r\n      },\r\n      degerlendirme: typeof t.degerlendirme === \"string\" ? t.degerlendirme : \"\",\r\n    };\r\n\r\n    return next;\r\n  };\r\n\r\n  const normalizeGradesInputs = useCallback((src) => {\r\n    const s = src || {};\r\n    const defaultGrades = getGradeOptions().map((g) => ({ grade: g, branchCount: 0, studentsPerBranch: 0 }));\r\n    const baseGrades = Array.isArray(s.grades) ? s.grades : defaultGrades;\r\n    const years = s.gradesYears && typeof s.gradesYears === \"object\" ? s.gradesYears : {};\r\n\r\n    const y1 = Array.isArray(years.y1) ? years.y1 : baseGrades;\r\n    const y2 = Array.isArray(years.y2) ? years.y2 : y1;\r\n    const y3 = Array.isArray(years.y3) ? years.y3 : y1;\r\n\r\n    const normalizeRow = (row) => ({\r\n      grade: String(row?.grade ?? \"\"),\r\n      branchCount: Number(row?.branchCount ?? 0),\r\n      studentsPerBranch: Number(row?.studentsPerBranch ?? 0),\r\n    });\r\n\r\n    const toMap = (list) => {\r\n      const m = new Map();\r\n      (Array.isArray(list) ? list : []).forEach((row) => {\r\n        const r = normalizeRow(row);\r\n        if (!r.grade) return;\r\n        m.set(r.grade, r);\r\n      });\r\n      return m;\r\n    };\r\n\r\n    const areGradesEqual = (a, b) => {\r\n      if (!Array.isArray(a) || !Array.isArray(b)) return false;\r\n      const ma = toMap(a);\r\n      const mb = toMap(b);\r\n      if (ma.size !== mb.size) return false;\r\n      for (const [grade, ra] of ma.entries()) {\r\n        const rb = mb.get(grade);\r\n        if (!rb) return false;\r\n        if (Number(ra.branchCount) !== Number(rb.branchCount)) return false;\r\n        if (Number(ra.studentsPerBranch) !== Number(rb.studentsPerBranch)) return false;\r\n      }\r\n      return true;\r\n    };\r\n\r\n    const needsPatch =\r\n      !s.gradesYears ||\r\n      !Array.isArray(s.grades) ||\r\n      !Array.isArray(years.y1) ||\r\n      !Array.isArray(years.y2) ||\r\n      !Array.isArray(years.y3) ||\r\n      !areGradesEqual(s.grades, y1);\r\n\r\n    if (!needsPatch) return s;\r\n\r\n    const next = structuredClone(s);\r\n    next.gradesYears = {\r\n      y1: structuredClone(y1),\r\n      y2: structuredClone(y2),\r\n      y3: structuredClone(y3),\r\n    };\r\n    next.grades = structuredClone(next.gradesYears.y1);\r\n    return next;\r\n  }, []);\r\n\r\n  const applyTuitionStudentCounts = useCallback((src) => {\r\n    const s = src && typeof src === \"object\" ? src : {};\r\n    const grades = s?.gradesYears?.y1 || s?.grades || [];\r\n    const sums = summarizeGradesByKademe(grades, s?.temelBilgiler?.kademeler);\r\n    const programType = getProgramType(s);\r\n    const variantCounts = {\r\n      okulOncesi: Number(sums.okulOncesi || 0),\r\n      ilkokulYerel: 0,\r\n      ilkokulInt: 0,\r\n      ortaokulYerel: 0,\r\n      ortaokulInt: 0,\r\n      liseYerel: 0,\r\n      liseInt: 0,\r\n    };\r\n    variantCounts[mapBaseKademeToVariant(\"ilkokul\", programType)] = Number(sums.ilkokul || 0);\r\n    variantCounts[mapBaseKademeToVariant(\"ortaokul\", programType)] = Number(sums.ortaokul || 0);\r\n    variantCounts[mapBaseKademeToVariant(\"lise\", programType)] = Number(sums.lise || 0);\r\n\r\n    const syncRows = (rows, getCount) => {\r\n      if (!Array.isArray(rows)) return { rows, changed: false };\r\n      let changed = false;\r\n      const nextRows = rows.map((r) => {\r\n        const key = String(r?.key ?? \"\");\r\n        const nextCount = getCount(key);\r\n        if (nextCount == null) return r;\r\n        const current = Number(r?.studentCount ?? 0);\r\n        if (Math.abs(current - nextCount) < 1e-6) return r;\r\n        changed = true;\r\n        return { ...r, studentCount: nextCount };\r\n      });\r\n      return { rows: changed ? nextRows : rows, changed };\r\n    };\r\n\r\n    const tuitionSync = syncRows(s?.gelirler?.tuition?.rows, (key) =>\r\n      Object.prototype.hasOwnProperty.call(variantCounts, key) ? variantCounts[key] : null\r\n    );\r\n\r\n    if (!tuitionSync.changed) return s;\r\n\r\n    const next = structuredClone(s);\r\n    next.gelirler = next.gelirler || {};\r\n    if (tuitionSync.changed) {\r\n      next.gelirler.tuition = next.gelirler.tuition || {};\r\n      next.gelirler.tuition.rows = tuitionSync.rows;\r\n    }\r\n    return next;\r\n  }, []);\r\n\r\n\r\n  async function loadAll() {\r\n    setErr(\"\");\r\n    setBootLoading(true);\r\n    setBootLoadingLabel(\"Okul ailiyor...\");\r\n    try {\r\n      const s = await api.getSchool(schoolId);\r\n      setSchool(s);\r\n\r\n      // load current user profile (region/country)\r\n      try {\r\n        const meInfo = await api.getMe();\r\n        setMe(meInfo);\r\n      } catch (_) {\r\n        // ignore (e.g., token missing)\r\n      }\r\n\r\n      setBootLoadingLabel(\"Senaryolar kontrol ediliyor...\");\r\n      const sc = await api.listScenarios(schoolId, {\r\n        limit: 50,\r\n        offset: 0,\r\n        fields: \"brief\",\r\n        order: \"created_at:desc\",\r\n      });\r\n      const rows = Array.isArray(sc?.items) ? sc.items : [];\r\n      setScenarios(rows);\r\n      if (selectedScenarioId != null) {\r\n        const exists = rows.some((x) => String(x.id) === String(selectedScenarioId));\r\n        if (!exists) {\r\n          writeSelectedScenarioId(schoolId, null);\r\n          setSelectedScenarioId(null);\r\n        }\r\n      }\r\n      setBootLoading(false);\r\n\r\n    } catch (e) {\r\n      setErr(e.message || \"Failed to load school\");\r\n      setBootLoading(false);\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    let active = true;\r\n    async function loadProgressConfig() {\r\n      try {\r\n        const data = await api.getProgressRequirements();\r\n        if (!active) return;\r\n        setProgressConfig(data?.config || data || null);\r\n      } catch (_) {\r\n        if (!active) return;\r\n        setProgressConfig(null);\r\n      }\r\n    }\r\n    loadProgressConfig();\r\n    return () => {\r\n      active = false;\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    loadAll(); /* eslint-disable-next-line */\r\n  }, [schoolId]);\r\n\r\n  useEffect(() => {\r\n    async function loadScenario() {\r\n      if (!selectedScenarioId) {\r\n        setSelectedScenario(null);\r\n        setInputs(null);\r\n        setBaselineInputs(null);\r\n        setReport(null);\r\n        setPrevReport(null);\r\n        setPrevScenarioMeta(null);\r\n        setNorm(null);\r\n        setBaselineNorm(null);\r\n        clearDirtyPrefix(\"inputs.\");\r\n        clearDirtyPrefix(\"norm.\");\r\n        return;\r\n      }\r\n      setErr(\"\");\r\n      setReport(null);\r\n      setLastSavedAt(null);\r\n      setLastCalculatedAt(null);\r\n      try {\r\n        const data = await api.getScenarioContext(schoolId, selectedScenarioId);\r\n\r\n        // IMPORTANT FIX:\r\n        setSelectedScenario(data?.scenario || null);\r\n\r\n        // IMPORTANT FIX:\r\n        // If backend returns null/undefined inputs, don't convert it to {}.\r\n        const raw = data?.inputs;\r\n        const normalized =\r\n          raw && typeof raw === \"object\"\r\n            ? normalizeGradesInputs(normalizeTemelBilgilerInputs(normalizeCapacityInputs(raw)))\r\n            : raw;\r\n        setInputs(normalized);\r\n        setBaselineInputs(normalized && typeof normalized === \"object\" ? structuredClone(normalized) : normalized);\r\n        clearDirtyPrefix(\"inputs.\");\r\n\r\n        const n = data?.norm ?? null;\r\n        setNorm(n);\r\n        setBaselineNorm(n ? structuredClone(n) : null);\r\n        clearDirtyPrefix(\"norm.\");\r\n      } catch (e) {\r\n        setErr(e.message || \"Failed to load scenario inputs\");\r\n      }\r\n    }\r\n    loadScenario();\r\n  }, [\r\n    schoolId,\r\n    selectedScenarioId,\r\n    clearDirtyPrefix,\r\n    normalizeCapacityInputs,\r\n    normalizeGradesInputs,\r\n  ]);\r\n\r\n  useEffect(() => {\r\n    if (!selectedScenarioId) {\r\n      reportCurrencyDefaultedForRef.current = null;\r\n      return;\r\n    }\r\n    const scenarioId = selectedScenario?.id;\r\n    if (!scenarioId || String(scenarioId) !== String(selectedScenarioId)) return;\r\n\r\n    const isLocal =\r\n      selectedScenario?.input_currency === \"LOCAL\" &&\r\n      Number(selectedScenario?.fx_usd_to_local) > 0 &&\r\n      selectedScenario?.local_currency_code;\r\n    const scenarioKey = String(scenarioId);\r\n\r\n    if (reportCurrencyDefaultedForRef.current !== scenarioKey) {\r\n      setReportCurrency(isLocal ? \"local\" : \"usd\");\r\n      reportCurrencyDefaultedForRef.current = scenarioKey;\r\n      return;\r\n    }\r\n\r\n    if (!isLocal && reportCurrency !== \"usd\") {\r\n      setReportCurrency(\"usd\");\r\n    }\r\n  }, [\r\n    selectedScenarioId,\r\n    selectedScenario?.id,\r\n    selectedScenario?.input_currency,\r\n    selectedScenario?.fx_usd_to_local,\r\n    selectedScenario?.local_currency_code,\r\n    reportCurrency,\r\n    setReportCurrency,\r\n  ]);\r\n\r\n  // Load previous year's report (used in TEMEL BILGILER: performans planlanan)\r\n  useEffect(() => {\r\n    async function loadPrev() {\r\n      try {\r\n        setPrevReport(null);\r\n        setPrevScenarioMeta(null);\r\n        const year = selectedScenario?.academic_year;\r\n        if (!year || !scenarios?.length) return;\r\n\r\n        const { startYear, endYear } = parseAcademicYear(year);\r\n        if (!startYear) return;\r\n        const prevStartYear = startYear - 1;\r\n        const prevEndYear = (endYear ?? startYear) - 1;\r\n\r\n        const prevScenario = scenarios.find((s) => {\r\n          const parsed = parseAcademicYear(s?.academic_year);\r\n          return parsed.startYear === prevStartYear && parsed.endYear === prevEndYear;\r\n        });\r\n        if (!prevScenario) return;\r\n\r\n        setPrevScenarioMeta(prevScenario);\r\n        const data = await api.calculateScenario(schoolId, prevScenario.id);\r\n        setPrevReport(data?.results || null);\r\n      } catch (_) {\r\n        setPrevReport(null);\r\n      }\r\n    }\r\n    loadPrev();\r\n  }, [schoolId, selectedScenario?.academic_year, scenarios]);\r\n\r\n  const scenarioLocked = isScenarioLocked(selectedScenario);\r\n  const inputsLocked = scenarioLocked || moduleLocked;\r\n\r\n  const saveNormConfig = useCallback(async () => {\r\n    if (!norm || !selectedScenarioId) return;\r\n    const payload = norm?.years\r\n      ? { years: norm.years }\r\n      : {\r\n        teacherWeeklyMaxHours: norm.teacherWeeklyMaxHours,\r\n        curriculumWeeklyHours: norm.curriculumWeeklyHours,\r\n      };\r\n    await api.saveNormConfig(schoolId, selectedScenarioId, payload);\r\n    const n = await api.getNormConfig(schoolId, selectedScenarioId);\r\n    setNorm(n);\r\n    setBaselineNorm(n ? structuredClone(n) : null);\r\n    clearDirtyPrefix(\"norm.\");\r\n  }, [norm, selectedScenarioId, schoolId, clearDirtyPrefix]);\r\n\r\n  // B) Save inputs with HR->Expenses salary patch applied + Capacity normalization\r\n  const saveInputs = useCallback(async () => {\r\n    if (!selectedScenarioId || !inputs) return false;\r\n    if (inputsLocked) {\r\n      setErr(scenarioLocked ? \"Senaryo kilitli. Inceleme bekleniyor.\" : \"Modul kilitli. Inceleme bekleniyor.\");\r\n      return false;\r\n    }\r\n    const shouldSaveInputs = hasDirtyPrefix(\"inputs.\");\r\n    const shouldSaveNorm = hasDirtyPrefix(\"norm.\");\r\n    if (!shouldSaveInputs && !shouldSaveNorm) return true;\r\n    setInputsSaving(true);\r\n    setErr(\"\");\r\n    try {\r\n      if (shouldSaveInputs) {\r\n        let patched = applyIkSalariesToGiderler(inputs);\r\n        patched = normalizeCapacityInputs(patched);\r\n        patched = normalizeGradesInputs(patched);\r\n        patched = applyTuitionStudentCounts(patched);\r\n\r\n        if (patched !== inputs) setInputs(patched);\r\n\r\n        // Build the list of modified permission resources from the dirty input paths.  Only\r\n        // consider dirty paths that affect scenario inputs (prefixed with \"inputs.\").  Dirty\r\n        // paths under the \"norm.\" prefix are handled separately when saving the norm config.\r\n        const modifiedResourcesSet = new Set();\r\n        const inputDirty = [];\r\n        for (const p of dirtyPaths) {\r\n          const pathStr = String(p || '');\r\n          if (!pathStr.startsWith('inputs.')) continue;\r\n          inputDirty.push(pathStr);\r\n          for (const r of pathToResources(pathStr)) {\r\n            modifiedResourcesSet.add(r);\r\n          }\r\n        }\r\n        const modifiedResources = Array.from(modifiedResourcesSet);\r\n        await api.saveScenarioInputs(\r\n          schoolId,\r\n          selectedScenarioId,\r\n          patched,\r\n          modifiedResources,\r\n          inputDirty\r\n        );\r\n        setBaselineInputs(patched && typeof patched === \"object\" ? structuredClone(patched) : patched);\r\n        clearDirtyPrefix(\"inputs.\");\r\n      }\r\n\r\n      if (shouldSaveNorm) {\r\n        await saveNormConfig();\r\n      }\r\n      setLastSavedAt(Date.now());\r\n      return true;\r\n    } catch (e) {\r\n      const fallback =\r\n        shouldSaveInputs && shouldSaveNorm\r\n          ? \"Save failed\"\r\n          : shouldSaveNorm\r\n            ? \"Save norm failed\"\r\n            : \"Save inputs failed\";\r\n      setErr(e.message || fallback);\r\n      return false;\r\n    } finally {\r\n      setInputsSaving(false);\r\n    }\r\n  }, [\r\n    applyIkSalariesToGiderler,\r\n    applyTuitionStudentCounts,\r\n    normalizeCapacityInputs,\r\n    normalizeGradesInputs,\r\n    selectedScenarioId,\r\n    inputs,\r\n    inputsLocked,\r\n    scenarioLocked,\r\n    hasDirtyPrefix,\r\n    dirtyPaths,\r\n    schoolId,\r\n    clearDirtyPrefix,\r\n    saveNormConfig,\r\n  ]);\r\n\r\n\r\n  // --- Guard: prevent calculating / submitting if Y2 & Y3 planned student totals are missing ---\r\n  function sumPlannedStudents(grades) {\r\n    const list = Array.isArray(grades) ? grades : [];\r\n    let sum = 0;\r\n    for (const row of list) {\r\n      const n = Number(row?.studentsPerBranch ?? 0);\r\n      if (Number.isFinite(n)) sum += n;\r\n    }\r\n    return sum;\r\n  }\r\n\r\n  function getPlannedStudentTotalsByYear(srcInputs) {\r\n    const s = srcInputs && typeof srcInputs === \"object\" ? srcInputs : {};\r\n    const years = s.gradesYears && typeof s.gradesYears === \"object\" ? s.gradesYears : {};\r\n    return {\r\n      y1: sumPlannedStudents(Array.isArray(years.y1) ? years.y1 : s.grades),\r\n      y2: sumPlannedStudents(years.y2),\r\n      y3: sumPlannedStudents(years.y3),\r\n    };\r\n  }\r\n\r\n\r\n  function showBlockingToast(message, toastId = \"blocking-toast\") {\r\n    // Small bottom-right notification (does not affect page layout)\r\n    toast.warn(message, {\r\n      toastId,\r\n      position: \"bottom-right\",\r\n      autoClose: false,\r\n      closeOnClick: false,\r\n      draggable: true,\r\n      icon: \"??\",\r\n      style: {\r\n        background: \"rgba(15, 23, 42, 0.96)\",\r\n        color: \"#f8fafc\",\r\n        border: \"1px solid rgba(251, 191, 36, 0.35)\",\r\n        boxShadow: \"0 18px 40px rgba(0,0,0,.28)\",\r\n        borderRadius: 14,\r\n      },\r\n    });\r\n  }\r\n\r\n  function ensurePlanningStudentsForY2Y3(actionLabel = \"Islem\") {\r\n    // If inputs are not loaded yet, don't block here (other guards will handle it)\r\n    if (!inputs) return true;\r\n    if (isHQ) return true;\r\n\r\n    const totals = getPlannedStudentTotalsByYear(inputs);\r\n    const missing = [];\r\n    if (!(totals.y2 > 0)) missing.push(\"Y2\");\r\n    if (!(totals.y3 > 0)) missing.push(\"Y3\");\r\n    if (!missing.length) return true;\r\n\r\n    const msg =\r\n      `${actionLabel} yapilamaz: Norm > Planlanan Donem Bilgileri bolumunde ` +\r\n      `${missing.join(\" ve \")} toplam ogrenci 0 gorunuyor. Lutfen Y2/Y3 ogrenci sayilarini girin.`;\r\n\r\n    // Do NOT set page-level err here (it breaks layout). Use toast only.\r\n    setErr(\"\");\r\n    showBlockingToast(msg, \"norm-y2y3-missing\");\r\n\r\n    if (tab !== \"norm\") setTab(\"norm\");\r\n    return false;\r\n  }\r\n\r\n  function ensurePrevRealFxForLocal(actionLabel = \"Islem\") {\r\n    if (!inputs) return true;\r\n    if (!isLocalScenario) return true;\r\n    if (!prevRealFxMissing) return true;\r\n\r\n    const msg =\r\n      `${actionLabel} yapilamaz: Temel Bilgiler > Performans alanindaki ` +\r\n      `\"Onceki Donem Ortalama Kur (Gerceklesen)\" girilmelidir.`;\r\n\r\n    setErr(\"\");\r\n    showBlockingToast(msg, \"prev-realized-fx-missing\");\r\n    if (tab !== \"basics\") setTab(\"basics\");\r\n    return false;\r\n  }\r\n\r\n\r\n  async function calculate(options = {}) {\r\n    if (!selectedScenarioId) return false;\r\n    if (!ensurePrevRealFxForLocal(\"Hesaplama\")) return false;\r\n    if (!options.skipPlanValidation && !ensurePlanningStudentsForY2Y3(\"Hesaplama\")) return false;\r\n    setCalculating(true);\r\n    setErr(\"\");\r\n    let ok = false;\r\n    try {\r\n      const data = await api.calculateScenario(schoolId, selectedScenarioId);\r\n      if (reportMode === \"distributed\") {\r\n        await fetchScenarioReport(\"distributed\");\r\n      } else {\r\n        setReport(data.results);\r\n      }\r\n      if (!options.keepTab) setTab(\"report\");\r\n      setLastCalculatedAt(Date.now());\r\n      if (typeof window !== \"undefined\") {\r\n        // Debug hook: inspect KPI calc payload/results in devtools\r\n        console.log(\"[kpi] calculate ok\", {\r\n          scenarioId: selectedScenarioId,\r\n          hasResults: Boolean(data?.results),\r\n        });\r\n      }\r\n      ok = true;\r\n    } catch (e) {\r\n      setErr(e.message || \"Calculation failed\");\r\n      if (typeof window !== \"undefined\") {\r\n        console.log(\"[kpi] calculate failed\", {\r\n          scenarioId: selectedScenarioId,\r\n          error: e?.message || e,\r\n        });\r\n      }\r\n    } finally {\r\n      setCalculating(false);\r\n    }\r\n    return ok;\r\n  }\r\n\r\n  async function handleExport() {\r\n    if (!selectedScenarioId) return;\r\n    setErr(\"\");\r\n    try {\r\n      await api.downloadXlsx(schoolId, selectedScenarioId, reportCurrency, reportMode);\r\n    } catch (e) {\r\n      setErr(e.message || \"Download failed\");\r\n    }\r\n  }\r\n\r\n  async function handleExportPdf() {\r\n    if (!selectedScenarioId) return;\r\n    setErr(\"\");\r\n    setExportingPdf(true);\r\n    try {\r\n      await api.downloadPdf(schoolId, selectedScenarioId, reportCurrency, reportMode);\r\n    } catch (e) {\r\n      setErr(e.message || \"PDF export failed\");\r\n    } finally {\r\n      setExportingPdf(false);\r\n    }\r\n  }\r\n\r\n  function setField(path, value) {\r\n    if (inputsLocked) return;\r\n    const next = structuredClone(inputs || {});\r\n    const keys = path.split(\".\");\r\n    let obj = next;\r\n    for (let i = 0; i < keys.length - 1; i++) {\r\n      obj[keys[i]] = obj[keys[i]] || {};\r\n      obj = obj[keys[i]];\r\n    }\r\n    obj[keys[keys.length - 1]] = value;\r\n    setInputs(next);\r\n  }\r\n\r\n  function areSetsEqual(a, b) {\r\n    if (a === b) return true;\r\n    if (a.size !== b.size) return false;\r\n    for (const v of a) {\r\n      if (!b.has(v)) return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  function valuesEqual(a, b) {\r\n    if (a == null && b == null) return true;\r\n    if (typeof a === \"number\" || typeof b === \"number\") return Number(a) === Number(b);\r\n    if (typeof a === \"boolean\" || typeof b === \"boolean\") return Boolean(a) === Boolean(b);\r\n    return Object.is(a, b);\r\n  }\r\n\r\n  function getValueAtPath(obj, parts) {\r\n    let cur = obj;\r\n    for (const part of parts) {\r\n      if (cur == null) return undefined;\r\n\r\n      if (Array.isArray(cur)) {\r\n        const byKey = cur.find((item) => item && typeof item === \"object\" && \"key\" in item && String(item.key) === part);\r\n        if (byKey) {\r\n          cur = byKey;\r\n          continue;\r\n        }\r\n\r\n        const byName = cur.find((item) => item && typeof item === \"object\" && \"name\" in item && String(item.name) === part);\r\n        if (byName) {\r\n          cur = byName;\r\n          continue;\r\n        }\r\n\r\n        const byGrade = cur.find((item) => item && typeof item === \"object\" && \"grade\" in item && String(item.grade) === part);\r\n        if (byGrade) {\r\n          cur = byGrade;\r\n          continue;\r\n        }\r\n\r\n        const idx = Number(part);\r\n        if (Number.isInteger(idx) && String(idx) === part) {\r\n          cur = cur[idx];\r\n          continue;\r\n        }\r\n\r\n        return undefined;\r\n      }\r\n\r\n      if (typeof cur !== \"object\") return undefined;\r\n      cur = cur[part];\r\n    }\r\n    return cur;\r\n  }\r\n\r\n  // ...existing code...\r\n  const getBaselineValue = useCallback(\r\n    (path) => {\r\n      if (!path) return undefined;\r\n      const parts = path.split(\".\");\r\n      if (!parts.length) return undefined;\r\n      if (parts[0] === \"inputs\") {\r\n        const val = getValueAtPath(baselineInputs, parts.slice(1));\r\n        if (val !== undefined) return val;\r\n\r\n        const last = parts[parts.length - 1];\r\n\r\n        // If field ends with Y2/Y3 try base field fallback (e.g. unitCostY2 -> unitCost)\r\n        if (last.endsWith(\"Y2\") || last.endsWith(\"Y3\")) {\r\n          const suffix = last.endsWith(\"Y2\") ? \"Y2\" : \"Y3\";\r\n          const baseField = last.slice(0, -2);\r\n          const baseVal = getValueAtPath(baselineInputs, parts.slice(1, -1).concat(baseField));\r\n          if (baseVal !== undefined) {\r\n            // For unitCost-like fields, return the inflation-adjusted derived value so UI matches display logic\r\n            if (baseField === \"unitCost\" || baseField.startsWith(\"unitCost\")) {\r\n              const infl = getValueAtPath(baselineInputs, [\"temelBilgiler\", \"inflation\"]) || {};\r\n              const y2f = 1 + Number(infl?.y2 || 0);\r\n              const y3f = y2f * (1 + Number(infl?.y3 || 0));\r\n              return suffix === \"Y2\" ? Number(baseVal) * y2f : Number(baseVal) * y3f;\r\n            }\r\n            // Other Y2/Y3 fields (studentCountY2, ratioY2, valueY2, etc.) fall back to base field\r\n            return baseVal;\r\n          }\r\n        }\r\n\r\n        // studentCountY2/Y3 fallback -> studentCount\r\n        if ((last === \"studentCountY2\" || last === \"studentCountY3\") && baselineInputs) {\r\n          const parent = getValueAtPath(baselineInputs, parts.slice(1, -1));\r\n          if (parent && typeof parent === \"object\") {\r\n            const sc = parent.studentCount;\r\n            if (sc != null) return sc;\r\n          }\r\n        }\r\n\r\n        // kapasite / year fallbacks handled elsewhere above; generic years fallback:\r\n        const yearsIdx = parts.indexOf(\"years\");\r\n        if (yearsIdx >= 0 && parts.length > yearsIdx + 1 && baselineInputs) {\r\n          const yearKey = parts[yearsIdx + 1]; // e.g. 'y1','y2','y3'\r\n          if (yearKey === \"y2\" || yearKey === \"y3\") {\r\n            const altParts = [...parts];\r\n            altParts[yearsIdx + 1] = \"y1\";\r\n            const altVal = getValueAtPath(baselineInputs, altParts.slice(1));\r\n            if (altVal !== undefined) {\r\n              if (parts.includes(\"ik\") && parts.includes(\"unitCosts\")) {\r\n                const ratio = getValueAtPath(baselineInputs, [\"ik\", \"unitCostRatio\"]);\r\n                const r = Number(ratio);\r\n                if (Number.isFinite(r)) {\r\n                  const base = Number(altVal);\r\n                  const multiplier = yearKey === \"y2\" ? r : r * r;\r\n                  return Number.isFinite(base) ? base * multiplier : undefined;\r\n                }\r\n              }\r\n              return altVal;\r\n            }\r\n          }\r\n        }\r\n\r\n        // ik specific fallbacks:\r\n        if (parts.slice(1, 3).join(\".\") === \"ik.years\" && baselineInputs) {\r\n          if (parts.includes(\"unitCostRatio\")) {\r\n            const u = getValueAtPath(baselineInputs, [\"ik\", \"unitCostRatio\"]);\r\n            if (u !== undefined) return u;\r\n            return 1;\r\n          }\r\n          const leafCandidates = [\"unitCosts\", \"headcountsByLevel\"];\r\n          if (leafCandidates.some((c) => parts.includes(c))) {\r\n            return 0;\r\n          }\r\n        }\r\n\r\n        // generic kapasite fallbacks (years.cur/y1/y2/y3 etc.)\r\n        if ((last === \"y1\" || last === \"y2\" || last === \"y3\") && baselineInputs) {\r\n          const parent = getValueAtPath(baselineInputs, parts.slice(1, -1));\r\n          if (parent && typeof parent === \"object\" && parent.y1 != null) return parent.y1;\r\n\r\n          const byIdx = parts.indexOf(\"byKademe\");\r\n          if (byIdx >= 1 && parts.length > byIdx + 1) {\r\n            const lvlKey = parts[byIdx + 1];\r\n            const per = getValueAtPath(baselineInputs, [\"kapasite\", \"byKademe\", lvlKey, \"caps\", \"y1\"]);\r\n            if (per !== undefined) return per;\r\n          }\r\n\r\n          const yearsY1 = getValueAtPath(baselineInputs, [\"kapasite\", \"years\", \"y1\"]);\r\n          if (yearsY1 !== undefined) return yearsY1;\r\n        }\r\n\r\n        // cur fallback for kapasite -> per-kademe caps.cur or kapasite.currentStudents\r\n        if (last === \"cur\" && baselineInputs) {\r\n          const byIdx = parts.indexOf(\"byKademe\");\r\n          if (byIdx >= 1 && parts.length > byIdx + 1) {\r\n            const lvlKey = parts[byIdx + 1];\r\n            const per = getValueAtPath(baselineInputs, [\"kapasite\", \"byKademe\", lvlKey, \"caps\", \"cur\"]);\r\n            if (per !== undefined) return per;\r\n          }\r\n          const curAll = getValueAtPath(baselineInputs, [\"kapasite\", \"currentStudents\"]);\r\n          if (curAll !== undefined) return curAll;\r\n        }\r\n\r\n        return undefined;\r\n      }\r\n      if (parts[0] === \"norm\") return getValueAtPath(baselineNorm, parts.slice(1));\r\n      return undefined;\r\n    },\r\n    [baselineInputs, baselineNorm]\r\n  );\r\n  // ...existing code...\r\n\r\n  const inputsDirty = hasDirtyPrefix(\"inputs.\") || hasDirtyPrefix(\"norm.\");\r\n  const submitActiveWorkItem = useCallback(async () => {\r\n    if (!activeWorkId) return;\r\n    if (inputsDirty) {\r\n      const ok = await saveInputs();\r\n      if (!ok) return;\r\n    }\r\n    await submitWorkItem(activeWorkId);\r\n  }, [activeWorkId, inputsDirty, saveInputs, submitWorkItem]);\r\n  const reviewActiveWorkItem = useCallback(\r\n    async (action = \"approve\") => {\r\n      if (!activeWorkId || !selectedScenario?.id) return;\r\n      if (reviewingWorkItem) return;\r\n      setReviewingWorkItem(true);\r\n      try {\r\n        await api.reviewWorkItem(schoolId, selectedScenario.id, activeWorkId, { action });\r\n        toast.success(action === \"approve\" ? \"Onayland\" : \"Revize istendi\");\r\n        await refreshWorkItems();\r\n        await refreshScenarioMeta();\r\n      } catch (e) {\r\n        toast.error(e?.message || \"lem baarsz\");\r\n      } finally {\r\n        setReviewingWorkItem(false);\r\n      }\r\n    },\r\n    [activeWorkId, selectedScenario?.id, reviewingWorkItem, schoolId, refreshWorkItems, refreshScenarioMeta]\r\n  );\r\n  const role = String(me?.role || \"\");\r\n  const isAccountant = role === \"accountant\";\r\n  const suppressUnsavedWarning =\r\n    activeWorkId && activeWorkState === \"submitted\" && role && !isAccountant;\r\n  const warnUnsavedChanges = inputsDirty && !suppressUnsavedWarning;\r\n  const moduleLockReason =\r\n    activeWorkState === \"submitted\"\r\n      ? \"Modul incelemede\"\r\n      : activeWorkState === \"approved\"\r\n        ? \"Modul onaylandi\"\r\n        : \"Modul kilitli\";\r\n  const inputsLockedReason = scenarioLocked\r\n    ? \"Senaryo kilitli\"\r\n    : moduleLocked\r\n      ? moduleLockReason\r\n      : \"\";\r\n  const isActiveRequired = activeWorkId\r\n    ? (requiredWorkIds.length\r\n      ? requiredWorkIds.includes(activeWorkId)\r\n      : (isHQ ? HQ_REQUIRED_WORK_IDS.has(activeWorkId) : true))\r\n    : false;\r\n  const canSubmitWorkItem =\r\n    activeWorkId &&\r\n    isActiveRequired &&\r\n    !scenarioLocked &&\r\n    [\"not_started\", \"in_progress\", \"needs_revision\"].includes(activeWorkState);\r\n  const markDirty = useCallback(\r\n    (path, value) => {\r\n      if (!path) return;\r\n      if (inputsLocked && (path.startsWith(\"inputs.\") || path.startsWith(\"norm.\"))) return;\r\n      if (path.startsWith(\"inputs.\")) {\r\n        setInputs((prev) => {\r\n          if (!prev) return prev;\r\n          const parts = path.split(\".\");\r\n          const current = getValueAtPath(prev, parts.slice(1));\r\n          if (valuesEqual(current, value)) return prev;\r\n          const next = structuredClone(prev);\r\n          const ok = setValueAtPath(next, parts.slice(1), value);\r\n          return ok ? next : prev;\r\n        });\r\n      }\r\n      const baselineValue = getBaselineValue(path);\r\n      const same = valuesEqual(value, baselineValue);\r\n      setDirtyPaths((prev) => {\r\n        const next = new Set(prev);\r\n        if (same) next.delete(path);\r\n        else next.add(path);\r\n        return areSetsEqual(prev, next) ? prev : next;\r\n      });\r\n    },\r\n    [inputsLocked, getBaselineValue, setInputs]\r\n  );\r\n\r\n  // --------------------------------------------------------------\r\n  // Warn the user when navigating away with unsaved changes.\r\n  //\r\n  // React Router does not automatically prompt the user when leaving\r\n  // a page with unsaved changes. To ensure users do not lose their\r\n  // work, hook into the native `beforeunload` event. When there are\r\n  // dirty inputs (i.e. the user has modified fields that have not\r\n  // yet been saved), we register a `beforeunload` handler that\r\n  // prevents the default navigation and sets the `returnValue` on\r\n  // the event. Browsers display a generic confirmation dialog to\r\n  // confirm whether the user really wants to leave the page.\r\n  //\r\n  // Without this handler the browser will navigate away silently\r\n  // resulting in lost changes. By registering the handler only\r\n  // when there are unsaved changes and cleaning it up when there\r\n  // are none, we avoid unnecessary prompts.\r\n  useEffect(() => {\r\n    // Handler for the `beforeunload` event. This fires when the\r\n    // user attempts to close or navigate away from the page (e.g.\r\n    // by closing the tab, refreshing or navigating to another URL).\r\n    const handleBeforeUnload = (event) => {\r\n      // If there are unsaved changes, prevent the unload and set\r\n      // `returnValue` to an empty string. The exact message is\r\n      // ignored by most modern browsers, but setting this triggers\r\n      // the confirmation dialog.\r\n      if (warnUnsavedChanges) {\r\n        event.preventDefault();\r\n        // Chrome requires returnValue to be set.\r\n        event.returnValue = \"\";\r\n      }\r\n    };\r\n\r\n    // Register the event listener when there are unsaved changes.\r\n    if (warnUnsavedChanges) {\r\n      window.addEventListener(\"beforeunload\", handleBeforeUnload);\r\n    }\r\n\r\n    // Cleanup: always remove the listener to avoid multiple handlers\r\n    // and to ensure we do not prompt when there are no dirty inputs.\r\n    return () => {\r\n      window.removeEventListener(\"beforeunload\", handleBeforeUnload);\r\n    };\r\n  }, [warnUnsavedChanges]);\r\n\r\n  // --------------------------------------------------------------\r\n  // Expose a global flag for unsaved changes.\r\n  //\r\n  // When navigating between different sections of the application (e.g. via\r\n  // sidebar links) we need to know if there are unsaved changes in the\r\n  // current School page. We write a boolean flag on the `window` object\r\n  // whenever the `inputsDirty` state changes so that other components such\r\n  // as the sidebar navigation can read this value and display a prompt if\r\n  // necessary. When the component unmounts, we clear the flag.\r\n  useEffect(() => {\r\n    try {\r\n      window.__fsUnsavedChanges = warnUnsavedChanges;\r\n    } catch (_) {\r\n      // In non-browser environments `window` may not exist.\r\n    }\r\n    return () => {\r\n      try {\r\n        // Clear the flag on unmount or when navigating away from this page.\r\n        window.__fsUnsavedChanges = false;\r\n      } catch (_) { }\r\n    };\r\n  }, [warnUnsavedChanges]);\r\n  const handleIkSalaryComputed = React.useCallback(\r\n    (salaryByYear) => {\r\n      if (inputsLocked) return;\r\n      const patch = salaryByYear?.y1 || {};\r\n      const keys = [\r\n        \"turkPersonelMaas\",\r\n        \"turkDestekPersonelMaas\",\r\n        \"yerelPersonelMaas\",\r\n        \"yerelDestekPersonelMaas\",\r\n        \"internationalPersonelMaas\",\r\n      ];\r\n\r\n      setInputs((prev) => {\r\n        const p = prev || {};\r\n        const prevItems = p?.giderler?.isletme?.items || {};\r\n\r\n        let changed = false;\r\n        for (const k of keys) {\r\n          const a = Number(prevItems?.[k] || 0);\r\n          const b = Number(patch?.[k] || 0);\r\n          if (Math.abs(a - b) > 1e-6) {\r\n            changed = true;\r\n            break;\r\n          }\r\n        }\r\n        if (!changed) return prev;\r\n\r\n        const next = structuredClone(p);\r\n        next.giderler = next.giderler || {};\r\n        next.giderler.isletme = next.giderler.isletme || {};\r\n        next.giderler.isletme.items = next.giderler.isletme.items || {};\r\n        for (const k of keys) next.giderler.isletme.items[k] = Number(patch?.[k] || 0);\r\n        if (canWriteGiderler) {\r\n          // Derived salary totals should not require Giderler write permission\r\n          // for HR users; only mark dirty when the user can write expenses.\r\n          for (const k of keys) {\r\n            markDirty(`inputs.giderler.isletme.items.${k}`, Number(patch?.[k] || 0));\r\n          }\r\n        }\r\n        return next;\r\n      });\r\n    },\r\n    [inputsLocked, markDirty, canWriteGiderler]\r\n  );\r\n  const handlePlanningGradesChange = React.useCallback(\r\n    (v) => {\r\n      if (inputsLocked) return;\r\n      if (!v || typeof v !== \"object\") return;\r\n      setInputs((prev) => {\r\n        const p = prev || {};\r\n        let next = structuredClone(p);\r\n        next.gradesYears = v;\r\n        if (Array.isArray(v.y1)) next.grades = structuredClone(v.y1);\r\n        next = applyTuitionStudentCounts(next);\r\n        return next;\r\n      });\r\n    },\r\n    [applyTuitionStudentCounts, inputsLocked]\r\n  );\r\n  const setNormSafe = useCallback(\r\n    (updater) => {\r\n      if (inputsLocked) return;\r\n      setNorm((prev) => (typeof updater === \"function\" ? updater(prev) : updater));\r\n    },\r\n    [inputsLocked, setNorm]\r\n  );\r\n  const showInputsHeader = INPUT_HEADER_TABS.has(tab);\r\n  const exportDisabled = inputsSaving || calculating || exportingPdf || !report;\r\n  const formatRelative = (ms) => {\r\n    if (!ms) return \"\";\r\n    const diff = Math.max(0, (nowTick || Date.now()) - ms);\r\n    if (diff < 60000) return \"az once\";\r\n    if (diff < 3600000) return `${Math.floor(diff / 60000)} dk once`;\r\n    return `${Math.floor(diff / 3600000)} saat once`;\r\n  };\r\n\r\n  // Determine the display label and style for a scenario based on its\r\n  // workflow status and timestamps.  When a scenario is approved but\r\n  // has not yet been forwarded to the central office (sent_at is null),\r\n  // it is considered Kontrol edildi.  Once sent_at is set, the\r\n  // scenario is locked and considered Onayland.  The draft state\r\n  // optionally distinguishes Hazrlanyor when progress exists, but\r\n  // falls back to Taslak otherwise.\r\n  useEffect(() => {\r\n    if (exportDisabled) setExportOpen(false);\r\n  }, [exportDisabled]);\r\n\r\n\r\n\r\n  function getScenarioStageLabel(s, progressPct) {\r\n    if (!s) return null;\r\n    const status = String(s.status || \"draft\");\r\n    // Show \"Taslak\" when no progress; \"Hazrlanyor\" when progress exists\r\n    if (status === \"draft\") {\r\n      const pct = Number(progressPct);\r\n      if (Number.isFinite(pct) && pct > 0) return \"Hazrlanyor\";\r\n      return \"Taslak\";\r\n    }\r\n    if (status === \"in_review\") return \"ncelemede\";\r\n    if (status === \"revision_requested\") return \"Revize istendi\";\r\n    if (status === \"sent_for_approval\" || status === \"submitted\") return \"Merkeze iletildi\";\r\n    if (status === \"approved\") {\r\n      // Sent_at indicates final approval\r\n      if (s.sent_at) return \"Onayland\";\r\n      return \"Kontrol edildi\";\r\n    }\r\n    return \"Taslak\";\r\n  }\r\n  function getScenarioStageClass(label) {\r\n    switch (label) {\r\n      case \"Revize istendi\":\r\n        return \"is-bad\";\r\n      case \"Merkeze iletildi\":\r\n      case \"ncelemede\":\r\n      case \"Hazrlanyor\":\r\n        return \"is-warn\";\r\n      case \"Kontrol edildi\":\r\n      case \"Onayland\":\r\n        return \"is-ok\";\r\n      case \"Taslak\":\r\n      default:\r\n        return \"is-muted\";\r\n    }\r\n  }\r\n  function getWorkItemStageLabel(state) {\r\n    switch (String(state || \"not_started\")) {\r\n      case \"approved\":\r\n        return \"Kontrol edildi\";\r\n      case \"needs_revision\":\r\n        return \"Revize istendi\";\r\n      case \"submitted\":\r\n        return \"ncelemede\";\r\n      case \"in_progress\":\r\n        return \"Hazrlanyor\";\r\n      default:\r\n        return \"Taslak\";\r\n    }\r\n  }\r\n  function getModuleStatusClass(state, scenarioStatus, scenarioSentAt) {\r\n    if (scenarioStatus === \"approved\" && scenarioSentAt) {\r\n      return \"is-final\";\r\n    }\r\n    if ([\"sent_for_approval\", \"submitted\"].includes(String(scenarioStatus || \"\"))) {\r\n      return \"is-forwarded\";\r\n    }\r\n    switch (String(state || \"not_started\")) {\r\n      case \"needs_revision\":\r\n        return \"is-revision\";\r\n      case \"approved\":\r\n        return \"is-approved\";\r\n      case \"submitted\":\r\n        return \"is-review\";\r\n      case \"in_progress\":\r\n      case \"not_started\":\r\n      default:\r\n        return \"is-draft\";\r\n    }\r\n  }\r\n\r\n  function renderStickyFooter() {\r\n    if (!showInputsHeader) return null;\r\n    // Build module progress segments.  Each segment uses the pct from progMap\r\n    // and averages for the combined \"norm\" and \"gider\" modules.\r\n    const moduleKeyToWorkId = {\r\n      temel: \"temel_bilgiler\",\r\n      kapasite: \"kapasite\",\r\n      norm: \"norm.ders_dagilimi\",\r\n      ik: \"ik.local_staff\",\r\n      gelir: \"gelirler.unit_fee\",\r\n      gider: \"giderler.isletme\",\r\n    };\r\n    const getModuleWorkState = (moduleKey) => {\r\n      if (!moduleKey) return \"not_started\";\r\n      if (!workItemsLoaded) return \"not_started\";\r\n      const workId = moduleKeyToWorkId[moduleKey];\r\n      if (!workId) return \"not_started\";\r\n      const item = Array.isArray(workItems)\r\n        ? workItems.find((w) => String(w?.work_id) === String(workId))\r\n        : null;\r\n      return item?.state ? String(item.state) : \"not_started\";\r\n    };\r\n    const footerModules = [];\r\n    const optionalSuffix = \" (Opsiyonel)\";\r\n    if (progMap && progMap.temelBilgiler) {\r\n      footerModules.push({\r\n        key: \"temel\",\r\n        label: isHQ ? `Temel${optionalSuffix}` : \"Temel\",\r\n        labelShort: \"Temel\",\r\n        pct: pctValue(progMap.temelBilgiler),\r\n        done: progMap.temelBilgiler.done === true,\r\n        isOptional: isHQ,\r\n      });\r\n    }\r\n    if (progMap && progMap.kapasite) {\r\n      footerModules.push({\r\n        key: \"kapasite\",\r\n        label: isHQ ? `Kapasite${optionalSuffix}` : \"Kapasite\",\r\n        labelShort: \"Kap\",\r\n        pct: pctValue(progMap.kapasite),\r\n        done: progMap.kapasite.done === true,\r\n        isOptional: isHQ,\r\n      });\r\n    }\r\n    // Combine gradesPlan and norm into a single \"Norm\" segment.  Use normAvgPct for pct.\r\n    const normDone = ignoreNormProgress\r\n      ? (progMap?.gradesPlan?.done === true || progMap?.gradesPlan?.done === undefined)\r\n      : (progMap?.gradesPlan?.done === true || progMap?.gradesPlan?.done === undefined) &&\r\n        (progMap?.norm?.done === true || progMap?.norm?.done === undefined);\r\n    footerModules.push({\r\n      key: \"norm\",\r\n      label: isHQ ? `Norm${optionalSuffix}` : \"Norm\",\r\n      labelShort: \"Norm\",\r\n      pct: Number.isFinite(normAvgPct) ? normAvgPct : 0,\r\n      done: normDone,\r\n      isOptional: isHQ,\r\n    });\r\n    if (progMap && progMap.ik) {\r\n      footerModules.push({\r\n        key: \"ik\",\r\n        label: \"IK\",\r\n        labelShort: \"IK\",\r\n        pct: pctValue(progMap.ik),\r\n        done: progMap.ik.done === true,\r\n      });\r\n    }\r\n    if (progMap && progMap.gelirler) {\r\n      footerModules.push({\r\n        key: \"gelir\",\r\n        label: \"Gelir\",\r\n        labelShort: \"Gel\",\r\n        pct: pctValue(progMap.gelirler),\r\n        done: progMap.gelirler.done === true,\r\n      });\r\n    }\r\n    // Combine giderler and discounts into a single \"Gider\" segment.  Use expensesAvgPct.\r\n    const giderDone = isHQ\r\n      ? (progMap?.giderler?.done === true || progMap?.giderler?.done === undefined)\r\n      : (progMap?.giderler?.done === true || progMap?.giderler?.done === undefined) &&\r\n        (progMap?.discounts?.done === true || progMap?.discounts?.done === undefined);\r\n    footerModules.push({\r\n      key: \"gider\",\r\n      label: \"Gider\",\r\n      labelShort: \"Gid\",\r\n      pct: Number.isFinite(expensesAvgPct) ? expensesAvgPct : 0,\r\n      done: giderDone,\r\n    });\r\n    const requiredModules = footerModules.filter((m) => !m.isOptional);\r\n    const allModulesDone = requiredModules.every((m) => m.done);\r\n    // Determine scenario progress pct for label heuristics\r\n    const scenarioProgressPct = selectedScenario?.progress_pct;\r\n    // Determine status pills: scenario-first when workflow advanced beyond draft,\r\n    // but prefer module-level \"approved/revision\" states.\r\n    const scenarioStageLabel = selectedScenario ? getScenarioStageLabel(selectedScenario, scenarioProgressPct) : null;\r\n    const scenarioDisplayLabel =\r\n      scenarioStageLabel &&\r\n      [\"ncelemede\", \"Revize istendi\", \"Merkeze iletildi\", \"Kontrol edildi\", \"Onayland\"].includes(\r\n        scenarioStageLabel\r\n      )\r\n        ? scenarioStageLabel\r\n        : null;\r\n    const scenarioDisplayClass = scenarioDisplayLabel ? getScenarioStageClass(scenarioDisplayLabel) : null;\r\n    const workItemLabel = workItemsLoaded && activeWorkId ? getWorkItemStageLabel(activeWorkState) : null;\r\n    const workItemClass = workItemLabel ? getScenarioStageClass(workItemLabel) : null;\r\n    const hasActiveWorkLabel = Boolean(activeWorkId && workItemLabel);\r\n\r\n    let scenarioTooltip = null;\r\n    if (scenarioDisplayLabel === \"Kontrol edildi\" && selectedScenario?.checked_at) {\r\n      const d = new Date(selectedScenario.checked_at);\r\n      scenarioTooltip = `Kontrol: ${Number.isFinite(d.getTime()) ? d.toLocaleString() : \"\"}`;\r\n    } else if (scenarioDisplayLabel === \"Merkeze iletildi\" && selectedScenario?.sent_at) {\r\n      const d = new Date(selectedScenario.sent_at);\r\n      scenarioTooltip = `letildi: ${Number.isFinite(d.getTime()) ? d.toLocaleString() : \"\"}`;\r\n    } else if (scenarioDisplayLabel === \"Onayland\" && selectedScenario?.reviewed_at) {\r\n      const d = new Date(selectedScenario.reviewed_at);\r\n      scenarioTooltip = `Onay: ${Number.isFinite(d.getTime()) ? d.toLocaleString() : \"\"}`;\r\n    }\r\n\r\n    let primaryPill = null;\r\n    let secondaryPill = null;\r\n\r\n    const scenarioIsFinal = scenarioDisplayLabel === \"Merkeze iletildi\" || scenarioDisplayLabel === \"Onayland\";\r\n    const allowScenarioPill =\r\n      scenarioIsFinal || !activeWorkId || (workItemsLoaded && scenarioMetaLoaded);\r\n    const scenarioPillLabel = allowScenarioPill ? scenarioDisplayLabel : null;\r\n    const scenarioPillClass = allowScenarioPill ? scenarioDisplayClass : null;\r\n    const scenarioPillTooltip = allowScenarioPill ? scenarioTooltip : null;\r\n\r\n    if (scenarioIsFinal && scenarioPillLabel) {\r\n      primaryPill = { label: scenarioPillLabel, className: scenarioPillClass, tooltip: scenarioPillTooltip };\r\n    } else if (hasActiveWorkLabel) {\r\n      primaryPill = { label: workItemLabel, className: workItemClass };\r\n      const suppressScenarioPill =\r\n        (scenarioPillLabel === \"Revize istendi\" && activeWorkState !== \"needs_revision\") ||\r\n        (scenarioPillLabel === \"Kontrol edildi\" && activeWorkState === \"needs_revision\") ||\r\n        (scenarioPillLabel === \"ncelemede\" && activeWorkState === \"approved\");\r\n      if (scenarioPillLabel && scenarioPillLabel !== workItemLabel && !suppressScenarioPill) {\r\n        secondaryPill = { label: scenarioPillLabel, className: scenarioPillClass, tooltip: scenarioPillTooltip };\r\n      }\r\n    } else if (scenarioPillLabel) {\r\n      primaryPill = { label: scenarioPillLabel, className: scenarioPillClass, tooltip: scenarioPillTooltip };\r\n      if (workItemLabel && workItemLabel !== scenarioPillLabel) {\r\n        secondaryPill = { label: workItemLabel, className: workItemClass };\r\n      }\r\n    } else if (workItemLabel) {\r\n      primaryPill = { label: workItemLabel, className: workItemClass };\r\n    }\r\n    // Determine footer meta text\r\n    const footerMetaBits = [];\r\n    if (lastSavedAt) footerMetaBits.push(`Kaydedildi ${formatRelative(lastSavedAt)}`);\r\n    if (lastCalculatedAt) footerMetaBits.push(`Hesapland ${formatRelative(lastCalculatedAt)}`);\r\n    let showDebug = false;\r\n    try {\r\n      showDebug = window?.localStorage?.getItem(\"fs_debug_kpi\") === \"1\";\r\n    } catch (_) {\r\n      showDebug = false;\r\n    }\r\n    if (showDebug) {\r\n      const debugBits = [\r\n        `calc:${calculating ? \"1\" : \"0\"}`,\r\n        `lastCalc:${lastCalculatedAt ? new Date(lastCalculatedAt).toLocaleTimeString() : \"none\"}`,\r\n        `report:${report ? \"yes\" : \"no\"}`,\r\n      ];\r\n      footerMetaBits.push(`DEBUG ${debugBits.join(\"  \")}`);\r\n    }\r\n    const footerMetaText = footerMetaBits.join(\"  \");\r\n    const hasFooterMeta = Boolean(footerMetaText);\r\n    // Determine primary action\r\n    // We compute role-aware capability flags above.  The final action\r\n    // selection must respect the following priority order:\r\n    // 1. Admin \"Onayla\" > 2. Accountant/Manager \"Merkeze ilet\" > 3. Principal/HR \"Gnder\".\r\n    const role = String(me?.role || \"\");\r\n    // Build scope options for permission checks.  Include the countryId if\r\n    // available (via the loaded school or current user) so that\r\n    // country-scoped permissions can match.  Without a countryId, a\r\n    // permission entry with a non-null scope_country_id will not match.\r\n    const countryIdForScope = school?.country_id ?? me?.country_id ?? null;\r\n    const scopeOpts = { schoolId, countryId: countryIdForScope };\r\n    const scenarioStatus = selectedScenario?.status;\r\n    const hasScenario = selectedScenario && selectedScenario.id;\r\n    // Helper to check permission using can()\r\n    const userCan = (res, action) => {\r\n      try {\r\n        return can(me, res, action, scopeOpts);\r\n      } catch {\r\n        return false;\r\n      }\r\n    };\r\n    const moduleKeyToTab = {\r\n      temel: \"basics\",\r\n      kapasite: \"kapasite\",\r\n      norm: \"norm\",\r\n      ik: \"hr\",\r\n      gelir: \"income\",\r\n      gider: \"expenses\",\r\n    };\r\n    const moduleKeyToPageKey = {\r\n      temel: \"temel_bilgiler\",\r\n      kapasite: \"kapasite\",\r\n      norm: \"norm\",\r\n      ik: \"ik\",\r\n      gelir: \"gelirler\",\r\n      gider: \"giderler\",\r\n    };\r\n    const canNavigateModule = (moduleKey) => {\r\n      const pageKey = moduleKeyToPageKey[moduleKey];\r\n      if (!pageKey) return false;\r\n      if (userCan(`page.${pageKey}`, \"read\")) return true;\r\n      const perms = Array.isArray(me?.permissions) ? me.permissions : [];\r\n      const countryId = scopeOpts.countryId;\r\n      return perms.some((perm) => {\r\n        if (perm.action !== \"read\" && perm.action !== \"write\") return false;\r\n        const res = String(perm.resource || \"\");\r\n        if (!res.startsWith(`section.${pageKey}.`)) return false;\r\n        const permCountry = perm.scope_country_id != null ? Number(perm.scope_country_id) : null;\r\n        const permSchool = perm.scope_school_id != null ? Number(perm.scope_school_id) : null;\r\n        if (permCountry != null && countryId != null && Number(permCountry) !== Number(countryId)) return false;\r\n        if (permSchool != null && schoolId != null && Number(permSchool) !== Number(schoolId)) return false;\r\n        if (permSchool != null && schoolId == null) return false;\r\n        if (permCountry != null && countryId == null) return false;\r\n        return true;\r\n      });\r\n    };\r\n    // Determine if user can perform scenario-level or module-level actions\r\n    // Scenario can only be sent when the active module is completed.\r\n    // Map active work ID to internal module key and to page permission resource\r\n    const workIdToKey = {\r\n      \"temel_bilgiler\": \"temel\",\r\n      \"kapasite\": \"kapasite\",\r\n      \"norm.ders_dagilimi\": \"norm\",\r\n      \"ik.local_staff\": \"ik\",\r\n      \"gelirler.unit_fee\": \"gelir\",\r\n      \"giderler.isletme\": \"gider\",\r\n    };\r\n    // Define the potential permission resources for each work item.  A module may\r\n    // have both a page-level and a section-level resource; having write\r\n    // permission on any of these resources allows the user to submit the\r\n    // module.  The order is from most specific (section-level) to page-level.\r\n    const workIdToWriteResources = {\r\n      \"temel_bilgiler\": [\"page.temel_bilgiler\"],\r\n      \"kapasite\": [\"section.kapasite.caps\", \"page.kapasite\"],\r\n      \"norm.ders_dagilimi\": [\"section.norm.ders_dagilimi\", \"page.norm\"],\r\n      \"ik.local_staff\": [\"section.ik.local_staff\", \"page.ik\"],\r\n      \"gelirler.unit_fee\": [\"section.gelirler.unit_fee\", \"page.gelirler\"],\r\n      \"giderler.isletme\": [\"section.giderler.isletme\", \"page.giderler\"],\r\n    };\r\n    const activeModuleKey = workIdToKey[String(activeWorkId || \"\")] || null;\r\n    const activeModuleObj = footerModules.find((m) => m.key === activeModuleKey);\r\n    const activeModuleDone = activeModuleObj ? activeModuleObj.done === true : false;\r\n    // Determine whether the user may attempt to submit (at least show the button).\r\n    // Principals/HR may submit when the scenario is in draft, in_review, or revision_requested.\r\n    // We only check module write permission and activeWorkId when enabling the button.\r\n    const canSubmitScenarioBase =\r\n      hasScenario &&\r\n      [\"draft\", \"in_review\", \"revision_requested\"].includes(scenarioStatus) &&\r\n      (role === \"principal\" || role === \"hr\" || role === \"manager\" || role === \"accountant\");\r\n    // Map active work ID to the corresponding page permission resource (if any)\r\n    const writeResources = activeWorkId ? workIdToWriteResources[String(activeWorkId)] || [] : [];\r\n    const userHasModuleWrite = writeResources.some((res) => {\r\n      try {\r\n        return userCan(res, \"write\");\r\n      } catch {\r\n        return false;\r\n      }\r\n    });\r\n    // Full submit flag: base permission and active module completed\r\n    // Determine if the user can actually submit the module right now.\r\n    // Must have base submit rights, an active work item, write permission on that module, and the module must be completed.\r\n    const canForwardScenario =\r\n      hasScenario &&\r\n      (role === \"accountant\" || role === \"manager\" || userCan(\"scenario.forward\", \"write\")) &&\r\n      scenarioStatus === \"approved\" &&\r\n      !selectedScenario?.sent_at &&\r\n      selectedScenario?.checked_at;\r\n    const canApproveScenario =\r\n      hasScenario &&\r\n      (role === \"admin\" || userCan(\"admin.scenario.review\", \"write\")) &&\r\n      scenarioStatus === \"sent_for_approval\";\r\n    const canReviewWorkItem =\r\n      hasScenario &&\r\n      activeWorkId &&\r\n      activeWorkState === \"submitted\" &&\r\n      (role === \"admin\" ||\r\n        role === \"manager\" ||\r\n        role === \"accountant\" ||\r\n        userCan(\"page.manage_permissions\", \"read\") ||\r\n        userCan(\"page.manage_permissions\", \"write\"));\r\n    const reviewDisabled =\r\n      reviewingWorkItem || inputsSaving || calculating || inputsDirty;\r\n    let reviewTooltip = \"Modl onayla\";\r\n    if (inputsDirty) {\r\n      reviewTooltip = \"nce deiiklikleri kaydedin.\";\r\n    } else if (inputsSaving) {\r\n      reviewTooltip = \"Kaydetme devam ediyor.\";\r\n    } else if (calculating) {\r\n      reviewTooltip = \"Hesaplama devam ediyor.\";\r\n    } else if (reviewingWorkItem) {\r\n      reviewTooltip = \"Onaylanyor...\";\r\n    }\r\n\r\n    // Calculate button permission: user must have write permissions on *all* modules\r\n    // Define the list of module page resources that correspond to scenario modules.\r\n    const moduleResources = [\r\n      \"page.temel_bilgiler\",\r\n      \"page.kapasite\",\r\n      \"page.norm\",\r\n      \"page.ik\",\r\n      \"page.gelirler\",\r\n      \"page.giderler\",\r\n    ];\r\n    const hasAllModuleWritePermissions = moduleResources.every((res) => {\r\n      try {\r\n        return can(me, res, \"write\", scopeOpts);\r\n      } catch {\r\n        return false;\r\n      }\r\n    });\r\n    // Determine disabled reasons\r\n    const primaryTooltipReasons = [];\r\n    let primaryDisabled = true;\r\n    let primaryLabel = \"\";\r\n    let primaryIcon = null;\r\n    let primaryOnClick = null;\r\n    // We evaluate actions in priority: Admin > Manager > Principal.\r\n    if (canApproveScenario) {\r\n      // Admin final approval\r\n      primaryLabel = \"Onayla\";\r\n      primaryIcon = <FaCheckCircle aria-hidden=\"true\" />;\r\n      primaryDisabled = false;\r\n      // Admin page rarely allows editing; still guard against concurrent save/calc\r\n      if (inputsSaving) {\r\n        primaryDisabled = true;\r\n        primaryTooltipReasons.push(\"Kaydetme devam ediyor.\");\r\n      }\r\n      if (calculating) {\r\n        primaryDisabled = true;\r\n        primaryTooltipReasons.push(\"Hesaplama devam ediyor.\");\r\n      }\r\n      if (!primaryDisabled) {\r\n        primaryOnClick = async () => {\r\n          try {\r\n            await api.adminReviewScenario(selectedScenario.id, { action: \"approve\" });\r\n            toast.success(\"Onayland\");\r\n            await refreshWorkItems();\r\n            await refreshScenarioMeta();\r\n          } catch (e) {\r\n            toast.error(e?.message || \"Onay baarsz\");\r\n          }\r\n        };\r\n      }\r\n    } else if (canForwardScenario) {\r\n      // Accountant/manager forward to admin\r\n      primaryLabel = \"Merkeze ilet\";\r\n      primaryIcon = <FaPaperPlane aria-hidden=\"true\" />;\r\n      primaryDisabled = false;\r\n      // disallow if modules incomplete or there are pending changes or locks\r\n      if (!allModulesDone) {\r\n        primaryDisabled = true;\r\n        const incomplete = footerModules.filter((m) => !m.done && !m.isOptional);\r\n        primaryTooltipReasons.push(\r\n          \"Tm modller tamamlanmal: \" +\r\n            incomplete.map((m) => `${m.label} ${m.pct}%`).join(\", \")\r\n        );\r\n      }\r\n      if (inputsDirty) {\r\n        primaryDisabled = true;\r\n        primaryTooltipReasons.push(\"nce deiiklikleri kaydedin.\");\r\n      }\r\n      if (inputsSaving) {\r\n        primaryDisabled = true;\r\n        primaryTooltipReasons.push(\"Kaydetme devam ediyor.\");\r\n      }\r\n      if (calculating) {\r\n        primaryDisabled = true;\r\n        primaryTooltipReasons.push(\"Hesaplama devam ediyor.\");\r\n      }\r\n      if (scenarioLocked) {\r\n        primaryDisabled = true;\r\n        primaryTooltipReasons.push(\"Senaryo kilitli.\");\r\n      }\r\n      if (!primaryDisabled) {\r\n        primaryOnClick = async () => {\r\n          try {\r\n            if (!ensurePrevRealFxForLocal(\"Hesaplama\")) return;\r\n            if (!ensurePlanningStudentsForY2Y3(\"Hesaplama\")) return;\r\n            // Save and recalc if needed\r\n            if (inputsDirty) {\r\n              const ok = await saveInputs();\r\n              if (!ok) return;\r\n            }\r\n            // Always calculate before sending so KPIs are up to date\r\n            const calcOk = await calculate({ keepTab: true });\r\n            if (!calcOk) return;\r\n            await api.sendForApproval(schoolId, selectedScenario.id);\r\n            toast.success(\"Merkeze iletildi\");\r\n            await refreshWorkItems();\r\n            await refreshScenarioMeta();\r\n          } catch (e) {\r\n            const reasons = Array.isArray(e?.data?.reasons) ? e.data.reasons.filter(Boolean) : [];\r\n            if (e?.status === 409 && reasons.length) {\r\n              toast.warn(`Merkeze iletilemez: ${reasons.join(\", \")}`);\r\n            } else {\r\n              toast.error(e?.message || \"letme baarsz\");\r\n            }\r\n          }\r\n        };\r\n      }\r\n    } else if (canSubmitScenarioBase) {\r\n      // Principal/HR submit to manager (module-level). Show button even if disabled.\r\n      primaryLabel = \"Gnder\";\r\n      primaryIcon = <FaPaperPlane aria-hidden=\"true\" />;\r\n      primaryDisabled = false;\r\n      // Validate prerequisites for module submission.  If any check fails we still show\r\n      // the button but keep it disabled with an explanatory tooltip.\r\n      if (!activeWorkId) {\r\n        primaryDisabled = true;\r\n        primaryTooltipReasons.push(\"G?nderilecek bir mod?l yok.\");\r\n      }\r\n      const isOptionalModule = activeWorkId && !isActiveRequired;\r\n      if (isOptionalModule) {\r\n        primaryDisabled = true;\r\n        primaryTooltipReasons.push(\"HQ senaryoda bu mod?l opsiyonel; g?nderilmesi gerekmiyor.\");\r\n      } else {\r\n        // User must have write permission on the active module's resource (page or section).\r\n        if (activeWorkId && !userHasModuleWrite) {\r\n          primaryDisabled = true;\r\n          primaryTooltipReasons.push(\"Bu mod?l? g?nderme yetkiniz yok.\");\r\n        }\r\n        // Module must be in a state that allows submission (not submitted or approved).\r\n        if (activeWorkId && !canSubmitWorkItem) {\r\n          primaryDisabled = true;\r\n          primaryTooltipReasons.push(moduleLockReason || \"Mod?l g?nderilemez\");\r\n        }\r\n        // Module must be completed before sending.\r\n        if (!activeModuleDone) {\r\n          primaryDisabled = true;\r\n          primaryTooltipReasons.push(\"Bu mod?l tamamlanmal?.\");\r\n        }\r\n        // Cannot submit while there are unsaved changes.\r\n        if (inputsDirty) {\r\n          primaryDisabled = true;\r\n          primaryTooltipReasons.push(\"?nce de?i?iklikleri kaydedin.\");\r\n        }\r\n        if (inputsSaving) {\r\n          primaryDisabled = true;\r\n          primaryTooltipReasons.push(\"Kaydetme devam ediyor.\");\r\n        }\r\n        if (calculating) {\r\n          primaryDisabled = true;\r\n          primaryTooltipReasons.push(\"Hesaplama devam ediyor.\");\r\n        }\r\n        if (scenarioLocked) {\r\n          primaryDisabled = true;\r\n          primaryTooltipReasons.push(\"Senaryo kilitli.\");\r\n        }\r\n      }\r\n      if (!primaryDisabled && activeWorkId && userHasModuleWrite && canSubmitWorkItem && activeModuleDone) {\r\n        // For module-level submission, submit only the active work item.\r\n        primaryOnClick = async () => {\r\n          await submitActiveWorkItem();\r\n        };\r\n      }\r\n    }\r\n    const primaryTooltip =\r\n      primaryTooltipReasons.length > 0 ? primaryTooltipReasons.join(\"  \") : undefined;\r\n    // Determine calculate and export labels as before\r\n    const hasReport = Boolean(report);\r\n    const calculateLabel = inputsDirty ? \"Kaydet & Hesapla\" : hasReport ? \"Yeniden Hesapla\" : \"Hesapla\";\r\n    const exportLabel = exportingPdf ? \"PDF hazirlaniyor...\" : \"Disa Aktar\";\r\n    const showExportButton = tab === \"report\" || hasReport;\r\n    return (\r\n      <div className=\"school-sticky-footer\" role=\"region\" aria-label=\"Scenario actions\">\r\n        <div className=\"school-sticky-footer-inner\">\r\n          <div className=\"school-footer-left\">\r\n            {/* Status chips */}\r\n            <div className=\"school-footer-pills\" role=\"status\" aria-live=\"polite\">\r\n              {primaryPill ? (\r\n                <span className={`school-pill ${primaryPill.className}`} title={primaryPill.tooltip}>\r\n                  {primaryPill.label}\r\n                </span>\r\n              ) : null}\r\n              {secondaryPill ? (\r\n                <span className={`school-pill ${secondaryPill.className}`} title={secondaryPill.tooltip}>\r\n                  {secondaryPill.label}\r\n                </span>\r\n              ) : null}\r\n              {inputs ? (\r\n                <span\r\n                  className={`school-pill is-warn ${inputsDirty ? \"\" : \"is-placeholder\"}`}\r\n                  title={inputsDirty ? \"Kaydedilmemi deiiklikler var\" : undefined}\r\n                  aria-hidden={inputsDirty ? undefined : \"true\"}\r\n                >\r\n                   Deiiklik var\r\n                </span>\r\n              ) : null}\r\n            </div>\r\n            {inputs ? (\r\n              <div\r\n                className={`school-footer-meta small ${hasFooterMeta ? \"\" : \"is-placeholder\"}`}\r\n                title={hasFooterMeta ? footerMetaText : undefined}\r\n                aria-hidden={hasFooterMeta ? undefined : \"true\"}\r\n              >\r\n                {hasFooterMeta ? footerMetaText : \"Kaydedildi\"}\r\n              </div>\r\n            ) : null}\r\n          </div>\r\n\r\n      {inputs ? (\r\n        <>\r\n          {/* Middle section: progress bar sits in its own container between status and buttons */}\r\n          <div className=\"school-footer-middle\">\r\n            <div className=\"module-progress\" role=\"progressbar\" aria-valuemin=\"0\" aria-valuemax=\"100\">\r\n              {footerModules.map((m) => {\r\n                const tabKey = moduleKeyToTab[m.key];\r\n                const canNav = Boolean(tabKey && canNavigateModule(m.key));\r\n                const isActive = activeModuleKey === m.key;\r\n                const workState = getModuleWorkState(m.key);\r\n                const statusClass = getModuleStatusClass(\r\n                  workState,\r\n                  selectedScenario?.status,\r\n                  selectedScenario?.sent_at\r\n                );\r\n                const SegmentTag = canNav ? \"button\" : \"div\";\r\n                return (\r\n                  <SegmentTag\r\n                    key={m.key}\r\n                    type={canNav ? \"button\" : undefined}\r\n                    onClick={canNav ? () => setTab(tabKey) : undefined}\r\n                    className={`module-seg ${canNav ? \"is-clickable\" : \"\"} ${isActive ? \"is-active\" : \"\"}`}\r\n                    title={`${m.label}: ${Math.round(m.pct)}% ${m.done ? \"Tamamland\" : \"Eksik\"}`}\r\n                    aria-disabled={canNav ? undefined : \"true\"}\r\n                  >\r\n                    <div className=\"module-title\">{m.labelShort}</div>\r\n                    <div className=\"module-bar\">\r\n                      <div\r\n                        className={`module-fill ${statusClass}`}\r\n                        style={{ width: `${Math.min(100, Math.max(0, Math.round(m.pct)))}%` }}\r\n                      />\r\n                      <span className=\"module-percent\">{Math.round(m.pct)}%</span>\r\n                    </div>\r\n                  </SegmentTag>\r\n                );\r\n              })}\r\n            </div>\r\n          </div>\r\n          {/* Right section: action buttons aligned to the far right */}\r\n          <div className=\"school-footer-right\">\r\n            {canReviewWorkItem ? (\r\n              <Tooltip lines={reviewTooltip ? [reviewTooltip] : []}>\r\n                <button\r\n                  type=\"button\"\r\n                  className=\"topbar-btn is-primary\"\r\n                  onClick={() => reviewActiveWorkItem(\"approve\")}\r\n                  disabled={reviewDisabled}\r\n                  title={reviewTooltip}\r\n                >\r\n                  <FaCheckCircle aria-hidden=\"true\" />\r\n                  <span>{reviewingWorkItem ? \"Onaylanyor...\" : \"Onayla\"}</span>\r\n                </button>\r\n              </Tooltip>\r\n            ) : null}\r\n            {primaryLabel ? (\r\n              <Tooltip lines={primaryTooltip ? [primaryTooltip] : []}>\r\n                <button\r\n                  type=\"button\"\r\n                  className=\"topbar-btn is-primary\"\r\n                  onClick={primaryOnClick}\r\n                  disabled={primaryDisabled}\r\n                  title={primaryTooltip}\r\n                >\r\n                  {primaryIcon}\r\n                  <span>{primaryLabel}</span>\r\n                </button>\r\n              </Tooltip>\r\n            ) : null}\r\n            <button\r\n              type=\"button\"\r\n              className={\"topbar-btn \" + (inputsDirty && !inputsSaving ? \"is-save\" : \"is-ghost\")}\r\n              onClick={saveInputs}\r\n              disabled={!inputsDirty || inputsSaving || inputsLocked}\r\n              title={\r\n                inputsLocked\r\n                  ? inputsLockedReason\r\n                  : inputsDirty\r\n                    ? \"Deiiklikleri kaydet\"\r\n                    : \"Kaydedilecek deiiklik yok\"\r\n              }\r\n            >\r\n              <FaSave aria-hidden=\"true\" />\r\n              <span>{inputsSaving ? \"Kaydediliyor...\" : inputsDirty ? \"Kaydet\" : \"Kaydedildi\"}</span>\r\n            </button>\r\n\r\n            {hasAllModuleWritePermissions ? (\r\n              <button\r\n                type=\"button\"\r\n                className=\"topbar-btn is-primary\"\r\n                onClick={async () => {\r\n                  if (inputsSaving || calculating) return;\r\n                  if (!ensurePrevRealFxForLocal(\"Hesaplama\")) return;\r\n                  if (!ensurePlanningStudentsForY2Y3(\"Hesaplama\")) return;\r\n                  if (inputsDirty) {\r\n                    const ok = await saveInputs();\r\n                    if (ok) await calculate();\r\n                    return;\r\n                  }\r\n                  await calculate();\r\n                }}\r\n                disabled={inputsSaving || calculating}\r\n                title={calculateLabel}\r\n              >\r\n                <FaCalculator aria-hidden=\"true\" />\r\n                <span>{calculating ? \"Hesaplanyor...\" : calculateLabel}</span>\r\n              </button>\r\n            ) : null}\r\n\r\n            {showExportButton ? (\r\n              <div className=\"action-menu\" ref={exportMenuRef}>\r\n                <button\r\n                  type=\"button\"\r\n                  className={`topbar-btn is-ghost ${exportingPdf ? \"is-loading\" : \"\"}`}\r\n                  onClick={() => {\r\n                    if (exportDisabled) return;\r\n                    setExportOpen((prev) => !prev);\r\n                  }}\r\n                  disabled={exportDisabled}\r\n                  aria-haspopup=\"menu\"\r\n                  aria-expanded={exportOpen}\r\n                  aria-busy={exportingPdf ? \"true\" : undefined}\r\n                >\r\n                  {exportingPdf ? <span className=\"pdf-export-spinner\" aria-hidden=\"true\" /> : null}\r\n                  {!exportingPdf ? <FaFileExport aria-hidden=\"true\" /> : null}\r\n                  <span>{exportLabel}</span>\r\n                </button>\r\n\r\n                {exportOpen ? (\r\n                  <div className=\"action-menu-panel action-menu-panel--up\" role=\"menu\">\r\n                    <button\r\n                      type=\"button\"\r\n                      className=\"action-menu-item\"\r\n                      onClick={() => {\r\n                        setExportOpen(false);\r\n                        handleExport();\r\n                      }}\r\n                      disabled={exportDisabled}\r\n                      role=\"menuitem\"\r\n                    >\r\n                      Excel (.xlsx)\r\n                    </button>\r\n                    <button\r\n                      type=\"button\"\r\n                      className=\"action-menu-item\"\r\n                      onClick={() => {\r\n                        setExportOpen(false);\r\n                        handleExportPdf();\r\n                      }}\r\n                      disabled={exportDisabled}\r\n                      role=\"menuitem\"\r\n                    >\r\n                      PDF (.pdf)\r\n                    </button>\r\n                  </div>\r\n                ) : null}\r\n              </div>\r\n            ) : null}\r\n          </div>\r\n        </>\r\n      ) : (\r\n        <div className=\"school-footer-right\">\r\n          <div className=\"school-footer-hint small\">nce bir senaryo sein.</div>\r\n        </div>\r\n      )}\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const outletContextValue = {\r\n    schoolId,\r\n    school,\r\n    me,\r\n    inputs,\r\n    setField,\r\n    norm,\r\n    setNorm: setNormSafe,\r\n    handlePlanningGradesChange,\r\n    dirtyPaths,\r\n    markDirty,\r\n    baseYear,\r\n    programType,\r\n    inputCurrencyCode,\r\n    selectedScenario,\r\n    prevReport,\r\n    prevScenarioMeta,\r\n    report,\r\n    reportCurrency,\r\n    setReportCurrency,\r\n    reportMode,\r\n    reportModeLoading,\r\n    handleReportModeChange,\r\n    detailedReportMode,\r\n    setDetailedReportMode,\r\n    reportExportRef,\r\n    progMap,\r\n    normAvgPct,\r\n    expensesAvgPct,\r\n    normMissingLines,\r\n    expensesMissingLines,\r\n    uiScopeKey,\r\n    handleIkSalaryComputed,\r\n\r\n    // Work item workflow context\r\n    workItems,\r\n    refreshWorkItems,\r\n    submitWorkItem,\r\n  };\r\n\r\n  return (\r\n    <div className=\"container school-page\">\r\n      <ToastContainer position=\"bottom-right\" autoClose={3500} newestOnTop closeOnClick pauseOnFocusLoss pauseOnHover hideProgressBar theme=\"dark\" />\r\n      <style>{`@keyframes schoolSpin{to{transform:rotate(360deg)}}`}</style>\r\n      {bootLoading ? (\r\n        <div className=\"modal-backdrop\" role=\"status\" aria-live=\"polite\" aria-busy=\"true\">\r\n          <div\r\n            className=\"card\"\r\n            style={{\r\n              width: \"min(420px, 92vw)\",\r\n              padding: \"18px 16px\",\r\n              textAlign: \"center\",\r\n            }}\r\n          >\r\n            <div\r\n              aria-hidden\r\n              style={{\r\n                width: 36,\r\n                height: 36,\r\n                margin: \"0 auto\",\r\n                borderRadius: \"50%\",\r\n                border: \"3px solid rgba(0,0,0,.15)\",\r\n                borderTopColor: \"rgba(0,0,0,.75)\",\r\n                animation: \"schoolSpin .8s linear infinite\",\r\n              }}\r\n            />\r\n            <div style={{ fontWeight: 800, marginTop: 12 }}>\r\n              {bootLoadingLabel || \"Yukleniyor...\"}\r\n            </div>\r\n            <div className=\"small muted\" style={{ marginTop: 6 }}>\r\n              Lutfen bekleyin...\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ) : null}\r\n\r\n      {err ? (\r\n        <div\r\n          className=\"card\"\r\n          style={{\r\n            marginTop: 10,\r\n            background: \"#fff1f2\",\r\n            borderColor: \"#fecaca\",\r\n          }}\r\n        >\r\n          {err}\r\n        </div>\r\n      ) : null}\r\n\r\n      {!selectedScenarioId ? (\r\n        <div className=\"card\" style={{ marginTop: 12 }}>\r\n          <div style={{ fontWeight: 700 }}>Okul & Senaryo Sec</div>\r\n          <div className=\"small\" style={{ marginTop: 6 }}>\r\n            Bu bolumu acmak icin once okul ve senaryo secin.\r\n          </div>\r\n          <button\r\n            type=\"button\"\r\n            className=\"btn primary\"\r\n            style={{ marginTop: 12 }}\r\n            onClick={() => navigate(`/select?schoolId=${schoolId}`)}\r\n          >\r\n            Okul & Senaryo Sec\r\n          </button>\r\n        </div>\r\n      ) : (\r\n        <Outlet context={outletContextValue} />\r\n      )}\r\n      {renderStickyFooter()}\r\n    </div>\r\n  );\r\n}\r\n\r\n","const KADEME_BASE_KEYS = [\"okulOncesi\", \"ilkokul\", \"ortaokul\", \"lise\"];\n\nexport function isHeadquarterScenario(inputs) {\n  const kademeler = inputs?.temelBilgiler?.kademeler;\n  if (!kademeler || typeof kademeler !== \"object\") return false;\n  return KADEME_BASE_KEYS.every((key) => kademeler?.[key]?.enabled === false);\n}\n","const PROGRAM_TYPES = {\r\n  LOCAL: \"local\",\r\n  INTERNATIONAL: \"international\",\r\n};\r\n\r\nconst ALLOWED_PROGRAM_TYPES = new Set(Object.values(PROGRAM_TYPES));\r\n\r\nfunction normalizeProgramType(value) {\r\n  const raw = String(value || \"\").trim().toLowerCase();\r\n  if (ALLOWED_PROGRAM_TYPES.has(raw)) return raw;\r\n  return PROGRAM_TYPES.LOCAL;\r\n}\r\n\r\nfunction getProgramType(inputs = {}, scenario = null) {\r\n  const programFromInputs =\r\n    inputs?.temelBilgiler?.programType ?? inputs?.programType ?? inputs?.program_type;\r\n  if (programFromInputs) {\r\n    return normalizeProgramType(programFromInputs);\r\n  }\r\n  const programFromScenario = scenario?.program_type || scenario?.programType;\r\n  if (programFromScenario) return normalizeProgramType(programFromScenario);\r\n  return PROGRAM_TYPES.LOCAL;\r\n}\r\n\r\nfunction isKademeKeyVisible(key, programType = PROGRAM_TYPES.LOCAL) {\r\n  const type = normalizeProgramType(programType);\r\n  if (!key) return true;\r\n  if (key === \"okulOncesi\") return true;\r\n  if (key.endsWith(\"Yerel\")) return type === PROGRAM_TYPES.LOCAL;\r\n  if (key.endsWith(\"Int\")) return type === PROGRAM_TYPES.INTERNATIONAL;\r\n  return true;\r\n}\r\n\r\nfunction mapBaseKademeToVariant(baseKademe, programType = PROGRAM_TYPES.LOCAL) {\r\n  const type = normalizeProgramType(programType);\r\n  if (baseKademe === \"okulOncesi\") return \"okulOncesi\";\r\n  const suffix = type === PROGRAM_TYPES.INTERNATIONAL ? \"Int\" : \"Yerel\";\r\n  return `${baseKademe}${suffix}`;\r\n}\r\n\r\nfunction getVariantKeysForProgramType(programType = PROGRAM_TYPES.LOCAL) {\r\n  const type = normalizeProgramType(programType);\r\n  return new Set([\r\n    \"okulOncesi\",\r\n    `ilkokul${type === PROGRAM_TYPES.INTERNATIONAL ? \"Int\" : \"Yerel\"}`,\r\n    `ortaokul${type === PROGRAM_TYPES.INTERNATIONAL ? \"Int\" : \"Yerel\"}`,\r\n    `lise${type === PROGRAM_TYPES.INTERNATIONAL ? \"Int\" : \"Yerel\"}`,\r\n  ]);\r\n}\r\n\r\nexport {\r\n  PROGRAM_TYPES,\r\n  ALLOWED_PROGRAM_TYPES,\r\n  getProgramType,\r\n  normalizeProgramType,\r\n  isKademeKeyVisible,\r\n  mapBaseKademeToVariant,\r\n  getVariantKeysForProgramType,\r\n};\r\n"],"names":["DEFAULT_PREFIX","safeRead","key","fallback","raw","window","localStorage","getItem","JSON","parse","_unused","useScenarioUiState","name","defaultValue","prefix","scope","arguments","length","undefined","scopeKey","scopeOverride","loc","useLocation","useMemo","trim","pathname","search","useScenarioScopeKey","storageKey","concat","loadedKeyRef","useRef","state","setState","useState","useEffect","current","value","setItem","stringify","_unused2","safeWrite","useScenarioUiFlag","opts","v","setV","next","useScenarioUiString","String","computeScenarioProgress","inputs","norm","config","scenario","catalog","buildProgressCatalog","normalizedConfig","defaults","DEFAULT_PROGRESS_CONFIG","input","sectionsInput","sections","out","version","Object","keys","forEach","id","base","incoming","enabled","mode","min","Number","selectedFields","normalizeConfig","isHQ","isHeadquarterScenario","HQ_INCLUDED_TABS","Set","sectionsById","Map","map","s","sectionResults","totalUnits","doneUnits","overallTotalUnits","overallDoneUnits","section","_catalog$context","_catalog$context2","_catalog$context3","cfg","set","includeInOverall","has","tabKey","addUnits","total","done","requiresKademe","hasKademeSelection","context","noKademeMode","kademeSelectedButEmpty","Boolean","enabledKademes","size","missingReasons","selectedIds","Array","isArray","fields","filter","_cfg$selectedFields","allowEmpty","label","applicable","fieldsById","field","appliesIf","_","filled","missing","getValue","ok","type","isNonEmptyString","toNum","isFilled","push","filledCount","modeDefault","toUpperCase","minRequired","isFinite","minDefault","Math","max","doneCount","tabs","tab","enabledSections","sectionIds","result","get","def","tabTotal","tabDone","missingLines","allDone","res","t","d","pct","round","missingPreview","join","effectiveTotal","effectiveDone","missingDetailsLines","reasons","visibleTabs","completedCount","totalCount","pathToResources","path","tokens","split","shift","page","replace","toLowerCase","PAGE_ALIASES","grades_years","grades_current","grades","prototype","hasOwnProperty","call","sectionSnake","pageMap","temel_bilgiler","inflation","ucret_artis_oranlari","okul_ucretleri_hesaplama","ik_mevcut","burs_indirim_ogrenci_sayilari","burs_ogr","rakip_analizi","rakip","performans","degerlendirme","okul_egitim_bilgileri","yetkililer","kademeler","program_type","gelirler","giderler","ik","discounts","grades_plan","kapasite","mapped","INPUT_HEADER_TABS","TAB_TO_ROUTE","basics","hr","income","expenses","detailedReport","report","ROUTE_TO_TAB","fromEntries","entries","_ref","TAB_TO_WORK_ID","HQ_REQUIRED_WORK_IDS","parseAcademicYear","academicYear","range","match","startYear","endYear","single","pctValue","n","mergeMissingLines","a","b","seen","list","line","val","add","slice","findArrayItemIndex","arr","part","byKey","findIndex","item","byName","byGrade","grade","idx","isInteger","SchoolPage","_inputs$temelBilgiler","_inputs$temelBilgiler2","useParams","location","navigate","useNavigate","outlet","useOutletContext","schoolId","school","setSchool","err","setErr","me","setMe","document","title","selectedScenario","setSelectedScenario","prevReport","setPrevReport","prevScenarioMeta","setPrevScenarioMeta","workItems","setWorkItems","workItemsLoaded","setWorkItemsLoaded","requiredWorkIds","setRequiredWorkIds","scenarioMetaLoaded","setScenarioMetaLoaded","reviewingWorkItem","setReviewingWorkItem","scenarios","setScenarios","selectedScenarioId","setSelectedScenarioId","readSelectedScenarioId","pendingTabAfterSelect","setPendingTabAfterSelect","refreshWorkItems","useCallback","async","sid","data","api","listWorkItems","refreshScenarioMeta","listScenarios","limit","offset","order","items","scenarioId","nextScenario","find","prev","_objectSpread","submitWorkItem","workId","toast","success","e","error","message","setNorm","progressConfig","setProgressConfig","setInputs","inputsSaving","setInputsSaving","dirtyPaths","setDirtyPaths","baselineInputs","setBaselineInputs","baselineNorm","setBaselineNorm","clearDirtyPrefix","changed","startsWith","hasDirtyPrefix","setReport","calculating","setCalculating","lastSavedAt","setLastSavedAt","lastCalculatedAt","setLastCalculatedAt","nowTick","setNowTick","exportOpen","setExportOpen","exportMenuRef","reportExportRef","exportingPdf","setExportingPdf","bootLoading","setBootLoading","bootLoadingLabel","setBootLoadingLabel","uiScopeKey","reportCurrency","setReportCurrency","reportCurrencyDefaultedForRef","reportMode","setReportMode","reportModeLoading","setReportModeLoading","detailedReportMode","setDetailedReportMode","activeRouteSegment","activeWorkId","activeWorkItem","work_id","activeWorkState","moduleLocked","includes","setTab","React","nextTab","segment","writeLastVisitedPath","writeGlobalLastRouteSegment","targetSegment","readLastVisitedPath","target","setInterval","Date","now","clearInterval","handleClick","event","el","contains","handleKey","addEventListener","removeEventListener","baseYear","academic_year","inputCurrencyCode","input_currency","local_currency_code","isLocalScenario","prevRealFxValue","temelBilgiler","prevYearRealizedFxUsdToLocal","prevRealFxMissing","programType","getProgramType","permissionScope","_ref2","_school$country_id","countryId","country_id","canReadNorm","can","canWriteGiderler","ignoreNormProgress","scenarioProgress","writeScenarioFlags","isHeadquarter","progMap","normAvgPct","gradesPlan","expensesAvgPct","normMissingLines","_progMap$gradesPlan","_progMap$norm","expensesMissingLines","_progMap$giderler","_progMap$giderler2","_progMap$discounts","fetchScenarioReport","nextMode","getScenarioReport","results","handleReportModeChange","setHeaderMeta","subtitle","hideDefault","centered","_outlet$clearHeaderMe","clearHeaderMeta","applyIkSalariesToGiderler","inInputs","_ik$years","_src$giderler","_src$giderler$isletme","src","yearIK","years","y1","unitCosts","headcountsByLevel","roles","levelKeys","levels","roleAnnual","r","count","lvl","_headcountsByLevel$lv","patch","turkPersonelMaas","turk_mudur","turk_mdyard","turk_egitimci","turkDestekPersonelMaas","turk_temsil","yerelPersonelMaas","yerel_yonetici_egitimci","yerelDestekPersonelMaas","yerel_destek","yerel_ulke_temsil_destek","internationalPersonelMaas","int_yonetici_egitimci","prevItems","isletme","k","abs","structuredClone","normalizeCapacityInputs","_cap$years","_cap$years2","_cap$years3","safeNum","legacy","schoolCapacity","cap","y2","y3","currentStudents","byKademe","normalizeGradesInputs","defaultGrades","getGradeOptions","g","branchCount","studentsPerBranch","baseGrades","gradesYears","toMap","m","row","_row$grade","_row$branchCount","_row$studentsPerBranc","normalizeRow","areGradesEqual","ma","mb","ra","rb","applyTuitionStudentCounts","_s$gradesYears","_s$temelBilgiler","_s$gelirler","_s$gelirler$tuition","sums","summarizeGradesByKademe","variantCounts","okulOncesi","ilkokulYerel","ilkokulInt","ortaokulYerel","ortaokulInt","liseYerel","liseInt","mapBaseKademeToVariant","ilkokul","ortaokul","lise","tuitionSync","syncRows","rows","getCount","nextRows","_r$key","_r$studentCount","nextCount","studentCount","tuition","active","getProgressRequirements","loadProgressConfig","getSchool","meInfo","getMe","sc","some","x","writeSelectedScenarioId","loadAll","_data$norm","getScenarioContext","normalized","inf","toFinite","expenseDeviationPct","y2023","y2024","y2025","currentSeasonAvgFee","mudur","ulkeTemsilcisi","raporuHazirlayan","okulEgitimBilgileri","egitimBaslamaTarihi","zorunluEgitimDonemleri","birDersSuresiDakika","gunlukDersSaati","haftalikDersSaatiToplam","sabahciOglenci","ogretmenHaftalikDersOrt","gecisSinaviBilgisi","uygulananProgram","normalizeKademeConfig","normalizeProgramType","okulUcretleriHesaplama","ucretArtisOranlari","ikMevcut","turkPersonelYoneticiEgitimci","turkPersonelTemsilcilik","yerelKadroluEgitimci","yerelUcretliVakaterEgitimci","yerelDestek","yerelTemsilcilik","international","bursIndirimOgrenciSayilari","magisBasariBursu","maarifYetenekBursu","ihtiyacBursu","okulBasariBursu","tamEgitimBursu","barinmaBursu","turkceBasariBursu","uluslararasiYukumlulukIndirimi","vakifCalisaniIndirimi","kardesIndirimi","erkenKayitIndirimi","pesinOdemeIndirimi","kademeGecisIndirimi","temsilIndirimi","kurumIndirimi","istisnaiIndirim","yerelMevzuatIndirimi","rakipAnalizi","c","gerceklesen","ogrenciSayisi","karZarar","bursVeIndirimler","normalizeTemelBilgilerInputs","loadScenario","isLocal","fx_usd_to_local","scenarioKey","year","prevStartYear","prevEndYear","prevScenario","parsed","calculateScenario","loadPrev","scenarioLocked","status","submittedAt","submitted_at","sentAt","sent_at","isScenarioLocked","inputsLocked","saveNormConfig","payload","teacherWeeklyMaxHours","curriculumWeeklyHours","getNormConfig","saveInputs","shouldSaveInputs","shouldSaveNorm","patched","modifiedResourcesSet","inputDirty","p","pathStr","modifiedResources","from","saveScenarioInputs","sumPlannedStudents","sum","_row$studentsPerBranc2","showBlockingToast","toastId","warn","position","autoClose","closeOnClick","draggable","icon","style","background","color","border","boxShadow","borderRadius","ensurePlanningStudentsForY2Y3","actionLabel","totals","srcInputs","getPlannedStudentTotalsByYear","msg","ensurePrevRealFxForLocal","calculate","options","skipPlanValidation","keepTab","console","log","hasResults","valuesEqual","is","getValueAtPath","obj","parts","cur","getBaselineValue","last","endsWith","suffix","baseField","baseVal","infl","y2f","y3f","parent","yearsIdx","indexOf","yearKey","altParts","altVal","ratio","multiplier","u","byIdx","lvlKey","per","yearsY1","curAll","inputsDirty","submitActiveWorkItem","reviewActiveWorkItem","action","reviewWorkItem","role","warnUnsavedChanges","moduleLockReason","inputsLockedReason","isActiveRequired","canSubmitWorkItem","markDirty","i","setValueAtPath","baselineValue","same","delete","areSetsEqual","handleBeforeUnload","preventDefault","returnValue","__fsUnsavedChanges","handleIkSalaryComputed","salaryByYear","_p$giderler","_p$giderler$isletme","handlePlanningGradesChange","setNormSafe","updater","showInputsHeader","exportDisabled","formatRelative","ms","diff","floor","getScenarioStageClass","outletContextValue","setField","_jsxs","className","children","_jsx","ToastContainer","newestOnTop","pauseOnFocusLoss","pauseOnHover","hideProgressBar","theme","width","padding","textAlign","height","margin","borderTopColor","animation","fontWeight","marginTop","borderColor","Outlet","onClick","_progMap$gradesPlan2","_progMap$gradesPlan3","_progMap$gradesPlan4","_progMap$gradesPlan5","_progMap$norm2","_progMap$norm3","_progMap$giderler3","_progMap$giderler4","_progMap$giderler5","_progMap$giderler6","_progMap$discounts2","_progMap$discounts3","_ref3","_school$country_id2","moduleKeyToWorkId","temel","gelir","gider","footerModules","optionalSuffix","labelShort","isOptional","normDone","giderDone","allModulesDone","every","scenarioProgressPct","progress_pct","scenarioStageLabel","progressPct","getScenarioStageLabel","scenarioDisplayLabel","scenarioDisplayClass","workItemLabel","getWorkItemStageLabel","workItemClass","hasActiveWorkLabel","scenarioTooltip","checked_at","getTime","toLocaleString","reviewed_at","primaryPill","secondaryPill","scenarioIsFinal","allowScenarioPill","scenarioPillLabel","scenarioPillClass","scenarioPillTooltip","tooltip","footerMetaBits","showDebug","_window","_window$localStorage","debugBits","toLocaleTimeString","footerMetaText","hasFooterMeta","countryIdForScope","scopeOpts","scenarioStatus","hasScenario","userCan","_unused3","moduleKeyToTab","moduleKeyToPageKey","activeModuleKey","activeModuleObj","activeModuleDone","canSubmitScenarioBase","userHasModuleWrite","_unused4","canForwardScenario","canApproveScenario","canReviewWorkItem","reviewDisabled","reviewTooltip","hasAllModuleWritePermissions","_unused5","primaryTooltipReasons","primaryDisabled","primaryLabel","primaryIcon","primaryOnClick","FaCheckCircle","adminReviewScenario","FaPaperPlane","incomplete","sendForApproval","_e$data","primaryTooltip","hasReport","calculateLabel","exportLabel","showExportButton","_Fragment","canNav","moduleKey","pageKey","perms","permissions","perm","resource","permCountry","scope_country_id","permSchool","scope_school_id","canNavigateModule","isActive","statusClass","scenarioSentAt","getModuleStatusClass","w","getModuleWorkState","SegmentTag","Tooltip","lines","disabled","FaSave","FaCalculator","ref","FaFileExport","downloadXlsx","handleExport","downloadPdf","handleExportPdf","renderStickyFooter","KADEME_BASE_KEYS","_kademeler$key","PROGRAM_TYPES","LOCAL","INTERNATIONAL","ALLOWED_PROGRAM_TYPES","values","programFromInputs","programFromScenario","isKademeKeyVisible","baseKademe"],"ignoreList":[],"sourceRoot":""}