"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[6],{5006(e,a,r){r.r(a),r.d(a,{default:()=>j});var i=r(2555),l=r(5043),t=r(9570),n=r(4839),s=r(5685),o=r(2115),d=r(3204),c=r(7559),u=r(3182),m=r(5534),v=r(579);const p=["temel_bilgiler","kapasite","norm.ders_dagilimi","ik.local_staff","gelirler.unit_fee","giderler.isletme"],h={temel_bilgiler:"Temel Bilgiler",kapasite:"Kapasite","norm.ders_dagilimi":"Norm","ik.local_staff":"\u0130K","gelirler.unit_fee":"Gelirler","giderler.isletme":"Giderler"},y={temel_bilgiler:"temel-bilgiler",kapasite:"kapasite","norm.ders_dagilimi":"norm","ik.local_staff":"ik","gelirler.unit_fee":"gelirler","giderler.isletme":"giderler"};function b(e){const a=Number(null===e||void 0===e?void 0:e.totalRequired);return Number.isFinite(a)&&a>0?a:Array.isArray(null===e||void 0===e?void 0:e.requiredItems)?e.requiredItems.length:p.length}const x=[{key:"all",label:"T\xfcm\xfc"},{key:"ready",label:"Merkeze \u0130letilmeye Haz\u0131r"},{key:"in_review",label:"\u0130ncelemede"},{key:"revision",label:"Revize \u0130stendi"},{key:"approved",label:"Kontrol Edildi"},{key:"sent",label:"Merkeze \u0130letildi"},{key:"approved_final",label:"Onayland\u0131"}],f={all:d.x7F,ready:d.A7C,in_review:d.KSO,revision:d.BS8,approved:d.CMH,sent:d.Cer,approved_final:d.gt3};function k(e){const a=null===e||void 0===e?void 0:e.status,r=null===e||void 0===e?void 0:e.sent_at;switch(a){case"revision_requested":return{label:"Revize \u0130stendi",className:"is-bad"};case"sent_for_approval":return{label:"Merkeze iletildi",className:"is-warn"};case"approved":return r?{label:"Onayland\u0131",className:"is-ok"}:{label:"Kontrol edildi",className:"is-ok"};case"in_review":return{label:"\u0130ncelemede",className:"is-warn"};case"submitted":return{label:"Onayda",className:"is-warn"};default:return{label:"Taslak",className:"is-muted"}}}function j(){var e;const a=(0,u.A)(),r=(0,s.KC)(),d=(0,s.Zp)(),[j,q]=(0,l.useState)([]),[w,C]=(0,l.useState)(!1),[_,I]=(0,l.useState)("all"),[A,S]=(0,l.useState)(null),[R,M]=(0,l.useState)(!0),E=(0,l.useRef)(null),z=(0,l.useRef)(null),O=(0,l.useRef)(!1),P=(0,l.useId)(),F=(0,l.useId)(),B=(0,l.useCallback)(()=>{O.current=!1,M(!0),requestAnimationFrame(()=>S(null))},[]),H=(0,l.useCallback)(e=>{var a,r;O.current=!0,M(!0),E.current=null!==(a=null===e||void 0===e||null===(r=e.scenario)||void 0===r?void 0:r.id)&&void 0!==a?a:null,S(e)},[]);(0,l.useEffect)(()=>{function e(e){"Escape"===e.key&&B()}return document.body.style.overflow=A&&"object"===typeof A?"hidden":"auto",window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[A,B]),(0,l.useEffect)(()=>{if(!A)return;const e=window.setTimeout(()=>M(!1),220);return()=>window.clearTimeout(e)},[A]);const K=(0,l.useMemo)(()=>{var e,r;const i=null===(e=a.user)||void 0===e?void 0:e.role;if("admin"===i||"manager"===i||"accountant"===i)return!0;const l=null===(r=a.user)||void 0===r?void 0:r.permissions;return!!Array.isArray(l)&&l.some(e=>"page.manage_permissions"===e.resource&&("read"===e.action||"write"===e.action))},[a.user]);(0,l.useEffect)(()=>{var e;return null===r||void 0===r||null===(e=r.setHeaderMeta)||void 0===e||e.call(r,{title:"Review Queue",subtitle:"Mod\xfcl onay kuyru\u011fu",centered:!0}),()=>{var e;null===r||void 0===r||null===(e=r.clearHeaderMeta)||void 0===e||e.call(r)}},[r]);const L=(0,l.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(K){C(!0);try{var a;const r=await c.FH.managerGetReviewQueue(),i=Array.isArray(r)?r:[],l=null!==(a=null===e||void 0===e?void 0:e.activeScenarioId)&&void 0!==a?a:E.current;if(("boolean"===typeof(null===e||void 0===e?void 0:e.deferUpdate)?e.deferUpdate:O.current||null!=l)?z.current=i:q(i),null!=l){const e=i.find(e=>{var a;return String(null===e||void 0===e||null===(a=e.scenario)||void 0===a?void 0:a.id)===String(l)});e&&S({school:e.school,scenario:e.scenario,requiredItems:e.requiredItems,approvedCount:e.approvedCount,totalRequired:b(e)})}}catch(r){console.error(r),o.oR.error((null===r||void 0===r?void 0:r.message)||"Failed to load review queue")}finally{C(!1)}}},[K]);(0,l.useEffect)(()=>{var e,a;E.current=null!==(e=null===A||void 0===A||null===(a=A.scenario)||void 0===a?void 0:a.id)&&void 0!==e?e:null,O.current=Boolean(A),!A&&z.current&&(q(z.current),z.current=null)},[A]),(0,l.useEffect)(()=>{L()},[L]);const T=(0,l.useCallback)((e,a)=>{if(!e)return!1;const r=e.scenario||{},i=r.status,l=r.sent_at,t=Number(e.approvedCount||0)===b(e),n="approved"===i&&!l,s="approved"===i&&!!l;switch(a){case"ready":return n&&t;case"in_review":return"in_review"===i||"submitted"===i;case"revision":return"revision_requested"===i;case"approved":return n;case"sent":return"sent_for_approval"===i;case"approved_final":return s;default:return!0}},[]),W=(0,l.useMemo)(()=>{const e=Object.fromEntries(x.map(e=>[e.key,0]));return e.all=Array.isArray(j)?j.length:0,Array.isArray(j)?(j.forEach(a=>{x.forEach(r=>{"all"!==r.key&&T(a,r.key)&&(e[r.key]+=1)})}),e):e},[j,T]),D=(0,l.useMemo)(()=>Array.isArray(j)?"all"===_?j:j.filter(e=>T(e,_)):[],[j,_,T]),G=Math.max(0,x.findIndex(e=>e.key===_)),U=(0,l.useCallback)((e,a,r)=>{const i=y[r];i&&((0,m.sE)(e,a),(0,m.BM)(e,a,i),(0,m.dW)(i),d("/schools/".concat(e,"/").concat(i)))},[d]),Q=(0,l.useCallback)((e,a)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),I(a))},[]),Y=(e,a,r,l)=>{const t=Array.isArray(e)?e.map(e=>{var t;return e.workId!==a?e:(0,i.A)((0,i.A)({},e),{},{item:(0,i.A)((0,i.A)({},e.item),{},{state:r,manager_comment:l||(null===(t=e.item)||void 0===t?void 0:t.manager_comment)})})}):e,n=Array.isArray(t)?t.filter(e=>{var a;return"approved"===(null===e||void 0===e||null===(a=e.item)||void 0===a?void 0:a.state)}).length:0;return{updatedItems:t,approvedCount:n}},Z=(0,l.useCallback)((e,a)=>{q(r=>r.map(r=>null!==r&&void 0!==r&&r.scenario?String(r.scenario.id)!==String(e)?r:a(r):r))},[]);if(!K)return(0,v.jsx)("div",{className:"container",children:(0,v.jsxs)("div",{className:"card",children:[(0,v.jsx)("div",{style:{fontWeight:700},children:"Access Denied"}),(0,v.jsx)("div",{className:"small",style:{marginTop:6},children:"You do not have permission to view the review queue."})]})});const J=null===A||void 0===A?void 0:A.scenario,V=null===A||void 0===A?void 0:A.school,X=J?k(J):null,$=A?b(A):p.length;return(0,v.jsxs)("div",{className:"container",children:[(0,v.jsx)(o.N9,{position:"bottom-right",autoClose:3500,newestOnTop:!0,closeOnClick:!0,pauseOnFocusLoss:!0,pauseOnHover:!0,hideProgressBar:!0,theme:"dark"}),(0,v.jsx)(t.N,{children:A&&"object"===typeof A?(0,v.jsx)(n.P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"rq-overlay",onClick:B},"rq-overlay"):null}),(0,v.jsx)(t.N,{children:A&&"object"===typeof A?(0,v.jsxs)("div",{className:"rq-modal-wrap",role:"dialog","aria-modal":"true","aria-label":"Scenario details",onClick:e=>{e.target===e.currentTarget&&B()},children:[(0,v.jsx)(n.P.button,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,transition:{duration:.05}},className:"rq-close-btn",type:"button",onClick:B,"aria-label":"Close",children:(0,v.jsx)(N,{})},"rq-close-".concat(null===J||void 0===J?void 0:J.id,"-").concat(P)),(0,v.jsxs)(n.P.div,{layoutId:R?"rq-card-".concat(null===J||void 0===J?void 0:J.id,"-").concat(P):"rq-modal-".concat(null===J||void 0===J?void 0:J.id,"-").concat(P),className:"card rq-modal",onClick:e=>e.stopPropagation(),children:[(0,v.jsxs)("div",{className:"rq-modal-head",children:[(0,v.jsx)(n.P.div,{layoutId:R?"rq-thumb-".concat(null===J||void 0===J?void 0:J.id,"-").concat(P):"rq-modal-thumb-".concat(null===J||void 0===J?void 0:J.id,"-").concat(P),className:"rq-thumb rq-thumb--lg",children:g(J)}),(0,v.jsxs)("div",{className:"rq-modal-head-text",children:[(0,v.jsxs)(n.P.div,{layoutId:R?"rq-title-".concat(null===J||void 0===J?void 0:J.id,"-").concat(P):"rq-modal-title-".concat(null===J||void 0===J?void 0:J.id,"-").concat(P),className:"rq-title rq-title--lg",children:[null===J||void 0===J?void 0:J.name," (",null===J||void 0===J?void 0:J.academic_year,")"]}),(0,v.jsx)("div",{className:"rq-subtitle",children:null===V||void 0===V?void 0:V.name})]}),(0,v.jsxs)("div",{className:"rq-modal-top-actions",children:[X?(0,v.jsx)("span",{className:"status-badge ".concat(X.className),children:X.label}):null,A?(0,v.jsxs)("span",{className:"small is-muted",children:[A.approvedCount,"/",$," onayland\u0131"]}):null]})]}),(0,v.jsxs)("div",{className:"rq-modal-body",children:[(0,v.jsxs)("div",{className:"small is-muted",style:{marginBottom:10},children:["Mod\xfclleri inceleyin. \u201cG\xf6nderildi\u201d durumundaki mod\xfcller i\xe7in ",(0,v.jsx)("b",{children:"Onayla"})," veya"," ",(0,v.jsx)("b",{children:"Revizyon \u0130ste"})," kullan\u0131n."]}),(0,v.jsx)("div",{className:"review-queue-card-inner",children:(0,v.jsxs)("table",{className:"table",children:[(0,v.jsx)("thead",{children:(0,v.jsxs)("tr",{children:[(0,v.jsx)("th",{children:"Mod\xfcl"}),(0,v.jsx)("th",{children:"Durum"}),(0,v.jsx)("th",{children:"G\xf6nderildi"}),(0,v.jsx)("th",{children:"Yorum"}),(0,v.jsx)("th",{})]})}),(0,v.jsx)("tbody",{children:null===A||void 0===A||null===(e=A.requiredItems)||void 0===e?void 0:e.map(e=>{let{workId:a,item:r}=e;const l=(null===r||void 0===r?void 0:r.state)||"not_started",t=function(e){switch(e){case"approved":return{label:"Kontrol edildi",className:"is-ok"};case"needs_revision":return{label:"Revize \u0130stendi",className:"is-bad"};case"submitted":return{label:"\u0130ncelemede",className:"is-warn"};case"in_progress":return{label:"Haz\u0131rlan\u0131yor",className:"is-warn"};default:return{label:"Ba\u015flanmad\u0131",className:"is-muted"}}}(l),n=null!==r&&void 0!==r&&r.submitted_at?new Date(r.submitted_at).toLocaleString():"-",s=(null===r||void 0===r?void 0:r.manager_comment)||"-",d="submitted"===l,u="submitted"===l,m=Boolean(y[a]);return(0,v.jsxs)("tr",{className:"submitted"===l?"highlight-row":"",children:[(0,v.jsx)("td",{children:m?(0,v.jsx)("button",{type:"button",className:"review-queue-module-link",onClick:()=>{B(),U(V.id,J.id,a)},title:"Mod\xfcle git",children:h[a]||a}):h[a]||a}),(0,v.jsx)("td",{children:(0,v.jsx)("span",{className:"status-badge ".concat(t.className),children:t.label})}),(0,v.jsx)("td",{className:"small",children:n}),(0,v.jsx)("td",{className:"small",style:{maxWidth:260,whiteSpace:"pre-wrap"},children:s}),(0,v.jsxs)("td",{children:[d?(0,v.jsx)("button",{className:"btn sm primary",type:"button",onClick:()=>(async(e,a,r)=>{try{var l;await c.FH.reviewWorkItem(e,a,r,{action:"approve"}),o.oR.success("Onayland\u0131"),String(null===A||void 0===A||null===(l=A.scenario)||void 0===l?void 0:l.id)===String(a)?(S(e=>{if(!e)return e;const{updatedItems:a,approvedCount:l}=Y(e.requiredItems,r,"approved");return(0,i.A)((0,i.A)({},e),{},{requiredItems:a,approvedCount:l})}),Z(a,e=>{const{updatedItems:a,approvedCount:l}=Y(e.requiredItems,r,"approved");return(0,i.A)((0,i.A)({},e),{},{requiredItems:a,approvedCount:l})})):L({deferUpdate:!1})}catch(t){console.error(t),o.oR.error((null===t||void 0===t?void 0:t.message)||"Failed to approve work item")}})(V.id,J.id,a),children:"Onayla"}):null,u?(0,v.jsx)("button",{className:"btn sm danger",type:"button",onClick:()=>(async(e,a,r)=>{const l=window.prompt("Revizyon notu (opsiyonel):");if(void 0!==l)try{var t;if(await c.FH.reviewWorkItem(e,a,r,{action:"revise",comment:l&&l.trim()?l.trim():void 0}),o.oR.success("Revizyon istendi"),String(null===A||void 0===A||null===(t=A.scenario)||void 0===t?void 0:t.id)===String(a)){const e=l&&l.trim()?l.trim():"";S(a=>{if(!a)return a;const{updatedItems:l,approvedCount:t}=Y(a.requiredItems,r,"needs_revision",e);return(0,i.A)((0,i.A)({},a),{},{requiredItems:l,approvedCount:t})}),Z(a,a=>{const{updatedItems:l,approvedCount:t}=Y(a.requiredItems,r,"needs_revision",e);return(0,i.A)((0,i.A)({},a),{},{requiredItems:l,approvedCount:t})})}else L({deferUpdate:!1})}catch(n){console.error(n),o.oR.error((null===n||void 0===n?void 0:n.message)||"Failed to request revision")}})(V.id,J.id,a),children:"Revizyon \u0130ste"}):null]})]},a)})})]})})]}),(0,v.jsx)("div",{className:"rq-modal-footer",children:(0,v.jsx)("button",{className:"btn",type:"button",onClick:B,children:"Kapat"})})]})]}):null}),(0,v.jsxs)("section",{className:"review-queue-tabs",style:{"--rq-tab-count":x.length,"--rq-active-index":G},children:[x.map(e=>{const a="".concat(F,"-").concat(e.key);return(0,v.jsx)("input",{id:a,type:"radio",name:"review-queue-filter-".concat(F),className:"rq-tab-input",checked:_===e.key,onChange:()=>I(e.key)},a)}),(0,v.jsx)("nav",{className:"rq-tab-nav",role:"tablist","aria-label":"Senaryo filtresi",children:x.map(e=>{var a;const r="".concat(F,"-").concat(e.key),i=_===e.key,l=f[e.key];return(0,v.jsxs)("label",{htmlFor:r,role:"tab","aria-selected":i,tabIndex:0,className:"review-queue-tab ".concat(i?"is-active":""),onKeyDown:a=>Q(a,e.key),children:[(0,v.jsx)("span",{className:"rq-tab-icon",children:l?(0,v.jsx)(l,{"aria-hidden":"true"}):null}),(0,v.jsx)("span",{className:"rq-tab-text",children:e.label}),(0,v.jsx)("span",{className:"review-queue-count",children:null!==(a=W[e.key])&&void 0!==a?a:0})]},e.key)})})]}),w?(0,v.jsx)("div",{className:"card",children:"Loading..."}):0===D.length?(0,v.jsx)("div",{className:"card",children:(0,v.jsx)("div",{children:"No scenarios to review"})}):(0,v.jsx)("div",{className:"review-queue-cards",children:D.map(e=>{const{school:a,scenario:r,requiredItems:i,approvedCount:l}=e,t=k(r),s=b(e),o={school:a,scenario:r,requiredItems:i,approvedCount:l,totalRequired:s};return(0,v.jsx)(n.P.div,{layoutId:"rq-card-".concat(r.id,"-").concat(P),className:"card rq-card-compact",onClick:()=>H(o),children:(0,v.jsxs)("div",{className:"rq-compact-row",children:[(0,v.jsxs)("div",{className:"rq-compact-left",children:[(0,v.jsx)(n.P.div,{layoutId:"rq-thumb-".concat(r.id,"-").concat(P),className:"rq-thumb",children:g(r)}),(0,v.jsxs)("div",{children:[(0,v.jsx)("div",{className:"rq-kicker",children:null===a||void 0===a?void 0:a.name}),(0,v.jsxs)(n.P.div,{layoutId:"rq-title-".concat(r.id,"-").concat(P),className:"rq-title",children:[r.name," (",r.academic_year,")"]}),(0,v.jsxs)("div",{className:"rq-subtitle",children:[(0,v.jsx)("span",{className:"status-badge ".concat(t.className),children:t.label}),(0,v.jsxs)("span",{className:"small is-muted",style:{marginLeft:8},children:[l,"/",s," onayland\u0131"]})]})]})]}),(0,v.jsx)("div",{className:"rq-actions",children:(0,v.jsx)("button",{type:"button",className:"rq-open-pill",onClick:e=>{e.stopPropagation(),H(o)},children:"\u0130ncele"})})]})},r.id)})})]})}function N(){return(0,v.jsxs)(n.P.svg,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,transition:{duration:.05}},xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"rq-close-icon",children:[(0,v.jsx)("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"}),(0,v.jsx)("path",{d:"M18 6l-12 12"}),(0,v.jsx)("path",{d:"M6 6l12 12"})]})}function g(e){var a,r;const i=String((null===e||void 0===e?void 0:e.name)||"").trim();if(!i)return"S";const l=i.split(/\s+/).filter(Boolean);return(((null===(a=l[0])||void 0===a?void 0:a[0])||"S")+((null===(r=l[1])||void 0===r?void 0:r[0])||"")).toUpperCase()}}}]);
//# sourceMappingURL=6.afde1519.chunk.js.map