{"version":3,"file":"static/js/292.7c08c4b4.chunk.js","mappings":"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","sources":["components/permissions/PermissionsTable.jsx","components/access/AdminCreateUserModal.jsx","components/access/AdminCreateSchoolModal.jsx","components/access/AdminSchoolPrincipalsDrawer.jsx","pages/AdminPermissionsPage.jsx","hooks/useListQueries.js"],"sourcesContent":["import React, { useEffect, useMemo, useState } from \"react\";\r\n\r\nconst stripActionSuffix = (label) => {\r\n  const raw = String(label || \"\");\r\n  return raw.replace(/\\s*(?:-|\\u2013)\\s*(View|Edit)\\s*$/i, \"\");\r\n};\r\n\r\nconst renderPermMark = (enabled) => (\r\n  <span className={`perm-mark ${enabled ? \"is-yes\" : \"is-no\"}`}>\r\n    {enabled ? (\r\n      <svg viewBox=\"0 0 24 24\" aria-hidden=\"true\" className=\"perm-mark-icon\">\r\n        <path d=\"M5 13l4 4L19 7\" />\r\n      </svg>\r\n    ) : (\r\n      <svg viewBox=\"0 0 24 24\" aria-hidden=\"true\" className=\"perm-mark-icon\">\r\n        <path d=\"M6 6l12 12M18 6l-12 12\" />\r\n      </svg>\r\n    )}\r\n  </span>\r\n);\r\n\r\nexport default function PermissionsTable({\r\n  permissionsGrouped = {},\r\n  permissionSelections = {},\r\n  permissionScopes = {},\r\n  userSchools = [],\r\n  isAdmin = false,\r\n  onTogglePermission,\r\n  onToggleGroup,\r\n  onScopeChange,\r\n  defaultCollapsed = false,\r\n}) {\r\n  // Local search state for filtering permissions\r\n  const [search, setSearch] = useState(\"\");\r\n  // Track collapsed state for groups\r\n  const [collapsedGroups, setCollapsedGroups] = useState(() => {\r\n    if (!defaultCollapsed) return {};\r\n    const groupKeys = Object.keys(permissionsGrouped || {});\r\n    if (groupKeys.length === 0) return {};\r\n    return groupKeys.reduce((acc, grp) => {\r\n      acc[grp] = true;\r\n      return acc;\r\n    }, {});\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (!defaultCollapsed) return;\r\n    const groupKeys = Object.keys(permissionsGrouped || {});\r\n    if (groupKeys.length === 0) return;\r\n    setCollapsedGroups((prev) => {\r\n      let changed = false;\r\n      const next = { ...prev };\r\n      groupKeys.forEach((grp) => {\r\n        if (next[grp] == null) {\r\n          next[grp] = true;\r\n          changed = true;\r\n        }\r\n      });\r\n      return changed ? next : prev;\r\n    });\r\n  }, [defaultCollapsed, permissionsGrouped]);\r\n\r\n  const permissionRowsByGroup = useMemo(() => {\r\n    const out = {};\r\n    Object.entries(permissionsGrouped || {}).forEach(([groupName, perms]) => {\r\n      const map = new Map();\r\n      perms.forEach((perm) => {\r\n        if (!isAdmin && perm.resource === \"page.manage_permissions\") return;\r\n        const resource = String(perm.resource || \"\");\r\n        if (!resource) return;\r\n        if (!map.has(resource)) {\r\n          map.set(resource, {\r\n            resource,\r\n            label: stripActionSuffix(perm.label || resource),\r\n            readKey: `${resource}|read`,\r\n            writeKey: `${resource}|write`,\r\n          });\r\n        }\r\n      });\r\n      const rows = Array.from(map.values());\r\n      // Sort alphabetically using English locale to match UI language\r\n      rows.sort((a, b) => a.label.localeCompare(b.label, \"en\", { sensitivity: \"base\" }));\r\n      out[groupName] = rows;\r\n    });\r\n    return out;\r\n  }, [permissionsGrouped, isAdmin]);\r\n\r\n  if (!permissionsGrouped || Object.keys(permissionsGrouped).length === 0) {\r\n    return <div>No permissions defined.</div>;\r\n  }\r\n\r\n  // Search handler\r\n  const handleSearchChange = (e) => {\r\n    setSearch(e.target.value);\r\n  };\r\n\r\n  const toggleCollapse = (grp) => {\r\n    setCollapsedGroups((prev) => ({ ...prev, [grp]: !prev[grp] }));\r\n  };\r\n\r\n  return (\r\n    <>\r\n      {/* Permission search */}\r\n      <div style={{ marginBottom: 12 }}>\r\n        <input\r\n          className=\"input sm\"\r\n          placeholder=\"Search permissions…\"\r\n          value={search}\r\n          onChange={handleSearchChange}\r\n        />\r\n      </div>\r\n      {Object.entries(permissionsGrouped).map(([grp, perms]) => {\r\n        const rows = permissionRowsByGroup[grp] || [];\r\n        if (rows.length === 0) return null;\r\n        // Filter groupKeys and rows based on search\r\n        const groupKeys = perms\r\n          .filter((perm) => (isAdmin ? true : perm.resource !== \"page.manage_permissions\"))\r\n          .map((perm) => `${perm.resource}|${perm.action}`);\r\n        const selectedCount = groupKeys.filter((k) => permissionSelections[k]).length;\r\n        const allSelected = groupKeys.length > 0 && selectedCount === groupKeys.length;\r\n        const indeterminate = selectedCount > 0 && !allSelected;\r\n        // Filter rows by search\r\n        const filteredRows = rows.filter((row) => {\r\n          if (!search) return true;\r\n          const term = search.trim().toLowerCase();\r\n          return (\r\n            (row.label || \"\").toLowerCase().includes(term) ||\r\n            (row.resource || \"\").toLowerCase().includes(term)\r\n          );\r\n        });\r\n        // Determine collapse state\r\n        const isCollapsed = collapsedGroups[grp];\r\n        return (\r\n          <div key={grp} style={{ marginBottom: 12 }}>\r\n            <div className=\"row\" style={{ alignItems: \"center\", marginBottom: 6 }}>\r\n              <input\r\n                type=\"checkbox\"\r\n                checked={allSelected}\r\n                ref={(el) => {\r\n                  if (el) el.indeterminate = indeterminate;\r\n                }}\r\n                onChange={() => onToggleGroup?.(groupKeys, !allSelected)}\r\n              />\r\n              <div\r\n                style={{ fontWeight: 600, cursor: \"pointer\", display: \"flex\", alignItems: \"center\", gap: 6 }}\r\n                onClick={() => toggleCollapse(grp)}\r\n              >\r\n                {grp}\r\n                <span style={{ fontWeight: 400, fontSize: 12, color: '#6b7280' }}>\r\n                  ({selectedCount}/{groupKeys.length} enabled)\r\n                </span>\r\n                <span style={{ fontSize: 10 }}>\r\n                  {isCollapsed ? \"▶\" : \"▼\"}\r\n                </span>\r\n              </div>\r\n            </div>\r\n            {!isCollapsed && filteredRows.length > 0 && (\r\n              <table className=\"table permissions-table\">\r\n                <thead>\r\n                  <tr>\r\n                    <th>Permission</th>\r\n                    <th style={{ textAlign: \"center\" }}>Read</th>\r\n                    <th style={{ textAlign: \"center\" }}>Write</th>\r\n                    <th>Scope</th>\r\n                  </tr>\r\n                </thead>\r\n                <tbody>\r\n                  {filteredRows.map((row) => {\r\n                    const readSelected = Boolean(permissionSelections[row.readKey]);\r\n                    const writeSelected = Boolean(permissionSelections[row.writeKey]);\r\n                    const scopeVal =\r\n                      permissionScopes[row.writeKey] || permissionScopes[row.readKey] || \"country\";\r\n                    const scopeDisabled = !readSelected && !writeSelected;\r\n                    return (\r\n                      <tr key={row.resource}>\r\n                        <td>\r\n                          <div style={{ fontWeight: 600 }}>{row.label}</div>\r\n                          <div className=\"small\" style={{ color: '#6b7280' }}>{row.resource}</div>\r\n                        </td>\r\n                        <td style={{ textAlign: \"center\" }}>\r\n                          <button\r\n                            type=\"button\"\r\n                            className={`perm-toggle ${readSelected ? \"is-yes\" : \"is-no\"}`}\r\n                            onClick={() => onTogglePermission?.(row.readKey, scopeVal)}\r\n                            aria-pressed={readSelected}\r\n                            title=\"Read\"\r\n                          >\r\n                            {renderPermMark(readSelected)}\r\n                          </button>\r\n                        </td>\r\n                        <td style={{ textAlign: \"center\" }}>\r\n                          <button\r\n                            type=\"button\"\r\n                            className={`perm-toggle ${writeSelected ? \"is-yes\" : \"is-no\"}`}\r\n                            onClick={() => onTogglePermission?.(row.writeKey, scopeVal)}\r\n                            aria-pressed={writeSelected}\r\n                            title=\"Write\"\r\n                          >\r\n                            {renderPermMark(writeSelected)}\r\n                          </button>\r\n                        </td>\r\n                        <td>\r\n                          <select\r\n                            className=\"input sm\"\r\n                            disabled={scopeDisabled}\r\n                            value={scopeVal}\r\n                            onChange={(e) => onScopeChange?.(row.resource, e.target.value)}\r\n                          >\r\n                            <option value=\"country\">{isAdmin ? \"User Country\" : \"Country\"}</option>\r\n                            {userSchools &&\r\n                              userSchools.map((s) => (\r\n                                <option key={s.id} value={`school:${s.id}`}>\r\n                                  {s.name}\r\n                                </option>\r\n                              ))}\r\n                          </select>\r\n                        </td>\r\n                      </tr>\r\n                    );\r\n                  })}\r\n                </tbody>\r\n              </table>\r\n            )}\r\n            {!isCollapsed && filteredRows.length === 0 && (\r\n              <div className=\"small\" style={{ marginLeft: 32 }}>No permissions match your search.</div>\r\n            )}\r\n          </div>\r\n        );\r\n      })}\r\n    </>\r\n  );\r\n}\r\n","import React, { useState } from \"react\";\r\nimport { api } from \"../../api\";\r\nimport { toast } from \"react-toastify\";\r\n\r\n/**\r\n * Modal for creating a new user in the admin context.\r\n *\r\n * Admins can assign a role (User, HR, Principal, Manager, Accountant, Admin)\r\n * and optionally assign the user to a country. A temporary password is\r\n * required. Upon successful creation, the modal will close and the\r\n * provided onCreated callback will be fired to refresh parent state.\r\n *\r\n * Props:\r\n * - show (boolean): whether the modal is visible\r\n * - onClose (function): called when the modal should close\r\n * - onCreated (function): called after a user is successfully created\r\n * - countries (array): list of countries { id, name } for the country selector\r\n */\r\nexport default function AdminCreateUserModal({ show, onClose, onCreated, countries = [] }) {\r\n  const [fullName, setFullName] = useState(\"\");\r\n  const [email, setEmail] = useState(\"\");\r\n  const [password, setPassword] = useState(\"\");\r\n  const [role, setRole] = useState(\"user\");\r\n  const [countryId, setCountryId] = useState(\"\");\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  if (!show) return null;\r\n\r\n  const handleSubmit = async (e) => {\r\n    e.preventDefault();\r\n    const trimmedEmail = email.trim();\r\n    if (!trimmedEmail || !password) {\r\n      toast.error(\"Email and password are required\");\r\n      return;\r\n    }\r\n    if (password.length < 8) {\r\n      toast.error(\"Password must be at least 8 characters\");\r\n      return;\r\n    }\r\n    // Validate role\r\n    const allowedRoles = [\"user\", \"hr\", \"principal\", \"manager\", \"accountant\", \"admin\"];\r\n    if (!allowedRoles.includes(role)) {\r\n      toast.error(\"Invalid role\");\r\n      return;\r\n    }\r\n    setLoading(true);\r\n    try {\r\n      const payload = {\r\n        full_name: fullName ? fullName.trim() : null,\r\n        email: trimmedEmail,\r\n        password,\r\n        role,\r\n      };\r\n      if (countryId && countryId !== \"unassigned\") {\r\n        payload.country_id = Number(countryId);\r\n      }\r\n      await api.createUser(payload);\r\n      toast.success(\"User created\");\r\n      // Reset form fields\r\n      setFullName(\"\");\r\n      setEmail(\"\");\r\n      setPassword(\"\");\r\n      setRole(\"user\");\r\n      setCountryId(\"\");\r\n      onCreated?.();\r\n      onClose?.();\r\n    } catch (err) {\r\n      console.error(err);\r\n      toast.error(err?.message || \"Failed to create user\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"modal-backdrop\" onClick={onClose}>\r\n      <div\r\n        className=\"modal\"\r\n        onClick={(e) => {\r\n          // Prevent backdrop click from closing when clicking inside modal\r\n          e.stopPropagation();\r\n        }}\r\n      >\r\n        <h2 style={{ marginTop: 0, marginBottom: 8 }}>Create User</h2>\r\n        <div className=\"small\" style={{ marginBottom: 12 }}>\r\n          Enter details for the new user. A temporary password must be at least 8 characters.\r\n        </div>\r\n        <form onSubmit={handleSubmit}>\r\n          <div className=\"row\" style={{ gap: 8, flexWrap: \"wrap\", marginBottom: 12 }}>\r\n            <input\r\n              className=\"input full\"\r\n              placeholder=\"Full name\"\r\n              value={fullName}\r\n              onChange={(e) => setFullName(e.target.value)}\r\n            />\r\n            <input\r\n              className=\"input full\"\r\n              placeholder=\"Email\"\r\n              type=\"email\"\r\n              value={email}\r\n              onChange={(e) => setEmail(e.target.value)}\r\n            />\r\n            <input\r\n              className=\"input full\"\r\n              placeholder=\"Temporary password\"\r\n              type=\"password\"\r\n              value={password}\r\n              onChange={(e) => setPassword(e.target.value)}\r\n            />\r\n            <select\r\n              className=\"input full\"\r\n              value={role}\r\n              onChange={(e) => setRole(e.target.value)}\r\n            >\r\n              <option value=\"user\">User</option>\r\n              <option value=\"hr\">HR</option>\r\n              <option value=\"principal\">Principal</option>\r\n              <option value=\"manager\">Manager</option>\r\n              <option value=\"accountant\">Accountant</option>\r\n              <option value=\"admin\">Admin</option>\r\n            </select>\r\n            <select\r\n              className=\"input full\"\r\n              value={countryId}\r\n              onChange={(e) => setCountryId(e.target.value)}\r\n            >\r\n              <option value=\"\">Unassigned</option>\r\n              {countries.map((c) => (\r\n                <option key={c.id} value={c.id}>\r\n                  {c.name}\r\n                </option>\r\n              ))}\r\n            </select>\r\n          </div>\r\n          <div className=\"row\" style={{ justifyContent: \"flex-end\", gap: 8 }}>\r\n            <button type=\"button\" className=\"btn\" onClick={onClose} disabled={loading}>\r\n              Cancel\r\n            </button>\r\n            <button type=\"submit\" className=\"btn primary\" disabled={loading}>\r\n              {loading ? \"Creating...\" : \"Create User\"}\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  );\r\n}","import React, { useState } from \"react\";\r\nimport { api } from \"../../api\";\r\nimport { toast } from \"react-toastify\";\r\n\r\n/**\r\n * Modal for creating a new school within a selected country.\r\n *\r\n * Admins must choose a country to assign the school to. After successful\r\n * creation, the modal closes and the parent can refresh the schools list.\r\n *\r\n * Props:\r\n * - show (boolean): whether the modal is visible\r\n * - onClose (function): called when the modal should close\r\n * - onCreated (function): called after a school is successfully created\r\n * - countries (array): list of countries { id, name }\r\n */\r\nexport default function AdminCreateSchoolModal({ show, onClose, onCreated, countries = [] }) {\r\n  const [countryId, setCountryId] = useState(\"\");\r\n  const [name, setName] = useState(\"\");\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  if (!show) return null;\r\n\r\n  const handleSubmit = async (e) => {\r\n    e.preventDefault();\r\n    const trimmed = name.trim();\r\n    if (!countryId) {\r\n      toast.error(\"Country is required\");\r\n      return;\r\n    }\r\n    if (!trimmed) {\r\n      toast.error(\"School name is required\");\r\n      return;\r\n    }\r\n    setLoading(true);\r\n    try {\r\n      await api.adminCreateCountrySchool(countryId, { name: trimmed });\r\n      toast.success(\"School created\");\r\n      setCountryId(\"\");\r\n      setName(\"\");\r\n      onCreated?.(countryId);\r\n      onClose?.();\r\n    } catch (err) {\r\n      console.error(err);\r\n      toast.error(err?.message || \"Failed to create school\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"modal-backdrop\" onClick={onClose}>\r\n      <div\r\n        className=\"modal\"\r\n        onClick={(e) => {\r\n          e.stopPropagation();\r\n        }}\r\n      >\r\n        <h2 style={{ marginTop: 0, marginBottom: 8 }}>Create School</h2>\r\n        <div className=\"small\" style={{ marginBottom: 12 }}>\r\n          Choose a country and enter the name of the new school.\r\n        </div>\r\n        <form onSubmit={handleSubmit}>\r\n          <div className=\"row\" style={{ gap: 8, flexWrap: \"wrap\", marginBottom: 12 }}>\r\n            <select\r\n              className=\"input full\"\r\n              value={countryId}\r\n              onChange={(e) => setCountryId(e.target.value)}\r\n            >\r\n              <option value=\"\">Select country…</option>\r\n              {countries.map((c) => (\r\n                <option key={c.id} value={c.id}>\r\n                  {c.name}\r\n                </option>\r\n              ))}\r\n            </select>\r\n            <input\r\n              className=\"input full\"\r\n              placeholder=\"School name\"\r\n              value={name}\r\n              onChange={(e) => setName(e.target.value)}\r\n            />\r\n          </div>\r\n          <div className=\"row\" style={{ justifyContent: \"flex-end\", gap: 8 }}>\r\n            <button type=\"button\" className=\"btn\" onClick={onClose} disabled={loading}>\r\n              Cancel\r\n            </button>\r\n            <button type=\"submit\" className=\"btn primary\" disabled={loading}>\r\n              {loading ? \"Creating...\" : \"Create School\"}\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  );\r\n}","import React, { useEffect, useState, useMemo } from \"react\";\r\nimport { api } from \"../../api\";\r\nimport { toast } from \"react-toastify\";\r\n\r\n/**\r\n * Drawer for assigning principals to a school in the admin context.\r\n *\r\n * The drawer slides from the right and allows adding/removing principals\r\n * for the selected school. Candidate principals are filtered by country\r\n * to ensure only principals from the selected country may be assigned.\r\n *\r\n * Props:\r\n * - show: boolean controlling visibility\r\n * - school: the selected school object { id, name }\r\n * - users: array of all users (to derive principals list)\r\n * - countryId: the ID of the currently selected country\r\n * - onClose: callback when the drawer should close\r\n * - onSaved: callback after saving assignments (optional)\r\n */\r\nexport default function AdminSchoolPrincipalsDrawer({ show, school, users = [], countryId, onClose, onSaved }) {\r\n  const [assigned, setAssigned] = useState([]);\r\n  const [initialAssigned, setInitialAssigned] = useState([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [saving, setSaving] = useState(false);\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n\r\n  // Derive list of principal users filtered by country\r\n  const principalUsers = useMemo(\r\n    () => users.filter((u) => u.role === \"principal\" && String(u.country_id) === String(countryId)),\r\n    [users, countryId]\r\n  );\r\n\r\n  // Load existing principals when drawer opens or school changes\r\n  useEffect(() => {\r\n    async function load() {\r\n      if (!show || !school) return;\r\n      setLoading(true);\r\n      try {\r\n        const list = await api.adminGetSchoolPrincipals(school.id);\r\n        const ids = Array.isArray(list) ? list.map((u) => u.id) : [];\r\n        setAssigned(ids);\r\n        setInitialAssigned(ids);\r\n      } catch (err) {\r\n        console.error(err);\r\n        setAssigned([]);\r\n        setInitialAssigned([]);\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    }\r\n    load();\r\n  }, [show, school]);\r\n\r\n  // Filter available principals based on search and not already assigned\r\n  const availablePrincipals = useMemo(() => {\r\n    const term = searchTerm.trim().toLowerCase();\r\n    return principalUsers\r\n      .filter((u) => !assigned.includes(u.id))\r\n      .filter((u) => {\r\n        if (!term) return true;\r\n        const name = (u.full_name || \"\").toLowerCase();\r\n        const email = (u.email || \"\").toLowerCase();\r\n        return name.includes(term) || email.includes(term);\r\n      });\r\n  }, [principalUsers, assigned, searchTerm]);\r\n\r\n  // Determine if assignments have changed. Hook must run before any early return.\r\n  const hasChanges = useMemo(() => {\r\n    if (assigned.length !== initialAssigned.length) return true;\r\n    for (const id of assigned) {\r\n      if (!initialAssigned.includes(id)) return true;\r\n    }\r\n    return false;\r\n  }, [assigned, initialAssigned]);\r\n\r\n  // Early return after hooks are declared\r\n  if (!show || !school) return null;\r\n\r\n  const addPrincipal = (userId) => {\r\n    setAssigned((prev) => (prev.includes(userId) ? prev : [...prev, userId]));\r\n  };\r\n\r\n  const removePrincipal = (userId) => {\r\n    setAssigned((prev) => prev.filter((id) => id !== userId));\r\n  };\r\n\r\n  const handleSave = async () => {\r\n    if (!school) return;\r\n    setSaving(true);\r\n    try {\r\n      await api.adminSetSchoolPrincipals(school.id, { userIds: assigned });\r\n      toast.success(\"Saved\");\r\n      setInitialAssigned(assigned.slice());\r\n      onSaved?.(school.id, assigned);\r\n      onClose?.();\r\n    } catch (err) {\r\n      console.error(err);\r\n      toast.error(err?.message || \"Failed to save principals\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleCancel = () => {\r\n    // Revert to initial assignments and close\r\n    setAssigned(initialAssigned.slice());\r\n    onClose?.();\r\n  };\r\n\r\n  return (\r\n    <div className=\"drawer-backdrop\" onClick={handleCancel}>\r\n      <div\r\n        className=\"drawer\"\r\n        onClick={(e) => {\r\n          // prevent closing on clicks inside drawer\r\n          e.stopPropagation();\r\n        }}\r\n      >\r\n        <div className=\"drawer-header\" style={{ display: \"flex\", justifyContent: \"space-between\", alignItems: \"center\", marginBottom: 12 }}>\r\n          <div style={{ fontWeight: 700 }}>School: {school.name}</div>\r\n          <button className=\"btn\" style={{ border: \"none\", background: \"transparent\", padding: 0 }} onClick={handleCancel}>\r\n            ×\r\n          </button>\r\n        </div>\r\n        {loading ? (\r\n          <div>Loading principals...</div>\r\n        ) : principalUsers.length === 0 ? (\r\n          <div>No principals found in this country. Create a principal user first, then assign them to schools.</div>\r\n        ) : (\r\n          <>\r\n            {/* Assigned principals */}\r\n            <div style={{ marginBottom: 12 }}>\r\n              <div style={{ fontWeight: 600, marginBottom: 6 }}>Assigned principals</div>\r\n              {assigned.length === 0 ? (\r\n                <div className=\"small\">No principals assigned to this school yet.</div>\r\n              ) : (\r\n                <div className=\"row\" style={{ gap: 6, flexWrap: \"wrap\" }}>\r\n                  {assigned.map((id) => {\r\n                    const u = users.find((x) => String(x.id) === String(id));\r\n                    const label = u ? u.full_name || u.email || u.id : id;\r\n                    return (\r\n                      <div key={id} className=\"chip\">\r\n                        <span>{label}</span>\r\n                        <button\r\n                          type=\"button\"\r\n                          className=\"chip-remove\"\r\n                          onClick={() => removePrincipal(id)}\r\n                          aria-label=\"Remove principal\"\r\n                        >\r\n                          ×\r\n                        </button>\r\n                      </div>\r\n                    );\r\n                  })}\r\n                </div>\r\n              )}\r\n            </div>\r\n            {/* Add principal search */}\r\n            <div style={{ marginBottom: 12 }}>\r\n              <div style={{ fontWeight: 600, marginBottom: 6 }}>Add principal</div>\r\n              <input\r\n                className=\"input full\"\r\n                placeholder=\"Find a principal…\"\r\n                value={searchTerm}\r\n                onChange={(e) => setSearchTerm(e.target.value)}\r\n                style={{ marginBottom: 6 }}\r\n              />\r\n              <div style={{ maxHeight: 200, overflowY: \"auto\" }}>\r\n                {availablePrincipals.length === 0 ? (\r\n                  <div className=\"small\">No principals available</div>\r\n                ) : (\r\n                  availablePrincipals.map((u) => {\r\n                    const label = u.full_name || u.email || u.id;\r\n                    return (\r\n                      <div\r\n                        key={u.id}\r\n                        className=\"access-list-item\"\r\n                        style={{ cursor: \"pointer\" }}\r\n                        onClick={() => addPrincipal(u.id)}\r\n                      >\r\n                        <div>{label}</div>\r\n                      </div>\r\n                    );\r\n                  })\r\n                )}\r\n              </div>\r\n            </div>\r\n            {/* Drawer footer */}\r\n            <div style={{ display: \"flex\", justifyContent: \"flex-end\", gap: 8 }}>\r\n              <button className=\"btn\" onClick={handleCancel} disabled={saving}>\r\n                Cancel\r\n              </button>\r\n              <button className=\"btn primary\" onClick={handleSave} disabled={saving || !hasChanges}>\r\n                {saving ? \"Saving...\" : \"Save\"}\r\n              </button>\r\n            </div>\r\n          </>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}","import React, { useEffect, useState, useMemo, useCallback, useRef } from \"react\";\r\nimport { api } from \"../api\";\nimport { useAdminUsers, useListCountries } from \"../hooks/useListQueries\";\nimport { toast } from \"react-toastify\";\r\nimport { useOutletContext } from \"react-router-dom\";\r\nimport PermissionsTable from \"../components/permissions/PermissionsTable\";\r\nimport AdminCreateUserModal from \"../components/access/AdminCreateUserModal\";\r\nimport AdminCreateSchoolModal from \"../components/access/AdminCreateSchoolModal\";\r\nimport AdminSchoolPrincipalsDrawer from \"../components/access/AdminSchoolPrincipalsDrawer\";\r\n\r\nconst CAPABILITY_DEFS = [\r\n  { key: \"managePermissions\", label: \"Manage Permissions\", resources: [\"page.manage_permissions\"] },\r\n  { key: \"createUser\", label: \"Create User\", resources: [\"user.create\"] },\r\n  { key: \"createSchool\", label: \"Create School\", resources: [\"school.create\"] },\r\n  {\r\n    key: \"scenarioActions\",\r\n    label: \"Scenario Actions\",\r\n    resources: [\r\n      \"scenario.create\",\r\n      \"scenario.plan_edit\",\r\n      \"scenario.copy\",\r\n      \"scenario.submit\",\r\n      \"scenario.delete\",\r\n    ],\r\n  },\r\n];\r\nconst CAPABILITY_RESOURCES = CAPABILITY_DEFS.flatMap((def) => def.resources);\r\nconst CAPABILITY_RESOURCE_SET = new Set(CAPABILITY_RESOURCES);\r\n\r\nfunction dedupePermissions(list) {\r\n  const map = new Map();\r\n  (Array.isArray(list) ? list : []).forEach((perm) => {\r\n    const key = [\r\n      perm.resource,\r\n      perm.action,\r\n      perm.scope_country_id ?? \"\",\r\n      perm.scope_school_id ?? \"\",\r\n    ].join(\"|\");\r\n    map.set(key, perm);\r\n  });\r\n  return Array.from(map.values());\r\n}\r\n\r\nfunction hasScopedWritePermission(perms, resource, countryId) {\r\n  if (!Array.isArray(perms)) return false;\r\n  return perms.some((perm) => {\r\n    if (perm.resource !== resource || perm.action !== \"write\") return false;\r\n    if (perm.scope_school_id != null) return false;\r\n    if (perm.scope_country_id == null) return true;\r\n    return Number(perm.scope_country_id) === Number(countryId);\r\n  });\r\n}\r\n\r\nfunction buildCapabilityState(perms, countryId) {\r\n  const state = {};\r\n  CAPABILITY_DEFS.forEach((def) => {\r\n    state[def.key] = def.resources.every((resource) =>\r\n      hasScopedWritePermission(perms, resource, countryId)\r\n    );\r\n  });\r\n  return state;\r\n}\r\n\r\n/**\r\n * AdminPermissionsPage renders the Access Management hub for administrators.\r\n * Administrators can manage users across all countries, assign countries and\r\n * roles, edit permissions scoped to country or schools, create users and\r\n * schools, and assign principals to schools via a drawer.  The UI is built\r\n * with a two‑pane layout and tabs for Users & Permissions and Schools &\r\n * Principals.  All UI text is English.\r\n */\r\nexport default function AdminPermissionsPage() {\r\n  const outlet = useOutletContext();\r\n  // Countries list used for filters and selectors\r\n  const [countries, setCountries] = useState([]);\r\n  // countriesLoading is unused; removed to avoid ESLint warning\r\n  // Users data and filters\n  const [users, setUsers] = useState([]);\n  const usersQuery = useAdminUsers({\n    limit: 50,\n    offset: 0,\n    fields: \"brief\",\n    order: \"full_name:asc\",\n  });\n  const usersLoading = usersQuery.isFetching;\n  const [searchUser, setSearchUser] = useState(\"\");\r\n  const [roleFilter, setRoleFilter] = useState(\"all\");\r\n  const [countryFilter, setCountryFilter] = useState(\"all\");\r\n  const [showUnassignedOnly, setShowUnassignedOnly] = useState(false);\r\n  const [selectedUserId, setSelectedUserId] = useState(null);\r\n  // Selected user metadata and snapshots\r\n  const [selectedUserRole, setSelectedUserRole] = useState(null);\r\n  const [selectedUserCountryId, setSelectedUserCountryId] = useState(\"\");\r\n  const [initialRole, setInitialRole] = useState(null);\r\n  const [initialCountryId, setInitialCountryId] = useState(\"\");\r\n  const [permissionSelections, setPermissionSelections] = useState({});\r\n  const [permissionScopes, setPermissionScopes] = useState({});\r\n  const [initialSelections, setInitialSelections] = useState({});\r\n  const [initialScopes, setInitialScopes] = useState({});\r\n  const [permissionsCatalog, setPermissionsCatalog] = useState(null);\r\n  const [permissionsLoading, setPermissionsLoading] = useState(false);\r\n  const [userSchools, setUserSchools] = useState([]);\r\n  const [saving, setSaving] = useState(false);\r\n  // Tab state: 'countries', 'users', or 'schools'\r\n  const [activeTab, setActiveTab] = useState(\"countries\");\r\n  // Countries tab state\r\n  const [selectedCountryIdForDrawer, setSelectedCountryIdForDrawer] = useState(null);\r\n  const [selectedAccountantId, setSelectedAccountantId] = useState(\"\");\r\n  const [assignAccountantUserId, setAssignAccountantUserId] = useState(\"\");\r\n  const [permissionsByUserId, setPermissionsByUserId] = useState({});\r\n  const [permissionsLoadingByUserId, setPermissionsLoadingByUserId] = useState({});\r\n  const permissionsByUserIdRef = useRef({});\r\n  const permissionsLoadingByUserIdRef = useRef({});\r\n  const [capabilityDraft, setCapabilityDraft] = useState(null);\r\n  const [capabilitySnapshot, setCapabilitySnapshot] = useState(null);\r\n  const [capabilitySaving, setCapabilitySaving] = useState(false);\r\n  // Create modals\r\n  const [showCreateUser, setShowCreateUser] = useState(false);\r\n  const [showCreateSchool, setShowCreateSchool] = useState(false);\r\n  // Schools tab state\r\n  const [selectedCountryId, setSelectedCountryId] = useState(\"\");\r\n  const [schools, setSchools] = useState([]);\r\n  const [searchSchool, setSearchSchool] = useState(\"\");\r\n  const [selectedSchoolId, setSelectedSchoolId] = useState(null);\n\n  const countriesQuery = useListCountries();\n\r\n  // Set header meta on mount/unmount\r\n  useEffect(() => {\r\n    outlet?.setHeaderMeta?.({\r\n      title: \"Access Management\",\r\n      subtitle: \"Manage users, permissions, and principal assignments\",\r\n      centered: true,\r\n    });\r\n    return () => {\r\n      outlet?.clearHeaderMeta?.();\r\n    };\r\n  }, [outlet]);\r\n\r\n  // Load list of countries\n  const loadCountries = useCallback(async () => {\n    const result = await countriesQuery.refetch();\n    if (result?.error) {\n      console.error(result.error);\n      toast.error(result.error?.message || \"Failed to load countries\");\n    }\n  }, [countriesQuery]);\n\n  // Load list of users\n  const loadUsers = useCallback(async () => {\n    const result = await usersQuery.refetch();\n    if (result?.error) {\n      console.error(result.error);\n      toast.error(result.error?.message || \"Failed to load users\");\n    }\n  }, [usersQuery]);\n\n  useEffect(() => {\n    const rows = countriesQuery.data;\n    setCountries(Array.isArray(rows) ? rows : []);\n  }, [countriesQuery.data]);\n\n  useEffect(() => {\n    const rows = usersQuery.data?.items;\n    setUsers(Array.isArray(rows) ? rows : []);\n  }, [usersQuery.data]);\n\n  useEffect(() => {\n    if (!countriesQuery.isError) return;\n    console.error(countriesQuery.error);\n    toast.error(countriesQuery.error?.message || \"Failed to load countries\");\n  }, [countriesQuery.isError, countriesQuery.error]);\n\n  useEffect(() => {\n    if (!usersQuery.isError) return;\n    console.error(usersQuery.error);\n    toast.error(usersQuery.error?.message || \"Failed to load users\");\n  }, [usersQuery.isError, usersQuery.error]);\n\r\n  // Load schools for selected country in Schools tab\r\n  const loadSchoolsForCountry = useCallback(async (countryId) => {\r\n    const cid = Number(countryId);\r\n    if (!Number.isFinite(cid)) {\r\n      setSchools([]);\r\n      return;\r\n    }\r\n    try {\r\n      const rows = await api.adminListCountrySchools(cid);\r\n      if (Array.isArray(rows)) {\r\n        setSchools(rows);\r\n      } else if (rows && Array.isArray(rows.items)) {\r\n        setSchools(rows.items);\r\n      } else {\r\n        setSchools([]);\r\n      }\r\n    } catch (err) {\r\n      console.error(err);\r\n      toast.error(err?.message || \"Failed to load schools\");\r\n      setSchools([]);\r\n    }\r\n  }, []);\r\n\r\n  // Load permissions catalog, user permissions, and country schools for selected user\r\n  const loadPermissionsForUser = useCallback(async (user) => {\r\n    if (!user) {\r\n      // Reset state when no user is selected\r\n      setPermissionsCatalog(null);\r\n      setPermissionSelections({});\r\n      setPermissionScopes({});\r\n      setUserSchools([]);\r\n      setSelectedUserRole(null);\r\n      setSelectedUserCountryId(\"\");\r\n      setInitialRole(null);\r\n      setInitialCountryId(\"\");\r\n      setInitialSelections({});\r\n      setInitialScopes({});\r\n      return;\r\n    }\r\n    setPermissionsLoading(true);\r\n    try {\r\n      const schoolsPromise =\r\n        user.country_id != null ? api.adminListCountrySchools(user.country_id) : Promise.resolve([]);\r\n      const [catalogData, userPerms, schoolRows] = await Promise.all([\r\n        api.adminGetPermissionsCatalog(),\r\n        api.adminGetUserPermissions(user.id),\r\n        schoolsPromise,\r\n      ]);\r\n      setPermissionsCatalog(catalogData || null);\r\n      let schoolsList = [];\r\n      if (Array.isArray(schoolRows)) {\r\n        schoolsList = schoolRows;\r\n      } else if (schoolRows && Array.isArray(schoolRows.items)) {\r\n        schoolsList = schoolRows.items;\r\n      }\r\n      setUserSchools(schoolsList);\r\n      const sel = {};\r\n      const scopes = {};\r\n      (userPerms || []).forEach((p) => {\r\n        const key = `${p.resource}|${p.action}`;\r\n        sel[key] = true;\r\n        if (p.scope_school_id != null) {\r\n          scopes[key] = `school:${p.scope_school_id}`;\r\n        } else {\r\n          scopes[key] = \"country\";\r\n        }\r\n      });\r\n      setPermissionSelections(sel);\r\n      setPermissionScopes(scopes);\r\n      setSelectedUserRole(user.role || null);\r\n      setSelectedUserCountryId(user.country_id != null ? String(user.country_id) : \"\");\r\n      setInitialRole(user.role || null);\r\n      setInitialCountryId(user.country_id != null ? String(user.country_id) : \"\");\r\n      setInitialSelections(sel);\r\n      setInitialScopes(scopes);\r\n    } catch (err) {\r\n      console.error(err);\r\n      toast.error(err?.message || \"Failed to load permissions\");\r\n    } finally {\r\n      setPermissionsLoading(false);\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    permissionsByUserIdRef.current = permissionsByUserId;\r\n  }, [permissionsByUserId]);\r\n\r\n  useEffect(() => {\r\n    permissionsLoadingByUserIdRef.current = permissionsLoadingByUserId;\r\n  }, [permissionsLoadingByUserId]);\r\n\r\n  // When selected user or users list changes: load their permissions\r\n  useEffect(() => {\r\n    const user = users.find((u) => String(u.id) === String(selectedUserId));\r\n    loadPermissionsForUser(user);\r\n  }, [selectedUserId, users, loadPermissionsForUser]);\r\n\r\n  // When selectedCountryId changes in Schools tab: load schools\r\n  useEffect(() => {\r\n    if (activeTab !== \"schools\") return;\r\n    loadSchoolsForCountry(selectedCountryId);\r\n  }, [activeTab, selectedCountryId, loadSchoolsForCountry]);\r\n\r\n  const accountantUsers = useMemo(\r\n    () => users.filter((u) => String(u.role) === \"accountant\"),\r\n    [users]\r\n  );\r\n\r\n  const accountantsByCountry = useMemo(() => {\r\n    const map = {};\r\n    accountantUsers.forEach((user) => {\r\n      const key = user.country_id != null ? String(user.country_id) : \"\";\r\n      if (!map[key]) map[key] = [];\r\n      map[key].push(user);\r\n    });\r\n    Object.values(map).forEach((list) => {\r\n      list.sort((a, b) => {\r\n        const nameA = (a.full_name || a.email || \"\").toLowerCase();\r\n        const nameB = (b.full_name || b.email || \"\").toLowerCase();\r\n        return nameA.localeCompare(nameB);\r\n      });\r\n    });\r\n    return map;\r\n  }, [accountantUsers]);\r\n\r\n  const ensureUserPermissions = useCallback(async (userId) => {\r\n    if (!userId) return [];\r\n    const cached = permissionsByUserIdRef.current[userId];\r\n    if (cached) return cached;\r\n    setPermissionsLoadingByUserId((prev) => ({ ...prev, [userId]: true }));\r\n    try {\r\n      const perms = await api.adminGetUserPermissions(userId);\r\n      const normalized = Array.isArray(perms) ? perms : [];\r\n      setPermissionsByUserId((prev) => ({ ...prev, [userId]: normalized }));\r\n      return normalized;\r\n    } catch (err) {\r\n      console.error(err);\r\n      toast.error(err?.message || \"Failed to load accountant permissions\");\r\n      return [];\r\n    } finally {\r\n      setPermissionsLoadingByUserId((prev) => {\r\n        const next = { ...prev };\r\n        delete next[userId];\r\n        return next;\r\n      });\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (activeTab !== \"countries\") return;\r\n    if (accountantUsers.length === 0) return;\r\n    const toFetch = accountantUsers.filter(\r\n      (user) =>\r\n        !permissionsByUserIdRef.current[user.id] &&\r\n        !permissionsLoadingByUserIdRef.current[user.id]\r\n    );\r\n    if (toFetch.length === 0) return;\r\n    setPermissionsLoadingByUserId((prev) => {\r\n      const next = { ...prev };\r\n      toFetch.forEach((user) => {\r\n        next[user.id] = true;\r\n      });\r\n      return next;\r\n    });\r\n    Promise.allSettled(toFetch.map((user) => api.adminGetUserPermissions(user.id)))\r\n      .then((results) => {\r\n        let hadError = false;\r\n        setPermissionsByUserId((prev) => {\r\n          const next = { ...prev };\r\n          results.forEach((result, index) => {\r\n            const userId = toFetch[index]?.id;\r\n            if (!userId) return;\r\n            if (result.status === \"fulfilled\") {\r\n              next[userId] = Array.isArray(result.value) ? result.value : [];\r\n            } else {\r\n              hadError = true;\r\n            }\r\n          });\r\n          return next;\r\n        });\r\n        if (hadError) {\r\n          toast.error(\"Failed to load some accountant permissions\");\r\n        }\r\n      })\r\n      .finally(() => {\r\n        setPermissionsLoadingByUserId((prev) => {\r\n          const next = { ...prev };\r\n          toFetch.forEach((user) => {\r\n            delete next[user.id];\r\n          });\r\n          return next;\r\n        });\r\n      });\r\n  }, [activeTab, accountantUsers]);\r\n\r\n  const selectedCountryForDrawer = useMemo(\r\n    () =>\r\n      countries.find((country) => String(country.id) === String(selectedCountryIdForDrawer)) ||\r\n      null,\r\n    [countries, selectedCountryIdForDrawer]\r\n  );\r\n\r\n  const drawerAccountants = useMemo(() => {\r\n    if (!selectedCountryForDrawer) return [];\r\n    return accountantsByCountry[String(selectedCountryForDrawer.id)] || [];\r\n  }, [accountantsByCountry, selectedCountryForDrawer]);\r\n\r\n  const assignableAccountants = useMemo(() => {\r\n    if (!selectedCountryForDrawer) return [];\r\n    return users.filter((user) => {\r\n      if (String(user.role) === \"admin\") return false;\r\n      if (user.country_id == null) return true;\r\n      return Number(user.country_id) === Number(selectedCountryForDrawer.id);\r\n    });\r\n  }, [selectedCountryForDrawer, users]);\r\n\r\n  useEffect(() => {\r\n    if (!selectedCountryForDrawer) {\r\n      setSelectedAccountantId(\"\");\r\n      setAssignAccountantUserId(\"\");\r\n      setCapabilityDraft(null);\r\n      setCapabilitySnapshot(null);\r\n      return;\r\n    }\r\n    if (drawerAccountants.length === 0) {\r\n      setSelectedAccountantId(\"\");\r\n      setCapabilityDraft(null);\r\n      setCapabilitySnapshot(null);\r\n      return;\r\n    }\r\n    const hasSelected = drawerAccountants.some(\r\n      (user) => String(user.id) === String(selectedAccountantId)\r\n    );\r\n    if (!hasSelected) {\r\n      setSelectedAccountantId(String(drawerAccountants[0].id));\r\n    }\r\n  }, [drawerAccountants, selectedAccountantId, selectedCountryForDrawer]);\r\n\r\n  useEffect(() => {\r\n    let isActive = true;\r\n    const load = async () => {\r\n      if (!selectedCountryForDrawer || !selectedAccountantId) {\r\n        setCapabilityDraft(null);\r\n        setCapabilitySnapshot(null);\r\n        return;\r\n      }\r\n      const userId = Number(selectedAccountantId);\r\n      if (!Number.isFinite(userId)) return;\r\n      const perms = await ensureUserPermissions(userId);\r\n      if (!isActive) return;\r\n      const caps = buildCapabilityState(perms, selectedCountryForDrawer.id);\r\n      setCapabilityDraft(caps);\r\n      setCapabilitySnapshot(caps);\r\n    };\r\n    load();\r\n    return () => {\r\n      isActive = false;\r\n    };\r\n  }, [ensureUserPermissions, selectedAccountantId, selectedCountryForDrawer]);\r\n\r\n  // Helper to group permissions by group name\r\n  const permissionsGrouped = useMemo(() => {\r\n    if (!permissionsCatalog) return {};\r\n    if (typeof permissionsCatalog === \"object\" && !Array.isArray(permissionsCatalog)) {\r\n      return permissionsCatalog;\r\n    }\r\n    if (Array.isArray(permissionsCatalog)) {\r\n      return permissionsCatalog.reduce((acc, perm) => {\r\n        const grp = perm.group || \"Other\";\r\n        if (!acc[grp]) acc[grp] = [];\r\n        acc[grp].push(perm);\r\n        return acc;\r\n      }, {});\r\n    }\r\n    return {};\r\n  }, [permissionsCatalog]);\r\n\r\n  /**\r\n   * Toggle a permission (read or write) while enforcing dependency rules.\r\n   * Write implies read. Disabling read will disable write. Scopes default to \"country\".\r\n   */\r\n  const togglePermission = useCallback(\r\n    (key, scopeValue = \"country\") => {\r\n      if (!key) return;\r\n      const [resource, action] = key.split(\"|\");\r\n      const readKey = `${resource}|read`;\r\n      const writeKey = `${resource}|write`;\r\n      const newSelections = { ...permissionSelections };\r\n      const newScopes = { ...permissionScopes };\r\n      const currentVal = !!permissionSelections[key];\r\n      const enable = !currentVal;\r\n      if (action === \"write\") {\r\n        if (enable) {\r\n          newSelections[writeKey] = true;\r\n          newSelections[readKey] = true;\r\n          if (!newScopes[writeKey]) newScopes[writeKey] = scopeValue || \"country\";\r\n          if (!newScopes[readKey]) newScopes[readKey] = scopeValue || \"country\";\r\n        } else {\r\n          // disabling write only\r\n          newSelections[writeKey] = false;\r\n          delete newScopes[writeKey];\r\n        }\r\n      } else {\r\n        // toggling read\r\n        if (enable) {\r\n          newSelections[readKey] = true;\r\n          if (!newScopes[readKey]) newScopes[readKey] = scopeValue || \"country\";\r\n        } else {\r\n          // disabling read removes both read and write\r\n          newSelections[readKey] = false;\r\n          newSelections[writeKey] = false;\r\n          delete newScopes[readKey];\r\n          delete newScopes[writeKey];\r\n        }\r\n      }\r\n      setPermissionSelections(newSelections);\r\n      setPermissionScopes(newScopes);\r\n    },\r\n    [permissionSelections, permissionScopes]\r\n  );\r\n\r\n  /**\r\n   * Toggle an entire group of permissions on or off. Delegates to togglePermission\r\n   * for each individual key to ensure dependency rules are enforced.\r\n   */\r\n  const togglePermissionGroup = useCallback(\r\n    (groupKeys, nextValue) => {\r\n      if (!Array.isArray(groupKeys) || groupKeys.length === 0) return;\r\n      groupKeys.forEach((k) => {\r\n        const cur = !!permissionSelections[k];\r\n        if (cur !== nextValue) {\r\n          togglePermission(k, \"country\");\r\n        }\r\n      });\r\n    },\r\n    [permissionSelections, togglePermission]\r\n  );\r\n\r\n  /**\r\n   * Change the scope for a given resource across both read and write actions.\r\n   */\r\n  function changePermissionScopeForResource(resource, value) {\r\n    const readKey = `${resource}|read`;\r\n    const writeKey = `${resource}|write`;\r\n    setPermissionScopes((prev) => {\r\n      const next = { ...prev };\r\n      if (permissionSelections[readKey]) next[readKey] = value;\r\n      if (permissionSelections[writeKey]) next[writeKey] = value;\r\n      return next;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Determine if there are unsaved changes relative to the initial snapshot.\r\n   */\r\n  const hasUnsavedChanges = useMemo(() => {\r\n    if (selectedUserId == null) return false;\r\n    if (selectedUserRole !== initialRole) return true;\r\n    if ((selectedUserCountryId || \"\") !== (initialCountryId || \"\")) return true;\r\n    const allKeys = new Set([\r\n      ...Object.keys(initialSelections || {}),\r\n      ...Object.keys(permissionSelections || {}),\r\n    ]);\r\n    for (const k of allKeys) {\r\n      const curSel = !!permissionSelections[k];\r\n      const initSel = !!initialSelections[k];\r\n      if (curSel !== initSel) return true;\r\n      const curScope = permissionScopes[k] || null;\r\n      const initScope = initialScopes[k] || null;\r\n      if (curScope !== initScope) return true;\r\n    }\r\n    return false;\r\n  }, [\r\n    selectedUserId,\r\n    selectedUserRole,\r\n    selectedUserCountryId,\r\n    initialRole,\r\n    initialCountryId,\r\n    permissionSelections,\r\n    permissionScopes,\r\n    initialSelections,\r\n    initialScopes,\r\n  ]);\r\n\r\n  /**\r\n   * Save changes for the selected user. Writes country, role and permissions to the server.\r\n   */\r\n  async function saveChanges() {\r\n    const user = users.find((u) => String(u.id) === String(selectedUserId));\r\n    if (!user) {\r\n      toast.error(\"Select a user\");\r\n      return;\r\n    }\r\n    const countryChanged = (selectedUserCountryId || \"\") !== (initialCountryId || \"\");\r\n    const roleChanged = selectedUserRole !== initialRole;\r\n    // Determine if permissions changed\r\n    let permissionsChanged = false;\r\n    const keysUnion = new Set([\r\n      ...Object.keys(initialSelections || {}),\r\n      ...Object.keys(permissionSelections || {}),\r\n    ]);\r\n    for (const k of keysUnion) {\r\n      const curSel = !!permissionSelections[k];\r\n      const initSel = !!initialSelections[k];\r\n      if (curSel !== initSel) {\r\n        permissionsChanged = true;\r\n        break;\r\n      }\r\n      const curScope = permissionScopes[k] || null;\r\n      const initScope = initialScopes[k] || null;\r\n      if (curScope !== initScope) {\r\n        permissionsChanged = true;\r\n        break;\r\n      }\r\n    }\r\n    let perms = [];\r\n    if (permissionsChanged) {\r\n      const scopeCountryId = selectedUserCountryId && selectedUserCountryId !== \"\" ? Number(selectedUserCountryId) : null;\r\n      perms = [];\r\n      Object.keys(permissionSelections || {}).forEach((k) => {\r\n        if (!permissionSelections[k]) return;\r\n        const [resource, action] = k.split(\"|\");\r\n        let scopeVal = permissionScopes[k] || \"country\";\r\n        let scope_country_id = null;\r\n        let scope_school_id = null;\r\n        if (scopeVal === \"country\") {\r\n          scope_country_id = scopeCountryId;\r\n        } else if (scopeVal.startsWith(\"school:\")) {\r\n          const sidStr = scopeVal.split(\":\")[1];\r\n          const sid = Number(sidStr);\r\n          if (Number.isFinite(sid)) {\r\n            scope_school_id = sid;\r\n          }\r\n          scope_country_id = scopeCountryId;\r\n        }\r\n        perms.push({ resource, action, scope_country_id, scope_school_id });\r\n      });\r\n    }\r\n    setSaving(true);\r\n    try {\r\n      if (countryChanged) {\r\n        const cid = selectedUserCountryId ? Number(selectedUserCountryId) : null;\r\n        await api.assignUserCountry(user.id, { country_id: cid });\r\n      }\r\n      if (roleChanged) {\r\n        await api.adminUpdateUserRole(user.id, { role: selectedUserRole });\r\n      }\r\n      if (permissionsChanged) {\r\n        await api.adminSetUserPermissions(user.id, { permissions: perms });\r\n      }\r\n      toast.success(\"Saved\");\r\n      // Reload users to update country/role badges\r\n      await loadUsers();\r\n      // Reload permissions for the selected user using updated data\r\n      await loadPermissionsForUser({\r\n        id: user.id,\r\n        role: selectedUserRole,\r\n        country_id: selectedUserCountryId ? Number(selectedUserCountryId) : null,\r\n      });\r\n      // Reset snapshot states\r\n      setInitialRole(selectedUserRole);\r\n      setInitialCountryId(selectedUserCountryId || \"\");\r\n      setInitialSelections({ ...permissionSelections });\r\n      setInitialScopes({ ...permissionScopes });\r\n    } catch (err) {\r\n      console.error(err);\r\n      toast.error(err?.message || \"Save failed\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Discard unsaved changes by restoring selections, scopes, role and country from snapshots.\r\n   */\r\n  function discardChanges() {\r\n    setPermissionSelections({ ...initialSelections });\r\n    setPermissionScopes({ ...initialScopes });\r\n    setSelectedUserRole(initialRole);\r\n    setSelectedUserCountryId(initialCountryId || \"\");\r\n  }\r\n\r\n  // Filter users list based on search, role, country and showUnassignedOnly\r\n  const filteredUsers = useMemo(() => {\r\n    let list = users;\r\n    if (roleFilter && roleFilter !== \"all\") {\r\n      list = list.filter((u) => u.role === roleFilter);\r\n    }\r\n    if (showUnassignedOnly) {\r\n      list = list.filter((u) => u.country_id == null);\r\n    }\r\n    if (countryFilter && countryFilter !== \"all\") {\r\n      if (countryFilter === \"unassigned\") {\r\n        list = list.filter((u) => u.country_id == null);\r\n      } else {\r\n        list = list.filter((u) => String(u.country_id) === String(countryFilter));\r\n      }\r\n    }\r\n    const term = searchUser.trim().toLowerCase();\r\n    if (term) {\r\n      list = list.filter((u) => {\r\n        const name = (u.full_name || \"\").toLowerCase();\r\n        const email = (u.email || \"\").toLowerCase();\r\n        return name.includes(term) || email.includes(term);\r\n      });\r\n    }\r\n    return list;\r\n  }, [users, roleFilter, countryFilter, searchUser, showUnassignedOnly]);\r\n\r\n  // Filter schools list based on search term\r\n  const filteredSchools = useMemo(() => {\r\n    if (!Array.isArray(schools)) return [];\r\n    const term = searchSchool.trim().toLowerCase();\r\n    if (!term) return schools;\r\n    return schools.filter((s) => {\r\n      const name = (s.name || \"\").toLowerCase();\r\n      return name.includes(term);\r\n    });\r\n  }, [schools, searchSchool]);\r\n\r\n  const capabilityDirty = useMemo(() => {\r\n    if (!capabilityDraft || !capabilitySnapshot) return false;\r\n    return CAPABILITY_DEFS.some(\r\n      (def) => capabilityDraft[def.key] !== capabilitySnapshot[def.key]\r\n    );\r\n  }, [capabilityDraft, capabilitySnapshot]);\r\n\r\n  const getUserLabel = useCallback(\r\n    (user) => user?.full_name || user?.email || user?.id || \"Unknown\",\r\n    []\r\n  );\r\n\r\n  const handleAssignAccountant = async () => {\r\n    if (!selectedCountryForDrawer || !assignAccountantUserId) return;\r\n    const userId = Number(assignAccountantUserId);\r\n    if (!Number.isFinite(userId)) return;\r\n    setCapabilitySaving(true);\r\n    try {\r\n      const selectedUser = users.find((u) => String(u.id) === String(userId));\r\n      if (!selectedUser) {\r\n        toast.error(\"User not found\");\r\n        return;\r\n      }\r\n      if (selectedUser.country_id == null || Number(selectedUser.country_id) !== Number(selectedCountryForDrawer.id)) {\r\n        await api.assignUserCountry(userId, { country_id: selectedCountryForDrawer.id });\r\n      }\r\n      await api.adminUpdateUserRole(userId, { role: \"accountant\" });\r\n      toast.success(\"Accountant assigned\");\r\n      setPermissionsByUserId((prev) => {\r\n        const next = { ...prev };\r\n        delete next[userId];\r\n        return next;\r\n      });\r\n      await loadUsers();\r\n      setAssignAccountantUserId(\"\");\r\n      setSelectedAccountantId(String(userId));\r\n    } catch (err) {\r\n      console.error(err);\r\n      toast.error(err?.message || \"Failed to assign accountant\");\r\n    } finally {\r\n      setCapabilitySaving(false);\r\n    }\r\n  };\r\n\r\n  const handleToggleCapability = (key) => {\r\n    setCapabilityDraft((prev) => ({ ...prev, [key]: !prev?.[key] }));\r\n  };\r\n\r\n  const handleDiscardCapabilities = () => {\r\n    setCapabilityDraft(capabilitySnapshot);\r\n  };\r\n\r\n  const handleSaveCapabilities = async () => {\r\n    if (!selectedCountryForDrawer || !selectedAccountantId) return;\r\n    const userId = Number(selectedAccountantId);\r\n    if (!Number.isFinite(userId)) return;\r\n    setCapabilitySaving(true);\r\n    try {\r\n      const basePerms = permissionsByUserIdRef.current[userId] || (await ensureUserPermissions(userId));\r\n      let nextPerms = (Array.isArray(basePerms) ? basePerms : []).filter(\r\n        (perm) => !CAPABILITY_RESOURCE_SET.has(perm.resource)\r\n      );\r\n      CAPABILITY_DEFS.forEach((def) => {\r\n        if (!capabilityDraft?.[def.key]) return;\r\n        def.resources.forEach((resource) => {\r\n          nextPerms.push({\r\n            resource,\r\n            action: \"read\",\r\n            scope_country_id: Number(selectedCountryForDrawer.id),\r\n            scope_school_id: null,\r\n          });\r\n          nextPerms.push({\r\n            resource,\r\n            action: \"write\",\r\n            scope_country_id: Number(selectedCountryForDrawer.id),\r\n            scope_school_id: null,\r\n          });\r\n        });\r\n      });\r\n      nextPerms = dedupePermissions(nextPerms);\r\n      await api.adminSetUserPermissions(userId, { permissions: nextPerms });\r\n      setPermissionsByUserId((prev) => ({ ...prev, [userId]: nextPerms }));\r\n      setCapabilitySnapshot(capabilityDraft);\r\n      toast.success(\"Accountant permissions updated\");\r\n    } catch (err) {\r\n      console.error(err);\r\n      toast.error(err?.message || \"Failed to update permissions\");\r\n    } finally {\r\n      setCapabilitySaving(false);\r\n    }\r\n  };\r\n\r\n  const handleOpenFullEditor = () => {\r\n    if (!selectedAccountantId) return;\r\n    setActiveTab(\"users\");\r\n    setSelectedUserId(String(selectedAccountantId));\r\n    setSelectedCountryIdForDrawer(null);\r\n  };\r\n\r\n  return (\r\n    <div className=\"permissions-page\">\r\n      <div className=\"container permissions-page-content\" style={{ padding: \"1rem\" }}>\r\n        {/* Top bar with tabs and actions */}\r\n        <div className=\"row\" style={{ justifyContent: \"space-between\", alignItems: \"center\" }}>\r\n          <div className=\"access-hub-tabs\">\r\n            <div\r\n              className={`access-hub-tab ${activeTab === \"countries\" ? \"is-active\" : \"\"}`}\r\n              onClick={() => {\r\n                setActiveTab(\"countries\");\r\n                setSelectedUserId(null);\r\n                setSelectedSchoolId(null);\r\n              }}\r\n            >\r\n              Countries & Accountants\r\n            </div>\r\n            <div\r\n              className={`access-hub-tab ${activeTab === \"users\" ? \"is-active\" : \"\"}`}\r\n              onClick={() => {\r\n                setActiveTab(\"users\");\r\n                setSelectedSchoolId(null);\r\n                setSelectedCountryIdForDrawer(null);\r\n              }}\r\n            >\r\n              Users & Permissions\r\n            </div>\r\n            <div\r\n              className={`access-hub-tab ${activeTab === \"schools\" ? \"is-active\" : \"\"}`}\r\n              onClick={() => {\r\n                setActiveTab(\"schools\");\r\n                setSelectedUserId(null);\r\n                setSelectedCountryIdForDrawer(null);\r\n              }}\r\n            >\r\n              Schools & Principals\r\n            </div>\r\n          </div>\r\n            <div className=\"row\" style={{ gap: 8 }}>\r\n              <button className=\"btn primary\" onClick={() => setShowCreateUser(true)}>\r\n                Create user\r\n              </button>\r\n              <button className=\"btn primary\" onClick={() => setShowCreateSchool(true)}>\r\n                Create school\r\n              </button>\r\n            </div>\r\n          </div>\r\n          {activeTab === \"countries\" && (\r\n            <>\r\n              <div\r\n                className={`school-assignments-overlay ${\r\n                  selectedCountryForDrawer ? \"is-open\" : \"\"\r\n                }`}\r\n                onClick={() => setSelectedCountryIdForDrawer(null)}\r\n                role=\"button\"\r\n                aria-label=\"Close country drawer\"\r\n                tabIndex={-1}\r\n              />\r\n              <aside\r\n                className={`school-assignments-drawer ${\r\n                  selectedCountryForDrawer ? \"is-open\" : \"\"\r\n                }`}\r\n              >\r\n                <div className=\"school-assignments-drawer-header\">\r\n                  <div>\r\n                    <div className=\"school-assignments-drawer-title\">Country accountants</div>\r\n                    <div className=\"school-assignments-drawer-subtitle\">\r\n                      {selectedCountryForDrawer\r\n                        ? `${selectedCountryForDrawer.name} ${selectedCountryForDrawer.code ? `(${selectedCountryForDrawer.code})` : \"\"}`\r\n                        : \"Select a country\"}\r\n                    </div>\r\n                  </div>\r\n                  <button\r\n                    className=\"btn school-assignments-close\"\r\n                    onClick={() => setSelectedCountryIdForDrawer(null)}\r\n                    aria-label=\"Close drawer\"\r\n                    type=\"button\"\r\n                  >\r\n                  x\r\n                  </button>\r\n                </div>\r\n                <div className=\"school-assignments-drawer-body\">\r\n                  {!selectedCountryForDrawer ? (\r\n                    <div className=\"school-assignments-empty\">Select a country to manage accountants.</div>\r\n                  ) : (\r\n                    <>\r\n                      <div className=\"school-assignments-section-title\">Assigned accountant</div>\r\n                      {drawerAccountants.length === 0 ? (\r\n                        <div className=\"school-assignments-add-card\">\r\n                          <div className=\"row\" style={{ flexDirection: \"column\", gap: 8 }}>\r\n                            <select\r\n                              className=\"input full\"\r\n                              value={assignAccountantUserId}\r\n                              onChange={(e) => setAssignAccountantUserId(e.target.value)}\r\n                            >\r\n                              <option value=\"\">Select user...</option>\r\n                              {assignableAccountants.map((user) => (\r\n                                <option key={user.id} value={user.id}>\r\n                                  {getUserLabel(user)}\r\n                                </option>\r\n                              ))}\r\n                            </select>\r\n                            <button\r\n                              className=\"btn primary\"\r\n                              onClick={handleAssignAccountant}\r\n                              disabled={!assignAccountantUserId || capabilitySaving}\r\n                            >\r\n                              {capabilitySaving ? \"Assigning...\" : \"Set as Accountant\"}\r\n                            </button>\r\n                            {assignableAccountants.length === 0 && (\r\n                              <div className=\"small\">No eligible users available.</div>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      ) : (\r\n                        <div className=\"school-assignments-add-card\">\r\n                          {drawerAccountants.length > 1 ? (\r\n                            <select\r\n                              className=\"input full\"\r\n                              value={selectedAccountantId}\r\n                              onChange={(e) => setSelectedAccountantId(e.target.value)}\r\n                            >\r\n                              {drawerAccountants.map((user) => (\r\n                                <option key={user.id} value={user.id}>\r\n                                  {getUserLabel(user)}\r\n                                </option>\r\n                              ))}\r\n                            </select>\r\n                          ) : (\r\n                            <div style={{ fontWeight: 600 }}>\r\n                              {getUserLabel(drawerAccountants[0])}\r\n                            </div>\r\n                          )}\r\n                          {drawerAccountants.length > 1 && (\r\n                            <div className=\"small\" style={{ marginTop: 6 }}>\r\n                              Multiple accountants assigned. Select one to edit.\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                      )}\r\n\r\n                      <div className=\"school-assignments-section-title\">Accountant capabilities</div>\r\n                      {!selectedAccountantId ? (\r\n                        <div className=\"school-assignments-empty\">\r\n                          Assign an accountant to edit capabilities.\r\n                        </div>\r\n                      ) : (\r\n                        <div className=\"school-assignments-card\">\r\n                          {CAPABILITY_DEFS.map((def) => (\r\n                            <label key={def.key} className=\"school-assignments-module-item\">\r\n                              <input\r\n                                type=\"checkbox\"\r\n                                checked={Boolean(capabilityDraft?.[def.key])}\r\n                                onChange={() => handleToggleCapability(def.key)}\r\n                                disabled={capabilitySaving}\r\n                              />\r\n                              <span>{def.label}</span>\r\n                            </label>\r\n                          ))}\r\n                          <div\r\n                            className=\"row\"\r\n                            style={{ justifyContent: \"flex-end\", gap: 8, marginTop: 12 }}\r\n                          >\r\n                            <button\r\n                              className=\"btn\"\r\n                              onClick={handleDiscardCapabilities}\r\n                              disabled={!capabilityDirty || capabilitySaving}\r\n                            >\r\n                              Discard\r\n                            </button>\r\n                            <button\r\n                              className=\"btn primary\"\r\n                              onClick={handleSaveCapabilities}\r\n                              disabled={!capabilityDirty || capabilitySaving}\r\n                            >\r\n                              {capabilitySaving ? \"Saving...\" : \"Save\"}\r\n                            </button>\r\n                          </div>\r\n                        </div>\r\n                      )}\r\n\r\n                      {selectedAccountantId && (\r\n                        <button\r\n                          className=\"btn\"\r\n                          onClick={handleOpenFullEditor}\r\n                          style={{ marginTop: 12 }}\r\n                        >\r\n                          Open full permission editor\r\n                        </button>\r\n                      )}\r\n                    </>\r\n                  )}\r\n                </div>\r\n              </aside>\r\n            </>\r\n          )}\r\n        {/* Tab content */}\r\n        {activeTab === \"countries\" && (\r\n          <div style={{ marginTop: 16 }}>\r\n            <div style={{ fontWeight: 700, marginBottom: 12 }}>Countries</div>\r\n            <div className=\"row\" style={{ gap: 6, marginBottom: 12, flexWrap: \"wrap\" }}>\r\n              <span className=\"role-tag is-ok\">Enabled</span>\r\n              <span className=\"role-tag is-warn\">Disabled / No accountant</span>\r\n              <span className=\"role-tag is-muted\">Loading / Unknown</span>\r\n            </div>\r\n            <div className=\"school-assignments-table-wrap\">\r\n              <table className=\"table school-assignments-table\">\r\n                <thead>\r\n                  <tr>\r\n                    <th>Country</th>\r\n                    <th>Accountant status</th>\r\n                    <th>Capabilities</th>\r\n                  </tr>\r\n                </thead>\r\n                <tbody>\r\n                  {countries.length === 0 ? (\r\n                    <tr>\r\n                      <td colSpan={3}>No countries available.</td>\r\n                    </tr>\r\n                  ) : (\r\n                    countries.map((country) => {\r\n                      const accountants = accountantsByCountry[String(country.id)] || [];\r\n                      const primaryAccountant = accountants[0] || null;\r\n                      const hasMultiple = accountants.length > 1;\r\n                      const statusLabel =\r\n                        accountants.length === 0\r\n                          ? \"No accountant\"\r\n                          : accountants.length === 1\r\n                            ? `1 accountant: ${getUserLabel(primaryAccountant)}`\r\n                            : `Multiple accountants: ${accountants.length}`;\r\n                      const perms = primaryAccountant\r\n                        ? permissionsByUserId[primaryAccountant.id]\r\n                        : null;\r\n                      const capabilities = perms\r\n                        ? buildCapabilityState(perms, country.id)\r\n                        : null;\r\n                      const isPermsLoading =\r\n                        primaryAccountant &&\r\n                        Boolean(permissionsLoadingByUserId[primaryAccountant.id]);\r\n                      return (\r\n                        <tr\r\n                          key={country.id}\r\n                          style={{ cursor: \"pointer\" }}\r\n                          onClick={() => setSelectedCountryIdForDrawer(String(country.id))}\r\n                        >\r\n                          <td>\r\n                            <div style={{ fontWeight: 600 }}>\r\n                              {country.name}\r\n                              {country.code ? ` (${country.code})` : \"\"}\r\n                            </div>\r\n                          </td>\r\n                          <td>\r\n                            <div style={{ display: \"flex\", alignItems: \"center\", gap: 8 }}>\r\n                              <span\r\n                                className={`role-tag ${\r\n                                  accountants.length === 1 ? \"is-ok\" : \"is-warn\"\r\n                                }`}\r\n                              >\r\n                                {statusLabel}\r\n                              </span>\r\n                              {hasMultiple && <span className=\"role-tag is-warn\">Needs review</span>}\r\n                            </div>\r\n                          </td>\r\n                          <td>\r\n                            <div className=\"row\" style={{ gap: 6 }}>\r\n                              {CAPABILITY_DEFS.map((def) => {\r\n                                const enabled = capabilities?.[def.key];\r\n                                const label = def.label;\r\n                                let status = \"Unknown\";\r\n                                let badgeClass = \"role-tag is-muted\";\r\n                                if (accountants.length === 0) {\r\n                                  status = \"No accountant\";\r\n                                  badgeClass = \"role-tag is-warn\";\r\n                                } else if (isPermsLoading) {\r\n                                  status = \"Loading\";\r\n                                  badgeClass = \"role-tag is-muted\";\r\n                                } else if (!capabilities) {\r\n                                  status = \"Unknown\";\r\n                                  badgeClass = \"role-tag is-muted\";\r\n                                } else if (enabled) {\r\n                                  status = \"Enabled\";\r\n                                  badgeClass = \"role-tag is-ok\";\r\n                                } else {\r\n                                  status = \"Disabled\";\r\n                                  badgeClass = \"role-tag is-warn\";\r\n                                }\r\n                                return (\r\n                                  <span\r\n                                    key={def.key}\r\n                                    className={badgeClass}\r\n                                  >\r\n                                    {label}: {status}\r\n                                  </span>\r\n                                );\r\n                              })}\r\n                            </div>\r\n                          </td>\r\n                        </tr>\r\n                      );\r\n                    })\r\n                  )}\r\n                </tbody>\r\n              </table>\r\n            </div>\r\n          </div>\r\n        )}\r\n        {activeTab === \"users\" && (\r\n          <div className=\"access-hub-grid\" style={{ marginTop: 16 }}>\r\n            {/* Left pane: user list and filters */}\r\n            <div className=\"left-pane\">\r\n              <div style={{ marginBottom: 12, fontWeight: 700 }}>Users</div>\r\n              <div className=\"row\" style={{ flexDirection: \"column\", gap: 8 }}>\r\n                <input\r\n                  className=\"input full\"\r\n                  placeholder=\"Search users by name or email…\"\r\n                  value={searchUser}\r\n                  onChange={(e) => setSearchUser(e.target.value)}\r\n                />\r\n                <select\r\n                  className=\"input full\"\r\n                  value={roleFilter}\r\n                  onChange={(e) => setRoleFilter(e.target.value)}\r\n                >\r\n                  <option value=\"all\">All roles</option>\r\n                  <option value=\"user\">User</option>\r\n                  <option value=\"hr\">HR</option>\r\n                  <option value=\"principal\">Principal</option>\r\n                  <option value=\"manager\">Manager</option>\r\n                  <option value=\"accountant\">Accountant</option>\r\n                  <option value=\"admin\">Admin</option>\r\n                </select>\r\n                <select\r\n                  className=\"input full\"\r\n                  value={countryFilter}\r\n                  onChange={(e) => setCountryFilter(e.target.value)}\r\n                >\r\n                  <option value=\"all\">All countries</option>\r\n                  {countries.map((c) => (\r\n                    <option key={c.id} value={String(c.id)}>\r\n                      {c.name}\r\n                    </option>\r\n                  ))}\r\n                  <option value=\"unassigned\">Unassigned</option>\r\n                </select>\r\n                <label style={{ display: \"flex\", alignItems: \"center\", gap: 6 }}>\r\n                  <input\r\n                    type=\"checkbox\"\r\n                    checked={showUnassignedOnly}\r\n                    onChange={(e) => setShowUnassignedOnly(e.target.checked)}\r\n                  />\r\n                  <span className=\"small\">Show unassigned only</span>\r\n                </label>\r\n              </div>\r\n              <div style={{ marginTop: 12 }}>\r\n                {usersLoading ? (\r\n                  <div>Loading users…</div>\r\n                ) : filteredUsers.length === 0 ? (\r\n                  <div>No users yet. Create a user to start assigning permissions.</div>\r\n                ) : (\r\n                  filteredUsers.map((u) => {\r\n                    const isSelected = String(u.id) === String(selectedUserId);\r\n                    const name = u.full_name || u.email || u.id;\r\n                    const email = u.email || \"\";\r\n                    const roleLabel =\r\n                      u.role?.charAt(0).toUpperCase() + u.role?.slice(1) || \"\";\r\n                    const countryLabel = u.country_name || \"Unassigned\";\r\n                    return (\r\n                      <div\r\n                        key={u.id}\r\n                        className={`access-list-item ${isSelected ? \"is-selected\" : \"\"}`}\r\n                        onClick={() => setSelectedUserId(String(u.id))}\r\n                      >\r\n                        <div style={{ display: \"flex\", flexDirection: \"column\" }}>\r\n                          <div style={{ fontWeight: 600 }}>{name}</div>\r\n                          <div className=\"small\" style={{ color: \"#6b7280\" }}>\r\n                            {email}\r\n                          </div>\r\n                        </div>\r\n                        <div style={{ display: \"flex\", alignItems: \"center\", gap: 6 }}>\r\n                          <span className=\"role-tag\">{roleLabel}</span>\r\n                          <span className=\"role-tag\">{countryLabel}</span>\r\n                        </div>\r\n                      </div>\r\n                    );\r\n                  })\r\n                )}\r\n              </div>\r\n            </div>\r\n            {/* Right pane: user editor */}\r\n            <div className=\"right-pane\">\r\n              {!selectedUserId ? (\r\n                <div style={{ padding: 16 }}>Select a user from the list to edit role and permissions.</div>\r\n              ) : permissionsLoading ? (\r\n                <div>Loading permissions…</div>\r\n              ) : (\r\n                <>\r\n                  {/* User details */}\r\n                  <div className=\"card\" style={{ marginBottom: 16 }}>\r\n                    <div style={{ fontWeight: 700, marginBottom: 8 }}>User details</div>\r\n                    {(() => {\r\n                      const u = users.find((x) => String(x.id) === String(selectedUserId));\r\n                      if (!u) return null;\r\n                      const name = u.full_name || u.email || u.id;\r\n                      return (\r\n                        <>\r\n                          <div style={{ marginBottom: 8 }}>\r\n                            <div style={{ fontWeight: 600 }}>{name}</div>\r\n                            <div className=\"small\" style={{ color: \"#6b7280\" }}>\r\n                              {u.email}\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"row\" style={{ gap: 8, marginBottom: 8 }}>\r\n                            <div style={{ flex: 1 }}>\r\n                              <label className=\"small\" style={{ display: \"block\", marginBottom: 4 }}>\r\n                                Role\r\n                              </label>\r\n                              <select\r\n                                className=\"input full\"\r\n                                value={selectedUserRole || \"user\"}\r\n                                onChange={(e) => setSelectedUserRole(e.target.value)}\r\n                              >\r\n                                <option value=\"user\">User</option>\r\n                                <option value=\"hr\">HR</option>\r\n                                <option value=\"principal\">Principal</option>\r\n                                <option value=\"manager\">Manager</option>\r\n                                <option value=\"accountant\">Accountant</option>\r\n                                <option value=\"admin\">Admin</option>\r\n                              </select>\r\n                            </div>\r\n                            <div style={{ flex: 1 }}>\r\n                              <label className=\"small\" style={{ display: \"block\", marginBottom: 4 }}>\r\n                                Country\r\n                              </label>\r\n                              <select\r\n                                className=\"input full\"\r\n                                value={selectedUserCountryId}\r\n                                onChange={(e) => setSelectedUserCountryId(e.target.value)}\r\n                              >\r\n                                <option value=\"\">Unassigned</option>\r\n                                {countries.map((c) => (\r\n                                  <option key={c.id} value={String(c.id)}>\r\n                                    {c.name}\r\n                                  </option>\r\n                                ))}\r\n                              </select>\r\n                              {selectedUserCountryId === \"\" && (\r\n                                <div className=\"small\" style={{ color: \"#ef4444\", marginTop: 4 }}>\r\n                                  Assign a country to edit scoped permissions.\r\n                                </div>\r\n                              )}\r\n                            </div>\r\n                          </div>\r\n                        </>\r\n                      );\r\n                    })()}\r\n                  </div>\r\n                  {/* Permissions section */}\r\n                  <div className=\"card\">\r\n                    <div style={{ fontWeight: 700, marginBottom: 8 }}>Permissions</div>\r\n                    {!selectedUserCountryId ? (\r\n                      <div>Assign a country to edit scoped permissions.</div>\r\n                    ) : (\r\n                      <PermissionsTable\r\n                        permissionsGrouped={permissionsGrouped}\r\n                        permissionSelections={permissionSelections}\r\n                        permissionScopes={permissionScopes}\r\n                        userSchools={userSchools}\r\n                        isAdmin\r\n                        onTogglePermission={togglePermission}\r\n                        onToggleGroup={togglePermissionGroup}\r\n                        onScopeChange={changePermissionScopeForResource}\r\n                      />\r\n                    )}\r\n                  </div>\r\n                </>\r\n              )}\r\n            </div>\r\n          </div>\r\n        )}\r\n        {activeTab === \"schools\" && (\r\n          <div className=\"access-hub-grid\" style={{ marginTop: 16 }}>\r\n            {/* Left pane: country selector and schools list */}\r\n            <div className=\"left-pane\">\r\n              <div style={{ marginBottom: 12, fontWeight: 700 }}>Schools</div>\r\n              <div className=\"row\" style={{ flexDirection: \"column\", gap: 8 }}>\r\n                <select\r\n                  className=\"input full\"\r\n                  value={selectedCountryId}\r\n                  onChange={(e) => setSelectedCountryId(e.target.value)}\r\n                >\r\n                  <option value=\"\">Select country…</option>\r\n                  {countries.map((c) => (\r\n                    <option key={c.id} value={String(c.id)}>\r\n                      {c.name}\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n                <input\r\n                  className=\"input full\"\r\n                  placeholder=\"Search schools…\"\r\n                  value={searchSchool}\r\n                  onChange={(e) => setSearchSchool(e.target.value)}\r\n                  disabled={!selectedCountryId}\r\n                />\r\n              </div>\r\n              <div style={{ marginTop: 12 }}>\r\n                {!selectedCountryId ? (\r\n                  <div>Select a country to view schools and assign principals.</div>\r\n                ) : schools.length === 0 ? (\r\n                  <div>No schools in this country yet. Create a school to assign principals.</div>\r\n                ) : filteredSchools.length === 0 ? (\r\n                  <div>No schools match your search.</div>\r\n                ) : (\r\n                  filteredSchools.map((s) => {\r\n                    const isSelected = String(s.id) === String(selectedSchoolId);\r\n                    return (\r\n                      <div\r\n                        key={s.id}\r\n                        className={`access-list-item ${isSelected ? \"is-selected\" : \"\"}`}\r\n                        onClick={() => setSelectedSchoolId(String(s.id))}\r\n                      >\r\n                        <div>{s.name}</div>\r\n                      </div>\r\n                    );\r\n                  })\r\n                )}\r\n              </div>\r\n            </div>\r\n            {/* Right pane: placeholder for instructional text */}\r\n            <div className=\"right-pane\">\r\n              {!selectedSchoolId && (\r\n                <div style={{ padding: 16 }}>Select a school to manage principal assignments.</div>\r\n              )}\r\n            </div>\r\n            {selectedSchoolId && (\r\n              <AdminSchoolPrincipalsDrawer\r\n                show={!!selectedSchoolId}\r\n                school={schools.find((s) => String(s.id) === String(selectedSchoolId))}\r\n                users={users}\r\n                countryId={selectedCountryId}\r\n                onClose={() => setSelectedSchoolId(null)}\r\n                onSaved={async (schoolId, assigned) => {\r\n                  // No extra actions needed after saving assignments\r\n                }}\r\n              />\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n      {/* Unsaved changes action bar */}\r\n      {activeTab === \"users\" && selectedUserId && hasUnsavedChanges && (\r\n        <div className=\"permissions-sticky-footer\">\r\n          <div className=\"permissions-sticky-footer-inner\">\r\n            <div className=\"permissions-footer-actions\">\r\n              <button className=\"btn\" onClick={discardChanges} disabled={saving || permissionsLoading}>\r\n                Discard\r\n              </button>\r\n              <button\r\n                className=\"btn primary\"\r\n                onClick={saveChanges}\r\n                disabled={saving || permissionsLoading}\r\n              >\r\n                {saving ? \"Saving…\" : \"Save changes\"}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n      {/* Modals */}\r\n      {showCreateUser && (\r\n        <AdminCreateUserModal\r\n          show={showCreateUser}\r\n          onClose={() => setShowCreateUser(false)}\r\n          onCreated={() => {\r\n            loadUsers();\r\n            // When creating a new user, also reload countries in case a new country was added elsewhere\r\n            loadCountries();\r\n          }}\r\n          countries={countries}\r\n        />\r\n      )}\r\n      {showCreateSchool && (\r\n        <AdminCreateSchoolModal\r\n          show={showCreateSchool}\r\n          onClose={() => setShowCreateSchool(false)}\r\n          onCreated={(countryId) => {\r\n            // If the new school belongs to the current country in Schools tab, reload schools\r\n            if (String(countryId) === String(selectedCountryId)) {\r\n              loadSchoolsForCountry(countryId);\r\n            }\r\n            // Refresh list regardless\r\n            loadCountries();\r\n          }}\r\n          countries={countries}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","import { useQuery } from \"@tanstack/react-query\";\nimport { api } from \"../api\";\n\nconst DEFAULT_QUERY_OPTIONS = {\n  staleTime: 60_000,\n};\n\nexport function useListCountries(options = {}) {\n  return useQuery({\n    queryKey: [\"countries\"],\n    queryFn: () => api.listCountries(),\n    ...DEFAULT_QUERY_OPTIONS,\n    ...options,\n  });\n}\n\nexport function useListSchools(params = {}, options = {}) {\n  return useQuery({\n    queryKey: [\"schools\", params],\n    queryFn: () => api.listSchools(params),\n    ...DEFAULT_QUERY_OPTIONS,\n    ...options,\n  });\n}\n\nexport function useAdminUsers(params = {}, options = {}) {\n  return useQuery({\n    queryKey: [\"adminUsers\", params],\n    queryFn: () => api.listUsers(params),\n    ...DEFAULT_QUERY_OPTIONS,\n    ...options,\n  });\n}\n\nexport function useManagerUsers(params = {}, options = {}) {\n  return useQuery({\n    queryKey: [\"managerUsers\", params],\n    queryFn: () => api.managerListUsers(params),\n    ...DEFAULT_QUERY_OPTIONS,\n    ...options,\n  });\n}\r\n"],"names":["renderPermMark","enabled","_jsx","className","concat","children","viewBox","d","PermissionsTable","_ref","permissionsGrouped","permissionSelections","permissionScopes","userSchools","isAdmin","onTogglePermission","onToggleGroup","onScopeChange","defaultCollapsed","search","setSearch","useState","collapsedGroups","setCollapsedGroups","groupKeys","Object","keys","length","reduce","acc","grp","useEffect","prev","changed","next","_objectSpread","forEach","permissionRowsByGroup","useMemo","out","entries","_ref2","groupName","perms","map","Map","perm","resource","String","label","has","set","replace","readKey","writeKey","rows","Array","from","values","sort","a","b","localeCompare","sensitivity","_jsxs","_Fragment","style","marginBottom","placeholder","value","onChange","e","target","_ref3","filter","action","selectedCount","k","allSelected","indeterminate","filteredRows","row","term","trim","toLowerCase","includes","isCollapsed","alignItems","type","checked","ref","el","fontWeight","cursor","display","gap","onClick","toggleCollapse","fontSize","color","textAlign","readSelected","Boolean","writeSelected","scopeVal","scopeDisabled","title","disabled","s","id","name","marginLeft","AdminCreateUserModal","show","onClose","onCreated","countries","fullName","setFullName","email","setEmail","password","setPassword","role","setRole","countryId","setCountryId","loading","setLoading","stopPropagation","marginTop","onSubmit","async","preventDefault","trimmedEmail","toast","error","payload","full_name","country_id","Number","api","createUser","success","err","console","message","flexWrap","c","justifyContent","AdminCreateSchoolModal","setName","trimmed","adminCreateCountrySchool","AdminSchoolPrincipalsDrawer","school","users","onSaved","assigned","setAssigned","initialAssigned","setInitialAssigned","saving","setSaving","searchTerm","setSearchTerm","principalUsers","u","list","adminGetSchoolPrincipals","ids","isArray","load","availablePrincipals","hasChanges","handleCancel","slice","border","background","padding","find","x","removePrincipal","userId","maxHeight","overflowY","addPrincipal","adminSetSchoolPrincipals","userIds","CAPABILITY_DEFS","key","resources","CAPABILITY_RESOURCES","flatMap","def","CAPABILITY_RESOURCE_SET","Set","buildCapabilityState","state","every","some","scope_school_id","scope_country_id","hasScopedWritePermission","AdminPermissionsPage","outlet","useOutletContext","setCountries","setUsers","usersQuery","useAdminUsers","limit","offset","fields","order","usersLoading","isFetching","searchUser","setSearchUser","roleFilter","setRoleFilter","countryFilter","setCountryFilter","showUnassignedOnly","setShowUnassignedOnly","selectedUserId","setSelectedUserId","selectedUserRole","setSelectedUserRole","selectedUserCountryId","setSelectedUserCountryId","initialRole","setInitialRole","initialCountryId","setInitialCountryId","setPermissionSelections","setPermissionScopes","initialSelections","setInitialSelections","initialScopes","setInitialScopes","permissionsCatalog","setPermissionsCatalog","permissionsLoading","setPermissionsLoading","setUserSchools","activeTab","setActiveTab","selectedCountryIdForDrawer","setSelectedCountryIdForDrawer","selectedAccountantId","setSelectedAccountantId","assignAccountantUserId","setAssignAccountantUserId","permissionsByUserId","setPermissionsByUserId","permissionsLoadingByUserId","setPermissionsLoadingByUserId","permissionsByUserIdRef","useRef","permissionsLoadingByUserIdRef","capabilityDraft","setCapabilityDraft","capabilitySnapshot","setCapabilitySnapshot","capabilitySaving","setCapabilitySaving","showCreateUser","setShowCreateUser","showCreateSchool","setShowCreateSchool","selectedCountryId","setSelectedCountryId","schools","setSchools","searchSchool","setSearchSchool","selectedSchoolId","setSelectedSchoolId","countriesQuery","useListCountries","_outlet$setHeaderMeta","setHeaderMeta","call","subtitle","centered","_outlet$clearHeaderMe","clearHeaderMeta","loadCountries","useCallback","result","refetch","_result$error","loadUsers","_result$error2","data","_usersQuery$data","items","_countriesQuery$error","isError","_usersQuery$error","loadSchoolsForCountry","cid","isFinite","adminListCountrySchools","loadPermissionsForUser","user","schoolsPromise","Promise","resolve","catalogData","userPerms","schoolRows","all","adminGetPermissionsCatalog","adminGetUserPermissions","schoolsList","sel","scopes","p","current","accountantUsers","accountantsByCountry","push","nameA","nameB","ensureUserPermissions","cached","normalized","toFetch","allSettled","then","results","hadError","index","_toFetch$index","status","finally","selectedCountryForDrawer","country","drawerAccountants","assignableAccountants","isActive","caps","group","togglePermission","scopeValue","arguments","undefined","split","newSelections","newScopes","enable","togglePermissionGroup","nextValue","hasUnsavedChanges","allKeys","filteredUsers","filteredSchools","capabilityDirty","getUserLabel","tabIndex","code","flexDirection","selectedUser","assignUserCountry","adminUpdateUserRole","handleToggleCapability","handleDiscardCapabilities","basePerms","nextPerms","_perm$scope_country_i","_perm$scope_school_id","join","dedupePermissions","adminSetUserPermissions","permissions","handleOpenFullEditor","colSpan","accountants","primaryAccountant","hasMultiple","statusLabel","capabilities","isPermsLoading","badgeClass","_u$role","_u$role2","isSelected","roleLabel","charAt","toUpperCase","countryLabel","country_name","flex","schoolId","countryChanged","roleChanged","permissionsChanged","keysUnion","scopeCountryId","startsWith","sidStr","sid","DEFAULT_QUERY_OPTIONS","staleTime","options","useQuery","queryKey","queryFn","listCountries","useListSchools","params","listSchools","listUsers","useManagerUsers","managerListUsers"],"ignoreList":[],"sourceRoot":""}