{"version":3,"file":"static/js/693.ae8825b8.chunk.js","mappings":"2JAQA,MAAMA,EAAiB,cAEvB,SAASC,EAASC,EAAKC,GACrB,IACE,MAAMC,EAAMC,OAAOC,aAAaC,QAAQL,GACxC,OAAW,MAAPE,EAAoBD,EACjBK,KAAKC,MAAML,EACpB,CAAE,MAAAM,GACA,OAAOP,CACT,CACF,CA0BO,SAASQ,EAAmBC,EAAMC,GAAwD,IAA1C,OAAEC,EAASd,EAAc,MAAEe,GAAOC,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,CAAC,EAC3F,MAAMG,EAjBD,WAAsE,IAAzCL,EAAME,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAGhB,EAAgBoB,EAAaJ,UAAAC,OAAA,EAAAD,UAAA,QAAAE,EACxE,MAAMG,GAAMC,EAAAA,EAAAA,MACZ,OAAOC,EAAAA,EAAAA,SAAQ,KACb,MACMR,GADoC,kBAAlBK,EAA6BA,EAAcI,OAAS,KACjDH,EAAII,UAAYJ,EAAIK,QAAU,IACzD,OAAOZ,EAAS,IAAMC,GACrB,CAACD,EAAQM,EAAeC,EAAII,SAAUJ,EAAIK,QAC/C,CAUmBC,CAAoBb,EAAQC,GACvCa,GAAaL,EAAAA,EAAAA,SAAQ,OAAAM,OAASV,EAAQ,QAAAU,OAAOjB,GAAQ,CAACO,EAAUP,IAEhEkB,GAAeC,EAAAA,EAAAA,QAAO,OAErBC,EAAOC,IAAYC,EAAAA,EAAAA,UAAS,IAAMjC,EAAS2B,EAAYf,IAe9D,OAZAsB,EAAAA,EAAAA,WAAU,KACRL,EAAaM,QAAUR,EACvBK,EAAShC,EAAS2B,EAAYf,KAE7B,CAACe,KAGJO,EAAAA,EAAAA,WAAU,KACJL,EAAaM,UAAYR,GAzCjC,SAAmB1B,EAAKmC,GACtB,IACEhC,OAAOC,aAAagC,QAAQpC,EAAKM,KAAK+B,UAAUF,GAClD,CAAE,MAAAG,GACA,CAEJ,CAoCIC,CAAUb,EAAYI,IACrB,CAACJ,EAAYI,IAET,CAACA,EAAOC,EAAUL,EAC3B,CAEO,SAASc,EAAkB9B,GAAmC,IAA7BC,EAAYG,UAAAC,OAAA,QAAAC,IAAAF,UAAA,IAAAA,UAAA,GAAU2B,EAAI3B,UAAAC,OAAA,EAAAD,UAAA,QAAAE,EAChE,MAAO0B,EAAGC,GAAQlC,EAAmBC,IAAQC,EAAc8B,GAE3D,MAAO,GAAGC,EADOE,GAASD,KAAwB,oBAATC,EAAsBA,EAAKF,GAAKE,IAE3E,CAEO,SAASC,EAAoBnC,GAAgC,IAA1BC,EAAYG,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,GAAI2B,EAAI3B,UAAAC,OAAA,EAAAD,UAAA,QAAAE,EAC/D,MAAO0B,EAAGC,GAAQlC,EAAmBC,EAAMoC,OAAmB,OAAZnC,QAAY,IAAZA,EAAAA,EAAgB,IAAK8B,GAEvE,MAAO,CAACK,OAAQ,OAADJ,QAAC,IAADA,EAAAA,EAAK,IADJE,GAASD,EAAKG,OAAuB,oBAATF,EAAsBA,EAAKF,GAAKE,IAE9E,C,oJCvCO,SAASG,IAAkE,IAA1C,OAAEC,EAAM,KAAEC,EAAI,OAAEC,EAAM,SAAEC,GAAUrC,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,CAAC,EAC5E,MAAMsC,GAAUC,EAAAA,EAAAA,IAAqB,CAAEL,SAAQC,OAAME,aAC/CG,EAvBR,SAAyBJ,GACvB,MAAMK,GAAWC,EAAAA,EAAAA,MACXC,EAAQP,GAA4B,kBAAXA,EAAsBA,EAAS,CAAC,EACzDQ,EAAgBD,EAAME,UAAsC,kBAAnBF,EAAME,SAAwBF,EAAME,SAAW,CAAC,EACzFC,EAAM,CAAEC,QAASN,EAASM,QAASF,SAAU,CAAC,GAcpD,OAZAG,OAAOC,KAAKR,EAASI,UAAUK,QAASC,IACtC,MAAMC,EAAOX,EAASI,SAASM,IAAO,CAAC,EACjCE,EAAWT,EAAcO,IAAoC,kBAAtBP,EAAcO,GAAmBP,EAAcO,GAAM,CAAC,EACnGL,EAAID,SAASM,GAAM,CACjBG,QAAqC,mBAArBD,EAASC,QAAwBD,EAASC,SAA2B,IAAjBF,EAAKE,QACzEC,KAA+B,kBAAlBF,EAASE,MAAqBF,EAASE,KAAOF,EAASE,KAAOH,EAAKG,KAChFC,IAAqB,MAAhBH,EAASG,IAAcC,OAAOJ,EAASG,KAAOJ,EAAKI,IACxDE,eACEL,EAASK,gBAAqD,kBAA5BL,EAASK,eAA8BL,EAASK,eAAiB,CAAC,KAInGZ,CACT,CAI2Ba,CAAgBvB,GACnCwB,GAAOC,EAAAA,EAAAA,GAAsB3B,GAC7B4B,EAAmB,IAAIC,IAAI,CAAC,KAAM,WAAY,aAE9CC,EAAe,IAAIC,IAAI3B,EAAQO,SAASqB,IAAKC,GAAM,CAACA,EAAEhB,GAAIgB,KAC1DC,EAAiB,IAAIH,IAC3B,IAAII,EAAa,EACbC,EAAY,EACZC,EAAoB,EACpBC,EAAmB,EAEvBlC,EAAQO,SAASK,QAASuB,IAAa,IAADC,EACpC,MAAMC,EAAMnC,EAAiBK,SAAS4B,EAAQtB,KAAO,CAAC,EACtD,IAAoB,IAAhBwB,EAAIrB,QAEN,YADAc,EAAeQ,IAAIH,EAAQtB,GAAI,CAAEG,SAAS,IAG5C,MAAMuB,GAAoBjB,GAAQE,EAAiBgB,IAAIL,EAAQM,QACzDC,EAAWA,CAACC,EAAOC,KACvBb,GAAcY,EACdX,GAAaY,EACTL,IACFN,GAAqBU,EACrBT,GAAoBU,IAIlBC,GAA4C,IAA3BV,EAAQU,eACzBC,EAAoC,QAAlBV,EAAGpC,EAAQ+C,eAAO,IAAAX,OAAA,EAAfA,EAAiBU,mBAC5C,GAAID,IAAmBC,EASrB,OARAhB,EAAeQ,IAAIH,EAAQtB,GAAI,CAC7BG,SAAS,EACT4B,MAAM,EACNZ,UAAW,EACXD,WAAY,EACZiB,eAAgB,CAAC,8BAEnBN,EAAS,EAAG,GAId,MACMO,GADWC,MAAMC,QAAQhB,EAAQiB,QAAUjB,EAAQiB,OAAS,IACrCC,OAAQxC,IAAE,IAAAyC,EAAA,OAAkC,KAAX,QAAlBA,EAAAjB,EAAIjB,sBAAc,IAAAkC,OAAA,EAAlBA,EAAqBzC,MACjE,GAA2B,IAAvBoC,EAAYtF,OAQd,YAPAmE,EAAeQ,IAAIH,EAAQtB,GAAI,CAC7BG,SAAS,EACT4B,MAAM,EACNZ,UAAW,EACXD,WAAY,EACZiB,eAAgB,KAIpB,MAAMO,EAAaN,EAChBrB,IAAKf,GAAOb,EAAQwD,WAAW3C,IAC/BwC,OAAOI,SACPJ,OAAQK,IACP,GAA+B,oBAApBA,EAAMC,UAA0B,OAAO,EAClD,IACE,OAAmD,IAA5CD,EAAMC,UAAU/D,EAAQC,EAAME,EACvC,CAAE,MAAO6D,GACP,OAAO,CACT,IAGEC,EAAS,GACTC,EAAU,GAEhBP,EAAW3C,QAAS8C,IAClB,IAAI3E,EAAQ,KACZ,IACEA,EAAQ2E,EAAMK,SAAWL,EAAMK,SAASnE,EAAQC,GAAQ,IAC1D,CAAE,MAAO+D,GACP7E,EAAQ,IACV,CACA,MAAMiF,EA3GZ,SAAkBjF,EAAOkF,GACvB,MAAa,WAATA,GAA0BC,EAAAA,EAAAA,IAAiBnF,GAGlC,YAATkF,EAA4C,mBAAVlF,GAC5BoF,EAAAA,EAAAA,IAAMpF,GACL,CACb,CAoGiBqF,CAASrF,EAAO2E,EAAMO,MAC7BD,EAAIH,EAAOQ,KAAKX,GACfI,EAAQO,KAAKX,KAGpB,MAAMY,EAAcT,EAAOlG,OAC3B,IAAIsD,EAAOvB,OAAO2C,EAAIpB,MAAQkB,EAAQoC,aAAe,OAAOC,cACxDC,EAActD,OAAOuD,SAASvD,OAAOkB,EAAInB,MAAQC,OAAOkB,EAAInB,KAAOiB,EAAQwC,WAM/E,GALIrD,GAAuB,kBAAfa,EAAQtB,KAClBI,EAAO,MACPwD,EAAc,GAGH,QAATxD,EAAgB,CAClB,MAAMC,EAAM0D,KAAKC,IAAI,EAAG1D,OAAOuD,SAASD,GAAeA,EAAc,GAC/D7B,EAAO0B,GAAepD,EACtB4D,EAAYF,KAAK1D,IAAIoD,EAAapD,GASxC,OARAY,EAAeQ,IAAIH,EAAQtB,GAAI,CAC7BG,SAAS,EACT4B,OACAZ,UAAW8C,EACX/C,WAAYb,EACZ8B,eAAgBJ,EAAO,GAAK,CAAC,SAADrE,OAAU2C,EAAG,iBAE3CwB,EAASxB,EAAK4D,EAEhB,CAEA,MAAMnC,EAAQY,EAAW5F,OACzB,GAAc,IAAVgF,EAmBF,aAlB2B,IAAvBR,EAAQ4C,YACVjD,EAAeQ,IAAIH,EAAQtB,GAAI,CAC7BG,SAAS,EACT4B,MAAM,EACNZ,UAAW,EACXD,WAAY,EACZiB,eAAgB,CAACb,EAAQ6C,OAAS,WAEpCtC,EAAS,EAAG,IAEZZ,EAAeQ,IAAIH,EAAQtB,GAAI,CAC7BG,SAAS,EACT4B,MAAM,EACNZ,UAAW,EACXD,WAAY,EACZiB,eAAgB,MAMtB,MAAMJ,EAAO0B,IAAgB3B,EACvBK,EAAiBJ,EACnB,GACAkB,EAAQlC,IAAK8B,GAAUA,EAAMsB,OAAO3B,OAAOI,SAE/C3B,EAAeQ,IAAIH,EAAQtB,GAAI,CAC7BG,SAAS,EACT4B,OACAZ,UAAWsC,EACXvC,WAAYY,EACZK,mBAEFN,EAASC,EAAO2B,KAGlB,MAAMW,EAAOjF,EAAQiF,KAAKrD,IAAKsD,IAC7B,MACMC,GADWD,EAAIE,YAAc,IAEhCxD,IAAKf,IAAE,CAAQA,KAAIwE,OAAQvD,EAAewD,IAAIzE,GAAK0E,IAAK7D,EAAa4D,IAAIzE,MACzEwC,OAAQxB,GAAMA,EAAEwD,SAA+B,IAArBxD,EAAEwD,OAAOrE,SAEtC,IAAIwE,EAAW,EACXC,EAAU,EACd,MAAMC,EAAe,GACrB,IAAIC,GAAU,EAEdR,EAAgBvE,QAASiB,IACvB,MAAM+D,EAAM/D,EAAEwD,QAAU,CAAC,EACpBO,EAAIhD,OAAM+C,GAAU,GACzB,MAAME,EAAI1E,OAAOyE,EAAI7D,YAAc,GAC7B+D,EAAI3E,OAAOyE,EAAI5D,WAAa,GAC9B6D,EAAI,IACNL,GAAYK,EACZJ,GAAWK,GAET5C,MAAMC,QAAQyC,EAAI5C,iBAAmB4C,EAAI5C,eAAerF,QAC1D+H,EAAarB,QAAQuB,EAAI5C,kBAI7B,MAAM+C,EAAMP,EACRZ,KAAKoB,MAAOP,EAAUD,EAAY,KAClCG,EACE,IACA,EACAM,EAAiBP,EAAa/H,OAAS+H,EAAaQ,KAAK,OAAS,GAExE,MAAO,CACLtJ,IAAKsI,EAAItI,IACToI,MAAOE,EAAIF,MACXe,MACAnD,KAAM+C,EACNM,iBACAP,kBAIES,EAAiB7E,EAAOW,EAAoBF,EAC5CqE,EAAgB9E,EAAOY,EAAmBF,EAC1C+D,EAAMI,EAAiBvB,KAAKoB,MAAOI,EAAgBD,EAAkB,KAAO,IAC5EE,EAAsBpB,EACzB5B,OAAQwC,IAAOA,EAAEjD,MACjBS,OAAQwC,IAAQvE,GAAcE,EAAiBgB,IAAIqD,EAAEjJ,MACrDgF,IAAKiE,IACJ,MAAMS,EAAUT,EAAEI,gBAAkB,gBACpC,MAAM,GAAN1H,OAAUsH,EAAEb,MAAK,MAAAzG,OAAK+H,KAGpBC,EAAcjF,EAAO2D,EAAK5B,OAAQwC,GAAMrE,EAAiBgB,IAAIqD,EAAEjJ,MAAQqI,EAI7E,MAAO,CACLc,MACAS,eALqBD,EAAYlD,OAAQwC,GAAMA,EAAEjD,MAAMjF,OAMvD8I,WALiBF,EAAY5I,OAM7BsH,OACAoB,sBAEJ,C,oDCrMA,SAASK,EAAgBC,GACvB,MAAMtB,EAAS,GACf,IAAKsB,EAAM,OAAOtB,EAClB,MAAMuB,EAASlH,OAAOiH,GAAME,MAAM,KAKlC,GAHID,EAAOjJ,OAAS,GAAmB,WAAdiJ,EAAO,IAC9BA,EAAOE,QAEa,IAAlBF,EAAOjJ,OAAc,OAAO0H,EAGhC,IAAI0B,EADYH,EAAO,GACJI,QAAQ,qBAAsB,SAASC,cAC1D,MAAMC,EAAe,CACnBC,aAAc,cACdC,eAAgB,cAChBC,OAAQ,eAKV,GAHI3G,OAAO4G,UAAUC,eAAeC,KAAKN,EAAcH,KACrDA,EAAOG,EAAaH,KAEjBA,EAAM,OAAO1B,EAMlB,GAAIuB,EAAOjJ,QAAU,EAAG,CACtB,MACM8J,EADab,EAAO,GACMI,QAAQ,qBAAsB,SAASC,cAwCjES,EAvCsB,CAC1BC,eAAgB,CACdC,UAAW,YACXC,qBAAsB,YACtBC,yBAA0B,YAC1BC,UAAW,YACXC,8BAA+B,WAC/BC,SAAU,WACVC,cAAe,QACfC,MAAO,QACPC,WAAY,aACZC,cAAe,aACfC,sBAAuB,cACvBC,WAAY,KACZC,UAAW,KACXC,aAAc,MAEhBC,SAAU,CACR,IAAK,YAEPC,SAAU,CACR,IAAK,WAEPC,GAAI,CACF,IAAK,eAEPC,UAAW,CACT,IAAK,aAEPhJ,KAAM,CACJ,IAAK,iBAEPiJ,YAAa,CACX,IAAK,QAEPC,SAAU,CACR,IAAK,SAG2BhC,GACpC,IAAIiC,EAAS,KAcb,GAXIA,EAFAtB,EACEhH,OAAO4G,UAAUC,eAAeC,KAAKE,EAASD,GACvCC,EAAQD,GACR/G,OAAO4G,UAAUC,eAAeC,KAAKE,EAAS,KAC9CA,EAAQ,KAGRD,EAIFA,EAEPuB,EAKF,OADA3D,EAAOhB,KAAK,WAAD9F,OAAYwI,EAAI,KAAAxI,OAAIyK,IACxB3D,CAEX,CAGA,OADAA,EAAOhB,KAAK,QAAD9F,OAASwI,IACb1B,CACT,CAgBA,MAAM4D,EAAoB,IAAIxH,IAAI,CAAC,SAAU,WAAY,SAAU,WAAY,OAAQ,KAAM,iBAAkB,WACzGyH,EAAe,CACnBC,OAAQ,iBACRJ,SAAU,WACVlJ,KAAM,OACNuJ,GAAI,KACJC,OAAQ,WACRC,SAAU,WACVC,eAAgB,gBAChBC,OAAQ,SAEJC,EAAe/I,OAAOgJ,YAAYhJ,OAAOiJ,QAAQT,GAActH,IAAIgI,IAAA,IAAEhN,EAAKmC,GAAM6K,EAAA,MAAK,CAAC7K,EAAOnC,MAC7FiN,EAAiB,CACrBV,OAAQ,iBACRJ,SAAU,WACVlJ,KAAM,qBACNuJ,GAAI,iBACJC,OAAQ,oBACRC,SAAU,oBAENQ,EAAuB,IAAIrI,IAAI,CAAC,iBAAkB,oBAAqB,qBAE7E,SAASsI,EAAkBC,GACzB,MAAMnI,EAAInC,OAAOsK,GAAgB,IAAI9L,OAC/B+L,EAAQpI,EAAEqI,MAAM,yBACtB,GAAID,EAAO,CACT,MAAME,EAAYhJ,OAAO8I,EAAM,IACzBG,EAAUjJ,OAAO8I,EAAM,IAC7B,GAAI9I,OAAOuD,SAASyF,IAAchJ,OAAOuD,SAAS0F,GAChD,MAAO,CAAED,YAAWC,UAExB,CACA,MAAMC,EAASxI,EAAEqI,MAAM,aACvB,GAAIG,EAAQ,CACV,MAAMF,EAAYhJ,OAAOkJ,EAAO,IAChC,GAAIlJ,OAAOuD,SAASyF,GAAY,MAAO,CAAEA,YAAWC,QAASD,EAC/D,CACA,MAAO,CAAEA,UAAW,KAAMC,QAAS,KACrC,CAEA,SAASE,EAASpF,GAChB,MAAMqF,EAAIpJ,OAAU,OAAH+D,QAAG,IAAHA,OAAG,EAAHA,EAAKa,KACtB,OAAO5E,OAAOuD,SAAS6F,GAAKA,EAAI,CAClC,CAEA,SAASC,EAAkBC,EAAGC,GAC5B,MAAMlK,EAAM,GACNmK,EAAO,IAAIlJ,IAUjB,MATA,CAACgJ,EAAGC,GAAG9J,QAASgK,IACT1H,MAAMC,QAAQyH,IACnBA,EAAKhK,QAASiK,IACZ,MAAMC,EAAMpL,OAAOmL,GAAQ,IAAI3M,OAC1B4M,IAAOH,EAAKnI,IAAIsI,KACrBH,EAAKI,IAAID,GACTtK,EAAI6D,KAAKyG,QAGNtK,EAAIwK,MAAM,EAAG,GACtB,CAEA,SAASC,EAAmBC,EAAKC,GAC/B,IAAKjI,MAAMC,QAAQ+H,GAAM,OAAQ,EACjC,MAAME,EAAQF,EAAIG,UACfC,GAASA,GAAwB,kBAATA,GAAqB,QAASA,GAAQ5L,OAAO4L,EAAK1O,OAASuO,GAEtF,IAAe,IAAXC,EAAc,OAAOA,EACzB,MAAMG,EAASL,EAAIG,UAChBC,GAASA,GAAwB,kBAATA,GAAqB,SAAUA,GAAQ5L,OAAO4L,EAAKhO,QAAU6N,GAExF,IAAgB,IAAZI,EAAe,OAAOA,EAC1B,MAAMC,EAAUN,EAAIG,UACjBC,GAASA,GAAwB,kBAATA,GAAqB,UAAWA,GAAQ5L,OAAO4L,EAAKG,SAAWN,GAE1F,IAAiB,IAAbK,EAAgB,OAAOA,EAC3B,MAAME,EAAMvK,OAAOgK,GACnB,OAAIhK,OAAOwK,UAAUD,IAAQhM,OAAOgM,KAASP,GAAQO,GAAO,GAAKA,EAAMR,EAAIvN,OAAe+N,GAClF,CACV,CA+Be,SAASE,IAAc,IAADC,EAAAC,EACnC,MAAM,GAAEjL,IAAOkL,EAAAA,EAAAA,KACTC,GAAWhO,EAAAA,EAAAA,MACXiO,GAAWC,EAAAA,EAAAA,MACXC,GAASC,EAAAA,EAAAA,MACTC,EAAWlL,OAAON,IAEjByL,EAAQC,IAAa3N,EAAAA,EAAAA,UAAS,OAC9B4N,EAAKC,IAAU7N,EAAAA,EAAAA,UAAS,KAGxB8N,EAAIC,IAAS/N,EAAAA,EAAAA,UAAS,OAE7BC,EAAAA,EAAAA,WAAU,KACR,MAAMiC,EAAO,qBACb8L,SAASC,MAAc,OAANP,QAAM,IAANA,GAAAA,EAAQhP,KAAI,GAAAiB,OAAM+N,EAAOhP,KAAI,UAAAiB,OAAMuC,GAAI,eAAAvC,OAAiBuC,IACxE,CAAO,OAANwL,QAAM,IAANA,OAAM,EAANA,EAAQhP,OAIZ,MAAOwP,EAAkBC,IAAuBnO,EAAAA,EAAAA,UAAS,OAClDoO,EAAYC,IAAiBrO,EAAAA,EAAAA,UAAS,OACtCsO,EAAkBC,IAAuBvO,EAAAA,EAAAA,UAAS,OAMlDwO,EAAWC,IAAgBzO,EAAAA,EAAAA,UAAS,KACpC0O,EAAiBC,IAAsB3O,EAAAA,EAAAA,WAAS,IAChD4O,EAAiBC,IAAsB7O,EAAAA,EAAAA,UAAS,KAChD8O,EAAoBC,IAAyB/O,EAAAA,EAAAA,WAAS,IACtDgP,EAAmBC,IAAwBjP,EAAAA,EAAAA,WAAS,IAGpDkP,GAAWC,KAAgBnP,EAAAA,EAAAA,UAAS,KACpCoP,GAAoBC,KAAyBrP,EAAAA,EAAAA,UAAS,KAAMsP,EAAAA,EAAAA,IAAuB7B,KACnF8B,GAAuBC,KAA4BxP,EAAAA,EAAAA,UAAS,MAQ7DyP,IAAmBC,EAAAA,EAAAA,aAAYC,UACnC,MAAMC,EAAsB,OAAhB1B,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkBjM,GAC9B,IAAK2N,IAAQnC,EAIX,OAHAgB,EAAa,IACbE,GAAmB,QACnBE,EAAmB,IAGrB,IACE,MAAMgB,QAAaC,EAAAA,GAAIC,cAActC,EAAUmC,GAC/CnB,EAAanK,MAAMC,QAAY,OAAJsL,QAAI,IAAJA,OAAI,EAAJA,EAAMrB,WAAaqB,EAAKrB,UAAY,IAC/DK,EAAmBvK,MAAMC,QAAY,OAAJsL,QAAI,IAAJA,OAAI,EAAJA,EAAMjB,iBAAmBiB,EAAKjB,gBAAkB,IACjFD,GAAmB,EACrB,CAAE,MAAO3J,GAEP6J,EAAmB,IACnBF,GAAmB,EACrB,GACC,CAAClB,EAA0B,OAAhBS,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkBjM,KAG1B+N,IAAsBN,EAAAA,EAAAA,aAAYC,UACtC,GAAKlC,EAAL,CACAsB,GAAsB,GACtB,IACE,MAAMc,QAAaC,EAAAA,GAAIG,cAAcxC,EAAU,CAC7CyC,MAAO,GACPC,OAAQ,EACR3L,OAAQ,QACR4L,MAAO,oBAEHpE,EAAO1H,MAAMC,QAAY,OAAJsL,QAAI,IAAJA,OAAI,EAAJA,EAAMQ,OAASR,EAAKQ,MAAQ,GACvDlB,GAAanD,GACb,MAAMsE,EAA+B,OAAlBlB,SAAkB,IAAlBA,GAAAA,GAAsC,OAAhBlB,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkBjM,GAC3D,GAAkB,MAAdqO,EAAoB,CACtB,MAAMC,EAAevE,EAAKwE,KAAM9D,GAAS5L,OAAW,OAAJ4L,QAAI,IAAJA,OAAI,EAAJA,EAAMzK,MAAQnB,OAAOwP,IACjEC,GACFpC,EAAqBsC,GAAUA,GAAIC,EAAAA,EAAAA,IAAAA,EAAAA,EAAAA,GAAA,GAAQD,GAASF,GAAiBA,EAEzE,CACAxB,GAAsB,EACxB,CAAE,MAAO/J,GAEP+J,GAAsB,EACxB,CAtBqB,GAuBpB,CAACtB,EAAU2B,GAAoC,OAAhBlB,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkBjM,KAI9C0O,IAAiBjB,EAAAA,EAAAA,aACrBC,UACE,MAAMC,EAAsB,OAAhB1B,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkBjM,GAC9B,GAAK2N,GAAQnC,GAAamD,EAC1B,UACQd,EAAAA,GAAIa,eAAelD,EAAUmC,EAAKgB,SAClCnB,WACAO,KACNa,EAAAA,GAAMC,QAAQ,0BAChB,CAAE,MAAOC,GACPF,EAAAA,GAAMG,MAAMD,EAAEE,SAAW,uCAC3B,GAEF,CAACxD,EAA0B,OAAhBS,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkBjM,GAAIwN,GAAkBO,MAQrD/P,EAAAA,EAAAA,WAAU,KACR,GAAqB,OAAhBiO,QAAgB,IAAhBA,IAAAA,EAAkBjM,GAIrB,OAHAwM,EAAa,IACbE,GAAmB,QACnBI,GAAsB,GAGxBJ,GAAmB,GACnBI,GAAsB,GACtBU,MACC,CAAiB,OAAhBvB,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkBjM,GAAIwN,KAO1B,MAAOxO,GAAMiQ,KAAWlR,EAAAA,EAAAA,UAAS,OAC1BmR,GAAgBC,KAAqBpR,EAAAA,EAAAA,UAAS,OAG9CgB,GAAQqQ,KAAarR,EAAAA,EAAAA,UAAS,OAC9BsR,GAAcC,KAAmBvR,EAAAA,EAAAA,WAAS,IAC1CwR,GAAYC,KAAiBzR,EAAAA,EAAAA,UAAS,IAAM,IAAI6C,MAChD6O,GAAgBC,KAAqB3R,EAAAA,EAAAA,UAAS,OAC9C4R,GAAcC,KAAmB7R,EAAAA,EAAAA,UAAS,MAC3C8R,IAAmBpC,EAAAA,EAAAA,aAAa9Q,IACpC6S,GAAehB,IACb,IAAKA,EAAKsB,KAAM,OAAOtB,EACvB,IAAIuB,GAAU,EACd,MAAMpR,EAAO,IAAIiC,IACjB,IAAK,MAAMkF,KAAQ0I,EACb1I,EAAKkK,WAAWrT,GAClBoT,GAAU,EAGZpR,EAAKuL,IAAIpE,GAEX,OAAOiK,EAAUpR,EAAO6P,KAEzB,IACGyB,IAAiBxC,EAAAA,EAAAA,aACpB9Q,IACC,IAAK,MAAMmJ,KAAQyJ,GACjB,GAAIzJ,IAASnJ,GAAUmJ,EAAKkK,WAAWrT,GAAS,OAAO,EAEzD,OAAO,GAET,CAAC4S,MAGI5G,GAAQuH,KAAanS,EAAAA,EAAAA,UAAS,OAC9BoS,GAAaC,KAAkBrS,EAAAA,EAAAA,WAAS,IACxCsS,GAAaC,KAAkBvS,EAAAA,EAAAA,UAAS,OACxCwS,GAAkBC,KAAuBzS,EAAAA,EAAAA,UAAS,OAClD0S,GAASC,KAAc3S,EAAAA,EAAAA,UAAS,IAChC4S,GAAYC,KAAiB7S,EAAAA,EAAAA,WAAS,GACvC8S,IAAgBjT,EAAAA,EAAAA,QAAO,MACvBkT,IAAkBlT,EAAAA,EAAAA,QAAO,OACxBmT,GAAcC,KAAmBjT,EAAAA,EAAAA,WAAS,IAE1CkT,GAAaC,KAAkBnT,EAAAA,EAAAA,WAAS,IACxCoT,GAAkBC,KAAuBrT,EAAAA,EAAAA,UAAS,wBAEzDC,EAAAA,EAAAA,WAAU,KACRoP,IAAsBC,EAAAA,EAAAA,IAAuB7B,KAC5C,CAACA,IAEJ,MAAM6F,IAAajU,EAAAA,EAAAA,SACjB,cAAAM,OAAgB8N,EAAQ,cAAA9N,OAA+B,OAAlByP,SAAkB,IAAlBA,GAAAA,GAAsB,QAC3D,CAAC3B,EAAU2B,MAENmE,GAAgBC,KAAqB/U,EAAAA,EAAAA,IAAmB,kBAAmB,MAAO,CAAEI,MAAOyU,KAC5FG,IAAgC5T,EAAAA,EAAAA,QAAO,OACtC6T,GAAYC,KAAiBlV,EAAAA,EAAAA,IAAmB,cAAe,WAAY,CAAEI,MAAOyU,MACpFM,GAAmBC,KAAwB7T,EAAAA,EAAAA,WAAS,IACpD8T,GAAoBC,KAAyBlT,EAAAA,EAAAA,IAAoB,4BAA6B,WAAY,CAAEhC,MAAOyU,KACpHU,IAAqB3U,EAAAA,EAAAA,SAAQ,KACjC,MAAM6C,EAAI,YAAAvC,OAAe8N,EAAQ,KACjC,OAAKL,EAAS7N,SAAS0S,WAAW/P,IAC3BkL,EAAS7N,SAAS6M,MAAMlK,EAAKnD,QAAQkJ,MAAM,KAAK,IADP,IAE/C,CAACmF,EAAS7N,SAAUkO,IACjBnH,GAAMuE,EAAamJ,KAAuB,GAC1CC,GAAehJ,EAAe3E,KAAQ,KACtC4N,IAAiB7U,EAAAA,EAAAA,SAAQ,IACxB4U,IAAiB3P,MAAMC,QAAQiK,IAC7BA,EAAUgC,KAAM9D,GAAS5L,OAAW,OAAJ4L,QAAI,IAAJA,OAAI,EAAJA,EAAMyH,WAAarT,OAAOmT,MADV,KAEtD,CAACA,GAAczF,IACZ4F,GAAgC,OAAdF,SAAc,IAAdA,IAAAA,GAAgBpU,MAAQgB,OAAOoT,GAAepU,OAAS,cACzEuU,GAAe,CAAC,YAAa,YAAYC,SAASF,IAClDG,GAASC,EAAAA,YACZC,IACC,MAAMC,EAAUpK,EAAamK,GACxBC,GACLrH,EAAS,YAAD1N,OAAa8N,EAAQ,KAAA9N,OAAI+U,KAEnC,CAACrH,EAAUI,KAGbxN,EAAAA,EAAAA,WAAU,KAKH4K,EAAamJ,MAClBW,EAAAA,EAAAA,IAAqBlH,EAAU2B,GAAoB4E,KAClD,CAACA,GAAoBvG,EAAU2B,MAKlCnP,EAAAA,EAAAA,WAAU,KACH4K,EAAamJ,MAClBY,EAAAA,EAAAA,IAA4BZ,KAC3B,CAACA,MAEJ/T,EAAAA,EAAAA,WAAU,KAKR,MAAMiC,EAAI,YAAAvC,OAAe8N,GACzB,GAAIL,EAAS7N,WAAa2C,GAAQkL,EAAS7N,WAAQ,GAAAI,OAAQuC,EAAI,KAAK,OACpE,MACM2S,GADOC,EAAAA,EAAAA,IAAoBrH,EAAU2B,KACb9E,EAAaC,OACrCwK,EAAM,GAAApV,OAAMuC,EAAI,KAAAvC,OAAIkV,GAC1BxH,EAAS0H,EAAQ,CAAE3M,SAAS,KAC3B,CAACgF,EAAS7N,SAAU8N,EAAUI,EAAU2B,MAE3CnP,EAAAA,EAAAA,WAAU,KACRkT,IAAe,GACfE,GAAoB,wBACnB,CAAC5F,KAEJxN,EAAAA,EAAAA,WAAU,KACHsP,IACAH,IACDtO,OAAOsO,MAAwBtO,OAAOyO,GAAsBe,cAChEiE,GAAOhF,GAAsBjJ,KAC7BkJ,GAAyB,QACxB,CAACD,GAAuBH,GAAoBmF,MAE/CtU,EAAAA,EAAAA,WAAU,KACR,MAAMgC,EAAK+S,YAAY,IAAMrC,GAAWsC,KAAKC,OAAQ,KACrD,MAAO,IAAMC,cAAclT,IAC1B,KAEHhC,EAAAA,EAAAA,WAAU,KACR,IAAK2S,GAAY,OACjB,MAAMwC,EAAeC,IACnB,MAAMC,EAAKxC,GAAc5S,QACpBoV,IAAMA,EAAGC,SAASF,EAAMN,SAC7BlC,IAAc,IAEV2C,EAAaH,IACC,WAAdA,EAAMrX,KAAkB6U,IAAc,IAI5C,OAFA7E,SAASyH,iBAAiB,YAAaL,GACvCpH,SAASyH,iBAAiB,UAAWD,GAC9B,KACLxH,SAAS0H,oBAAoB,YAAaN,GAC1CpH,SAAS0H,oBAAoB,UAAWF,KAEzC,CAAC5C,KAGJ,MACM+C,GADgBxK,EAAkC,OAAhB+C,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkB0H,eAC3BrK,UACzBsK,GACiC,WAArB,OAAhB3H,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkB4H,gBACb5H,EAAiB6H,qBAAuB,QACzC,MACAC,GAAuD,WAArB,OAAhB9H,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkB4H,gBACpCG,GAAkB1T,QAAa,OAANvB,SAAM,IAANA,IAAqB,QAAfiM,EAANjM,GAAQkV,qBAAa,IAAAjJ,GAAY,QAAZC,EAArBD,EAAuBzD,kBAAU,IAAA0D,OAA3B,EAANA,EAAmCiJ,+BAAgC,GAC5FC,GAAoBJ,MAAqBzT,OAAOuD,SAASmQ,KAAoBA,GAAkB,GAE/FI,IAAchX,EAAAA,EAAAA,SAAQ,KAAMiX,EAAAA,EAAAA,IAAetV,GAAQkN,GAAmB,CAAClN,GAAQkN,IAC/EqI,IAAkBlX,EAAAA,EAAAA,SAAQ,KAAO,IAADmX,EAAAC,EACpC,MAAMC,EAAgD,QAAvCF,EAAqB,QAArBC,EAAS,OAAN/I,QAAM,IAANA,OAAM,EAANA,EAAQiJ,kBAAU,IAAAF,EAAAA,EAAM,OAAF3I,QAAE,IAAFA,OAAE,EAAFA,EAAI6I,kBAAU,IAAAH,EAAAA,EAAI,KAC1D,MAAO,CAAE/I,WAAUiJ,cAClB,CAACjJ,EAAgB,OAANC,QAAM,IAANA,OAAM,EAANA,EAAQiJ,WAAc,OAAF7I,QAAE,IAAFA,OAAE,EAAFA,EAAI6I,aAChCC,IAAcvX,EAAAA,EAAAA,SAAQ,KAC1B,IACE,OAAOwX,EAAAA,EAAAA,IAAI/I,EAAI,YAAa,OAAQyI,GACtC,CAAE,MAAA/X,GACA,OAAO,CACT,GACC,CAACsP,EAAIyI,KACFO,IAAmBzX,EAAAA,EAAAA,SAAQ,KAC/B,IACE,SAAIwX,EAAAA,EAAAA,IAAI/I,EAAI,2BAA4B,QAASyI,MAC1CM,EAAAA,EAAAA,IAAI/I,EAAI,gBAAiB,QAASyI,GAC3C,CAAE,MAAAjW,GACA,OAAO,CACT,GACC,CAACwN,EAAIyI,KACFQ,IAAsB9V,KAAS2V,GAE/BI,IAAmB3X,EAAAA,EAAAA,SACvB,IAAM0B,EAAwB,CAAEC,UAAQC,QAAMC,OAAQiQ,GAAgBhQ,SAAU+M,IAChF,CAAClN,GAAQC,GAAMkQ,GAAgBjD,IAE3BxL,IAAOrD,EAAAA,EAAAA,SAAQ,KAAMsD,EAAAA,EAAAA,GAAsB3B,IAAS,CAACA,MAC3Df,EAAAA,EAAAA,WAAU,KACJwN,GAAY2B,IAAsBpO,KACpCiW,EAAAA,EAAAA,IAAmBxJ,EAAU2B,GAAoB,CAAE8H,cAAexU,MAEnE,CAAC+K,EAAU2B,GAAoBpO,GAAQ0B,KAC1C,MAAMyU,IAAU9X,EAAAA,EAAAA,SACd,IAAMyC,OAAOgJ,cAA6B,OAAhBkM,SAAgB,IAAhBA,QAAgB,EAAhBA,GAAkB3Q,OAAQ,IAAIrD,IAAKiE,GAAM,CAACA,EAAEjJ,IAAKiJ,KAC3E,CAAC+P,KAEGI,IAAa/X,EAAAA,EAAAA,SAAQ,KACzB,MAAMwM,EAAIH,EAASyL,GAAQE,YACrBvL,EAAIiL,GAAqBlL,EAAIH,EAASyL,GAAQlW,MACpD,OAAO+E,KAAKoB,OAAOyE,EAAIC,GAAK,IAC3B,CAACqL,GAASJ,KACPO,IAAiBjY,EAAAA,EAAAA,SAAQ,KAC7B,MAAMwM,EAAIH,EAASyL,GAAQpN,UAC3B,GAAIrH,GAAM,OAAOmJ,EAGjB,MAAMC,EAAIJ,EAASyL,GAAQlN,WAC3B,OAAOjE,KAAKoB,OAAOyE,EAAIC,GAAK,IAC3B,CAACqL,GAASzU,KACP6U,IAAmBlY,EAAAA,EAAAA,SACvB,SAAAmY,EAAAC,EAAA,OAAM7L,EAAoC,QAAnB4L,EAACL,GAAQE,kBAAU,IAAAG,OAAA,EAAlBA,EAAoB1Q,aAA0B,QAAd2Q,EAAEN,GAAQlW,YAAI,IAAAwW,OAAA,EAAZA,EAAc3Q,eACxE,CAACqQ,KAEGO,IAAuBrY,EAAAA,EAAAA,SAC3B,SAAAsY,EAAAC,EAAAC,EAAA,OACEnV,GACI4B,MAAMC,QAAwB,QAAjBoT,EAACR,GAAQpN,gBAAQ,IAAA4N,OAAA,EAAhBA,EAAkB7Q,cAC9BqQ,GAAQpN,SAASjD,aACjB,GACF8E,EAAkC,QAAjBgM,EAACT,GAAQpN,gBAAQ,IAAA6N,OAAA,EAAhBA,EAAkB9Q,aAA+B,QAAnB+Q,EAAEV,GAAQlN,iBAAS,IAAA4N,OAAA,EAAjBA,EAAmB/Q,eAC3E,CAACqQ,GAASzU,KAGNoV,IAAsBpI,EAAAA,EAAAA,aAC1BC,UACE,IAAKP,GAAoB,OACzB,MAAM2I,EAAWjX,OAAOuB,GAAQ,YAChCwR,IAAqB,GACrBhG,EAAO,IACP,IACE,MAAMgC,QAAaC,EAAAA,GAAIkI,kBAAkBvK,EAAU2B,GAAoB2I,GACvE5F,IAAc,OAAJtC,QAAI,IAAJA,OAAI,EAAJA,EAAMoI,UAAW,KAC7B,CAAE,MAAOlH,GACPlD,EAAOkD,EAAEE,SAAW,sBACtB,CAAC,QACC4C,IAAqB,EACvB,GAEF,CAACpG,EAAU2B,KAGP8I,IAAyBxI,EAAAA,EAAAA,aAC7BC,UACE,MAAMoI,EAAWjX,OAAOuB,GAAQ,YAC5B0V,IAAarE,IAAc9I,KAC/B+I,GAAcoE,SACRD,GAAoBC,KAE5B,CAACD,GAAqBpE,GAAY9I,GAAQ+I,MAE5C1T,EAAAA,EAAAA,WAAU,KACR,GAAW,OAANsN,QAAM,IAANA,GAAAA,EAAQ4K,cASb,OARA5K,EAAO4K,cAAc,CACnBlK,MAAa,OAANP,QAAM,IAANA,GAAAA,EAAQhP,KAAOgP,EAAOhP,KAAO,OACpC0Z,SAAUlK,EAAgB,GAAAvO,OACnBuO,EAAiBxP,MAAIiB,OAAGuO,EAAiB0H,cAAa,WAAAjW,OAASuO,EAAiB0H,eAAkB,IACrG,mBACJyC,aAAa,EACbC,UAAU,IAEL,KAAO,IAADC,EACW,QAAtBA,EAAAhL,EAAOiL,uBAAe,IAAAD,GAAtBA,EAAA3P,KAAA2E,KAED,CAACA,EAAQW,EAAwB,OAANR,QAAM,IAANA,OAAM,EAANA,EAAQhP,OAGtC,MAAM+Z,IAA4B/I,EAAAA,EAAAA,aAAagJ,IAAc,IAADC,EAAAC,EAAAC,EAC1D,MAAMC,EAAMJ,GAAY,CAAC,EACnB1O,EAAK8O,EAAI9O,IAAM,CAAC,EAChB+O,EAAW,OAAF/O,QAAE,IAAFA,GAAS,QAAP2O,EAAF3O,EAAIgP,aAAK,IAAAL,GAATA,EAAWM,GAAKjP,EAAGgP,MAAMC,GAAKjP,EAEvCkP,GAAkB,OAANH,QAAM,IAANA,OAAM,EAANA,EAAQG,YAAa,CAAC,EAClCC,GAA0B,OAANJ,QAAM,IAANA,OAAM,EAANA,EAAQI,oBAAqB,CAAC,EAElDC,EAAQ,CACZ,aACA,cACA,gBACA,cACA,0BACA,eACA,2BACA,yBAGIC,EAAYvX,OAAOC,KAAKoX,GAAqB,CAAC,GAC9CG,EAASD,EAAUta,OACrBsa,EACA,CACE,aACA,eACA,aACA,gBACA,cACA,YACA,WAGAE,EAAa,CAAC,EACpB,IAAK,MAAMC,KAAKJ,EAAO,CACrB,IAAIK,EAAQ,EACZ,IAAK,MAAMC,KAAOJ,EAAO,CAAD,IAAAK,EAAEF,GAASlX,QAAwB,OAAjB4W,QAAiB,IAAjBA,GAAwB,QAAPQ,EAAjBR,EAAoBO,UAAI,IAAAC,OAAP,EAAjBA,EAA2BH,KAAM,EAAG,CAC9ED,EAAWC,GAAKjX,QAAgB,OAAT2W,QAAS,IAATA,OAAS,EAATA,EAAYM,KAAM,GAAKC,CAChD,CAEA,MAAMG,EAAQ,CACZC,kBACGN,EAAWO,YAAc,IACzBP,EAAWQ,aAAe,IAC1BR,EAAWS,eAAiB,GAC/BC,uBAAwBV,EAAWW,aAAe,EAClDC,kBAAmBZ,EAAWa,yBAA2B,EACzDC,yBACGd,EAAWe,cAAgB,IAAMf,EAAWgB,0BAA4B,GAC3EC,0BAA2BjB,EAAWkB,uBAAyB,GAG3DC,GAAe,OAAH5B,QAAG,IAAHA,GAAa,QAAVF,EAAHE,EAAK/O,gBAAQ,IAAA6O,GAAS,QAATC,EAAbD,EAAe+B,eAAO,IAAA9B,OAAnB,EAAHA,EAAwBxI,QAAS,CAAC,EAC9CtO,EAAOD,OAAOC,KAAK6X,GAEzB,IAAI5H,GAAU,EACd,IAAK,MAAM4I,KAAK7Y,EAAM,CACpB,MAAM8J,EAAItJ,QAAgB,OAATmY,QAAS,IAATA,OAAS,EAATA,EAAYE,KAAM,GAC7B9O,EAAIvJ,QAAY,OAALqX,QAAK,IAALA,OAAK,EAALA,EAAQgB,KAAM,GAC/B,GAAI5U,KAAK6U,IAAIhP,EAAIC,GAAK,KAAM,CAC1BkG,GAAU,EACV,KACF,CACF,CACA,IAAKA,EAAS,OAAO8G,EAErB,MAAMlY,EAAOka,gBAAgBhC,GAC7BlY,EAAKmJ,SAAWnJ,EAAKmJ,UAAY,CAAC,EAClCnJ,EAAKmJ,SAAS4Q,QAAU/Z,EAAKmJ,SAAS4Q,SAAW,CAAC,EAClD/Z,EAAKmJ,SAAS4Q,QAAQtK,MAAQzP,EAAKmJ,SAAS4Q,QAAQtK,OAAS,CAAC,EAC9D,IAAK,MAAMuK,KAAK7Y,EAAMnB,EAAKmJ,SAAS4Q,QAAQtK,MAAMuK,GAAKrY,OAAOqX,EAAMgB,IAAM,GAC1E,OAAOha,GACN,IAEGma,IAA0BrL,EAAAA,EAAAA,aAAaoJ,IAAS,IAADkC,EAAAC,EAAAC,EACnD,MAAMC,EAAWza,IACf,MAAMiL,EAAIpJ,OAAO7B,GACjB,OAAO6B,OAAOuD,SAAS6F,GAAKA,EAAI,GAG5B1I,EAAI6V,GAAO,CAAC,EACZsC,EAASD,EAAQlY,EAAEoY,gBAEnBC,EAAMrY,EAAEkH,UAAkC,kBAAflH,EAAEkH,SAAwBlH,EAAEkH,SAAW,CAAC,EACnE6O,EAAQsC,EAAItC,OAA8B,kBAAdsC,EAAItC,MAAqBsC,EAAItC,MAAQ,CAAC,EAElEC,EAAKkC,EAAoB,MAAZnC,EAAMC,GAAaD,EAAMC,GAAKmC,GAC3CG,EAAKJ,EAAoB,MAAZnC,EAAMuC,GAAavC,EAAMuC,GAAKtC,GAC3CuC,EAAKL,EAAoB,MAAZnC,EAAMwC,GAAaxC,EAAMwC,GAAKvC,GAE3CwC,EAAkBN,EAAQG,EAAIG,iBAC9BC,EAAWJ,EAAII,UAAoC,kBAAjBJ,EAAII,SAAwBJ,EAAII,SAAW,CAAC,EAepF,KAZE,mBAAoBzY,IACnBA,EAAEkH,UACmB,kBAAflH,EAAEkH,WACRmR,EAAItC,OACgB,kBAAdsC,EAAItC,OACXmC,EAAW,OAAHG,QAAG,IAAHA,GAAU,QAAPN,EAAHM,EAAKtC,aAAK,IAAAgC,OAAP,EAAHA,EAAY/B,MAAQA,GAC5BkC,EAAW,OAAHG,QAAG,IAAHA,GAAU,QAAPL,EAAHK,EAAKtC,aAAK,IAAAiC,OAAP,EAAHA,EAAYM,MAAQA,GAC5BJ,EAAW,OAAHG,QAAG,IAAHA,GAAU,QAAPJ,EAAHI,EAAKtC,aAAK,IAAAkC,OAAP,EAAHA,EAAYM,MAAQA,GAC5BL,EAAW,OAAHG,QAAG,IAAHA,OAAG,EAAHA,EAAKG,mBAAqBA,IACjCH,EAAII,UACmB,kBAAjBJ,EAAII,UAEI,OAAOzY,EAExB,MAAMrC,EAAOka,gBAAgB7X,GAQ7B,OAPArC,EAAKuJ,UAAQuG,EAAAA,EAAAA,IAAAA,EAAAA,EAAAA,GAAA,GACP4K,GAAO,CAAC,GAAG,CAAF,GACbG,kBACAzC,MAAO,CAAEC,KAAIsC,KAAIC,MACjBE,aAEE,mBAAoB9a,UAAaA,EAAKya,eACnCza,GACN,IA0FG+a,IAAwBjM,EAAAA,EAAAA,aAAaoJ,IACzC,MAAM7V,EAAI6V,GAAO,CAAC,EACZ8C,GAAgBC,EAAAA,EAAAA,MAAkB7Y,IAAK8Y,IAAC,CAAQjP,MAAOiP,EAAGC,YAAa,EAAGC,kBAAmB,KAC7FC,EAAa3X,MAAMC,QAAQtB,EAAEwF,QAAUxF,EAAEwF,OAASmT,EAClD5C,EAAQ/V,EAAEiZ,aAAwC,kBAAlBjZ,EAAEiZ,YAA2BjZ,EAAEiZ,YAAc,CAAC,EAE9EjD,EAAK3U,MAAMC,QAAQyU,EAAMC,IAAMD,EAAMC,GAAKgD,EAC1CV,EAAKjX,MAAMC,QAAQyU,EAAMuC,IAAMvC,EAAMuC,GAAKtC,EAC1CuC,EAAKlX,MAAMC,QAAQyU,EAAMwC,IAAMxC,EAAMwC,GAAKvC,EAQ1CkD,EAASnQ,IACb,MAAMoQ,EAAI,IAAIrZ,IAMd,OALCuB,MAAMC,QAAQyH,GAAQA,EAAO,IAAIhK,QAASqa,IACzC,MAAM7C,EATY6C,KAAG,IAAAC,EAAAC,EAAAC,EAAA,MAAM,CAC7B3P,MAAO/L,OAAiB,QAAXwb,EAAI,OAAHD,QAAG,IAAHA,OAAG,EAAHA,EAAKxP,aAAK,IAAAyP,EAAAA,EAAI,IAC5BP,YAAaxZ,OAAuB,QAAjBga,EAAI,OAAHF,QAAG,IAAHA,OAAG,EAAHA,EAAKN,mBAAW,IAAAQ,EAAAA,EAAI,GACxCP,kBAAmBzZ,OAA6B,QAAvBia,EAAI,OAAHH,QAAG,IAAHA,OAAG,EAAHA,EAAKL,yBAAiB,IAAAQ,EAAAA,EAAI,KAMxCC,CAAaJ,GAClB7C,EAAE3M,OACPuP,EAAE1Y,IAAI8V,EAAE3M,MAAO2M,KAEV4C,GAyBT,MAPGnZ,EAAEiZ,cACF5X,MAAMC,QAAQtB,EAAEwF,UAChBnE,MAAMC,QAAQyU,EAAMC,MACpB3U,MAAMC,QAAQyU,EAAMuC,MACpBjX,MAAMC,QAAQyU,EAAMwC,MAnBAkB,EAAC7Q,EAAGC,KACzB,IAAKxH,MAAMC,QAAQsH,KAAOvH,MAAMC,QAAQuH,GAAI,OAAO,EACnD,MAAM6Q,EAAKR,EAAMtQ,GACX+Q,EAAKT,EAAMrQ,GACjB,GAAI6Q,EAAG5K,OAAS6K,EAAG7K,KAAM,OAAO,EAChC,IAAK,MAAOlF,EAAOgQ,KAAOF,EAAG5R,UAAW,CACtC,MAAM+R,EAAKF,EAAGlW,IAAImG,GAClB,IAAKiQ,EAAI,OAAO,EAChB,GAAIva,OAAOsa,EAAGd,eAAiBxZ,OAAOua,EAAGf,aAAc,OAAO,EAC9D,GAAIxZ,OAAOsa,EAAGb,qBAAuBzZ,OAAOua,EAAGd,mBAAoB,OAAO,CAC5E,CACA,OAAO,GASNU,CAAezZ,EAAEwF,OAAQwQ,IAEX,OAAOhW,EAExB,MAAMrC,EAAOka,gBAAgB7X,GAO7B,OANArC,EAAKsb,YAAc,CACjBjD,GAAI6B,gBAAgB7B,GACpBsC,GAAIT,gBAAgBS,GACpBC,GAAIV,gBAAgBU,IAEtB5a,EAAK6H,OAASqS,gBAAgBla,EAAKsb,YAAYjD,IACxCrY,GACN,IAEGmc,IAA4BrN,EAAAA,EAAAA,aAAaoJ,IAAS,IAADkE,EAAAC,EAAAC,EAAAC,EACrD,MAAMla,EAAI6V,GAAsB,kBAARA,EAAmBA,EAAM,CAAC,EAC5CrQ,GAAU,OAADxF,QAAC,IAADA,GAAc,QAAb+Z,EAAD/Z,EAAGiZ,mBAAW,IAAAc,OAAb,EAADA,EAAgB/D,MAAO,OAADhW,QAAC,IAADA,OAAC,EAADA,EAAGwF,SAAU,GAC5C2U,GAAOC,EAAAA,EAAAA,IAAwB5U,EAAS,OAADxF,QAAC,IAADA,GAAgB,QAAfga,EAADha,EAAGiT,qBAAa,IAAA+G,OAAf,EAADA,EAAkBrT,WACzDyM,GAAcC,EAAAA,EAAAA,IAAerT,GAC7Bqa,EAAgB,CACpBC,WAAYhb,OAAO6a,EAAKG,YAAc,GACtCC,aAAc,EACdC,WAAY,EACZC,cAAe,EACfC,YAAa,EACbC,UAAW,EACXC,QAAS,GAEXP,GAAcQ,EAAAA,EAAAA,IAAuB,UAAWzH,IAAgB9T,OAAO6a,EAAKW,SAAW,GACvFT,GAAcQ,EAAAA,EAAAA,IAAuB,WAAYzH,IAAgB9T,OAAO6a,EAAKY,UAAY,GACzFV,GAAcQ,EAAAA,EAAAA,IAAuB,OAAQzH,IAAgB9T,OAAO6a,EAAKa,MAAQ,GAEjF,MAeMC,EAfWC,EAACC,EAAMC,KACtB,IAAK/Z,MAAMC,QAAQ6Z,GAAO,MAAO,CAAEA,OAAMpM,SAAS,GAClD,IAAIA,GAAU,EACd,MAAMsM,EAAWF,EAAKpb,IAAKwW,IAAO,IAAD+E,EAAAC,EAC/B,MAAMxgB,EAAM8C,OAAa,QAAPyd,EAAE,OAAD/E,QAAC,IAADA,OAAC,EAADA,EAAGxb,WAAG,IAAAugB,EAAAA,EAAI,IACvBE,EAAYJ,EAASrgB,GAC3B,GAAiB,MAAbygB,EAAmB,OAAOjF,EAC9B,MAAMtZ,EAAUqC,OAAsB,QAAhBic,EAAE,OAADhF,QAAC,IAADA,OAAC,EAADA,EAAGkF,oBAAY,IAAAF,EAAAA,EAAI,GAC1C,OAAIxY,KAAK6U,IAAI3a,EAAUue,GAAa,KAAajF,GACjDxH,GAAU,GACVtB,EAAAA,EAAAA,IAAAA,EAAAA,EAAAA,GAAA,GAAY8I,GAAC,IAAEkF,aAAcD,OAE/B,MAAO,CAAEL,KAAMpM,EAAUsM,EAAWF,EAAMpM,YAGxBmM,CAAU,OAADlb,QAAC,IAADA,GAAW,QAAVia,EAADja,EAAG6G,gBAAQ,IAAAoT,GAAS,QAATC,EAAXD,EAAayB,eAAO,IAAAxB,OAAnB,EAADA,EAAsBiB,KAAOpgB,GACxD8D,OAAO4G,UAAUC,eAAeC,KAAK0U,EAAetf,GAAOsf,EAActf,GAAO,MAGlF,IAAKkgB,EAAYlM,QAAS,OAAO/O,EAEjC,MAAMrC,EAAOka,gBAAgB7X,GAM7B,OALArC,EAAKkJ,SAAWlJ,EAAKkJ,UAAY,CAAC,EAC9BoU,EAAYlM,UACdpR,EAAKkJ,SAAS6U,QAAU/d,EAAKkJ,SAAS6U,SAAW,CAAC,EAClD/d,EAAKkJ,SAAS6U,QAAQP,KAAOF,EAAYE,MAEpCxd,GACN,KA2CHX,EAAAA,EAAAA,WAAU,KACR,IAAI2e,GAAS,EAYb,OAXAjP,iBACE,IACE,MAAME,QAAaC,EAAAA,GAAI+O,0BACvB,IAAKD,EAAQ,OACbxN,IAAsB,OAAJvB,QAAI,IAAJA,OAAI,EAAJA,EAAM3O,SAAU2O,GAAQ,KAC5C,CAAE,MAAO7K,GACP,IAAK4Z,EAAQ,OACbxN,GAAkB,KACpB,CACF,CACA0N,GACO,KACLF,GAAS,IAEV,KAEH3e,EAAAA,EAAAA,WAAU,MA1DV0P,iBACE9B,EAAO,IACPsF,IAAe,GACfE,GAAoB,uBACpB,IACE,MAAMpQ,QAAU6M,EAAAA,GAAIiP,UAAUtR,GAC9BE,EAAU1K,GAGV,IACE,MAAM+b,QAAelP,EAAAA,GAAImP,QACzBlR,EAAMiR,EACR,CAAE,MAAOha,GACP,CAGFqO,GAAoB,kCACpB,MAAM6L,QAAWpP,EAAAA,GAAIG,cAAcxC,EAAU,CAC3CyC,MAAO,GACPC,OAAQ,EACR3L,OAAQ,QACR4L,MAAO,oBAEHgO,EAAO9Z,MAAMC,QAAU,OAAF2a,QAAE,IAAFA,OAAE,EAAFA,EAAI7O,OAAS6O,EAAG7O,MAAQ,GACnDlB,GAAaiP,GACa,MAAtBhP,KACagP,EAAKe,KAAMC,GAAMte,OAAOse,EAAEnd,MAAQnB,OAAOsO,QAEtDiQ,EAAAA,EAAAA,IAAwB5R,EAAU,MAClC4B,GAAsB,QAG1B8D,IAAe,EAEjB,CAAE,MAAOpC,GACPlD,EAAOkD,EAAEE,SAAW,yBACpBkC,IAAe,EACjB,CACF,CAqBEmM,IACC,CAAC7R,KAEJxN,EAAAA,EAAAA,WAAU,MACR0P,iBACE,IAAKP,GAWH,OAVAjB,EAAoB,MACpBkD,GAAU,MACVM,GAAkB,MAClBQ,GAAU,MACV9D,EAAc,MACdE,EAAoB,MACpB2C,GAAQ,MACRW,GAAgB,MAChBC,GAAiB,gBACjBA,GAAiB,SAGnBjE,EAAO,IACPsE,GAAU,MACVI,GAAe,MACfE,GAAoB,MACpB,IAAK,IAAD8M,EACF,MAAM1P,QAAaC,EAAAA,GAAI0P,mBAAmB/R,EAAU2B,IAGpDjB,GAAwB,OAAJ0B,QAAI,IAAJA,OAAI,EAAJA,EAAM1O,WAAY,MAItC,MAAMjD,EAAU,OAAJ2R,QAAI,IAAJA,OAAI,EAAJA,EAAM7O,OACZye,EACJvhB,GAAsB,kBAARA,EACVyd,GAhS0B7C,KACpC,MAAM7V,EAAI6V,GAAO,CAAC,EACZ7R,EAAIhE,EAAEiT,eAA4C,kBAApBjT,EAAEiT,cAA6BjT,EAAEiT,cAAgB,CAAC,EAChFtV,EAAOka,gBAAgB7X,GAGvByc,EAAMzY,EAAE+B,WAAoC,kBAAhB/B,EAAE+B,UAAyB/B,EAAE+B,UAAY,CAAC,EACtE2W,EAAYjf,GAAO6B,OAAOuD,SAASvD,OAAO7B,IAAM6B,OAAO7B,GAAK,EA6ElE,OA5EAE,EAAKsV,cAAgB,CACnBlN,WAAS0H,EAAAA,EAAAA,IAAAA,EAAAA,EAAAA,GAAA,GACJgP,GAAG,IACNE,oBAAqBD,EAASD,EAAIE,qBAClCC,MAAOF,EAASD,EAAIG,OACpBC,MAAOH,EAASD,EAAII,OACpBC,MAAOJ,EAASD,EAAIK,OACpB9G,GAAI0G,EAASD,EAAIzG,IACjBsC,GAAIoE,EAASD,EAAInE,IACjBC,GAAImE,EAASD,EAAIlE,IACjBwE,oBAAqBL,EAASD,EAAIM,uBAEpCrW,WAAY1C,EAAE0C,YAAc,CAAEsW,MAAO,GAAIC,eAAgB,GAAIC,iBAAkB,IAC/EC,oBAAqBnZ,EAAEmZ,qBAAuB,CAC5CC,oBAAqB,GACrBC,uBAAwB,GACxBC,oBAAqB,EACrBC,gBAAiB,EACjBC,wBAAyB,EACzBC,eAAgB,GAChBC,wBAAyB,EACzBC,mBAAoB,GACpBC,iBAAkB,IAEpBjX,WAAWkX,EAAAA,EAAAA,IAAsB7Z,EAAE2C,WACnCyM,aAAa0K,EAAAA,EAAAA,IAAqB9Z,EAAEoP,aACpC2K,uBAA4D,mBAA7B/Z,EAAE+Z,wBAAuC/Z,EAAE+Z,uBAC1EC,mBAAoBha,EAAEga,oBAAsB,CAC1C1D,WAAY,EACZC,aAAc,EACdC,WAAY,EACZC,cAAe,EACfC,YAAa,EACbC,UAAW,EACXC,QAAS,GAEXqD,SAAUja,EAAEia,UAAY,CACtBC,6BAA8B,EAC9BC,wBAAyB,EACzBC,qBAAsB,EACtBC,4BAA6B,EAC7BC,YAAa,EACbC,iBAAkB,EAClBC,cAAe,GAEjBC,2BAA4Bza,EAAEya,4BAA8B,CAC1DC,iBAAkB,EAClBC,mBAAoB,EACpBC,aAAc,EACdC,gBAAiB,EACjBC,eAAgB,EAChBC,aAAc,EACdC,kBAAmB,EACnBC,+BAAgC,EAChCC,sBAAuB,EACvBC,eAAgB,EAChBC,mBAAoB,EACpBC,mBAAoB,EACpBC,oBAAqB,EACrBC,eAAgB,EAChBC,cAAe,EACfC,gBAAiB,EACjBC,qBAAsB,GAExBC,aAAc3b,EAAE2b,cAAgB,CAC9BrF,WAAY,CAAE1R,EAAG,EAAGC,EAAG,EAAG+W,EAAG,GAC7B9E,QAAS,CAAElS,EAAG,EAAGC,EAAG,EAAG+W,EAAG,GAC1B7E,SAAU,CAAEnS,EAAG,EAAGC,EAAG,EAAG+W,EAAG,GAC3B5E,KAAM,CAAEpS,EAAG,EAAGC,EAAG,EAAG+W,EAAG,IAEzBrZ,WAAYvC,EAAEuC,YAAc,CAC1BsZ,YAAa,CAAEC,cAAe,EAAGjZ,SAAU,EAAGC,SAAU,EAAGiZ,SAAU,EAAGC,iBAAkB,IAE5FxZ,cAA0C,kBAApBxC,EAAEwC,cAA6BxC,EAAEwC,cAAgB,IAGlE7I,GA4MyBsiB,CAA6BnI,GAAwB7c,KAC3EA,EACNmT,GAAUoO,GACV9N,GAAkB8N,GAAoC,kBAAfA,EAA0B3E,gBAAgB2E,GAAcA,GAC/F3N,GAAiB,WAEjB,MAAMnG,EAAc,QAAb4T,EAAO,OAAJ1P,QAAI,IAAJA,OAAI,EAAJA,EAAM5O,YAAI,IAAAse,EAAAA,EAAI,KACxBrO,GAAQvF,GACRkG,GAAgBlG,EAAImP,gBAAgBnP,GAAK,MACzCmG,GAAiB,QACnB,CAAE,MAAOf,GACPlD,EAAOkD,EAAEE,SAAW,iCACtB,CACF,CACAkS,IACC,CACD1V,EACA2B,GACA0C,GACAiJ,GACAY,MAGF1b,EAAAA,EAAAA,WAAU,KACR,IAAKmP,GAEH,YADAqE,GAA8BvT,QAAU,MAG1C,MAAMoQ,EAA6B,OAAhBpC,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkBjM,GACrC,IAAKqO,GAAcxP,OAAOwP,KAAgBxP,OAAOsO,IAAqB,OAEtE,MAAMgU,EACiC,WAArB,OAAhBlV,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkB4H,iBAClBvT,OAAuB,OAAhB2L,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkBmV,iBAAmB,IAC5B,OAAhBnV,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkB6H,qBACduN,EAAcxiB,OAAOwP,GAE3B,GAAImD,GAA8BvT,UAAYojB,EAG5C,OAFA9P,GAAkB4P,EAAU,QAAU,YACtC3P,GAA8BvT,QAAUojB,GAIrCF,GAA8B,QAAnB7P,IACdC,GAAkB,QAEnB,CACDpE,GACgB,OAAhBlB,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkBjM,GACF,OAAhBiM,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkB4H,eACF,OAAhB5H,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkBmV,gBACF,OAAhBnV,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkB6H,oBAClBxC,GACAC,MAIFvT,EAAAA,EAAAA,WAAU,MACR0P,iBACE,IACEtB,EAAc,MACdE,EAAoB,MACpB,MAAMgV,EAAuB,OAAhBrV,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkB0H,cAC/B,IAAK2N,GAAkB,OAATrU,SAAS,IAATA,KAAAA,GAAWnQ,OAAQ,OAEjC,MAAM,UAAEwM,EAAS,QAAEC,GAAYL,EAAkBoY,GACjD,IAAKhY,EAAW,OAChB,MAAMiY,EAAgBjY,EAAY,EAC5BkY,GAAsB,OAAPjY,QAAO,IAAPA,EAAAA,EAAWD,GAAa,EAEvCmY,EAAexU,GAAUsB,KAAMvN,IACnC,MAAM0gB,EAASxY,EAAmB,OAADlI,QAAC,IAADA,OAAC,EAADA,EAAG2S,eACpC,OAAO+N,EAAOpY,YAAciY,GAAiBG,EAAOnY,UAAYiY,IAElE,IAAKC,EAAc,OAEnBnV,EAAoBmV,GACpB,MAAM7T,QAAaC,EAAAA,GAAI8T,kBAAkBnW,EAAUiW,EAAazhB,IAChEoM,GAAkB,OAAJwB,QAAI,IAAJA,OAAI,EAAJA,EAAMoI,UAAW,KACjC,CAAE,MAAOjT,GACPqJ,EAAc,KAChB,CACF,CACAwV,IACC,CAACpW,EAA0B,OAAhBS,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkB0H,cAAe1G,KAE/C,MAAM4U,GAp/BR,SAA0B3iB,GACxB,MAAM4iB,EAASjjB,QAAe,OAARK,QAAQ,IAARA,OAAQ,EAARA,EAAU4iB,SAAU,SACpCC,EAAwC,OAAlB,OAAR7iB,QAAQ,IAARA,OAAQ,EAARA,EAAU8iB,cACxBC,EAA8B,OAAb,OAAR/iB,QAAQ,IAARA,OAAQ,EAARA,EAAUgjB,SACzB,MACa,sBAAXJ,GACW,cAAXA,GACY,aAAXA,GAAyBG,GACd,cAAXH,GAA0BC,CAE/B,CA0+ByBI,CAAiBlW,GAClCmW,GAAeP,IAAkBzP,GAEjCiQ,IAAiB5U,EAAAA,EAAAA,aAAYC,UACjC,IAAK1O,KAASmO,GAAoB,OAClC,MAAMmV,EAAc,OAAJtjB,SAAI,IAAJA,IAAAA,GAAM+X,MAClB,CAAEA,MAAO/X,GAAK+X,OACd,CACAwL,sBAAuBvjB,GAAKujB,sBAC5BC,sBAAuBxjB,GAAKwjB,6BAE1B3U,EAAAA,GAAIwU,eAAe7W,EAAU2B,GAAoBmV,GACvD,MAAM5Y,QAAUmE,EAAAA,GAAI4U,cAAcjX,EAAU2B,IAC5C8B,GAAQvF,GACRkG,GAAgBlG,EAAImP,gBAAgBnP,GAAK,MACzCmG,GAAiB,UAChB,CAAC7Q,GAAMmO,GAAoB3B,EAAUqE,KAGlC6S,IAAajV,EAAAA,EAAAA,aAAYC,UAC7B,IAAKP,KAAuBpO,GAAQ,OAAO,EAC3C,GAAIqjB,GAEF,OADAxW,EAAOiW,GAAiB,wCAA0C,wCAC3D,EAET,MAAMc,EAAmB1S,GAAe,WAClC2S,EAAiB3S,GAAe,SACtC,IAAK0S,IAAqBC,EAAgB,OAAO,EACjDtT,IAAgB,GAChB1D,EAAO,IACP,IACE,GAAI+W,EAAkB,CACpB,IAAIE,EAAUrM,GAA0BzX,IACxC8jB,EAAU/J,GAAwB+J,GAClCA,EAAUnJ,GAAsBmJ,GAChCA,EAAU/H,GAA0B+H,GAEhCA,IAAY9jB,IAAQqQ,GAAUyT,GAKlC,MAAMC,EAAuB,IAAIliB,IAC3BmiB,EAAa,GACnB,IAAK,MAAMC,KAAKzT,GAAY,CAC1B,MAAM0T,EAAUpkB,OAAOmkB,GAAK,IAC5B,GAAKC,EAAQjT,WAAW,WAAxB,CACA+S,EAAWvf,KAAKyf,GAChB,IAAK,MAAM1L,KAAK1R,EAAgBod,GAC9BH,EAAqB5Y,IAAIqN,EAHiB,CAK9C,CACA,MAAM2L,EAAoB7gB,MAAM8gB,KAAKL,SAC/BjV,EAAAA,GAAIuV,mBACR5X,EACA2B,GACA0V,EACAK,EACAH,GAEFrT,GAAkBmT,GAA8B,kBAAZA,EAAuBhK,gBAAgBgK,GAAWA,GACtFhT,GAAiB,UACnB,CAMA,OAJI+S,SACIP,KAER/R,GAAe0C,KAAKC,QACb,CACT,CAAE,MAAOnE,GACP,MAAM9S,EACJ2mB,GAAoBC,EAChB,cACAA,EACE,mBACA,qBAER,OADAhX,EAAOkD,EAAEE,SAAWhT,IACb,CACT,CAAC,QACCsT,IAAgB,EAClB,GACC,CACDkH,GACAsE,GACAhC,GACAY,GACAvM,GACApO,GACAqjB,GACAP,GACA5R,GACAV,GACA/D,EACAqE,GACAwS,KAKF,SAASgB,GAAmB7c,GAC1B,MAAMuD,EAAO1H,MAAMC,QAAQkE,GAAUA,EAAS,GAC9C,IAAI8c,EAAM,EACV,IAAK,MAAMlJ,KAAOrQ,EAAM,CAAC,IAADwZ,EACtB,MAAM7Z,EAAIpJ,OAA6B,QAAvBijB,EAAI,OAAHnJ,QAAG,IAAHA,OAAG,EAAHA,EAAKL,yBAAiB,IAAAwJ,EAAAA,EAAI,GACvCjjB,OAAOuD,SAAS6F,KAAI4Z,GAAO5Z,EACjC,CACA,OAAO4Z,CACT,CAaA,SAASE,GAAkBxU,GAAsC,IAA7ByU,EAAO5mB,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,iBAE5C+R,EAAAA,GAAM8U,KAAK1U,EAAS,CAClByU,UACAE,SAAU,eACVC,WAAW,EACXC,cAAc,EACdC,WAAW,EACXC,KAAM,KACNC,MAAO,CACLC,WAAY,yBACZC,MAAO,UACPC,OAAQ,qCACRC,UAAW,8BACXC,aAAc,KAGpB,CAEA,SAASC,KAAsD,IAAxBC,EAAW1nB,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,QAEnD,IAAKkC,GAAQ,OAAO,EACpB,GAAI0B,GAAM,OAAO,EAEjB,MAAM+jB,EAnCR,SAAuCC,GACrC,MAAMzjB,EAAIyjB,GAAkC,kBAAdA,EAAyBA,EAAY,CAAC,EAC9D1N,EAAQ/V,EAAEiZ,aAAwC,kBAAlBjZ,EAAEiZ,YAA2BjZ,EAAEiZ,YAAc,CAAC,EACpF,MAAO,CACLjD,GAAIqM,GAAmBhhB,MAAMC,QAAQyU,EAAMC,IAAMD,EAAMC,GAAKhW,EAAEwF,QAC9D8S,GAAI+J,GAAmBtM,EAAMuC,IAC7BC,GAAI8J,GAAmBtM,EAAMwC,IAEjC,CA2BiBmL,CAA8B3lB,IACvCkE,EAAU,GAGhB,GAFMuhB,EAAOlL,GAAK,GAAIrW,EAAQO,KAAK,MAC7BghB,EAAOjL,GAAK,GAAItW,EAAQO,KAAK,OAC9BP,EAAQnG,OAAQ,OAAO,EAE5B,MAAM6nB,EACJ,GAAAjnB,OAAG6mB,EAAW,8DAAA7mB,OACXuF,EAAQoC,KAAK,QAAO,uEAOzB,OAJAuG,EAAO,IACP4X,GAAkBmB,EAAK,qBAEX,SAARtgB,IAAgBiO,GAAO,SACpB,CACT,CAEA,SAASsS,KACP,IAAK7lB,GAAQ,OAAO,EACpB,IAAKgV,GAAiB,OAAO,EAC7B,IAAKI,GAAmB,OAAO,EAE/B,MAAMwQ,EACJ,GAAAjnB,OANyCb,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,QAM9B,iHAMhB,OAHA+O,EAAO,IACP4X,GAAkBmB,EAAK,4BACX,WAARtgB,IAAkBiO,GAAO,WACtB,CACT,CAGA5E,eAAemX,KAAyB,IAAfC,EAAOjoB,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,CAAC,EAClC,IAAKsQ,GAAoB,OAAO,EAChC,IAAKyX,GAAyB,aAAc,OAAO,EACnD,IAAKE,EAAQC,qBAAuBT,GAA8B,aAAc,OAAO,EACvFlU,IAAe,GACfxE,EAAO,IACP,IAAIzI,GAAK,EACT,IACE,MAAMyK,QAAaC,EAAAA,GAAI8T,kBAAkBnW,EAAU2B,IAChC,gBAAfsE,SACIoE,GAAoB,eAE1B3F,GAAUtC,EAAKoI,SAEZ8O,EAAQE,SAAS1S,GAAO,UAC7B9B,GAAoBwC,KAAKC,OACH,qBAAX/W,QAET+oB,QAAQC,IAAI,qBAAsB,CAChC7W,WAAYlB,GACZgY,WAAYviB,QAAY,OAAJgL,QAAI,IAAJA,OAAI,EAAJA,EAAMoI,WAG9B7S,GAAK,CACP,CAAE,MAAO2L,GACPlD,EAAOkD,EAAEE,SAAW,sBACE,qBAAX9S,QACT+oB,QAAQC,IAAI,yBAA0B,CACpC7W,WAAYlB,GACZ4B,OAAQ,OAADD,QAAC,IAADA,OAAC,EAADA,EAAGE,UAAWF,GAG3B,CAAC,QACCsB,IAAe,EACjB,CACA,OAAOjN,CACT,CA+CA,SAASiiB,GAAYxb,EAAGC,GACtB,OAAS,MAALD,GAAkB,MAALC,IACA,kBAAND,GAA+B,kBAANC,EAAuBvJ,OAAOsJ,KAAOtJ,OAAOuJ,GAC/D,mBAAND,GAAgC,mBAANC,EAAwBjH,QAAQgH,KAAOhH,QAAQiH,GAC7EhK,OAAOwlB,GAAGzb,EAAGC,GACtB,CAEA,SAASyb,GAAeC,EAAKC,GAC3B,IAAIC,EAAMF,EACV,IAAK,MAAMjb,KAAQkb,EAAO,CACxB,GAAW,MAAPC,EAAa,OAEjB,GAAIpjB,MAAMC,QAAQmjB,GAAM,CACtB,MAAMlb,EAAQkb,EAAIlX,KAAM9D,GAASA,GAAwB,kBAATA,GAAqB,QAASA,GAAQ5L,OAAO4L,EAAK1O,OAASuO,GAC3G,GAAIC,EAAO,CACTkb,EAAMlb,EACN,QACF,CAEA,MAAMG,EAAS+a,EAAIlX,KAAM9D,GAASA,GAAwB,kBAATA,GAAqB,SAAUA,GAAQ5L,OAAO4L,EAAKhO,QAAU6N,GAC9G,GAAII,EAAQ,CACV+a,EAAM/a,EACN,QACF,CAEA,MAAMC,EAAU8a,EAAIlX,KAAM9D,GAASA,GAAwB,kBAATA,GAAqB,UAAWA,GAAQ5L,OAAO4L,EAAKG,SAAWN,GACjH,GAAIK,EAAS,CACX8a,EAAM9a,EACN,QACF,CAEA,MAAME,EAAMvK,OAAOgK,GACnB,GAAIhK,OAAOwK,UAAUD,IAAQhM,OAAOgM,KAASP,EAAM,CACjDmb,EAAMA,EAAI5a,GACV,QACF,CAEA,MACF,CAEA,GAAmB,kBAAR4a,EAAkB,OAC7BA,EAAMA,EAAInb,EACZ,CACA,OAAOmb,CACT,CAGA,MAAMC,IAAmBjY,EAAAA,EAAAA,aACtB3H,IACC,IAAKA,EAAM,OACX,MAAM0f,EAAQ1f,EAAKE,MAAM,KACzB,GAAKwf,EAAM1oB,OAAX,CACA,GAAiB,WAAb0oB,EAAM,GAAiB,CACzB,MAAMvb,EAAMqb,GAAe7V,GAAgB+V,EAAMrb,MAAM,IACvD,QAAYpN,IAARkN,EAAmB,OAAOA,EAE9B,MAAM0b,EAAOH,EAAMA,EAAM1oB,OAAS,GAGlC,GAAI6oB,EAAKC,SAAS,OAASD,EAAKC,SAAS,MAAO,CAC9C,MAAMC,EAASF,EAAKC,SAAS,MAAQ,KAAO,KACtCE,EAAYH,EAAKxb,MAAM,GAAI,GAC3B4b,EAAUT,GAAe7V,GAAgB+V,EAAMrb,MAAM,GAAI,GAAGzM,OAAOooB,IACzE,QAAgB/oB,IAAZgpB,EAAuB,CAEzB,GAAkB,aAAdD,GAA4BA,EAAU9V,WAAW,YAAa,CAChE,MAAMgW,EAAOV,GAAe7V,GAAgB,CAAC,gBAAiB,eAAiB,CAAC,EAC1EwW,EAAM,EAAI3lB,QAAW,OAAJ0lB,QAAI,IAAJA,OAAI,EAAJA,EAAM1M,KAAM,GAC7B4M,EAAMD,GAAO,EAAI3lB,QAAW,OAAJ0lB,QAAI,IAAJA,OAAI,EAAJA,EAAMzM,KAAM,IAC1C,MAAkB,OAAXsM,EAAkBvlB,OAAOylB,GAAWE,EAAM3lB,OAAOylB,GAAWG,CACrE,CAEA,OAAOH,CACT,CACF,CAGA,IAAc,mBAATJ,GAAsC,mBAATA,IAA8BlW,GAAgB,CAC9E,MAAM0W,EAASb,GAAe7V,GAAgB+V,EAAMrb,MAAM,GAAI,IAC9D,GAAIgc,GAA4B,kBAAXA,EAAqB,CACxC,MAAMlJ,EAAKkJ,EAAO1J,aAClB,GAAU,MAANQ,EAAY,OAAOA,CACzB,CACF,CAGA,MAAMmJ,EAAWZ,EAAMa,QAAQ,SAC/B,GAAID,GAAY,GAAKZ,EAAM1oB,OAASspB,EAAW,GAAK3W,GAAgB,CAClE,MAAM6W,EAAUd,EAAMY,EAAW,GACjC,GAAgB,OAAZE,GAAgC,OAAZA,EAAkB,CACxC,MAAMC,EAAW,IAAIf,GACrBe,EAASH,EAAW,GAAK,KACzB,MAAMI,EAASlB,GAAe7V,GAAgB8W,EAASpc,MAAM,IAC7D,QAAepN,IAAXypB,EAAsB,CACxB,GAAIhB,EAAMnT,SAAS,OAASmT,EAAMnT,SAAS,aAAc,CACvD,MAAMoU,EAAQnB,GAAe7V,GAAgB,CAAC,KAAM,kBAC9C8H,EAAIjX,OAAOmmB,GACjB,GAAInmB,OAAOuD,SAAS0T,GAAI,CACtB,MAAMtX,EAAOK,OAAOkmB,GACdE,EAAyB,OAAZJ,EAAmB/O,EAAIA,EAAIA,EAC9C,OAAOjX,OAAOuD,SAAS5D,GAAQA,EAAOymB,OAAa3pB,CACrD,CACF,CACA,OAAOypB,CACT,CACF,CACF,CAGA,GAAoC,aAAhChB,EAAMrb,MAAM,EAAG,GAAG9E,KAAK,MAAuBoK,GAAgB,CAChE,GAAI+V,EAAMnT,SAAS,iBAAkB,CACnC,MAAMsU,EAAIrB,GAAe7V,GAAgB,CAAC,KAAM,kBAChD,YAAU1S,IAAN4pB,EAAwBA,EACrB,CACT,CAEA,GADuB,CAAC,YAAa,qBAClBzJ,KAAM0D,GAAM4E,EAAMnT,SAASuO,IAC5C,OAAO,CAEX,CAGA,IAAc,OAAT+E,GAA0B,OAATA,GAA0B,OAATA,IAAkBlW,GAAgB,CACvE,MAAM0W,EAASb,GAAe7V,GAAgB+V,EAAMrb,MAAM,GAAI,IAC9D,GAAIgc,GAA4B,kBAAXA,GAAoC,MAAbA,EAAOnP,GAAY,OAAOmP,EAAOnP,GAE7E,MAAM4P,EAAQpB,EAAMa,QAAQ,YAC5B,GAAIO,GAAS,GAAKpB,EAAM1oB,OAAS8pB,EAAQ,EAAG,CAC1C,MAAMC,EAASrB,EAAMoB,EAAQ,GACvBE,EAAMxB,GAAe7V,GAAgB,CAAC,WAAY,WAAYoX,EAAQ,OAAQ,OACpF,QAAY9pB,IAAR+pB,EAAmB,OAAOA,CAChC,CAEA,MAAMC,EAAUzB,GAAe7V,GAAgB,CAAC,WAAY,QAAS,OACrE,QAAgB1S,IAAZgqB,EAAuB,OAAOA,CACpC,CAGA,GAAa,QAATpB,GAAkBlW,GAAgB,CACpC,MAAMmX,EAAQpB,EAAMa,QAAQ,YAC5B,GAAIO,GAAS,GAAKpB,EAAM1oB,OAAS8pB,EAAQ,EAAG,CAC1C,MAAMC,EAASrB,EAAMoB,EAAQ,GACvBE,EAAMxB,GAAe7V,GAAgB,CAAC,WAAY,WAAYoX,EAAQ,OAAQ,QACpF,QAAY9pB,IAAR+pB,EAAmB,OAAOA,CAChC,CACA,MAAME,EAAS1B,GAAe7V,GAAgB,CAAC,WAAY,oBAC3D,QAAe1S,IAAXiqB,EAAsB,OAAOA,CACnC,CAEA,MACF,CACA,MAAiB,SAAbxB,EAAM,GAAsBF,GAAe3V,GAAc6V,EAAMrb,MAAM,SAAzE,CApGmC,GAuGrC,CAACsF,GAAgBE,KAIbsX,GAAchX,GAAe,YAAcA,GAAe,SAC1DiX,IAAuBzZ,EAAAA,EAAAA,aAAYC,UACvC,GAAKsE,GAAL,CACA,GAAIiV,GAAa,CAEf,UADiBvE,KACR,MACX,OACMhU,GAAesD,GALI,GAMxB,CAACA,GAAciV,GAAavE,GAAYhU,KACrCyY,IAAuB1Z,EAAAA,EAAAA,aAC3BC,iBAA+B,IAAxB0Z,EAAMvqB,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,UACd,GAAKmV,IAAiC,OAAhB/F,QAAgB,IAAhBA,GAAAA,EAAkBjM,KACpC+M,EAAJ,CACAC,GAAqB,GACrB,UACQa,EAAAA,GAAIwZ,eAAe7b,EAAUS,EAAiBjM,GAAIgS,GAAc,CAAEoV,WACxExY,EAAAA,GAAMC,QAAmB,YAAXuY,EAAuB,iBAAc,wBAC7C5Z,WACAO,IACR,CAAE,MAAOe,GACPF,EAAAA,GAAMG,OAAO,OAADD,QAAC,IAADA,OAAC,EAADA,EAAGE,UAAW,2CAC5B,CAAC,QACChC,GAAqB,EACvB,CAX6B,CAY/B,EACA,CAACgF,GAA8B,OAAhB/F,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkBjM,GAAI+M,EAAmBvB,EAAUgC,GAAkBO,KAEhFuZ,GAAOzoB,QAAS,OAAFgN,QAAE,IAAFA,OAAE,EAAFA,EAAIyb,OAAQ,IAI1BC,GAAqBN,MADzBjV,IAAoC,cAApBG,IAAmCmV,MAFvB,eAATA,KAIfE,GACgB,cAApBrV,GACI,mBACoB,aAApBA,GACE,kBACA,gBACFsV,GAAqB5F,GACvB,kBACAzP,GACEoV,GACA,GACAE,KAAmB1V,KACpBrF,EAAgB7P,OACf6P,EAAgB0F,SAASL,KACxBvR,IAAOwI,EAAqBtH,IAAIqQ,KAEjC2V,GACJ3V,IACA0V,KACC7F,IACD,CAAC,cAAe,cAAe,kBAAkBxP,SAASF,IACtDyV,IAAYna,EAAAA,EAAAA,aAChB,CAAC3H,EAAM5H,KACL,IAAK4H,EAAM,OACX,GAAIsc,KAAiBtc,EAAKkK,WAAW,YAAclK,EAAKkK,WAAW,UAAW,OAC1ElK,EAAKkK,WAAW,YAClBZ,GAAWZ,IACT,IAAKA,EAAM,OAAOA,EAClB,MAAMgX,EAAQ1f,EAAKE,MAAM,KAEzB,GAAIof,GADYE,GAAe9W,EAAMgX,EAAMrb,MAAM,IACxBjM,GAAQ,OAAOsQ,EACxC,MAAM7P,EAAOka,gBAAgBrK,GACvBrL,EA13ChB,SAAwBoiB,EAAKC,EAAOtnB,GAClC,IAAKqnB,IAAQljB,MAAMC,QAAQkjB,KAAWA,EAAM1oB,OAAQ,OAAO,EAC3D,IAAI2oB,EAAMF,EACV,IAAK,IAAIsC,EAAI,EAAGA,EAAIrC,EAAM1oB,OAAS,EAAG+qB,IAAK,CACzC,MAAMvd,EAAOkb,EAAMqC,GACnB,GAAW,MAAPpC,EAAa,OAAO,EACxB,GAAIpjB,MAAMC,QAAQmjB,GAAM,CACtB,MAAM5a,EAAMT,EAAmBqb,EAAKnb,GACpC,GAAIO,EAAM,EAAG,OAAO,EACJ,MAAZ4a,EAAI5a,IAAoC,kBAAb4a,EAAI5a,KAAmB4a,EAAI5a,GAAO,CAAC,GAClE4a,EAAMA,EAAI5a,GACV,QACF,CACA,GAAmB,kBAAR4a,EAAkB,OAAO,EACnB,MAAbA,EAAInb,IAAsC,kBAAdmb,EAAInb,KAAoBmb,EAAInb,GAAQ,CAAC,GACrEmb,EAAMA,EAAInb,EACZ,CACA,MAAMqb,EAAOH,EAAMA,EAAM1oB,OAAS,GAClC,GAAIuF,MAAMC,QAAQmjB,GAAM,CACtB,MAAM5a,EAAMT,EAAmBqb,EAAKE,GACpC,QAAI9a,EAAM,KACV4a,EAAI5a,GAAO3M,GACJ,EACT,CACA,OAAW,MAAPunB,GAA8B,kBAARA,IAC1BA,EAAIE,GAAQznB,GACL,EACT,CA+1CqB4pB,CAAenpB,EAAM6mB,EAAMrb,MAAM,GAAIjM,GAChD,OAAOiF,EAAKxE,EAAO6P,IAGvB,MAAMuZ,EAAgBrC,GAAiB5f,GACjCkiB,EAAO5C,GAAYlnB,EAAO6pB,GAChCvY,GAAehB,IACb,MAAM7P,EAAO,IAAIiC,IAAI4N,GAGrB,OAFIwZ,EAAMrpB,EAAKspB,OAAOniB,GACjBnH,EAAKuL,IAAIpE,GAhPpB,SAAsB8D,EAAGC,GACvB,GAAID,IAAMC,EAAG,OAAO,EACpB,GAAID,EAAEkG,OAASjG,EAAEiG,KAAM,OAAO,EAC9B,IAAK,MAAMrR,KAAKmL,EACd,IAAKC,EAAElI,IAAIlD,GAAI,OAAO,EAExB,OAAO,CACT,CA0OaypB,CAAa1Z,EAAM7P,GAAQ6P,EAAO7P,KAG7C,CAACyjB,GAAcsD,GAAkBtW,MAmBnCpR,EAAAA,EAAAA,WAAU,KAIR,MAAMmqB,EAAsB/U,IAKtBmU,KACFnU,EAAMgV,iBAENhV,EAAMiV,YAAc,KAWxB,OANId,IACFrrB,OAAOsX,iBAAiB,eAAgB2U,GAKnC,KACLjsB,OAAOuX,oBAAoB,eAAgB0U,KAE5C,CAACZ,MAWJvpB,EAAAA,EAAAA,WAAU,KACR,IACE9B,OAAOosB,mBAAqBf,EAC9B,CAAE,MAAOxkB,GACP,CAEF,MAAO,KACL,IAEE7G,OAAOosB,oBAAqB,CAC9B,CAAE,MAAOvlB,GAAK,IAEf,CAACwkB,KACJ,MAAMgB,GAAyBhW,EAAAA,YAC5BiW,IACC,GAAIpG,GAAc,OAClB,MAAMzK,GAAoB,OAAZ6Q,QAAY,IAAZA,OAAY,EAAZA,EAAcxR,KAAM,CAAC,EAC7BlX,EAAO,CACX,mBACA,yBACA,oBACA,0BACA,6BAGFsP,GAAWZ,IAAU,IAADia,EAAAC,EAClB,MAAM1F,EAAIxU,GAAQ,CAAC,EACbiK,GAAa,OAADuK,QAAC,IAADA,GAAW,QAAVyF,EAADzF,EAAGlb,gBAAQ,IAAA2gB,GAAS,QAATC,EAAXD,EAAa/P,eAAO,IAAAgQ,OAAnB,EAADA,EAAsBta,QAAS,CAAC,EAElD,IAAI2B,GAAU,EACd,IAAK,MAAM4I,KAAK7Y,EAAM,CACpB,MAAM8J,EAAItJ,QAAgB,OAATmY,QAAS,IAATA,OAAS,EAATA,EAAYE,KAAM,GAC7B9O,EAAIvJ,QAAY,OAALqX,QAAK,IAALA,OAAK,EAALA,EAAQgB,KAAM,GAC/B,GAAI5U,KAAK6U,IAAIhP,EAAIC,GAAK,KAAM,CAC1BkG,GAAU,EACV,KACF,CACF,CACA,IAAKA,EAAS,OAAOvB,EAErB,MAAM7P,EAAOka,gBAAgBmK,GAC7BrkB,EAAKmJ,SAAWnJ,EAAKmJ,UAAY,CAAC,EAClCnJ,EAAKmJ,SAAS4Q,QAAU/Z,EAAKmJ,SAAS4Q,SAAW,CAAC,EAClD/Z,EAAKmJ,SAAS4Q,QAAQtK,MAAQzP,EAAKmJ,SAAS4Q,QAAQtK,OAAS,CAAC,EAC9D,IAAK,MAAMuK,KAAK7Y,EAAMnB,EAAKmJ,SAAS4Q,QAAQtK,MAAMuK,GAAKrY,QAAY,OAALqX,QAAK,IAALA,OAAK,EAALA,EAAQgB,KAAM,GAC5E,GAAI9D,GAGF,IAAK,MAAM8D,KAAK7Y,EACd8nB,GAAU,iCAADlqB,OAAkCib,GAAKrY,QAAY,OAALqX,QAAK,IAALA,OAAK,EAALA,EAAQgB,KAAM,IAGzE,OAAOha,KAGX,CAACyjB,GAAcwF,GAAW/S,KAEtB8T,GAA6BpW,EAAAA,YAChC9T,IACK2jB,IACC3jB,GAAkB,kBAANA,GACjB2Q,GAAWZ,IAET,IAAI7P,EAAOka,gBADDrK,GAAQ,CAAC,GAKnB,OAHA7P,EAAKsb,YAAcxb,EACf4D,MAAMC,QAAQ7D,EAAEuY,MAAKrY,EAAK6H,OAASqS,gBAAgBpa,EAAEuY,KACzDrY,EAAOmc,GAA0Bnc,GAC1BA,KAGX,CAACmc,GAA2BsH,KAExBwG,IAAcnb,EAAAA,EAAAA,aACjBob,IACKzG,IACJnT,GAAST,GAA6B,oBAAZqa,EAAyBA,EAAQra,GAAQqa,IAErE,CAACzG,GAAcnT,KAEX6Z,GAAmB1gB,EAAkBzG,IAAI0C,IACzC0kB,GAAiB1Z,IAAgBc,IAAeY,KAAiBpI,GACjEqgB,GAAkBC,IACtB,IAAKA,EAAI,MAAO,GAChB,MAAMC,EAAOnlB,KAAKC,IAAI,GAAIyM,IAAWuC,KAAKC,OAASgW,GACnD,OAAIC,EAAO,IAAc,UACrBA,EAAO,KAAe,GAANxrB,OAAUqG,KAAKolB,MAAMD,EAAO,KAAM,YAChD,GAANxrB,OAAUqG,KAAKolB,MAAMD,EAAO,MAAQ,eAmCtC,SAASE,GAAsBjlB,GAC7B,OAAQA,GACN,IAAK,iBACH,MAAO,SACT,IAAK,mBACL,IAAK,kBACL,IAAK,yBACH,MAAO,UACT,IAAK,iBACL,IAAK,iBACH,MAAO,QAET,QACE,MAAO,WAEb,EAxCAnG,EAAAA,EAAAA,WAAU,KACJ+qB,IAAgBnY,IAAc,IACjC,CAACmY,KAyuBJ,MAAMM,GAAqB,CACzB7d,WACAC,SACAI,KACA9M,UACAuqB,SAzoCF,SAAkBxjB,EAAM5H,GACtB,GAAIkkB,GAAc,OAClB,MAAMzjB,EAAOka,gBAAgB9Z,IAAU,CAAC,GAClCe,EAAOgG,EAAKE,MAAM,KACxB,IAAIuf,EAAM5mB,EACV,IAAK,IAAIkpB,EAAI,EAAGA,EAAI/nB,EAAKhD,OAAS,EAAG+qB,IACnCtC,EAAIzlB,EAAK+nB,IAAMtC,EAAIzlB,EAAK+nB,KAAO,CAAC,EAChCtC,EAAMA,EAAIzlB,EAAK+nB,IAEjBtC,EAAIzlB,EAAKA,EAAKhD,OAAS,IAAMoB,EAC7BkR,GAAUzQ,EACZ,EA+nCEK,QACAiQ,QAAS2Z,GACTD,8BACApZ,cACAqY,aACAlU,YACAU,eACAR,qBACA3H,mBACAE,aACAE,mBACA1D,UACA2I,kBACAC,qBACAE,cACAE,qBACAsE,0BACApE,sBACAC,yBACAhB,mBACAoE,WACAC,cACAE,kBACAC,oBACAG,wBACApE,cACAkX,0BAGAhc,YACAiB,oBACAkB,mBAGF,OACE6a,EAAAA,EAAAA,MAAA,OAAKC,UAAU,wBAAuBC,SAAA,EACpCC,EAAAA,EAAAA,KAACC,EAAAA,GAAc,CAAChG,SAAS,eAAeC,UAAW,KAAMgG,aAAW,EAAC/F,cAAY,EAACgG,kBAAgB,EAACC,cAAY,EAACC,iBAAe,EAACC,MAAM,UACtIN,EAAAA,EAAAA,KAAA,SAAAD,SAAA,wDACCxY,IACCyY,EAAAA,EAAAA,KAAA,OAAKF,UAAU,iBAAiBlC,KAAK,SAAS,YAAU,SAAS,YAAU,OAAMmC,UAC/EF,EAAAA,EAAAA,MAAA,OACEC,UAAU,OACVxF,MAAO,CACLiG,MAAO,mBACPC,QAAS,YACTC,UAAW,UACXV,SAAA,EAEFC,EAAAA,EAAAA,KAAA,OACE,iBACA1F,MAAO,CACLiG,MAAO,GACPG,OAAQ,GACRC,OAAQ,SACRhG,aAAc,MACdF,OAAQ,4BACRmG,eAAgB,kBAChBC,UAAW,qCAGfb,EAAAA,EAAAA,KAAA,OAAK1F,MAAO,CAAEwG,WAAY,IAAKC,UAAW,IAAKhB,SAC5CtY,IAAoB,mBAEvBuY,EAAAA,EAAAA,KAAA,OAAKF,UAAU,cAAcxF,MAAO,CAAEyG,UAAW,GAAIhB,SAAC,4BAKxD,KAEH9d,GACC+d,EAAAA,EAAAA,KAAA,OACEF,UAAU,OACVxF,MAAO,CACLyG,UAAW,GACXxG,WAAY,UACZyG,YAAa,WACbjB,SAED9d,IAED,KAEFwB,IAgBAuc,EAAAA,EAAAA,KAACiB,EAAAA,GAAM,CAACzoB,QAASmnB,MAfjBE,EAAAA,EAAAA,MAAA,OAAKC,UAAU,OAAOxF,MAAO,CAAEyG,UAAW,IAAKhB,SAAA,EAC7CC,EAAAA,EAAAA,KAAA,OAAK1F,MAAO,CAAEwG,WAAY,KAAMf,SAAC,wBACjCC,EAAAA,EAAAA,KAAA,OAAKF,UAAU,QAAQxF,MAAO,CAAEyG,UAAW,GAAIhB,SAAC,sDAGhDC,EAAAA,EAAAA,KAAA,UACEtmB,KAAK,SACLomB,UAAU,cACVxF,MAAO,CAAEyG,UAAW,IACpBG,QAASA,IAAMxf,EAAS,oBAAD1N,OAAqB8N,IAAYie,SACzD,0BAnwBT,WAA+B,IAADoB,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAC5B,IAAK5C,GAAkB,OAAO,KAG9B,MAAM6C,EAAoB,CACxBC,MAAO,iBACP1jB,SAAU,WACVlJ,KAAM,qBACN+I,GAAI,iBACJ8jB,MAAO,oBACPC,MAAO,oBAYHC,EAAgB,GAChBC,EAAiB,eACnB9W,IAAWA,GAAQjB,eACrB8X,EAAcvoB,KAAK,CACjBzH,IAAK,QACLoI,MAAO1D,GAAI,QAAA/C,OAAWsuB,GAAmB,QACzCC,WAAY,QACZ/mB,IAAKuE,EAASyL,GAAQjB,eACtBlS,MAAqC,IAA/BmT,GAAQjB,cAAclS,KAC5BmqB,WAAYzrB,KAGZyU,IAAWA,GAAQhN,UACrB6jB,EAAcvoB,KAAK,CACjBzH,IAAK,WACLoI,MAAO1D,GAAI,WAAA/C,OAAcsuB,GAAmB,WAC5CC,WAAY,MACZ/mB,IAAKuE,EAASyL,GAAQhN,UACtBnG,MAAgC,IAA1BmT,GAAQhN,SAASnG,KACvBmqB,WAAYzrB,KAIhB,MAAM0rB,EAAWrX,IACkB,KAAvB,OAAPI,SAAO,IAAPA,IAAmB,QAAZ2V,EAAP3V,GAASE,kBAAU,IAAAyV,OAAZ,EAAPA,EAAqB9oB,YAA+ChF,KAAvB,OAAPmY,SAAO,IAAPA,IAAmB,QAAZ4V,EAAP5V,GAASE,kBAAU,IAAA0V,OAAZ,EAAPA,EAAqB/oB,QAC7B,KAAvB,OAAPmT,SAAO,IAAPA,IAAmB,QAAZ6V,EAAP7V,GAASE,kBAAU,IAAA2V,OAAZ,EAAPA,EAAqBhpB,YAA+ChF,KAAvB,OAAPmY,SAAO,IAAPA,IAAmB,QAAZ8V,EAAP9V,GAASE,kBAAU,IAAA4V,OAAZ,EAAPA,EAAqBjpB,UACnC,KAAjB,OAAPmT,SAAO,IAAPA,IAAa,QAAN+V,EAAP/V,GAASlW,YAAI,IAAAisB,OAAN,EAAPA,EAAelpB,YAAyChF,KAAjB,OAAPmY,SAAO,IAAPA,IAAa,QAANgW,EAAPhW,GAASlW,YAAI,IAAAksB,OAAN,EAAPA,EAAenpB,OACpDgqB,EAAcvoB,KAAK,CACjBzH,IAAK,OACLoI,MAAO1D,GAAI,OAAA/C,OAAUsuB,GAAmB,OACxCC,WAAY,OACZ/mB,IAAK5E,OAAOuD,SAASsR,IAAcA,GAAa,EAChDpT,KAAMoqB,EACND,WAAYzrB,KAEVyU,IAAWA,GAAQnN,IACrBgkB,EAAcvoB,KAAK,CACjBzH,IAAK,KACLoI,MAAO,KACP8nB,WAAY,KACZ/mB,IAAKuE,EAASyL,GAAQnN,IACtBhG,MAA0B,IAApBmT,GAAQnN,GAAGhG,OAGjBmT,IAAWA,GAAQrN,UACrBkkB,EAAcvoB,KAAK,CACjBzH,IAAK,QACLoI,MAAO,QACP8nB,WAAY,MACZ/mB,IAAKuE,EAASyL,GAAQrN,UACtB9F,MAAgC,IAA1BmT,GAAQrN,SAAS9F,OAI3B,MAAMqqB,EAAY3rB,IACe,KAArB,OAAPyU,SAAO,IAAPA,IAAiB,QAAViW,EAAPjW,GAASpN,gBAAQ,IAAAqjB,OAAV,EAAPA,EAAmBppB,YAA6ChF,KAArB,OAAPmY,SAAO,IAAPA,IAAiB,QAAVkW,EAAPlW,GAASpN,gBAAQ,IAAAsjB,OAAV,EAAPA,EAAmBrpB,QAC3B,KAArB,OAAPmT,SAAO,IAAPA,IAAiB,QAAVmW,EAAPnW,GAASpN,gBAAQ,IAAAujB,OAAV,EAAPA,EAAmBtpB,YAA6ChF,KAArB,OAAPmY,SAAO,IAAPA,IAAiB,QAAVoW,EAAPpW,GAASpN,gBAAQ,IAAAwjB,OAAV,EAAPA,EAAmBvpB,UAC1B,KAAtB,OAAPmT,SAAO,IAAPA,IAAkB,QAAXqW,EAAPrW,GAASlN,iBAAS,IAAAujB,OAAX,EAAPA,EAAoBxpB,YAA8ChF,KAAtB,OAAPmY,SAAO,IAAPA,IAAkB,QAAXsW,EAAPtW,GAASlN,iBAAS,IAAAwjB,OAAX,EAAPA,EAAoBzpB,OAC9DgqB,EAAcvoB,KAAK,CACjBzH,IAAK,QACLoI,MAAO,QACP8nB,WAAY,MACZ/mB,IAAK5E,OAAOuD,SAASwR,IAAkBA,GAAiB,EACxDtT,KAAMqqB,IAER,MACMC,EADkBN,EAAcvpB,OAAQ2X,IAAOA,EAAE+R,YAChBI,MAAOnS,GAAMA,EAAEpY,MAEhDwqB,EAAsC,OAAhBtgB,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkBugB,aAGxCC,EAAqBxgB,EAnK7B,SAA+BjL,EAAG0rB,GAChC,IAAK1rB,EAAG,OAAO,KACf,MAAM8gB,EAASjjB,OAAOmC,EAAE8gB,QAAU,SAElC,GAAe,UAAXA,EAAoB,CACtB,MAAM5c,EAAM5E,OAAOosB,GACnB,OAAIpsB,OAAOuD,SAASqB,IAAQA,EAAM,EAAU,yBACrC,QACT,CACA,MAAe,cAAX4c,EAA+B,kBACpB,uBAAXA,EAAwC,iBAC7B,sBAAXA,GAA6C,cAAXA,EAA+B,mBACtD,aAAXA,EAEE9gB,EAAEkhB,QAAgB,iBACf,iBAEF,QACT,CAiJgDyK,CAAsB1gB,EAAkBsgB,GAAuB,KACvGK,EACJH,GACA,CAAC,kBAAc,iBAAkB,mBAAoB,iBAAkB,kBAAapa,SAClFoa,GAEEA,EACA,KACAI,EAAuBD,EAAuBxD,GAAsBwD,GAAwB,KAC5FE,EAAgBrgB,GAAmBuF,GAzI3C,SAA+BnU,GAC7B,OAAQgB,OAAOhB,GAAS,gBACtB,IAAK,WACH,MAAO,iBACT,IAAK,iBACH,MAAO,iBACT,IAAK,YACH,MAAO,kBACT,IAAK,cACH,MAAO,yBACT,QACE,MAAO,SAEb,CA4H0DkvB,CAAsB5a,IAAmB,KAC3F6a,EAAgBF,EAAgB1D,GAAsB0D,GAAiB,KACvEG,EAAqBrqB,QAAQoP,IAAgB8a,GAEnD,IAAII,EAAkB,KACtB,GAA6B,mBAAzBN,GAA6D,OAAhB3gB,QAAgB,IAAhBA,GAAAA,EAAkBkhB,WAAY,CAC7E,MAAMloB,EAAI,IAAI+N,KAAK/G,EAAiBkhB,YACpCD,EAAe,YAAAxvB,OAAe4C,OAAOuD,SAASoB,EAAEmoB,WAAanoB,EAAEooB,iBAAmB,GACpF,MAAO,GAA6B,qBAAzBT,GAA+D,OAAhB3gB,QAAgB,IAAhBA,GAAAA,EAAkBiW,QAAS,CACnF,MAAMjd,EAAI,IAAI+N,KAAK/G,EAAiBiW,SACpCgL,EAAe,kBAAAxvB,OAAgB4C,OAAOuD,SAASoB,EAAEmoB,WAAanoB,EAAEooB,iBAAmB,GACrF,MAAO,GAA6B,mBAAzBT,GAAwD,OAAhB3gB,QAAgB,IAAhBA,GAAAA,EAAkBqhB,YAAa,CAChF,MAAMroB,EAAI,IAAI+N,KAAK/G,EAAiBqhB,aACpCJ,EAAe,SAAAxvB,OAAY4C,OAAOuD,SAASoB,EAAEmoB,WAAanoB,EAAEooB,iBAAmB,GACjF,CAEA,IAAIE,EAAc,KACdC,EAAgB,KAEpB,MAAMC,EAA2C,qBAAzBb,GAAwE,mBAAzBA,EACjEc,EACJD,IAAoBzb,IAAiBvF,GAAmBI,EACpD8gB,EAAoBD,EAAoBd,EAAuB,KAC/DgB,EAAoBF,EAAoBb,EAAuB,KAC/DgB,EAAsBH,EAAoBR,EAAkB,KAElE,GAAIO,GAAmBE,EACrBJ,EAAc,CAAEppB,MAAOwpB,EAAmBnE,UAAWoE,EAAmBE,QAASD,QAC5E,GAAIZ,EAAoB,CAC7BM,EAAc,CAAEppB,MAAO2oB,EAAetD,UAAWwD,GAK7CW,GAAqBA,IAAsBb,KAHtB,mBAAtBa,GAA8D,mBAApBxb,IACpB,mBAAtBwb,GAA8D,mBAApBxb,IACpB,oBAAtBwb,GAA0D,aAApBxb,MAEvCqb,EAAgB,CAAErpB,MAAOwpB,EAAmBnE,UAAWoE,EAAmBE,QAASD,GAEvF,MAAWF,GACTJ,EAAc,CAAEppB,MAAOwpB,EAAmBnE,UAAWoE,EAAmBE,QAASD,GAC7Ef,GAAiBA,IAAkBa,IACrCH,EAAgB,CAAErpB,MAAO2oB,EAAetD,UAAWwD,KAE5CF,IACTS,EAAc,CAAEppB,MAAO2oB,EAAetD,UAAWwD,IAGnD,MAAMe,EAAiB,GACnB1d,IAAa0d,EAAevqB,KAAK,cAAD9F,OAAesrB,GAAe3Y,MAC9DE,IAAkBwd,EAAevqB,KAAK,mBAAD9F,OAAesrB,GAAezY,MACvE,IAAIyd,GAAY,EAChB,IAAK,IAADC,EAAAC,GACFF,EAA8D,OAA5C,QAANC,EAAA/xB,cAAM,IAAA+xB,GAAc,QAAdC,GAAND,EAAQ9xB,oBAAY,IAAA+xB,QAAd,EAANA,GAAsB9xB,QAAQ,gBAC5C,CAAE,MAAO2G,IACPirB,GAAY,CACd,CACA,GAAIA,EAAW,CACb,MAAMG,EAAY,CAAC,QAADzwB,OACRyS,GAAc,IAAM,KAAG,YAAAzS,OACnB6S,GAAmB,IAAIyC,KAAKzC,IAAkB6d,qBAAuB,QAAM,UAAA1wB,OAC7EiL,GAAS,MAAQ,OAE7BolB,EAAevqB,KAAK,SAAD9F,OAAUywB,EAAU9oB,KAAK,aAC9C,CACA,MAAMgpB,GAAiBN,EAAe1oB,KAAK,YACrCipB,GAAgB1rB,QAAQyrB,IAKxB/G,GAAOzoB,QAAS,OAAFgN,QAAE,IAAFA,OAAE,EAAFA,EAAIyb,OAAQ,IAK1BiH,GAAwD,QAAvC9C,EAAqB,QAArBC,EAAS,OAANjgB,QAAM,IAANA,OAAM,EAANA,EAAQiJ,kBAAU,IAAAgX,EAAAA,EAAM,OAAF7f,QAAE,IAAFA,OAAE,EAAFA,EAAI6I,kBAAU,IAAA+W,EAAAA,EAAI,KAC5D+C,GAAY,CAAEhjB,WAAUiJ,UAAW8Z,IACnCE,GAAiC,OAAhBxiB,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkB6V,OACnC4M,GAAcziB,GAAoBA,EAAiBjM,GAEnD2uB,GAAUA,CAAC5pB,EAAKqiB,KACpB,IACE,OAAOxS,EAAAA,EAAAA,IAAI/I,EAAI9G,EAAKqiB,EAAQoH,GAC9B,CAAE,MAAAI,GACA,OAAO,CACT,GAEIC,GAAiB,CACrBjD,MAAO,SACP1jB,SAAU,WACVlJ,KAAM,OACN+I,GAAI,KACJ8jB,MAAO,SACPC,MAAO,YAEHgD,GAAqB,CACzBlD,MAAO,iBACP1jB,SAAU,WACVlJ,KAAM,OACN+I,GAAI,KACJ8jB,MAAO,WACPC,MAAO,YA4CHiD,GApBc,CAClB,eAAkB,QAClB,SAAY,WACZ,qBAAsB,OACtB,iBAAkB,KAClB,oBAAqB,QACrB,mBAAoB,SAcclwB,OAAOmT,IAAgB,MAAQ,KAC7Dgd,GAAkBjD,EAAcxd,KAAM4L,GAAMA,EAAEpe,MAAQgzB,IACtDE,KAAmBD,KAA2C,IAAzBA,GAAgBjtB,KAIrDmtB,GACJR,IACA,CAAC,QAAS,YAAa,sBAAsBrc,SAASoc,MAC5C,cAATnH,IAAiC,OAATA,IAA0B,YAATA,IAA+B,eAATA,IAG5D6H,IADiBnd,IAnBQ,CAC7B,eAAkB,CAAC,uBACnB,SAAY,CAAC,wBAAyB,iBACtC,qBAAsB,CAAC,6BAA8B,aACrD,iBAAkB,CAAC,yBAA0B,WAC7C,oBAAqB,CAAC,4BAA6B,iBACnD,mBAAoB,CAAC,2BAA4B,kBAaUnT,OAAOmT,MAAuB,IACjDkL,KAAMnY,IAC9C,IACE,OAAO4pB,GAAQ5pB,EAAK,QACtB,CAAE,MAAAqqB,GACA,OAAO,CACT,IAKIC,GACJX,KACU,eAATpH,IAAkC,YAATA,IAAsBqH,GAAQ,mBAAoB,WACzD,aAAnBF,MACiB,OAAhBxiB,QAAgB,IAAhBA,GAAAA,EAAkBiW,WACH,OAAhBjW,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkBkhB,YACdmC,GACJZ,KACU,UAATpH,IAAoBqH,GAAQ,wBAAyB,WACnC,sBAAnBF,GACIc,GACJb,IACA1c,IACoB,cAApBG,KACU,UAATmV,IACU,YAATA,IACS,eAATA,IACAqH,GAAQ,0BAA2B,SACnCA,GAAQ,0BAA2B,UACjCa,GACJziB,GAAqBsC,IAAgBc,IAAe8W,GACtD,IAAIwI,GAAgB,sBAChBxI,GACFwI,GAAgB,6CACPpgB,GACTogB,GAAgB,yBACPtf,GACTsf,GAAgB,0BACP1iB,IACT0iB,GAAgB,uBAKlB,MAQMC,GARkB,CACtB,sBACA,gBACA,YACA,UACA,gBACA,iBAEmDpD,MAAOvnB,IAC1D,IACE,OAAO6P,EAAAA,EAAAA,IAAI/I,EAAI9G,EAAK,QAASypB,GAC/B,CAAE,MAAAmB,GACA,OAAO,CACT,IAGIC,GAAwB,GAC9B,IAAIC,IAAkB,EAClBC,GAAe,GACfC,GAAc,KACdC,GAAiB,KAErB,GAAIV,GAEFQ,GAAe,SACfC,IAAcrG,EAAAA,EAAAA,KAACuG,EAAAA,IAAa,CAAC,cAAY,SACzCJ,IAAkB,EAEdxgB,KACFwgB,IAAkB,EAClBD,GAAsBpsB,KAAK,2BAEzB2M,KACF0f,IAAkB,EAClBD,GAAsBpsB,KAAK,4BAExBqsB,KACHG,GAAiBtiB,UACf,UACQG,EAAAA,GAAIqiB,oBAAoBjkB,EAAiBjM,GAAI,CAAEonB,OAAQ,YAC7DxY,EAAAA,GAAMC,QAAQ,wBACRrB,WACAO,IACR,CAAE,MAAOe,GACPF,EAAAA,GAAMG,OAAO,OAADD,QAAC,IAADA,OAAC,EAADA,EAAGE,UAAW,gCAC5B,SAGC,GAAIqgB,GAAoB,CAM7B,GAJAS,GAAe,eACfC,IAAcrG,EAAAA,EAAAA,KAACyG,EAAAA,IAAY,CAAC,cAAY,SACxCN,IAAkB,GAEbxD,EAAgB,CACnBwD,IAAkB,EAClB,MAAMO,EAAarE,EAAcvpB,OAAQ2X,IAAOA,EAAEpY,OAASoY,EAAE+R,YAC7D0D,GAAsBpsB,KACpB,yCACE4sB,EAAWrvB,IAAKoZ,GAAC,GAAAzc,OAAQyc,EAAEhW,MAAK,KAAAzG,OAAIyc,EAAEjV,IAAG,MAAKG,KAAK,MAEzD,CACI4hB,KACF4I,IAAkB,EAClBD,GAAsBpsB,KAAK,+CAEzB6L,KACFwgB,IAAkB,EAClBD,GAAsBpsB,KAAK,2BAEzB2M,KACF0f,IAAkB,EAClBD,GAAsBpsB,KAAK,4BAEzBqe,KACFgO,IAAkB,EAClBD,GAAsBpsB,KAAK,qBAExBqsB,KACHG,GAAiBtiB,UACf,IACE,IAAKkX,GAAyB,aAAc,OAC5C,IAAKN,GAA8B,aAAc,OAEjD,GAAI2C,GAAa,CAEf,UADiBvE,KACR,MACX,CAGA,UADqBmC,GAAU,CAAEG,SAAS,IAC7B,aACPnX,EAAAA,GAAIwiB,gBAAgB7kB,EAAUS,EAAiBjM,IACrD4O,EAAAA,GAAMC,QAAQ,0BACRrB,WACAO,IACR,CAAE,MAAOe,GACPF,EAAAA,GAAMG,OAAO,OAADD,QAAC,IAADA,OAAC,EAADA,EAAGE,UAAW,uCAC5B,GAGN,MAAO,GAAIkgB,GAAuB,CAEhCY,GAAe,YACfC,IAAcrG,EAAAA,EAAAA,KAACyG,EAAAA,IAAY,CAAC,cAAY,SACxCN,IAAkB,EAGb7d,KACH6d,IAAkB,EAClBD,GAAsBpsB,KAAK,gCAEJwO,KAAiB0V,IAExCmI,IAAkB,EAClBD,GAAsBpsB,KAAK,+DAGvBwO,KAAiBmd,KACnBU,IAAkB,EAClBD,GAAsBpsB,KAAK,qCAGzBwO,KAAiB2V,KACnBkI,IAAkB,EAClBD,GAAsBpsB,KAAKgkB,IAAoB,uBAG5CyH,KACHY,IAAkB,EAClBD,GAAsBpsB,KAAK,2BAGzByjB,KACF4I,IAAkB,EAClBD,GAAsBpsB,KAAK,kCAEzB6L,KACFwgB,IAAkB,EAClBD,GAAsBpsB,KAAK,2BAEzB2M,KACF0f,IAAkB,EAClBD,GAAsBpsB,KAAK,4BAEzBqe,KACFgO,IAAkB,EAClBD,GAAsBpsB,KAAK,uBAG1BqsB,IAAmB7d,IAAgBmd,IAAsBxH,IAAqBsH,KAEjFe,GAAiBtiB,gBACTwZ,MAGZ,CACA,MAAMoJ,GACJV,GAAsB9yB,OAAS,EAAI8yB,GAAsBvqB,KAAK,iBAAStI,EAEnEwzB,GAAY3tB,QAAQ+F,IACpB6nB,GAAiBvJ,GAAc,mBAAqBsJ,GAAY,kBAAoB,UACpFE,GAAc1f,GAAe,sBAAwB,aACrD2f,GAA2B,WAARrsB,IAAoBksB,GAC7C,OACE7G,EAAAA,EAAAA,KAAA,OAAKF,UAAU,uBAAuBlC,KAAK,SAAS,aAAW,mBAAkBmC,UAC/EF,EAAAA,EAAAA,MAAA,OAAKC,UAAU,6BAA4BC,SAAA,EACzCF,EAAAA,EAAAA,MAAA,OAAKC,UAAU,qBAAoBC,SAAA,EAEjCF,EAAAA,EAAAA,MAAA,OAAKC,UAAU,sBAAsBlC,KAAK,SAAS,YAAU,SAAQmC,SAAA,CAClE8D,GACC7D,EAAAA,EAAAA,KAAA,QAAMF,UAAS,eAAA9rB,OAAiB6vB,EAAY/D,WAAaxd,MAAOuhB,EAAYO,QAAQrE,SACjF8D,EAAYppB,QAEb,KACHqpB,GACC9D,EAAAA,EAAAA,KAAA,QAAMF,UAAS,eAAA9rB,OAAiB8vB,EAAchE,WAAaxd,MAAOwhB,EAAcM,QAAQrE,SACrF+D,EAAcrpB,QAEf,KACHpF,IACC2qB,EAAAA,EAAAA,KAAA,QACEF,UAAS,uBAAA9rB,OAAyBupB,GAAc,GAAK,kBACrDjb,MAAOib,GAAc,sDAAoClqB,EACzD,cAAakqB,QAAclqB,EAAY,OAAO0sB,SAC/C,oCAGC,QAEL1qB,IACC2qB,EAAAA,EAAAA,KAAA,OACEF,UAAS,4BAAA9rB,OAA8B4wB,GAAgB,GAAK,kBAC5DtiB,MAAOsiB,GAAgBD,QAAiBtxB,EACxC,cAAauxB,QAAgBvxB,EAAY,OAAO0sB,SAE/C6E,GAAgBD,GAAiB,eAElC,QAGTtvB,IACCwqB,EAAAA,EAAAA,MAAAoH,EAAAA,SAAA,CAAAlH,SAAA,EAEEC,EAAAA,EAAAA,KAAA,OAAKF,UAAU,uBAAsBC,UACnCC,EAAAA,EAAAA,KAAA,OAAKF,UAAU,kBAAkBlC,KAAK,cAAc,gBAAc,IAAI,gBAAc,MAAKmC,SACtFsC,EAAchrB,IAAKoZ,IAClB,MAAMvY,EAASitB,GAAe1U,EAAEpe,KAC1B60B,EAAShuB,QAAQhB,GAjTRivB,KACzB,MAAMC,EAAUhC,GAAmB+B,GACnC,IAAKC,EAAS,OAAO,EACrB,GAAInC,GAAQ,QAADjxB,OAASozB,GAAW,QAAS,OAAO,EAC/C,MAAMC,EAAQ1uB,MAAMC,QAAU,OAAFuJ,QAAE,IAAFA,OAAE,EAAFA,EAAImlB,aAAenlB,EAAGmlB,YAAc,GAC1Dvc,EAAY+Z,GAAU/Z,UAC5B,OAAOsc,EAAM7T,KAAM+T,IACjB,GAAoB,SAAhBA,EAAK7J,QAAqC,UAAhB6J,EAAK7J,OAAoB,OAAO,EAE9D,IADYvoB,OAAOoyB,EAAKC,UAAY,IAC3BlhB,WAAW,WAADtS,OAAYozB,EAAO,MAAM,OAAO,EACnD,MAAMK,EAAuC,MAAzBF,EAAKG,iBAA2B9wB,OAAO2wB,EAAKG,kBAAoB,KAC9EC,EAAqC,MAAxBJ,EAAKK,gBAA0BhxB,OAAO2wB,EAAKK,iBAAmB,KACjF,OAAmB,MAAfH,GAAoC,MAAb1c,GAAqBnU,OAAO6wB,KAAiB7wB,OAAOmU,MAC7D,MAAd4c,GAAkC,MAAZ7lB,GAAoBlL,OAAO+wB,KAAgB/wB,OAAOkL,MAC1D,MAAd6lB,GAAkC,MAAZ7lB,KACP,MAAf2lB,GAAoC,MAAb1c,MAkSc8c,CAAkBpX,EAAEpe,MAC/Cy1B,EAAWzC,KAAoB5U,EAAEpe,IAEjC01B,EArhBpB,SAA8B5zB,EAAO4wB,EAAgBiD,GACnD,GAAuB,aAAnBjD,GAAiCiD,EACnC,MAAO,WAET,GAAI,CAAC,oBAAqB,aAAarf,SAASxT,OAAO4vB,GAAkB,KACvE,MAAO,eAET,OAAQ5vB,OAAOhB,GAAS,gBACtB,IAAK,iBACH,MAAO,cACT,IAAK,WACH,MAAO,cACT,IAAK,YACH,MAAO,YAGT,QACE,MAAO,WAEb,CAkgBkC8zB,CApfJd,KAC1B,IAAKA,EAAW,MAAO,cACvB,IAAKpkB,EAAiB,MAAO,cAC7B,MAAMkC,EAASgd,EAAkBkF,GACjC,IAAKliB,EAAQ,MAAO,cACpB,MAAMlE,EAAOpI,MAAMC,QAAQiK,GACvBA,EAAUgC,KAAMqjB,GAAM/yB,OAAQ,OAAD+yB,QAAC,IAADA,OAAC,EAADA,EAAG1f,WAAarT,OAAO8P,IACpD,KACJ,OAAW,OAAJlE,QAAI,IAAJA,GAAAA,EAAM5M,MAAQgB,OAAO4L,EAAK5M,OAAS,eA2edg0B,CAAmB1X,EAAEpe,KAGrB,OAAhBkQ,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkB6V,OACF,OAAhB7V,QAAgB,IAAhBA,OAAgB,EAAhBA,EAAkBiW,SAEd4P,EAAalB,EAAS,SAAW,MACvC,OACErH,EAAAA,EAAAA,MAACuI,EAAU,CAET1uB,KAAMwtB,EAAS,cAAW7zB,EAC1B6tB,QAASgG,EAAS,IAAMte,GAAO1Q,QAAU7E,EACzCysB,UAAS,cAAA9rB,OAAgBkzB,EAAS,eAAiB,GAAE,KAAAlzB,OAAI8zB,EAAW,YAAc,IAClFxlB,MAAK,GAAAtO,OAAKyc,EAAEhW,MAAK,MAAAzG,OAAKqG,KAAKoB,MAAMgV,EAAEjV,KAAI,MAAAxH,OAAKyc,EAAEpY,KAAO,kBAAe,SACpE,gBAAe6uB,OAAS7zB,EAAY,OAAO0sB,SAAA,EAE3CC,EAAAA,EAAAA,KAAA,OAAKF,UAAU,eAAcC,SAAEtP,EAAE8R,cACjC1C,EAAAA,EAAAA,MAAA,OAAKC,UAAU,aAAYC,SAAA,EACzBC,EAAAA,EAAAA,KAAA,OACEF,UAAS,eAAA9rB,OAAiB+zB,GAC1BzN,MAAO,CAAEiG,MAAM,GAADvsB,OAAKqG,KAAK1D,IAAI,IAAK0D,KAAKC,IAAI,EAAGD,KAAKoB,MAAMgV,EAAEjV,OAAM,SAElEqkB,EAAAA,EAAAA,MAAA,QAAMC,UAAU,iBAAgBC,SAAA,CAAE1lB,KAAKoB,MAAMgV,EAAEjV,KAAK,YAbjDiV,EAAEpe,YAqBjBwtB,EAAAA,EAAAA,MAAA,OAAKC,UAAU,sBAAqBC,SAAA,CACjC8F,IACC7F,EAAAA,EAAAA,KAACqI,EAAAA,EAAO,CAACC,MAAOvC,GAAgB,CAACA,IAAiB,GAAGhG,UACnDF,EAAAA,EAAAA,MAAA,UACEnmB,KAAK,SACLomB,UAAU,wBACVoB,QAASA,IAAMzD,GAAqB,WACpC8K,SAAUzC,GACVxjB,MAAOyjB,GAAchG,SAAA,EAErBC,EAAAA,EAAAA,KAACuG,EAAAA,IAAa,CAAC,cAAY,UAC3BvG,EAAAA,EAAAA,KAAA,QAAAD,SAAO1c,EAAoB,sBAAmB,gBAGhD,KACH+iB,IACCpG,EAAAA,EAAAA,KAACqI,EAAAA,EAAO,CAACC,MAAO1B,GAAiB,CAACA,IAAkB,GAAG7G,UACrDF,EAAAA,EAAAA,MAAA,UACEnmB,KAAK,SACLomB,UAAU,wBACVoB,QAASoF,GACTiC,SAAUpC,GACV7jB,MAAOskB,GAAe7G,SAAA,CAErBsG,IACDrG,EAAAA,EAAAA,KAAA,QAAAD,SAAOqG,UAGT,MACJvG,EAAAA,EAAAA,MAAA,UACEnmB,KAAK,SACLomB,UAAW,eAAiBvC,KAAgB5X,GAAe,UAAY,YACvEub,QAASlI,GACTuP,UAAWhL,IAAe5X,IAAgB+S,GAC1CpW,MACEoW,GACIqF,GACAR,GACE,kCACA,wCACPwC,SAAA,EAEDC,EAAAA,EAAAA,KAACwI,EAAAA,IAAM,CAAC,cAAY,UACpBxI,EAAAA,EAAAA,KAAA,QAAAD,SAAOpa,GAAe,kBAAoB4X,GAAc,SAAW,kBAGpEyI,IACCnG,EAAAA,EAAAA,MAAA,UACEnmB,KAAK,SACLomB,UAAU,wBACVoB,QAASld,UACP,IAAI2B,KAAgBc,IACfyU,GAAyB,cACzBN,GAA8B,aAAnC,CACA,GAAI2C,GAAa,CAGf,kBAFiBvE,YACHmC,KAEhB,OACMA,IANiD,GAQzDoN,SAAU5iB,IAAgBc,GAC1BnE,MAAOwkB,GAAe/G,SAAA,EAEtBC,EAAAA,EAAAA,KAACyI,EAAAA,IAAY,CAAC,cAAY,UAC1BzI,EAAAA,EAAAA,KAAA,QAAAD,SAAOtZ,GAAc,uBAAoBqgB,QAEzC,KAEHE,IACCnH,EAAAA,EAAAA,MAAA,OAAKC,UAAU,cAAc4I,IAAKvhB,GAAc4Y,SAAA,EAC9CF,EAAAA,EAAAA,MAAA,UACEnmB,KAAK,SACLomB,UAAS,uBAAA9rB,OAAyBqT,GAAe,aAAe,IAChE6Z,QAASA,KACH7B,IACJnY,GAAepC,IAAUA,IAE3ByjB,SAAUlJ,GACV,gBAAc,OACd,gBAAepY,GACf,YAAWI,GAAe,YAAShU,EAAU0sB,SAAA,CAE5C1Y,IAAe2Y,EAAAA,EAAAA,KAAA,QAAMF,UAAU,qBAAqB,cAAY,SAAY,KAC3EzY,GAAqD,MAAtC2Y,EAAAA,EAAAA,KAAC2I,EAAAA,IAAY,CAAC,cAAY,UAC3C3I,EAAAA,EAAAA,KAAA,QAAAD,SAAOgH,QAGR9f,IACC4Y,EAAAA,EAAAA,MAAA,OAAKC,UAAU,0CAA0ClC,KAAK,OAAMmC,SAAA,EAClEC,EAAAA,EAAAA,KAAA,UACEtmB,KAAK,SACLomB,UAAU,mBACVoB,QAASA,KACPha,IAAc,GAvnCpClD,iBACE,GAAKP,GAAL,CACAvB,EAAO,IACP,UACQiC,EAAAA,GAAIykB,aAAa9mB,EAAU2B,GAAoBmE,GAAgBG,GACvE,CAAE,MAAO3C,GACPlD,EAAOkD,EAAEE,SAAW,kBACtB,CAN+B,CAOjC,CAgnCsBujB,IAEFN,SAAUlJ,GACVzB,KAAK,WAAUmC,SAChB,mBAGDC,EAAAA,EAAAA,KAAA,UACEtmB,KAAK,SACLomB,UAAU,mBACVoB,QAASA,KACPha,IAAc,GAznCpClD,iBACE,GAAKP,GAAL,CACAvB,EAAO,IACPoF,IAAgB,GAChB,UACQnD,EAAAA,GAAI2kB,YAAYhnB,EAAU2B,GAAoBmE,GAAgBG,GACtE,CAAE,MAAO3C,GACPlD,EAAOkD,EAAEE,SAAW,oBACtB,CAAC,QACCgC,IAAgB,EAClB,CAT+B,CAUjC,CA+mCsByhB,IAEFR,SAAUlJ,GACVzB,KAAK,WAAUmC,SAChB,kBAID,QAEJ,YAIRC,EAAAA,EAAAA,KAAA,OAAKF,UAAU,sBAAqBC,UAClCC,EAAAA,EAAAA,KAAA,OAAKF,UAAU,2BAA0BC,SAAC,wCAMlD,CA6GKiJ,KAGP,C,+BCtmFA,MAAMC,EAAmB,CAAC,aAAc,UAAW,WAAY,QAExD,SAASjyB,EAAsB3B,GAAS,IAADiM,EAC5C,MAAMrD,EAAkB,OAAN5I,QAAM,IAANA,GAAqB,QAAfiM,EAANjM,EAAQkV,qBAAa,IAAAjJ,OAAf,EAANA,EAAuBrD,UACzC,SAAKA,GAAkC,kBAAdA,IAClBgrB,EAAiBrG,MAAOvwB,IAAG,IAAA62B,EAAA,OAAmC,KAArB,OAATjrB,QAAS,IAATA,GAAgB,QAAPirB,EAATjrB,EAAY5L,UAAI,IAAA62B,OAAP,EAATA,EAAkBzyB,UAC3D,C,oECNA,MAAM0yB,EAAgB,CACpBC,MAAO,QACPC,cAAe,iBAGXC,EAAwB,IAAIpyB,IAAIf,OAAOozB,OAAOJ,IAEpD,SAAS/T,EAAqB5gB,GAC5B,MAAMjC,EAAM4C,OAAOX,GAAS,IAAIb,OAAO+I,cACvC,OAAI4sB,EAAsBrxB,IAAI1F,GAAaA,EACpC42B,EAAcC,KACvB,CAEA,SAASze,IAA8C,IAADtL,EAAAiC,EAAAC,EAAA,IAA9BlM,EAAMlC,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,CAAC,EAAGqC,EAAQrC,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,KAC9C,MAAMq2B,EACqD,QADpCnqB,EACa,QADbiC,EACf,OAANjM,QAAM,IAANA,GAAqB,QAAfkM,EAANlM,EAAQkV,qBAAa,IAAAhJ,OAAf,EAANA,EAAuBmJ,mBAAW,IAAApJ,EAAAA,EAAU,OAANjM,QAAM,IAANA,OAAM,EAANA,EAAQqV,mBAAW,IAAArL,EAAAA,EAAU,OAANhK,QAAM,IAANA,OAAM,EAANA,EAAQ6I,aACvE,GAAIsrB,EACF,OAAOpU,EAAqBoU,GAE9B,MAAMC,GAA8B,OAARj0B,QAAQ,IAARA,OAAQ,EAARA,EAAU0I,gBAAwB,OAAR1I,QAAQ,IAARA,OAAQ,EAARA,EAAUkV,aAChE,OAAI+e,EAA4BrU,EAAqBqU,GAC9CN,EAAcC,KACvB,CAEA,SAASM,EAAmBr3B,GAC1B,MAAMqH,EAAO0b,EAD6BjiB,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAGg2B,EAAcC,OAE3D,OAAK/2B,IACO,eAARA,IACAA,EAAI6pB,SAAS,SAAiBxiB,IAASyvB,EAAcC,OACrD/2B,EAAI6pB,SAAS,QAAexiB,IAASyvB,EAAcE,eAEzD,CAEA,SAASlX,EAAuBwX,GAC9B,MAAMjwB,EAAO0b,EADwCjiB,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAGg2B,EAAcC,OAEtE,GAAmB,eAAfO,EAA6B,MAAO,aACxC,MAAMxN,EAASziB,IAASyvB,EAAcE,cAAgB,MAAQ,QAC9D,MAAM,GAANr1B,OAAU21B,GAAU31B,OAAGmoB,EACzB,C","sources":["hooks/useScenarioUIState.js","utils/scenarioProgress.js","pages/SchoolPage.jsx","utils/scenarioProfile.js","utils/programType.js"],"sourcesContent":["import { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { useLocation } from \"react-router-dom\";\r\n\r\n// Per school + per scenario persistence.\r\n// We scope by current URL (pathname + search). In your app, this URL already contains\r\n// schoolId and scenarioId (either in params or querystring), so each school/scenario\r\n// gets its own remembered UI state.\r\n\r\nconst DEFAULT_PREFIX = \"fizizbilite\";\r\n\r\nfunction safeRead(key, fallback) {\r\n  try {\r\n    const raw = window.localStorage.getItem(key);\r\n    if (raw == null) return fallback;\r\n    return JSON.parse(raw);\r\n  } catch {\r\n    return fallback;\r\n  }\r\n}\r\n\r\nfunction safeWrite(key, value) {\r\n  try {\r\n    window.localStorage.setItem(key, JSON.stringify(value));\r\n  } catch {\r\n    // ignore quota / privacy mode errors\r\n  }\r\n}\r\n\r\nexport function useScenarioScopeKey(prefix = DEFAULT_PREFIX, scopeOverride) {\r\n  const loc = useLocation();\r\n  return useMemo(() => {\r\n    const override = typeof scopeOverride === \"string\" ? scopeOverride.trim() : \"\";\r\n    const scope = override || (loc.pathname + (loc.search || \"\"));\r\n    return prefix + \":\" + scope;\r\n  }, [prefix, scopeOverride, loc.pathname, loc.search]);\r\n}\r\n\r\n/**\r\n * Generic persisted state hook (localStorage), scoped by current scenario URL.\r\n *\r\n * NOTE: We intentionally avoid writing to a *new* scope key until we've loaded that\r\n * key's stored value. This prevents \"old state\" from being written into a newly\r\n * navigated scenario.\r\n */\r\nexport function useScenarioUiState(name, defaultValue, { prefix = DEFAULT_PREFIX, scope } = {}) {\r\n  const scopeKey = useScenarioScopeKey(prefix, scope);\r\n  const storageKey = useMemo(() => `${scopeKey}:ui:${name}`, [scopeKey, name]);\r\n\r\n  const loadedKeyRef = useRef(null);\r\n\r\n  const [state, setState] = useState(() => safeRead(storageKey, defaultValue));\r\n\r\n  // Load when the scope (school/scenario) changes\r\n  useEffect(() => {\r\n    loadedKeyRef.current = storageKey;\r\n    setState(safeRead(storageKey, defaultValue));\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [storageKey]);\r\n\r\n  // Persist changes (only after we loaded for this key)\r\n  useEffect(() => {\r\n    if (loadedKeyRef.current !== storageKey) return;\r\n    safeWrite(storageKey, state);\r\n  }, [storageKey, state]);\r\n\r\n  return [state, setState, storageKey];\r\n}\r\n\r\nexport function useScenarioUiFlag(name, defaultValue = false, opts) {\r\n  const [v, setV] = useScenarioUiState(name, !!defaultValue, opts);\r\n  const setFlag = (next) => setV(!!(typeof next === \"function\" ? next(v) : next));\r\n  return [!!v, setFlag];\r\n}\r\n\r\nexport function useScenarioUiString(name, defaultValue = \"\", opts) {\r\n  const [v, setV] = useScenarioUiState(name, String(defaultValue ?? \"\"), opts);\r\n  const setStr = (next) => setV(String(typeof next === \"function\" ? next(v) : next));\r\n  return [String(v ?? \"\"), setStr];\r\n}\r\n\r\nexport function useScenarioUiNumber(name, defaultValue = 0, opts) {\r\n  const [v, setV] = useScenarioUiState(name, Number(defaultValue ?? 0), opts);\r\n  const setNum = (next) => {\r\n    const raw = typeof next === \"function\" ? next(v) : next;\r\n    const n = Number(raw);\r\n    setV(Number.isFinite(n) ? n : 0);\r\n  };\r\n  return [Number(v ?? 0), setNum];\r\n}\r\n","import {\r\n  DEFAULT_PROGRESS_CONFIG,\r\n  buildProgressCatalog,\r\n  isNonEmptyString,\r\n  safeGet,\r\n  toNum,\r\n} from \"./progressCatalog\";\r\nimport { isHeadquarterScenario } from \"./scenarioProfile\";\r\n\r\nfunction isFilled(value, type) {\r\n  if (type === \"string\") return isNonEmptyString(value);\r\n  // For boolean fields we accept both true/false as \"filled\".\r\n  // Only null/undefined should be treated as missing.\r\n  if (type === \"boolean\") return typeof value === \"boolean\";\r\n  const n = toNum(value);\r\n  return n > 0;\r\n}\r\n\r\nfunction normalizeConfig(config) {\r\n  const defaults = DEFAULT_PROGRESS_CONFIG();\r\n  const input = config && typeof config === \"object\" ? config : {};\r\n  const sectionsInput = input.sections && typeof input.sections === \"object\" ? input.sections : {};\r\n  const out = { version: defaults.version, sections: {} };\r\n\r\n  Object.keys(defaults.sections).forEach((id) => {\r\n    const base = defaults.sections[id] || {};\r\n    const incoming = sectionsInput[id] && typeof sectionsInput[id] === \"object\" ? sectionsInput[id] : {};\r\n    out.sections[id] = {\r\n      enabled: typeof incoming.enabled === \"boolean\" ? incoming.enabled : base.enabled !== false,\r\n      mode: typeof incoming.mode === \"string\" && incoming.mode ? incoming.mode : base.mode,\r\n      min: incoming.min != null ? Number(incoming.min) : base.min,\r\n      selectedFields:\r\n        incoming.selectedFields && typeof incoming.selectedFields === \"object\" ? incoming.selectedFields : {},\r\n    };\r\n  });\r\n\r\n  return out;\r\n}\r\n\r\nexport function computeScenarioProgress({ inputs, norm, config, scenario } = {}) {\r\n  const catalog = buildProgressCatalog({ inputs, norm, scenario });\r\n  const normalizedConfig = normalizeConfig(config);\r\n  const isHQ = isHeadquarterScenario(inputs);\r\n  const HQ_INCLUDED_TABS = new Set([\"ik\", \"gelirler\", \"giderler\"]);\r\n\r\n  const sectionsById = new Map(catalog.sections.map((s) => [s.id, s]));\r\n  const sectionResults = new Map();\r\n  let totalUnits = 0;\r\n  let doneUnits = 0;\r\n  let overallTotalUnits = 0;\r\n  let overallDoneUnits = 0;\r\n\r\n  catalog.sections.forEach((section) => {\r\n    const cfg = normalizedConfig.sections[section.id] || {};\r\n    if (cfg.enabled === false) {\r\n      sectionResults.set(section.id, { enabled: false });\r\n      return;\r\n    }\r\n    const includeInOverall = !isHQ || HQ_INCLUDED_TABS.has(section.tabKey);\r\n    const addUnits = (total, done) => {\r\n      totalUnits += total;\r\n      doneUnits += done;\r\n      if (includeInOverall) {\r\n        overallTotalUnits += total;\r\n        overallDoneUnits += done;\r\n      }\r\n    };\r\n\r\n    const requiresKademe = section.requiresKademe === true;\r\n    const hasKademeSelection = catalog.context?.hasKademeSelection;\r\n    if (requiresKademe && !hasKademeSelection) {\r\n      sectionResults.set(section.id, {\r\n        enabled: true,\r\n        done: false,\r\n        doneUnits: 0,\r\n        totalUnits: 1,\r\n        missingReasons: [\"Kademeler secilmedi\"],\r\n      });\r\n      addUnits(1, 0);\r\n      return;\r\n    }\r\n\r\n    const fieldIds = Array.isArray(section.fields) ? section.fields : [];\r\n    const selectedIds = fieldIds.filter((id) => cfg.selectedFields?.[id] !== false);\r\n    if (selectedIds.length === 0) {\r\n      sectionResults.set(section.id, {\r\n        enabled: true,\r\n        done: true,\r\n        doneUnits: 0,\r\n        totalUnits: 0,\r\n        missingReasons: [],\r\n      });\r\n      return;\r\n    }\r\n    const applicable = selectedIds\r\n      .map((id) => catalog.fieldsById[id])\r\n      .filter(Boolean)\r\n      .filter((field) => {\r\n        if (typeof field.appliesIf !== \"function\") return true;\r\n        try {\r\n          return field.appliesIf(inputs, norm, scenario) !== false;\r\n        } catch (_) {\r\n          return true;\r\n        }\r\n      });\r\n\r\n    const filled = [];\r\n    const missing = [];\r\n\r\n    applicable.forEach((field) => {\r\n      let value = null;\r\n      try {\r\n        value = field.getValue ? field.getValue(inputs, norm) : null;\r\n      } catch (_) {\r\n        value = null;\r\n      }\r\n      const ok = isFilled(value, field.type);\r\n      if (ok) filled.push(field);\r\n      else missing.push(field);\r\n    });\r\n\r\n    const filledCount = filled.length;\r\n    let mode = String(cfg.mode || section.modeDefault || \"ALL\").toUpperCase();\r\n    let minRequired = Number.isFinite(Number(cfg.min)) ? Number(cfg.min) : section.minDefault;\r\n    if (isHQ && section.id === \"ik.localStaff\") {\r\n      mode = \"MIN\";\r\n      minRequired = 1;\r\n    }\r\n\r\n    if (mode === \"MIN\") {\r\n      const min = Math.max(1, Number.isFinite(minRequired) ? minRequired : 1);\r\n      const done = filledCount >= min;\r\n      const doneCount = Math.min(filledCount, min);\r\n      sectionResults.set(section.id, {\r\n        enabled: true,\r\n        done,\r\n        doneUnits: doneCount,\r\n        totalUnits: min,\r\n        missingReasons: done ? [] : [`En az ${min} alan`],\r\n      });\r\n      addUnits(min, doneCount);\r\n      return;\r\n    }\r\n\r\n    const total = applicable.length;\r\n    if (total === 0) {\r\n      if (section.allowEmpty === false) {\r\n        sectionResults.set(section.id, {\r\n          enabled: true,\r\n          done: false,\r\n          doneUnits: 0,\r\n          totalUnits: 1,\r\n          missingReasons: [section.label || \"Eksik\"],\r\n        });\r\n        addUnits(1, 0);\r\n      } else {\r\n        sectionResults.set(section.id, {\r\n          enabled: true,\r\n          done: true,\r\n          doneUnits: 0,\r\n          totalUnits: 0,\r\n          missingReasons: [],\r\n        });\r\n      }\r\n      return;\r\n    }\r\n\r\n    const done = filledCount === total;\r\n    const missingReasons = done\r\n      ? []\r\n      : missing.map((field) => field.label).filter(Boolean);\r\n\r\n    sectionResults.set(section.id, {\r\n      enabled: true,\r\n      done,\r\n      doneUnits: filledCount,\r\n      totalUnits: total,\r\n      missingReasons,\r\n    });\r\n    addUnits(total, filledCount);\r\n  });\r\n\r\n  const tabs = catalog.tabs.map((tab) => {\r\n    const sections = tab.sectionIds || [];\r\n    const enabledSections = sections\r\n      .map((id) => ({ id, result: sectionResults.get(id), def: sectionsById.get(id) }))\r\n      .filter((s) => s.result && s.result.enabled !== false);\r\n\r\n    let tabTotal = 0;\r\n    let tabDone = 0;\r\n    const missingLines = [];\r\n    let allDone = true;\r\n\r\n    enabledSections.forEach((s) => {\r\n      const res = s.result || {};\r\n      if (!res.done) allDone = false;\r\n      const t = Number(res.totalUnits || 0);\r\n      const d = Number(res.doneUnits || 0);\r\n      if (t > 0) {\r\n        tabTotal += t;\r\n        tabDone += d;\r\n      }\r\n      if (Array.isArray(res.missingReasons) && res.missingReasons.length) {\r\n        missingLines.push(...res.missingReasons);\r\n      }\r\n    });\r\n\r\n    const pct = tabTotal\r\n      ? Math.round((tabDone / tabTotal) * 100)\r\n      : allDone\r\n        ? 100\r\n        : 0;\r\n    const missingPreview = missingLines.length ? missingLines.join(\" / \") : \"\";\r\n\r\n    return {\r\n      key: tab.key,\r\n      label: tab.label,\r\n      pct,\r\n      done: allDone,\r\n      missingPreview,\r\n      missingLines,\r\n    };\r\n  });\r\n\r\n  const effectiveTotal = isHQ ? overallTotalUnits : totalUnits;\r\n  const effectiveDone = isHQ ? overallDoneUnits : doneUnits;\r\n  const pct = effectiveTotal ? Math.round((effectiveDone / effectiveTotal) * 100) : 100;\r\n  const missingDetailsLines = tabs\r\n    .filter((t) => !t.done)\r\n    .filter((t) => (!isHQ ? true : HQ_INCLUDED_TABS.has(t.key)))\r\n    .map((t) => {\r\n      const reasons = t.missingPreview || \"Eksik alanlar\";\r\n      return `${t.label}: ${reasons}`;\r\n    });\r\n\r\n  const visibleTabs = isHQ ? tabs.filter((t) => HQ_INCLUDED_TABS.has(t.key)) : tabs;\r\n  const completedCount = visibleTabs.filter((t) => t.done).length;\r\n  const totalCount = visibleTabs.length;\r\n\r\n  return {\r\n    pct,\r\n    completedCount,\r\n    totalCount,\r\n    tabs,\r\n    missingDetailsLines,\r\n  };\r\n}\r\n\r\nexport { safeGet, toNum, isNonEmptyString };\r\n","// frontend/src/pages/SchoolPage.jsx\r\n\r\nimport React, { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { Outlet, useLocation, useNavigate, useOutletContext, useParams } from \"react-router-dom\";\r\nimport { ToastContainer, toast } from \"react-toastify\";\r\nimport { api } from \"../api\";\r\nimport Tooltip from \"../components/ui/Tooltip\";\r\nimport { can } from \"../utils/permissions\";\r\nimport { getGradeOptions, normalizeKademeConfig, summarizeGradesByKademe } from \"../utils/kademe\";\r\nimport { computeScenarioProgress } from \"../utils/scenarioProgress\";\r\nimport { useScenarioUiState, useScenarioUiString } from \"../hooks/useScenarioUIState\";\r\nimport { FaCalculator, FaCheckCircle, FaFileExport, FaPaperPlane, FaSave } from \"react-icons/fa\";\r\nimport {\r\n  readLastVisitedPath,\r\n  readSelectedScenarioId,\r\n  writeLastVisitedPath,\r\n  writeSelectedScenarioId,\r\n  writeGlobalLastRouteSegment,\r\n  writeScenarioFlags,\r\n} from \"../utils/schoolNavStorage\";\r\nimport { getProgramType, mapBaseKademeToVariant, normalizeProgramType } from \"../utils/programType\";\r\nimport { isHeadquarterScenario } from \"../utils/scenarioProfile\";\r\n\r\n// Helper: Convert dirty input paths to permission resource keys for modifiedResources.\r\n// It strips a leading 'inputs.' prefix (if present), converts camelCase\r\n// tokens to snake_case, and returns page-level and section-level resources.\r\n// Example: 'inputs.gelirler.unitFee'  ['page.gelirler','section.gelirler.unit_fee'].\r\n/**\r\n * Convert a dirty input path into a list of permission resources.  The\r\n * function returns at most two resources: a pagelevel resource (always)\r\n * and, when a known mapping exists, a sectionlevel resource.  It\r\n * normalizes camelCase tokens to snake_case and applies custom\r\n * section mappings to ensure that generated section keys align with the\r\n * backend permissions catalog.  Unknown sections fall back to pagelevel\r\n * only.\r\n *\r\n * For example:\r\n *   'inputs.gelirler.tuition.rows.0.amount'  ['page.gelirler','section.gelirler.unit_fee']\r\n *   'inputs.temelBilgiler.performans.degerlendirme'  ['page.temel_bilgiler','section.temel_bilgiler.performans']\r\n *   'inputs.ik.years.y1'  ['page.ik','section.ik.local_staff']\r\n *\r\n * The SECTION_KEY_MAPPING constant below defines mappings from secondlevel\r\n * keys to canonical section names per page.  A wildcard '*' entry may be\r\n * used to map any key to a default section.  A mapping value of null\r\n * indicates that no sectionlevel resource should be generated for that key.\r\n *\r\n * @param {string} path Dirty input path (e.g. 'inputs.gelirler.tuition.rows.0.amount')\r\n * @returns {string[]} List of permission resource keys\r\n */\r\nfunction pathToResources(path) {\r\n  const result = [];\r\n  if (!path) return result;\r\n  const tokens = String(path).split('.');\r\n  // Strip a leading 'inputs.' prefix to isolate the module and section keys.\r\n  if (tokens.length > 0 && tokens[0] === 'inputs') {\r\n    tokens.shift();\r\n  }\r\n  if (tokens.length === 0) return result;\r\n  // Normalize the module (page) token from camelCase to snake_case.\r\n  const pageRaw = tokens[0];\r\n  let page = pageRaw.replace(/([a-z0-9])([A-Z])/g, '$1_$2').toLowerCase();\r\n  const PAGE_ALIASES = {\r\n    grades_years: \"grades_plan\",\r\n    grades_current: \"grades_plan\",\r\n    grades: \"grades_plan\",\r\n  };\r\n  if (Object.prototype.hasOwnProperty.call(PAGE_ALIASES, page)) {\r\n    page = PAGE_ALIASES[page];\r\n  }\r\n  if (!page) return result;\r\n  // If a section token exists, map it to a canonical section resource key.  If\r\n  // mapping yields a non-null value, return only the section-level resource.\r\n  // Otherwise, fall back to the page-level resource.  This avoids sending\r\n  // both the page and section resources for the same change, which would\r\n  // incorrectly require the user to have write access on both resources.\r\n  if (tokens.length >= 2) {\r\n    const sectionRaw = tokens[1];\r\n    const sectionSnake = sectionRaw.replace(/([a-z0-9])([A-Z])/g, '$1_$2').toLowerCase();\r\n    const SECTION_KEY_MAPPING = {\r\n      temel_bilgiler: {\r\n        inflation: 'inflation',\r\n        ucret_artis_oranlari: 'inflation',\r\n        okul_ucretleri_hesaplama: 'inflation',\r\n        ik_mevcut: 'ik_mevcut',\r\n        burs_indirim_ogrenci_sayilari: 'burs_ogr',\r\n        burs_ogr: 'burs_ogr',\r\n        rakip_analizi: 'rakip',\r\n        rakip: 'rakip',\r\n        performans: 'performans',\r\n        degerlendirme: 'performans',\r\n        okul_egitim_bilgileri: 'okul_egitim',\r\n        yetkililer: null,\r\n        kademeler: null,\r\n        program_type: null,\r\n      },\r\n      gelirler: {\r\n        '*': 'unit_fee',\r\n      },\r\n      giderler: {\r\n        '*': 'isletme',\r\n      },\r\n      ik: {\r\n        '*': 'local_staff',\r\n      },\r\n      discounts: {\r\n        '*': 'discounts',\r\n      },\r\n      norm: {\r\n        '*': 'ders_dagilimi',\r\n      },\r\n      grades_plan: {\r\n        '*': 'plan',\r\n      },\r\n      kapasite: {\r\n        '*': 'caps',\r\n      },\r\n    };\r\n    const pageMap = SECTION_KEY_MAPPING[page];\r\n    let mapped = null;\r\n    if (pageMap) {\r\n      if (Object.prototype.hasOwnProperty.call(pageMap, sectionSnake)) {\r\n        mapped = pageMap[sectionSnake];\r\n      } else if (Object.prototype.hasOwnProperty.call(pageMap, '*')) {\r\n        mapped = pageMap['*'];\r\n      } else {\r\n        // If no explicit mapping exists, use the normalized section name directly.\r\n        mapped = sectionSnake;\r\n      }\r\n    } else {\r\n      // For pages with no mapping defined, use the normalized section name.\r\n      mapped = sectionSnake;\r\n    }\r\n    if (mapped) {\r\n      // When a section-level mapping exists (mapped !== null), return only\r\n      // the section-level resource.  Do not include the page-level resource\r\n      // because a section write implicitly requires only section permission.\r\n      result.push(`section.${page}.${mapped}`);\r\n      return result;\r\n    }\r\n  }\r\n  // Fall back to the page-level resource if no section mapping applies.\r\n  result.push(`page.${page}`);\r\n  return result;\r\n}\r\n\r\nfunction isScenarioLocked(scenario) {\r\n  const status = String(scenario?.status || \"draft\");\r\n  const submittedAt = scenario?.submitted_at != null;\r\n  const sentAt = scenario?.sent_at != null;\r\n  return (\r\n    status === \"sent_for_approval\" ||\r\n    status === \"submitted\" ||\r\n    (status === \"approved\" && sentAt) ||\r\n    (status === \"in_review\" && submittedAt)\r\n  );\r\n}\r\n\r\n\r\n\r\nconst INPUT_HEADER_TABS = new Set([\"basics\", \"kapasite\", \"income\", \"expenses\", \"norm\", \"hr\", \"detailedReport\", \"report\"]);\r\nconst TAB_TO_ROUTE = {\r\n  basics: \"temel-bilgiler\",\r\n  kapasite: \"kapasite\",\r\n  norm: \"norm\",\r\n  hr: \"ik\",\r\n  income: \"gelirler\",\r\n  expenses: \"giderler\",\r\n  detailedReport: \"detayli-rapor\",\r\n  report: \"rapor\",\r\n};\r\nconst ROUTE_TO_TAB = Object.fromEntries(Object.entries(TAB_TO_ROUTE).map(([key, value]) => [value, key]));\r\nconst TAB_TO_WORK_ID = {\r\n  basics: \"temel_bilgiler\",\r\n  kapasite: \"kapasite\",\r\n  norm: \"norm.ders_dagilimi\",\r\n  hr: \"ik.local_staff\",\r\n  income: \"gelirler.unit_fee\",\r\n  expenses: \"giderler.isletme\",\r\n};\r\nconst HQ_REQUIRED_WORK_IDS = new Set([\"ik.local_staff\", \"gelirler.unit_fee\", \"giderler.isletme\"]);\r\n\r\nfunction parseAcademicYear(academicYear) {\r\n  const s = String(academicYear || \"\").trim();\r\n  const range = s.match(/(\\d{4})\\s*-\\s*(\\d{4})/);\r\n  if (range) {\r\n    const startYear = Number(range[1]);\r\n    const endYear = Number(range[2]);\r\n    if (Number.isFinite(startYear) && Number.isFinite(endYear)) {\r\n      return { startYear, endYear };\r\n    }\r\n  }\r\n  const single = s.match(/^(\\d{4})$/);\r\n  if (single) {\r\n    const startYear = Number(single[1]);\r\n    if (Number.isFinite(startYear)) return { startYear, endYear: startYear };\r\n  }\r\n  return { startYear: null, endYear: null };\r\n}\r\n\r\nfunction pctValue(tab) {\r\n  const n = Number(tab?.pct);\r\n  return Number.isFinite(n) ? n : 0;\r\n}\r\n\r\nfunction mergeMissingLines(a, b) {\r\n  const out = [];\r\n  const seen = new Set();\r\n  [a, b].forEach((list) => {\r\n    if (!Array.isArray(list)) return;\r\n    list.forEach((line) => {\r\n      const val = String(line || \"\").trim();\r\n      if (!val || seen.has(val)) return;\r\n      seen.add(val);\r\n      out.push(val);\r\n    });\r\n  });\r\n  return out.slice(0, 15);\r\n}\r\n\r\nfunction findArrayItemIndex(arr, part) {\r\n  if (!Array.isArray(arr)) return -1;\r\n  const byKey = arr.findIndex(\r\n    (item) => item && typeof item === \"object\" && \"key\" in item && String(item.key) === part\r\n  );\r\n  if (byKey !== -1) return byKey;\r\n  const byName = arr.findIndex(\r\n    (item) => item && typeof item === \"object\" && \"name\" in item && String(item.name) === part\r\n  );\r\n  if (byName !== -1) return byName;\r\n  const byGrade = arr.findIndex(\r\n    (item) => item && typeof item === \"object\" && \"grade\" in item && String(item.grade) === part\r\n  );\r\n  if (byGrade !== -1) return byGrade;\r\n  const idx = Number(part);\r\n  if (Number.isInteger(idx) && String(idx) === part && idx >= 0 && idx < arr.length) return idx;\r\n  return -1;\r\n}\r\n\r\nfunction setValueAtPath(obj, parts, value) {\r\n  if (!obj || !Array.isArray(parts) || !parts.length) return false;\r\n  let cur = obj;\r\n  for (let i = 0; i < parts.length - 1; i++) {\r\n    const part = parts[i];\r\n    if (cur == null) return false;\r\n    if (Array.isArray(cur)) {\r\n      const idx = findArrayItemIndex(cur, part);\r\n      if (idx < 0) return false;\r\n      if (cur[idx] == null || typeof cur[idx] !== \"object\") cur[idx] = {};\r\n      cur = cur[idx];\r\n      continue;\r\n    }\r\n    if (typeof cur !== \"object\") return false;\r\n    if (cur[part] == null || typeof cur[part] !== \"object\") cur[part] = {};\r\n    cur = cur[part];\r\n  }\r\n  const last = parts[parts.length - 1];\r\n  if (Array.isArray(cur)) {\r\n    const idx = findArrayItemIndex(cur, last);\r\n    if (idx < 0) return false;\r\n    cur[idx] = value;\r\n    return true;\r\n  }\r\n  if (cur == null || typeof cur !== \"object\") return false;\r\n  cur[last] = value;\r\n  return true;\r\n}\r\n\r\nexport default function SchoolPage() {\r\n  const { id } = useParams();\r\n  const location = useLocation();\r\n  const navigate = useNavigate();\r\n  const outlet = useOutletContext();\r\n  const schoolId = Number(id);\r\n\r\n  const [school, setSchool] = useState(null);\r\n  const [err, setErr] = useState(\"\");\r\n\r\n  // user profile (region, country, etc.)\r\n  const [me, setMe] = useState(null);\r\n\r\n  useEffect(() => {\r\n    const base = \"Feasibility Studio\";\r\n    document.title = school?.name ? `${school.name}  ${base}` : `School  ${base}`;\r\n  }, [school?.name]);\r\n\r\n  // Selected scenario meta and related state must be defined before\r\n  // they are referenced in refreshWorkItems and submitWorkItem.\r\n  const [selectedScenario, setSelectedScenario] = useState(null);\r\n  const [prevReport, setPrevReport] = useState(null);\r\n  const [prevScenarioMeta, setPrevScenarioMeta] = useState(null);\r\n  // Work items list for the currently selected scenario.  Each entry\r\n  // represents a module (e.g. gelirler.unit_fee) and tracks its\r\n  // workflow state.  When the selected scenario changes the list is\r\n  // reloaded from the server.  Principals and HR users can submit\r\n  // modules for review via submitWorkItem, which will refresh this list.\r\n  const [workItems, setWorkItems] = useState([]);\r\n  const [workItemsLoaded, setWorkItemsLoaded] = useState(false);\r\n  const [requiredWorkIds, setRequiredWorkIds] = useState([]);\r\n  const [scenarioMetaLoaded, setScenarioMetaLoaded] = useState(false);\r\n  const [reviewingWorkItem, setReviewingWorkItem] = useState(false);\r\n\r\n  // scenarios\r\n  const [scenarios, setScenarios] = useState([]);\r\n  const [selectedScenarioId, setSelectedScenarioId] = useState(() => readSelectedScenarioId(schoolId));\r\n  const [pendingTabAfterSelect, setPendingTabAfterSelect] = useState(null);\r\n\r\n\r\n  // Refresh the work items for the current scenario.  This helper\r\n  // fetches the work item list from the backend and updates state.\r\n  // It is memoized on schoolId and selectedScenario.id to avoid\r\n  // unnecessary re-renders.  When no scenario is selected, it\r\n  // clears the list.\r\n  const refreshWorkItems = useCallback(async () => {\r\n    const sid = selectedScenario?.id;\r\n    if (!sid || !schoolId) {\r\n      setWorkItems([]);\r\n      setWorkItemsLoaded(false);\r\n      setRequiredWorkIds([]);\r\n      return;\r\n    }\r\n    try {\r\n      const data = await api.listWorkItems(schoolId, sid);\r\n      setWorkItems(Array.isArray(data?.workItems) ? data.workItems : []);\r\n      setRequiredWorkIds(Array.isArray(data?.requiredWorkIds) ? data.requiredWorkIds : []);\r\n      setWorkItemsLoaded(true);\r\n    } catch (_) {\r\n      // ignore errors, keep existing list\r\n      setRequiredWorkIds([]);\r\n      setWorkItemsLoaded(true);\r\n    }\r\n  }, [schoolId, selectedScenario?.id]);\r\n\r\n  // Refresh scenario metadata (status/sent_at/checked_at) without touching inputs/report.\r\n  const refreshScenarioMeta = useCallback(async () => {\r\n    if (!schoolId) return;\r\n    setScenarioMetaLoaded(false);\r\n    try {\r\n      const data = await api.listScenarios(schoolId, {\r\n        limit: 50,\r\n        offset: 0,\r\n        fields: \"brief\",\r\n        order: \"created_at:desc\",\r\n      });\r\n      const list = Array.isArray(data?.items) ? data.items : [];\r\n      setScenarios(list);\r\n      const scenarioId = selectedScenarioId ?? selectedScenario?.id;\r\n      if (scenarioId != null) {\r\n        const nextScenario = list.find((item) => String(item?.id) === String(scenarioId));\r\n        if (nextScenario) {\r\n          setSelectedScenario((prev) => (prev ? { ...prev, ...nextScenario } : nextScenario));\r\n        }\r\n      }\r\n      setScenarioMetaLoaded(true);\r\n    } catch (_) {\r\n      // ignore errors, keep existing meta\r\n      setScenarioMetaLoaded(false);\r\n    }\r\n  }, [schoolId, selectedScenarioId, selectedScenario?.id]);\r\n\r\n  // Submit a work item for review.  Accepts a workId string.  On\r\n  // success the work items are refreshed and a toast is shown.\r\n  const submitWorkItem = useCallback(\r\n    async (workId) => {\r\n      const sid = selectedScenario?.id;\r\n      if (!sid || !schoolId || !workId) return;\r\n      try {\r\n        await api.submitWorkItem(schoolId, sid, workId);\r\n        await refreshWorkItems();\r\n        await refreshScenarioMeta();\r\n        toast.success(\"Modl gnderildi.\");\r\n      } catch (e) {\r\n        toast.error(e.message || \"Gnderme baarsz\");\r\n      }\r\n    },\r\n    [schoolId, selectedScenario?.id, refreshWorkItems, refreshScenarioMeta]\r\n  );\r\n\r\n\r\n  // Fetch work items whenever the selected scenario changes.  If there\r\n  // is no scenario selected the list is cleared.  The refreshWorkItems\r\n  // dependency ensures that any changes to schoolId or scenario id are\r\n  // respected.\r\n  useEffect(() => {\r\n    if (!selectedScenario?.id) {\r\n      setWorkItems([]);\r\n      setWorkItemsLoaded(false);\r\n      setScenarioMetaLoaded(false);\r\n      return;\r\n    }\r\n    setWorkItemsLoaded(false);\r\n    setScenarioMetaLoaded(false);\r\n    refreshWorkItems();\r\n  }, [selectedScenario?.id, refreshWorkItems]);\r\n\r\n  // removed duplicate declarations for selectedScenario, prevReport,\r\n  // prevScenarioMeta, and workItems. These are now defined earlier\r\n  // before they are used in callbacks.\r\n\r\n  // norm\r\n  const [norm, setNorm] = useState(null);\r\n  const [progressConfig, setProgressConfig] = useState(null);\r\n\r\n  // inputs\r\n  const [inputs, setInputs] = useState(null);\r\n  const [inputsSaving, setInputsSaving] = useState(false);\r\n  const [dirtyPaths, setDirtyPaths] = useState(() => new Set());\r\n  const [baselineInputs, setBaselineInputs] = useState(null);\r\n  const [baselineNorm, setBaselineNorm] = useState(null);\r\n  const clearDirtyPrefix = useCallback((prefix) => {\r\n    setDirtyPaths((prev) => {\r\n      if (!prev.size) return prev;\r\n      let changed = false;\r\n      const next = new Set();\r\n      for (const path of prev) {\r\n        if (path.startsWith(prefix)) {\r\n          changed = true;\r\n          continue;\r\n        }\r\n        next.add(path);\r\n      }\r\n      return changed ? next : prev;\r\n    });\r\n  }, []);\r\n  const hasDirtyPrefix = useCallback(\r\n    (prefix) => {\r\n      for (const path of dirtyPaths) {\r\n        if (path === prefix || path.startsWith(prefix)) return true;\r\n      }\r\n      return false;\r\n    },\r\n    [dirtyPaths]\r\n  );\r\n  // report\r\n  const [report, setReport] = useState(null);\r\n  const [calculating, setCalculating] = useState(false);\r\n  const [lastSavedAt, setLastSavedAt] = useState(null);\r\n  const [lastCalculatedAt, setLastCalculatedAt] = useState(null);\r\n  const [nowTick, setNowTick] = useState(0);\r\n  const [exportOpen, setExportOpen] = useState(false);\r\n  const exportMenuRef = useRef(null);\r\n  const reportExportRef = useRef(null);\r\n  const [exportingPdf, setExportingPdf] = useState(false);\r\n  // Page boot loading (used to show a spinner while auto-starting the scenario wizard)\r\n  const [bootLoading, setBootLoading] = useState(true);\r\n  const [bootLoadingLabel, setBootLoadingLabel] = useState(\"Okul ailiyor...\");\r\n\r\n  useEffect(() => {\r\n    setSelectedScenarioId(readSelectedScenarioId(schoolId));\r\n  }, [schoolId]);\r\n\r\n  const uiScopeKey = useMemo(\r\n    () => `school:${schoolId}:scenario:${selectedScenarioId ?? \"none\"}`,\r\n    [schoolId, selectedScenarioId]\r\n  );\r\n  const [reportCurrency, setReportCurrency] = useScenarioUiState(\"report.currency\", \"usd\", { scope: uiScopeKey });\r\n  const reportCurrencyDefaultedForRef = useRef(null);\r\n  const [reportMode, setReportMode] = useScenarioUiState(\"report.mode\", \"original\", { scope: uiScopeKey });\r\n  const [reportModeLoading, setReportModeLoading] = useState(false);\r\n  const [detailedReportMode, setDetailedReportMode] = useScenarioUiString(\"school.detailedReportMode\", \"detailed\", { scope: uiScopeKey });\r\n  const activeRouteSegment = useMemo(() => {\r\n    const base = `/schools/${schoolId}/`;\r\n    if (!location.pathname.startsWith(base)) return \"\";\r\n    return location.pathname.slice(base.length).split(\"/\")[0] || \"\";\r\n  }, [location.pathname, schoolId]);\r\n  const tab = ROUTE_TO_TAB[activeRouteSegment] || \"\";\r\n  const activeWorkId = TAB_TO_WORK_ID[tab] || null;\r\n  const activeWorkItem = useMemo(() => {\r\n    if (!activeWorkId || !Array.isArray(workItems)) return null;\r\n    return workItems.find((item) => String(item?.work_id) === String(activeWorkId)) || null;\r\n  }, [activeWorkId, workItems]);\r\n  const activeWorkState = activeWorkItem?.state ? String(activeWorkItem.state) : \"not_started\";\r\n  const moduleLocked = [\"submitted\", \"approved\"].includes(activeWorkState);\r\n  const setTab = React.useCallback(\r\n    (nextTab) => {\r\n      const segment = TAB_TO_ROUTE[nextTab];\r\n      if (!segment) return;\r\n      navigate(`/schools/${schoolId}/${segment}`);\r\n    },\r\n    [navigate, schoolId]\r\n  );\r\n\r\n  useEffect(() => {\r\n    // Persist the current route segment for the given school and scenario. When\r\n    // no scenario is selected (`selectedScenarioId` is null) the helper will\r\n    // store the path under a \"none\" scenario key. This ensures that we\r\n    // remember the last page even before a scenario is chosen.\r\n    if (!ROUTE_TO_TAB[activeRouteSegment]) return;\r\n    writeLastVisitedPath(schoolId, selectedScenarioId, activeRouteSegment);\r\n  }, [activeRouteSegment, schoolId, selectedScenarioId]);\r\n\r\n  // Persist the current route segment globally so that when switching between\r\n  // schools or scenarios the user returns to the same sidebar page. This is\r\n  // independent of school or scenario context.\r\n  useEffect(() => {\r\n    if (!ROUTE_TO_TAB[activeRouteSegment]) return;\r\n    writeGlobalLastRouteSegment(activeRouteSegment);\r\n  }, [activeRouteSegment]);\r\n\r\n  useEffect(() => {\r\n    // When the user loads the base school path (e.g. `/schools/4`), redirect to\r\n    // the last visited route for the current school and scenario. If no\r\n    // scenario is selected we still look up the \"none\" scenario key. If\r\n    // nothing is recorded, default to the basics tab.\r\n    const base = `/schools/${schoolId}`;\r\n    if (location.pathname !== base && location.pathname !== `${base}/`) return;\r\n    const last = readLastVisitedPath(schoolId, selectedScenarioId);\r\n    const targetSegment = last || TAB_TO_ROUTE.basics;\r\n    const target = `${base}/${targetSegment}`;\r\n    navigate(target, { replace: true });\r\n  }, [location.pathname, navigate, schoolId, selectedScenarioId]);\r\n\r\n  useEffect(() => {\r\n    setBootLoading(true);\r\n    setBootLoadingLabel(\"Okul ailiyor...\");\r\n  }, [schoolId]);\r\n\r\n  useEffect(() => {\r\n    if (!pendingTabAfterSelect) return;\r\n    if (!selectedScenarioId) return;\r\n    if (String(selectedScenarioId) !== String(pendingTabAfterSelect.scenarioId)) return;\r\n    setTab(pendingTabAfterSelect.tab);\r\n    setPendingTabAfterSelect(null);\r\n  }, [pendingTabAfterSelect, selectedScenarioId, setTab]);\r\n\r\n  useEffect(() => {\r\n    const id = setInterval(() => setNowTick(Date.now()), 30000);\r\n    return () => clearInterval(id);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!exportOpen) return;\r\n    const handleClick = (event) => {\r\n      const el = exportMenuRef.current;\r\n      if (!el || el.contains(event.target)) return;\r\n      setExportOpen(false);\r\n    };\r\n    const handleKey = (event) => {\r\n      if (event.key === \"Escape\") setExportOpen(false);\r\n    };\r\n    document.addEventListener(\"mousedown\", handleClick);\r\n    document.addEventListener(\"keydown\", handleKey);\r\n    return () => {\r\n      document.removeEventListener(\"mousedown\", handleClick);\r\n      document.removeEventListener(\"keydown\", handleKey);\r\n    };\r\n  }, [exportOpen]);\r\n\r\n\r\n  const scenarioYears = parseAcademicYear(selectedScenario?.academic_year);\r\n  const baseYear = scenarioYears.startYear;\r\n  const inputCurrencyCode =\r\n    selectedScenario?.input_currency === \"LOCAL\"\r\n      ? (selectedScenario.local_currency_code || \"LOCAL\")\r\n      : \"USD\";\r\n  const isLocalScenario = selectedScenario?.input_currency === \"LOCAL\";\r\n  const prevRealFxValue = Number(inputs?.temelBilgiler?.performans?.prevYearRealizedFxUsdToLocal || 0);\r\n  const prevRealFxMissing = isLocalScenario && !(Number.isFinite(prevRealFxValue) && prevRealFxValue > 0);\r\n\r\n  const programType = useMemo(() => getProgramType(inputs, selectedScenario), [inputs, selectedScenario]);\r\n  const permissionScope = useMemo(() => {\r\n    const countryId = school?.country_id ?? me?.country_id ?? null;\r\n    return { schoolId, countryId };\r\n  }, [schoolId, school?.country_id, me?.country_id]);\r\n  const canReadNorm = useMemo(() => {\r\n    try {\r\n      return can(me, \"page.norm\", \"read\", permissionScope);\r\n    } catch {\r\n      return false;\r\n    }\r\n  }, [me, permissionScope]);\r\n  const canWriteGiderler = useMemo(() => {\r\n    try {\r\n      if (can(me, \"section.giderler.isletme\", \"write\", permissionScope)) return true;\r\n      return can(me, \"page.giderler\", \"write\", permissionScope);\r\n    } catch {\r\n      return false;\r\n    }\r\n  }, [me, permissionScope]);\r\n  const ignoreNormProgress = !norm && !canReadNorm;\r\n\r\n  const scenarioProgress = useMemo(\r\n    () => computeScenarioProgress({ inputs, norm, config: progressConfig, scenario: selectedScenario }),\r\n    [inputs, norm, progressConfig, selectedScenario]\r\n  );\r\n  const isHQ = useMemo(() => isHeadquarterScenario(inputs), [inputs]);\r\n  useEffect(() => {\r\n    if (schoolId && selectedScenarioId && inputs) {\r\n      writeScenarioFlags(schoolId, selectedScenarioId, { isHeadquarter: isHQ });\r\n    }\r\n  }, [schoolId, selectedScenarioId, inputs, isHQ]);\r\n  const progMap = useMemo(\r\n    () => Object.fromEntries((scenarioProgress?.tabs || []).map((t) => [t.key, t])),\r\n    [scenarioProgress]\r\n  );\r\n  const normAvgPct = useMemo(() => {\r\n    const a = pctValue(progMap.gradesPlan);\r\n    const b = ignoreNormProgress ? a : pctValue(progMap.norm);\r\n    return Math.round((a + b) / 2);\r\n  }, [progMap, ignoreNormProgress]);\r\n  const expensesAvgPct = useMemo(() => {\r\n    const a = pctValue(progMap.giderler);\r\n    if (isHQ) return a;\r\n    // Use the new discounts key instead of the legacy indirimler key.  If the\r\n    // discounts tab is missing, default to 0 for the percentage value.\r\n    const b = pctValue(progMap.discounts);\r\n    return Math.round((a + b) / 2);\r\n  }, [progMap, isHQ]);\r\n  const normMissingLines = useMemo(\r\n    () => mergeMissingLines(progMap.gradesPlan?.missingLines, progMap.norm?.missingLines),\r\n    [progMap]\r\n  );\r\n  const expensesMissingLines = useMemo(\r\n    () =>\r\n      isHQ\r\n        ? Array.isArray(progMap.giderler?.missingLines)\r\n          ? progMap.giderler.missingLines\r\n          : []\r\n        : mergeMissingLines(progMap.giderler?.missingLines, progMap.discounts?.missingLines),\r\n    [progMap, isHQ]\r\n  );\r\n\r\n  const fetchScenarioReport = useCallback(\r\n    async (mode) => {\r\n      if (!selectedScenarioId) return;\r\n      const nextMode = String(mode || \"original\");\r\n      setReportModeLoading(true);\r\n      setErr(\"\");\r\n      try {\r\n        const data = await api.getScenarioReport(schoolId, selectedScenarioId, nextMode);\r\n        setReport(data?.results || null);\r\n      } catch (e) {\r\n        setErr(e.message || \"Report fetch failed\");\r\n      } finally {\r\n        setReportModeLoading(false);\r\n      }\r\n    },\r\n    [schoolId, selectedScenarioId]\r\n  );\r\n\r\n  const handleReportModeChange = useCallback(\r\n    async (mode) => {\r\n      const nextMode = String(mode || \"original\");\r\n      if (nextMode === reportMode && report) return;\r\n      setReportMode(nextMode);\r\n      await fetchScenarioReport(nextMode);\r\n    },\r\n    [fetchScenarioReport, reportMode, report, setReportMode]\r\n  );\r\n  useEffect(() => {\r\n    if (!outlet?.setHeaderMeta) return;\r\n    outlet.setHeaderMeta({\r\n      title: school?.name ? school.name : \"Okul\",\r\n      subtitle: selectedScenario\r\n        ? `${selectedScenario.name}${selectedScenario.academic_year ? `  ${selectedScenario.academic_year}` : \"\"}`\r\n        : \"Senaryo sein\",\r\n      hideDefault: false,\r\n      centered: true,\r\n    });\r\n    return () => {\r\n      outlet.clearHeaderMeta?.();\r\n    };\r\n  }, [outlet, selectedScenario, school?.name]);\r\n\r\n  // A) Helper: HR(IK) -> Expenses(Isletme) 5 salary rows auto patch (uses 1.Yil / y1)\r\n  const applyIkSalariesToGiderler = useCallback((inInputs) => {\r\n    const src = inInputs || {};\r\n    const ik = src.ik || {};\r\n    const yearIK = ik?.years?.y1 ? ik.years.y1 : ik; // legacy support\r\n\r\n    const unitCosts = yearIK?.unitCosts || {};\r\n    const headcountsByLevel = yearIK?.headcountsByLevel || {};\r\n\r\n    const roles = [\r\n      \"turk_mudur\",\r\n      \"turk_mdyard\",\r\n      \"turk_egitimci\",\r\n      \"turk_temsil\",\r\n      \"yerel_yonetici_egitimci\",\r\n      \"yerel_destek\",\r\n      \"yerel_ulke_temsil_destek\",\r\n      \"int_yonetici_egitimci\",\r\n    ];\r\n\r\n    const levelKeys = Object.keys(headcountsByLevel || {});\n    const levels = levelKeys.length\n      ? levelKeys\n      : [\n          \"okulOncesi\",\n          \"ilkokulYerel\",\n          \"ilkokulInt\",\n          \"ortaokulYerel\",\n          \"ortaokulInt\",\n          \"liseYerel\",\n          \"liseInt\",\n        ];\n\r\n    const roleAnnual = {};\r\n    for (const r of roles) {\r\n      let count = 0;\r\n      for (const lvl of levels) count += Number(headcountsByLevel?.[lvl]?.[r] || 0);\r\n      roleAnnual[r] = Number(unitCosts?.[r] || 0) * count;\r\n    }\r\n\r\n    const patch = {\r\n      turkPersonelMaas:\r\n        (roleAnnual.turk_mudur || 0) +\r\n        (roleAnnual.turk_mdyard || 0) +\r\n        (roleAnnual.turk_egitimci || 0),\r\n      turkDestekPersonelMaas: roleAnnual.turk_temsil || 0,\r\n      yerelPersonelMaas: roleAnnual.yerel_yonetici_egitimci || 0,\r\n      yerelDestekPersonelMaas:\r\n        (roleAnnual.yerel_destek || 0) + (roleAnnual.yerel_ulke_temsil_destek || 0),\r\n      internationalPersonelMaas: roleAnnual.int_yonetici_egitimci || 0,\r\n    };\r\n\r\n    const prevItems = src?.giderler?.isletme?.items || {};\r\n    const keys = Object.keys(patch);\r\n\r\n    let changed = false;\r\n    for (const k of keys) {\r\n      const a = Number(prevItems?.[k] || 0);\r\n      const b = Number(patch?.[k] || 0);\r\n      if (Math.abs(a - b) > 1e-6) {\r\n        changed = true;\r\n        break;\r\n      }\r\n    }\r\n    if (!changed) return src;\r\n\r\n    const next = structuredClone(src);\r\n    next.giderler = next.giderler || {};\r\n    next.giderler.isletme = next.giderler.isletme || {};\r\n    next.giderler.isletme.items = next.giderler.isletme.items || {};\r\n    for (const k of keys) next.giderler.isletme.items[k] = Number(patch[k] || 0);\r\n    return next;\r\n  }, []);\r\n\r\n  const normalizeCapacityInputs = useCallback((src) => {\r\n    const safeNum = (v) => {\r\n      const n = Number(v);\r\n      return Number.isFinite(n) ? n : 0;\r\n    };\r\n\r\n    const s = src || {};\r\n    const legacy = safeNum(s.schoolCapacity);\r\n\r\n    const cap = s.kapasite && typeof s.kapasite === \"object\" ? s.kapasite : {};\r\n    const years = cap.years && typeof cap.years === \"object\" ? cap.years : {};\r\n\r\n    const y1 = safeNum(years.y1 != null ? years.y1 : legacy);\r\n    const y2 = safeNum(years.y2 != null ? years.y2 : y1);\r\n    const y3 = safeNum(years.y3 != null ? years.y3 : y1);\r\n\r\n    const currentStudents = safeNum(cap.currentStudents);\r\n    const byKademe = cap.byKademe && typeof cap.byKademe === \"object\" ? cap.byKademe : {};\r\n\r\n    const needsPatch =\r\n      \"schoolCapacity\" in s ||\r\n      !s.kapasite ||\r\n      typeof s.kapasite !== \"object\" ||\r\n      !cap.years ||\r\n      typeof cap.years !== \"object\" ||\r\n      safeNum(cap?.years?.y1) !== y1 ||\r\n      safeNum(cap?.years?.y2) !== y2 ||\r\n      safeNum(cap?.years?.y3) !== y3 ||\r\n      safeNum(cap?.currentStudents) !== currentStudents ||\r\n      !cap.byKademe ||\r\n      typeof cap.byKademe !== \"object\";\r\n\r\n    if (!needsPatch) return s;\r\n\r\n    const next = structuredClone(s);\r\n    next.kapasite = {\r\n      ...(cap || {}),\r\n      currentStudents,\r\n      years: { y1, y2, y3 },\r\n      byKademe,\r\n    };\r\n    if (\"schoolCapacity\" in next) delete next.schoolCapacity;\r\n    return next;\r\n  }, []);\r\n\r\n\r\n  const normalizeTemelBilgilerInputs = (src) => {\r\n    const s = src || {};\r\n    const t = s.temelBilgiler && typeof s.temelBilgiler === \"object\" ? s.temelBilgiler : {};\r\n    const next = structuredClone(s);\r\n\r\n    // inflation defaults\r\n    const inf = t.inflation && typeof t.inflation === \"object\" ? t.inflation : {};\r\n    const toFinite = (v) => (Number.isFinite(Number(v)) ? Number(v) : 0);\r\n    next.temelBilgiler = {\r\n      inflation: {\r\n        ...inf,\r\n        expenseDeviationPct: toFinite(inf.expenseDeviationPct),\r\n        y2023: toFinite(inf.y2023),\r\n        y2024: toFinite(inf.y2024),\r\n        y2025: toFinite(inf.y2025),\r\n        y1: toFinite(inf.y1),\r\n        y2: toFinite(inf.y2),\r\n        y3: toFinite(inf.y3),\r\n        currentSeasonAvgFee: toFinite(inf.currentSeasonAvgFee),\r\n      },\r\n      yetkililer: t.yetkililer || { mudur: \"\", ulkeTemsilcisi: \"\", raporuHazirlayan: \"\" },\r\n      okulEgitimBilgileri: t.okulEgitimBilgileri || {\r\n        egitimBaslamaTarihi: \"\",\r\n        zorunluEgitimDonemleri: \"\",\r\n        birDersSuresiDakika: 0,\r\n        gunlukDersSaati: 0,\r\n        haftalikDersSaatiToplam: 0,\r\n        sabahciOglenci: \"\",\r\n        ogretmenHaftalikDersOrt: 0,\r\n        gecisSinaviBilgisi: \"\",\r\n        uygulananProgram: \"\",\r\n      },\r\n      kademeler: normalizeKademeConfig(t.kademeler),\r\n      programType: normalizeProgramType(t.programType),\r\n      okulUcretleriHesaplama: typeof t.okulUcretleriHesaplama === \"boolean\" ? t.okulUcretleriHesaplama : true,\r\n      ucretArtisOranlari: t.ucretArtisOranlari || {\r\n        okulOncesi: 0,\r\n        ilkokulYerel: 0,\r\n        ilkokulInt: 0,\r\n        ortaokulYerel: 0,\r\n        ortaokulInt: 0,\r\n        liseYerel: 0,\r\n        liseInt: 0,\r\n      },\r\n      ikMevcut: t.ikMevcut || {\r\n        turkPersonelYoneticiEgitimci: 0,\r\n        turkPersonelTemsilcilik: 0,\r\n        yerelKadroluEgitimci: 0,\r\n        yerelUcretliVakaterEgitimci: 0,\r\n        yerelDestek: 0,\r\n        yerelTemsilcilik: 0,\r\n        international: 0,\r\n      },\r\n      bursIndirimOgrenciSayilari: t.bursIndirimOgrenciSayilari || {\r\n        magisBasariBursu: 0,\r\n        maarifYetenekBursu: 0,\r\n        ihtiyacBursu: 0,\r\n        okulBasariBursu: 0,\r\n        tamEgitimBursu: 0,\r\n        barinmaBursu: 0,\r\n        turkceBasariBursu: 0,\r\n        uluslararasiYukumlulukIndirimi: 0,\r\n        vakifCalisaniIndirimi: 0,\r\n        kardesIndirimi: 0,\r\n        erkenKayitIndirimi: 0,\r\n        pesinOdemeIndirimi: 0,\r\n        kademeGecisIndirimi: 0,\r\n        temsilIndirimi: 0,\r\n        kurumIndirimi: 0,\r\n        istisnaiIndirim: 0,\r\n        yerelMevzuatIndirimi: 0,\r\n      },\r\n      rakipAnalizi: t.rakipAnalizi || {\r\n        okulOncesi: { a: 0, b: 0, c: 0 },\r\n        ilkokul: { a: 0, b: 0, c: 0 },\r\n        ortaokul: { a: 0, b: 0, c: 0 },\r\n        lise: { a: 0, b: 0, c: 0 },\r\n      },\r\n      performans: t.performans || {\r\n        gerceklesen: { ogrenciSayisi: 0, gelirler: 0, giderler: 0, karZarar: 0, bursVeIndirimler: 0 },\r\n      },\r\n      degerlendirme: typeof t.degerlendirme === \"string\" ? t.degerlendirme : \"\",\r\n    };\r\n\r\n    return next;\r\n  };\r\n\r\n  const normalizeGradesInputs = useCallback((src) => {\r\n    const s = src || {};\r\n    const defaultGrades = getGradeOptions().map((g) => ({ grade: g, branchCount: 0, studentsPerBranch: 0 }));\r\n    const baseGrades = Array.isArray(s.grades) ? s.grades : defaultGrades;\r\n    const years = s.gradesYears && typeof s.gradesYears === \"object\" ? s.gradesYears : {};\r\n\r\n    const y1 = Array.isArray(years.y1) ? years.y1 : baseGrades;\r\n    const y2 = Array.isArray(years.y2) ? years.y2 : y1;\r\n    const y3 = Array.isArray(years.y3) ? years.y3 : y1;\r\n\r\n    const normalizeRow = (row) => ({\r\n      grade: String(row?.grade ?? \"\"),\r\n      branchCount: Number(row?.branchCount ?? 0),\r\n      studentsPerBranch: Number(row?.studentsPerBranch ?? 0),\r\n    });\r\n\r\n    const toMap = (list) => {\r\n      const m = new Map();\r\n      (Array.isArray(list) ? list : []).forEach((row) => {\r\n        const r = normalizeRow(row);\r\n        if (!r.grade) return;\r\n        m.set(r.grade, r);\r\n      });\r\n      return m;\r\n    };\r\n\r\n    const areGradesEqual = (a, b) => {\r\n      if (!Array.isArray(a) || !Array.isArray(b)) return false;\r\n      const ma = toMap(a);\r\n      const mb = toMap(b);\r\n      if (ma.size !== mb.size) return false;\r\n      for (const [grade, ra] of ma.entries()) {\r\n        const rb = mb.get(grade);\r\n        if (!rb) return false;\r\n        if (Number(ra.branchCount) !== Number(rb.branchCount)) return false;\r\n        if (Number(ra.studentsPerBranch) !== Number(rb.studentsPerBranch)) return false;\r\n      }\r\n      return true;\r\n    };\r\n\r\n    const needsPatch =\r\n      !s.gradesYears ||\r\n      !Array.isArray(s.grades) ||\r\n      !Array.isArray(years.y1) ||\r\n      !Array.isArray(years.y2) ||\r\n      !Array.isArray(years.y3) ||\r\n      !areGradesEqual(s.grades, y1);\r\n\r\n    if (!needsPatch) return s;\r\n\r\n    const next = structuredClone(s);\r\n    next.gradesYears = {\r\n      y1: structuredClone(y1),\r\n      y2: structuredClone(y2),\r\n      y3: structuredClone(y3),\r\n    };\r\n    next.grades = structuredClone(next.gradesYears.y1);\r\n    return next;\r\n  }, []);\r\n\r\n  const applyTuitionStudentCounts = useCallback((src) => {\r\n    const s = src && typeof src === \"object\" ? src : {};\r\n    const grades = s?.gradesYears?.y1 || s?.grades || [];\r\n    const sums = summarizeGradesByKademe(grades, s?.temelBilgiler?.kademeler);\r\n    const programType = getProgramType(s);\r\n    const variantCounts = {\r\n      okulOncesi: Number(sums.okulOncesi || 0),\r\n      ilkokulYerel: 0,\r\n      ilkokulInt: 0,\r\n      ortaokulYerel: 0,\r\n      ortaokulInt: 0,\r\n      liseYerel: 0,\r\n      liseInt: 0,\r\n    };\r\n    variantCounts[mapBaseKademeToVariant(\"ilkokul\", programType)] = Number(sums.ilkokul || 0);\r\n    variantCounts[mapBaseKademeToVariant(\"ortaokul\", programType)] = Number(sums.ortaokul || 0);\r\n    variantCounts[mapBaseKademeToVariant(\"lise\", programType)] = Number(sums.lise || 0);\r\n\r\n    const syncRows = (rows, getCount) => {\r\n      if (!Array.isArray(rows)) return { rows, changed: false };\r\n      let changed = false;\r\n      const nextRows = rows.map((r) => {\r\n        const key = String(r?.key ?? \"\");\r\n        const nextCount = getCount(key);\r\n        if (nextCount == null) return r;\r\n        const current = Number(r?.studentCount ?? 0);\r\n        if (Math.abs(current - nextCount) < 1e-6) return r;\r\n        changed = true;\r\n        return { ...r, studentCount: nextCount };\r\n      });\r\n      return { rows: changed ? nextRows : rows, changed };\r\n    };\r\n\r\n    const tuitionSync = syncRows(s?.gelirler?.tuition?.rows, (key) =>\r\n      Object.prototype.hasOwnProperty.call(variantCounts, key) ? variantCounts[key] : null\r\n    );\r\n\r\n    if (!tuitionSync.changed) return s;\r\n\r\n    const next = structuredClone(s);\r\n    next.gelirler = next.gelirler || {};\r\n    if (tuitionSync.changed) {\r\n      next.gelirler.tuition = next.gelirler.tuition || {};\r\n      next.gelirler.tuition.rows = tuitionSync.rows;\r\n    }\r\n    return next;\r\n  }, []);\r\n\r\n\r\n  async function loadAll() {\r\n    setErr(\"\");\r\n    setBootLoading(true);\r\n    setBootLoadingLabel(\"Okul ailiyor...\");\r\n    try {\r\n      const s = await api.getSchool(schoolId);\r\n      setSchool(s);\r\n\r\n      // load current user profile (region/country)\r\n      try {\r\n        const meInfo = await api.getMe();\r\n        setMe(meInfo);\r\n      } catch (_) {\r\n        // ignore (e.g., token missing)\r\n      }\r\n\r\n      setBootLoadingLabel(\"Senaryolar kontrol ediliyor...\");\r\n      const sc = await api.listScenarios(schoolId, {\r\n        limit: 50,\r\n        offset: 0,\r\n        fields: \"brief\",\r\n        order: \"created_at:desc\",\r\n      });\r\n      const rows = Array.isArray(sc?.items) ? sc.items : [];\r\n      setScenarios(rows);\r\n      if (selectedScenarioId != null) {\r\n        const exists = rows.some((x) => String(x.id) === String(selectedScenarioId));\r\n        if (!exists) {\r\n          writeSelectedScenarioId(schoolId, null);\r\n          setSelectedScenarioId(null);\r\n        }\r\n      }\r\n      setBootLoading(false);\r\n\r\n    } catch (e) {\r\n      setErr(e.message || \"Failed to load school\");\r\n      setBootLoading(false);\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    let active = true;\r\n    async function loadProgressConfig() {\r\n      try {\r\n        const data = await api.getProgressRequirements();\r\n        if (!active) return;\r\n        setProgressConfig(data?.config || data || null);\r\n      } catch (_) {\r\n        if (!active) return;\r\n        setProgressConfig(null);\r\n      }\r\n    }\r\n    loadProgressConfig();\r\n    return () => {\r\n      active = false;\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    loadAll(); /* eslint-disable-next-line */\r\n  }, [schoolId]);\r\n\r\n  useEffect(() => {\r\n    async function loadScenario() {\r\n      if (!selectedScenarioId) {\r\n        setSelectedScenario(null);\r\n        setInputs(null);\r\n        setBaselineInputs(null);\r\n        setReport(null);\r\n        setPrevReport(null);\r\n        setPrevScenarioMeta(null);\r\n        setNorm(null);\r\n        setBaselineNorm(null);\r\n        clearDirtyPrefix(\"inputs.\");\r\n        clearDirtyPrefix(\"norm.\");\r\n        return;\r\n      }\r\n      setErr(\"\");\r\n      setReport(null);\r\n      setLastSavedAt(null);\r\n      setLastCalculatedAt(null);\r\n      try {\r\n        const data = await api.getScenarioContext(schoolId, selectedScenarioId);\r\n\r\n        // IMPORTANT FIX:\r\n        setSelectedScenario(data?.scenario || null);\r\n\r\n        // IMPORTANT FIX:\r\n        // If backend returns null/undefined inputs, don't convert it to {}.\r\n        const raw = data?.inputs;\r\n        const normalized =\r\n          raw && typeof raw === \"object\"\r\n            ? normalizeGradesInputs(normalizeTemelBilgilerInputs(normalizeCapacityInputs(raw)))\r\n            : raw;\r\n        setInputs(normalized);\r\n        setBaselineInputs(normalized && typeof normalized === \"object\" ? structuredClone(normalized) : normalized);\r\n        clearDirtyPrefix(\"inputs.\");\r\n\r\n        const n = data?.norm ?? null;\r\n        setNorm(n);\r\n        setBaselineNorm(n ? structuredClone(n) : null);\r\n        clearDirtyPrefix(\"norm.\");\r\n      } catch (e) {\r\n        setErr(e.message || \"Failed to load scenario inputs\");\r\n      }\r\n    }\r\n    loadScenario();\r\n  }, [\r\n    schoolId,\r\n    selectedScenarioId,\r\n    clearDirtyPrefix,\r\n    normalizeCapacityInputs,\r\n    normalizeGradesInputs,\r\n  ]);\r\n\r\n  useEffect(() => {\r\n    if (!selectedScenarioId) {\r\n      reportCurrencyDefaultedForRef.current = null;\r\n      return;\r\n    }\r\n    const scenarioId = selectedScenario?.id;\r\n    if (!scenarioId || String(scenarioId) !== String(selectedScenarioId)) return;\r\n\r\n    const isLocal =\r\n      selectedScenario?.input_currency === \"LOCAL\" &&\r\n      Number(selectedScenario?.fx_usd_to_local) > 0 &&\r\n      selectedScenario?.local_currency_code;\r\n    const scenarioKey = String(scenarioId);\r\n\r\n    if (reportCurrencyDefaultedForRef.current !== scenarioKey) {\r\n      setReportCurrency(isLocal ? \"local\" : \"usd\");\r\n      reportCurrencyDefaultedForRef.current = scenarioKey;\r\n      return;\r\n    }\r\n\r\n    if (!isLocal && reportCurrency !== \"usd\") {\r\n      setReportCurrency(\"usd\");\r\n    }\r\n  }, [\r\n    selectedScenarioId,\r\n    selectedScenario?.id,\r\n    selectedScenario?.input_currency,\r\n    selectedScenario?.fx_usd_to_local,\r\n    selectedScenario?.local_currency_code,\r\n    reportCurrency,\r\n    setReportCurrency,\r\n  ]);\r\n\r\n  // Load previous year's report (used in TEMEL BILGILER: performans planlanan)\r\n  useEffect(() => {\r\n    async function loadPrev() {\r\n      try {\r\n        setPrevReport(null);\r\n        setPrevScenarioMeta(null);\r\n        const year = selectedScenario?.academic_year;\r\n        if (!year || !scenarios?.length) return;\r\n\r\n        const { startYear, endYear } = parseAcademicYear(year);\r\n        if (!startYear) return;\r\n        const prevStartYear = startYear - 1;\r\n        const prevEndYear = (endYear ?? startYear) - 1;\r\n\r\n        const prevScenario = scenarios.find((s) => {\r\n          const parsed = parseAcademicYear(s?.academic_year);\r\n          return parsed.startYear === prevStartYear && parsed.endYear === prevEndYear;\r\n        });\r\n        if (!prevScenario) return;\r\n\r\n        setPrevScenarioMeta(prevScenario);\r\n        const data = await api.calculateScenario(schoolId, prevScenario.id);\r\n        setPrevReport(data?.results || null);\r\n      } catch (_) {\r\n        setPrevReport(null);\r\n      }\r\n    }\r\n    loadPrev();\r\n  }, [schoolId, selectedScenario?.academic_year, scenarios]);\r\n\r\n  const scenarioLocked = isScenarioLocked(selectedScenario);\r\n  const inputsLocked = scenarioLocked || moduleLocked;\r\n\r\n  const saveNormConfig = useCallback(async () => {\r\n    if (!norm || !selectedScenarioId) return;\r\n    const payload = norm?.years\r\n      ? { years: norm.years }\r\n      : {\r\n        teacherWeeklyMaxHours: norm.teacherWeeklyMaxHours,\r\n        curriculumWeeklyHours: norm.curriculumWeeklyHours,\r\n      };\r\n    await api.saveNormConfig(schoolId, selectedScenarioId, payload);\r\n    const n = await api.getNormConfig(schoolId, selectedScenarioId);\r\n    setNorm(n);\r\n    setBaselineNorm(n ? structuredClone(n) : null);\r\n    clearDirtyPrefix(\"norm.\");\r\n  }, [norm, selectedScenarioId, schoolId, clearDirtyPrefix]);\r\n\r\n  // B) Save inputs with HR->Expenses salary patch applied + Capacity normalization\r\n  const saveInputs = useCallback(async () => {\r\n    if (!selectedScenarioId || !inputs) return false;\r\n    if (inputsLocked) {\r\n      setErr(scenarioLocked ? \"Senaryo kilitli. Inceleme bekleniyor.\" : \"Modul kilitli. Inceleme bekleniyor.\");\r\n      return false;\r\n    }\r\n    const shouldSaveInputs = hasDirtyPrefix(\"inputs.\");\r\n    const shouldSaveNorm = hasDirtyPrefix(\"norm.\");\r\n    if (!shouldSaveInputs && !shouldSaveNorm) return true;\r\n    setInputsSaving(true);\r\n    setErr(\"\");\r\n    try {\r\n      if (shouldSaveInputs) {\r\n        let patched = applyIkSalariesToGiderler(inputs);\r\n        patched = normalizeCapacityInputs(patched);\r\n        patched = normalizeGradesInputs(patched);\r\n        patched = applyTuitionStudentCounts(patched);\r\n\r\n        if (patched !== inputs) setInputs(patched);\r\n\r\n        // Build the list of modified permission resources from the dirty input paths.  Only\r\n        // consider dirty paths that affect scenario inputs (prefixed with \"inputs.\").  Dirty\r\n        // paths under the \"norm.\" prefix are handled separately when saving the norm config.\r\n        const modifiedResourcesSet = new Set();\r\n        const inputDirty = [];\r\n        for (const p of dirtyPaths) {\r\n          const pathStr = String(p || '');\r\n          if (!pathStr.startsWith('inputs.')) continue;\r\n          inputDirty.push(pathStr);\r\n          for (const r of pathToResources(pathStr)) {\r\n            modifiedResourcesSet.add(r);\r\n          }\r\n        }\r\n        const modifiedResources = Array.from(modifiedResourcesSet);\r\n        await api.saveScenarioInputs(\r\n          schoolId,\r\n          selectedScenarioId,\r\n          patched,\r\n          modifiedResources,\r\n          inputDirty\r\n        );\r\n        setBaselineInputs(patched && typeof patched === \"object\" ? structuredClone(patched) : patched);\r\n        clearDirtyPrefix(\"inputs.\");\r\n      }\r\n\r\n      if (shouldSaveNorm) {\r\n        await saveNormConfig();\r\n      }\r\n      setLastSavedAt(Date.now());\r\n      return true;\r\n    } catch (e) {\r\n      const fallback =\r\n        shouldSaveInputs && shouldSaveNorm\r\n          ? \"Save failed\"\r\n          : shouldSaveNorm\r\n            ? \"Save norm failed\"\r\n            : \"Save inputs failed\";\r\n      setErr(e.message || fallback);\r\n      return false;\r\n    } finally {\r\n      setInputsSaving(false);\r\n    }\r\n  }, [\r\n    applyIkSalariesToGiderler,\r\n    applyTuitionStudentCounts,\r\n    normalizeCapacityInputs,\r\n    normalizeGradesInputs,\r\n    selectedScenarioId,\r\n    inputs,\r\n    inputsLocked,\r\n    scenarioLocked,\r\n    hasDirtyPrefix,\r\n    dirtyPaths,\r\n    schoolId,\r\n    clearDirtyPrefix,\r\n    saveNormConfig,\r\n  ]);\r\n\r\n\r\n  // --- Guard: prevent calculating / submitting if Y2 & Y3 planned student totals are missing ---\r\n  function sumPlannedStudents(grades) {\r\n    const list = Array.isArray(grades) ? grades : [];\r\n    let sum = 0;\r\n    for (const row of list) {\r\n      const n = Number(row?.studentsPerBranch ?? 0);\r\n      if (Number.isFinite(n)) sum += n;\r\n    }\r\n    return sum;\r\n  }\r\n\r\n  function getPlannedStudentTotalsByYear(srcInputs) {\r\n    const s = srcInputs && typeof srcInputs === \"object\" ? srcInputs : {};\r\n    const years = s.gradesYears && typeof s.gradesYears === \"object\" ? s.gradesYears : {};\r\n    return {\r\n      y1: sumPlannedStudents(Array.isArray(years.y1) ? years.y1 : s.grades),\r\n      y2: sumPlannedStudents(years.y2),\r\n      y3: sumPlannedStudents(years.y3),\r\n    };\r\n  }\r\n\r\n\r\n  function showBlockingToast(message, toastId = \"blocking-toast\") {\r\n    // Small bottom-right notification (does not affect page layout)\r\n    toast.warn(message, {\r\n      toastId,\r\n      position: \"bottom-right\",\r\n      autoClose: false,\r\n      closeOnClick: false,\r\n      draggable: true,\r\n      icon: \"??\",\r\n      style: {\r\n        background: \"rgba(15, 23, 42, 0.96)\",\r\n        color: \"#f8fafc\",\r\n        border: \"1px solid rgba(251, 191, 36, 0.35)\",\r\n        boxShadow: \"0 18px 40px rgba(0,0,0,.28)\",\r\n        borderRadius: 14,\r\n      },\r\n    });\r\n  }\r\n\r\n  function ensurePlanningStudentsForY2Y3(actionLabel = \"Islem\") {\n    // If inputs are not loaded yet, don't block here (other guards will handle it)\n    if (!inputs) return true;\n    if (isHQ) return true;\n\r\n    const totals = getPlannedStudentTotalsByYear(inputs);\r\n    const missing = [];\r\n    if (!(totals.y2 > 0)) missing.push(\"Y2\");\r\n    if (!(totals.y3 > 0)) missing.push(\"Y3\");\r\n    if (!missing.length) return true;\r\n\r\n    const msg =\r\n      `${actionLabel} yapilamaz: Norm > Planlanan Donem Bilgileri bolumunde ` +\r\n      `${missing.join(\" ve \")} toplam ogrenci 0 gorunuyor. Lutfen Y2/Y3 ogrenci sayilarini girin.`;\r\n\r\n    // Do NOT set page-level err here (it breaks layout). Use toast only.\r\n    setErr(\"\");\r\n    showBlockingToast(msg, \"norm-y2y3-missing\");\r\n\r\n    if (tab !== \"norm\") setTab(\"norm\");\r\n    return false;\r\n  }\r\n\r\n  function ensurePrevRealFxForLocal(actionLabel = \"Islem\") {\r\n    if (!inputs) return true;\r\n    if (!isLocalScenario) return true;\r\n    if (!prevRealFxMissing) return true;\r\n\r\n    const msg =\r\n      `${actionLabel} yapilamaz: Temel Bilgiler > Performans alanindaki ` +\r\n      `\"Onceki Donem Ortalama Kur (Gerceklesen)\" girilmelidir.`;\r\n\r\n    setErr(\"\");\r\n    showBlockingToast(msg, \"prev-realized-fx-missing\");\r\n    if (tab !== \"basics\") setTab(\"basics\");\r\n    return false;\r\n  }\r\n\r\n\r\n  async function calculate(options = {}) {\r\n    if (!selectedScenarioId) return false;\r\n    if (!ensurePrevRealFxForLocal(\"Hesaplama\")) return false;\r\n    if (!options.skipPlanValidation && !ensurePlanningStudentsForY2Y3(\"Hesaplama\")) return false;\r\n    setCalculating(true);\r\n    setErr(\"\");\r\n    let ok = false;\r\n    try {\r\n      const data = await api.calculateScenario(schoolId, selectedScenarioId);\r\n      if (reportMode === \"distributed\") {\r\n        await fetchScenarioReport(\"distributed\");\r\n      } else {\r\n        setReport(data.results);\r\n      }\r\n      if (!options.keepTab) setTab(\"report\");\r\n      setLastCalculatedAt(Date.now());\r\n      if (typeof window !== \"undefined\") {\r\n        // Debug hook: inspect KPI calc payload/results in devtools\r\n        console.log(\"[kpi] calculate ok\", {\r\n          scenarioId: selectedScenarioId,\r\n          hasResults: Boolean(data?.results),\r\n        });\r\n      }\r\n      ok = true;\r\n    } catch (e) {\r\n      setErr(e.message || \"Calculation failed\");\r\n      if (typeof window !== \"undefined\") {\r\n        console.log(\"[kpi] calculate failed\", {\r\n          scenarioId: selectedScenarioId,\r\n          error: e?.message || e,\r\n        });\r\n      }\r\n    } finally {\r\n      setCalculating(false);\r\n    }\r\n    return ok;\r\n  }\r\n\r\n  async function handleExport() {\r\n    if (!selectedScenarioId) return;\r\n    setErr(\"\");\r\n    try {\r\n      await api.downloadXlsx(schoolId, selectedScenarioId, reportCurrency, reportMode);\r\n    } catch (e) {\r\n      setErr(e.message || \"Download failed\");\r\n    }\r\n  }\r\n\r\n  async function handleExportPdf() {\r\n    if (!selectedScenarioId) return;\r\n    setErr(\"\");\r\n    setExportingPdf(true);\r\n    try {\r\n      await api.downloadPdf(schoolId, selectedScenarioId, reportCurrency, reportMode);\r\n    } catch (e) {\r\n      setErr(e.message || \"PDF export failed\");\r\n    } finally {\r\n      setExportingPdf(false);\r\n    }\r\n  }\r\n\r\n  function setField(path, value) {\r\n    if (inputsLocked) return;\r\n    const next = structuredClone(inputs || {});\r\n    const keys = path.split(\".\");\r\n    let obj = next;\r\n    for (let i = 0; i < keys.length - 1; i++) {\r\n      obj[keys[i]] = obj[keys[i]] || {};\r\n      obj = obj[keys[i]];\r\n    }\r\n    obj[keys[keys.length - 1]] = value;\r\n    setInputs(next);\r\n  }\r\n\r\n  function areSetsEqual(a, b) {\r\n    if (a === b) return true;\r\n    if (a.size !== b.size) return false;\r\n    for (const v of a) {\r\n      if (!b.has(v)) return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  function valuesEqual(a, b) {\r\n    if (a == null && b == null) return true;\r\n    if (typeof a === \"number\" || typeof b === \"number\") return Number(a) === Number(b);\r\n    if (typeof a === \"boolean\" || typeof b === \"boolean\") return Boolean(a) === Boolean(b);\r\n    return Object.is(a, b);\r\n  }\r\n\r\n  function getValueAtPath(obj, parts) {\r\n    let cur = obj;\r\n    for (const part of parts) {\r\n      if (cur == null) return undefined;\r\n\r\n      if (Array.isArray(cur)) {\r\n        const byKey = cur.find((item) => item && typeof item === \"object\" && \"key\" in item && String(item.key) === part);\r\n        if (byKey) {\r\n          cur = byKey;\r\n          continue;\r\n        }\r\n\r\n        const byName = cur.find((item) => item && typeof item === \"object\" && \"name\" in item && String(item.name) === part);\r\n        if (byName) {\r\n          cur = byName;\r\n          continue;\r\n        }\r\n\r\n        const byGrade = cur.find((item) => item && typeof item === \"object\" && \"grade\" in item && String(item.grade) === part);\r\n        if (byGrade) {\r\n          cur = byGrade;\r\n          continue;\r\n        }\r\n\r\n        const idx = Number(part);\r\n        if (Number.isInteger(idx) && String(idx) === part) {\r\n          cur = cur[idx];\r\n          continue;\r\n        }\r\n\r\n        return undefined;\r\n      }\r\n\r\n      if (typeof cur !== \"object\") return undefined;\r\n      cur = cur[part];\r\n    }\r\n    return cur;\r\n  }\r\n\r\n  // ...existing code...\r\n  const getBaselineValue = useCallback(\r\n    (path) => {\r\n      if (!path) return undefined;\r\n      const parts = path.split(\".\");\r\n      if (!parts.length) return undefined;\r\n      if (parts[0] === \"inputs\") {\r\n        const val = getValueAtPath(baselineInputs, parts.slice(1));\r\n        if (val !== undefined) return val;\r\n\r\n        const last = parts[parts.length - 1];\r\n\r\n        // If field ends with Y2/Y3 try base field fallback (e.g. unitCostY2 -> unitCost)\r\n        if (last.endsWith(\"Y2\") || last.endsWith(\"Y3\")) {\r\n          const suffix = last.endsWith(\"Y2\") ? \"Y2\" : \"Y3\";\r\n          const baseField = last.slice(0, -2);\r\n          const baseVal = getValueAtPath(baselineInputs, parts.slice(1, -1).concat(baseField));\r\n          if (baseVal !== undefined) {\r\n            // For unitCost-like fields, return the inflation-adjusted derived value so UI matches display logic\r\n            if (baseField === \"unitCost\" || baseField.startsWith(\"unitCost\")) {\r\n              const infl = getValueAtPath(baselineInputs, [\"temelBilgiler\", \"inflation\"]) || {};\r\n              const y2f = 1 + Number(infl?.y2 || 0);\r\n              const y3f = y2f * (1 + Number(infl?.y3 || 0));\r\n              return suffix === \"Y2\" ? Number(baseVal) * y2f : Number(baseVal) * y3f;\r\n            }\r\n            // Other Y2/Y3 fields (studentCountY2, ratioY2, valueY2, etc.) fall back to base field\r\n            return baseVal;\r\n          }\r\n        }\r\n\r\n        // studentCountY2/Y3 fallback -> studentCount\r\n        if ((last === \"studentCountY2\" || last === \"studentCountY3\") && baselineInputs) {\r\n          const parent = getValueAtPath(baselineInputs, parts.slice(1, -1));\r\n          if (parent && typeof parent === \"object\") {\r\n            const sc = parent.studentCount;\r\n            if (sc != null) return sc;\r\n          }\r\n        }\r\n\r\n        // kapasite / year fallbacks handled elsewhere above; generic years fallback:\r\n        const yearsIdx = parts.indexOf(\"years\");\r\n        if (yearsIdx >= 0 && parts.length > yearsIdx + 1 && baselineInputs) {\r\n          const yearKey = parts[yearsIdx + 1]; // e.g. 'y1','y2','y3'\r\n          if (yearKey === \"y2\" || yearKey === \"y3\") {\r\n            const altParts = [...parts];\r\n            altParts[yearsIdx + 1] = \"y1\";\r\n            const altVal = getValueAtPath(baselineInputs, altParts.slice(1));\r\n            if (altVal !== undefined) {\r\n              if (parts.includes(\"ik\") && parts.includes(\"unitCosts\")) {\r\n                const ratio = getValueAtPath(baselineInputs, [\"ik\", \"unitCostRatio\"]);\r\n                const r = Number(ratio);\r\n                if (Number.isFinite(r)) {\r\n                  const base = Number(altVal);\r\n                  const multiplier = yearKey === \"y2\" ? r : r * r;\r\n                  return Number.isFinite(base) ? base * multiplier : undefined;\r\n                }\r\n              }\r\n              return altVal;\r\n            }\r\n          }\r\n        }\r\n\r\n        // ik specific fallbacks:\r\n        if (parts.slice(1, 3).join(\".\") === \"ik.years\" && baselineInputs) {\r\n          if (parts.includes(\"unitCostRatio\")) {\r\n            const u = getValueAtPath(baselineInputs, [\"ik\", \"unitCostRatio\"]);\r\n            if (u !== undefined) return u;\r\n            return 1;\r\n          }\r\n          const leafCandidates = [\"unitCosts\", \"headcountsByLevel\"];\r\n          if (leafCandidates.some((c) => parts.includes(c))) {\r\n            return 0;\r\n          }\r\n        }\r\n\r\n        // generic kapasite fallbacks (years.cur/y1/y2/y3 etc.)\r\n        if ((last === \"y1\" || last === \"y2\" || last === \"y3\") && baselineInputs) {\r\n          const parent = getValueAtPath(baselineInputs, parts.slice(1, -1));\r\n          if (parent && typeof parent === \"object\" && parent.y1 != null) return parent.y1;\r\n\r\n          const byIdx = parts.indexOf(\"byKademe\");\r\n          if (byIdx >= 1 && parts.length > byIdx + 1) {\r\n            const lvlKey = parts[byIdx + 1];\r\n            const per = getValueAtPath(baselineInputs, [\"kapasite\", \"byKademe\", lvlKey, \"caps\", \"y1\"]);\r\n            if (per !== undefined) return per;\r\n          }\r\n\r\n          const yearsY1 = getValueAtPath(baselineInputs, [\"kapasite\", \"years\", \"y1\"]);\r\n          if (yearsY1 !== undefined) return yearsY1;\r\n        }\r\n\r\n        // cur fallback for kapasite -> per-kademe caps.cur or kapasite.currentStudents\r\n        if (last === \"cur\" && baselineInputs) {\r\n          const byIdx = parts.indexOf(\"byKademe\");\r\n          if (byIdx >= 1 && parts.length > byIdx + 1) {\r\n            const lvlKey = parts[byIdx + 1];\r\n            const per = getValueAtPath(baselineInputs, [\"kapasite\", \"byKademe\", lvlKey, \"caps\", \"cur\"]);\r\n            if (per !== undefined) return per;\r\n          }\r\n          const curAll = getValueAtPath(baselineInputs, [\"kapasite\", \"currentStudents\"]);\r\n          if (curAll !== undefined) return curAll;\r\n        }\r\n\r\n        return undefined;\r\n      }\r\n      if (parts[0] === \"norm\") return getValueAtPath(baselineNorm, parts.slice(1));\r\n      return undefined;\r\n    },\r\n    [baselineInputs, baselineNorm]\r\n  );\r\n  // ...existing code...\r\n\r\n  const inputsDirty = hasDirtyPrefix(\"inputs.\") || hasDirtyPrefix(\"norm.\");\r\n  const submitActiveWorkItem = useCallback(async () => {\r\n    if (!activeWorkId) return;\r\n    if (inputsDirty) {\r\n      const ok = await saveInputs();\r\n      if (!ok) return;\r\n    }\r\n    await submitWorkItem(activeWorkId);\r\n  }, [activeWorkId, inputsDirty, saveInputs, submitWorkItem]);\r\n  const reviewActiveWorkItem = useCallback(\r\n    async (action = \"approve\") => {\r\n      if (!activeWorkId || !selectedScenario?.id) return;\r\n      if (reviewingWorkItem) return;\r\n      setReviewingWorkItem(true);\r\n      try {\r\n        await api.reviewWorkItem(schoolId, selectedScenario.id, activeWorkId, { action });\r\n        toast.success(action === \"approve\" ? \"Onayland\" : \"Revize istendi\");\r\n        await refreshWorkItems();\r\n        await refreshScenarioMeta();\r\n      } catch (e) {\r\n        toast.error(e?.message || \"lem baarsz\");\r\n      } finally {\r\n        setReviewingWorkItem(false);\r\n      }\r\n    },\r\n    [activeWorkId, selectedScenario?.id, reviewingWorkItem, schoolId, refreshWorkItems, refreshScenarioMeta]\r\n  );\r\n  const role = String(me?.role || \"\");\r\n  const isAccountant = role === \"accountant\";\r\n  const suppressUnsavedWarning =\r\n    activeWorkId && activeWorkState === \"submitted\" && role && !isAccountant;\r\n  const warnUnsavedChanges = inputsDirty && !suppressUnsavedWarning;\r\n  const moduleLockReason =\r\n    activeWorkState === \"submitted\"\r\n      ? \"Modul incelemede\"\r\n      : activeWorkState === \"approved\"\r\n        ? \"Modul onaylandi\"\r\n        : \"Modul kilitli\";\r\n  const inputsLockedReason = scenarioLocked\r\n    ? \"Senaryo kilitli\"\r\n    : moduleLocked\r\n      ? moduleLockReason\r\n      : \"\";\r\n  const isActiveRequired = activeWorkId\r\n    ? (requiredWorkIds.length\r\n      ? requiredWorkIds.includes(activeWorkId)\r\n      : (isHQ ? HQ_REQUIRED_WORK_IDS.has(activeWorkId) : true))\r\n    : false;\r\n  const canSubmitWorkItem =\r\n    activeWorkId &&\r\n    isActiveRequired &&\r\n    !scenarioLocked &&\r\n    [\"not_started\", \"in_progress\", \"needs_revision\"].includes(activeWorkState);\r\n  const markDirty = useCallback(\r\n    (path, value) => {\r\n      if (!path) return;\r\n      if (inputsLocked && (path.startsWith(\"inputs.\") || path.startsWith(\"norm.\"))) return;\r\n      if (path.startsWith(\"inputs.\")) {\r\n        setInputs((prev) => {\r\n          if (!prev) return prev;\r\n          const parts = path.split(\".\");\r\n          const current = getValueAtPath(prev, parts.slice(1));\r\n          if (valuesEqual(current, value)) return prev;\r\n          const next = structuredClone(prev);\r\n          const ok = setValueAtPath(next, parts.slice(1), value);\r\n          return ok ? next : prev;\r\n        });\r\n      }\r\n      const baselineValue = getBaselineValue(path);\r\n      const same = valuesEqual(value, baselineValue);\r\n      setDirtyPaths((prev) => {\r\n        const next = new Set(prev);\r\n        if (same) next.delete(path);\r\n        else next.add(path);\r\n        return areSetsEqual(prev, next) ? prev : next;\r\n      });\r\n    },\r\n    [inputsLocked, getBaselineValue, setInputs]\r\n  );\r\n\r\n  // --------------------------------------------------------------\r\n  // Warn the user when navigating away with unsaved changes.\r\n  //\r\n  // React Router does not automatically prompt the user when leaving\r\n  // a page with unsaved changes. To ensure users do not lose their\r\n  // work, hook into the native `beforeunload` event. When there are\r\n  // dirty inputs (i.e. the user has modified fields that have not\r\n  // yet been saved), we register a `beforeunload` handler that\r\n  // prevents the default navigation and sets the `returnValue` on\r\n  // the event. Browsers display a generic confirmation dialog to\r\n  // confirm whether the user really wants to leave the page.\r\n  //\r\n  // Without this handler the browser will navigate away silently\r\n  // resulting in lost changes. By registering the handler only\r\n  // when there are unsaved changes and cleaning it up when there\r\n  // are none, we avoid unnecessary prompts.\r\n  useEffect(() => {\r\n    // Handler for the `beforeunload` event. This fires when the\r\n    // user attempts to close or navigate away from the page (e.g.\r\n    // by closing the tab, refreshing or navigating to another URL).\r\n    const handleBeforeUnload = (event) => {\r\n      // If there are unsaved changes, prevent the unload and set\r\n      // `returnValue` to an empty string. The exact message is\r\n      // ignored by most modern browsers, but setting this triggers\r\n      // the confirmation dialog.\r\n      if (warnUnsavedChanges) {\r\n        event.preventDefault();\r\n        // Chrome requires returnValue to be set.\r\n        event.returnValue = \"\";\r\n      }\r\n    };\r\n\r\n    // Register the event listener when there are unsaved changes.\r\n    if (warnUnsavedChanges) {\r\n      window.addEventListener(\"beforeunload\", handleBeforeUnload);\r\n    }\r\n\r\n    // Cleanup: always remove the listener to avoid multiple handlers\r\n    // and to ensure we do not prompt when there are no dirty inputs.\r\n    return () => {\r\n      window.removeEventListener(\"beforeunload\", handleBeforeUnload);\r\n    };\r\n  }, [warnUnsavedChanges]);\r\n\r\n  // --------------------------------------------------------------\r\n  // Expose a global flag for unsaved changes.\r\n  //\r\n  // When navigating between different sections of the application (e.g. via\r\n  // sidebar links) we need to know if there are unsaved changes in the\r\n  // current School page. We write a boolean flag on the `window` object\r\n  // whenever the `inputsDirty` state changes so that other components such\r\n  // as the sidebar navigation can read this value and display a prompt if\r\n  // necessary. When the component unmounts, we clear the flag.\r\n  useEffect(() => {\r\n    try {\r\n      window.__fsUnsavedChanges = warnUnsavedChanges;\r\n    } catch (_) {\r\n      // In non-browser environments `window` may not exist.\r\n    }\r\n    return () => {\r\n      try {\r\n        // Clear the flag on unmount or when navigating away from this page.\r\n        window.__fsUnsavedChanges = false;\r\n      } catch (_) { }\r\n    };\r\n  }, [warnUnsavedChanges]);\r\n  const handleIkSalaryComputed = React.useCallback(\r\n    (salaryByYear) => {\r\n      if (inputsLocked) return;\r\n      const patch = salaryByYear?.y1 || {};\r\n      const keys = [\r\n        \"turkPersonelMaas\",\r\n        \"turkDestekPersonelMaas\",\r\n        \"yerelPersonelMaas\",\r\n        \"yerelDestekPersonelMaas\",\r\n        \"internationalPersonelMaas\",\r\n      ];\r\n\r\n      setInputs((prev) => {\r\n        const p = prev || {};\r\n        const prevItems = p?.giderler?.isletme?.items || {};\r\n\r\n        let changed = false;\r\n        for (const k of keys) {\r\n          const a = Number(prevItems?.[k] || 0);\r\n          const b = Number(patch?.[k] || 0);\r\n          if (Math.abs(a - b) > 1e-6) {\r\n            changed = true;\r\n            break;\r\n          }\r\n        }\r\n        if (!changed) return prev;\r\n\r\n        const next = structuredClone(p);\r\n        next.giderler = next.giderler || {};\r\n        next.giderler.isletme = next.giderler.isletme || {};\r\n        next.giderler.isletme.items = next.giderler.isletme.items || {};\r\n        for (const k of keys) next.giderler.isletme.items[k] = Number(patch?.[k] || 0);\r\n        if (canWriteGiderler) {\r\n          // Derived salary totals should not require Giderler write permission\r\n          // for HR users; only mark dirty when the user can write expenses.\r\n          for (const k of keys) {\r\n            markDirty(`inputs.giderler.isletme.items.${k}`, Number(patch?.[k] || 0));\r\n          }\r\n        }\r\n        return next;\r\n      });\r\n    },\r\n    [inputsLocked, markDirty, canWriteGiderler]\r\n  );\r\n  const handlePlanningGradesChange = React.useCallback(\r\n    (v) => {\r\n      if (inputsLocked) return;\r\n      if (!v || typeof v !== \"object\") return;\r\n      setInputs((prev) => {\r\n        const p = prev || {};\r\n        let next = structuredClone(p);\r\n        next.gradesYears = v;\r\n        if (Array.isArray(v.y1)) next.grades = structuredClone(v.y1);\r\n        next = applyTuitionStudentCounts(next);\r\n        return next;\r\n      });\r\n    },\r\n    [applyTuitionStudentCounts, inputsLocked]\r\n  );\r\n  const setNormSafe = useCallback(\r\n    (updater) => {\r\n      if (inputsLocked) return;\r\n      setNorm((prev) => (typeof updater === \"function\" ? updater(prev) : updater));\r\n    },\r\n    [inputsLocked, setNorm]\r\n  );\r\n  const showInputsHeader = INPUT_HEADER_TABS.has(tab);\r\n  const exportDisabled = inputsSaving || calculating || exportingPdf || !report;\r\n  const formatRelative = (ms) => {\r\n    if (!ms) return \"\";\r\n    const diff = Math.max(0, (nowTick || Date.now()) - ms);\r\n    if (diff < 60000) return \"az once\";\r\n    if (diff < 3600000) return `${Math.floor(diff / 60000)} dk once`;\r\n    return `${Math.floor(diff / 3600000)} saat once`;\r\n  };\r\n\r\n  // Determine the display label and style for a scenario based on its\r\n  // workflow status and timestamps.  When a scenario is approved but\r\n  // has not yet been forwarded to the central office (sent_at is null),\r\n  // it is considered Kontrol edildi.  Once sent_at is set, the\r\n  // scenario is locked and considered Onayland.  The draft state\r\n  // optionally distinguishes Hazrlanyor when progress exists, but\r\n  // falls back to Taslak otherwise.\r\n  useEffect(() => {\r\n    if (exportDisabled) setExportOpen(false);\r\n  }, [exportDisabled]);\r\n\r\n\r\n\r\n  function getScenarioStageLabel(s, progressPct) {\r\n    if (!s) return null;\r\n    const status = String(s.status || \"draft\");\r\n    // Show \"Taslak\" when no progress; \"Hazrlanyor\" when progress exists\r\n    if (status === \"draft\") {\r\n      const pct = Number(progressPct);\r\n      if (Number.isFinite(pct) && pct > 0) return \"Hazrlanyor\";\r\n      return \"Taslak\";\r\n    }\r\n    if (status === \"in_review\") return \"ncelemede\";\r\n    if (status === \"revision_requested\") return \"Revize istendi\";\r\n    if (status === \"sent_for_approval\" || status === \"submitted\") return \"Merkeze iletildi\";\r\n    if (status === \"approved\") {\r\n      // Sent_at indicates final approval\r\n      if (s.sent_at) return \"Onayland\";\r\n      return \"Kontrol edildi\";\r\n    }\r\n    return \"Taslak\";\r\n  }\r\n  function getScenarioStageClass(label) {\r\n    switch (label) {\r\n      case \"Revize istendi\":\r\n        return \"is-bad\";\r\n      case \"Merkeze iletildi\":\r\n      case \"ncelemede\":\r\n      case \"Hazrlanyor\":\r\n        return \"is-warn\";\r\n      case \"Kontrol edildi\":\r\n      case \"Onayland\":\r\n        return \"is-ok\";\r\n      case \"Taslak\":\r\n      default:\r\n        return \"is-muted\";\r\n    }\r\n  }\r\n  function getWorkItemStageLabel(state) {\r\n    switch (String(state || \"not_started\")) {\r\n      case \"approved\":\r\n        return \"Kontrol edildi\";\r\n      case \"needs_revision\":\r\n        return \"Revize istendi\";\r\n      case \"submitted\":\r\n        return \"ncelemede\";\r\n      case \"in_progress\":\r\n        return \"Hazrlanyor\";\r\n      default:\r\n        return \"Taslak\";\r\n    }\r\n  }\r\n  function getModuleStatusClass(state, scenarioStatus, scenarioSentAt) {\r\n    if (scenarioStatus === \"approved\" && scenarioSentAt) {\r\n      return \"is-final\";\r\n    }\r\n    if ([\"sent_for_approval\", \"submitted\"].includes(String(scenarioStatus || \"\"))) {\r\n      return \"is-forwarded\";\r\n    }\r\n    switch (String(state || \"not_started\")) {\r\n      case \"needs_revision\":\r\n        return \"is-revision\";\r\n      case \"approved\":\r\n        return \"is-approved\";\r\n      case \"submitted\":\r\n        return \"is-review\";\r\n      case \"in_progress\":\r\n      case \"not_started\":\r\n      default:\r\n        return \"is-draft\";\r\n    }\r\n  }\r\n\r\n  function renderStickyFooter() {\r\n    if (!showInputsHeader) return null;\r\n    // Build module progress segments.  Each segment uses the pct from progMap\r\n    // and averages for the combined \"norm\" and \"gider\" modules.\r\n    const moduleKeyToWorkId = {\r\n      temel: \"temel_bilgiler\",\r\n      kapasite: \"kapasite\",\r\n      norm: \"norm.ders_dagilimi\",\r\n      ik: \"ik.local_staff\",\r\n      gelir: \"gelirler.unit_fee\",\r\n      gider: \"giderler.isletme\",\r\n    };\r\n    const getModuleWorkState = (moduleKey) => {\r\n      if (!moduleKey) return \"not_started\";\r\n      if (!workItemsLoaded) return \"not_started\";\r\n      const workId = moduleKeyToWorkId[moduleKey];\r\n      if (!workId) return \"not_started\";\r\n      const item = Array.isArray(workItems)\r\n        ? workItems.find((w) => String(w?.work_id) === String(workId))\r\n        : null;\r\n      return item?.state ? String(item.state) : \"not_started\";\r\n    };\r\n    const footerModules = [];\r\n    const optionalSuffix = \" (Opsiyonel)\";\r\n    if (progMap && progMap.temelBilgiler) {\r\n      footerModules.push({\r\n        key: \"temel\",\r\n        label: isHQ ? `Temel${optionalSuffix}` : \"Temel\",\r\n        labelShort: \"Temel\",\r\n        pct: pctValue(progMap.temelBilgiler),\r\n        done: progMap.temelBilgiler.done === true,\r\n        isOptional: isHQ,\r\n      });\r\n    }\r\n    if (progMap && progMap.kapasite) {\r\n      footerModules.push({\r\n        key: \"kapasite\",\r\n        label: isHQ ? `Kapasite${optionalSuffix}` : \"Kapasite\",\r\n        labelShort: \"Kap\",\r\n        pct: pctValue(progMap.kapasite),\r\n        done: progMap.kapasite.done === true,\r\n        isOptional: isHQ,\r\n      });\r\n    }\r\n    // Combine gradesPlan and norm into a single \"Norm\" segment.  Use normAvgPct for pct.\r\n    const normDone = ignoreNormProgress\r\n      ? (progMap?.gradesPlan?.done === true || progMap?.gradesPlan?.done === undefined)\r\n      : (progMap?.gradesPlan?.done === true || progMap?.gradesPlan?.done === undefined) &&\r\n        (progMap?.norm?.done === true || progMap?.norm?.done === undefined);\r\n    footerModules.push({\r\n      key: \"norm\",\r\n      label: isHQ ? `Norm${optionalSuffix}` : \"Norm\",\r\n      labelShort: \"Norm\",\r\n      pct: Number.isFinite(normAvgPct) ? normAvgPct : 0,\r\n      done: normDone,\r\n      isOptional: isHQ,\r\n    });\r\n    if (progMap && progMap.ik) {\r\n      footerModules.push({\r\n        key: \"ik\",\r\n        label: \"?K\",\r\n        labelShort: \"?K\",\r\n        pct: pctValue(progMap.ik),\r\n        done: progMap.ik.done === true,\r\n      });\r\n    }\r\n    if (progMap && progMap.gelirler) {\r\n      footerModules.push({\r\n        key: \"gelir\",\r\n        label: \"Gelir\",\r\n        labelShort: \"Gel\",\r\n        pct: pctValue(progMap.gelirler),\r\n        done: progMap.gelirler.done === true,\r\n      });\r\n    }\r\n    // Combine giderler and discounts into a single \"Gider\" segment.  Use expensesAvgPct.\r\n    const giderDone = isHQ\r\n      ? (progMap?.giderler?.done === true || progMap?.giderler?.done === undefined)\r\n      : (progMap?.giderler?.done === true || progMap?.giderler?.done === undefined) &&\r\n        (progMap?.discounts?.done === true || progMap?.discounts?.done === undefined);\r\n    footerModules.push({\r\n      key: \"gider\",\r\n      label: \"Gider\",\r\n      labelShort: \"Gid\",\r\n      pct: Number.isFinite(expensesAvgPct) ? expensesAvgPct : 0,\r\n      done: giderDone,\r\n    });\r\n    const requiredModules = footerModules.filter((m) => !m.isOptional);\r\n    const allModulesDone = requiredModules.every((m) => m.done);\r\n    // Determine scenario progress pct for label heuristics\r\n    const scenarioProgressPct = selectedScenario?.progress_pct;\r\n    // Determine status pills: scenario-first when workflow advanced beyond draft,\r\n    // but prefer module-level \"approved/revision\" states.\r\n    const scenarioStageLabel = selectedScenario ? getScenarioStageLabel(selectedScenario, scenarioProgressPct) : null;\r\n    const scenarioDisplayLabel =\r\n      scenarioStageLabel &&\r\n      [\"ncelemede\", \"Revize istendi\", \"Merkeze iletildi\", \"Kontrol edildi\", \"Onayland\"].includes(\r\n        scenarioStageLabel\r\n      )\r\n        ? scenarioStageLabel\r\n        : null;\r\n    const scenarioDisplayClass = scenarioDisplayLabel ? getScenarioStageClass(scenarioDisplayLabel) : null;\r\n    const workItemLabel = workItemsLoaded && activeWorkId ? getWorkItemStageLabel(activeWorkState) : null;\r\n    const workItemClass = workItemLabel ? getScenarioStageClass(workItemLabel) : null;\r\n    const hasActiveWorkLabel = Boolean(activeWorkId && workItemLabel);\r\n\r\n    let scenarioTooltip = null;\r\n    if (scenarioDisplayLabel === \"Kontrol edildi\" && selectedScenario?.checked_at) {\r\n      const d = new Date(selectedScenario.checked_at);\r\n      scenarioTooltip = `Kontrol: ${Number.isFinite(d.getTime()) ? d.toLocaleString() : \"\"}`;\r\n    } else if (scenarioDisplayLabel === \"Merkeze iletildi\" && selectedScenario?.sent_at) {\r\n      const d = new Date(selectedScenario.sent_at);\r\n      scenarioTooltip = `letildi: ${Number.isFinite(d.getTime()) ? d.toLocaleString() : \"\"}`;\r\n    } else if (scenarioDisplayLabel === \"Onayland\" && selectedScenario?.reviewed_at) {\r\n      const d = new Date(selectedScenario.reviewed_at);\r\n      scenarioTooltip = `Onay: ${Number.isFinite(d.getTime()) ? d.toLocaleString() : \"\"}`;\r\n    }\r\n\r\n    let primaryPill = null;\r\n    let secondaryPill = null;\r\n\r\n    const scenarioIsFinal = scenarioDisplayLabel === \"Merkeze iletildi\" || scenarioDisplayLabel === \"Onayland\";\r\n    const allowScenarioPill =\r\n      scenarioIsFinal || !activeWorkId || (workItemsLoaded && scenarioMetaLoaded);\r\n    const scenarioPillLabel = allowScenarioPill ? scenarioDisplayLabel : null;\r\n    const scenarioPillClass = allowScenarioPill ? scenarioDisplayClass : null;\r\n    const scenarioPillTooltip = allowScenarioPill ? scenarioTooltip : null;\r\n\r\n    if (scenarioIsFinal && scenarioPillLabel) {\r\n      primaryPill = { label: scenarioPillLabel, className: scenarioPillClass, tooltip: scenarioPillTooltip };\r\n    } else if (hasActiveWorkLabel) {\r\n      primaryPill = { label: workItemLabel, className: workItemClass };\r\n      const suppressScenarioPill =\r\n        (scenarioPillLabel === \"Revize istendi\" && activeWorkState !== \"needs_revision\") ||\r\n        (scenarioPillLabel === \"Kontrol edildi\" && activeWorkState === \"needs_revision\") ||\r\n        (scenarioPillLabel === \"ncelemede\" && activeWorkState === \"approved\");\r\n      if (scenarioPillLabel && scenarioPillLabel !== workItemLabel && !suppressScenarioPill) {\r\n        secondaryPill = { label: scenarioPillLabel, className: scenarioPillClass, tooltip: scenarioPillTooltip };\r\n      }\r\n    } else if (scenarioPillLabel) {\r\n      primaryPill = { label: scenarioPillLabel, className: scenarioPillClass, tooltip: scenarioPillTooltip };\r\n      if (workItemLabel && workItemLabel !== scenarioPillLabel) {\r\n        secondaryPill = { label: workItemLabel, className: workItemClass };\r\n      }\r\n    } else if (workItemLabel) {\r\n      primaryPill = { label: workItemLabel, className: workItemClass };\r\n    }\r\n    // Determine footer meta text\r\n    const footerMetaBits = [];\r\n    if (lastSavedAt) footerMetaBits.push(`Kaydedildi ${formatRelative(lastSavedAt)}`);\r\n    if (lastCalculatedAt) footerMetaBits.push(`Hesapland ${formatRelative(lastCalculatedAt)}`);\r\n    let showDebug = false;\r\n    try {\r\n      showDebug = window?.localStorage?.getItem(\"fs_debug_kpi\") === \"1\";\r\n    } catch (_) {\r\n      showDebug = false;\r\n    }\r\n    if (showDebug) {\r\n      const debugBits = [\r\n        `calc:${calculating ? \"1\" : \"0\"}`,\r\n        `lastCalc:${lastCalculatedAt ? new Date(lastCalculatedAt).toLocaleTimeString() : \"none\"}`,\r\n        `report:${report ? \"yes\" : \"no\"}`,\r\n      ];\r\n      footerMetaBits.push(`DEBUG ${debugBits.join(\"  \")}`);\r\n    }\r\n    const footerMetaText = footerMetaBits.join(\"  \");\r\n    const hasFooterMeta = Boolean(footerMetaText);\r\n    // Determine primary action\r\n    // We compute role-aware capability flags above.  The final action\r\n    // selection must respect the following priority order:\r\n    // 1. Admin \"Onayla\" > 2. Accountant/Manager \"Merkeze ilet\" > 3. Principal/HR \"Gnder\".\r\n    const role = String(me?.role || \"\");\r\n    // Build scope options for permission checks.  Include the countryId if\r\n    // available (via the loaded school or current user) so that\r\n    // country-scoped permissions can match.  Without a countryId, a\r\n    // permission entry with a non-null scope_country_id will not match.\r\n    const countryIdForScope = school?.country_id ?? me?.country_id ?? null;\r\n    const scopeOpts = { schoolId, countryId: countryIdForScope };\r\n    const scenarioStatus = selectedScenario?.status;\r\n    const hasScenario = selectedScenario && selectedScenario.id;\r\n    // Helper to check permission using can()\r\n    const userCan = (res, action) => {\r\n      try {\r\n        return can(me, res, action, scopeOpts);\r\n      } catch {\r\n        return false;\r\n      }\r\n    };\r\n    const moduleKeyToTab = {\r\n      temel: \"basics\",\r\n      kapasite: \"kapasite\",\r\n      norm: \"norm\",\r\n      ik: \"hr\",\r\n      gelir: \"income\",\r\n      gider: \"expenses\",\r\n    };\r\n    const moduleKeyToPageKey = {\r\n      temel: \"temel_bilgiler\",\r\n      kapasite: \"kapasite\",\r\n      norm: \"norm\",\r\n      ik: \"ik\",\r\n      gelir: \"gelirler\",\r\n      gider: \"giderler\",\r\n    };\r\n    const canNavigateModule = (moduleKey) => {\r\n      const pageKey = moduleKeyToPageKey[moduleKey];\r\n      if (!pageKey) return false;\r\n      if (userCan(`page.${pageKey}`, \"read\")) return true;\r\n      const perms = Array.isArray(me?.permissions) ? me.permissions : [];\r\n      const countryId = scopeOpts.countryId;\r\n      return perms.some((perm) => {\r\n        if (perm.action !== \"read\" && perm.action !== \"write\") return false;\r\n        const res = String(perm.resource || \"\");\r\n        if (!res.startsWith(`section.${pageKey}.`)) return false;\r\n        const permCountry = perm.scope_country_id != null ? Number(perm.scope_country_id) : null;\r\n        const permSchool = perm.scope_school_id != null ? Number(perm.scope_school_id) : null;\r\n        if (permCountry != null && countryId != null && Number(permCountry) !== Number(countryId)) return false;\r\n        if (permSchool != null && schoolId != null && Number(permSchool) !== Number(schoolId)) return false;\r\n        if (permSchool != null && schoolId == null) return false;\r\n        if (permCountry != null && countryId == null) return false;\r\n        return true;\r\n      });\r\n    };\r\n    // Determine if user can perform scenario-level or module-level actions\r\n    // Scenario can only be sent when the active module is completed.\r\n    // Map active work ID to internal module key and to page permission resource\r\n    const workIdToKey = {\r\n      \"temel_bilgiler\": \"temel\",\r\n      \"kapasite\": \"kapasite\",\r\n      \"norm.ders_dagilimi\": \"norm\",\r\n      \"ik.local_staff\": \"ik\",\r\n      \"gelirler.unit_fee\": \"gelir\",\r\n      \"giderler.isletme\": \"gider\",\r\n    };\r\n    // Define the potential permission resources for each work item.  A module may\r\n    // have both a page-level and a section-level resource; having write\r\n    // permission on any of these resources allows the user to submit the\r\n    // module.  The order is from most specific (section-level) to page-level.\r\n    const workIdToWriteResources = {\r\n      \"temel_bilgiler\": [\"page.temel_bilgiler\"],\r\n      \"kapasite\": [\"section.kapasite.caps\", \"page.kapasite\"],\r\n      \"norm.ders_dagilimi\": [\"section.norm.ders_dagilimi\", \"page.norm\"],\r\n      \"ik.local_staff\": [\"section.ik.local_staff\", \"page.ik\"],\r\n      \"gelirler.unit_fee\": [\"section.gelirler.unit_fee\", \"page.gelirler\"],\r\n      \"giderler.isletme\": [\"section.giderler.isletme\", \"page.giderler\"],\r\n    };\r\n    const activeModuleKey = workIdToKey[String(activeWorkId || \"\")] || null;\r\n    const activeModuleObj = footerModules.find((m) => m.key === activeModuleKey);\r\n    const activeModuleDone = activeModuleObj ? activeModuleObj.done === true : false;\r\n    // Determine whether the user may attempt to submit (at least show the button).\r\n    // Principals/HR may submit when the scenario is in draft, in_review, or revision_requested.\r\n    // We only check module write permission and activeWorkId when enabling the button.\r\n    const canSubmitScenarioBase =\r\n      hasScenario &&\r\n      [\"draft\", \"in_review\", \"revision_requested\"].includes(scenarioStatus) &&\r\n      (role === \"principal\" || role === \"hr\" || role === \"manager\" || role === \"accountant\");\r\n    // Map active work ID to the corresponding page permission resource (if any)\r\n    const writeResources = activeWorkId ? workIdToWriteResources[String(activeWorkId)] || [] : [];\r\n    const userHasModuleWrite = writeResources.some((res) => {\r\n      try {\r\n        return userCan(res, \"write\");\r\n      } catch {\r\n        return false;\r\n      }\r\n    });\r\n    // Full submit flag: base permission and active module completed\r\n    // Determine if the user can actually submit the module right now.\r\n    // Must have base submit rights, an active work item, write permission on that module, and the module must be completed.\r\n    const canForwardScenario =\r\n      hasScenario &&\r\n      (role === \"accountant\" || role === \"manager\" || userCan(\"scenario.forward\", \"write\")) &&\r\n      scenarioStatus === \"approved\" &&\r\n      !selectedScenario?.sent_at &&\r\n      selectedScenario?.checked_at;\r\n    const canApproveScenario =\r\n      hasScenario &&\r\n      (role === \"admin\" || userCan(\"admin.scenario.review\", \"write\")) &&\r\n      scenarioStatus === \"sent_for_approval\";\r\n    const canReviewWorkItem =\r\n      hasScenario &&\r\n      activeWorkId &&\r\n      activeWorkState === \"submitted\" &&\r\n      (role === \"admin\" ||\r\n        role === \"manager\" ||\r\n        role === \"accountant\" ||\r\n        userCan(\"page.manage_permissions\", \"read\") ||\r\n        userCan(\"page.manage_permissions\", \"write\"));\r\n    const reviewDisabled =\r\n      reviewingWorkItem || inputsSaving || calculating || inputsDirty;\r\n    let reviewTooltip = \"Modl onayla\";\r\n    if (inputsDirty) {\r\n      reviewTooltip = \"nce deiiklikleri kaydedin.\";\r\n    } else if (inputsSaving) {\r\n      reviewTooltip = \"Kaydetme devam ediyor.\";\r\n    } else if (calculating) {\r\n      reviewTooltip = \"Hesaplama devam ediyor.\";\r\n    } else if (reviewingWorkItem) {\r\n      reviewTooltip = \"Onaylanyor...\";\r\n    }\r\n\r\n    // Calculate button permission: user must have write permissions on *all* modules\r\n    // Define the list of module page resources that correspond to scenario modules.\r\n    const moduleResources = [\r\n      \"page.temel_bilgiler\",\r\n      \"page.kapasite\",\r\n      \"page.norm\",\r\n      \"page.ik\",\r\n      \"page.gelirler\",\r\n      \"page.giderler\",\r\n    ];\r\n    const hasAllModuleWritePermissions = moduleResources.every((res) => {\r\n      try {\r\n        return can(me, res, \"write\", scopeOpts);\r\n      } catch {\r\n        return false;\r\n      }\r\n    });\r\n    // Determine disabled reasons\r\n    const primaryTooltipReasons = [];\r\n    let primaryDisabled = true;\r\n    let primaryLabel = \"\";\r\n    let primaryIcon = null;\r\n    let primaryOnClick = null;\r\n    // We evaluate actions in priority: Admin > Manager > Principal.\r\n    if (canApproveScenario) {\r\n      // Admin final approval\r\n      primaryLabel = \"Onayla\";\r\n      primaryIcon = <FaCheckCircle aria-hidden=\"true\" />;\r\n      primaryDisabled = false;\r\n      // Admin page rarely allows editing; still guard against concurrent save/calc\r\n      if (inputsSaving) {\r\n        primaryDisabled = true;\r\n        primaryTooltipReasons.push(\"Kaydetme devam ediyor.\");\r\n      }\r\n      if (calculating) {\r\n        primaryDisabled = true;\r\n        primaryTooltipReasons.push(\"Hesaplama devam ediyor.\");\r\n      }\r\n      if (!primaryDisabled) {\r\n        primaryOnClick = async () => {\r\n          try {\r\n            await api.adminReviewScenario(selectedScenario.id, { action: \"approve\" });\r\n            toast.success(\"Onayland\");\r\n            await refreshWorkItems();\r\n            await refreshScenarioMeta();\r\n          } catch (e) {\r\n            toast.error(e?.message || \"Onay baarsz\");\r\n          }\r\n        };\r\n      }\r\n    } else if (canForwardScenario) {\r\n      // Accountant/manager forward to admin\r\n      primaryLabel = \"Merkeze ilet\";\r\n      primaryIcon = <FaPaperPlane aria-hidden=\"true\" />;\r\n      primaryDisabled = false;\r\n      // disallow if modules incomplete or there are pending changes or locks\r\n      if (!allModulesDone) {\r\n        primaryDisabled = true;\r\n        const incomplete = footerModules.filter((m) => !m.done && !m.isOptional);\r\n        primaryTooltipReasons.push(\r\n          \"Tm modller tamamlanmal: \" +\r\n            incomplete.map((m) => `${m.label} ${m.pct}%`).join(\", \")\r\n        );\r\n      }\r\n      if (inputsDirty) {\r\n        primaryDisabled = true;\r\n        primaryTooltipReasons.push(\"nce deiiklikleri kaydedin.\");\r\n      }\r\n      if (inputsSaving) {\r\n        primaryDisabled = true;\r\n        primaryTooltipReasons.push(\"Kaydetme devam ediyor.\");\r\n      }\r\n      if (calculating) {\r\n        primaryDisabled = true;\r\n        primaryTooltipReasons.push(\"Hesaplama devam ediyor.\");\r\n      }\r\n      if (scenarioLocked) {\r\n        primaryDisabled = true;\r\n        primaryTooltipReasons.push(\"Senaryo kilitli.\");\r\n      }\r\n      if (!primaryDisabled) {\r\n        primaryOnClick = async () => {\r\n          try {\r\n            if (!ensurePrevRealFxForLocal(\"Hesaplama\")) return;\r\n            if (!ensurePlanningStudentsForY2Y3(\"Hesaplama\")) return;\r\n            // Save and recalc if needed\r\n            if (inputsDirty) {\r\n              const ok = await saveInputs();\r\n              if (!ok) return;\r\n            }\r\n            // Always calculate before sending so KPIs are up to date\r\n            const calcOk = await calculate({ keepTab: true });\r\n            if (!calcOk) return;\r\n            await api.sendForApproval(schoolId, selectedScenario.id);\r\n            toast.success(\"Merkeze iletildi\");\r\n            await refreshWorkItems();\r\n            await refreshScenarioMeta();\r\n          } catch (e) {\r\n            toast.error(e?.message || \"letme baarsz\");\r\n          }\r\n        };\r\n      }\r\n    } else if (canSubmitScenarioBase) {\r\n      // Principal/HR submit to manager (module-level). Show button even if disabled.\r\n      primaryLabel = \"Gnder\";\r\n      primaryIcon = <FaPaperPlane aria-hidden=\"true\" />;\r\n      primaryDisabled = false;\r\n      // Validate prerequisites for module submission.  If any check fails we still show\r\n      // the button but keep it disabled with an explanatory tooltip.\r\n      if (!activeWorkId) {\r\n        primaryDisabled = true;\r\n        primaryTooltipReasons.push(\"G?nderilecek bir mod?l yok.\");\r\n      }\r\n      const isOptionalModule = activeWorkId && !isActiveRequired;\r\n      if (isOptionalModule) {\r\n        primaryDisabled = true;\r\n        primaryTooltipReasons.push(\"HQ senaryoda bu mod?l opsiyonel; g?nderilmesi gerekmiyor.\");\r\n      } else {\r\n        // User must have write permission on the active module's resource (page or section).\r\n        if (activeWorkId && !userHasModuleWrite) {\r\n          primaryDisabled = true;\r\n          primaryTooltipReasons.push(\"Bu mod?l? g?nderme yetkiniz yok.\");\r\n        }\r\n        // Module must be in a state that allows submission (not submitted or approved).\r\n        if (activeWorkId && !canSubmitWorkItem) {\r\n          primaryDisabled = true;\r\n          primaryTooltipReasons.push(moduleLockReason || \"Mod?l g?nderilemez\");\r\n        }\r\n        // Module must be completed before sending.\r\n        if (!activeModuleDone) {\r\n          primaryDisabled = true;\r\n          primaryTooltipReasons.push(\"Bu mod?l tamamlanmal?.\");\r\n        }\r\n        // Cannot submit while there are unsaved changes.\r\n        if (inputsDirty) {\r\n          primaryDisabled = true;\r\n          primaryTooltipReasons.push(\"?nce de?i?iklikleri kaydedin.\");\r\n        }\r\n        if (inputsSaving) {\r\n          primaryDisabled = true;\r\n          primaryTooltipReasons.push(\"Kaydetme devam ediyor.\");\r\n        }\r\n        if (calculating) {\r\n          primaryDisabled = true;\r\n          primaryTooltipReasons.push(\"Hesaplama devam ediyor.\");\r\n        }\r\n        if (scenarioLocked) {\r\n          primaryDisabled = true;\r\n          primaryTooltipReasons.push(\"Senaryo kilitli.\");\r\n        }\r\n      }\r\n      if (!primaryDisabled && activeWorkId && userHasModuleWrite && canSubmitWorkItem && activeModuleDone) {\r\n        // For module-level submission, submit only the active work item.\r\n        primaryOnClick = async () => {\r\n          await submitActiveWorkItem();\r\n        };\r\n      }\r\n    }\r\n    const primaryTooltip =\r\n      primaryTooltipReasons.length > 0 ? primaryTooltipReasons.join(\"  \") : undefined;\r\n    // Determine calculate and export labels as before\r\n    const hasReport = Boolean(report);\r\n    const calculateLabel = inputsDirty ? \"Kaydet & Hesapla\" : hasReport ? \"Yeniden Hesapla\" : \"Hesapla\";\r\n    const exportLabel = exportingPdf ? \"PDF hazirlaniyor...\" : \"Disa Aktar\";\r\n    const showExportButton = tab === \"report\" || hasReport;\r\n    return (\r\n      <div className=\"school-sticky-footer\" role=\"region\" aria-label=\"Scenario actions\">\r\n        <div className=\"school-sticky-footer-inner\">\r\n          <div className=\"school-footer-left\">\r\n            {/* Status chips */}\r\n            <div className=\"school-footer-pills\" role=\"status\" aria-live=\"polite\">\r\n              {primaryPill ? (\r\n                <span className={`school-pill ${primaryPill.className}`} title={primaryPill.tooltip}>\r\n                  {primaryPill.label}\r\n                </span>\r\n              ) : null}\r\n              {secondaryPill ? (\r\n                <span className={`school-pill ${secondaryPill.className}`} title={secondaryPill.tooltip}>\r\n                  {secondaryPill.label}\r\n                </span>\r\n              ) : null}\r\n              {inputs ? (\r\n                <span\r\n                  className={`school-pill is-warn ${inputsDirty ? \"\" : \"is-placeholder\"}`}\r\n                  title={inputsDirty ? \"Kaydedilmemi deiiklikler var\" : undefined}\r\n                  aria-hidden={inputsDirty ? undefined : \"true\"}\r\n                >\r\n                   Deiiklik var\r\n                </span>\r\n              ) : null}\r\n            </div>\r\n            {inputs ? (\r\n              <div\r\n                className={`school-footer-meta small ${hasFooterMeta ? \"\" : \"is-placeholder\"}`}\r\n                title={hasFooterMeta ? footerMetaText : undefined}\r\n                aria-hidden={hasFooterMeta ? undefined : \"true\"}\r\n              >\r\n                {hasFooterMeta ? footerMetaText : \"Kaydedildi\"}\r\n              </div>\r\n            ) : null}\r\n          </div>\r\n\r\n      {inputs ? (\r\n        <>\r\n          {/* Middle section: progress bar sits in its own container between status and buttons */}\r\n          <div className=\"school-footer-middle\">\r\n            <div className=\"module-progress\" role=\"progressbar\" aria-valuemin=\"0\" aria-valuemax=\"100\">\r\n              {footerModules.map((m) => {\r\n                const tabKey = moduleKeyToTab[m.key];\r\n                const canNav = Boolean(tabKey && canNavigateModule(m.key));\r\n                const isActive = activeModuleKey === m.key;\r\n                const workState = getModuleWorkState(m.key);\r\n                const statusClass = getModuleStatusClass(\r\n                  workState,\r\n                  selectedScenario?.status,\r\n                  selectedScenario?.sent_at\r\n                );\r\n                const SegmentTag = canNav ? \"button\" : \"div\";\r\n                return (\r\n                  <SegmentTag\r\n                    key={m.key}\r\n                    type={canNav ? \"button\" : undefined}\r\n                    onClick={canNav ? () => setTab(tabKey) : undefined}\r\n                    className={`module-seg ${canNav ? \"is-clickable\" : \"\"} ${isActive ? \"is-active\" : \"\"}`}\r\n                    title={`${m.label}: ${Math.round(m.pct)}% ${m.done ? \"Tamamland\" : \"Eksik\"}`}\r\n                    aria-disabled={canNav ? undefined : \"true\"}\r\n                  >\r\n                    <div className=\"module-title\">{m.labelShort}</div>\r\n                    <div className=\"module-bar\">\r\n                      <div\r\n                        className={`module-fill ${statusClass}`}\r\n                        style={{ width: `${Math.min(100, Math.max(0, Math.round(m.pct)))}%` }}\r\n                      />\r\n                      <span className=\"module-percent\">{Math.round(m.pct)}%</span>\r\n                    </div>\r\n                  </SegmentTag>\r\n                );\r\n              })}\r\n            </div>\r\n          </div>\r\n          {/* Right section: action buttons aligned to the far right */}\r\n          <div className=\"school-footer-right\">\r\n            {canReviewWorkItem ? (\r\n              <Tooltip lines={reviewTooltip ? [reviewTooltip] : []}>\r\n                <button\r\n                  type=\"button\"\r\n                  className=\"topbar-btn is-primary\"\r\n                  onClick={() => reviewActiveWorkItem(\"approve\")}\r\n                  disabled={reviewDisabled}\r\n                  title={reviewTooltip}\r\n                >\r\n                  <FaCheckCircle aria-hidden=\"true\" />\r\n                  <span>{reviewingWorkItem ? \"Onaylanyor...\" : \"Onayla\"}</span>\r\n                </button>\r\n              </Tooltip>\r\n            ) : null}\r\n            {primaryLabel ? (\r\n              <Tooltip lines={primaryTooltip ? [primaryTooltip] : []}>\r\n                <button\r\n                  type=\"button\"\r\n                  className=\"topbar-btn is-primary\"\r\n                  onClick={primaryOnClick}\r\n                  disabled={primaryDisabled}\r\n                  title={primaryTooltip}\r\n                >\r\n                  {primaryIcon}\r\n                  <span>{primaryLabel}</span>\r\n                </button>\r\n              </Tooltip>\r\n            ) : null}\r\n            <button\r\n              type=\"button\"\r\n              className={\"topbar-btn \" + (inputsDirty && !inputsSaving ? \"is-save\" : \"is-ghost\")}\r\n              onClick={saveInputs}\r\n              disabled={!inputsDirty || inputsSaving || inputsLocked}\r\n              title={\r\n                inputsLocked\r\n                  ? inputsLockedReason\r\n                  : inputsDirty\r\n                    ? \"Deiiklikleri kaydet\"\r\n                    : \"Kaydedilecek deiiklik yok\"\r\n              }\r\n            >\r\n              <FaSave aria-hidden=\"true\" />\r\n              <span>{inputsSaving ? \"Kaydediliyor...\" : inputsDirty ? \"Kaydet\" : \"Kaydedildi\"}</span>\r\n            </button>\r\n\r\n            {hasAllModuleWritePermissions ? (\r\n              <button\r\n                type=\"button\"\r\n                className=\"topbar-btn is-primary\"\r\n                onClick={async () => {\r\n                  if (inputsSaving || calculating) return;\r\n                  if (!ensurePrevRealFxForLocal(\"Hesaplama\")) return;\r\n                  if (!ensurePlanningStudentsForY2Y3(\"Hesaplama\")) return;\r\n                  if (inputsDirty) {\r\n                    const ok = await saveInputs();\r\n                    if (ok) await calculate();\r\n                    return;\r\n                  }\r\n                  await calculate();\r\n                }}\r\n                disabled={inputsSaving || calculating}\r\n                title={calculateLabel}\r\n              >\r\n                <FaCalculator aria-hidden=\"true\" />\r\n                <span>{calculating ? \"Hesaplanyor...\" : calculateLabel}</span>\r\n              </button>\r\n            ) : null}\r\n\r\n            {showExportButton ? (\r\n              <div className=\"action-menu\" ref={exportMenuRef}>\r\n                <button\r\n                  type=\"button\"\r\n                  className={`topbar-btn is-ghost ${exportingPdf ? \"is-loading\" : \"\"}`}\r\n                  onClick={() => {\r\n                    if (exportDisabled) return;\r\n                    setExportOpen((prev) => !prev);\r\n                  }}\r\n                  disabled={exportDisabled}\r\n                  aria-haspopup=\"menu\"\r\n                  aria-expanded={exportOpen}\r\n                  aria-busy={exportingPdf ? \"true\" : undefined}\r\n                >\r\n                  {exportingPdf ? <span className=\"pdf-export-spinner\" aria-hidden=\"true\" /> : null}\r\n                  {!exportingPdf ? <FaFileExport aria-hidden=\"true\" /> : null}\r\n                  <span>{exportLabel}</span>\r\n                </button>\r\n\r\n                {exportOpen ? (\r\n                  <div className=\"action-menu-panel action-menu-panel--up\" role=\"menu\">\r\n                    <button\r\n                      type=\"button\"\r\n                      className=\"action-menu-item\"\r\n                      onClick={() => {\r\n                        setExportOpen(false);\r\n                        handleExport();\r\n                      }}\r\n                      disabled={exportDisabled}\r\n                      role=\"menuitem\"\r\n                    >\r\n                      Excel (.xlsx)\r\n                    </button>\r\n                    <button\r\n                      type=\"button\"\r\n                      className=\"action-menu-item\"\r\n                      onClick={() => {\r\n                        setExportOpen(false);\r\n                        handleExportPdf();\r\n                      }}\r\n                      disabled={exportDisabled}\r\n                      role=\"menuitem\"\r\n                    >\r\n                      PDF (.pdf)\r\n                    </button>\r\n                  </div>\r\n                ) : null}\r\n              </div>\r\n            ) : null}\r\n          </div>\r\n        </>\r\n      ) : (\r\n        <div className=\"school-footer-right\">\r\n          <div className=\"school-footer-hint small\">nce bir senaryo sein.</div>\r\n        </div>\r\n      )}\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const outletContextValue = {\r\n    schoolId,\r\n    school,\r\n    me,\r\n    inputs,\r\n    setField,\r\n    norm,\r\n    setNorm: setNormSafe,\r\n    handlePlanningGradesChange,\r\n    dirtyPaths,\r\n    markDirty,\r\n    baseYear,\r\n    programType,\r\n    inputCurrencyCode,\r\n    selectedScenario,\r\n    prevReport,\r\n    prevScenarioMeta,\r\n    report,\r\n    reportCurrency,\r\n    setReportCurrency,\r\n    reportMode,\r\n    reportModeLoading,\r\n    handleReportModeChange,\r\n    detailedReportMode,\r\n    setDetailedReportMode,\r\n    reportExportRef,\r\n    progMap,\r\n    normAvgPct,\r\n    expensesAvgPct,\r\n    normMissingLines,\r\n    expensesMissingLines,\r\n    uiScopeKey,\r\n    handleIkSalaryComputed,\r\n\r\n    // Work item workflow context\r\n    workItems,\r\n    refreshWorkItems,\r\n    submitWorkItem,\r\n  };\r\n\r\n  return (\r\n    <div className=\"container school-page\">\r\n      <ToastContainer position=\"bottom-right\" autoClose={3500} newestOnTop closeOnClick pauseOnFocusLoss pauseOnHover hideProgressBar theme=\"dark\" />\r\n      <style>{`@keyframes schoolSpin{to{transform:rotate(360deg)}}`}</style>\r\n      {bootLoading ? (\r\n        <div className=\"modal-backdrop\" role=\"status\" aria-live=\"polite\" aria-busy=\"true\">\r\n          <div\r\n            className=\"card\"\r\n            style={{\r\n              width: \"min(420px, 92vw)\",\r\n              padding: \"18px 16px\",\r\n              textAlign: \"center\",\r\n            }}\r\n          >\r\n            <div\r\n              aria-hidden\r\n              style={{\r\n                width: 36,\r\n                height: 36,\r\n                margin: \"0 auto\",\r\n                borderRadius: \"50%\",\r\n                border: \"3px solid rgba(0,0,0,.15)\",\r\n                borderTopColor: \"rgba(0,0,0,.75)\",\r\n                animation: \"schoolSpin .8s linear infinite\",\r\n              }}\r\n            />\r\n            <div style={{ fontWeight: 800, marginTop: 12 }}>\r\n              {bootLoadingLabel || \"Yukleniyor...\"}\r\n            </div>\r\n            <div className=\"small muted\" style={{ marginTop: 6 }}>\r\n              Lutfen bekleyin...\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ) : null}\r\n\r\n      {err ? (\r\n        <div\r\n          className=\"card\"\r\n          style={{\r\n            marginTop: 10,\r\n            background: \"#fff1f2\",\r\n            borderColor: \"#fecaca\",\r\n          }}\r\n        >\r\n          {err}\r\n        </div>\r\n      ) : null}\r\n\r\n      {!selectedScenarioId ? (\r\n        <div className=\"card\" style={{ marginTop: 12 }}>\r\n          <div style={{ fontWeight: 700 }}>Okul & Senaryo Sec</div>\r\n          <div className=\"small\" style={{ marginTop: 6 }}>\r\n            Bu bolumu acmak icin once okul ve senaryo secin.\r\n          </div>\r\n          <button\r\n            type=\"button\"\r\n            className=\"btn primary\"\r\n            style={{ marginTop: 12 }}\r\n            onClick={() => navigate(`/select?schoolId=${schoolId}`)}\r\n          >\r\n            Okul & Senaryo Sec\r\n          </button>\r\n        </div>\r\n      ) : (\r\n        <Outlet context={outletContextValue} />\r\n      )}\r\n      {renderStickyFooter()}\r\n    </div>\r\n  );\r\n}\r\n\r\n","const KADEME_BASE_KEYS = [\"okulOncesi\", \"ilkokul\", \"ortaokul\", \"lise\"];\n\nexport function isHeadquarterScenario(inputs) {\n  const kademeler = inputs?.temelBilgiler?.kademeler;\n  if (!kademeler || typeof kademeler !== \"object\") return false;\n  return KADEME_BASE_KEYS.every((key) => kademeler?.[key]?.enabled === false);\n}\n","const PROGRAM_TYPES = {\r\n  LOCAL: \"local\",\r\n  INTERNATIONAL: \"international\",\r\n};\r\n\r\nconst ALLOWED_PROGRAM_TYPES = new Set(Object.values(PROGRAM_TYPES));\r\n\r\nfunction normalizeProgramType(value) {\r\n  const raw = String(value || \"\").trim().toLowerCase();\r\n  if (ALLOWED_PROGRAM_TYPES.has(raw)) return raw;\r\n  return PROGRAM_TYPES.LOCAL;\r\n}\r\n\r\nfunction getProgramType(inputs = {}, scenario = null) {\r\n  const programFromInputs =\r\n    inputs?.temelBilgiler?.programType ?? inputs?.programType ?? inputs?.program_type;\r\n  if (programFromInputs) {\r\n    return normalizeProgramType(programFromInputs);\r\n  }\r\n  const programFromScenario = scenario?.program_type || scenario?.programType;\r\n  if (programFromScenario) return normalizeProgramType(programFromScenario);\r\n  return PROGRAM_TYPES.LOCAL;\r\n}\r\n\r\nfunction isKademeKeyVisible(key, programType = PROGRAM_TYPES.LOCAL) {\r\n  const type = normalizeProgramType(programType);\r\n  if (!key) return true;\r\n  if (key === \"okulOncesi\") return true;\r\n  if (key.endsWith(\"Yerel\")) return type === PROGRAM_TYPES.LOCAL;\r\n  if (key.endsWith(\"Int\")) return type === PROGRAM_TYPES.INTERNATIONAL;\r\n  return true;\r\n}\r\n\r\nfunction mapBaseKademeToVariant(baseKademe, programType = PROGRAM_TYPES.LOCAL) {\r\n  const type = normalizeProgramType(programType);\r\n  if (baseKademe === \"okulOncesi\") return \"okulOncesi\";\r\n  const suffix = type === PROGRAM_TYPES.INTERNATIONAL ? \"Int\" : \"Yerel\";\r\n  return `${baseKademe}${suffix}`;\r\n}\r\n\r\nfunction getVariantKeysForProgramType(programType = PROGRAM_TYPES.LOCAL) {\r\n  const type = normalizeProgramType(programType);\r\n  return new Set([\r\n    \"okulOncesi\",\r\n    `ilkokul${type === PROGRAM_TYPES.INTERNATIONAL ? \"Int\" : \"Yerel\"}`,\r\n    `ortaokul${type === PROGRAM_TYPES.INTERNATIONAL ? \"Int\" : \"Yerel\"}`,\r\n    `lise${type === PROGRAM_TYPES.INTERNATIONAL ? \"Int\" : \"Yerel\"}`,\r\n  ]);\r\n}\r\n\r\nexport {\r\n  PROGRAM_TYPES,\r\n  ALLOWED_PROGRAM_TYPES,\r\n  getProgramType,\r\n  normalizeProgramType,\r\n  isKademeKeyVisible,\r\n  mapBaseKademeToVariant,\r\n  getVariantKeysForProgramType,\r\n};\r\n"],"names":["DEFAULT_PREFIX","safeRead","key","fallback","raw","window","localStorage","getItem","JSON","parse","_unused","useScenarioUiState","name","defaultValue","prefix","scope","arguments","length","undefined","scopeKey","scopeOverride","loc","useLocation","useMemo","trim","pathname","search","useScenarioScopeKey","storageKey","concat","loadedKeyRef","useRef","state","setState","useState","useEffect","current","value","setItem","stringify","_unused2","safeWrite","useScenarioUiFlag","opts","v","setV","next","useScenarioUiString","String","computeScenarioProgress","inputs","norm","config","scenario","catalog","buildProgressCatalog","normalizedConfig","defaults","DEFAULT_PROGRESS_CONFIG","input","sectionsInput","sections","out","version","Object","keys","forEach","id","base","incoming","enabled","mode","min","Number","selectedFields","normalizeConfig","isHQ","isHeadquarterScenario","HQ_INCLUDED_TABS","Set","sectionsById","Map","map","s","sectionResults","totalUnits","doneUnits","overallTotalUnits","overallDoneUnits","section","_catalog$context","cfg","set","includeInOverall","has","tabKey","addUnits","total","done","requiresKademe","hasKademeSelection","context","missingReasons","selectedIds","Array","isArray","fields","filter","_cfg$selectedFields","applicable","fieldsById","Boolean","field","appliesIf","_","filled","missing","getValue","ok","type","isNonEmptyString","toNum","isFilled","push","filledCount","modeDefault","toUpperCase","minRequired","isFinite","minDefault","Math","max","doneCount","allowEmpty","label","tabs","tab","enabledSections","sectionIds","result","get","def","tabTotal","tabDone","missingLines","allDone","res","t","d","pct","round","missingPreview","join","effectiveTotal","effectiveDone","missingDetailsLines","reasons","visibleTabs","completedCount","totalCount","pathToResources","path","tokens","split","shift","page","replace","toLowerCase","PAGE_ALIASES","grades_years","grades_current","grades","prototype","hasOwnProperty","call","sectionSnake","pageMap","temel_bilgiler","inflation","ucret_artis_oranlari","okul_ucretleri_hesaplama","ik_mevcut","burs_indirim_ogrenci_sayilari","burs_ogr","rakip_analizi","rakip","performans","degerlendirme","okul_egitim_bilgileri","yetkililer","kademeler","program_type","gelirler","giderler","ik","discounts","grades_plan","kapasite","mapped","INPUT_HEADER_TABS","TAB_TO_ROUTE","basics","hr","income","expenses","detailedReport","report","ROUTE_TO_TAB","fromEntries","entries","_ref","TAB_TO_WORK_ID","HQ_REQUIRED_WORK_IDS","parseAcademicYear","academicYear","range","match","startYear","endYear","single","pctValue","n","mergeMissingLines","a","b","seen","list","line","val","add","slice","findArrayItemIndex","arr","part","byKey","findIndex","item","byName","byGrade","grade","idx","isInteger","SchoolPage","_inputs$temelBilgiler","_inputs$temelBilgiler2","useParams","location","navigate","useNavigate","outlet","useOutletContext","schoolId","school","setSchool","err","setErr","me","setMe","document","title","selectedScenario","setSelectedScenario","prevReport","setPrevReport","prevScenarioMeta","setPrevScenarioMeta","workItems","setWorkItems","workItemsLoaded","setWorkItemsLoaded","requiredWorkIds","setRequiredWorkIds","scenarioMetaLoaded","setScenarioMetaLoaded","reviewingWorkItem","setReviewingWorkItem","scenarios","setScenarios","selectedScenarioId","setSelectedScenarioId","readSelectedScenarioId","pendingTabAfterSelect","setPendingTabAfterSelect","refreshWorkItems","useCallback","async","sid","data","api","listWorkItems","refreshScenarioMeta","listScenarios","limit","offset","order","items","scenarioId","nextScenario","find","prev","_objectSpread","submitWorkItem","workId","toast","success","e","error","message","setNorm","progressConfig","setProgressConfig","setInputs","inputsSaving","setInputsSaving","dirtyPaths","setDirtyPaths","baselineInputs","setBaselineInputs","baselineNorm","setBaselineNorm","clearDirtyPrefix","size","changed","startsWith","hasDirtyPrefix","setReport","calculating","setCalculating","lastSavedAt","setLastSavedAt","lastCalculatedAt","setLastCalculatedAt","nowTick","setNowTick","exportOpen","setExportOpen","exportMenuRef","reportExportRef","exportingPdf","setExportingPdf","bootLoading","setBootLoading","bootLoadingLabel","setBootLoadingLabel","uiScopeKey","reportCurrency","setReportCurrency","reportCurrencyDefaultedForRef","reportMode","setReportMode","reportModeLoading","setReportModeLoading","detailedReportMode","setDetailedReportMode","activeRouteSegment","activeWorkId","activeWorkItem","work_id","activeWorkState","moduleLocked","includes","setTab","React","nextTab","segment","writeLastVisitedPath","writeGlobalLastRouteSegment","targetSegment","readLastVisitedPath","target","setInterval","Date","now","clearInterval","handleClick","event","el","contains","handleKey","addEventListener","removeEventListener","baseYear","academic_year","inputCurrencyCode","input_currency","local_currency_code","isLocalScenario","prevRealFxValue","temelBilgiler","prevYearRealizedFxUsdToLocal","prevRealFxMissing","programType","getProgramType","permissionScope","_ref2","_school$country_id","countryId","country_id","canReadNorm","can","canWriteGiderler","ignoreNormProgress","scenarioProgress","writeScenarioFlags","isHeadquarter","progMap","normAvgPct","gradesPlan","expensesAvgPct","normMissingLines","_progMap$gradesPlan","_progMap$norm","expensesMissingLines","_progMap$giderler","_progMap$giderler2","_progMap$discounts","fetchScenarioReport","nextMode","getScenarioReport","results","handleReportModeChange","setHeaderMeta","subtitle","hideDefault","centered","_outlet$clearHeaderMe","clearHeaderMeta","applyIkSalariesToGiderler","inInputs","_ik$years","_src$giderler","_src$giderler$isletme","src","yearIK","years","y1","unitCosts","headcountsByLevel","roles","levelKeys","levels","roleAnnual","r","count","lvl","_headcountsByLevel$lv","patch","turkPersonelMaas","turk_mudur","turk_mdyard","turk_egitimci","turkDestekPersonelMaas","turk_temsil","yerelPersonelMaas","yerel_yonetici_egitimci","yerelDestekPersonelMaas","yerel_destek","yerel_ulke_temsil_destek","internationalPersonelMaas","int_yonetici_egitimci","prevItems","isletme","k","abs","structuredClone","normalizeCapacityInputs","_cap$years","_cap$years2","_cap$years3","safeNum","legacy","schoolCapacity","cap","y2","y3","currentStudents","byKademe","normalizeGradesInputs","defaultGrades","getGradeOptions","g","branchCount","studentsPerBranch","baseGrades","gradesYears","toMap","m","row","_row$grade","_row$branchCount","_row$studentsPerBranc","normalizeRow","areGradesEqual","ma","mb","ra","rb","applyTuitionStudentCounts","_s$gradesYears","_s$temelBilgiler","_s$gelirler","_s$gelirler$tuition","sums","summarizeGradesByKademe","variantCounts","okulOncesi","ilkokulYerel","ilkokulInt","ortaokulYerel","ortaokulInt","liseYerel","liseInt","mapBaseKademeToVariant","ilkokul","ortaokul","lise","tuitionSync","syncRows","rows","getCount","nextRows","_r$key","_r$studentCount","nextCount","studentCount","tuition","active","getProgressRequirements","loadProgressConfig","getSchool","meInfo","getMe","sc","some","x","writeSelectedScenarioId","loadAll","_data$norm","getScenarioContext","normalized","inf","toFinite","expenseDeviationPct","y2023","y2024","y2025","currentSeasonAvgFee","mudur","ulkeTemsilcisi","raporuHazirlayan","okulEgitimBilgileri","egitimBaslamaTarihi","zorunluEgitimDonemleri","birDersSuresiDakika","gunlukDersSaati","haftalikDersSaatiToplam","sabahciOglenci","ogretmenHaftalikDersOrt","gecisSinaviBilgisi","uygulananProgram","normalizeKademeConfig","normalizeProgramType","okulUcretleriHesaplama","ucretArtisOranlari","ikMevcut","turkPersonelYoneticiEgitimci","turkPersonelTemsilcilik","yerelKadroluEgitimci","yerelUcretliVakaterEgitimci","yerelDestek","yerelTemsilcilik","international","bursIndirimOgrenciSayilari","magisBasariBursu","maarifYetenekBursu","ihtiyacBursu","okulBasariBursu","tamEgitimBursu","barinmaBursu","turkceBasariBursu","uluslararasiYukumlulukIndirimi","vakifCalisaniIndirimi","kardesIndirimi","erkenKayitIndirimi","pesinOdemeIndirimi","kademeGecisIndirimi","temsilIndirimi","kurumIndirimi","istisnaiIndirim","yerelMevzuatIndirimi","rakipAnalizi","c","gerceklesen","ogrenciSayisi","karZarar","bursVeIndirimler","normalizeTemelBilgilerInputs","loadScenario","isLocal","fx_usd_to_local","scenarioKey","year","prevStartYear","prevEndYear","prevScenario","parsed","calculateScenario","loadPrev","scenarioLocked","status","submittedAt","submitted_at","sentAt","sent_at","isScenarioLocked","inputsLocked","saveNormConfig","payload","teacherWeeklyMaxHours","curriculumWeeklyHours","getNormConfig","saveInputs","shouldSaveInputs","shouldSaveNorm","patched","modifiedResourcesSet","inputDirty","p","pathStr","modifiedResources","from","saveScenarioInputs","sumPlannedStudents","sum","_row$studentsPerBranc2","showBlockingToast","toastId","warn","position","autoClose","closeOnClick","draggable","icon","style","background","color","border","boxShadow","borderRadius","ensurePlanningStudentsForY2Y3","actionLabel","totals","srcInputs","getPlannedStudentTotalsByYear","msg","ensurePrevRealFxForLocal","calculate","options","skipPlanValidation","keepTab","console","log","hasResults","valuesEqual","is","getValueAtPath","obj","parts","cur","getBaselineValue","last","endsWith","suffix","baseField","baseVal","infl","y2f","y3f","parent","yearsIdx","indexOf","yearKey","altParts","altVal","ratio","multiplier","u","byIdx","lvlKey","per","yearsY1","curAll","inputsDirty","submitActiveWorkItem","reviewActiveWorkItem","action","reviewWorkItem","role","warnUnsavedChanges","moduleLockReason","inputsLockedReason","isActiveRequired","canSubmitWorkItem","markDirty","i","setValueAtPath","baselineValue","same","delete","areSetsEqual","handleBeforeUnload","preventDefault","returnValue","__fsUnsavedChanges","handleIkSalaryComputed","salaryByYear","_p$giderler","_p$giderler$isletme","handlePlanningGradesChange","setNormSafe","updater","showInputsHeader","exportDisabled","formatRelative","ms","diff","floor","getScenarioStageClass","outletContextValue","setField","_jsxs","className","children","_jsx","ToastContainer","newestOnTop","pauseOnFocusLoss","pauseOnHover","hideProgressBar","theme","width","padding","textAlign","height","margin","borderTopColor","animation","fontWeight","marginTop","borderColor","Outlet","onClick","_progMap$gradesPlan2","_progMap$gradesPlan3","_progMap$gradesPlan4","_progMap$gradesPlan5","_progMap$norm2","_progMap$norm3","_progMap$giderler3","_progMap$giderler4","_progMap$giderler5","_progMap$giderler6","_progMap$discounts2","_progMap$discounts3","_ref3","_school$country_id2","moduleKeyToWorkId","temel","gelir","gider","footerModules","optionalSuffix","labelShort","isOptional","normDone","giderDone","allModulesDone","every","scenarioProgressPct","progress_pct","scenarioStageLabel","progressPct","getScenarioStageLabel","scenarioDisplayLabel","scenarioDisplayClass","workItemLabel","getWorkItemStageLabel","workItemClass","hasActiveWorkLabel","scenarioTooltip","checked_at","getTime","toLocaleString","reviewed_at","primaryPill","secondaryPill","scenarioIsFinal","allowScenarioPill","scenarioPillLabel","scenarioPillClass","scenarioPillTooltip","tooltip","footerMetaBits","showDebug","_window","_window$localStorage","debugBits","toLocaleTimeString","footerMetaText","hasFooterMeta","countryIdForScope","scopeOpts","scenarioStatus","hasScenario","userCan","_unused3","moduleKeyToTab","moduleKeyToPageKey","activeModuleKey","activeModuleObj","activeModuleDone","canSubmitScenarioBase","userHasModuleWrite","_unused4","canForwardScenario","canApproveScenario","canReviewWorkItem","reviewDisabled","reviewTooltip","hasAllModuleWritePermissions","_unused5","primaryTooltipReasons","primaryDisabled","primaryLabel","primaryIcon","primaryOnClick","FaCheckCircle","adminReviewScenario","FaPaperPlane","incomplete","sendForApproval","primaryTooltip","hasReport","calculateLabel","exportLabel","showExportButton","_Fragment","canNav","moduleKey","pageKey","perms","permissions","perm","resource","permCountry","scope_country_id","permSchool","scope_school_id","canNavigateModule","isActive","statusClass","scenarioSentAt","getModuleStatusClass","w","getModuleWorkState","SegmentTag","Tooltip","lines","disabled","FaSave","FaCalculator","ref","FaFileExport","downloadXlsx","handleExport","downloadPdf","handleExportPdf","renderStickyFooter","KADEME_BASE_KEYS","_kademeler$key","PROGRAM_TYPES","LOCAL","INTERNATIONAL","ALLOWED_PROGRAM_TYPES","values","programFromInputs","programFromScenario","isKademeKeyVisible","baseKademe"],"ignoreList":[],"sourceRoot":""}