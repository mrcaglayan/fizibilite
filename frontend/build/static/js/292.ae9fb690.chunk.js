"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[292],{1292(e,s,n){n.r(s),n.d(s,{default:()=>f});var r=n(2555),t=n(5043),i=n(7559),l=n(1998),a=n(2115),o=n(5685),c=n(3204),d=n(579);const u=e=>(0,d.jsx)("span",{className:"perm-mark ".concat(e?"is-yes":"is-no"),children:e?(0,d.jsx)("svg",{viewBox:"0 0 24 24","aria-hidden":"true",className:"perm-mark-icon",children:(0,d.jsx)("path",{d:"M5 13l4 4L19 7"})}):(0,d.jsx)("svg",{viewBox:"0 0 24 24","aria-hidden":"true",className:"perm-mark-icon",children:(0,d.jsx)("path",{d:"M6 6l12 12M18 6l-12 12"})})});function m(e){let{permissionsGrouped:s={},permissionSelections:n={},permissionScopes:i={},userSchools:l=[],isAdmin:a=!1,onTogglePermission:o,onToggleGroup:c,onScopeChange:m,defaultCollapsed:h=!1}=e;const[p,g]=(0,t.useState)(""),[v,y]=(0,t.useState)(()=>{if(!h)return{};const e=Object.keys(s||{});return 0===e.length?{}:e.reduce((e,s)=>(e[s]=!0,e),{})});(0,t.useEffect)(()=>{if(!h)return;const e=Object.keys(s||{});0!==e.length&&y(s=>{let n=!1;const t=(0,r.A)({},s);return e.forEach(e=>{null==t[e]&&(t[e]=!0,n=!0)}),n?t:s})},[h,s]);const x=(0,t.useMemo)(()=>{const e={};return Object.entries(s||{}).forEach(s=>{let[n,r]=s;const t=new Map;r.forEach(e=>{if(!a&&"page.manage_permissions"===e.resource)return;const s=String(e.resource||"");var n;s&&(t.has(s)||t.set(s,{resource:s,label:(n=e.label||s,String(n||"").replace(/\s*(?:-|\u2013)\s*(View|Edit)\s*$/i,"")),readKey:"".concat(s,"|read"),writeKey:"".concat(s,"|write")}))});const i=Array.from(t.values());i.sort((e,s)=>e.label.localeCompare(s.label,"en",{sensitivity:"base"})),e[n]=i}),e},[s,a]);if(!s||0===Object.keys(s).length)return(0,d.jsx)("div",{children:"No permissions defined."});return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("div",{style:{marginBottom:12},children:(0,d.jsx)("input",{className:"input sm",placeholder:"Search permissions\u2026",value:p,onChange:e=>{g(e.target.value)}})}),Object.entries(s).map(e=>{let[s,t]=e;const h=x[s]||[];if(0===h.length)return null;const g=t.filter(e=>!!a||"page.manage_permissions"!==e.resource).map(e=>"".concat(e.resource,"|").concat(e.action)),j=g.filter(e=>n[e]).length,f=g.length>0&&j===g.length,b=j>0&&!f,N=h.filter(e=>{if(!p)return!0;const s=p.trim().toLowerCase();return(e.label||"").toLowerCase().includes(s)||(e.resource||"").toLowerCase().includes(s)}),S=v[s];return(0,d.jsxs)("div",{style:{marginBottom:12},children:[(0,d.jsxs)("div",{className:"row",style:{alignItems:"center",marginBottom:6},children:[(0,d.jsx)("input",{type:"checkbox",checked:f,ref:e=>{e&&(e.indeterminate=b)},onChange:()=>null===c||void 0===c?void 0:c(g,!f)}),(0,d.jsxs)("div",{style:{fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",gap:6},onClick:()=>(e=>{y(s=>(0,r.A)((0,r.A)({},s),{},{[e]:!s[e]}))})(s),children:[s,(0,d.jsxs)("span",{style:{fontWeight:400,fontSize:12,color:"#6b7280"},children:["(",j,"/",g.length," enabled)"]}),(0,d.jsx)("span",{style:{fontSize:10},children:S?"\u25b6":"\u25bc"})]})]}),!S&&N.length>0&&(0,d.jsxs)("table",{className:"table permissions-table",children:[(0,d.jsx)("thead",{children:(0,d.jsxs)("tr",{children:[(0,d.jsx)("th",{children:"Permission"}),(0,d.jsx)("th",{style:{textAlign:"center"},children:"Read"}),(0,d.jsx)("th",{style:{textAlign:"center"},children:"Write"}),(0,d.jsx)("th",{children:"Scope"})]})}),(0,d.jsx)("tbody",{children:N.map(e=>{const s=Boolean(n[e.readKey]),r=Boolean(n[e.writeKey]),t=i[e.writeKey]||i[e.readKey]||"country",c=!s&&!r;return(0,d.jsxs)("tr",{children:[(0,d.jsxs)("td",{children:[(0,d.jsx)("div",{style:{fontWeight:600},children:e.label}),(0,d.jsx)("div",{className:"small",style:{color:"#6b7280"},children:e.resource})]}),(0,d.jsx)("td",{style:{textAlign:"center"},children:(0,d.jsx)("button",{type:"button",className:"perm-toggle ".concat(s?"is-yes":"is-no"),onClick:()=>null===o||void 0===o?void 0:o(e.readKey,t),"aria-pressed":s,title:"Read",children:u(s)})}),(0,d.jsx)("td",{style:{textAlign:"center"},children:(0,d.jsx)("button",{type:"button",className:"perm-toggle ".concat(r?"is-yes":"is-no"),onClick:()=>null===o||void 0===o?void 0:o(e.writeKey,t),"aria-pressed":r,title:"Write",children:u(r)})}),(0,d.jsx)("td",{children:(0,d.jsxs)("select",{className:"input sm",disabled:c,value:t,onChange:s=>null===m||void 0===m?void 0:m(e.resource,s.target.value),children:[(0,d.jsx)("option",{value:"country",children:a?"User Country":"Country"}),l&&l.map(e=>(0,d.jsx)("option",{value:"school:".concat(e.id),children:e.name},e.id))]})})]},e.resource)})})]}),!S&&0===N.length&&(0,d.jsx)("div",{className:"small",style:{marginLeft:32},children:"No permissions match your search."})]},s)})]})}function h(e){let{show:s,onClose:n,onCreated:r,countries:l=[]}=e;const[o,c]=(0,t.useState)(""),[u,m]=(0,t.useState)(""),[h,p]=(0,t.useState)(""),[g,v]=(0,t.useState)("user"),[y,x]=(0,t.useState)(""),[j,f]=(0,t.useState)(""),[b,N]=(0,t.useState)([]),[S,C]=(0,t.useState)(!1),[w,A]=(0,t.useState)(!1);if((0,t.useEffect)(()=>{if(!s)return;if("principal"!==g)return f(""),void N([]);if(!y)return f(""),void N([]);f(""),N([]);let e=!0;return C(!0),(async()=>{try{const s=await i.FH.adminListCountrySchools(y),n=Array.isArray(s)?s:null!==s&&void 0!==s&&s.items&&Array.isArray(s.items)?s.items:[];e&&N(n)}catch(s){console.error(s),e&&(N([]),a.oR.error((null===s||void 0===s?void 0:s.message)||"Failed to load schools"))}finally{e&&C(!1)}})(),()=>{e=!1}},[s,g,y]),!s)return null;return(0,d.jsx)("div",{className:"modal-backdrop",onClick:n,children:(0,d.jsxs)("div",{className:"modal",onClick:e=>{e.stopPropagation()},children:[(0,d.jsx)("h2",{style:{marginTop:0,marginBottom:8},children:"Create User"}),(0,d.jsx)("div",{className:"small",style:{marginBottom:12},children:"Enter details for the new user. A temporary password must be at least 8 characters."}),(0,d.jsxs)("form",{onSubmit:async e=>{e.preventDefault();const s=u.trim();if(!s||!h)return void a.oR.error("Email and password are required");if(h.length<8)return void a.oR.error("Password must be at least 8 characters");if(["user","hr","principal","manager","accountant","admin"].includes(g))if("principal"!==g||y){A(!0);try{const e={full_name:o?o.trim():null,email:s,password:h,role:g};y&&"unassigned"!==y&&(e.country_id=Number(y));const l=await i.FH.createUser(e);if("principal"===g&&j){const e=Number(j);if(Number.isFinite(e))try{const s=await i.FH.adminGetSchoolPrincipals(e),n=Array.isArray(s)?s.map(e=>Number(e.id)).filter(Number.isFinite):[],r=Number(null===l||void 0===l?void 0:l.id);Number.isFinite(r)&&!n.includes(r)&&n.push(r),await i.FH.adminSetSchoolPrincipals(e,{userIds:n})}catch(t){console.error(t),a.oR.error((null===t||void 0===t?void 0:t.message)||"Failed to assign principal to school")}}a.oR.success("User created"),c(""),m(""),p(""),v("user"),x(""),f(""),N([]),null===r||void 0===r||r(),null===n||void 0===n||n()}catch(t){console.error(t),a.oR.error((null===t||void 0===t?void 0:t.message)||"Failed to create user")}finally{A(!1)}}else a.oR.error("Country is required for principals");else a.oR.error("Invalid role")},children:[(0,d.jsxs)("div",{className:"row",style:{gap:8,flexWrap:"wrap",marginBottom:12},children:[(0,d.jsx)("input",{className:"input full",placeholder:"Full name",value:o,onChange:e=>c(e.target.value)}),(0,d.jsx)("input",{className:"input full",placeholder:"Email",type:"email",value:u,onChange:e=>m(e.target.value)}),(0,d.jsx)("input",{className:"input full",placeholder:"Temporary password",type:"password",value:h,onChange:e=>p(e.target.value)}),(0,d.jsxs)("select",{className:"input full",value:g,onChange:e=>v(e.target.value),children:[(0,d.jsx)("option",{value:"user",children:"User"}),(0,d.jsx)("option",{value:"hr",children:"HR"}),(0,d.jsx)("option",{value:"principal",children:"Principal"}),(0,d.jsx)("option",{value:"manager",children:"Manager"}),(0,d.jsx)("option",{value:"accountant",children:"Accountant"}),(0,d.jsx)("option",{value:"admin",children:"Admin"})]}),(0,d.jsxs)("select",{className:"input full",value:y,onChange:e=>x(e.target.value),children:[(0,d.jsx)("option",{value:"",children:"principal"===g?"Select country (required)":"Unassigned"}),l.map(e=>(0,d.jsx)("option",{value:e.id,children:e.name},e.id))]}),"principal"===g?(0,d.jsxs)("select",{className:"input full",value:j,onChange:e=>f(e.target.value),disabled:!y||S,children:[(0,d.jsx)("option",{value:"",children:S?"Loading schools...":"Optional: assign to a school"}),b.map(e=>(0,d.jsx)("option",{value:e.id,children:e.name},e.id))]}):null]}),(0,d.jsxs)("div",{className:"row",style:{justifyContent:"flex-end",gap:8},children:[(0,d.jsx)("button",{type:"button",className:"btn",onClick:n,disabled:w,children:"Cancel"}),(0,d.jsx)("button",{type:"submit",className:"btn primary",disabled:w,children:w?"Creating...":"Create User"})]})]})]})})}function p(e){let{show:s,onClose:n,onCreated:r,countries:l=[]}=e;const[o,c]=(0,t.useState)(""),[u,m]=(0,t.useState)([""]),[h,p]=(0,t.useState)(!1),g=(0,t.useMemo)(()=>u.reduce((e,s)=>String(s||"").trim()?e+1:e,0),[u]);if(!s)return null;return(0,d.jsx)("div",{className:"modal-backdrop",onClick:n,children:(0,d.jsxs)("div",{className:"modal",onClick:e=>{e.stopPropagation()},children:[(0,d.jsx)("h2",{style:{marginTop:0,marginBottom:8},children:"Create School"}),(0,d.jsx)("div",{className:"small",style:{marginBottom:12},children:"Choose a country and enter one or more school names."}),(0,d.jsxs)("form",{onSubmit:async e=>{e.preventDefault();const s=u.map(e=>String(e||"").trim()).filter(Boolean),t=Array.from(new Set(s));if(!o)return void a.oR.error("Country is required");if(!t.length)return void a.oR.error("At least one school name is required");p(!0);const l=[];let d=0;try{for(const e of t)try{await i.FH.adminCreateCountrySchool(o,{name:e}),d+=1}catch(h){l.push({name:e,message:(null===h||void 0===h?void 0:h.message)||"Failed to create school"})}d>0&&(null===r||void 0===r||r(o)),l.length?(a.oR.error("".concat(l.length," of ").concat(t.length," schools failed")),m(l.map(e=>e.name))):(a.oR.success("".concat(d," schools created")),c(""),m([""]),null===n||void 0===n||n())}catch(h){console.error(h),a.oR.error((null===h||void 0===h?void 0:h.message)||"Failed to create school")}finally{p(!1)}},children:[(0,d.jsx)("div",{className:"row",style:{gap:8,flexWrap:"wrap",marginBottom:12},children:(0,d.jsxs)("select",{className:"input full",value:o,onChange:e=>c(e.target.value),disabled:h,children:[(0,d.jsx)("option",{value:"",children:"Select country\u2026"}),l.map(e=>(0,d.jsx)("option",{value:e.id,children:e.name},e.id))]})}),(0,d.jsx)("div",{style:{display:"grid",gap:8,marginBottom:12},children:u.map((e,s)=>(0,d.jsxs)("div",{className:"row",style:{gap:8},children:[(0,d.jsx)("input",{className:"input full",placeholder:"School name #".concat(s+1),value:e,onChange:e=>{return n=s,r=e.target.value,void m(e=>{const s=[...e];return s[n]=r,s});var n,r},disabled:h}),(0,d.jsx)("button",{type:"button",className:"btn",onClick:()=>{return e=s,void m(s=>s.length<=1?s:s.filter((s,n)=>n!==e));var e},disabled:h||u.length<=1,children:"Remove"})]},"school-row-".concat(s)))}),(0,d.jsxs)("div",{className:"row",style:{justifyContent:"space-between",gap:8,marginBottom:12},children:[(0,d.jsx)("button",{type:"button",className:"btn",onClick:()=>{m(e=>[...e,""])},disabled:h,children:"Add row"}),(0,d.jsx)("div",{className:"small",style:{color:"#6b7280"},children:"Add one school per row."})]}),(0,d.jsxs)("div",{className:"row",style:{justifyContent:"flex-end",gap:8},children:[(0,d.jsx)("button",{type:"button",className:"btn",onClick:n,disabled:h,children:"Cancel"}),(0,d.jsx)("button",{type:"submit",className:"btn primary",disabled:h,children:h?"Creating...":g>1?"Create ".concat(g," schools"):"Create school"})]})]})]})})}function g(e){let{show:s,school:n,users:r=[],countryId:l,onClose:o,onSaved:c}=e;const[u,m]=(0,t.useState)([]),[h,p]=(0,t.useState)([]),[g,v]=(0,t.useState)(!1),[y,x]=(0,t.useState)(!1),[j,f]=(0,t.useState)(""),b=(0,t.useMemo)(()=>r.filter(e=>"principal"===e.role&&String(e.country_id)===String(l)),[r,l]);(0,t.useEffect)(()=>{!async function(){if(s&&n){v(!0);try{const e=await i.FH.adminGetSchoolPrincipals(n.id),s=Array.isArray(e)?e.map(e=>e.id):[];m(s),p(s)}catch(e){console.error(e),m([]),p([])}finally{v(!1)}}}()},[s,n]);const N=(0,t.useMemo)(()=>{const e=j.trim().toLowerCase();return b.filter(e=>!u.includes(e.id)).filter(s=>{if(!e)return!0;const n=(s.full_name||"").toLowerCase(),r=(s.email||"").toLowerCase();return n.includes(e)||r.includes(e)})},[b,u,j]),S=(0,t.useMemo)(()=>{if(u.length!==h.length)return!0;for(const e of u)if(!h.includes(e))return!0;return!1},[u,h]);if(!s||!n)return null;const C=()=>{m(h.slice()),null===o||void 0===o||o()};return(0,d.jsx)("div",{className:"drawer-backdrop",onClick:C,children:(0,d.jsxs)("div",{className:"drawer",onClick:e=>{e.stopPropagation()},children:[(0,d.jsxs)("div",{className:"drawer-header",style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12},children:[(0,d.jsxs)("div",{style:{fontWeight:700},children:["School: ",n.name]}),(0,d.jsx)("button",{className:"btn",style:{border:"none",background:"transparent",padding:0},onClick:C,children:"\xd7"})]}),g?(0,d.jsx)("div",{children:"Loading principals..."}):0===b.length?(0,d.jsx)("div",{children:"No principals found in this country. Create a principal user first, then assign them to schools."}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)("div",{style:{marginBottom:12},children:[(0,d.jsx)("div",{style:{fontWeight:600,marginBottom:6},children:"Assigned principals"}),0===u.length?(0,d.jsx)("div",{className:"small",children:"No principals assigned to this school yet."}):(0,d.jsx)("div",{className:"row",style:{gap:6,flexWrap:"wrap"},children:u.map(e=>{const s=r.find(s=>String(s.id)===String(e)),n=s?s.full_name||s.email||s.id:e;return(0,d.jsxs)("div",{className:"chip",children:[(0,d.jsx)("span",{children:n}),(0,d.jsx)("button",{type:"button",className:"chip-remove",onClick:()=>{return s=e,void m(e=>e.filter(e=>e!==s));var s},"aria-label":"Remove principal",children:"\xd7"})]},e)})})]}),(0,d.jsxs)("div",{style:{marginBottom:12},children:[(0,d.jsx)("div",{style:{fontWeight:600,marginBottom:6},children:"Add principal"}),(0,d.jsx)("input",{className:"input full",placeholder:"Find a principal\u2026",value:j,onChange:e=>f(e.target.value),style:{marginBottom:6}}),(0,d.jsx)("div",{style:{maxHeight:200,overflowY:"auto"},children:0===N.length?(0,d.jsx)("div",{className:"small",children:"No principals available"}):N.map(e=>{const s=e.full_name||e.email||e.id;return(0,d.jsx)("div",{className:"access-list-item",style:{cursor:"pointer"},onClick:()=>{return s=e.id,void m(e=>e.includes(s)?e:[...e,s]);var s},children:(0,d.jsx)("div",{children:s})},e.id)})})]}),(0,d.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:8},children:[(0,d.jsx)("button",{className:"btn",onClick:C,disabled:y,children:"Cancel"}),(0,d.jsx)("button",{className:"btn primary",onClick:async()=>{if(n){x(!0);try{await i.FH.adminSetSchoolPrincipals(n.id,{userIds:u}),a.oR.success("Saved"),p(u.slice()),null===c||void 0===c||c(n.id,u),null===o||void 0===o||o()}catch(e){console.error(e),a.oR.error((null===e||void 0===e?void 0:e.message)||"Failed to save principals")}finally{x(!1)}}},disabled:y||!S,children:y?"Saving...":"Save"})]})]})]})})}const v=[{key:"managePermissions",label:"Manage Permissions",resources:["page.manage_permissions"]},{key:"createUser",label:"Create User",resources:["user.create"]},{key:"createSchool",label:"Create School",resources:["school.create"]},{key:"scenarioActions",label:"Scenario Actions",resources:["scenario.create","scenario.plan_edit","scenario.copy","scenario.submit","scenario.delete"]}],y=v.flatMap(e=>e.resources),x=new Set(y);function j(e,s){const n={};return v.forEach(r=>{n[r.key]=r.resources.every(n=>function(e,s,n){return!!Array.isArray(e)&&e.some(e=>e.resource===s&&"write"===e.action&&null==e.scope_school_id&&(null==e.scope_country_id||Number(e.scope_country_id)===Number(n)))}(e,n,s))}),n}function f(){const e=(0,o.KC)(),[s,n]=(0,t.useState)([]),[u,y]=(0,t.useState)([]),f=(0,l.F2)({limit:50,offset:0,fields:"brief",order:"full_name:asc"}),b=f.isFetching,[N,S]=(0,t.useState)(""),[C,w]=(0,t.useState)("all"),[A,k]=(0,t.useState)("all"),[F,_]=(0,t.useState)(!1),[R,E]=(0,t.useState)(null),[U,B]=(0,t.useState)(null),[M,H]=(0,t.useState)(""),[P,L]=(0,t.useState)(null),[W,I]=(0,t.useState)(""),[T,q]=(0,t.useState)({}),[O,K]=(0,t.useState)({}),[D,G]=(0,t.useState)({}),[z,V]=(0,t.useState)({}),[Y,$]=(0,t.useState)(null),[J,Q]=(0,t.useState)(!1),[X,Z]=(0,t.useState)([]),[ee,se]=(0,t.useState)(!1),[ne,re]=(0,t.useState)("countries"),[te,ie]=(0,t.useState)(null),[le,ae]=(0,t.useState)(""),[oe,ce]=(0,t.useState)(""),[de,ue]=(0,t.useState)({}),[me,he]=(0,t.useState)({}),pe=(0,t.useRef)({}),ge=(0,t.useRef)({}),[ve,ye]=(0,t.useState)(null),[xe,je]=(0,t.useState)(null),[fe,be]=(0,t.useState)(!1),[Ne,Se]=(0,t.useState)(!1),[Ce,we]=(0,t.useState)(!1),[Ae,ke]=(0,t.useState)(""),[Fe,_e]=(0,t.useState)([]),[Re,Ee]=(0,t.useState)(""),[Ue,Be]=(0,t.useState)(null),Me=(0,l.al)();(0,t.useEffect)(()=>{var s;return null===e||void 0===e||null===(s=e.setHeaderMeta)||void 0===s||s.call(e,{title:"Access Management",subtitle:"Manage users, permissions, and principal assignments",centered:!0}),()=>{var s;null===e||void 0===e||null===(s=e.clearHeaderMeta)||void 0===s||s.call(e)}},[e]);const He=(0,t.useCallback)(async()=>{const e=await Me.refetch();var s;null!==e&&void 0!==e&&e.error&&(console.error(e.error),a.oR.error((null===(s=e.error)||void 0===s?void 0:s.message)||"Failed to load countries"))},[Me]),Pe=(0,t.useCallback)(async()=>{const e=await f.refetch();var s;null!==e&&void 0!==e&&e.error&&(console.error(e.error),a.oR.error((null===(s=e.error)||void 0===s?void 0:s.message)||"Failed to load users"))},[f]);(0,t.useEffect)(()=>{const e=Me.data;n(Array.isArray(e)?e:[])},[Me.data]),(0,t.useEffect)(()=>{var e;const s=null===(e=f.data)||void 0===e?void 0:e.items;y(Array.isArray(s)?s:[])},[f.data]),(0,t.useEffect)(()=>{var e;Me.isError&&(console.error(Me.error),a.oR.error((null===(e=Me.error)||void 0===e?void 0:e.message)||"Failed to load countries"))},[Me.isError,Me.error]),(0,t.useEffect)(()=>{var e;f.isError&&(console.error(f.error),a.oR.error((null===(e=f.error)||void 0===e?void 0:e.message)||"Failed to load users"))},[f.isError,f.error]);const Le=(0,t.useCallback)(async e=>{const s=Number(e);if(Number.isFinite(s))try{const e=await i.FH.adminListCountrySchools(s);Array.isArray(e)?_e(e):e&&Array.isArray(e.items)?_e(e.items):_e([])}catch(n){console.error(n),a.oR.error((null===n||void 0===n?void 0:n.message)||"Failed to load schools"),_e([])}else _e([])},[]),We=(0,t.useCallback)(async e=>{if(!e)return $(null),q({}),K({}),Z([]),B(null),H(""),L(null),I(""),G({}),void V({});Q(!0);try{const s=null!=e.country_id?i.FH.adminListCountrySchools(e.country_id):Promise.resolve([]),[n,r,t]=await Promise.all([i.FH.adminGetPermissionsCatalog(),i.FH.adminGetUserPermissions(e.id),s]);$(n||null);let l=[];Array.isArray(t)?l=t:t&&Array.isArray(t.items)&&(l=t.items),Z(l);const a={},o={};(r||[]).forEach(e=>{const s="".concat(e.resource,"|").concat(e.action);a[s]=!0,null!=e.scope_school_id?o[s]="school:".concat(e.scope_school_id):o[s]="country"}),q(a),K(o),B(e.role||null),H(null!=e.country_id?String(e.country_id):""),L(e.role||null),I(null!=e.country_id?String(e.country_id):""),G(a),V(o)}catch(s){console.error(s),a.oR.error((null===s||void 0===s?void 0:s.message)||"Failed to load permissions")}finally{Q(!1)}},[]);(0,t.useEffect)(()=>{pe.current=de},[de]),(0,t.useEffect)(()=>{ge.current=me},[me]),(0,t.useEffect)(()=>{const e=u.find(e=>String(e.id)===String(R));We(e)},[R,u,We]),(0,t.useEffect)(()=>{"schools"===ne&&Le(Ae)},[ne,Ae,Le]);const Ie=(0,t.useMemo)(()=>u.filter(e=>"accountant"===String(e.role)),[u]),Te=(0,t.useMemo)(()=>{const e={};return Ie.forEach(s=>{const n=null!=s.country_id?String(s.country_id):"";e[n]||(e[n]=[]),e[n].push(s)}),Object.values(e).forEach(e=>{e.sort((e,s)=>{const n=(e.full_name||e.email||"").toLowerCase(),r=(s.full_name||s.email||"").toLowerCase();return n.localeCompare(r)})}),e},[Ie]),qe=(0,t.useCallback)(async e=>{if(!e)return[];const s=pe.current[e];if(s)return s;he(s=>(0,r.A)((0,r.A)({},s),{},{[e]:!0}));try{const s=await i.FH.adminGetUserPermissions(e),n=Array.isArray(s)?s:[];return ue(s=>(0,r.A)((0,r.A)({},s),{},{[e]:n})),n}catch(n){return console.error(n),a.oR.error((null===n||void 0===n?void 0:n.message)||"Failed to load accountant permissions"),[]}finally{he(s=>{const n=(0,r.A)({},s);return delete n[e],n})}},[]);(0,t.useEffect)(()=>{if("countries"!==ne)return;if(0===Ie.length)return;const e=Ie.filter(e=>!pe.current[e.id]&&!ge.current[e.id]);0!==e.length&&(he(s=>{const n=(0,r.A)({},s);return e.forEach(e=>{n[e.id]=!0}),n}),Promise.allSettled(e.map(e=>i.FH.adminGetUserPermissions(e.id))).then(s=>{let n=!1;ue(t=>{const i=(0,r.A)({},t);return s.forEach((s,r)=>{var t;const l=null===(t=e[r])||void 0===t?void 0:t.id;l&&("fulfilled"===s.status?i[l]=Array.isArray(s.value)?s.value:[]:n=!0)}),i}),n&&a.oR.error("Failed to load some accountant permissions")}).finally(()=>{he(s=>{const n=(0,r.A)({},s);return e.forEach(e=>{delete n[e.id]}),n})}))},[ne,Ie]);const Oe=(0,t.useMemo)(()=>s.find(e=>String(e.id)===String(te))||null,[s,te]),Ke=(0,t.useMemo)(()=>Oe&&Te[String(Oe.id)]||[],[Te,Oe]),De=(0,t.useMemo)(()=>Oe?u.filter(e=>"admin"!==String(e.role)&&(null==e.country_id||Number(e.country_id)===Number(Oe.id))):[],[Oe,u]);(0,t.useEffect)(()=>{if(!Oe)return ae(""),ce(""),ye(null),void je(null);if(0===Ke.length)return ae(""),ye(null),void je(null);Ke.some(e=>String(e.id)===String(le))||ae(String(Ke[0].id))},[Ke,le,Oe]),(0,t.useEffect)(()=>{let e=!0;return(async()=>{if(!Oe||!le)return ye(null),void je(null);const s=Number(le);if(!Number.isFinite(s))return;const n=await qe(s);if(!e)return;const r=j(n,Oe.id);ye(r),je(r)})(),()=>{e=!1}},[qe,le,Oe]);const Ge=(0,t.useMemo)(()=>Y?"object"!==typeof Y||Array.isArray(Y)?Array.isArray(Y)?Y.reduce((e,s)=>{const n=s.group||"Other";return e[n]||(e[n]=[]),e[n].push(s),e},{}):{}:Y:{},[Y]),ze=(0,t.useCallback)(function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"country";if(!e)return;const[n,t]=e.split("|"),i="".concat(n,"|read"),l="".concat(n,"|write"),a=(0,r.A)({},T),o=(0,r.A)({},O),c=!!!T[e];"write"===t?c?(a[l]=!0,a[i]=!0,o[l]||(o[l]=s||"country"),o[i]||(o[i]=s||"country")):(a[l]=!1,delete o[l]):c?(a[i]=!0,o[i]||(o[i]=s||"country")):(a[i]=!1,a[l]=!1,delete o[i],delete o[l]),q(a),K(o)},[T,O]),Ve=(0,t.useCallback)((e,s)=>{Array.isArray(e)&&0!==e.length&&e.forEach(e=>{!!T[e]!==s&&ze(e,"country")})},[T,ze]);const Ye=(0,t.useMemo)(()=>{if(null==R)return!1;if(U!==P)return!0;if((M||"")!==(W||""))return!0;const e=new Set([...Object.keys(D||{}),...Object.keys(T||{})]);for(const s of e){if(!!T[s]!==!!D[s])return!0;if((O[s]||null)!==(z[s]||null))return!0}return!1},[R,U,M,P,W,T,O,D,z]);const $e=(0,t.useMemo)(()=>{let e=u;C&&"all"!==C&&(e=e.filter(e=>e.role===C)),F&&(e=e.filter(e=>null==e.country_id)),A&&"all"!==A&&(e="unassigned"===A?e.filter(e=>null==e.country_id):e.filter(e=>String(e.country_id)===String(A)));const s=N.trim().toLowerCase();return s&&(e=e.filter(e=>{const n=(e.full_name||"").toLowerCase(),r=(e.email||"").toLowerCase();return n.includes(s)||r.includes(s)})),e},[u,C,A,N,F]),Je=(0,t.useMemo)(()=>{if(!Array.isArray(Fe))return[];const e=Re.trim().toLowerCase();return e?Fe.filter(s=>(s.name||"").toLowerCase().includes(e)):Fe},[Fe,Re]),Qe=(0,t.useMemo)(()=>!(!ve||!xe)&&v.some(e=>ve[e.key]!==xe[e.key]),[ve,xe]),Xe=(0,t.useCallback)(e=>(null===e||void 0===e?void 0:e.full_name)||(null===e||void 0===e?void 0:e.email)||(null===e||void 0===e?void 0:e.id)||"Unknown",[]);return(0,d.jsxs)("div",{className:"permissions-page",children:[(0,d.jsxs)("div",{className:"container permissions-page-content",style:{padding:"1rem"},children:[(0,d.jsxs)("div",{className:"row",style:{justifyContent:"space-between",alignItems:"center"},children:[(0,d.jsxs)("div",{className:"access-hub-tabs",children:[(0,d.jsx)("div",{className:"access-hub-tab ".concat("countries"===ne?"is-active":""),onClick:()=>{re("countries"),E(null),Be(null)},children:"Countries & Accountants"}),(0,d.jsx)("div",{className:"access-hub-tab ".concat("users"===ne?"is-active":""),onClick:()=>{re("users"),Be(null),ie(null)},children:"Users & Permissions"}),(0,d.jsx)("div",{className:"access-hub-tab ".concat("schools"===ne?"is-active":""),onClick:()=>{re("schools"),E(null),ie(null)},children:"Schools & Principals"})]}),(0,d.jsxs)("div",{className:"row",style:{gap:8},children:[(0,d.jsx)("button",{className:"btn primary",onClick:()=>Se(!0),children:(0,d.jsxs)("span",{className:"row",style:{gap:6,alignItems:"center"},children:[(0,d.jsx)(c.NPy,{"aria-hidden":"true"}),(0,d.jsx)("span",{children:"Create user"})]})}),(0,d.jsx)("button",{className:"btn primary",onClick:()=>we(!0),children:(0,d.jsxs)("span",{className:"row",style:{gap:6,alignItems:"center"},children:[(0,d.jsx)(c.iM1,{"aria-hidden":"true"}),(0,d.jsx)("span",{children:"Create school"})]})})]})]}),"countries"===ne&&(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("div",{className:"school-assignments-overlay ".concat(Oe?"is-open":""),onClick:()=>ie(null),role:"button","aria-label":"Close country drawer",tabIndex:-1}),(0,d.jsxs)("aside",{className:"school-assignments-drawer ".concat(Oe?"is-open":""),children:[(0,d.jsxs)("div",{className:"school-assignments-drawer-header",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"school-assignments-drawer-title",children:"Country accountants"}),(0,d.jsx)("div",{className:"school-assignments-drawer-subtitle",children:Oe?"".concat(Oe.name," ").concat(Oe.code?"(".concat(Oe.code,")"):""):"Select a country"})]}),(0,d.jsx)("button",{className:"btn school-assignments-close",onClick:()=>ie(null),"aria-label":"Close drawer",type:"button",children:"x"})]}),(0,d.jsx)("div",{className:"school-assignments-drawer-body",children:Oe?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("div",{className:"school-assignments-section-title",children:"Assigned accountant"}),0===Ke.length?(0,d.jsx)("div",{className:"school-assignments-add-card",children:(0,d.jsxs)("div",{className:"row",style:{flexDirection:"column",gap:8},children:[(0,d.jsxs)("select",{className:"input full",value:oe,onChange:e=>ce(e.target.value),children:[(0,d.jsx)("option",{value:"",children:"Select user..."}),De.map(e=>(0,d.jsx)("option",{value:e.id,children:Xe(e)},e.id))]}),(0,d.jsx)("button",{className:"btn primary",onClick:async()=>{if(!Oe||!oe)return;const e=Number(oe);if(Number.isFinite(e)){be(!0);try{const s=u.find(s=>String(s.id)===String(e));if(!s)return void a.oR.error("User not found");null!=s.country_id&&Number(s.country_id)===Number(Oe.id)||await i.FH.assignUserCountry(e,{country_id:Oe.id}),await i.FH.adminUpdateUserRole(e,{role:"accountant"}),a.oR.success("Accountant assigned"),ue(s=>{const n=(0,r.A)({},s);return delete n[e],n}),await Pe(),ce(""),ae(String(e))}catch(s){console.error(s),a.oR.error((null===s||void 0===s?void 0:s.message)||"Failed to assign accountant")}finally{be(!1)}}},disabled:!oe||fe,children:fe?"Assigning...":"Set as Accountant"}),0===De.length&&(0,d.jsx)("div",{className:"small",children:"No eligible users available."})]})}):(0,d.jsxs)("div",{className:"school-assignments-add-card",children:[Ke.length>1?(0,d.jsx)("select",{className:"input full",value:le,onChange:e=>ae(e.target.value),children:Ke.map(e=>(0,d.jsx)("option",{value:e.id,children:Xe(e)},e.id))}):(0,d.jsx)("div",{style:{fontWeight:600},children:Xe(Ke[0])}),Ke.length>1&&(0,d.jsx)("div",{className:"small",style:{marginTop:6},children:"Multiple accountants assigned. Select one to edit."})]}),(0,d.jsx)("div",{className:"school-assignments-section-title",children:"Accountant capabilities"}),le?(0,d.jsxs)("div",{className:"school-assignments-card",children:[v.map(e=>(0,d.jsxs)("label",{className:"school-assignments-module-item",children:[(0,d.jsx)("input",{type:"checkbox",checked:Boolean(null===ve||void 0===ve?void 0:ve[e.key]),onChange:()=>{return s=e.key,void ye(e=>(0,r.A)((0,r.A)({},e),{},{[s]:!(null!==e&&void 0!==e&&e[s])}));var s},disabled:fe}),(0,d.jsx)("span",{children:e.label})]},e.key)),(0,d.jsxs)("div",{className:"row",style:{justifyContent:"flex-end",gap:8,marginTop:12},children:[(0,d.jsx)("button",{className:"btn",onClick:()=>{ye(xe)},disabled:!Qe||fe,children:"Discard"}),(0,d.jsx)("button",{className:"btn primary",onClick:async()=>{if(!Oe||!le)return;const e=Number(le);if(Number.isFinite(e)){be(!0);try{const s=pe.current[e]||await qe(e);let n=(Array.isArray(s)?s:[]).filter(e=>!x.has(e.resource));v.forEach(e=>{null!==ve&&void 0!==ve&&ve[e.key]&&e.resources.forEach(e=>{n.push({resource:e,action:"read",scope_country_id:Number(Oe.id),scope_school_id:null}),n.push({resource:e,action:"write",scope_country_id:Number(Oe.id),scope_school_id:null})})}),n=function(e){const s=new Map;return(Array.isArray(e)?e:[]).forEach(e=>{var n,r;const t=[e.resource,e.action,null!==(n=e.scope_country_id)&&void 0!==n?n:"",null!==(r=e.scope_school_id)&&void 0!==r?r:""].join("|");s.set(t,e)}),Array.from(s.values())}(n),await i.FH.adminSetUserPermissions(e,{permissions:n}),ue(s=>(0,r.A)((0,r.A)({},s),{},{[e]:n})),je(ve),a.oR.success("Accountant permissions updated")}catch(s){console.error(s),a.oR.error((null===s||void 0===s?void 0:s.message)||"Failed to update permissions")}finally{be(!1)}}},disabled:!Qe||fe,children:fe?"Saving...":"Save"})]})]}):(0,d.jsx)("div",{className:"school-assignments-empty",children:"Assign an accountant to edit capabilities."}),le&&(0,d.jsx)("button",{className:"btn",onClick:()=>{le&&(re("users"),E(String(le)),ie(null))},style:{marginTop:12},children:"Open full permission editor"})]}):(0,d.jsx)("div",{className:"school-assignments-empty",children:"Select a country to manage accountants."})})]})]}),"countries"===ne&&(0,d.jsxs)("div",{style:{marginTop:16},children:[(0,d.jsx)("div",{style:{fontWeight:700,marginBottom:12},children:"Countries"}),(0,d.jsxs)("div",{className:"row",style:{gap:6,marginBottom:12,flexWrap:"wrap"},children:[(0,d.jsx)("span",{className:"role-tag is-ok",children:"Enabled"}),(0,d.jsx)("span",{className:"role-tag is-warn",children:"Disabled / No accountant"}),(0,d.jsx)("span",{className:"role-tag is-muted",children:"Loading / Unknown"})]}),(0,d.jsx)("div",{className:"school-assignments-table-wrap",children:(0,d.jsxs)("table",{className:"table school-assignments-table",children:[(0,d.jsx)("thead",{children:(0,d.jsxs)("tr",{children:[(0,d.jsx)("th",{children:"Country"}),(0,d.jsx)("th",{children:"Accountant status"}),(0,d.jsx)("th",{children:"Capabilities"})]})}),(0,d.jsx)("tbody",{children:0===s.length?(0,d.jsx)("tr",{children:(0,d.jsx)("td",{colSpan:3,children:"No countries available."})}):s.map(e=>{const s=Te[String(e.id)]||[],n=s[0]||null,r=s.length>1,t=0===s.length?"No accountant":1===s.length?"1 accountant: ".concat(Xe(n)):"Multiple accountants: ".concat(s.length),i=n?de[n.id]:null,l=i?j(i,e.id):null,a=n&&Boolean(me[n.id]);return(0,d.jsxs)("tr",{style:{cursor:"pointer"},onClick:()=>ie(String(e.id)),children:[(0,d.jsx)("td",{children:(0,d.jsxs)("div",{style:{fontWeight:600},children:[e.name,e.code?" (".concat(e.code,")"):""]})}),(0,d.jsx)("td",{children:(0,d.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,d.jsx)("span",{className:"role-tag ".concat(1===s.length?"is-ok":"is-warn"),children:t}),r&&(0,d.jsx)("span",{className:"role-tag is-warn",children:"Needs review"})]})}),(0,d.jsx)("td",{children:(0,d.jsx)("div",{className:"row",style:{gap:6},children:v.map(e=>{const n=null===l||void 0===l?void 0:l[e.key],r=e.label;let t="Unknown",i="role-tag is-muted";return 0===s.length?(t="No accountant",i="role-tag is-warn"):a?(t="Loading",i="role-tag is-muted"):l?n?(t="Enabled",i="role-tag is-ok"):(t="Disabled",i="role-tag is-warn"):(t="Unknown",i="role-tag is-muted"),(0,d.jsxs)("span",{className:i,children:[r,": ",t]},e.key)})})})]},e.id)})})]})})]}),"users"===ne&&(0,d.jsxs)("div",{className:"access-hub-grid",style:{marginTop:16},children:[(0,d.jsxs)("div",{className:"left-pane",children:[(0,d.jsx)("div",{style:{marginBottom:12,fontWeight:700},children:"Users"}),(0,d.jsxs)("div",{className:"row",style:{flexDirection:"column",gap:8},children:[(0,d.jsx)("input",{className:"input full",placeholder:"Search users by name or email\u2026",value:N,onChange:e=>S(e.target.value)}),(0,d.jsxs)("select",{className:"input full",value:C,onChange:e=>w(e.target.value),children:[(0,d.jsx)("option",{value:"all",children:"All roles"}),(0,d.jsx)("option",{value:"user",children:"User"}),(0,d.jsx)("option",{value:"hr",children:"HR"}),(0,d.jsx)("option",{value:"principal",children:"Principal"}),(0,d.jsx)("option",{value:"manager",children:"Manager"}),(0,d.jsx)("option",{value:"accountant",children:"Accountant"}),(0,d.jsx)("option",{value:"admin",children:"Admin"})]}),(0,d.jsxs)("select",{className:"input full",value:A,onChange:e=>k(e.target.value),children:[(0,d.jsx)("option",{value:"all",children:"All countries"}),s.map(e=>(0,d.jsx)("option",{value:String(e.id),children:e.name},e.id)),(0,d.jsx)("option",{value:"unassigned",children:"Unassigned"})]}),(0,d.jsxs)("label",{style:{display:"flex",alignItems:"center",gap:6},children:[(0,d.jsx)("input",{type:"checkbox",checked:F,onChange:e=>_(e.target.checked)}),(0,d.jsx)("span",{className:"small",children:"Show unassigned only"})]})]}),(0,d.jsx)("div",{style:{marginTop:12},children:b?(0,d.jsx)("div",{children:"Loading users\u2026"}):0===$e.length?(0,d.jsx)("div",{children:"No users yet. Create a user to start assigning permissions."}):$e.map(e=>{var s,n;const r=String(e.id)===String(R),t=e.full_name||e.email||e.id,i=e.email||"",l=(null===(s=e.role)||void 0===s?void 0:s.charAt(0).toUpperCase())+(null===(n=e.role)||void 0===n?void 0:n.slice(1))||"",a=e.country_name||"Unassigned";return(0,d.jsxs)("div",{className:"access-list-item ".concat(r?"is-selected":""),onClick:()=>E(String(e.id)),children:[(0,d.jsxs)("div",{style:{display:"flex",flexDirection:"column"},children:[(0,d.jsx)("div",{style:{fontWeight:600},children:t}),(0,d.jsx)("div",{className:"small",style:{color:"#6b7280"},children:i})]}),(0,d.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:6},children:[(0,d.jsx)("span",{className:"role-tag",children:l}),(0,d.jsx)("span",{className:"role-tag",children:a})]})]},e.id)})})]}),(0,d.jsx)("div",{className:"right-pane",children:R?J?(0,d.jsx)("div",{children:"Loading permissions\u2026"}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)("div",{className:"card",style:{marginBottom:16},children:[(0,d.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"User details"}),(()=>{const e=u.find(e=>String(e.id)===String(R));if(!e)return null;const n=e.full_name||e.email||e.id;return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)("div",{style:{marginBottom:8},children:[(0,d.jsx)("div",{style:{fontWeight:600},children:n}),(0,d.jsx)("div",{className:"small",style:{color:"#6b7280"},children:e.email})]}),(0,d.jsxs)("div",{className:"row",style:{gap:8,marginBottom:8},children:[(0,d.jsxs)("div",{style:{flex:1},children:[(0,d.jsx)("label",{className:"small",style:{display:"block",marginBottom:4},children:"Role"}),(0,d.jsxs)("select",{className:"input full",value:U||"user",onChange:e=>B(e.target.value),children:[(0,d.jsx)("option",{value:"user",children:"User"}),(0,d.jsx)("option",{value:"hr",children:"HR"}),(0,d.jsx)("option",{value:"principal",children:"Principal"}),(0,d.jsx)("option",{value:"manager",children:"Manager"}),(0,d.jsx)("option",{value:"accountant",children:"Accountant"}),(0,d.jsx)("option",{value:"admin",children:"Admin"})]})]}),(0,d.jsxs)("div",{style:{flex:1},children:[(0,d.jsx)("label",{className:"small",style:{display:"block",marginBottom:4},children:"Country"}),(0,d.jsxs)("select",{className:"input full",value:M,onChange:e=>H(e.target.value),children:[(0,d.jsx)("option",{value:"",children:"Unassigned"}),s.map(e=>(0,d.jsx)("option",{value:String(e.id),children:e.name},e.id))]}),""===M&&(0,d.jsx)("div",{className:"small",style:{color:"#ef4444",marginTop:4},children:"Assign a country to edit scoped permissions."})]})]})]})})()]}),(0,d.jsxs)("div",{className:"card",children:[(0,d.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Permissions"}),M?(0,d.jsx)(m,{permissionsGrouped:Ge,permissionSelections:T,permissionScopes:O,userSchools:X,isAdmin:!0,onTogglePermission:ze,onToggleGroup:Ve,onScopeChange:function(e,s){const n="".concat(e,"|read"),t="".concat(e,"|write");K(e=>{const i=(0,r.A)({},e);return T[n]&&(i[n]=s),T[t]&&(i[t]=s),i})}}):(0,d.jsx)("div",{children:"Assign a country to edit scoped permissions."})]})]}):(0,d.jsx)("div",{style:{padding:16},children:"Select a user from the list to edit role and permissions."})})]}),"schools"===ne&&(0,d.jsxs)("div",{className:"access-hub-grid",style:{marginTop:16},children:[(0,d.jsxs)("div",{className:"left-pane",children:[(0,d.jsx)("div",{style:{marginBottom:12,fontWeight:700},children:"Schools"}),(0,d.jsxs)("div",{className:"row",style:{flexDirection:"column",gap:8},children:[(0,d.jsxs)("select",{className:"input full",value:Ae,onChange:e=>ke(e.target.value),children:[(0,d.jsx)("option",{value:"",children:"Select country\u2026"}),s.map(e=>(0,d.jsx)("option",{value:String(e.id),children:e.name},e.id))]}),(0,d.jsx)("input",{className:"input full",placeholder:"Search schools\u2026",value:Re,onChange:e=>Ee(e.target.value),disabled:!Ae})]}),(0,d.jsx)("div",{style:{marginTop:12},children:Ae?0===Fe.length?(0,d.jsx)("div",{children:"No schools in this country yet. Create a school to assign principals."}):0===Je.length?(0,d.jsx)("div",{children:"No schools match your search."}):Je.map(e=>{const s=String(e.id)===String(Ue);return(0,d.jsx)("div",{className:"access-list-item ".concat(s?"is-selected":""),onClick:()=>Be(String(e.id)),children:(0,d.jsx)("div",{children:e.name})},e.id)}):(0,d.jsx)("div",{children:"Select a country to view schools and assign principals."})})]}),(0,d.jsx)("div",{className:"right-pane",children:!Ue&&(0,d.jsx)("div",{style:{padding:16},children:"Select a school to manage principal assignments."})}),Ue&&(0,d.jsx)(g,{show:!!Ue,school:Fe.find(e=>String(e.id)===String(Ue)),users:u,countryId:Ae,onClose:()=>Be(null),onSaved:async(e,s)=>{}})]})]}),"users"===ne&&R&&Ye&&(0,d.jsx)("div",{className:"permissions-sticky-footer",children:(0,d.jsx)("div",{className:"permissions-sticky-footer-inner",children:(0,d.jsxs)("div",{className:"permissions-footer-actions",children:[(0,d.jsx)("button",{className:"btn",onClick:function(){q((0,r.A)({},D)),K((0,r.A)({},z)),B(P),H(W||"")},disabled:ee||J,children:"Discard"}),(0,d.jsx)("button",{className:"btn primary",onClick:async function(){const e=u.find(e=>String(e.id)===String(R));if(!e)return void a.oR.error("Select a user");const s=(M||"")!==(W||""),n=U!==P;let t=!1;const l=new Set([...Object.keys(D||{}),...Object.keys(T||{})]);for(const r of l){if(!!T[r]!==!!D[r]){t=!0;break}if((O[r]||null)!==(z[r]||null)){t=!0;break}}let o=[];if(t){const e=M&&""!==M?Number(M):null;o=[],Object.keys(T||{}).forEach(s=>{if(!T[s])return;const[n,r]=s.split("|");let t=O[s]||"country",i=null,l=null;if("country"===t)i=e;else if(t.startsWith("school:")){const s=t.split(":")[1],n=Number(s);Number.isFinite(n)&&(l=n),i=e}o.push({resource:n,action:r,scope_country_id:i,scope_school_id:l})})}se(!0);try{if(s){const s=M?Number(M):null;await i.FH.assignUserCountry(e.id,{country_id:s})}n&&await i.FH.adminUpdateUserRole(e.id,{role:U}),t&&await i.FH.adminSetUserPermissions(e.id,{permissions:o}),a.oR.success("Saved"),await Pe(),await We({id:e.id,role:U,country_id:M?Number(M):null}),L(U),I(M||""),G((0,r.A)({},T)),V((0,r.A)({},O))}catch(c){console.error(c),a.oR.error((null===c||void 0===c?void 0:c.message)||"Save failed")}finally{se(!1)}},disabled:ee||J,children:ee?"Saving\u2026":"Save changes"})]})})}),Ne&&(0,d.jsx)(h,{show:Ne,onClose:()=>Se(!1),onCreated:()=>{Pe(),He()},countries:s}),Ce&&(0,d.jsx)(p,{show:Ce,onClose:()=>we(!1),onCreated:e=>{String(e)===String(Ae)&&Le(e),He()},countries:s})]})}},1998(e,s,n){n.d(s,{F2:()=>c,al:()=>a,dq:()=>d,te:()=>o});var r=n(2555),t=n(2532),i=n(7559);const l={staleTime:6e4};function a(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,t.I)((0,r.A)((0,r.A)({queryKey:["countries"],queryFn:()=>i.FH.listCountries()},l),e))}function o(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,t.I)((0,r.A)((0,r.A)({queryKey:["schools",e],queryFn:()=>i.FH.listSchools(e)},l),s))}function c(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,t.I)((0,r.A)((0,r.A)({queryKey:["adminUsers",e],queryFn:()=>i.FH.listUsers(e)},l),s))}function d(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,t.I)((0,r.A)((0,r.A)({queryKey:["managerUsers",e],queryFn:()=>i.FH.managerListUsers(e)},l),s))}}}]);
//# sourceMappingURL=292.ae9fb690.chunk.js.map