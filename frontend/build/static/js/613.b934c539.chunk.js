"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[613],{613(e,s,l){l.d(s,{A:()=>k});var i,a=l(2555),n=l(5043),t=l(7950),r=l(5685),o=l(2115),c=l(7559),d=l(3182),u=l(4405),m=l(3492),h=l(4930),p=l(579);const v=["y1","y2","y3"],x=["temel_bilgiler","kapasite","norm.ders_dagilimi","ik.local_staff","gelirler.unit_fee","giderler.isletme"],g={temel_bilgiler:"Temel Bilgiler",kapasite:"Kapasite","norm.ders_dagilimi":"Norm","ik.local_staff":"\u0130K","gelirler.unit_fee":"Gelirler","giderler.isletme":"Giderler"},y=(null===(i=h.b[0])||void 0===i?void 0:i.key)||"users",j=e=>h.b.some(s=>s.key===e),b=e=>{if(!e)return null;const s=new URLSearchParams(e).get("tab");return j(s)?s:null},f=e=>{const s=Number(e);return Number.isFinite(s)?s.toLocaleString(void 0,{maximumFractionDigits:0}):"-"},N=e=>{const s=Number(e);return Number.isFinite(s)?(100*s).toLocaleString(void 0,{maximumFractionDigits:2})+"%":"-"},S=e=>{if(!e)return"-";const s=new Date(e);return Number.isFinite(s.getTime())?s.toLocaleString():"-"},w=["Magis Basari Bursu","Maarif Yetenek Bursu","Ihtiyac Bursu","Okul Basari Bursu","Tam Egitim Bursu","Barinma Bursu","Turkce Basari Bursu","Uluslararasi Yukumluluk Indirimi","Vakif Calisani Indirimi","Kardes Indirimi","Erken Kayit Indirimi","Pesin Odeme Indirimi","Kademe Gecis Indirimi","Temsil Indirimi","Kurum Indirimi","Istisnai Indirim","Yerel Mevzuat Indirimi"];function C(e){const s=(0,m.bO)(),l=e&&"object"===typeof e?e:{},i=l.sections&&"object"===typeof l.sections?l.sections:{},a={version:s.version,sections:{}};return Object.keys(s.sections).forEach(e=>{const l=s.sections[e]||{},n=i[e]&&"object"===typeof i[e]?i[e]:{};a.sections[e]={enabled:"boolean"===typeof n.enabled?n.enabled:!1!==l.enabled,mode:"string"===typeof n.mode&&n.mode?n.mode:l.mode,min:null!=n.min?Number(n.min):l.min,selectedFields:n.selectedFields&&"object"===typeof n.selectedFields?n.selectedFields:{}}}),a}function k(){var e,s,l,i,h,k,_,A,R,F,T,I;let{forcedTab:E=null}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const B=(0,d.A)(),L=(0,r.KC)(),U=(0,r.zy)(),M=j(E)?E:null,[P,W]=(0,n.useState)(()=>{if(M)return M;const e=b(U.search);if(e)return e;try{const e=localStorage.getItem("admin.activeTab");if(j(e))return e}catch(s){}return y});(0,n.useEffect)(()=>{if(M)return;const e=b(U.search);e&&e!==P?W(e):e||P===y||W(y)},[U.search,P,M]),(0,n.useEffect)(()=>{M&&P!==M&&W(M)},[M,P]),(0,n.useEffect)(()=>{if(!M)try{localStorage.setItem("admin.activeTab",P)}catch(e){}},[P,M]);const[H,q]=(0,n.useState)([]),[Y,K]=(0,n.useState)([]),[D,O]=(0,n.useState)(!1),[z,G]=(0,n.useState)(!1),[J,Q]=(0,n.useState)(null),[V,X]=(0,n.useState)(null),[Z,$]=(0,n.useState)(null),[ee,se]=(0,n.useState)(null),[le,ie]=(0,n.useState)(null),[ae,ne]=(0,n.useState)(""),[te,re]=(0,n.useState)(""),[oe,ce]=(0,n.useState)(""),[de,ue]=(0,n.useState)(""),[me,he]=(0,n.useState)(""),[pe,ve]=(0,n.useState)(""),[xe,ge]=(0,n.useState)("user"),[ye,je]=(0,n.useState)(""),[be,fe]=(0,n.useState)(""),[Ne,Se]=(0,n.useState)(""),[we,Ce]=(0,n.useState)(!0),[ke,_e]=(0,n.useState)(""),[Ae,Re]=(0,n.useState)([]),[Fe,Te]=(0,n.useState)(!1),[Ie,Ee]=(0,n.useState)(""),[Be,Le]=(0,n.useState)(""),[Ue,Me]=(0,n.useState)(!1),[Pe,We]=(0,n.useState)(null),[He,qe]=(0,n.useState)({}),[Ye,Ke]=(0,n.useState)(""),[De,Oe]=(0,n.useState)(null),[ze,Ge]=(0,n.useState)(!1),[Je,Qe]=(0,n.useState)(!1),[Ve,Xe]=(0,n.useState)(""),[Ze,$e]=(0,n.useState)(()=>new Set),[es,ss]=(0,n.useState)(""),[ls,is]=(0,n.useState)(!1),[as,ns]=(0,n.useState)({}),[ts,rs]=(0,n.useState)(new Set),[os,cs]=(0,n.useState)(new Set),[ds,us]=(0,n.useState)([]),[ms,hs]=(0,n.useState)(null),[ps,vs]=(0,n.useState)({}),[xs,gs]=(0,n.useState)({}),[ys,js]=(0,n.useState)(!1),[bs,fs]=(0,n.useState)(!1),[Ns,Ss]=(0,n.useState)([]),ws=(0,n.useMemo)(()=>[{value:"user",label:"User"},{value:"principal",label:"Principal"},{value:"hr",label:"HR"},{value:"manager",label:"Manager"},{value:"accountant",label:"Accountant"},{value:"admin",label:"Admin"}],[]),[Cs,ks]=(0,n.useState)(!1),[_s,As]=(0,n.useState)({}),[Rs,Fs]=(0,n.useState)({}),[Ts,Is]=(0,n.useState)({}),[Es,Bs]=(0,n.useState)(!1),[Ls,Us]=(0,n.useState)({status:"",academicYear:"",region:"",countryId:""}),[Ms,Ps]=(0,n.useState)({key:null,dir:null}),[Ws,Hs]=(0,n.useState)(null),[qs,Ys]=(0,n.useState)(""),[Ks,Ds]=(0,n.useState)({y1:!0,y2:!0,y3:!0}),[Os,zs]=(0,n.useState)(()=>{const e={};return x.forEach(s=>e[s]=!1),e}),Gs=(0,n.useCallback)(()=>{const e={};x.forEach(s=>e[s]=!0),zs(e)},[]),Js=(0,n.useCallback)(()=>{const e={};x.forEach(s=>e[s]=!1),zs(e)},[]),[Qs,Vs]=(0,n.useState)(!1),[Xs,Zs]=(0,n.useState)(""),[$s,el]=(0,n.useState)(null),[sl,ll]=(0,n.useState)(!1),[il,al]=(0,n.useState)(!1),nl=(0,n.useRef)(null),[tl,rl]=(0,n.useState)(new Set),[ol,cl]=(0,n.useState)(new Set);(0,n.useEffect)(()=>{document.title="Admin \xb7 Feasibility Studio"},[]),(0,n.useEffect)(()=>(null===L||void 0===L||L.setHeaderMeta({title:"Admin",subtitle:"Create users, manage countries, and review scenarios."}),()=>{var e;null===L||void 0===L||null===(e=L.clearHeaderMeta)||void 0===e||e.call(L)}),[L]);const dl=(0,n.useRef)(Ls);(0,n.useEffect)(()=>{dl.current=Ls},[Ls]);const ul=(0,n.useMemo)(()=>Y.find(e=>String(e.id)===String(be))||null,[Y,be]),ml=(0,n.useMemo)(()=>H.find(e=>String(e.id)===String(Ne))||null,[H,Ne]),hl=(0,n.useMemo)(()=>H.find(e=>String(e.id)===String(ke))||null,[H,ke]);(0,n.useEffect)(()=>{"countries"===P&&Array.isArray(Ae)&&0!==Ae.length&&Ae.forEach(e=>{const s=e.id;void 0===_s[s]&&(async()=>{try{const e=await c.FH.adminGetSchoolPrincipals(s);As(l=>(0,a.A)((0,a.A)({},l),{},{[s]:Array.isArray(e)?e:[]}));const l=Array.isArray(e)?e.map(e=>e.id):[];Fs(e=>(0,a.A)((0,a.A)({},e),{},{[s]:l}))}catch(e){console.error(e)}})()})},[P,Ae,_s]),(0,n.useEffect)(()=>{const e=null===ul||void 0===ul?void 0:ul.id,s=null===ul||void 0===ul?void 0:ul.country_id;if(!e)return hs(null),vs({}),gs({}),void Ss([]);js(!0),Promise.all([c.FH.adminGetPermissionsCatalog(),c.FH.adminGetUserPermissions(e),s?c.FH.adminListCountrySchools(s):Promise.resolve([])]).then(e=>{let[s,l,i]=e;hs(s||null);let a=[];Array.isArray(i)?a=i:i&&Array.isArray(i.items)&&(a=i.items),Ss(a);const n={},t={};(l||[]).forEach(e=>{const s="".concat(e.resource,"|").concat(e.action);n[s]=!0,null!=e.scope_school_id?t[s]="school:".concat(e.scope_school_id):t[s]="country"}),vs(n),gs(t)}).catch(e=>{console.error(e),o.oR.error((null===e||void 0===e?void 0:e.message)||"Failed to load permissions")}).finally(()=>{js(!1)})},[ul]);const pl=(0,n.useMemo)(()=>({discounts:w.map(e=>({name:e,ratio:0,value:0}))}),[]),vl=(0,n.useMemo)(()=>(0,m.Rn)({inputs:pl,norm:null}),[pl]),xl=(0,n.useMemo)(()=>C(De),[De]),gl=ul&&ml&&null!=ul.country_id&&String(ul.country_id)===String(ml.id),yl=ul?ul.country_name?"".concat(ul.country_name," (").concat(ul.country_code,")").concat(ul.region?" - ".concat(ul.region):""):"Unassigned":"Select a user",jl=ml?"".concat(ml.name," (").concat(ml.code,")").concat(ml.region?" - ".concat(ml.region):""):"Select a country",bl=null!=(null===ul||void 0===ul?void 0:ul.country_id)?"Update Country":"Assign Country",fl=(0,n.useMemo)(()=>we?Y.filter(e=>null==e.country_id):Y,[Y,we]),Nl=(0,n.useMemo)(()=>{const e=new Set;return H.forEach(s=>{s.region&&e.add(s.region)}),Array.from(e).sort()},[H]),Sl=(0,n.useMemo)(()=>ms?Array.isArray(ms)||"object"!==typeof ms?Array.isArray(ms)?ms.reduce((e,s)=>{const l=s.group||"Other";return e[l]||(e[l]=[]),e[l].push(s),e},{}):{}:ms:{},[ms]),wl=(0,n.useMemo)(()=>Ls.region?H.filter(e=>e.region===Ls.region):H,[H,Ls.region]),Cl=(0,n.useCallback)(e=>{const s={academic_year:["desc","asc",null],country_name:["asc","desc",null],school_name:["asc","desc",null],scenario_name:["asc","desc",null],submitted_at:["desc","asc",null],status:["asc","desc",null]};Ps(l=>{const i=s[e]||["asc","desc",null];if(l.key!==e)return{key:e,dir:i[0]};const a=i.indexOf(l.dir),n=i[(a+1)%i.length];return n?{key:e,dir:n}:{key:null,dir:null}})},[Ps]),kl=(0,n.useCallback)(e=>Ms.key===e&&Ms.dir?"asc"===Ms.dir?"\u25b2":"\u25bc":"",[Ms]),_l=(0,n.useCallback)(e=>Ms.key===e&&Ms.dir?"asc"===Ms.dir?"ascending":"descending":"none",[Ms]),Al=(0,n.useMemo)(()=>{const e=Array.isArray(ds)?ds:[];if(null===Ms||void 0===Ms||!Ms.key||null===Ms||void 0===Ms||!Ms.dir)return e;const s=e=>{var s,l,i,a,n,t;switch(Ms.key){case"country_name":return String((null===(s=e.country)||void 0===s?void 0:s.name)||"");case"school_name":return String((null===(l=e.school)||void 0===l?void 0:l.name)||"");case"scenario_name":return String((null===(i=e.scenario)||void 0===i?void 0:i.name)||"");case"academic_year":return(e=>{const s=String(e||"").trim(),l=s.match(/\d{4}/g)||[],i=l[0]?Number(l[0]):-1;return{a:i,b:l[1]?Number(l[1]):i,raw:s.toLowerCase()}})(null===(a=e.scenario)||void 0===a?void 0:a.academic_year);case"submitted_at":return null!==(n=e.scenario)&&void 0!==n&&n.submitted_at?new Date(e.scenario.submitted_at).getTime():-1/0;case"status":return String((null===(t=e.scenario)||void 0===t?void 0:t.status)||"");default:return""}},l="desc"===Ms.dir?-1:1,i=(e,s)=>String(e||"").localeCompare(String(s||""),void 0,{sensitivity:"base"}),a=e.map((e,l)=>({row:e,idx:l,val:s(e)}));return a.sort((e,s)=>{let a=0;const n=e.val,t=s.val;var r,o,c,d;"academic_year"===Ms.key?(a=(null!==(r=null===n||void 0===n?void 0:n.a)&&void 0!==r?r:-1)-(null!==(o=null===t||void 0===t?void 0:t.a)&&void 0!==o?o:-1),0===a&&(a=(null!==(c=null===n||void 0===n?void 0:n.b)&&void 0!==c?c:-1)-(null!==(d=null===t||void 0===t?void 0:t.b)&&void 0!==d?d:-1)),0===a&&(a=i(null===n||void 0===n?void 0:n.raw,null===t||void 0===t?void 0:t.raw))):a="number"===typeof n&&"number"===typeof t?n-t:i(n,t);return 0===a?e.idx-s.idx:a*l}),a.map(e=>e.row)},[ds,Ms]),Rl=Ve.trim().toLowerCase(),Fl=(0,n.useMemo)(()=>{const e=es.trim().toLowerCase();return e?H.filter(s=>{const l=String(s.name||"").toLowerCase(),i=String(s.code||"").toLowerCase();return l.includes(e)||i.includes(e)}):H},[H,es]),Tl=Ze.size,Il=!Ye||0===Tl||Je||ze||ls,El=(0,n.useMemo)(()=>{const e=Ie.trim().toLowerCase();return e?Ae.filter(s=>String(s.name||"").toLowerCase().includes(e)):Ae},[Ae,Ie]),Bl=(0,n.useCallback)(async()=>{O(!0);try{const[e,s]=await Promise.all([c.FH.listCountries(),c.FH.listUsers({limit:50,offset:0,fields:"brief",order:"id:desc"})]);q(e),K(Array.isArray(null===s||void 0===s?void 0:s.items)?s.items:[])}catch(e){o.oR.error(e.message||"Failed to load admin data")}finally{O(!1)}},[]),Ll=(0,n.useCallback)(async e=>{const s=Number(e);if(Number.isFinite(s)){Te(!0);try{const e=await c.FH.adminListCountrySchools(s,{includeClosed:1});Re(Array.isArray(e)?e:[])}catch(l){o.oR.error(l.message||"Failed to load schools")}finally{Te(!1)}}else Re([])},[]),Ul=(0,n.useCallback)(async e=>{const s=Number(e);if(Number.isFinite(s)){Ge(!0);try{const e=await c.FH.adminGetProgressRequirements(s);Oe(C((null===e||void 0===e?void 0:e.config)||e))}catch(l){o.oR.error(l.message||"Failed to load progress requirements"),Oe(C(null))}finally{Ge(!1)}}else Oe(null)},[]),Ml=(0,n.useCallback)(async e=>{const s=e||dl.current||{};Bs(!0);try{const e={status:s.status,academicYear:s.academicYear,region:s.region,countryId:s.countryId},l=await c.FH.adminGetScenarioQueue(e);us(Array.isArray(l)?l:[])}catch(l){o.oR.error(l.message||"Failed to load approvals queue")}finally{Bs(!1)}},[]),Pl=(0,n.useCallback)(async e=>{const s=(null!==e&&void 0!==e?e:Xs).trim();if(s){ll(!0);try{const e=await c.FH.adminGetRollup({academicYear:s});el(e)}catch(l){o.oR.error(l.message||"Failed to load rollup report")}finally{ll(!1)}}else o.oR.error("Academic year is required")},[Xs]);async function Wl(e){const s=function(){try{const l=["token","auth_token","jwt","access_token"];for(const i of l){var e,s;const l=null===(e=window)||void 0===e||null===(s=e.localStorage)||void 0===s?void 0:s.getItem(i);if(l)return String(l)}}catch(l){}return""}(),l=await fetch("/api/admin/users/".concat(e,"/reset-password"),{method:"POST",headers:(0,a.A)({"Content-Type":"application/json"},s?{Authorization:"Bearer ".concat(s)}:{}),body:JSON.stringify({})});let i={};try{i=await l.json()}catch(r){i={}}if(!l.ok){var n,t;const e=(null===(n=i)||void 0===n?void 0:n.error)||(null===(t=i)||void 0===t?void 0:t.details)||"Reset failed (".concat(l.status,")");throw new Error(e)}return i}(0,n.useEffect)(()=>{var e;"admin"===(null===(e=B.user)||void 0===e?void 0:e.role)&&Bl()},[null===(e=B.user)||void 0===e?void 0:e.role,Bl]),(0,n.useEffect)(()=>{var e;"approvals"===P&&"admin"===(null===(e=B.user)||void 0===e?void 0:e.role)&&Ml()},[P,null===(s=B.user)||void 0===s?void 0:s.role,Ml]),(0,n.useEffect)(()=>{"countries"===P&&(ke?Ll(ke):Re([]))},[P,Ll,ke]),(0,n.useEffect)(()=>{"progress"===P&&(Ye?Ul(Ye):Oe(null))},[P,Ul,Ye]),(0,n.useEffect)(()=>{Xe(""),rs(new Set),cs(new Set)},[Ye]),(0,n.useEffect)(()=>{if(!il)return;const e=e=>{const s=nl.current;s&&!s.contains(e.target)&&al(!1)},s=e=>{"Escape"===e.key&&al(!1)};return document.addEventListener("mousedown",e),document.addEventListener("keydown",s),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",s)}},[il]),(0,n.useEffect)(()=>{if(null===$s||void 0===$s||!$s.regions)return;const e=new Set,s=new Set;$s.regions.forEach(l=>{e.add(l.region),l.countries.forEach(e=>{s.add("".concat(l.region,"::").concat(e.id))})}),rl(e),cl(s)},[$s]),(0,n.useEffect)(()=>{if(!be)return void Se("");const e=Y.find(e=>String(e.id)===String(be));e&&null!=e.country_id?Se(String(e.country_id)):Se("")},[be,Y]),(0,n.useEffect)(()=>{qe({}),Ee(""),Le("")},[ke]);const Hl=(e,s)=>{Oe(l=>{var i;const a=C(l),n=structuredClone(a),t=null===(i=n.sections)||void 0===i?void 0:i[e];return t?(s(t),n):a})},ql=(e,s)=>{if(Hs({row:e,action:s}),Ys(""),Ds({y1:!0,y2:!0,y3:!0}),"revise"===s){const e={};x.forEach(s=>e[s]=!1),zs(e)}},Yl=()=>{Hs(null),Ys(""),Ds({y1:!0,y2:!0,y3:!0});const e={};x.forEach(s=>e[s]=!1),zs(e)},Kl=e=>{if(!e)return(0,p.jsx)("div",{className:"kpi-mini kpi-mini-missing",children:"Missing KPIs"});const s=e.net_ciro?e.net_result/e.net_ciro:null;return(0,p.jsxs)("div",{className:"kpi-mini",children:[(0,p.jsxs)("div",{className:"kpi-mini-row",children:[(0,p.jsx)("span",{className:"kpi-mini-label",children:"Net ciro"}),(0,p.jsx)("span",{className:"kpi-mini-value",children:f(e.net_ciro)})]}),(0,p.jsxs)("div",{className:"kpi-mini-row",children:[(0,p.jsx)("span",{className:"kpi-mini-label",children:"Net result"}),(0,p.jsx)("span",{className:"kpi-mini-value",children:f(e.net_result)})]}),(0,p.jsxs)("div",{className:"kpi-mini-row",children:[(0,p.jsx)("span",{className:"kpi-mini-label",children:"Margin"}),(0,p.jsx)("span",{className:"kpi-mini-value",children:N(s)})]})]})},Dl=e=>e?(0,p.jsxs)("div",{className:"rollup-year-cell",children:[(0,p.jsxs)("div",{className:"rollup-metric",children:[(0,p.jsx)("span",{className:"rollup-label",children:"Net ciro"}),(0,p.jsx)("span",{className:"rollup-value",children:f(e.net_ciro)})]}),(0,p.jsxs)("div",{className:"rollup-metric",children:[(0,p.jsx)("span",{className:"rollup-label",children:"Net income"}),(0,p.jsx)("span",{className:"rollup-value",children:f(e.net_income)})]}),(0,p.jsxs)("div",{className:"rollup-metric",children:[(0,p.jsx)("span",{className:"rollup-label",children:"Expenses"}),(0,p.jsx)("span",{className:"rollup-value",children:f(e.total_expenses)})]}),(0,p.jsxs)("div",{className:"rollup-metric",children:[(0,p.jsx)("span",{className:"rollup-label",children:"Net result"}),(0,p.jsx)("span",{className:"rollup-value",children:f(e.net_result)})]}),(0,p.jsxs)("div",{className:"rollup-metric",children:[(0,p.jsx)("span",{className:"rollup-label",children:"Margin"}),(0,p.jsx)("span",{className:"rollup-value",children:N(e.profitMargin)})]}),(0,p.jsxs)("div",{className:"rollup-metric",children:[(0,p.jsx)("span",{className:"rollup-label",children:"Students"}),(0,p.jsx)("span",{className:"rollup-value",children:f(e.students_total)})]})]}):(0,p.jsx)("div",{className:"rollup-year-cell is-empty",children:"-"}),Ol=()=>{if("approvals"!==P)if("progress"!==P){if("reports"!==P)return"countries"===P?(Bl(),void(ke&&Ll(ke))):void Bl();Pl(Xs)}else Ye&&Ul(Ye);else Ml(Ls)};if(!B.user)return(0,p.jsx)("div",{className:"container",children:(0,p.jsx)("div",{className:"card",children:"Loading..."})});if("admin"!==B.user.role)return(0,p.jsx)("div",{className:"container",children:(0,p.jsxs)("div",{className:"card",children:[(0,p.jsx)("div",{style:{fontWeight:700},children:"Admin only"}),(0,p.jsx)("div",{className:"small",style:{marginTop:6},children:"You do not have permission to view this page."}),(0,p.jsx)("div",{style:{marginTop:10},children:(0,p.jsx)(r.N_,{to:"/schools",children:"Back to Schools"})})]})});const zl=sl||!$s,Gl=D||Es||sl||ze,Jl=()=>(0,p.jsx)("button",{className:"btn",onClick:Ol,disabled:Gl,children:"Refresh"});return(0,p.jsxs)(p.Fragment,{children:[null!==L&&void 0!==L&&L.headerPortalEl?(0,t.createPortal)(Jl(),L.headerPortalEl):null,(0,p.jsxs)("div",{className:"container",children:[!(null!==L&&void 0!==L&&L.headerPortalEl)&&(0,p.jsxs)("div",{className:"row",style:{justifyContent:"space-between"},children:[(0,p.jsxs)("div",{children:[(0,p.jsx)("div",{style:{fontWeight:800,fontSize:20},children:"Admin"}),(0,p.jsx)("div",{className:"small",children:"Create users, manage countries, and review scenarios."})]}),Jl()]}),(0,p.jsx)(o.N9,{position:"top-right",autoClose:3500,newestOnTop:!0,closeOnClick:!0,pauseOnFocusLoss:!0,pauseOnHover:!0}),z?(0,p.jsxs)("div",{className:"modal-backdrop",role:"status","aria-live":"polite","aria-busy":"true",children:[(0,p.jsx)("style",{children:"@keyframes adminSpin{to{transform:rotate(360deg)}}"}),(0,p.jsxs)("div",{className:"card",style:{width:"min(360px, 92vw)",padding:"16px",textAlign:"center"},children:[(0,p.jsx)("div",{"aria-hidden":!0,style:{width:28,height:28,margin:"0 auto",borderRadius:"50%",border:"3px solid rgba(0,0,0,.15)",borderTopColor:"rgba(0,0,0,.75)",animation:"adminSpin .8s linear infinite"}}),(0,p.jsx)("div",{style:{fontWeight:700,marginTop:10},children:"Updating user..."}),(0,p.jsx)("div",{className:"small muted",style:{marginTop:6},children:"Please wait."})]})]}):null,J?(0,p.jsx)("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true",children:(0,p.jsxs)("div",{className:"modal",children:[(0,p.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Confirm Change"}),(0,p.jsx)("div",{className:"small",style:{marginBottom:12},children:"Change ".concat(J.email," from ").concat(J.currentLabel," to ").concat(J.nextLabel,"?")}),(0,p.jsxs)("div",{className:"row",style:{justifyContent:"flex-end"},children:[(0,p.jsx)("button",{className:"btn",onClick:()=>Q(null),disabled:z,children:"Cancel"}),(0,p.jsx)("button",{className:"btn primary",onClick:()=>{const e=J;Q(null),async function(e){if(e&&!z){G(!0);try{await c.FH.assignUserCountry(e.userId,{countryId:e.nextId}),await Bl(),o.oR.success(e.hadCountry?"User country updated":"User assigned")}catch(s){o.oR.error(s.message||"Assignment failed")}finally{G(!1)}}}(e)},disabled:z,children:z?"Updating...":"Confirm"})]})]})}):null,V?(0,p.jsx)("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true",children:(0,p.jsxs)("div",{className:"modal",children:[(0,p.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Confirm Delete"}),(0,p.jsx)("div",{className:"small",style:{marginBottom:12},children:"Delete ".concat(V.label,"? This only works if the user has no related records.")}),(0,p.jsxs)("div",{className:"row",style:{justifyContent:"flex-end"},children:[(0,p.jsx)("button",{className:"btn",onClick:()=>X(null),children:"Cancel"}),(0,p.jsx)("button",{className:"btn danger",onClick:()=>{const e=V;X(null),async function(e){if(e)try{await c.FH.deleteUser(e.id),await Bl(),o.oR.success("User deleted")}catch(s){o.oR.error(s.message||"Delete failed")}}(e)},children:"Delete"})]})]})}):null,le?(0,p.jsxs)("div",{className:"modal-backdrop",role:"status","aria-live":"polite","aria-busy":"true",children:[(0,p.jsx)("style",{children:"@keyframes adminSpin{to{transform:rotate(360deg)}}"}),(0,p.jsxs)("div",{className:"card",style:{width:"min(360px, 92vw)",padding:"16px",textAlign:"center"},children:[(0,p.jsx)("div",{"aria-hidden":!0,style:{width:28,height:28,margin:"0 auto",borderRadius:"50%",border:"3px solid rgba(0,0,0,.15)",borderTopColor:"rgba(0,0,0,.75)",animation:"adminSpin .8s linear infinite"}}),(0,p.jsx)("div",{style:{fontWeight:700,marginTop:10},children:"Resetting password..."}),(0,p.jsx)("div",{className:"small muted",style:{marginTop:6},children:"Please wait."})]})]}):null,Z?(0,p.jsx)("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true",children:(0,p.jsxs)("div",{className:"modal",children:[(0,p.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Reset Password"}),(0,p.jsx)("div",{className:"small",style:{marginBottom:12},children:"Generate a new temporary password for ".concat(Z.email,"? The user will be forced to change it on next login.")}),(0,p.jsxs)("div",{className:"row",style:{justifyContent:"flex-end"},children:[(0,p.jsx)("button",{className:"btn",onClick:()=>$(null),disabled:Boolean(le),children:"Cancel"}),(0,p.jsx)("button",{className:"btn primary",onClick:()=>{const e=Z;$(null),async function(e){if(null!==e&&void 0!==e&&e.id&&!le){ie(e.id);try{const s=await Wl(e.id);se({id:e.id,email:e.email,full_name:e.full_name||null,temporary_password:s.temporary_password}),await Bl(),o.oR.success("Temporary password generated")}catch(s){o.oR.error(s.message||"Reset failed")}finally{ie(null)}}}(e)},disabled:Boolean(le),children:"Confirm"})]})]})}):null,ee?(0,p.jsx)("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true",children:(0,p.jsxs)("div",{className:"modal",style:{maxWidth:560},children:[(0,p.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Temporary Password"}),(0,p.jsx)("div",{className:"small",style:{marginBottom:10},children:"Share this password securely with the user. It will only be shown once here."}),(0,p.jsxs)("div",{className:"card",style:{padding:12,background:"rgba(0,0,0,.03)"},children:[(0,p.jsxs)("div",{className:"small",style:{marginBottom:6},children:["User: ",(0,p.jsx)("strong",{children:ee.email})]}),(0,p.jsxs)("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between"},children:[(0,p.jsx)("div",{style:{fontFamily:"ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace",fontSize:18},children:ee.temporary_password}),(0,p.jsx)("button",{className:"btn",onClick:()=>async function(e){const s=String(e||"");if(s){try{return await navigator.clipboard.writeText(s),void o.oR.success("Copied")}catch(l){}try{const e=document.createElement("textarea");e.value=s,e.style.position="fixed",e.style.left="-9999px",document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),o.oR.success("Copied")}catch(i){o.oR.error("Copy failed")}}}(ee.temporary_password),children:"Copy"})]})]}),(0,p.jsx)("div",{className:"row",style:{justifyContent:"flex-end",marginTop:12},children:(0,p.jsx)("button",{className:"btn primary",onClick:()=>se(null),children:"Done"})})]})}):null,Ws?(0,p.jsx)("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true",children:(0,p.jsxs)("div",{className:"modal",children:[(0,p.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"approve"===Ws.action?"Approve Scenario":"Request Revision"}),(0,p.jsxs)("div",{className:"small",style:{marginBottom:12},children:[null!==(l=Ws.row)&&void 0!==l&&null!==(i=l.school)&&void 0!==i&&i.name?"".concat(Ws.row.school.name," - "):"",(null===(h=Ws.row)||void 0===h||null===(k=h.scenario)||void 0===k?void 0:k.name)||"Scenario"]}),"approve"===Ws.action?(0,p.jsxs)("div",{style:{marginBottom:10},children:[(0,p.jsx)("div",{className:"small",style:{marginBottom:6},children:"Included years"}),(0,p.jsx)("div",{className:"row",children:v.map(e=>(0,p.jsxs)("label",{className:"small",style:{display:"inline-flex",gap:6},children:[(0,p.jsx)("input",{type:"checkbox",checked:Ks[e],onChange:s=>Ds(l=>(0,a.A)((0,a.A)({},l),{},{[e]:s.target.checked}))}),e.toUpperCase()]},e))})]}):null,"revise"===Ws.action?(0,p.jsxs)("div",{style:{marginBottom:10},children:[(0,p.jsx)("div",{className:"small",style:{marginBottom:6},children:"Sadece se\xe7ilen mod\xfcller revizeye a\xe7\u0131lacak (editable)."}),(0,p.jsxs)("div",{className:"row",style:{flexWrap:"wrap",gap:8},children:[x.map(e=>(0,p.jsxs)("label",{className:"small",style:{display:"inline-flex",gap:6,alignItems:"center"},children:[(0,p.jsx)("input",{type:"checkbox",checked:Boolean(Os[e]),onChange:s=>zs(l=>(0,a.A)((0,a.A)({},l),{},{[e]:s.target.checked}))}),g[e]||e]},e)),(0,p.jsx)("button",{type:"button",className:"btn sm",onClick:Gs,children:"T\xfcm\xfcn\xfc se\xe7"}),(0,p.jsx)("button",{type:"button",className:"btn sm",onClick:Js,children:"Temizle"})]})]}):null,(0,p.jsxs)("div",{style:{marginBottom:12},children:[(0,p.jsxs)("div",{className:"small",style:{marginBottom:6},children:["Note ","revise"===Ws.action?"(required)":"(optional)"]}),(0,p.jsx)("textarea",{className:"input",style:{width:"100%",minHeight:90},value:qs,onChange:e=>Ys(e.target.value)})]}),(0,p.jsxs)("div",{className:"row",style:{justifyContent:"flex-end"},children:[(0,p.jsx)("button",{className:"btn",onClick:Yl,children:"Cancel"}),(0,p.jsx)("button",{className:"btn primary",onClick:async()=>{var e,s;if(null===Ws||void 0===Ws||null===(e=Ws.row)||void 0===e||null===(s=e.scenario)||void 0===s||!s.id)return;const l=Ws.action,i=qs.trim();if("revise"===l&&!i)return void o.oR.error("Note is required for revision requests");const a={action:l,note:i||null};if("approve"===l){const e=v.filter(e=>Ks[e]);if(!e.length)return void o.oR.error("Select at least one year");a.includedYears=e}else if("revise"===l){const e=x.filter(e=>Os[e]);if(!e.length)return void o.oR.error("Select at least one module");a.revisionWorkIds=e}Vs(!0);try{await c.FH.adminReviewScenario(Ws.row.scenario.id,a),o.oR.success("approve"===l?"Scenario approved":"Revision requested"),Yl(),await Ml()}catch(n){o.oR.error(n.message||"Review failed")}finally{Vs(!1)}},disabled:Qs,children:Qs?"Saving...":"approve"===Ws.action?"Approve":"Request Revision"})]})]})}):null,"users"===P&&(0,p.jsxs)(p.Fragment,{children:[(0,p.jsxs)("div",{style:{marginTop:12,display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(320px, 1fr))",gap:12},children:[(0,p.jsxs)("div",{className:"card",children:[(0,p.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Create User"}),(0,p.jsxs)("div",{className:"row",children:[(0,p.jsx)("input",{className:"input",placeholder:"Full name",value:de,onChange:e=>ue(e.target.value)}),(0,p.jsx)("input",{className:"input",placeholder:"Email",value:me,onChange:e=>he(e.target.value)}),(0,p.jsx)("input",{className:"input",placeholder:"Temporary password",type:"password",value:pe,onChange:e=>ve(e.target.value)}),(0,p.jsxs)("select",{className:"input sm",value:xe,onChange:e=>ge(e.target.value),children:[(0,p.jsx)("option",{value:"user",children:"User"}),(0,p.jsx)("option",{value:"admin",children:"Admin"}),(0,p.jsx)("option",{value:"principal",children:"Principal"}),(0,p.jsx)("option",{value:"hr",children:"HR"}),(0,p.jsx)("option",{value:"manager",children:"Manager"}),(0,p.jsx)("option",{value:"accountant",children:"Accountant"})]}),(0,p.jsxs)("select",{className:"input",value:ye,onChange:e=>je(e.target.value),children:[(0,p.jsx)("option",{value:"",children:"Assign country (optional)"}),H.map(e=>(0,p.jsxs)("option",{value:e.id,children:[e.name," (",e.code,")",e.region?" - ".concat(e.region):""]},e.id))]}),(0,p.jsx)("button",{className:"btn primary",onClick:async function(){const e={fullName:de.trim()||null,email:me.trim(),password:pe,role:xe};if(ye){const s=Number(ye);if(!Number.isFinite(s))return void o.oR.error("Invalid country selection");e.countryId=s}if(e.email&&e.password)if(e.password.length<8)o.oR.error("Password must be at least 8 characters");else try{await c.FH.createUser(e),ue(""),he(""),ve(""),ge("user"),je(""),await Bl(),o.oR.success("User created (password reset required on first login)")}catch(s){o.oR.error(s.message||"Create user failed")}else o.oR.error("Email and password are required")},disabled:D,children:"Create"})]}),(0,p.jsx)("div",{className:"small",style:{marginTop:8},children:"New users must reset their password on first login."})]}),(0,p.jsxs)("div",{className:"card",children:[(0,p.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Assign / Edit User Country"}),(0,p.jsx)("div",{className:"small",style:{marginBottom:6},children:ul?"Editing: ".concat(ul.email).concat(ul.full_name?" (".concat(ul.full_name,")"):""," #").concat(ul.id):"Select a user to assign or edit."}),(0,p.jsxs)("div",{className:"row",children:[(0,p.jsxs)("select",{className:"input",value:be,onChange:e=>fe(e.target.value),children:[(0,p.jsx)("option",{value:"",children:"Select user"}),Y.map(e=>(0,p.jsxs)("option",{value:e.id,children:[e.email," ",e.full_name?"(".concat(e.full_name,")"):""," #",e.id]},e.id))]}),(0,p.jsxs)("select",{className:"input",value:Ne,onChange:e=>Se(e.target.value),children:[(0,p.jsx)("option",{value:"",children:"Select country"}),H.map(e=>(0,p.jsxs)("option",{value:e.id,children:[e.name," (",e.code,") - ",e.region]},e.id))]}),(0,p.jsx)("button",{className:"btn primary",onClick:async function(){if(!ul)return void o.oR.error("Select a user");if(!Ne)return void o.oR.error("Select a country");if(z)return;const e=Number(Ne);if(Number.isFinite(e))if(gl)o.oR.error("Selected country is already assigned to this user");else{if(null!=ul.country_id){const s=ul.country_name?"".concat(ul.country_name," (").concat(ul.country_code,")"):"Unassigned",l=ml?"".concat(ml.name," (").concat(ml.code,")"):"#".concat(e);return void Q({userId:ul.id,nextId:e,email:ul.email,currentLabel:s,nextLabel:l,hadCountry:!0})}G(!0);try{await c.FH.assignUserCountry(be,{countryId:e}),await Bl(),o.oR.success("User assigned")}catch(s){o.oR.error(s.message||"Assignment failed")}finally{G(!1)}}else o.oR.error("Invalid country selection")},disabled:D||z||!be||!Ne||gl,children:z?"Updating...":bl})]}),(0,p.jsxs)("div",{className:"small",style:{marginTop:8},children:[(0,p.jsxs)("div",{children:["Current: ",yl]}),(0,p.jsxs)("div",{children:["New: ",jl]}),ul&&ml&&null!=ul.country_id&&!gl?(0,p.jsx)("div",{style:{color:"#b45309"},children:"You are changing this user's assignment."}):null,gl?(0,p.jsx)("div",{style:{color:"#6b7280"},children:"Selected country matches current assignment."}):null,"Users must re-login after assignment to refresh their token."]})]})]}),(0,p.jsxs)("div",{className:"card",children:[(0,p.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Permissions"}),ul?ys?(0,p.jsx)("div",{className:"small",children:"Loading permissions..."}):(0,p.jsxs)(p.Fragment,{children:[(0,p.jsxs)("div",{style:{marginBottom:8},children:[(0,p.jsx)("label",{className:"small",style:{marginRight:8},children:"Role:"}),(0,p.jsx)("select",{className:"input sm",value:(null===ul||void 0===ul?void 0:ul.role)||"user",onChange:e=>async function(s){if(ul){ks(!0);try{await c.FH.adminUpdateUserRole(ul.id,{role:s}),await Bl(),fe(String(ul.id)),o.oR.success("Role updated")}catch(e){o.oR.error((null===e||void 0===e?void 0:e.message)||"Failed to update role")}finally{ks(!1)}}}(e.target.value),disabled:Cs,children:ws.map(e=>(0,p.jsx)("option",{value:e.value,children:e.label},e.value))})]}),0===Object.keys(Sl).length?(0,p.jsx)("div",{className:"small",children:"No permissions defined."}):Object.entries(Sl).map(e=>{let[s,l]=e;return(0,p.jsxs)("div",{style:{marginBottom:12},children:[(0,p.jsx)("div",{style:{fontWeight:600,marginBottom:4},children:s}),l.map(e=>{const s="".concat(e.resource,"|").concat(e.action),l=Boolean(ps[s]),i=xs[s]||"country";return(0,p.jsxs)("div",{className:"row",style:{alignItems:"center",marginBottom:4},children:[(0,p.jsxs)("label",{className:"small",style:{flexGrow:1,display:"flex",alignItems:"center",gap:6},children:[(0,p.jsx)("input",{type:"checkbox",checked:l,onChange:()=>function(e){vs(s=>{const l=(0,a.A)({},s);return l[e]=!s[e],l}),gs(s=>ps[e]||s[e]?s:(0,a.A)((0,a.A)({},s),{},{[e]:"country"}))}(s)}),e.label]}),(0,p.jsxs)("select",{className:"input sm",disabled:!l,value:i,onChange:e=>function(e,s){gs(l=>(0,a.A)((0,a.A)({},l),{},{[e]:s}))}(s,e.target.value),children:[(0,p.jsx)("option",{value:"country",children:"Country"}),Ns&&Ns.map(e=>(0,p.jsx)("option",{value:"school:".concat(e.id),children:e.name},e.id))]})]},s)})]},s)}),(0,p.jsx)("div",{className:"row",style:{marginTop:8},children:(0,p.jsx)("button",{className:"btn primary",onClick:async function(){if(!ul)return void o.oR.error("Select a user to edit permissions");const e=[];Object.keys(ps||{}).forEach(s=>{if(!ps[s])return;const[l,i]=s.split("|");let a=xs[s]||"country",n=null,t=null;if("country"===a)null!=ul.country_id&&(n=Number(ul.country_id));else if(a.startsWith("school:")){const e=a.split(":")[1],s=Number(e);Number.isFinite(s)&&(t=s),null!=ul.country_id&&(n=Number(ul.country_id))}e.push({resource:l,action:i,scope_country_id:n,scope_school_id:t})}),fs(!0);try{await c.FH.adminSetUserPermissions(ul.id,{permissions:e});const s=await c.FH.adminGetUserPermissions(ul.id),l={},i={};(s||[]).forEach(e=>{const s="".concat(e.resource,"|").concat(e.action);l[s]=!0,null!=e.scope_school_id?i[s]="school:".concat(e.scope_school_id):i[s]="country"}),vs(l),gs(i),o.oR.success("Permissions saved")}catch(s){o.oR.error((null===s||void 0===s?void 0:s.message)||"Save permissions failed")}finally{fs(!1)}},disabled:bs,children:bs?"Saving...":"Save Permissions"})})]}):(0,p.jsx)("div",{className:"small",children:"Select a user above to edit permissions."})]}),(0,p.jsxs)("div",{className:"card",style:{marginTop:12},children:[(0,p.jsxs)("div",{className:"row",style:{justifyContent:"space-between"},children:[(0,p.jsx)("div",{style:{fontWeight:700},children:"Users"}),(0,p.jsxs)("label",{className:"small",children:[(0,p.jsx)("input",{type:"checkbox",checked:we,onChange:e=>Ce(e.target.checked)})," ","Unassigned only"]})]}),(0,p.jsxs)("table",{className:"table",style:{marginTop:8},children:[(0,p.jsx)("thead",{children:(0,p.jsxs)("tr",{children:[(0,p.jsx)("th",{children:"ID"}),(0,p.jsx)("th",{children:"Name"}),(0,p.jsx)("th",{children:"Email"}),(0,p.jsx)("th",{children:"Role"}),(0,p.jsx)("th",{children:"Reset"}),(0,p.jsx)("th",{children:"Country"}),(0,p.jsx)("th",{children:"Region"}),(0,p.jsx)("th",{children:"Actions"})]})}),(0,p.jsx)("tbody",{children:0===fl.length?(0,p.jsx)("tr",{children:(0,p.jsx)("td",{colSpan:"8",className:"small",children:"No users found."})}):fl.map(e=>(0,p.jsxs)("tr",{children:[(0,p.jsx)("td",{className:"small",children:e.id}),(0,p.jsx)("td",{children:e.full_name||"-"}),(0,p.jsx)("td",{children:e.email}),(0,p.jsx)("td",{className:"small",children:e.role}),(0,p.jsx)("td",{children:e.must_reset_password?(0,p.jsx)("span",{className:"badge",children:"Yes"}):(0,p.jsx)("span",{className:"small",children:"No"})}),(0,p.jsx)("td",{children:e.country_name?(0,p.jsxs)("span",{children:[e.country_name," (",e.country_code,")"]}):(0,p.jsx)("span",{className:"badge",children:"Unassigned"})}),(0,p.jsx)("td",{children:e.region||"-"}),(0,p.jsx)("td",{children:(0,p.jsxs)("div",{className:"row",children:[(0,p.jsx)("button",{className:"btn",onClick:()=>fe(String(e.id)),children:"Edit"}),(0,p.jsx)("button",{className:"btn",onClick:()=>async function(e){null!==e&&void 0!==e&&e.id&&$({id:e.id,email:e.email,full_name:e.full_name||null})}(e),disabled:Boolean(le),children:"Reset password"}),(0,p.jsx)("button",{className:"btn",onClick:()=>async function(e){if(!e||!e.id)return;const s=e.email||"User #".concat(e.id);X({id:e.id,label:s})}(e),children:"Delete"})]})})]},e.id))})]}),(0,p.jsx)("div",{className:"small",style:{marginTop:8},children:"Delete is blocked if the user has created or updated records."})]})]}),"countries"===P&&(0,p.jsxs)(p.Fragment,{children:[(0,p.jsxs)("div",{className:"card",style:{marginTop:12},children:[(0,p.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Create Country"}),(0,p.jsxs)("div",{className:"row",children:[(0,p.jsx)("input",{className:"input",placeholder:"Country name",value:ae,onChange:e=>ne(e.target.value)}),(0,p.jsx)("input",{className:"input sm",placeholder:"Code",value:te,onChange:e=>re(e.target.value.toUpperCase())}),(0,p.jsx)("input",{className:"input",placeholder:"Region",value:oe,onChange:e=>ce(e.target.value)}),(0,p.jsx)("button",{className:"btn primary",onClick:async function(){const e={name:ae.trim(),code:te.trim().toUpperCase(),region:oe.trim()};if(e.name&&e.code&&e.region)try{await c.FH.createCountry(e),ne(""),re(""),ce(""),await Bl(),o.oR.success("Country created")}catch(s){o.oR.error(s.message||"Create country failed")}else o.oR.error("Name, code, and region are required")},disabled:D,children:"Create"})]})]}),(0,p.jsxs)("div",{className:"card",style:{marginTop:12},children:[(0,p.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Countries"}),(0,p.jsxs)("table",{className:"table",children:[(0,p.jsx)("thead",{children:(0,p.jsxs)("tr",{children:[(0,p.jsx)("th",{children:"ID"}),(0,p.jsx)("th",{children:"Name"}),(0,p.jsx)("th",{children:"Code"}),(0,p.jsx)("th",{children:"Region"})]})}),(0,p.jsx)("tbody",{children:0===H.length?(0,p.jsx)("tr",{children:(0,p.jsx)("td",{colSpan:"4",className:"small",children:"No countries yet."})}):H.map(e=>(0,p.jsxs)("tr",{children:[(0,p.jsx)("td",{className:"small",children:e.id}),(0,p.jsx)("td",{children:e.name}),(0,p.jsx)("td",{className:"small",children:e.code}),(0,p.jsx)("td",{children:e.region})]},e.id))})]})]}),(0,p.jsxs)("div",{className:"card",style:{marginTop:12},children:[(0,p.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Country Schools"}),(0,p.jsxs)("div",{className:"row",style:{marginBottom:10},children:[(0,p.jsxs)("select",{className:"input",value:ke,onChange:e=>_e(e.target.value),children:[(0,p.jsx)("option",{value:"",children:"Select a country"}),H.map(e=>(0,p.jsx)("option",{value:e.id,children:e.name},e.id))]}),(0,p.jsx)("input",{className:"input",placeholder:"Search schools",value:Ie,onChange:e=>Ee(e.target.value),disabled:!ke})]}),(0,p.jsxs)("div",{className:"row",style:{marginBottom:10},children:[(0,p.jsx)("input",{className:"input",placeholder:"New school name",value:Be,onChange:e=>Le(e.target.value),disabled:!ke||Ue}),(0,p.jsx)("button",{className:"btn primary",onClick:async function(){if(!ke)return void o.oR.error("Select a country");const e=Be.trim();if(e){Me(!0);try{await c.FH.adminCreateCountrySchool(ke,{name:e}),Le(""),await Ll(ke),o.oR.success("School created")}catch(s){o.oR.error(s.message||"Create school failed")}finally{Me(!1)}}else o.oR.error("School name is required")},disabled:!ke||Ue,children:Ue?"Creating...":"Create"})]}),hl?(0,p.jsxs)("table",{className:"table",children:[(0,p.jsx)("thead",{children:(0,p.jsxs)("tr",{children:[(0,p.jsx)("th",{children:"Name"}),(0,p.jsx)("th",{children:"Status"}),(0,p.jsx)("th",{children:"Created At"}),(0,p.jsx)("th",{children:"Closed At"}),(0,p.jsx)("th",{children:"Principals"}),(0,p.jsx)("th",{children:"Actions"})]})}),(0,p.jsx)("tbody",{children:Fe?(0,p.jsx)("tr",{children:(0,p.jsx)("td",{colSpan:"6",className:"small",children:"Loading..."})}):0===El.length?(0,p.jsx)("tr",{children:(0,p.jsx)("td",{colSpan:"6",className:"small",children:"No schools found."})}):El.map(e=>{var s,l;const i="closed"===e.status?{label:"Closed",className:"is-muted"}:{label:"Active",className:"is-ok"};const n=null!==(s=null!==(l=He[e.id])&&void 0!==l?l:e.name)&&void 0!==s?s:"",t=Pe===e.id;return(0,p.jsxs)("tr",{children:[(0,p.jsx)("td",{children:e.name}),(0,p.jsx)("td",{children:(0,p.jsx)("span",{className:"status-badge ".concat(i.className),children:i.label})}),(0,p.jsx)("td",{className:"small",children:S(e.created_at)}),(0,p.jsx)("td",{className:"small",children:S(e.closed_at)}),(0,p.jsx)("td",{children:Array.isArray(_s[e.id])&&_s[e.id].length>0?(0,p.jsx)("span",{children:_s[e.id].map(e=>e.full_name||e.email).join(", ")}):(0,p.jsx)("span",{className:"small muted",children:"-"})}),(0,p.jsxs)("td",{children:[(0,p.jsxs)("div",{className:"row",children:[(0,p.jsx)("input",{className:"input sm",value:n,onChange:s=>qe(l=>(0,a.A)((0,a.A)({},l),{},{[e.id]:s.target.value})),disabled:t}),(0,p.jsx)("button",{className:"btn primary",onClick:()=>async function(e){if(null===e||void 0===e||!e.id)return;const s=He[e.id],l=String(null!=s?s:e.name||"").trim();if(l){if(l!==e.name){We(e.id);try{await c.FH.adminUpdateSchool(e.id,{name:l}),await Ll(ke),qe(s=>(0,a.A)((0,a.A)({},s),{},{[e.id]:l})),o.oR.success("School updated")}catch(i){o.oR.error(i.message||"Update failed")}finally{We(null)}}}else o.oR.error("Name is required")}(e),disabled:t,children:"Save"}),(0,p.jsx)("button",{className:"btn",onClick:()=>async function(e){if(null===e||void 0===e||!e.id)return;const s="closed"===e.status?"active":"closed";We(e.id);try{await c.FH.adminUpdateSchool(e.id,{status:s}),await Ll(ke),o.oR.success("closed"===s?"School closed":"School reopened")}catch(l){o.oR.error(l.message||"Update failed")}finally{We(null)}}(e),disabled:t,children:"closed"===e.status?"Reopen":"Close"})]}),(0,p.jsxs)("div",{className:"row",style:{marginTop:4},children:[(0,p.jsx)("select",{multiple:!0,className:"input sm",value:(Rs[e.id]||[]).map(String),onChange:s=>{const l=Array.from(s.target.selectedOptions||[]).map(e=>e.value);!function(e,s){const l=s.map(e=>Number(e)).filter(e=>Number.isFinite(e));Fs(s=>(0,a.A)((0,a.A)({},s),{},{[e]:l}))}(e.id,l)},children:Y.filter(e=>"principal"===e.role).map(e=>(0,p.jsxs)("option",{value:e.id,children:[e.email," ",e.full_name?"(".concat(e.full_name,")"):""," #",e.id]},e.id))}),(0,p.jsx)("button",{className:"btn",onClick:()=>async function(e){const s=Rs[e]||[];Is(s=>(0,a.A)((0,a.A)({},s),{},{[e]:!0}));try{await c.FH.adminSetSchoolPrincipals(e,{userIds:s});const l=Y.filter(e=>"principal"===e.role&&s.includes(e.id));As(s=>(0,a.A)((0,a.A)({},s),{},{[e]:l})),o.oR.success("Principals updated")}catch(l){o.oR.error((null===l||void 0===l?void 0:l.message)||"Failed to update principals")}finally{Is(s=>(0,a.A)((0,a.A)({},s),{},{[e]:!1}))}}(e.id),disabled:Boolean(Ts[e.id]),children:Ts[e.id]?"Saving...":"Save"})]})]})]},e.id)})})]}):(0,p.jsx)("div",{className:"small",children:"Select a country to manage its schools."})]})]}),"progress"===P&&(0,p.jsxs)("div",{style:{marginTop:12},children:[(0,p.jsx)("div",{className:"card",children:(0,p.jsxs)("div",{className:"row",style:{justifyContent:"space-between",alignItems:"center"},children:[(0,p.jsxs)("div",{children:[(0,p.jsx)("div",{style:{fontWeight:700},children:"Progress Tracking"}),(0,p.jsx)("div",{className:"small",children:"Configure per-field requirements by country."})]}),(0,p.jsxs)("div",{className:"row",children:[(0,p.jsxs)("select",{className:"input sm",value:Ye,onChange:e=>Ke(e.target.value),children:[(0,p.jsx)("option",{value:"",children:"Select country"}),H.map(e=>(0,p.jsx)("option",{value:e.id,children:e.name},e.id))]}),(0,p.jsx)("input",{className:"input sm",placeholder:"Search fields",value:Ve,onChange:e=>Xe(e.target.value)}),(0,p.jsx)("button",{className:"btn primary",onClick:async()=>{if(Ye){Qe(!0);try{const e=await c.FH.adminSaveProgressRequirements(Ye,xl);Oe(C((null===e||void 0===e?void 0:e.config)||e)),o.oR.success("Progress requirements saved")}catch(e){o.oR.error(e.message||"Failed to save progress requirements")}finally{Qe(!1)}}else o.oR.error("Select a country")},disabled:!Ye||Je||ze,children:Je?"Saving...":"Save"})]})]})}),(0,p.jsxs)("div",{className:"card",style:{marginTop:12},children:[(0,p.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Apply to multiple countries"}),(0,p.jsxs)("div",{className:"row",style:{alignItems:"center",flexWrap:"wrap",marginBottom:10},children:[(0,p.jsx)("input",{className:"input sm",placeholder:"Search countries",value:es,onChange:e=>ss(e.target.value)}),(0,p.jsx)("button",{className:"btn",onClick:()=>{$e(e=>{const s=new Set(e);return Fl.forEach(e=>{const l=Number(e.id);Number.isFinite(l)&&s.add(l)}),s})},disabled:0===Fl.length||ls,children:"Select all"}),(0,p.jsx)("button",{className:"btn",onClick:()=>{$e(new Set)},disabled:0===Tl||ls,children:"Clear"}),(0,p.jsx)("button",{className:"btn primary",onClick:async()=>{const e=Array.from(Ze).map(e=>Number(e)).filter(e=>Number.isFinite(e)),s=Array.from(new Set(e));if(!s.length)return void o.oR.error("Select at least one country");if(!Ye)return void o.oR.error("Select a country to edit rules first");if(window.confirm("Apply this configuration to ".concat(s.length," countries? This will overwrite their current rules."))){is(!0);try{const e=await c.FH.adminBulkSaveProgressRequirements(s,xl),l=Number.isFinite(Number(null===e||void 0===e?void 0:e.updatedCount))?Number(e.updatedCount):s.length;o.oR.success("Applied to ".concat(l," countries")),s.some(e=>String(e)===String(Ye))&&await Ul(Ye)}catch(l){o.oR.error(l.message||"Failed to apply progress requirements")}finally{is(!1)}}},disabled:Il,children:ls?"Applying...":"Apply to Selected (".concat(Tl,")")})]}),(0,p.jsx)("div",{style:{border:"1px solid #e5e7eb",borderRadius:10,padding:10,background:"#fff",maxHeight:240,overflowY:"auto"},children:0===Fl.length?(0,p.jsx)("div",{className:"small",children:"No countries found."}):Fl.map(e=>{const s=Number(e.id),l=Ze.has(s);return(0,p.jsxs)("label",{style:{display:"flex",gap:8,alignItems:"center",padding:"6px 0"},children:[(0,p.jsx)("input",{type:"checkbox",checked:l,onChange:()=>(e=>{const s=Number(e);Number.isFinite(s)&&$e(e=>{const l=new Set(e);return l.has(s)?l.delete(s):l.add(s),l})})(s)}),(0,p.jsx)("span",{children:e.name||"-"})]},e.id)})})]}),Ye?(0,p.jsx)("div",{className:"card",style:{marginTop:12},children:ze?(0,p.jsx)("div",{className:"small",children:"Loading..."}):(0,p.jsx)("div",{style:{display:"grid",gap:12},children:vl.tabs.map(e=>{const s=vl.sections.filter(s=>s.tabKey===e.key),l=s.filter(e=>{if(!Rl)return!0;const s=String(e.label||"").toLowerCase().includes(Rl),l=(e.fields||[]).map(e=>vl.fieldsById[e]).filter(Boolean).some(e=>{const s=String(e.label||"").toLowerCase(),l=String(e.id||"").toLowerCase();return s.includes(Rl)||l.includes(Rl)});return s||l});if(!l.length)return null;const i=ts.has(e.key)||Boolean(Rl);return(0,p.jsxs)("div",{style:{border:"1px solid #e5e7eb",borderRadius:10,padding:10},children:[(0,p.jsxs)("div",{className:"row",style:{justifyContent:"space-between"},children:[(0,p.jsxs)("div",{className:"row",children:[(0,p.jsx)("button",{type:"button",className:"btn",onClick:()=>{return s=e.key,void rs(e=>{const l=new Set(e);return l.has(s)?l.delete(s):l.add(s),l});var s},children:i?"-":"+"}),(0,p.jsx)("div",{style:{fontWeight:700},children:e.label})]}),(0,p.jsxs)("div",{className:"small",children:[s.length," sections"]})]}),i?(0,p.jsx)("div",{style:{display:"grid",gap:10,marginTop:10},children:l.map(e=>{var s;const l=(null===(s=xl.sections)||void 0===s?void 0:s[e.id])||{},i=!1!==l.enabled,n=String(l.mode||e.modeDefault||"ALL").toUpperCase(),t=Number.isFinite(Number(l.min))&&Number(l.min)>0?Number(l.min):e.minDefault||1,r=(e.fields||[]).map(e=>vl.fieldsById[e]).filter(Boolean),o=Rl?r.filter(e=>{const s=String(e.label||"").toLowerCase(),l=String(e.id||"").toLowerCase();return s.includes(Rl)||l.includes(Rl)}):r;if(!o.length&&Rl)return null;const c=os.has(e.id)||Boolean(Rl),d=(Rl?o:r).map(e=>e.id),u=r.filter(e=>{var s;return!1!==(null===(s=l.selectedFields)||void 0===s?void 0:s[e.id])}).length,m=r.length,h=Boolean(as[e.id]),v=h?o.filter(e=>{var s;return!1!==(null===(s=l.selectedFields)||void 0===s?void 0:s[e.id])}):o,x="MIN"===n?t:null,g="MIN"===n&&x>u,y="ALL"===n?"\u2705 Rule: Must complete ALL selected fields (".concat(u," selected)"):g?"\u26a0\ufe0f MIN (".concat(x,") is greater than selected (").concat(u,"). It will behave like ALL."):"\u2705 Rule: Must complete AT LEAST ".concat(x," of ").concat(u," selected fields"),j="MIN"===n?x:u;return(0,p.jsxs)("div",{style:{borderTop:"1px solid #eef2f7",paddingTop:10},children:[(0,p.jsxs)("div",{className:"row",style:{justifyContent:"space-between",alignItems:"center"},children:[(0,p.jsxs)("div",{className:"row",children:[(0,p.jsx)("button",{type:"button",className:"btn",onClick:()=>{return s=e.id,void cs(e=>{const l=new Set(e);return l.has(s)?l.delete(s):l.add(s),l});var s},children:c?"-":"+"}),(0,p.jsx)("div",{style:{fontWeight:700},children:e.label}),(0,p.jsx)("span",{className:"status-badge ".concat(i?"is-ok":"is-muted"),children:i?"Enabled":"Disabled"}),(0,p.jsxs)("span",{className:"small",children:[u,"/",r.length||0," selected"]})]}),(0,p.jsxs)("div",{className:"row",children:[(0,p.jsxs)("label",{className:"small",children:[(0,p.jsx)("input",{type:"checkbox",checked:h,onChange:()=>ns(s=>(0,a.A)((0,a.A)({},s),{},{[e.id]:!(null!==s&&void 0!==s&&s[e.id])}))})," ","Show only selected"]}),(0,p.jsxs)("label",{className:"small",children:[(0,p.jsx)("input",{type:"checkbox",checked:i,onChange:s=>{return l=e.id,i=s.target.checked,void Hl(l,e=>{e.enabled=!!i});var l,i}})," ","Enabled"]}),(0,p.jsxs)("select",{className:"input xs",value:n,onChange:s=>{return l=e.id,i=s.target.value,void Hl(l,e=>{e.mode=i});var l,i},children:[(0,p.jsx)("option",{value:"ALL",children:"ALL"}),(0,p.jsx)("option",{value:"MIN",children:"MIN"})]}),"MIN"===n?(0,p.jsx)("input",{className:"input xs",type:"number",min:"1",value:t,onChange:s=>((e,s)=>{const l=Number(s);Hl(e,e=>{e.min=Number.isFinite(l)?Math.max(1,l):1})})(e.id,s.target.value)}):null,(0,p.jsx)("button",{className:"btn",onClick:()=>{return s=e.id,l=d,void Hl(s,e=>{e.selectedFields||(e.selectedFields={}),l.forEach(s=>{e.selectedFields&&delete e.selectedFields[s]})});var s,l},disabled:!d.length,children:"Select all"}),(0,p.jsx)("button",{className:"btn",onClick:()=>{return s=e.id,l=d,void Hl(s,e=>{e.selectedFields||(e.selectedFields={}),l.forEach(s=>{e.selectedFields&&(e.selectedFields[s]=!1)})});var s,l},disabled:!d.length,children:"Unselect all"})]})]}),(0,p.jsx)("div",{className:"small",style:{marginTop:6},children:y}),(0,p.jsxs)("div",{className:"small",style:{marginTop:4,color:"#6b7280"},children:["Selected: ",u,"/",m," \xb7 Mode: ",n," \xb7 Required: ",j]}),c?(0,p.jsx)("div",{style:{marginTop:8},children:v.length?(0,p.jsx)("div",{className:"grid2",style:{gap:8},children:v.map(s=>{var a;const n=!1!==(null===(a=l.selectedFields)||void 0===a?void 0:a[s.id]),t=((e,s)=>{if(!s)return null;const l=String(s.id||""),i=String(s.label||"");return"gradesPlan.plan"===e&&(l.startsWith("gradesPlan.")||i.includes("Plan "))?"grade":"ik.localStaff"===e&&l.startsWith("ik.headcount.")||"gelirler.unitFee"===e&&l.startsWith("gelirler.tuition.")?"type":null})(e.id,s);return(0,p.jsxs)("label",{className:"small",style:{display:"flex",gap:8,alignItems:"center",justifyContent:"space-between",width:"100%"},children:[(0,p.jsxs)("span",{style:{display:"inline-flex",gap:8,alignItems:"center"},children:[(0,p.jsx)("input",{type:"checkbox",checked:n,onChange:l=>((e,s,l)=>{Hl(e,e=>{e.selectedFields||(e.selectedFields={}),l?delete e.selectedFields[s]:e.selectedFields[s]=!1})})(e.id,s.id,l.target.checked),disabled:!i}),(0,p.jsx)("span",{children:s.label||s.id})]}),t?(0,p.jsxs)("span",{style:{padding:"2px 8px",borderRadius:999,background:"#eef2f7",color:"#374151",fontSize:11,lineHeight:1.4,whiteSpace:"nowrap"},children:["Dynamic: ",t]}):null]},s.id)})}):(0,p.jsx)("div",{className:"small",children:"No fields available for this section."})}):null]},e.id)})}):null]},e.key)})})}):(0,p.jsx)("div",{className:"card",style:{marginTop:12},children:(0,p.jsx)("div",{className:"small",children:"Select a country to edit progress rules."})})]}),"approvals"===P&&(0,p.jsxs)("div",{className:"card",style:{marginTop:12},children:[(0,p.jsxs)("div",{className:"row",style:{justifyContent:"space-between",alignItems:"flex-end"},children:[(0,p.jsxs)("div",{children:[(0,p.jsx)("div",{style:{fontWeight:700},children:"\xc7al\u0131\u015fma Listeleri"}),(0,p.jsx)("div",{className:"small",children:"Review submitted scenarios and approve for rollups."})]}),(0,p.jsxs)("div",{className:"row admin-filter-row",children:[(0,p.jsxs)("select",{className:"input sm",value:Ls.status,onChange:e=>Us(s=>(0,a.A)((0,a.A)({},s),{},{status:e.target.value})),children:[(0,p.jsx)("option",{value:"",children:"All"}),(0,p.jsx)("option",{value:"sent_for_approval",children:"Sent for approval"}),(0,p.jsx)("option",{value:"approved",children:"Approved"}),(0,p.jsx)("option",{value:"revision_requested",children:"Revision requested"}),(0,p.jsx)("option",{value:"draft",children:"Draft"})]}),(0,p.jsx)("input",{className:"input sm",placeholder:"Academic year",value:Ls.academicYear,onChange:e=>Us(s=>(0,a.A)((0,a.A)({},s),{},{academicYear:e.target.value}))}),(0,p.jsxs)("select",{className:"input sm",value:Ls.region,onChange:e=>Us(s=>(0,a.A)((0,a.A)({},s),{},{region:e.target.value,countryId:""})),children:[(0,p.jsx)("option",{value:"",children:"All regions"}),Nl.map(e=>(0,p.jsx)("option",{value:e,children:e},e))]}),(0,p.jsxs)("select",{className:"input sm",value:Ls.countryId,onChange:e=>Us(s=>(0,a.A)((0,a.A)({},s),{},{countryId:e.target.value})),children:[(0,p.jsx)("option",{value:"",children:"All countries"}),wl.map(e=>(0,p.jsx)("option",{value:e.id,children:e.name},e.id))]}),(0,p.jsx)("button",{className:"btn",onClick:()=>Ml(Ls),disabled:Es,children:"Apply"})]})]}),(0,p.jsxs)("table",{className:"table admin-approvals-table",style:{marginTop:12},children:[(0,p.jsx)("thead",{children:(0,p.jsxs)("tr",{children:[(0,p.jsx)("th",{"aria-sort":_l("country_name"),children:(0,p.jsxs)("button",{type:"button",onClick:()=>Cl("country_name"),style:{display:"inline-flex",alignItems:"center",gap:6,background:"none",border:"none",padding:0,cursor:"pointer",font:"inherit"},title:"Sort",children:["\xdclke ",(0,p.jsx)("span",{"aria-hidden":!0,children:kl("country_name")})]})}),(0,p.jsx)("th",{"aria-sort":_l("school_name"),children:(0,p.jsxs)("button",{type:"button",onClick:()=>Cl("school_name"),style:{display:"inline-flex",alignItems:"center",gap:6,background:"none",border:"none",padding:0,cursor:"pointer",font:"inherit"},title:"Sort",children:["School ",(0,p.jsx)("span",{"aria-hidden":!0,children:kl("school_name")})]})}),(0,p.jsx)("th",{"aria-sort":_l("scenario_name"),children:(0,p.jsxs)("button",{type:"button",onClick:()=>Cl("scenario_name"),style:{display:"inline-flex",alignItems:"center",gap:6,background:"none",border:"none",padding:0,cursor:"pointer",font:"inherit"},title:"Sort",children:["Scenario ",(0,p.jsx)("span",{"aria-hidden":!0,children:kl("scenario_name")})]})}),(0,p.jsx)("th",{"aria-sort":_l("academic_year"),children:(0,p.jsxs)("button",{type:"button",onClick:()=>Cl("academic_year"),style:{display:"inline-flex",alignItems:"center",gap:6,background:"none",border:"none",padding:0,cursor:"pointer",font:"inherit"},title:"Sort",children:["Academic Year ",(0,p.jsx)("span",{"aria-hidden":!0,children:kl("academic_year")})]})}),(0,p.jsx)("th",{"aria-sort":_l("submitted_at"),children:(0,p.jsxs)("button",{type:"button",onClick:()=>Cl("submitted_at"),style:{display:"inline-flex",alignItems:"center",gap:6,background:"none",border:"none",padding:0,cursor:"pointer",font:"inherit"},title:"Sort",children:["Submitted ",(0,p.jsx)("span",{"aria-hidden":!0,children:kl("submitted_at")})]})}),(0,p.jsx)("th",{"aria-sort":_l("status"),children:(0,p.jsxs)("button",{type:"button",onClick:()=>Cl("status"),style:{display:"inline-flex",alignItems:"center",gap:6,background:"none",border:"none",padding:0,cursor:"pointer",font:"inherit"},title:"Sort",children:["Status ",(0,p.jsx)("span",{"aria-hidden":!0,children:kl("status")})]})}),(0,p.jsx)("th",{children:"Progress"}),(0,p.jsx)("th",{children:"Y1 KPIs"}),(0,p.jsx)("th",{children:"Y2 KPIs"}),(0,p.jsx)("th",{children:"Y3 KPIs"}),(0,p.jsx)("th",{children:"Actions"})]})}),(0,p.jsx)("tbody",{children:Es?(0,p.jsx)("tr",{children:(0,p.jsx)("td",{colSpan:"11",className:"small",children:"Loading..."})}):0===Al.length?(0,p.jsx)("tr",{children:(0,p.jsx)("td",{colSpan:"11",className:"small",children:"No scenarios found."})}):Al.map(e=>{var s,l,i,a,n,t,r,o,c,d,m,h,v,x,g,y,j,b,f,N,w;const C=(e=>{const s=e&&"object"===typeof e?e:{status:e},l=s.status,i=s.sent_at;switch(l){case"revision_requested":return{label:"Revize istendi",className:"is-bad"};case"sent_for_approval":return{label:"Merkeze iletildi",className:"is-warn"};case"approved":return i?{label:"Onayland\u0131",className:"is-ok"}:{label:"Kontrol edildi",className:"is-ok"};case"in_review":return{label:"\u0130ncelemede",className:"is-warn"};case"submitted":return{label:"Onayda",className:"is-warn"};default:return{label:"Taslak",className:"is-muted"}}})(e.scenario),k="sent_for_approval"===(null===(s=e.scenario)||void 0===s?void 0:s.status)||"submitted"===(null===(l=e.scenario)||void 0===l?void 0:l.status),_=["sent_for_approval","approved","submitted"].includes(null===(i=e.scenario)||void 0===i?void 0:i.status),A=(null===(a=e.missingKpis)||void 0===a?void 0:a.y1)||(null===(n=e.missingKpis)||void 0===n?void 0:n.y2)||(null===(t=e.missingKpis)||void 0===t?void 0:t.y3),R=Number.isFinite(Number(null===(r=e.scenario)||void 0===r?void 0:r.progress_pct))?Math.round(Number(e.scenario.progress_pct)):null,F=null===(o=e.scenario)||void 0===o||null===(c=o.progress_json)||void 0===c?void 0:c.missingDetailsLines,T=null==R?[]:Array.isArray(F)&&F.length?["Eksik:",...F]:["Tum tablar tamamlandi"];return(0,p.jsxs)("tr",{children:[(0,p.jsxs)("td",{children:[(0,p.jsx)("div",{style:{fontWeight:700},children:(null===(v=e.country)||void 0===v?void 0:v.name)||"-"}),null!==(x=e.country)&&void 0!==x&&x.region?(0,p.jsx)("div",{className:"small",children:e.country.region}):null]}),(0,p.jsx)("td",{children:(0,p.jsx)("div",{style:{fontWeight:700},children:(null===(g=e.school)||void 0===g?void 0:g.name)||"-"})}),(0,p.jsxs)("td",{children:[(0,p.jsx)("div",{children:(null===(y=e.scenario)||void 0===y?void 0:y.name)||"-"}),A?(0,p.jsx)("span",{className:"status-badge is-bad",children:"Missing KPIs"}):null]}),(0,p.jsx)("td",{className:"small",children:(null===(j=e.scenario)||void 0===j?void 0:j.academic_year)||"-"}),(0,p.jsx)("td",{className:"small",children:S(null===(b=e.scenario)||void 0===b?void 0:b.submitted_at)}),(0,p.jsx)("td",{children:(0,p.jsx)("span",{className:"status-badge ".concat(C.className),children:C.label})}),(0,p.jsx)("td",{children:null==R?(0,p.jsx)("span",{className:"small",children:"-"}):(0,p.jsx)(u.A,{lines:T,children:(0,p.jsxs)("span",{className:"badge",children:[R,"%"]})})}),(0,p.jsx)("td",{children:Kl(null===(f=e.kpis)||void 0===f?void 0:f.y1)}),(0,p.jsx)("td",{children:Kl(null===(N=e.kpis)||void 0===N?void 0:N.y2)}),(0,p.jsx)("td",{children:Kl(null===(w=e.kpis)||void 0===w?void 0:w.y3)}),(0,p.jsx)("td",{children:(0,p.jsxs)("div",{className:"row",children:[(0,p.jsx)("button",{className:"btn primary",onClick:()=>ql(e,"approve"),disabled:!k||Qs,children:"Onayla"}),(0,p.jsx)("button",{className:"btn",onClick:()=>ql(e,"revise"),disabled:!_||Qs,children:"Revizyon \u0130ste"})]})})]},(null===(d=e.scenario)||void 0===d?void 0:d.id)||"".concat(null===(m=e.school)||void 0===m?void 0:m.id,"-").concat(null===(h=e.scenario)||void 0===h?void 0:h.name))})})]})]}),"reports"===P&&(0,p.jsxs)("div",{style:{marginTop:12},children:[(0,p.jsx)("div",{className:"card",children:(0,p.jsxs)("div",{className:"row",style:{justifyContent:"space-between"},children:[(0,p.jsxs)("div",{children:[(0,p.jsx)("div",{style:{fontWeight:700},children:"Rollup Reports"}),(0,p.jsx)("div",{className:"small",children:"Approved scenarios only. Select an academic year."})]}),(0,p.jsxs)("div",{className:"row",children:[(0,p.jsx)("input",{className:"input sm",placeholder:"Academic year",value:Xs,onChange:e=>Zs(e.target.value)}),(0,p.jsx)("button",{className:"btn",onClick:()=>Pl(Xs),disabled:sl,children:sl?"Loading...":"Load"}),(0,p.jsxs)("div",{className:"action-menu",ref:nl,children:[(0,p.jsx)("button",{type:"button",className:"btn",onClick:()=>{zl||al(e=>!e)},disabled:zl,"aria-haspopup":"menu","aria-expanded":il,children:"Export"}),il?(0,p.jsxs)("div",{className:"action-menu-panel",role:"menu",children:[(0,p.jsxs)("button",{type:"button",className:"action-menu-item",onClick:()=>{al(!1)},disabled:!0,title:"Excel export coming soon",role:"menuitem",children:["Excel (.xlsx)"," (coming soon)"]}),(0,p.jsx)("button",{type:"button",className:"action-menu-item",disabled:!0,role:"menuitem",children:"PDF (coming soon)"})]}):null]})]})]})}),$s?(0,p.jsxs)(p.Fragment,{children:[(0,p.jsxs)("div",{className:"card",style:{marginTop:12},children:[(0,p.jsx)("div",{style:{fontWeight:700},children:"Consolidated KPIs"}),(0,p.jsx)("div",{className:"admin-kpi-strip",style:{marginTop:10},children:v.map(e=>{var s,l,i,a,n,t,r,o,c,d,u,m;return(0,p.jsxs)("div",{className:"admin-kpi-year",children:[(0,p.jsx)("div",{className:"admin-kpi-year-title",children:e.toUpperCase()}),(0,p.jsxs)("div",{className:"admin-kpi-grid",children:[(0,p.jsxs)("div",{className:"admin-kpi",children:[(0,p.jsx)("div",{className:"admin-kpi-label",children:"Net ciro"}),(0,p.jsx)("div",{className:"admin-kpi-value",children:f(null===(s=$s.totals)||void 0===s||null===(l=s[e])||void 0===l?void 0:l.net_ciro)})]}),(0,p.jsxs)("div",{className:"admin-kpi",children:[(0,p.jsx)("div",{className:"admin-kpi-label",children:"Net income"}),(0,p.jsx)("div",{className:"admin-kpi-value",children:f(null===(i=$s.totals)||void 0===i||null===(a=i[e])||void 0===a?void 0:a.net_income)})]}),(0,p.jsxs)("div",{className:"admin-kpi",children:[(0,p.jsx)("div",{className:"admin-kpi-label",children:"Expenses"}),(0,p.jsx)("div",{className:"admin-kpi-value",children:f(null===(n=$s.totals)||void 0===n||null===(t=n[e])||void 0===t?void 0:t.total_expenses)})]}),(0,p.jsxs)("div",{className:"admin-kpi",children:[(0,p.jsx)("div",{className:"admin-kpi-label",children:"Net result"}),(0,p.jsx)("div",{className:"admin-kpi-value",children:f(null===(r=$s.totals)||void 0===r||null===(o=r[e])||void 0===o?void 0:o.net_result)})]}),(0,p.jsxs)("div",{className:"admin-kpi",children:[(0,p.jsx)("div",{className:"admin-kpi-label",children:"Margin"}),(0,p.jsx)("div",{className:"admin-kpi-value",children:N(null===(c=$s.totals)||void 0===c||null===(d=c[e])||void 0===d?void 0:d.profitMargin)})]}),(0,p.jsxs)("div",{className:"admin-kpi",children:[(0,p.jsx)("div",{className:"admin-kpi-label",children:"Students"}),(0,p.jsx)("div",{className:"admin-kpi-value",children:f(null===(u=$s.totals)||void 0===u||null===(m=u[e])||void 0===m?void 0:m.students_total)})]})]})]},e)})})]}),(0,p.jsxs)("div",{className:"card",style:{marginTop:12},children:[(0,p.jsx)("div",{style:{fontWeight:700},children:"Rollup Tree"}),(0,p.jsx)("div",{className:"small",style:{marginTop:4},children:"Only approved scenarios are consolidated. Excluded years show as blank."}),(0,p.jsx)("div",{className:"rollup-table-wrap",style:{marginTop:10},children:(0,p.jsxs)("table",{className:"table rollup-table",children:[(0,p.jsx)("thead",{children:(0,p.jsxs)("tr",{children:[(0,p.jsx)("th",{style:{minWidth:220},children:"Unit"}),(0,p.jsx)("th",{style:{minWidth:220},children:"Y1"}),(0,p.jsx)("th",{style:{minWidth:220},children:"Y2"}),(0,p.jsx)("th",{style:{minWidth:220},children:"Y3"})]})}),(0,p.jsxs)("tbody",{children:[(0,p.jsxs)("tr",{className:"rollup-row rollup-total",children:[(0,p.jsx)("td",{className:"rollup-name",children:"Totals"}),(0,p.jsx)("td",{children:Dl(null===(_=$s.totals)||void 0===_?void 0:_.y1)}),(0,p.jsx)("td",{children:Dl(null===(A=$s.totals)||void 0===A?void 0:A.y2)}),(0,p.jsx)("td",{children:Dl(null===(R=$s.totals)||void 0===R?void 0:R.y3)})]}),null===(F=$s.regions)||void 0===F?void 0:F.map(e=>{var s,l,i,a;const t=e.region||"Unknown",r=tl.has(t);return(0,p.jsxs)(n.Fragment,{children:[(0,p.jsxs)("tr",{className:"rollup-row rollup-region",children:[(0,p.jsxs)("td",{className:"rollup-name",children:[(0,p.jsx)("button",{type:"button",className:"tree-toggle",onClick:()=>(e=>{rl(s=>{const l=new Set(s);return l.has(e)?l.delete(e):l.add(e),l})})(t),"aria-label":"Toggle region",children:r?"-":"+"}),(0,p.jsx)("span",{className:"rollup-title",children:e.region||"Unknown region"})]}),(0,p.jsx)("td",{children:Dl(null===(s=e.years)||void 0===s?void 0:s.y1)}),(0,p.jsx)("td",{children:Dl(null===(l=e.years)||void 0===l?void 0:l.y2)}),(0,p.jsx)("td",{children:Dl(null===(i=e.years)||void 0===i?void 0:i.y3)})]}),r?null===(a=e.countries)||void 0===a?void 0:a.map(e=>{var s,l,i,a;const r="".concat(t,"::").concat(e.id),o=ol.has(r);return(0,p.jsxs)(n.Fragment,{children:[(0,p.jsxs)("tr",{className:"rollup-row rollup-country",children:[(0,p.jsxs)("td",{className:"rollup-name level-1",children:[(0,p.jsx)("button",{type:"button",className:"tree-toggle",onClick:()=>((e,s)=>{const l="".concat(e,"::").concat(s);cl(e=>{const s=new Set(e);return s.has(l)?s.delete(l):s.add(l),s})})(t,e.id),"aria-label":"Toggle country",children:o?"-":"+"}),(0,p.jsx)("span",{className:"rollup-title",children:e.name})]}),(0,p.jsx)("td",{children:Dl(null===(s=e.years)||void 0===s?void 0:s.y1)}),(0,p.jsx)("td",{children:Dl(null===(l=e.years)||void 0===l?void 0:l.y2)}),(0,p.jsx)("td",{children:Dl(null===(i=e.years)||void 0===i?void 0:i.y3)})]}),o?null===(a=e.schools)||void 0===a?void 0:a.map(e=>{var s,l,i,a;return(0,p.jsxs)("tr",{className:"rollup-row rollup-school",children:[(0,p.jsxs)("td",{className:"rollup-name level-2",children:[e.name,null!==(s=e.included_years)&&void 0!==s&&s.length?(0,p.jsxs)("span",{className:"rollup-sub",children:["(",e.included_years.join(", "),")"]}):null]}),(0,p.jsx)("td",{children:Dl(null===(l=e.years)||void 0===l?void 0:l.y1)}),(0,p.jsx)("td",{children:Dl(null===(i=e.years)||void 0===i?void 0:i.y2)}),(0,p.jsx)("td",{children:Dl(null===(a=e.years)||void 0===a?void 0:a.y3)})]},"school-".concat(e.id))}):null]},r)}):null]},"region-".concat(t))})]})]})})]}),null!==(T=$s.missingNoApproved)&&void 0!==T&&T.length?(0,p.jsxs)("div",{className:"card admin-alert",style:{marginTop:12},children:[(0,p.jsx)("div",{className:"admin-alert-title",children:"Schools without an approved scenario"}),(0,p.jsx)("ul",{children:$s.missingNoApproved.map(e=>(0,p.jsxs)("li",{children:[e.name," (",e.country_name,")"]},"missing-".concat(e.id)))})]}):null,null!==(I=$s.missingKpis)&&void 0!==I&&I.length?(0,p.jsxs)("div",{className:"card admin-alert",style:{marginTop:12},children:[(0,p.jsx)("div",{className:"admin-alert-title",children:"Approved scenarios missing KPI snapshots"}),(0,p.jsx)("ul",{children:$s.missingKpis.map(e=>(0,p.jsxs)("li",{children:["Scenario #",e.scenario_id," (School #",e.school_id,") - missing ",e.missingYears.join(", ")]},"missing-kpi-".concat(e.scenario_id)))})]}):null]}):(0,p.jsx)("div",{className:"card",style:{marginTop:12},children:(0,p.jsx)("div",{className:"small",children:"Select an academic year to view the rollup report."})})]})]})]})}}}]);
//# sourceMappingURL=613.b934c539.chunk.js.map