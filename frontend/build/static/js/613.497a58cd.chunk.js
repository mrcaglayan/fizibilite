"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[613],{613(e,s,l){l.d(s,{A:()=>_});var i,a=l(2555),n=l(5043),t=l(7950),r=l(5685),o=l(2115),c=l(3204),d=l(7559),u=l(3182),m=l(4405),h=l(3492),p=l(4930),v=l(579);const x=["y1","y2","y3"],g=["temel_bilgiler","kapasite","norm.ders_dagilimi","ik.local_staff","gelirler.unit_fee","giderler.isletme"],y={temel_bilgiler:"Temel Bilgiler",kapasite:"Kapasite","norm.ders_dagilimi":"Norm","ik.local_staff":"\u0130K","gelirler.unit_fee":"Gelirler","giderler.isletme":"Giderler"},j=(null===(i=p.b[0])||void 0===i?void 0:i.key)||"users",b=e=>p.b.some(s=>s.key===e),f=e=>{if(!e)return null;const s=new URLSearchParams(e).get("tab");return b(s)?s:null},N=e=>{const s=Number(e);return Number.isFinite(s)?s.toLocaleString(void 0,{maximumFractionDigits:0}):"-"},S=e=>{const s=Number(e);return Number.isFinite(s)?(100*s).toLocaleString(void 0,{maximumFractionDigits:2})+"%":"-"},w=e=>{if(!e)return"-";const s=new Date(e);return Number.isFinite(s.getTime())?s.toLocaleString():"-"},C=["Magis Basari Bursu","Maarif Yetenek Bursu","Ihtiyac Bursu","Okul Basari Bursu","Tam Egitim Bursu","Barinma Bursu","Turkce Basari Bursu","Uluslararasi Yukumluluk Indirimi","Vakif Calisani Indirimi","Kardes Indirimi","Erken Kayit Indirimi","Pesin Odeme Indirimi","Kademe Gecis Indirimi","Temsil Indirimi","Kurum Indirimi","Istisnai Indirim","Yerel Mevzuat Indirimi"];function k(e){const s=(0,h.bO)(),l=e&&"object"===typeof e?e:{},i=l.sections&&"object"===typeof l.sections?l.sections:{},a={version:s.version,sections:{}};return Object.keys(s.sections).forEach(e=>{const l=s.sections[e]||{},n=i[e]&&"object"===typeof i[e]?i[e]:{};a.sections[e]={enabled:"boolean"===typeof n.enabled?n.enabled:!1!==l.enabled,mode:"string"===typeof n.mode&&n.mode?n.mode:l.mode,min:null!=n.min?Number(n.min):l.min,selectedFields:n.selectedFields&&"object"===typeof n.selectedFields?n.selectedFields:{}}}),a}function _(){var e,s,l,i,p,_,A,R,F,T,I,B;let{forcedTab:E=null}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const L=(0,u.A)(),M=(0,r.KC)(),P=(0,r.zy)(),U=b(E)?E:null,[W,H]=(0,n.useState)(()=>{if(U)return U;const e=f(P.search);if(e)return e;try{const e=localStorage.getItem("admin.activeTab");if(b(e))return e}catch(s){}return j});(0,n.useEffect)(()=>{if(U)return;const e=f(P.search);e&&e!==W?H(e):e||W===j||H(j)},[P.search,W,U]),(0,n.useEffect)(()=>{U&&W!==U&&H(U)},[U,W]),(0,n.useEffect)(()=>{if(!U)try{localStorage.setItem("admin.activeTab",W)}catch(e){}},[W,U]);const[q,Y]=(0,n.useState)([]),[K,O]=(0,n.useState)([]),[D,z]=(0,n.useState)(!1),[G,J]=(0,n.useState)(!1),[Q,V]=(0,n.useState)(null),[X,Z]=(0,n.useState)(null),[$,ee]=(0,n.useState)(null),[se,le]=(0,n.useState)(null),[ie,ae]=(0,n.useState)(null),[ne,te]=(0,n.useState)(""),[re,oe]=(0,n.useState)(""),[ce,de]=(0,n.useState)(""),[ue,me]=(0,n.useState)(""),[he,pe]=(0,n.useState)(""),[ve,xe]=(0,n.useState)(""),[ge,ye]=(0,n.useState)("user"),[je,be]=(0,n.useState)(""),[fe,Ne]=(0,n.useState)(""),[Se,we]=(0,n.useState)(""),[Ce,ke]=(0,n.useState)(!0),[_e,Ae]=(0,n.useState)(""),[Re,Fe]=(0,n.useState)([]),[Te,Ie]=(0,n.useState)(!1),[Be,Ee]=(0,n.useState)(""),[Le,Me]=(0,n.useState)(""),[Pe,Ue]=(0,n.useState)(!1),[We,He]=(0,n.useState)(!1),[qe,Ye]=(0,n.useState)([""]),[Ke,Oe]=(0,n.useState)(null),[De,ze]=(0,n.useState)({}),[Ge,Je]=(0,n.useState)(""),[Qe,Ve]=(0,n.useState)(null),[Xe,Ze]=(0,n.useState)(!1),[$e,es]=(0,n.useState)(!1),[ss,ls]=(0,n.useState)(""),[is,as]=(0,n.useState)(()=>new Set),[ns,ts]=(0,n.useState)(""),[rs,os]=(0,n.useState)(!1),[cs,ds]=(0,n.useState)({}),[us,ms]=(0,n.useState)(new Set),[hs,ps]=(0,n.useState)(new Set),[vs,xs]=(0,n.useState)([]),[gs,ys]=(0,n.useState)(null),[js,bs]=(0,n.useState)({}),[fs,Ns]=(0,n.useState)({}),[Ss,ws]=(0,n.useState)(!1),[Cs,ks]=(0,n.useState)(!1),[_s,As]=(0,n.useState)([]),Rs=(0,n.useMemo)(()=>[{value:"user",label:"User"},{value:"principal",label:"Principal"},{value:"hr",label:"HR"},{value:"manager",label:"Manager"},{value:"accountant",label:"Accountant"},{value:"admin",label:"Admin"}],[]),[Fs,Ts]=(0,n.useState)(!1),[Is,Bs]=(0,n.useState)({}),[Es,Ls]=(0,n.useState)({}),[Ms,Ps]=(0,n.useState)({}),[Us,Ws]=(0,n.useState)(!1),[Hs,qs]=(0,n.useState)({status:"",academicYear:"",region:"",countryId:""}),[Ys,Ks]=(0,n.useState)({key:null,dir:null}),[Os,Ds]=(0,n.useState)(null),[zs,Gs]=(0,n.useState)(""),[Js,Qs]=(0,n.useState)({y1:!0,y2:!0,y3:!0}),[Vs,Xs]=(0,n.useState)(()=>{const e={};return g.forEach(s=>e[s]=!1),e}),Zs=(0,n.useCallback)(()=>{const e={};g.forEach(s=>e[s]=!0),Xs(e)},[]),$s=(0,n.useCallback)(()=>{const e={};g.forEach(s=>e[s]=!1),Xs(e)},[]),[el,sl]=(0,n.useState)(!1),[ll,il]=(0,n.useState)(""),[al,nl]=(0,n.useState)(null),[tl,rl]=(0,n.useState)(!1),[ol,cl]=(0,n.useState)(!1),dl=(0,n.useRef)(null),[ul,ml]=(0,n.useState)(new Set),[hl,pl]=(0,n.useState)(new Set);(0,n.useEffect)(()=>{document.title="Admin \xb7 Feasibility Studio"},[]),(0,n.useEffect)(()=>(null===M||void 0===M||M.setHeaderMeta({title:"Admin",subtitle:"Create users, manage countries, and review scenarios."}),()=>{var e;null===M||void 0===M||null===(e=M.clearHeaderMeta)||void 0===e||e.call(M)}),[M]);const vl=(0,n.useRef)(Hs);(0,n.useEffect)(()=>{vl.current=Hs},[Hs]);const xl=(0,n.useMemo)(()=>K.find(e=>String(e.id)===String(fe))||null,[K,fe]),gl=(0,n.useMemo)(()=>q.find(e=>String(e.id)===String(Se))||null,[q,Se]),yl=(0,n.useMemo)(()=>q.find(e=>String(e.id)===String(_e))||null,[q,_e]);(0,n.useEffect)(()=>{"countries"===W&&Array.isArray(Re)&&0!==Re.length&&Re.forEach(e=>{const s=e.id;void 0===Is[s]&&(async()=>{try{const e=await d.FH.adminGetSchoolPrincipals(s);Bs(l=>(0,a.A)((0,a.A)({},l),{},{[s]:Array.isArray(e)?e:[]}));const l=Array.isArray(e)?e.map(e=>e.id):[];Ls(e=>(0,a.A)((0,a.A)({},e),{},{[s]:l}))}catch(e){console.error(e)}})()})},[W,Re,Is]),(0,n.useEffect)(()=>{const e=null===xl||void 0===xl?void 0:xl.id,s=null===xl||void 0===xl?void 0:xl.country_id;if(!e)return ys(null),bs({}),Ns({}),void As([]);ws(!0),Promise.all([d.FH.adminGetPermissionsCatalog(),d.FH.adminGetUserPermissions(e),s?d.FH.adminListCountrySchools(s):Promise.resolve([])]).then(e=>{let[s,l,i]=e;ys(s||null);let a=[];Array.isArray(i)?a=i:i&&Array.isArray(i.items)&&(a=i.items),As(a);const n={},t={};(l||[]).forEach(e=>{const s="".concat(e.resource,"|").concat(e.action);n[s]=!0,null!=e.scope_school_id?t[s]="school:".concat(e.scope_school_id):t[s]="country"}),bs(n),Ns(t)}).catch(e=>{console.error(e),o.oR.error((null===e||void 0===e?void 0:e.message)||"Failed to load permissions")}).finally(()=>{ws(!1)})},[xl]);const jl=(0,n.useMemo)(()=>({discounts:C.map(e=>({name:e,ratio:0,value:0}))}),[]),bl=(0,n.useMemo)(()=>(0,h.Rn)({inputs:jl,norm:null}),[jl]),fl=(0,n.useMemo)(()=>k(Qe),[Qe]),Nl=xl&&gl&&null!=xl.country_id&&String(xl.country_id)===String(gl.id),Sl=xl?xl.country_name?"".concat(xl.country_name," (").concat(xl.country_code,")").concat(xl.region?" - ".concat(xl.region):""):"Unassigned":"Select a user",wl=gl?"".concat(gl.name," (").concat(gl.code,")").concat(gl.region?" - ".concat(gl.region):""):"Select a country",Cl=null!=(null===xl||void 0===xl?void 0:xl.country_id)?"Update Country":"Assign Country",kl=(0,n.useMemo)(()=>Ce?K.filter(e=>null==e.country_id):K,[K,Ce]),_l=(0,n.useMemo)(()=>{const e=new Set;return q.forEach(s=>{s.region&&e.add(s.region)}),Array.from(e).sort()},[q]),Al=(0,n.useMemo)(()=>gs?Array.isArray(gs)||"object"!==typeof gs?Array.isArray(gs)?gs.reduce((e,s)=>{const l=s.group||"Other";return e[l]||(e[l]=[]),e[l].push(s),e},{}):{}:gs:{},[gs]),Rl=(0,n.useMemo)(()=>Hs.region?q.filter(e=>e.region===Hs.region):q,[q,Hs.region]),Fl=(0,n.useCallback)(e=>{const s={academic_year:["desc","asc",null],country_name:["asc","desc",null],school_name:["asc","desc",null],scenario_name:["asc","desc",null],submitted_at:["desc","asc",null],status:["asc","desc",null]};Ks(l=>{const i=s[e]||["asc","desc",null];if(l.key!==e)return{key:e,dir:i[0]};const a=i.indexOf(l.dir),n=i[(a+1)%i.length];return n?{key:e,dir:n}:{key:null,dir:null}})},[Ks]),Tl=(0,n.useCallback)(e=>Ys.key===e&&Ys.dir?"asc"===Ys.dir?"\u25b2":"\u25bc":"",[Ys]),Il=(0,n.useCallback)(e=>Ys.key===e&&Ys.dir?"asc"===Ys.dir?"ascending":"descending":"none",[Ys]),Bl=(0,n.useMemo)(()=>{const e=Array.isArray(vs)?vs:[];if(null===Ys||void 0===Ys||!Ys.key||null===Ys||void 0===Ys||!Ys.dir)return e;const s=e=>{var s,l,i,a,n,t;switch(Ys.key){case"country_name":return String((null===(s=e.country)||void 0===s?void 0:s.name)||"");case"school_name":return String((null===(l=e.school)||void 0===l?void 0:l.name)||"");case"scenario_name":return String((null===(i=e.scenario)||void 0===i?void 0:i.name)||"");case"academic_year":return(e=>{const s=String(e||"").trim(),l=s.match(/\d{4}/g)||[],i=l[0]?Number(l[0]):-1;return{a:i,b:l[1]?Number(l[1]):i,raw:s.toLowerCase()}})(null===(a=e.scenario)||void 0===a?void 0:a.academic_year);case"submitted_at":return null!==(n=e.scenario)&&void 0!==n&&n.submitted_at?new Date(e.scenario.submitted_at).getTime():-1/0;case"status":return String((null===(t=e.scenario)||void 0===t?void 0:t.status)||"");default:return""}},l="desc"===Ys.dir?-1:1,i=(e,s)=>String(e||"").localeCompare(String(s||""),void 0,{sensitivity:"base"}),a=e.map((e,l)=>({row:e,idx:l,val:s(e)}));return a.sort((e,s)=>{let a=0;const n=e.val,t=s.val;var r,o,c,d;"academic_year"===Ys.key?(a=(null!==(r=null===n||void 0===n?void 0:n.a)&&void 0!==r?r:-1)-(null!==(o=null===t||void 0===t?void 0:t.a)&&void 0!==o?o:-1),0===a&&(a=(null!==(c=null===n||void 0===n?void 0:n.b)&&void 0!==c?c:-1)-(null!==(d=null===t||void 0===t?void 0:t.b)&&void 0!==d?d:-1)),0===a&&(a=i(null===n||void 0===n?void 0:n.raw,null===t||void 0===t?void 0:t.raw))):a="number"===typeof n&&"number"===typeof t?n-t:i(n,t);return 0===a?e.idx-s.idx:a*l}),a.map(e=>e.row)},[vs,Ys]),El=ss.trim().toLowerCase(),Ll=(0,n.useMemo)(()=>{const e=ns.trim().toLowerCase();return e?q.filter(s=>{const l=String(s.name||"").toLowerCase(),i=String(s.code||"").toLowerCase();return l.includes(e)||i.includes(e)}):q},[q,ns]),Ml=is.size,Pl=!Ge||0===Ml||$e||Xe||rs,Ul=(0,n.useMemo)(()=>{const e=Be.trim().toLowerCase();return e?Re.filter(s=>String(s.name||"").toLowerCase().includes(e)):Re},[Re,Be]),Wl=Pe||We,Hl=qe.reduce((e,s)=>String(s||"").trim()?e+1:e,0),ql=(0,n.useCallback)(async()=>{z(!0);try{const[e,s]=await Promise.all([d.FH.listCountries(),d.FH.listUsers({limit:50,offset:0,fields:"brief",order:"id:desc"})]);Y(e),O(Array.isArray(null===s||void 0===s?void 0:s.items)?s.items:[])}catch(e){o.oR.error(e.message||"Failed to load admin data")}finally{z(!1)}},[]),Yl=(0,n.useCallback)(async e=>{const s=Number(e);if(Number.isFinite(s)){Ie(!0);try{const e=await d.FH.adminListCountrySchools(s,{includeClosed:1});Fe(Array.isArray(e)?e:[])}catch(l){o.oR.error(l.message||"Failed to load schools")}finally{Ie(!1)}}else Fe([])},[]),Kl=(0,n.useCallback)(async e=>{const s=Number(e);if(Number.isFinite(s)){Ze(!0);try{const e=await d.FH.adminGetProgressRequirements(s);Ve(k((null===e||void 0===e?void 0:e.config)||e))}catch(l){o.oR.error(l.message||"Failed to load progress requirements"),Ve(k(null))}finally{Ze(!1)}}else Ve(null)},[]),Ol=(0,n.useCallback)(async e=>{const s=e||vl.current||{};Ws(!0);try{const e={status:s.status,academicYear:s.academicYear,region:s.region,countryId:s.countryId},l=await d.FH.adminGetScenarioQueue(e);xs(Array.isArray(l)?l:[])}catch(l){o.oR.error(l.message||"Failed to load approvals queue")}finally{Ws(!1)}},[]),Dl=(0,n.useCallback)(async e=>{const s=(null!==e&&void 0!==e?e:ll).trim();if(s){rl(!0);try{const e=await d.FH.adminGetRollup({academicYear:s});nl(e)}catch(l){o.oR.error(l.message||"Failed to load rollup report")}finally{rl(!1)}}else o.oR.error("Academic year is required")},[ll]);async function zl(e){const s=function(){try{const l=["token","auth_token","jwt","access_token"];for(const i of l){var e,s;const l=null===(e=window)||void 0===e||null===(s=e.localStorage)||void 0===s?void 0:s.getItem(i);if(l)return String(l)}}catch(l){}return""}(),l=await fetch("/api/admin/users/".concat(e,"/reset-password"),{method:"POST",headers:(0,a.A)({"Content-Type":"application/json"},s?{Authorization:"Bearer ".concat(s)}:{}),body:JSON.stringify({})});let i={};try{i=await l.json()}catch(r){i={}}if(!l.ok){var n,t;const e=(null===(n=i)||void 0===n?void 0:n.error)||(null===(t=i)||void 0===t?void 0:t.details)||"Reset failed (".concat(l.status,")");throw new Error(e)}return i}(0,n.useEffect)(()=>{var e;"admin"===(null===(e=L.user)||void 0===e?void 0:e.role)&&ql()},[null===(e=L.user)||void 0===e?void 0:e.role,ql]),(0,n.useEffect)(()=>{var e;"approvals"===W&&"admin"===(null===(e=L.user)||void 0===e?void 0:e.role)&&Ol()},[W,null===(s=L.user)||void 0===s?void 0:s.role,Ol]),(0,n.useEffect)(()=>{"countries"===W&&(_e?Yl(_e):Fe([]))},[W,Yl,_e]),(0,n.useEffect)(()=>{"progress"===W&&(Ge?Kl(Ge):Ve(null))},[W,Kl,Ge]),(0,n.useEffect)(()=>{ls(""),ms(new Set),ps(new Set)},[Ge]),(0,n.useEffect)(()=>{if(!ol)return;const e=e=>{const s=dl.current;s&&!s.contains(e.target)&&cl(!1)},s=e=>{"Escape"===e.key&&cl(!1)};return document.addEventListener("mousedown",e),document.addEventListener("keydown",s),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",s)}},[ol]),(0,n.useEffect)(()=>{if(null===al||void 0===al||!al.regions)return;const e=new Set,s=new Set;al.regions.forEach(l=>{e.add(l.region),l.countries.forEach(e=>{s.add("".concat(l.region,"::").concat(e.id))})}),ml(e),pl(s)},[al]),(0,n.useEffect)(()=>{if(!fe)return void we("");const e=K.find(e=>String(e.id)===String(fe));e&&null!=e.country_id?we(String(e.country_id)):we("")},[fe,K]),(0,n.useEffect)(()=>{ze({}),Ee(""),Me(""),Ye([""])},[_e]);const Gl=(e,s)=>{Ve(l=>{var i;const a=k(l),n=structuredClone(a),t=null===(i=n.sections)||void 0===i?void 0:i[e];return t?(s(t),n):a})},Jl=(e,s)=>{if(Ds({row:e,action:s}),Gs(""),Qs({y1:!0,y2:!0,y3:!0}),"revise"===s){const e={};g.forEach(s=>e[s]=!1),Xs(e)}},Ql=()=>{Ds(null),Gs(""),Qs({y1:!0,y2:!0,y3:!0});const e={};g.forEach(s=>e[s]=!1),Xs(e)},Vl=e=>{if(!e)return(0,v.jsx)("div",{className:"kpi-mini kpi-mini-missing",children:"Missing KPIs"});const s=e.net_ciro?e.net_result/e.net_ciro:null;return(0,v.jsxs)("div",{className:"kpi-mini",children:[(0,v.jsxs)("div",{className:"kpi-mini-row",children:[(0,v.jsx)("span",{className:"kpi-mini-label",children:"Net ciro"}),(0,v.jsx)("span",{className:"kpi-mini-value",children:N(e.net_ciro)})]}),(0,v.jsxs)("div",{className:"kpi-mini-row",children:[(0,v.jsx)("span",{className:"kpi-mini-label",children:"Net result"}),(0,v.jsx)("span",{className:"kpi-mini-value",children:N(e.net_result)})]}),(0,v.jsxs)("div",{className:"kpi-mini-row",children:[(0,v.jsx)("span",{className:"kpi-mini-label",children:"Margin"}),(0,v.jsx)("span",{className:"kpi-mini-value",children:S(s)})]})]})},Xl=e=>e?(0,v.jsxs)("div",{className:"rollup-year-cell",children:[(0,v.jsxs)("div",{className:"rollup-metric",children:[(0,v.jsx)("span",{className:"rollup-label",children:"Net ciro"}),(0,v.jsx)("span",{className:"rollup-value",children:N(e.net_ciro)})]}),(0,v.jsxs)("div",{className:"rollup-metric",children:[(0,v.jsx)("span",{className:"rollup-label",children:"Net income"}),(0,v.jsx)("span",{className:"rollup-value",children:N(e.net_income)})]}),(0,v.jsxs)("div",{className:"rollup-metric",children:[(0,v.jsx)("span",{className:"rollup-label",children:"Expenses"}),(0,v.jsx)("span",{className:"rollup-value",children:N(e.total_expenses)})]}),(0,v.jsxs)("div",{className:"rollup-metric",children:[(0,v.jsx)("span",{className:"rollup-label",children:"Net result"}),(0,v.jsx)("span",{className:"rollup-value",children:N(e.net_result)})]}),(0,v.jsxs)("div",{className:"rollup-metric",children:[(0,v.jsx)("span",{className:"rollup-label",children:"Margin"}),(0,v.jsx)("span",{className:"rollup-value",children:S(e.profitMargin)})]}),(0,v.jsxs)("div",{className:"rollup-metric",children:[(0,v.jsx)("span",{className:"rollup-label",children:"Students"}),(0,v.jsx)("span",{className:"rollup-value",children:N(e.students_total)})]})]}):(0,v.jsx)("div",{className:"rollup-year-cell is-empty",children:"-"}),Zl=()=>{if("approvals"!==W)if("progress"!==W){if("reports"!==W)return"countries"===W?(ql(),void(_e&&Yl(_e))):void ql();Dl(ll)}else Ge&&Kl(Ge);else Ol(Hs)};if(!L.user)return(0,v.jsx)("div",{className:"container",children:(0,v.jsx)("div",{className:"card",children:"Loading..."})});if("admin"!==L.user.role)return(0,v.jsx)("div",{className:"container",children:(0,v.jsxs)("div",{className:"card",children:[(0,v.jsx)("div",{style:{fontWeight:700},children:"Admin only"}),(0,v.jsx)("div",{className:"small",style:{marginTop:6},children:"You do not have permission to view this page."}),(0,v.jsx)("div",{style:{marginTop:10},children:(0,v.jsx)(r.N_,{to:"/schools",children:"Back to Schools"})})]})});const $l=tl||!al,ei=D||Us||tl||Xe,si=()=>(0,v.jsx)("button",{className:"btn",onClick:Zl,disabled:ei,children:"Refresh"});return(0,v.jsxs)(v.Fragment,{children:[null!==M&&void 0!==M&&M.headerPortalEl?(0,t.createPortal)(si(),M.headerPortalEl):null,(0,v.jsxs)("div",{className:"container",children:[!(null!==M&&void 0!==M&&M.headerPortalEl)&&(0,v.jsxs)("div",{className:"row",style:{justifyContent:"space-between"},children:[(0,v.jsxs)("div",{children:[(0,v.jsx)("div",{style:{fontWeight:800,fontSize:20},children:"Admin"}),(0,v.jsx)("div",{className:"small",children:"Create users, manage countries, and review scenarios."})]}),si()]}),(0,v.jsx)(o.N9,{position:"top-right",autoClose:3500,newestOnTop:!0,closeOnClick:!0,pauseOnFocusLoss:!0,pauseOnHover:!0}),G?(0,v.jsxs)("div",{className:"modal-backdrop",role:"status","aria-live":"polite","aria-busy":"true",children:[(0,v.jsx)("style",{children:"@keyframes adminSpin{to{transform:rotate(360deg)}}"}),(0,v.jsxs)("div",{className:"card",style:{width:"min(360px, 92vw)",padding:"16px",textAlign:"center"},children:[(0,v.jsx)("div",{"aria-hidden":!0,style:{width:28,height:28,margin:"0 auto",borderRadius:"50%",border:"3px solid rgba(0,0,0,.15)",borderTopColor:"rgba(0,0,0,.75)",animation:"adminSpin .8s linear infinite"}}),(0,v.jsx)("div",{style:{fontWeight:700,marginTop:10},children:"Updating user..."}),(0,v.jsx)("div",{className:"small muted",style:{marginTop:6},children:"Please wait."})]})]}):null,Q?(0,v.jsx)("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true",children:(0,v.jsxs)("div",{className:"modal",children:[(0,v.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Confirm Change"}),(0,v.jsx)("div",{className:"small",style:{marginBottom:12},children:"Change ".concat(Q.email," from ").concat(Q.currentLabel," to ").concat(Q.nextLabel,"?")}),(0,v.jsxs)("div",{className:"row",style:{justifyContent:"flex-end"},children:[(0,v.jsx)("button",{className:"btn",onClick:()=>V(null),disabled:G,children:"Cancel"}),(0,v.jsx)("button",{className:"btn primary",onClick:()=>{const e=Q;V(null),async function(e){if(e&&!G){J(!0);try{await d.FH.assignUserCountry(e.userId,{countryId:e.nextId}),await ql(),o.oR.success(e.hadCountry?"User country updated":"User assigned")}catch(s){o.oR.error(s.message||"Assignment failed")}finally{J(!1)}}}(e)},disabled:G,children:G?"Updating...":"Confirm"})]})]})}):null,X?(0,v.jsx)("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true",children:(0,v.jsxs)("div",{className:"modal",children:[(0,v.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Confirm Delete"}),(0,v.jsx)("div",{className:"small",style:{marginBottom:12},children:"Delete ".concat(X.label,"? This only works if the user has no related records.")}),(0,v.jsxs)("div",{className:"row",style:{justifyContent:"flex-end"},children:[(0,v.jsx)("button",{className:"btn",onClick:()=>Z(null),children:"Cancel"}),(0,v.jsx)("button",{className:"btn danger",onClick:()=>{const e=X;Z(null),async function(e){if(e)try{await d.FH.deleteUser(e.id),await ql(),o.oR.success("User deleted")}catch(s){o.oR.error(s.message||"Delete failed")}}(e)},children:"Delete"})]})]})}):null,ie?(0,v.jsxs)("div",{className:"modal-backdrop",role:"status","aria-live":"polite","aria-busy":"true",children:[(0,v.jsx)("style",{children:"@keyframes adminSpin{to{transform:rotate(360deg)}}"}),(0,v.jsxs)("div",{className:"card",style:{width:"min(360px, 92vw)",padding:"16px",textAlign:"center"},children:[(0,v.jsx)("div",{"aria-hidden":!0,style:{width:28,height:28,margin:"0 auto",borderRadius:"50%",border:"3px solid rgba(0,0,0,.15)",borderTopColor:"rgba(0,0,0,.75)",animation:"adminSpin .8s linear infinite"}}),(0,v.jsx)("div",{style:{fontWeight:700,marginTop:10},children:"Resetting password..."}),(0,v.jsx)("div",{className:"small muted",style:{marginTop:6},children:"Please wait."})]})]}):null,$?(0,v.jsx)("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true",children:(0,v.jsxs)("div",{className:"modal",children:[(0,v.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Reset Password"}),(0,v.jsx)("div",{className:"small",style:{marginBottom:12},children:"Generate a new temporary password for ".concat($.email,"? The user will be forced to change it on next login.")}),(0,v.jsxs)("div",{className:"row",style:{justifyContent:"flex-end"},children:[(0,v.jsx)("button",{className:"btn",onClick:()=>ee(null),disabled:Boolean(ie),children:"Cancel"}),(0,v.jsx)("button",{className:"btn primary",onClick:()=>{const e=$;ee(null),async function(e){if(null!==e&&void 0!==e&&e.id&&!ie){ae(e.id);try{const s=await zl(e.id);le({id:e.id,email:e.email,full_name:e.full_name||null,temporary_password:s.temporary_password}),await ql(),o.oR.success("Temporary password generated")}catch(s){o.oR.error(s.message||"Reset failed")}finally{ae(null)}}}(e)},disabled:Boolean(ie),children:"Confirm"})]})]})}):null,se?(0,v.jsx)("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true",children:(0,v.jsxs)("div",{className:"modal",style:{maxWidth:560},children:[(0,v.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Temporary Password"}),(0,v.jsx)("div",{className:"small",style:{marginBottom:10},children:"Share this password securely with the user. It will only be shown once here."}),(0,v.jsxs)("div",{className:"card",style:{padding:12,background:"rgba(0,0,0,.03)"},children:[(0,v.jsxs)("div",{className:"small",style:{marginBottom:6},children:["User: ",(0,v.jsx)("strong",{children:se.email})]}),(0,v.jsxs)("div",{className:"row",style:{alignItems:"center",justifyContent:"space-between"},children:[(0,v.jsx)("div",{style:{fontFamily:"ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace",fontSize:18},children:se.temporary_password}),(0,v.jsx)("button",{className:"btn",onClick:()=>async function(e){const s=String(e||"");if(s){try{return await navigator.clipboard.writeText(s),void o.oR.success("Copied")}catch(l){}try{const e=document.createElement("textarea");e.value=s,e.style.position="fixed",e.style.left="-9999px",document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),o.oR.success("Copied")}catch(i){o.oR.error("Copy failed")}}}(se.temporary_password),children:"Copy"})]})]}),(0,v.jsx)("div",{className:"row",style:{justifyContent:"flex-end",marginTop:12},children:(0,v.jsx)("button",{className:"btn primary",onClick:()=>le(null),children:"Done"})})]})}):null,Os?(0,v.jsx)("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true",children:(0,v.jsxs)("div",{className:"modal",children:[(0,v.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"approve"===Os.action?"Approve Scenario":"Request Revision"}),(0,v.jsxs)("div",{className:"small",style:{marginBottom:12},children:[null!==(l=Os.row)&&void 0!==l&&null!==(i=l.school)&&void 0!==i&&i.name?"".concat(Os.row.school.name," - "):"",(null===(p=Os.row)||void 0===p||null===(_=p.scenario)||void 0===_?void 0:_.name)||"Scenario"]}),"approve"===Os.action?(0,v.jsxs)("div",{style:{marginBottom:10},children:[(0,v.jsx)("div",{className:"small",style:{marginBottom:6},children:"Included years"}),(0,v.jsx)("div",{className:"row",children:x.map(e=>(0,v.jsxs)("label",{className:"small",style:{display:"inline-flex",gap:6},children:[(0,v.jsx)("input",{type:"checkbox",checked:Js[e],onChange:s=>Qs(l=>(0,a.A)((0,a.A)({},l),{},{[e]:s.target.checked}))}),e.toUpperCase()]},e))})]}):null,"revise"===Os.action?(0,v.jsxs)("div",{style:{marginBottom:10},children:[(0,v.jsx)("div",{className:"small",style:{marginBottom:6},children:"Sadece se\xe7ilen mod\xfcller revizeye a\xe7\u0131lacak (editable)."}),(0,v.jsxs)("div",{className:"row",style:{flexWrap:"wrap",gap:8},children:[g.map(e=>(0,v.jsxs)("label",{className:"small",style:{display:"inline-flex",gap:6,alignItems:"center"},children:[(0,v.jsx)("input",{type:"checkbox",checked:Boolean(Vs[e]),onChange:s=>Xs(l=>(0,a.A)((0,a.A)({},l),{},{[e]:s.target.checked}))}),y[e]||e]},e)),(0,v.jsx)("button",{type:"button",className:"btn sm",onClick:Zs,children:"T\xfcm\xfcn\xfc se\xe7"}),(0,v.jsx)("button",{type:"button",className:"btn sm",onClick:$s,children:"Temizle"})]})]}):null,(0,v.jsxs)("div",{style:{marginBottom:12},children:[(0,v.jsxs)("div",{className:"small",style:{marginBottom:6},children:["Note ","revise"===Os.action?"(required)":"(optional)"]}),(0,v.jsx)("textarea",{className:"input",style:{width:"100%",minHeight:90},value:zs,onChange:e=>Gs(e.target.value)})]}),(0,v.jsxs)("div",{className:"row",style:{justifyContent:"flex-end"},children:[(0,v.jsx)("button",{className:"btn",onClick:Ql,children:"Cancel"}),(0,v.jsx)("button",{className:"btn primary",onClick:async()=>{var e,s;if(null===Os||void 0===Os||null===(e=Os.row)||void 0===e||null===(s=e.scenario)||void 0===s||!s.id)return;const l=Os.action,i=zs.trim();if("revise"===l&&!i)return void o.oR.error("Note is required for revision requests");const a={action:l,note:i||null};if("approve"===l){const e=x.filter(e=>Js[e]);if(!e.length)return void o.oR.error("Select at least one year");a.includedYears=e}else if("revise"===l){const e=g.filter(e=>Vs[e]);if(!e.length)return void o.oR.error("Select at least one module");a.revisionWorkIds=e}sl(!0);try{await d.FH.adminReviewScenario(Os.row.scenario.id,a),o.oR.success("approve"===l?"Scenario approved":"Revision requested"),Ql(),await Ol()}catch(n){o.oR.error(n.message||"Review failed")}finally{sl(!1)}},disabled:el,children:el?"Saving...":"approve"===Os.action?"Approve":"Request Revision"})]})]})}):null,"users"===W&&(0,v.jsxs)(v.Fragment,{children:[(0,v.jsxs)("div",{style:{marginTop:12,display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(320px, 1fr))",gap:12},children:[(0,v.jsxs)("div",{className:"card",children:[(0,v.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Create User"}),(0,v.jsxs)("div",{className:"row",children:[(0,v.jsx)("input",{className:"input",placeholder:"Full name",value:ue,onChange:e=>me(e.target.value)}),(0,v.jsx)("input",{className:"input",placeholder:"Email",value:he,onChange:e=>pe(e.target.value)}),(0,v.jsx)("input",{className:"input",placeholder:"Temporary password",type:"password",value:ve,onChange:e=>xe(e.target.value)}),(0,v.jsxs)("select",{className:"input sm",value:ge,onChange:e=>ye(e.target.value),children:[(0,v.jsx)("option",{value:"user",children:"User"}),(0,v.jsx)("option",{value:"admin",children:"Admin"}),(0,v.jsx)("option",{value:"principal",children:"Principal"}),(0,v.jsx)("option",{value:"hr",children:"HR"}),(0,v.jsx)("option",{value:"manager",children:"Manager"}),(0,v.jsx)("option",{value:"accountant",children:"Accountant"})]}),(0,v.jsxs)("select",{className:"input",value:je,onChange:e=>be(e.target.value),children:[(0,v.jsx)("option",{value:"",children:"Assign country (optional)"}),q.map(e=>(0,v.jsxs)("option",{value:e.id,children:[e.name," (",e.code,")",e.region?" - ".concat(e.region):""]},e.id))]}),(0,v.jsx)("button",{className:"btn primary",onClick:async function(){const e={fullName:ue.trim()||null,email:he.trim(),password:ve,role:ge};if(je){const s=Number(je);if(!Number.isFinite(s))return void o.oR.error("Invalid country selection");e.countryId=s}if(e.email&&e.password)if(e.password.length<8)o.oR.error("Password must be at least 8 characters");else try{await d.FH.createUser(e),me(""),pe(""),xe(""),ye("user"),be(""),await ql(),o.oR.success("User created (password reset required on first login)")}catch(s){o.oR.error(s.message||"Create user failed")}else o.oR.error("Email and password are required")},disabled:D,children:(0,v.jsxs)("span",{className:"row",style:{gap:6,alignItems:"center"},children:[(0,v.jsx)(c.NPy,{"aria-hidden":"true"}),(0,v.jsx)("span",{children:"Create"})]})})]}),(0,v.jsx)("div",{className:"small",style:{marginTop:8},children:"New users must reset their password on first login."})]}),(0,v.jsxs)("div",{className:"card",children:[(0,v.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Assign / Edit User Country"}),(0,v.jsx)("div",{className:"small",style:{marginBottom:6},children:xl?"Editing: ".concat(xl.email).concat(xl.full_name?" (".concat(xl.full_name,")"):""," #").concat(xl.id):"Select a user to assign or edit."}),(0,v.jsxs)("div",{className:"row",children:[(0,v.jsxs)("select",{className:"input",value:fe,onChange:e=>Ne(e.target.value),children:[(0,v.jsx)("option",{value:"",children:"Select user"}),K.map(e=>(0,v.jsxs)("option",{value:e.id,children:[e.email," ",e.full_name?"(".concat(e.full_name,")"):""," #",e.id]},e.id))]}),(0,v.jsxs)("select",{className:"input",value:Se,onChange:e=>we(e.target.value),children:[(0,v.jsx)("option",{value:"",children:"Select country"}),q.map(e=>(0,v.jsxs)("option",{value:e.id,children:[e.name," (",e.code,") - ",e.region]},e.id))]}),(0,v.jsx)("button",{className:"btn primary",onClick:async function(){if(!xl)return void o.oR.error("Select a user");if(!Se)return void o.oR.error("Select a country");if(G)return;const e=Number(Se);if(Number.isFinite(e))if(Nl)o.oR.error("Selected country is already assigned to this user");else{if(null!=xl.country_id){const s=xl.country_name?"".concat(xl.country_name," (").concat(xl.country_code,")"):"Unassigned",l=gl?"".concat(gl.name," (").concat(gl.code,")"):"#".concat(e);return void V({userId:xl.id,nextId:e,email:xl.email,currentLabel:s,nextLabel:l,hadCountry:!0})}J(!0);try{await d.FH.assignUserCountry(fe,{countryId:e}),await ql(),o.oR.success("User assigned")}catch(s){o.oR.error(s.message||"Assignment failed")}finally{J(!1)}}else o.oR.error("Invalid country selection")},disabled:D||G||!fe||!Se||Nl,children:G?"Updating...":Cl})]}),(0,v.jsxs)("div",{className:"small",style:{marginTop:8},children:[(0,v.jsxs)("div",{children:["Current: ",Sl]}),(0,v.jsxs)("div",{children:["New: ",wl]}),xl&&gl&&null!=xl.country_id&&!Nl?(0,v.jsx)("div",{style:{color:"#b45309"},children:"You are changing this user's assignment."}):null,Nl?(0,v.jsx)("div",{style:{color:"#6b7280"},children:"Selected country matches current assignment."}):null,"Users must re-login after assignment to refresh their token."]})]})]}),(0,v.jsxs)("div",{className:"card",children:[(0,v.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Permissions"}),xl?Ss?(0,v.jsx)("div",{className:"small",children:"Loading permissions..."}):(0,v.jsxs)(v.Fragment,{children:[(0,v.jsxs)("div",{style:{marginBottom:8},children:[(0,v.jsx)("label",{className:"small",style:{marginRight:8},children:"Role:"}),(0,v.jsx)("select",{className:"input sm",value:(null===xl||void 0===xl?void 0:xl.role)||"user",onChange:e=>async function(s){if(xl){Ts(!0);try{await d.FH.adminUpdateUserRole(xl.id,{role:s}),await ql(),Ne(String(xl.id)),o.oR.success("Role updated")}catch(e){o.oR.error((null===e||void 0===e?void 0:e.message)||"Failed to update role")}finally{Ts(!1)}}}(e.target.value),disabled:Fs,children:Rs.map(e=>(0,v.jsx)("option",{value:e.value,children:e.label},e.value))})]}),0===Object.keys(Al).length?(0,v.jsx)("div",{className:"small",children:"No permissions defined."}):Object.entries(Al).map(e=>{let[s,l]=e;return(0,v.jsxs)("div",{style:{marginBottom:12},children:[(0,v.jsx)("div",{style:{fontWeight:600,marginBottom:4},children:s}),l.map(e=>{const s="".concat(e.resource,"|").concat(e.action),l=Boolean(js[s]),i=fs[s]||"country";return(0,v.jsxs)("div",{className:"row",style:{alignItems:"center",marginBottom:4},children:[(0,v.jsxs)("label",{className:"small",style:{flexGrow:1,display:"flex",alignItems:"center",gap:6},children:[(0,v.jsx)("input",{type:"checkbox",checked:l,onChange:()=>function(e){bs(s=>{const l=(0,a.A)({},s);return l[e]=!s[e],l}),Ns(s=>js[e]||s[e]?s:(0,a.A)((0,a.A)({},s),{},{[e]:"country"}))}(s)}),e.label]}),(0,v.jsxs)("select",{className:"input sm",disabled:!l,value:i,onChange:e=>function(e,s){Ns(l=>(0,a.A)((0,a.A)({},l),{},{[e]:s}))}(s,e.target.value),children:[(0,v.jsx)("option",{value:"country",children:"Country"}),_s&&_s.map(e=>(0,v.jsx)("option",{value:"school:".concat(e.id),children:e.name},e.id))]})]},s)})]},s)}),(0,v.jsx)("div",{className:"row",style:{marginTop:8},children:(0,v.jsx)("button",{className:"btn primary",onClick:async function(){if(!xl)return void o.oR.error("Select a user to edit permissions");const e=[];Object.keys(js||{}).forEach(s=>{if(!js[s])return;const[l,i]=s.split("|");let a=fs[s]||"country",n=null,t=null;if("country"===a)null!=xl.country_id&&(n=Number(xl.country_id));else if(a.startsWith("school:")){const e=a.split(":")[1],s=Number(e);Number.isFinite(s)&&(t=s),null!=xl.country_id&&(n=Number(xl.country_id))}e.push({resource:l,action:i,scope_country_id:n,scope_school_id:t})}),ks(!0);try{await d.FH.adminSetUserPermissions(xl.id,{permissions:e});const s=await d.FH.adminGetUserPermissions(xl.id),l={},i={};(s||[]).forEach(e=>{const s="".concat(e.resource,"|").concat(e.action);l[s]=!0,null!=e.scope_school_id?i[s]="school:".concat(e.scope_school_id):i[s]="country"}),bs(l),Ns(i),o.oR.success("Permissions saved")}catch(s){o.oR.error((null===s||void 0===s?void 0:s.message)||"Save permissions failed")}finally{ks(!1)}},disabled:Cs,children:Cs?"Saving...":"Save Permissions"})})]}):(0,v.jsx)("div",{className:"small",children:"Select a user above to edit permissions."})]}),(0,v.jsxs)("div",{className:"card",style:{marginTop:12},children:[(0,v.jsxs)("div",{className:"row",style:{justifyContent:"space-between"},children:[(0,v.jsx)("div",{style:{fontWeight:700},children:"Users"}),(0,v.jsxs)("label",{className:"small",children:[(0,v.jsx)("input",{type:"checkbox",checked:Ce,onChange:e=>ke(e.target.checked)})," ","Unassigned only"]})]}),(0,v.jsxs)("table",{className:"table",style:{marginTop:8},children:[(0,v.jsx)("thead",{children:(0,v.jsxs)("tr",{children:[(0,v.jsx)("th",{children:"ID"}),(0,v.jsx)("th",{children:"Name"}),(0,v.jsx)("th",{children:"Email"}),(0,v.jsx)("th",{children:"Role"}),(0,v.jsx)("th",{children:"Reset"}),(0,v.jsx)("th",{children:"Country"}),(0,v.jsx)("th",{children:"Region"}),(0,v.jsx)("th",{children:"Actions"})]})}),(0,v.jsx)("tbody",{children:0===kl.length?(0,v.jsx)("tr",{children:(0,v.jsx)("td",{colSpan:"8",className:"small",children:"No users found."})}):kl.map(e=>(0,v.jsxs)("tr",{children:[(0,v.jsx)("td",{className:"small",children:e.id}),(0,v.jsx)("td",{children:e.full_name||"-"}),(0,v.jsx)("td",{children:e.email}),(0,v.jsx)("td",{className:"small",children:e.role}),(0,v.jsx)("td",{children:e.must_reset_password?(0,v.jsx)("span",{className:"badge",children:"Yes"}):(0,v.jsx)("span",{className:"small",children:"No"})}),(0,v.jsx)("td",{children:e.country_name?(0,v.jsxs)("span",{children:[e.country_name," (",e.country_code,")"]}):(0,v.jsx)("span",{className:"badge",children:"Unassigned"})}),(0,v.jsx)("td",{children:e.region||"-"}),(0,v.jsx)("td",{children:(0,v.jsxs)("div",{className:"row",children:[(0,v.jsx)("button",{className:"btn",onClick:()=>Ne(String(e.id)),children:"Edit"}),(0,v.jsx)("button",{className:"btn",onClick:()=>async function(e){null!==e&&void 0!==e&&e.id&&ee({id:e.id,email:e.email,full_name:e.full_name||null})}(e),disabled:Boolean(ie),children:"Reset password"}),(0,v.jsx)("button",{className:"btn",onClick:()=>async function(e){if(!e||!e.id)return;const s=e.email||"User #".concat(e.id);Z({id:e.id,label:s})}(e),children:"Delete"})]})})]},e.id))})]}),(0,v.jsx)("div",{className:"small",style:{marginTop:8},children:"Delete is blocked if the user has created or updated records."})]})]}),"countries"===W&&(0,v.jsxs)(v.Fragment,{children:[(0,v.jsxs)("div",{className:"card",style:{marginTop:12},children:[(0,v.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Create Country"}),(0,v.jsxs)("div",{className:"row",children:[(0,v.jsx)("input",{className:"input",placeholder:"Country name",value:ne,onChange:e=>te(e.target.value)}),(0,v.jsx)("input",{className:"input sm",placeholder:"Code",value:re,onChange:e=>oe(e.target.value.toUpperCase())}),(0,v.jsx)("input",{className:"input",placeholder:"Region",value:ce,onChange:e=>de(e.target.value)}),(0,v.jsx)("button",{className:"btn primary",onClick:async function(){const e={name:ne.trim(),code:re.trim().toUpperCase(),region:ce.trim()};if(e.name&&e.code&&e.region)try{await d.FH.createCountry(e),te(""),oe(""),de(""),await ql(),o.oR.success("Country created")}catch(s){o.oR.error(s.message||"Create country failed")}else o.oR.error("Name, code, and region are required")},disabled:D,children:"Create"})]})]}),(0,v.jsxs)("div",{className:"card",style:{marginTop:12},children:[(0,v.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Countries"}),(0,v.jsxs)("table",{className:"table",children:[(0,v.jsx)("thead",{children:(0,v.jsxs)("tr",{children:[(0,v.jsx)("th",{children:"ID"}),(0,v.jsx)("th",{children:"Name"}),(0,v.jsx)("th",{children:"Code"}),(0,v.jsx)("th",{children:"Region"})]})}),(0,v.jsx)("tbody",{children:0===q.length?(0,v.jsx)("tr",{children:(0,v.jsx)("td",{colSpan:"4",className:"small",children:"No countries yet."})}):q.map(e=>(0,v.jsxs)("tr",{children:[(0,v.jsx)("td",{className:"small",children:e.id}),(0,v.jsx)("td",{children:e.name}),(0,v.jsx)("td",{className:"small",children:e.code}),(0,v.jsx)("td",{children:e.region})]},e.id))})]})]}),(0,v.jsxs)("div",{className:"card",style:{marginTop:12},children:[(0,v.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Country Schools"}),(0,v.jsxs)("div",{className:"row",style:{marginBottom:10},children:[(0,v.jsxs)("select",{className:"input",value:_e,onChange:e=>Ae(e.target.value),children:[(0,v.jsx)("option",{value:"",children:"Select a country"}),q.map(e=>(0,v.jsx)("option",{value:e.id,children:e.name},e.id))]}),(0,v.jsx)("input",{className:"input",placeholder:"Search schools",value:Be,onChange:e=>Ee(e.target.value),disabled:!_e})]}),(0,v.jsxs)("div",{className:"row",style:{marginBottom:10},children:[(0,v.jsx)("input",{className:"input",placeholder:"New school name",value:Le,onChange:e=>Me(e.target.value),disabled:!_e||Wl}),(0,v.jsx)("button",{className:"btn primary",onClick:async function(){if(!_e)return void o.oR.error("Select a country");const e=Le.trim();if(e){Ue(!0);try{await d.FH.adminCreateCountrySchool(_e,{name:e}),Me(""),await Yl(_e),o.oR.success("School created")}catch(s){o.oR.error(s.message||"Create school failed")}finally{Ue(!1)}}else o.oR.error("School name is required")},disabled:!_e||Wl,children:(0,v.jsxs)("span",{className:"row",style:{gap:6,alignItems:"center"},children:[(0,v.jsx)(c.iM1,{"aria-hidden":"true"}),(0,v.jsx)("span",{children:Pe?"Creating...":"Create"})]})})]}),(0,v.jsxs)("div",{style:{marginBottom:12,paddingTop:8,borderTop:"1px solid #eef2f7"},children:[(0,v.jsx)("div",{className:"small",style:{fontWeight:700,marginBottom:6},children:"Bulk add schools"}),(0,v.jsx)("div",{style:{display:"grid",gap:6},children:qe.map((e,s)=>(0,v.jsxs)("div",{className:"row",children:[(0,v.jsx)("input",{className:"input",placeholder:"School name #".concat(s+1),value:e,onChange:e=>{return l=s,i=e.target.value,void Ye(e=>{const s=[...e];return s[l]=i,s});var l,i},disabled:!_e||Wl}),(0,v.jsx)("button",{className:"btn",type:"button",onClick:()=>{return e=s,void Ye(s=>s.length<=1?s:s.filter((s,l)=>l!==e));var e},disabled:!_e||Wl||qe.length<=1,children:"Remove"})]},"school-create-row-".concat(s)))}),(0,v.jsxs)("div",{className:"row",style:{marginTop:8},children:[(0,v.jsx)("button",{className:"btn",type:"button",onClick:function(){Ye(e=>[...e,""])},disabled:!_e||Wl,children:"Add row"}),(0,v.jsx)("button",{className:"btn primary",type:"button",onClick:async function(){if(!_e)return void o.oR.error("Select a country");const e=qe.map(e=>String(e||"").trim()).filter(Boolean),s=Array.from(new Set(e));if(!s.length)return void o.oR.error("At least one school name is required");He(!0);const l=[];let i=0;try{for(const e of s)try{await d.FH.adminCreateCountrySchool(_e,{name:e}),i+=1}catch(a){l.push({name:e,message:(null===a||void 0===a?void 0:a.message)||"Create school failed"})}i>0&&await Yl(_e),l.length?(o.oR.error("".concat(l.length," of ").concat(s.length," schools failed")),Ye(l.map(e=>e.name))):(o.oR.success("".concat(i," schools created")),Ye([""]))}finally{He(!1)}},disabled:!_e||Wl||0===Hl,children:(0,v.jsxs)("span",{className:"row",style:{gap:6,alignItems:"center"},children:[(0,v.jsx)(c.iM1,{"aria-hidden":"true"}),(0,v.jsx)("span",{children:We?"Creating...":"Create ".concat(Hl||"").trim()})]})})]}),(0,v.jsx)("div",{className:"small",style:{marginTop:6,color:"#6b7280"},children:"Add one school per row, then create all at once."})]}),yl?(0,v.jsxs)("table",{className:"table",children:[(0,v.jsx)("thead",{children:(0,v.jsxs)("tr",{children:[(0,v.jsx)("th",{children:"Name"}),(0,v.jsx)("th",{children:"Status"}),(0,v.jsx)("th",{children:"Created At"}),(0,v.jsx)("th",{children:"Closed At"}),(0,v.jsx)("th",{children:"Principals"}),(0,v.jsx)("th",{children:"Actions"})]})}),(0,v.jsx)("tbody",{children:Te?(0,v.jsx)("tr",{children:(0,v.jsx)("td",{colSpan:"6",className:"small",children:"Loading..."})}):0===Ul.length?(0,v.jsx)("tr",{children:(0,v.jsx)("td",{colSpan:"6",className:"small",children:"No schools found."})}):Ul.map(e=>{var s,l;const i="closed"===e.status?{label:"Closed",className:"is-muted"}:{label:"Active",className:"is-ok"};const n=null!==(s=null!==(l=De[e.id])&&void 0!==l?l:e.name)&&void 0!==s?s:"",t=Ke===e.id;return(0,v.jsxs)("tr",{children:[(0,v.jsx)("td",{children:e.name}),(0,v.jsx)("td",{children:(0,v.jsx)("span",{className:"status-badge ".concat(i.className),children:i.label})}),(0,v.jsx)("td",{className:"small",children:w(e.created_at)}),(0,v.jsx)("td",{className:"small",children:w(e.closed_at)}),(0,v.jsx)("td",{children:Array.isArray(Is[e.id])&&Is[e.id].length>0?(0,v.jsx)("span",{children:Is[e.id].map(e=>e.full_name||e.email).join(", ")}):(0,v.jsx)("span",{className:"small muted",children:"-"})}),(0,v.jsxs)("td",{children:[(0,v.jsxs)("div",{className:"row",children:[(0,v.jsx)("input",{className:"input sm",value:n,onChange:s=>ze(l=>(0,a.A)((0,a.A)({},l),{},{[e.id]:s.target.value})),disabled:t}),(0,v.jsx)("button",{className:"btn primary",onClick:()=>async function(e){if(null===e||void 0===e||!e.id)return;const s=De[e.id],l=String(null!=s?s:e.name||"").trim();if(l){if(l!==e.name){Oe(e.id);try{await d.FH.adminUpdateSchool(e.id,{name:l}),await Yl(_e),ze(s=>(0,a.A)((0,a.A)({},s),{},{[e.id]:l})),o.oR.success("School updated")}catch(i){o.oR.error(i.message||"Update failed")}finally{Oe(null)}}}else o.oR.error("Name is required")}(e),disabled:t,children:"Save"}),(0,v.jsx)("button",{className:"btn",onClick:()=>async function(e){if(null===e||void 0===e||!e.id)return;const s="closed"===e.status?"active":"closed";Oe(e.id);try{await d.FH.adminUpdateSchool(e.id,{status:s}),await Yl(_e),o.oR.success("closed"===s?"School closed":"School reopened")}catch(l){o.oR.error(l.message||"Update failed")}finally{Oe(null)}}(e),disabled:t,children:"closed"===e.status?"Reopen":"Close"})]}),(0,v.jsxs)("div",{className:"row",style:{marginTop:4},children:[(0,v.jsx)("select",{multiple:!0,className:"input sm",value:(Es[e.id]||[]).map(String),onChange:s=>{const l=Array.from(s.target.selectedOptions||[]).map(e=>e.value);!function(e,s){const l=s.map(e=>Number(e)).filter(e=>Number.isFinite(e));Ls(s=>(0,a.A)((0,a.A)({},s),{},{[e]:l}))}(e.id,l)},children:K.filter(e=>"principal"===e.role).map(e=>(0,v.jsxs)("option",{value:e.id,children:[e.email," ",e.full_name?"(".concat(e.full_name,")"):""," #",e.id]},e.id))}),(0,v.jsx)("button",{className:"btn",onClick:()=>async function(e){const s=Es[e]||[];Ps(s=>(0,a.A)((0,a.A)({},s),{},{[e]:!0}));try{await d.FH.adminSetSchoolPrincipals(e,{userIds:s});const l=K.filter(e=>"principal"===e.role&&s.includes(e.id));Bs(s=>(0,a.A)((0,a.A)({},s),{},{[e]:l})),o.oR.success("Principals updated")}catch(l){o.oR.error((null===l||void 0===l?void 0:l.message)||"Failed to update principals")}finally{Ps(s=>(0,a.A)((0,a.A)({},s),{},{[e]:!1}))}}(e.id),disabled:Boolean(Ms[e.id]),children:Ms[e.id]?"Saving...":"Save"})]})]})]},e.id)})})]}):(0,v.jsx)("div",{className:"small",children:"Select a country to manage its schools."})]})]}),"progress"===W&&(0,v.jsxs)("div",{style:{marginTop:12},children:[(0,v.jsx)("div",{className:"card",children:(0,v.jsxs)("div",{className:"row",style:{justifyContent:"space-between",alignItems:"center"},children:[(0,v.jsxs)("div",{children:[(0,v.jsx)("div",{style:{fontWeight:700},children:"Progress Tracking"}),(0,v.jsx)("div",{className:"small",children:"Configure per-field requirements by country."})]}),(0,v.jsxs)("div",{className:"row",children:[(0,v.jsxs)("select",{className:"input sm",value:Ge,onChange:e=>Je(e.target.value),children:[(0,v.jsx)("option",{value:"",children:"Select country"}),q.map(e=>(0,v.jsx)("option",{value:e.id,children:e.name},e.id))]}),(0,v.jsx)("input",{className:"input sm",placeholder:"Search fields",value:ss,onChange:e=>ls(e.target.value)}),(0,v.jsx)("button",{className:"btn primary",onClick:async()=>{if(Ge){es(!0);try{const e=await d.FH.adminSaveProgressRequirements(Ge,fl);Ve(k((null===e||void 0===e?void 0:e.config)||e)),o.oR.success("Progress requirements saved")}catch(e){o.oR.error(e.message||"Failed to save progress requirements")}finally{es(!1)}}else o.oR.error("Select a country")},disabled:!Ge||$e||Xe,children:$e?"Saving...":"Save"})]})]})}),(0,v.jsxs)("div",{className:"card",style:{marginTop:12},children:[(0,v.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"Apply to multiple countries"}),(0,v.jsxs)("div",{className:"row",style:{alignItems:"center",flexWrap:"wrap",marginBottom:10},children:[(0,v.jsx)("input",{className:"input sm",placeholder:"Search countries",value:ns,onChange:e=>ts(e.target.value)}),(0,v.jsx)("button",{className:"btn",onClick:()=>{as(e=>{const s=new Set(e);return Ll.forEach(e=>{const l=Number(e.id);Number.isFinite(l)&&s.add(l)}),s})},disabled:0===Ll.length||rs,children:"Select all"}),(0,v.jsx)("button",{className:"btn",onClick:()=>{as(new Set)},disabled:0===Ml||rs,children:"Clear"}),(0,v.jsx)("button",{className:"btn primary",onClick:async()=>{const e=Array.from(is).map(e=>Number(e)).filter(e=>Number.isFinite(e)),s=Array.from(new Set(e));if(!s.length)return void o.oR.error("Select at least one country");if(!Ge)return void o.oR.error("Select a country to edit rules first");if(window.confirm("Apply this configuration to ".concat(s.length," countries? This will overwrite their current rules."))){os(!0);try{const e=await d.FH.adminBulkSaveProgressRequirements(s,fl),l=Number.isFinite(Number(null===e||void 0===e?void 0:e.updatedCount))?Number(e.updatedCount):s.length;o.oR.success("Applied to ".concat(l," countries")),s.some(e=>String(e)===String(Ge))&&await Kl(Ge)}catch(l){o.oR.error(l.message||"Failed to apply progress requirements")}finally{os(!1)}}},disabled:Pl,children:rs?"Applying...":"Apply to Selected (".concat(Ml,")")})]}),(0,v.jsx)("div",{style:{border:"1px solid #e5e7eb",borderRadius:10,padding:10,background:"#fff",maxHeight:240,overflowY:"auto"},children:0===Ll.length?(0,v.jsx)("div",{className:"small",children:"No countries found."}):Ll.map(e=>{const s=Number(e.id),l=is.has(s);return(0,v.jsxs)("label",{style:{display:"flex",gap:8,alignItems:"center",padding:"6px 0"},children:[(0,v.jsx)("input",{type:"checkbox",checked:l,onChange:()=>(e=>{const s=Number(e);Number.isFinite(s)&&as(e=>{const l=new Set(e);return l.has(s)?l.delete(s):l.add(s),l})})(s)}),(0,v.jsx)("span",{children:e.name||"-"})]},e.id)})})]}),Ge?(0,v.jsx)("div",{className:"card",style:{marginTop:12},children:Xe?(0,v.jsx)("div",{className:"small",children:"Loading..."}):(0,v.jsx)("div",{style:{display:"grid",gap:12},children:bl.tabs.map(e=>{const s=bl.sections.filter(s=>s.tabKey===e.key),l=s.filter(e=>{if(!El)return!0;const s=String(e.label||"").toLowerCase().includes(El),l=(e.fields||[]).map(e=>bl.fieldsById[e]).filter(Boolean).some(e=>{const s=String(e.label||"").toLowerCase(),l=String(e.id||"").toLowerCase();return s.includes(El)||l.includes(El)});return s||l});if(!l.length)return null;const i=us.has(e.key)||Boolean(El);return(0,v.jsxs)("div",{style:{border:"1px solid #e5e7eb",borderRadius:10,padding:10},children:[(0,v.jsxs)("div",{className:"row",style:{justifyContent:"space-between"},children:[(0,v.jsxs)("div",{className:"row",children:[(0,v.jsx)("button",{type:"button",className:"btn",onClick:()=>{return s=e.key,void ms(e=>{const l=new Set(e);return l.has(s)?l.delete(s):l.add(s),l});var s},children:i?"-":"+"}),(0,v.jsx)("div",{style:{fontWeight:700},children:e.label})]}),(0,v.jsxs)("div",{className:"small",children:[s.length," sections"]})]}),i?(0,v.jsx)("div",{style:{display:"grid",gap:10,marginTop:10},children:l.map(e=>{var s;const l=(null===(s=fl.sections)||void 0===s?void 0:s[e.id])||{},i=!1!==l.enabled,n=String(l.mode||e.modeDefault||"ALL").toUpperCase(),t=Number.isFinite(Number(l.min))&&Number(l.min)>0?Number(l.min):e.minDefault||1,r=(e.fields||[]).map(e=>bl.fieldsById[e]).filter(Boolean),o=El?r.filter(e=>{const s=String(e.label||"").toLowerCase(),l=String(e.id||"").toLowerCase();return s.includes(El)||l.includes(El)}):r;if(!o.length&&El)return null;const c=hs.has(e.id)||Boolean(El),d=(El?o:r).map(e=>e.id),u=r.filter(e=>{var s;return!1!==(null===(s=l.selectedFields)||void 0===s?void 0:s[e.id])}).length,m=r.length,h=Boolean(cs[e.id]),p=h?o.filter(e=>{var s;return!1!==(null===(s=l.selectedFields)||void 0===s?void 0:s[e.id])}):o,x="MIN"===n?t:null,g="MIN"===n&&x>u,y="ALL"===n?"\u2705 Rule: Must complete ALL selected fields (".concat(u," selected)"):g?"\u26a0\ufe0f MIN (".concat(x,") is greater than selected (").concat(u,"). It will behave like ALL."):"\u2705 Rule: Must complete AT LEAST ".concat(x," of ").concat(u," selected fields"),j="MIN"===n?x:u;return(0,v.jsxs)("div",{style:{borderTop:"1px solid #eef2f7",paddingTop:10},children:[(0,v.jsxs)("div",{className:"row",style:{justifyContent:"space-between",alignItems:"center"},children:[(0,v.jsxs)("div",{className:"row",children:[(0,v.jsx)("button",{type:"button",className:"btn",onClick:()=>{return s=e.id,void ps(e=>{const l=new Set(e);return l.has(s)?l.delete(s):l.add(s),l});var s},children:c?"-":"+"}),(0,v.jsx)("div",{style:{fontWeight:700},children:e.label}),(0,v.jsx)("span",{className:"status-badge ".concat(i?"is-ok":"is-muted"),children:i?"Enabled":"Disabled"}),(0,v.jsxs)("span",{className:"small",children:[u,"/",r.length||0," selected"]})]}),(0,v.jsxs)("div",{className:"row",children:[(0,v.jsxs)("label",{className:"small",children:[(0,v.jsx)("input",{type:"checkbox",checked:h,onChange:()=>ds(s=>(0,a.A)((0,a.A)({},s),{},{[e.id]:!(null!==s&&void 0!==s&&s[e.id])}))})," ","Show only selected"]}),(0,v.jsxs)("label",{className:"small",children:[(0,v.jsx)("input",{type:"checkbox",checked:i,onChange:s=>{return l=e.id,i=s.target.checked,void Gl(l,e=>{e.enabled=!!i});var l,i}})," ","Enabled"]}),(0,v.jsxs)("select",{className:"input xs",value:n,onChange:s=>{return l=e.id,i=s.target.value,void Gl(l,e=>{e.mode=i});var l,i},children:[(0,v.jsx)("option",{value:"ALL",children:"ALL"}),(0,v.jsx)("option",{value:"MIN",children:"MIN"})]}),"MIN"===n?(0,v.jsx)("input",{className:"input xs",type:"number",min:"1",value:t,onChange:s=>((e,s)=>{const l=Number(s);Gl(e,e=>{e.min=Number.isFinite(l)?Math.max(1,l):1})})(e.id,s.target.value)}):null,(0,v.jsx)("button",{className:"btn",onClick:()=>{return s=e.id,l=d,void Gl(s,e=>{e.selectedFields||(e.selectedFields={}),l.forEach(s=>{e.selectedFields&&delete e.selectedFields[s]})});var s,l},disabled:!d.length,children:"Select all"}),(0,v.jsx)("button",{className:"btn",onClick:()=>{return s=e.id,l=d,void Gl(s,e=>{e.selectedFields||(e.selectedFields={}),l.forEach(s=>{e.selectedFields&&(e.selectedFields[s]=!1)})});var s,l},disabled:!d.length,children:"Unselect all"})]})]}),(0,v.jsx)("div",{className:"small",style:{marginTop:6},children:y}),(0,v.jsxs)("div",{className:"small",style:{marginTop:4,color:"#6b7280"},children:["Selected: ",u,"/",m," \xb7 Mode: ",n," \xb7 Required: ",j]}),c?(0,v.jsx)("div",{style:{marginTop:8},children:p.length?(0,v.jsx)("div",{className:"grid2",style:{gap:8},children:p.map(s=>{var a;const n=!1!==(null===(a=l.selectedFields)||void 0===a?void 0:a[s.id]),t=((e,s)=>{if(!s)return null;const l=String(s.id||""),i=String(s.label||"");return"gradesPlan.plan"===e&&(l.startsWith("gradesPlan.")||i.includes("Plan "))?"grade":"ik.localStaff"===e&&l.startsWith("ik.headcount.")||"gelirler.unitFee"===e&&l.startsWith("gelirler.tuition.")?"type":null})(e.id,s);return(0,v.jsxs)("label",{className:"small",style:{display:"flex",gap:8,alignItems:"center",justifyContent:"space-between",width:"100%"},children:[(0,v.jsxs)("span",{style:{display:"inline-flex",gap:8,alignItems:"center"},children:[(0,v.jsx)("input",{type:"checkbox",checked:n,onChange:l=>((e,s,l)=>{Gl(e,e=>{e.selectedFields||(e.selectedFields={}),l?delete e.selectedFields[s]:e.selectedFields[s]=!1})})(e.id,s.id,l.target.checked),disabled:!i}),(0,v.jsx)("span",{children:s.label||s.id})]}),t?(0,v.jsxs)("span",{style:{padding:"2px 8px",borderRadius:999,background:"#eef2f7",color:"#374151",fontSize:11,lineHeight:1.4,whiteSpace:"nowrap"},children:["Dynamic: ",t]}):null]},s.id)})}):(0,v.jsx)("div",{className:"small",children:"No fields available for this section."})}):null]},e.id)})}):null]},e.key)})})}):(0,v.jsx)("div",{className:"card",style:{marginTop:12},children:(0,v.jsx)("div",{className:"small",children:"Select a country to edit progress rules."})})]}),"approvals"===W&&(0,v.jsxs)("div",{className:"card",style:{marginTop:12},children:[(0,v.jsxs)("div",{className:"row",style:{justifyContent:"space-between",alignItems:"flex-end"},children:[(0,v.jsxs)("div",{children:[(0,v.jsx)("div",{style:{fontWeight:700},children:"\xc7al\u0131\u015fma Listeleri"}),(0,v.jsx)("div",{className:"small",children:"Review submitted scenarios and approve for rollups."})]}),(0,v.jsxs)("div",{className:"row admin-filter-row",children:[(0,v.jsxs)("select",{className:"input sm",value:Hs.status,onChange:e=>qs(s=>(0,a.A)((0,a.A)({},s),{},{status:e.target.value})),children:[(0,v.jsx)("option",{value:"",children:"All"}),(0,v.jsx)("option",{value:"sent_for_approval",children:"Sent for approval"}),(0,v.jsx)("option",{value:"approved",children:"Approved"}),(0,v.jsx)("option",{value:"revision_requested",children:"Revision requested"}),(0,v.jsx)("option",{value:"draft",children:"Draft"})]}),(0,v.jsx)("input",{className:"input sm",placeholder:"Academic year",value:Hs.academicYear,onChange:e=>qs(s=>(0,a.A)((0,a.A)({},s),{},{academicYear:e.target.value}))}),(0,v.jsxs)("select",{className:"input sm",value:Hs.region,onChange:e=>qs(s=>(0,a.A)((0,a.A)({},s),{},{region:e.target.value,countryId:""})),children:[(0,v.jsx)("option",{value:"",children:"All regions"}),_l.map(e=>(0,v.jsx)("option",{value:e,children:e},e))]}),(0,v.jsxs)("select",{className:"input sm",value:Hs.countryId,onChange:e=>qs(s=>(0,a.A)((0,a.A)({},s),{},{countryId:e.target.value})),children:[(0,v.jsx)("option",{value:"",children:"All countries"}),Rl.map(e=>(0,v.jsx)("option",{value:e.id,children:e.name},e.id))]}),(0,v.jsx)("button",{className:"btn",onClick:()=>Ol(Hs),disabled:Us,children:"Apply"})]})]}),(0,v.jsxs)("table",{className:"table admin-approvals-table",style:{marginTop:12},children:[(0,v.jsx)("thead",{children:(0,v.jsxs)("tr",{children:[(0,v.jsx)("th",{"aria-sort":Il("country_name"),children:(0,v.jsxs)("button",{type:"button",onClick:()=>Fl("country_name"),style:{display:"inline-flex",alignItems:"center",gap:6,background:"none",border:"none",padding:0,cursor:"pointer",font:"inherit"},title:"Sort",children:["\xdclke ",(0,v.jsx)("span",{"aria-hidden":!0,children:Tl("country_name")})]})}),(0,v.jsx)("th",{"aria-sort":Il("school_name"),children:(0,v.jsxs)("button",{type:"button",onClick:()=>Fl("school_name"),style:{display:"inline-flex",alignItems:"center",gap:6,background:"none",border:"none",padding:0,cursor:"pointer",font:"inherit"},title:"Sort",children:["School ",(0,v.jsx)("span",{"aria-hidden":!0,children:Tl("school_name")})]})}),(0,v.jsx)("th",{"aria-sort":Il("scenario_name"),children:(0,v.jsxs)("button",{type:"button",onClick:()=>Fl("scenario_name"),style:{display:"inline-flex",alignItems:"center",gap:6,background:"none",border:"none",padding:0,cursor:"pointer",font:"inherit"},title:"Sort",children:["Scenario ",(0,v.jsx)("span",{"aria-hidden":!0,children:Tl("scenario_name")})]})}),(0,v.jsx)("th",{"aria-sort":Il("academic_year"),children:(0,v.jsxs)("button",{type:"button",onClick:()=>Fl("academic_year"),style:{display:"inline-flex",alignItems:"center",gap:6,background:"none",border:"none",padding:0,cursor:"pointer",font:"inherit"},title:"Sort",children:["Academic Year ",(0,v.jsx)("span",{"aria-hidden":!0,children:Tl("academic_year")})]})}),(0,v.jsx)("th",{"aria-sort":Il("submitted_at"),children:(0,v.jsxs)("button",{type:"button",onClick:()=>Fl("submitted_at"),style:{display:"inline-flex",alignItems:"center",gap:6,background:"none",border:"none",padding:0,cursor:"pointer",font:"inherit"},title:"Sort",children:["Submitted ",(0,v.jsx)("span",{"aria-hidden":!0,children:Tl("submitted_at")})]})}),(0,v.jsx)("th",{"aria-sort":Il("status"),children:(0,v.jsxs)("button",{type:"button",onClick:()=>Fl("status"),style:{display:"inline-flex",alignItems:"center",gap:6,background:"none",border:"none",padding:0,cursor:"pointer",font:"inherit"},title:"Sort",children:["Status ",(0,v.jsx)("span",{"aria-hidden":!0,children:Tl("status")})]})}),(0,v.jsx)("th",{children:"Progress"}),(0,v.jsx)("th",{children:"Y1 KPIs"}),(0,v.jsx)("th",{children:"Y2 KPIs"}),(0,v.jsx)("th",{children:"Y3 KPIs"}),(0,v.jsx)("th",{children:"Actions"})]})}),(0,v.jsx)("tbody",{children:Us?(0,v.jsx)("tr",{children:(0,v.jsx)("td",{colSpan:"11",className:"small",children:"Loading..."})}):0===Bl.length?(0,v.jsx)("tr",{children:(0,v.jsx)("td",{colSpan:"11",className:"small",children:"No scenarios found."})}):Bl.map(e=>{var s,l,i,a,n,t,r,o,c,d,u,h,p,x,g,y,j,b,f,N,S;const C=(e=>{const s=e&&"object"===typeof e?e:{status:e},l=s.status,i=s.sent_at;switch(l){case"revision_requested":return{label:"Revize istendi",className:"is-bad"};case"sent_for_approval":return{label:"Merkeze iletildi",className:"is-warn"};case"approved":return i?{label:"Onayland\u0131",className:"is-ok"}:{label:"Kontrol edildi",className:"is-ok"};case"in_review":return{label:"\u0130ncelemede",className:"is-warn"};case"submitted":return{label:"Onayda",className:"is-warn"};default:return{label:"Taslak",className:"is-muted"}}})(e.scenario),k="sent_for_approval"===(null===(s=e.scenario)||void 0===s?void 0:s.status)||"submitted"===(null===(l=e.scenario)||void 0===l?void 0:l.status),_=["sent_for_approval","approved","submitted"].includes(null===(i=e.scenario)||void 0===i?void 0:i.status),A=(null===(a=e.missingKpis)||void 0===a?void 0:a.y1)||(null===(n=e.missingKpis)||void 0===n?void 0:n.y2)||(null===(t=e.missingKpis)||void 0===t?void 0:t.y3),R=Number.isFinite(Number(null===(r=e.scenario)||void 0===r?void 0:r.progress_pct))?Math.round(Number(e.scenario.progress_pct)):null,F=Number((null===(o=e.scenario)||void 0===o?void 0:o.progress_missing_count)||0),T=null===(c=e.scenario)||void 0===c?void 0:c.progress_missing_preview,I=null==R?[]:F>0?["Eksik:",T||"Eksik alanlar"]:["Tum tablar tamamlandi"];return(0,v.jsxs)("tr",{children:[(0,v.jsxs)("td",{children:[(0,v.jsx)("div",{style:{fontWeight:700},children:(null===(p=e.country)||void 0===p?void 0:p.name)||"-"}),null!==(x=e.country)&&void 0!==x&&x.region?(0,v.jsx)("div",{className:"small",children:e.country.region}):null]}),(0,v.jsx)("td",{children:(0,v.jsx)("div",{style:{fontWeight:700},children:(null===(g=e.school)||void 0===g?void 0:g.name)||"-"})}),(0,v.jsxs)("td",{children:[(0,v.jsx)("div",{children:(null===(y=e.scenario)||void 0===y?void 0:y.name)||"-"}),A?(0,v.jsx)("span",{className:"status-badge is-bad",children:"Missing KPIs"}):null]}),(0,v.jsx)("td",{className:"small",children:(null===(j=e.scenario)||void 0===j?void 0:j.academic_year)||"-"}),(0,v.jsx)("td",{className:"small",children:w(null===(b=e.scenario)||void 0===b?void 0:b.submitted_at)}),(0,v.jsx)("td",{children:(0,v.jsx)("span",{className:"status-badge ".concat(C.className),children:C.label})}),(0,v.jsx)("td",{children:null==R?(0,v.jsx)("span",{className:"small",children:"-"}):(0,v.jsx)(m.A,{lines:I,children:(0,v.jsxs)("span",{className:"badge",children:[R,"%"]})})}),(0,v.jsx)("td",{children:Vl(null===(f=e.kpis)||void 0===f?void 0:f.y1)}),(0,v.jsx)("td",{children:Vl(null===(N=e.kpis)||void 0===N?void 0:N.y2)}),(0,v.jsx)("td",{children:Vl(null===(S=e.kpis)||void 0===S?void 0:S.y3)}),(0,v.jsx)("td",{children:(0,v.jsxs)("div",{className:"row",children:[(0,v.jsx)("button",{className:"btn primary",onClick:()=>Jl(e,"approve"),disabled:!k||el,children:"Onayla"}),(0,v.jsx)("button",{className:"btn",onClick:()=>Jl(e,"revise"),disabled:!_||el,children:"Revizyon \u0130ste"})]})})]},(null===(d=e.scenario)||void 0===d?void 0:d.id)||"".concat(null===(u=e.school)||void 0===u?void 0:u.id,"-").concat(null===(h=e.scenario)||void 0===h?void 0:h.name))})})]})]}),"reports"===W&&(0,v.jsxs)("div",{style:{marginTop:12},children:[(0,v.jsx)("div",{className:"card",children:(0,v.jsxs)("div",{className:"row",style:{justifyContent:"space-between"},children:[(0,v.jsxs)("div",{children:[(0,v.jsx)("div",{style:{fontWeight:700},children:"Rollup Reports"}),(0,v.jsx)("div",{className:"small",children:"Approved scenarios only. Select an academic year."})]}),(0,v.jsxs)("div",{className:"row",children:[(0,v.jsx)("input",{className:"input sm",placeholder:"Academic year",value:ll,onChange:e=>il(e.target.value)}),(0,v.jsx)("button",{className:"btn",onClick:()=>Dl(ll),disabled:tl,children:tl?"Loading...":"Load"}),(0,v.jsxs)("div",{className:"action-menu",ref:dl,children:[(0,v.jsx)("button",{type:"button",className:"btn",onClick:()=>{$l||cl(e=>!e)},disabled:$l,"aria-haspopup":"menu","aria-expanded":ol,children:"Export"}),ol?(0,v.jsxs)("div",{className:"action-menu-panel",role:"menu",children:[(0,v.jsxs)("button",{type:"button",className:"action-menu-item",onClick:()=>{cl(!1)},disabled:!0,title:"Excel export coming soon",role:"menuitem",children:["Excel (.xlsx)"," (coming soon)"]}),(0,v.jsx)("button",{type:"button",className:"action-menu-item",disabled:!0,role:"menuitem",children:"PDF (coming soon)"})]}):null]})]})]})}),al?(0,v.jsxs)(v.Fragment,{children:[(0,v.jsxs)("div",{className:"card",style:{marginTop:12},children:[(0,v.jsx)("div",{style:{fontWeight:700},children:"Consolidated KPIs"}),(0,v.jsx)("div",{className:"admin-kpi-strip",style:{marginTop:10},children:x.map(e=>{var s,l,i,a,n,t,r,o,c,d,u,m;return(0,v.jsxs)("div",{className:"admin-kpi-year",children:[(0,v.jsx)("div",{className:"admin-kpi-year-title",children:e.toUpperCase()}),(0,v.jsxs)("div",{className:"admin-kpi-grid",children:[(0,v.jsxs)("div",{className:"admin-kpi",children:[(0,v.jsx)("div",{className:"admin-kpi-label",children:"Net ciro"}),(0,v.jsx)("div",{className:"admin-kpi-value",children:N(null===(s=al.totals)||void 0===s||null===(l=s[e])||void 0===l?void 0:l.net_ciro)})]}),(0,v.jsxs)("div",{className:"admin-kpi",children:[(0,v.jsx)("div",{className:"admin-kpi-label",children:"Net income"}),(0,v.jsx)("div",{className:"admin-kpi-value",children:N(null===(i=al.totals)||void 0===i||null===(a=i[e])||void 0===a?void 0:a.net_income)})]}),(0,v.jsxs)("div",{className:"admin-kpi",children:[(0,v.jsx)("div",{className:"admin-kpi-label",children:"Expenses"}),(0,v.jsx)("div",{className:"admin-kpi-value",children:N(null===(n=al.totals)||void 0===n||null===(t=n[e])||void 0===t?void 0:t.total_expenses)})]}),(0,v.jsxs)("div",{className:"admin-kpi",children:[(0,v.jsx)("div",{className:"admin-kpi-label",children:"Net result"}),(0,v.jsx)("div",{className:"admin-kpi-value",children:N(null===(r=al.totals)||void 0===r||null===(o=r[e])||void 0===o?void 0:o.net_result)})]}),(0,v.jsxs)("div",{className:"admin-kpi",children:[(0,v.jsx)("div",{className:"admin-kpi-label",children:"Margin"}),(0,v.jsx)("div",{className:"admin-kpi-value",children:S(null===(c=al.totals)||void 0===c||null===(d=c[e])||void 0===d?void 0:d.profitMargin)})]}),(0,v.jsxs)("div",{className:"admin-kpi",children:[(0,v.jsx)("div",{className:"admin-kpi-label",children:"Students"}),(0,v.jsx)("div",{className:"admin-kpi-value",children:N(null===(u=al.totals)||void 0===u||null===(m=u[e])||void 0===m?void 0:m.students_total)})]})]})]},e)})})]}),(0,v.jsxs)("div",{className:"card",style:{marginTop:12},children:[(0,v.jsx)("div",{style:{fontWeight:700},children:"Rollup Tree"}),(0,v.jsx)("div",{className:"small",style:{marginTop:4},children:"Only approved scenarios are consolidated. Excluded years show as blank."}),(0,v.jsx)("div",{className:"rollup-table-wrap",style:{marginTop:10},children:(0,v.jsxs)("table",{className:"table rollup-table",children:[(0,v.jsx)("thead",{children:(0,v.jsxs)("tr",{children:[(0,v.jsx)("th",{style:{minWidth:220},children:"Unit"}),(0,v.jsx)("th",{style:{minWidth:220},children:"Y1"}),(0,v.jsx)("th",{style:{minWidth:220},children:"Y2"}),(0,v.jsx)("th",{style:{minWidth:220},children:"Y3"})]})}),(0,v.jsxs)("tbody",{children:[(0,v.jsxs)("tr",{className:"rollup-row rollup-total",children:[(0,v.jsx)("td",{className:"rollup-name",children:"Totals"}),(0,v.jsx)("td",{children:Xl(null===(A=al.totals)||void 0===A?void 0:A.y1)}),(0,v.jsx)("td",{children:Xl(null===(R=al.totals)||void 0===R?void 0:R.y2)}),(0,v.jsx)("td",{children:Xl(null===(F=al.totals)||void 0===F?void 0:F.y3)})]}),null===(T=al.regions)||void 0===T?void 0:T.map(e=>{var s,l,i,a;const t=e.region||"Unknown",r=ul.has(t);return(0,v.jsxs)(n.Fragment,{children:[(0,v.jsxs)("tr",{className:"rollup-row rollup-region",children:[(0,v.jsxs)("td",{className:"rollup-name",children:[(0,v.jsx)("button",{type:"button",className:"tree-toggle",onClick:()=>(e=>{ml(s=>{const l=new Set(s);return l.has(e)?l.delete(e):l.add(e),l})})(t),"aria-label":"Toggle region",children:r?"-":"+"}),(0,v.jsx)("span",{className:"rollup-title",children:e.region||"Unknown region"})]}),(0,v.jsx)("td",{children:Xl(null===(s=e.years)||void 0===s?void 0:s.y1)}),(0,v.jsx)("td",{children:Xl(null===(l=e.years)||void 0===l?void 0:l.y2)}),(0,v.jsx)("td",{children:Xl(null===(i=e.years)||void 0===i?void 0:i.y3)})]}),r?null===(a=e.countries)||void 0===a?void 0:a.map(e=>{var s,l,i,a;const r="".concat(t,"::").concat(e.id),o=hl.has(r);return(0,v.jsxs)(n.Fragment,{children:[(0,v.jsxs)("tr",{className:"rollup-row rollup-country",children:[(0,v.jsxs)("td",{className:"rollup-name level-1",children:[(0,v.jsx)("button",{type:"button",className:"tree-toggle",onClick:()=>((e,s)=>{const l="".concat(e,"::").concat(s);pl(e=>{const s=new Set(e);return s.has(l)?s.delete(l):s.add(l),s})})(t,e.id),"aria-label":"Toggle country",children:o?"-":"+"}),(0,v.jsx)("span",{className:"rollup-title",children:e.name})]}),(0,v.jsx)("td",{children:Xl(null===(s=e.years)||void 0===s?void 0:s.y1)}),(0,v.jsx)("td",{children:Xl(null===(l=e.years)||void 0===l?void 0:l.y2)}),(0,v.jsx)("td",{children:Xl(null===(i=e.years)||void 0===i?void 0:i.y3)})]}),o?null===(a=e.schools)||void 0===a?void 0:a.map(e=>{var s,l,i,a;return(0,v.jsxs)("tr",{className:"rollup-row rollup-school",children:[(0,v.jsxs)("td",{className:"rollup-name level-2",children:[e.name,null!==(s=e.included_years)&&void 0!==s&&s.length?(0,v.jsxs)("span",{className:"rollup-sub",children:["(",e.included_years.join(", "),")"]}):null]}),(0,v.jsx)("td",{children:Xl(null===(l=e.years)||void 0===l?void 0:l.y1)}),(0,v.jsx)("td",{children:Xl(null===(i=e.years)||void 0===i?void 0:i.y2)}),(0,v.jsx)("td",{children:Xl(null===(a=e.years)||void 0===a?void 0:a.y3)})]},"school-".concat(e.id))}):null]},r)}):null]},"region-".concat(t))})]})]})})]}),null!==(I=al.missingNoApproved)&&void 0!==I&&I.length?(0,v.jsxs)("div",{className:"card admin-alert",style:{marginTop:12},children:[(0,v.jsx)("div",{className:"admin-alert-title",children:"Schools without an approved scenario"}),(0,v.jsx)("ul",{children:al.missingNoApproved.map(e=>(0,v.jsxs)("li",{children:[e.name," (",e.country_name,")"]},"missing-".concat(e.id)))})]}):null,null!==(B=al.missingKpis)&&void 0!==B&&B.length?(0,v.jsxs)("div",{className:"card admin-alert",style:{marginTop:12},children:[(0,v.jsx)("div",{className:"admin-alert-title",children:"Approved scenarios missing KPI snapshots"}),(0,v.jsx)("ul",{children:al.missingKpis.map(e=>(0,v.jsxs)("li",{children:["Scenario #",e.scenario_id," (School #",e.school_id,") - missing ",e.missingYears.join(", ")]},"missing-kpi-".concat(e.scenario_id)))})]}):null]}):(0,v.jsx)("div",{className:"card",style:{marginTop:12},children:(0,v.jsx)("div",{className:"small",children:"Select an academic year to view the rollup report."})})]})]})]})}}}]);
//# sourceMappingURL=613.497a58cd.chunk.js.map